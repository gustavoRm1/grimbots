{% extends "base.html" %}

{% block title %}Remarketing - {{ bot.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="remarketingApp()" x-init="init()">
    
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <div class="flex items-center gap-3">
                <a href="/bots/{{ bot.id }}/config" class="text-textSecondary hover:text-textPrimary">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-textPrimary">üì¢ Remarketing</h1>
                    <p class="text-sm text-textSecondary">{{ bot.name }} ‚Ä¢ @{{ bot.username }}</p>
                </div>
            </div>
        </div>
        
        <button @click="showCreateModal = true"
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-semibold text-black bg-gradient-to-r from-accent500 to-accent600 hover:shadow-accent-glow transition-all">
            <i class="fas fa-plus mr-2"></i>
            Nova Campanha
        </button>
    </div>

    <!-- Alert de Informa√ß√£o - Redesenhado -->
    <div class="bg-info-500 bg-opacity-8 border-l-4 border-info-500 rounded-r-xl p-6 mb-8">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <div class="relative">
                    <div class="absolute -inset-1 bg-info-500 rounded-xl opacity-20 blur-md"></div>
                    <div class="relative flex items-center justify-center h-14 w-14 rounded-xl bg-info-500 bg-opacity-20 border border-info-500 border-opacity-30">
                        <i class="fas fa-bullhorn text-info-500 text-2xl" style="filter: brightness(1.3) drop-shadow(0 2px 6px rgba(59,130,246,0.5));"></i>
                    </div>
                </div>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-bold text-textPrimary mb-2 flex items-center">
                    <i class="fas fa-sparkles text-info-500 mr-2"></i>
                    Remarketing Inteligente
                </h3>
                <p class="text-sm text-textPrimary leading-relaxed mb-3">
                    Envie mensagens personalizadas para sua base de leads. O sistema garante:
                </p>
                <ul class="space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-success-500 mr-2 mt-0.5" style="filter: brightness(1.2);"></i>
                        <span class="text-sm text-textPrimary"><strong class="text-success-500">Cooldown m√≠nimo</strong> de 24h por usu√°rio</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-success-500 mr-2 mt-0.5" style="filter: brightness(1.2);"></i>
                        <span class="text-sm text-textPrimary"><strong class="text-info-500">Segmenta√ß√£o inteligente</strong> (n√£o compradores, inativos, carrinhos abandonados)</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-success-500 mr-2 mt-0.5" style="filter: brightness(1.2);"></i>
                        <span class="text-sm text-textPrimary"><strong class="text-accent500">Rate limiting autom√°tico</strong> (20 msgs/segundo)</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-success-500 mr-2 mt-0.5" style="filter: brightness(1.2);"></i>
                        <span class="text-sm text-textPrimary"><strong class="text-danger-500">Blacklist autom√°tica</strong> (usu√°rios que bloquearam)</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Lista de Campanhas -->
    <div class="card !p-0">
        <div class="px-6 py-5 border-b border-white border-opacity-5">
            <h3 class="text-lg font-semibold text-textPrimary">Campanhas de Remarketing</h3>
            <p class="text-sm text-textSecondary mt-1"><span x-text="campaigns.length"></span> campanha(s)</p>
        </div>
        
        <div class="px-6 py-6">
            <template x-if="campaigns.length > 0">
                <div class="space-y-4">
                    <template x-for="campaign in campaigns" :key="campaign.id">
                        <div class="border border-white border-opacity-10 rounded-lg p-5 hover:border-opacity-20 transition-all">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <h4 class="text-lg font-semibold text-textPrimary" x-text="campaign.name"></h4>
                                    <p class="text-sm text-textSecondary mt-1" x-text="campaign.message.substring(0, 100) + '...'"></p>
                                </div>
                                <span class="badge px-3 py-1 rounded-full text-xs font-bold" 
                                      :class="{
                                          'bg-green-500 bg-opacity-40 text-green-300 border border-green-500': campaign.status === 'completed',
                                          'bg-yellow-500 bg-opacity-20 text-yellow-400 border border-yellow-500': campaign.status === 'sending',
                                          'bg-blue-500 bg-opacity-20 text-blue-400 border border-blue-500': campaign.status === 'draft',
                                          'bg-purple-500 bg-opacity-20 text-purple-400 border border-purple-500': campaign.status === 'scheduled'
                                      }">
                                    <span x-text="getStatusLabel(campaign.status)"></span>
                                </span>
                            </div>
                            
                            <!-- Stats da Campanha -->
                            <div class="grid grid-cols-4 gap-4 mb-4">
                                <div class="text-center p-3 bg-bg900 rounded-lg">
                                    <p class="text-xs text-textSecondary">Alvo</p>
                                    <p class="text-lg font-bold text-textPrimary" x-text="campaign.total_targets || 0"></p>
                                </div>
                                <div class="text-center p-3 bg-bg900 rounded-lg">
                                    <p class="text-xs text-textSecondary">Enviados</p>
                                    <p class="text-lg font-bold text-green-400" x-text="campaign.total_sent || 0"></p>
                                </div>
                                <div class="text-center p-3 bg-bg900 rounded-lg">
                                    <p class="text-xs text-textSecondary">Falharam</p>
                                    <p class="text-lg font-bold text-red-400" x-text="campaign.total_failed || 0"></p>
                                </div>
                                <div class="text-center p-3 bg-bg900 rounded-lg">
                                    <p class="text-xs text-textSecondary">Bloquearam</p>
                                    <p class="text-lg font-bold text-yellow-400" x-text="campaign.total_blocked || 0"></p>
                                </div>
                            </div>
                            
                            <!-- Barra de Progresso (se enviando) -->
                            <template x-if="campaign.status === 'sending'">
                                <div class="mb-4">
                                    <div class="flex justify-between text-xs text-textSecondary mb-1">
                                        <span>Enviando...</span>
                                        <span x-text="Math.round((campaign.total_sent / campaign.total_targets) * 100) + '%'"></span>
                                    </div>
                                    <div class="w-full bg-bg900 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-accent500 to-accent600 h-2 rounded-full transition-all animate-pulse" 
                                             :style="`width: ${(campaign.total_sent / campaign.total_targets) * 100}%`"></div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- ‚úÖ V2.0: Info de Agendamento -->
                            <template x-if="campaign.status === 'scheduled' && campaign.scheduled_at">
                                <div class="mb-4 p-3 bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-20 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-calendar-check text-purple-400"></i>
                                        <span class="text-sm text-textPrimary">
                                            <strong>Agendada para:</strong>
                                            <span class="ml-2 font-bold text-purple-400" x-text="formatCampaignScheduledDate(campaign.scheduled_at)"></span>
                                        </span>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- A√ß√µes -->
                            <div class="flex gap-2">
                                <template x-if="campaign.status === 'draft'">
                                    <button @click="sendCampaign(campaign.id)"
                                            class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all">
                                        <i class="fas fa-paper-plane mr-2"></i>
                                        Enviar Agora
                                    </button>
                                </template>
                                
                                <template x-if="campaign.status === 'scheduled'">
                                    <button @click="sendCampaign(campaign.id)"
                                            class="flex-1 inline-flex justify-center items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all">
                                        <i class="fas fa-play mr-2"></i>
                                        Executar Agora
                                    </button>
                                </template>
                                
                                <template x-if="campaign.status === 'completed'">
                                    <button @click="viewReport(campaign.id)"
                                            class="flex-1 inline-flex justify-center items-center px-4 py-2 border border-white border-opacity-20 text-textSecondary rounded-lg hover:bg-white hover:bg-opacity-5 transition-all">
                                        <i class="fas fa-chart-bar mr-2"></i>
                                        Ver Relat√≥rio
                                    </button>
                                </template>
                                
                                <button @click="deleteCampaign(campaign.id)"
                                        class="inline-flex items-center px-4 py-2 border border-danger border-opacity-30 text-danger rounded-lg hover:bg-danger hover:bg-opacity-10 transition-all">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
            
            <template x-if="campaigns.length === 0">
                <div class="text-center py-12">
                    <i class="fas fa-bullhorn text-6xl text-muted opacity-30"></i>
                    <h3 class="mt-4 text-sm font-medium text-textPrimary">Nenhuma campanha criada</h3>
                    <p class="mt-2 text-sm text-textSecondary">Crie sua primeira campanha de remarketing para reativar leads.</p>
                    <button @click="showCreateModal = true"
                            class="mt-6 inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-semibold text-black bg-gradient-to-r from-accent500 to-accent600 hover:shadow-accent-glow transition-all">
                        <i class="fas fa-plus mr-2"></i>
                        Criar Primeira Campanha
                    </button>
                </div>
            </template>
        </div>
    </div>

    <!-- Modal de Criar Campanha -->
    <div x-show="showCreateModal" x-cloak
         class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div x-show="showCreateModal" x-transition
                 class="modal-backdrop fixed inset-0"
                 @click="showCreateModal = false"></div>

            <div x-show="showCreateModal" x-transition
                 class="modal-content relative bg-bg900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
                 style="border: 2px solid var(--border-accent); box-shadow: 0 25px 60px rgba(0,0,0,0.9);">
                
                <!-- Header Profissional -->
                <div class="px-8 pt-8 pb-6 border-b border-white border-opacity-5 rounded-t-2xl" style="background: var(--border-subtle);">
                    <div class="flex items-start">
                        <!-- √çcone com Glow -->
                        <div class="flex-shrink-0">
                            <div class="relative">
                                <div class="absolute -inset-2 bg-accent500 rounded-full opacity-25 blur-xl"></div>
                                <div class="relative flex items-center justify-center h-16 w-16 rounded-2xl border border-accent500 border-opacity-30" style="background: var(--border-subtle);">
                                    <i class="fas fa-bullhorn text-accent500" style="font-size: 2rem; filter: brightness(1.3);"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- T√≠tulo e Descri√ß√£o -->
                        <div class="ml-6 flex-1">
                            <h2 class="text-3xl font-bold text-textPrimary">
                                Nova Campanha de Remarketing
                            </h2>
                            <p class="mt-2 text-sm text-textSecondary leading-relaxed">
                                Configure e envie mensagens personalizadas para sua base de leads com segmenta√ß√£o inteligente
                            </p>
                        </div>
                        
                        <!-- Bot√£o Fechar -->
                        <button @click="showCreateModal = false" 
                                class="ml-3 text-textSecondary hover:text-textPrimary transition-colors focus:outline-none">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>

                <form @submit.prevent="createCampaign()" class="px-8 py-6">
                    
                    <!-- Mensagem -->
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-textPrimary mb-2">
                            <i class="fas fa-comment-alt mr-2 text-accent500"></i>
                            Mensagem do Remarketing
                        </label>
                        <textarea x-model="newCampaign.message" required rows="6"
                                  class="w-full px-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-textSecondary focus:outline-none focus:ring-2 focus:ring-accent500"
                                  placeholder="Digite a mensagem que ser√° enviada para os usu√°rios...&#10;&#10;Exemplo:&#10;üî• OFERTA ESPECIAL!&#10;N√£o perca essa oportunidade √∫nica..."></textarea>
                        <p class="text-xs text-textSecondary mt-2">
                            <i class="fas fa-lightbulb mr-1 text-accent500"></i>
                            Use emojis e seja persuasivo para aumentar a convers√£o
                        </p>
                    </div>

                    <!-- M√≠dia (Opcional) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-bold text-textPrimary mb-2">
                                <i class="fas fa-link mr-2 text-accent500"></i>
                                URL da M√≠dia (opcional)
                            </label>
                            <input type="url" 
                                   x-model="newCampaign.media_url" 
                                   class="w-full px-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-textSecondary focus:outline-none focus:ring-2 focus:ring-accent500"
                                   placeholder="https://t.me/canal/123">
                            <p class="text-xs text-textSecondary mt-2">Link do Telegram (v√≠deo ou foto)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-textPrimary mb-2">
                                <i class="fas fa-image mr-2 text-accent500"></i>
                                Tipo de M√≠dia Principal
                            </label>
                            <div class="grid grid-cols-2 gap-3 mt-2">
                                <label class="flex items-center gap-2 px-4 py-3 bg-bg900 border rounded-lg cursor-pointer transition-colors"
                                       :class="newCampaign.media_type === 'video' ? 'border-accent500' : 'border-white border-opacity-10'"
                                       :style="newCampaign.media_type === 'video' ? 'background: var(--border-subtle);' : ''">
                                    <input type="radio" x-model="newCampaign.media_type" value="video" style="accent-color: var(--brand-gold-500);">
                                    <i class="fas fa-video text-accent500"></i>
                                    <span class="text-sm text-textPrimary">V√≠deo</span>
                                </label>
                                <label class="flex items-center gap-2 px-4 py-3 bg-bg900 border rounded-lg cursor-pointer transition-colors"
                                       :class="newCampaign.media_type === 'photo' ? 'border-accent500' : 'border-white border-opacity-10'"
                                       :style="newCampaign.media_type === 'photo' ? 'background: var(--border-subtle);' : ''">
                                    <input type="radio" x-model="newCampaign.media_type" value="photo" style="accent-color: var(--brand-gold-500);">
                                    <i class="fas fa-camera text-accent500"></i>
                                    <span class="text-sm text-textPrimary">Foto</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- √Åudio Adicional -->
                    <div class="mb-6 p-4 rounded-xl" style="background: var(--border-subtle); border: 1px solid var(--border-accent);">
                        <label class="flex items-center gap-3 cursor-pointer mb-3">
                            <input type="checkbox" 
                                   x-model="newCampaign.audio_enabled"
                                   class="w-5 h-5 bg-bg900 border-white border-opacity-10 rounded focus:ring-accent500"
                                   style="accent-color: var(--brand-gold-500);">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-microphone text-accent500 text-lg"></i>
                                <span class="text-sm font-bold text-textPrimary">Adicionar √Åudio Complementar (opcional)</span>
                            </div>
                        </label>
                        <div x-show="newCampaign.audio_enabled" x-cloak>
                            <input type="url" 
                                   x-model="newCampaign.audio_url" 
                                   class="w-full px-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-textSecondary focus:outline-none focus:ring-2 focus:ring-accent500"
                                   placeholder="https://t.me/canal/audio">
                            <p class="text-xs text-textSecondary mt-2">O √°udio ser√° enviado ap√≥s a m√≠dia principal</p>
                        </div>
                    </div>

                    <!-- Segmenta√ß√£o de P√∫blico -->
                    <div class="mb-6 p-4 rounded-xl" style="background: var(--border-subtle); border: 1px solid var(--border-accent);">
                        <label class="block text-sm font-bold text-textPrimary mb-3">
                            <i class="fas fa-filter mr-2 text-accent500"></i>
                            Segmenta√ß√£o de P√∫blico
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-textSecondary mb-2">Dias desde √∫ltimo contato</label>
                                <input type="number" 
                                       x-model.number="newCampaign.days_since_last_contact" 
                                       min="0"
                                       class="w-full px-4 py-2 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary focus:outline-none focus:ring-2 focus:ring-accent500"
                                       placeholder="7">
                                <div class="mt-2 p-2 rounded-lg bg-bg900 border border-white border-opacity-5">
                                    <p class="text-xs text-textSecondary">
                                        <i class="fas fa-info-circle mr-1 text-accent500"></i>
                                        <span x-text="newCampaign.days_since_last_contact == 0 ? 'Todos os usu√°rios (sem filtro de inatividade)' : 'Apenas usu√°rios inativos h√° ' + newCampaign.days_since_last_contact + ' dia(s)'"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" 
                                           x-model="newCampaign.exclude_buyers"
                                           class="w-4 h-4 bg-bg900 border-white border-opacity-10 rounded focus:ring-accent500"
                                           style="accent-color: var(--brand-gold-500);">
                                    <span class="text-sm text-textPrimary">Excluir quem j√° comprou</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ‚úÖ V2.0: Agendamento de Envio -->
                    <div class="mb-6 p-4 rounded-xl" style="background: var(--border-subtle); border: 1px solid var(--border-accent);">
                        <div class="flex items-center mb-4">
                            <div class="flex items-center justify-center h-10 w-10 rounded-lg border border-accent500 border-opacity-30" style="background: var(--border-subtle);">
                                <i class="fas fa-clock text-accent500 text-lg" style="filter: brightness(1.2);"></i>
                            </div>
                            <h3 class="ml-3 text-base font-bold text-textPrimary">Agendamento de Envio</h3>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Op√ß√£o: Imediato ou Agendar -->
                            <div>
                                <label class="block text-sm font-medium text-textSecondary mb-3">Quando enviar:</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex items-center px-4 py-3.5 bg-bg900 border-2 rounded-xl cursor-pointer transition-all"
                                           :class="newCampaign.send_mode === 'immediate' ? 'border-accent500' : 'border-white border-opacity-10'"
                                           :style="newCampaign.send_mode === 'immediate' ? 'background: var(--border-subtle);' : ''">
                                        <input type="radio" x-model="newCampaign.send_mode" value="immediate"
                                               class="form-radio h-4 w-4" style="accent-color: var(--brand-gold-500);">
                                        <div class="ml-3 flex-1">
                                            <div class="flex items-center">
                                                <i class="fas fa-bolt text-accent500 mr-2"></i>
                                                <span class="text-sm font-semibold text-textPrimary">Enviar Imediato</span>
                                            </div>
                                            <p class="text-xs text-textSecondary mt-1">Enviar assim que a campanha for criada</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center px-4 py-3.5 bg-bg900 border-2 rounded-xl cursor-pointer transition-all"
                                           :class="newCampaign.send_mode === 'scheduled' ? 'border-accent500' : 'border-white border-opacity-10'"
                                           :style="newCampaign.send_mode === 'scheduled' ? 'background: var(--border-subtle);' : ''">
                                        <input type="radio" x-model="newCampaign.send_mode" value="scheduled"
                                               class="form-radio h-4 w-4" style="accent-color: var(--brand-gold-500);">
                                        <div class="ml-3 flex-1">
                                            <div class="flex items-center">
                                                <i class="fas fa-calendar-alt text-accent500 mr-2"></i>
                                                <span class="text-sm font-semibold text-textPrimary">Agendar</span>
                                            </div>
                                            <p class="text-xs text-textSecondary mt-1">Escolher data e hora espec√≠fica</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Campos de Data e Hora (se agendado) -->
                            <div x-show="newCampaign.send_mode === 'scheduled'" x-cloak class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-semibold text-textSecondary mb-2 flex items-center">
                                            <i class="fas fa-calendar text-accent500 mr-1.5 text-xs"></i>
                                            Data
                                        </label>
                                        <input type="date" x-model="newCampaign.scheduled_date" 
                                               :min="new Date().toISOString().split('T')[0]"
                                               class="w-full px-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary focus:outline-none focus:border-accent500 focus:ring-2 focus:ring-accent500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-textSecondary mb-2 flex items-center">
                                            <i class="fas fa-clock text-accent500 mr-1.5 text-xs"></i>
                                            Hora
                                        </label>
                                        <input type="time" x-model="newCampaign.scheduled_time" 
                                               class="w-full px-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary focus:outline-none focus:border-accent500 focus:ring-2 focus:ring-accent500 transition-all">
                                    </div>
                                </div>
                                
                                <!-- Preview da Data/Hora -->
                                <div x-show="newCampaign.scheduled_date && newCampaign.scheduled_time" 
                                     class="p-3 bg-bg900 border border-accent500 border-opacity-20 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-info-circle text-accent500"></i>
                                        <span class="text-sm text-textPrimary">
                                            <strong>Campanha agendada para:</strong>
                                            <span class="ml-2 font-bold text-accent500" x-text="formatScheduledDateTime()"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de Produto -->
                    <div class="mb-6 p-4 rounded-xl" style="background: var(--border-subtle); border: 1px solid var(--border-accent);">
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-bold text-textPrimary">
                                <i class="fas fa-tag mr-2 text-accent500"></i>
                                Bot√µes de Produto
                            </label>
                            <button type="button" 
                                    @click="newCampaign.buttons.push({ text: '', price: 0, description: '' })"
                                    class="px-3 py-1 text-xs font-bold rounded-lg text-black"
                                    style="background: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));">
                                <i class="fas fa-plus mr-1"></i>
                                Adicionar Bot√£o
                            </button>
                        </div>
                        
                        <!-- Lista de bot√µes -->
                        <template x-if="newCampaign.buttons.length === 0">
                            <div class="text-center py-6 text-textSecondary text-sm">
                                <i class="fas fa-hand-pointer text-2xl mb-2 text-accent500"></i>
                                <p>Nenhum bot√£o adicionado</p>
                                <p class="text-xs mt-1">Clique em "Adicionar Bot√£o" para criar op√ß√µes de produtos</p>
                            </div>
                        </template>
                        
                        <div class="space-y-3">
                            <template x-for="(button, index) in newCampaign.buttons" :key="index">
                                <div class="p-4 bg-bg900 rounded-lg border border-white border-opacity-10">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="text-xs font-bold text-accent500">
                                            <i class="fas fa-tag mr-1"></i>
                                            Bot√£o <span x-text="index + 1"></span>
                                        </span>
                                        <button type="button" 
                                                @click="newCampaign.buttons.splice(index, 1)"
                                                class="text-xs text-red-400 hover:text-red-300">
                                            <i class="fas fa-trash mr-1"></i>
                                            Remover
                                        </button>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div class="md:col-span-2">
                                            <label class="block text-xs text-textSecondary mb-1">Texto do Bot√£o</label>
                                            <input type="text" 
                                                   x-model="button.text"
                                                   class="w-full px-3 py-2 bg-surface-800 border border-white border-opacity-10 rounded-lg text-textPrimary text-sm focus:outline-none focus:ring-2 focus:ring-accent500"
                                                   placeholder="Ex: Comprar Produto Premium">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-textSecondary mb-1">Pre√ßo (R$)</label>
                                            <input type="number" 
                                                   x-model.number="button.price"
                                                   step="0.01"
                                                   min="0"
                                                   class="w-full px-3 py-2 bg-surface-800 border border-white border-opacity-10 rounded-lg text-textPrimary text-sm font-mono font-bold focus:outline-none focus:ring-2 focus:ring-accent500"
                                                   placeholder="19.97">
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <label class="block text-xs text-textSecondary mb-1">Descri√ß√£o do Produto</label>
                                        <input type="text" 
                                               x-model="button.description"
                                               class="w-full px-3 py-2 bg-surface-800 border border-white border-opacity-10 rounded-lg text-textPrimary text-sm focus:outline-none focus:ring-2 focus:ring-accent500"
                                               placeholder="Acesso completo + B√¥nus exclusivos">
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Warning -->
                    <div class="mb-6 p-4 rounded-lg" style="background: var(--border-subtle); border: 1px solid var(--border-accent);">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-xl text-accent500"></i>
                            <div>
                                <p class="text-sm text-textPrimary font-bold mb-1">Aten√ß√£o</p>
                                <p class="text-xs text-textSecondary">
                                    Esta campanha ser√° enviada para <strong class="text-accent500">TODOS</strong> os usu√°rios do bot que atendam aos crit√©rios de segmenta√ß√£o. 
                                    Certifique-se de que a mensagem est√° correta antes de enviar.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button type="button" 
                                @click="showCreateModal = false"
                                class="flex-1 px-6 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg text-textSecondary font-semibold hover:bg-surface-800 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit"
                                :disabled="!newCampaign.message || loading"
                                :class="!newCampaign.message ? 'opacity-50 cursor-not-allowed' : ''"
                                class="flex-1 px-6 py-3 text-black font-bold rounded-lg transition-colors flex items-center justify-center gap-2"
                                style="background: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));">
                            <i class="fas" :class="newCampaign.send_mode === 'scheduled' ? 'fa-calendar-check' : 'fa-paper-plane'"></i>
                            <span x-text="loading ? (newCampaign.send_mode === 'scheduled' ? 'Agendando...' : 'Enviando...') : (newCampaign.send_mode === 'scheduled' ? 'Agendar Remarketing' : 'Enviar Remarketing')"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Relat√≥rio -->
    <div x-show="showReportModal" x-cloak
         class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div x-show="showReportModal" x-transition
                 class="modal-backdrop fixed inset-0"
                 @click="showReportModal = false"></div>

            <div x-show="showReportModal" x-transition
                 class="modal-content relative bg-surface800 rounded-lg max-w-2xl w-full p-6">
                
                <template x-if="selectedCampaign">
                    <div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-textPrimary">üìä Relat√≥rio da Campanha</h2>
                            <button @click="showReportModal = false" class="text-textSecondary hover:text-textPrimary">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-6">
                            <!-- Info da Campanha -->
                            <div>
                                <h3 class="text-lg font-semibold text-textPrimary" x-text="selectedCampaign.name"></h3>
                                <p class="text-sm text-textSecondary" x-text="'Criada em ' + formatDate(selectedCampaign.created_at)"></p>
                            </div>

                            <!-- Resultados -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="card !p-4 text-center">
                                    <p class="text-3xl font-bold text-green-400" x-text="selectedCampaign.total_sent"></p>
                                    <p class="text-sm text-textSecondary mt-1">Enviados com Sucesso</p>
                                </div>
                                <div class="card !p-4 text-center">
                                    <p class="text-3xl font-bold text-accent500" 
                                       x-text="Math.round((selectedCampaign.total_sent / selectedCampaign.total_targets) * 100) + '%'"></p>
                                    <p class="text-sm text-textSecondary mt-1">Taxa de Entrega</p>
                                </div>
                                <div class="card !p-4 text-center">
                                    <p class="text-3xl font-bold text-red-400" x-text="selectedCampaign.total_failed"></p>
                                    <p class="text-sm text-textSecondary mt-1">Falharam</p>
                                </div>
                                <div class="card !p-4 text-center">
                                    <p class="text-3xl font-bold text-yellow-400" x-text="selectedCampaign.total_blocked"></p>
                                    <p class="text-sm text-textSecondary mt-1">Bloquearam Bot</p>
                                </div>
                            </div>

                            <!-- Dura√ß√£o -->
                            <div class="card !p-4">
                                <div class="flex justify-between">
                                    <span class="text-sm text-textSecondary">‚è±Ô∏è Dura√ß√£o:</span>
                                    <span class="text-sm font-semibold text-textPrimary" x-text="getDuration(selectedCampaign)"></span>
                                </div>
                            </div>

                            <button @click="showReportModal = false"
                                    class="w-full px-6 py-3 bg-gradient-to-r from-accent500 to-accent600 text-black font-semibold rounded-lg hover:shadow-accent-glow transition-all">
                                Fechar
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
function remarketingApp() {
    return {
        showCreateModal: false,
        showReportModal: false,
        loading: false,
        campaigns: {{ campaigns|tojson|safe }},
        selectedCampaign: null,
        
        newCampaign: {
            name: '',  // Gerado automaticamente no resetForm, n√£o exibido no form
            message: '',
            media_url: '',
            media_type: 'video',  // ‚úÖ Padr√£o igual Remarketing Geral
            buttons: [],
            target_audience: 'non_buyers',  // Mantido para compatibilidade, mas calculado automaticamente
            days_since_last_contact: 7,  // ‚úÖ Padr√£o igual Remarketing Geral
            exclude_buyers: false,  // ‚úÖ Padr√£o igual Remarketing Geral
            cooldown_hours: 24,
            send_mode: 'immediate',  // ‚úÖ V2.0: 'immediate' ou 'scheduled'
            scheduled_date: '',      // ‚úÖ V2.0: Data no formato YYYY-MM-DD
            scheduled_time: '',       // ‚úÖ V2.0: Hora no formato HH:MM
            audio_enabled: false,  // ‚úÖ V2.0
            audio_url: ''  // ‚úÖ V2.0
        },
        
        init() {
            // Conectar WebSocket para progress
            const socket = io();
            
            socket.on('remarketing_progress', (data) => {
                console.log('üìä Progresso:', data);
                // Atualizar campanha na lista
                const campaign = this.campaigns.find(c => c.id === data.campaign_id);
                if (campaign) {
                    campaign.total_sent = data.sent;
                    campaign.total_failed = data.failed;
                    campaign.total_blocked = data.blocked;
                }
            });
            
            socket.on('remarketing_completed', (data) => {
                console.log('‚úÖ Campanha conclu√≠da:', data);
                const campaign = this.campaigns.find(c => c.id === data.campaign_id);
                if (campaign) {
                    campaign.status = 'completed';
                    campaign.total_sent = data.total_sent;
                    campaign.total_failed = data.total_failed;
                    campaign.total_blocked = data.total_blocked;
                }
                
                this.showNotification('‚úÖ Campanha conclu√≠da com sucesso!');
            });
            
        },
        
        async createCampaign() {
            if (!this.newCampaign.message.trim()) {
                alert('‚ùå Digite uma mensagem para o remarketing!');
                return;
            }
            
            // ‚úÖ V2.0: Valida√ß√£o de agendamento
            if (this.newCampaign.send_mode === 'scheduled') {
                if (!this.newCampaign.scheduled_date || !this.newCampaign.scheduled_time) {
                    alert('Preencha data e hora para agendar a campanha');
                    return;
                }
                
                // Validar se data/hora n√£o √© no passado
                const scheduledDateTime = new Date(`${this.newCampaign.scheduled_date}T${this.newCampaign.scheduled_time}`);
                const now = new Date();
                if (scheduledDateTime <= now) {
                    alert('A data e hora devem ser no futuro');
                    return;
                }
            }
            
            // ‚úÖ V2.0: Salvar modo de envio antes de modificar dados
            const sendMode = this.newCampaign.send_mode;
            
            this.loading = true;
            try {
                // ‚úÖ V2.0: Preparar dados para envio (incluir scheduled_at se agendado)
                const campaignData = {...this.newCampaign};
                
                // ‚úÖ Calcular target_audience automaticamente baseado em exclude_buyers (igual Remarketing Geral)
                campaignData.target_audience = this.newCampaign.exclude_buyers ? 'non_buyers' : 'all';
                
                if (sendMode === 'scheduled') {
                    // Combinar data e hora em ISO string
                    campaignData.scheduled_at = `${this.newCampaign.scheduled_date}T${this.newCampaign.scheduled_time}:00`;
                    // Remover campos auxiliares antes de enviar
                    delete campaignData.send_mode;
                    delete campaignData.scheduled_date;
                    delete campaignData.scheduled_time;
                } else {
                    // Envio imediato: n√£o enviar scheduled_at
                    campaignData.scheduled_at = null;
                    delete campaignData.send_mode;
                    delete campaignData.scheduled_date;
                    delete campaignData.scheduled_time;
                }
                
                const response = await fetch(`/api/bots/{{ bot.id }}/remarketing/campaigns`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(campaignData)
                });
                
                const campaign = await response.json();
                
                if (response.ok) {
                    // Adicionar na lista
                    this.campaigns.unshift(campaign);
                    
                    // Fechar modal
                    this.showCreateModal = false;
                    
                    // Resetar form
                    this.resetForm();
                    
                    // ‚úÖ V2.0: Mensagem de sucesso baseada no modo
                    if (sendMode === 'scheduled') {
                        alert('üìÖ Campanha agendada com sucesso!');
                    } else {
                        // ‚úÖ V2.0: Enviar imediatamente apenas se n√£o for agendado
                        await this.sendCampaign(campaign.id);
                        alert('‚úÖ Campanha criada e enviando...');
                    }
                } else {
                    alert('Erro: ' + (campaign.error || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro ao criar campanha: ' + error.message);
            } finally {
                this.loading = false;
            }
        },
        
        async sendCampaign(campaignId) {
            if (!confirm('Confirma o envio desta campanha?')) return;
            
            try {
                const response = await fetch(`/api/bots/{{ bot.id }}/remarketing/campaigns/${campaignId}/send`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Atualizar status
                    const campaign = this.campaigns.find(c => c.id === campaignId);
                    if (campaign) {
                        campaign.status = 'sending';
                    }
                    
                    this.showNotification('üì§ Enviando campanha...');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        },
        
        viewReport(campaignId) {
            this.selectedCampaign = this.campaigns.find(c => c.id === campaignId);
            this.showReportModal = true;
        },
        
        async deleteCampaign(campaignId) {
            if (!confirm('Deletar esta campanha?')) return;
            
            // TODO: Implementar endpoint de delete
            this.campaigns = this.campaigns.filter(c => c.id !== campaignId);
            this.showNotification('Campanha deletada');
        },
        
        resetForm() {
            this.newCampaign = {
                name: '',  // Mantido para compatibilidade com backend, mas n√£o exibido no form
                message: '',
                media_url: '',
                media_type: 'video',  // ‚úÖ Padr√£o igual Remarketing Geral
                buttons: [],
                target_audience: 'non_buyers',  // Mantido para compatibilidade, mas calculado automaticamente
                days_since_last_contact: 7,  // ‚úÖ Padr√£o igual Remarketing Geral
                exclude_buyers: false,  // ‚úÖ Padr√£o igual Remarketing Geral
                cooldown_hours: 24,
                send_mode: 'immediate',  // ‚úÖ V2.0
                scheduled_date: '',      // ‚úÖ V2.0
                scheduled_time: '',        // ‚úÖ V2.0
                audio_enabled: false,  // ‚úÖ V2.0
                audio_url: ''  // ‚úÖ V2.0
            };
            // Gerar nome autom√°tico baseado em timestamp
            this.newCampaign.name = `Campanha ${new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}`;
        },
        
        // ‚úÖ V2.0: Formatar data/hora agendada para preview
        formatScheduledDateTime() {
            if (!this.newCampaign.scheduled_date || !this.newCampaign.scheduled_time) {
                return '';
            }
            
            const date = new Date(`${this.newCampaign.scheduled_date}T${this.newCampaign.scheduled_time}`);
            const options = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/Sao_Paulo'
            };
            return date.toLocaleString('pt-BR', options);
        },
        
        getStatusLabel(status) {
            const labels = {
                'draft': 'Rascunho',
                'scheduled': 'Agendada',  // ‚úÖ V2.0
                'sending': 'Enviando...',
                'completed': 'Conclu√≠da',
                'paused': 'Pausada',
                'failed': 'Falhou'
            };
            return labels[status] || status;
        },
        
        getDuration(campaign) {
            if (!campaign.started_at || !campaign.completed_at) return '-';
            const start = new Date(campaign.started_at);
            const end = new Date(campaign.completed_at);
            const diff = Math.round((end - start) / 1000 / 60); // minutos
            return diff + ' minuto' + (diff !== 1 ? 's' : '');
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('pt-BR');
        },
        
        // ‚úÖ V2.0: Formatar data/hora agendada de campanha
        formatCampaignScheduledDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'America/Sao_Paulo'
                });
            } catch (e) {
                return dateStr;
            }
        },
        
        showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    }
}
</script>
{% endblock %}

