{% extends "base.html" %}
{% block title %}Configurar Bot - {{ bot.name }}{% endblock %}

{% block extra_head %}
<style>
/* ✅ Editor Visual de Fluxo - jsPlumb Styles */
.connection-label {
    background: rgba(0, 0, 0, 0.8);
    color: #FFFFFF;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    pointer-events: none;
}

.flow-step-block {
    transition: transform 0.2s, box-shadow 0.2s;
    min-width: 200px;
    max-width: 280px;
    width: 240px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    touch-action: none;
    -webkit-touch-callout: none;
}

/* ✅ Prevenir seleção de texto durante drag */
.flow-step-block.dragging {
    cursor: grabbing !important;
    user-select: none !important;
    pointer-events: all;
    opacity: 0.9;
    transform: scale(1.05);
    z-index: 1000 !important;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.8) !important;
}

.flow-step-block:not(.dragging) {
    cursor: move;
}

/* ✅ Garantir que botões dentro do card não sejam arrastáveis */
.flow-step-block button,
.flow-step-block input,
.flow-step-block textarea,
.flow-step-block select,
.flow-step-block a,
.flow-step-block i {
    cursor: pointer !important;
    pointer-events: auto !important;
    user-select: auto !important;
}

/* ✅ Prevenir que o canvas seja arrastável */
#flow-visual-canvas {
    user-select: none;
    -webkit-user-select: none;
    cursor: default;
    position: relative;
}

/* ✅ PAN: Cursor de arrasto quando estiver arrastando o canvas */
#flow-visual-canvas.panning {
    cursor: grabbing !important;
}

/* ✅ ZOOM: Garantir que elementos internos possam ser escalados */
#flow-visual-canvas .jtk-surface-canvas {
    transition: transform 0.1s ease-out;
}

/* ✅ Permitir seleção apenas em inputs dentro do canvas */
#flow-visual-canvas input,
#flow-visual-canvas textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

/* ✅ Estilos para drop zones durante drag de conexões */
.drop-hover {
    border-color: #10B981 !important;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.5) !important;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

.drop-active {
    border-color: #34D399 !important;
    box-shadow: 0 0 20px rgba(52, 211, 153, 0.7) !important;
    transform: scale(1.05);
}

/* ✅ Garantir que linhas de conexão sejam arrastáveis */
.jtk-connector {
    cursor: move !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
}

.jtk-endpoint-connected {
    cursor: crosshair !important;
}

/* ✅ Endpoints VERDE (entrada) e VERMELHO (saída) */
/* ✅ CRÍTICO: Ocultar endpoints jsPlumb padrão - usamos apenas elementos visuais HTML */
.jtk-endpoint {
    display: none !important; /* ✅ Ocultar endpoints jsPlumb - usamos apenas elementos visuais */
}

/* ✅ Manter visíveis apenas nossos elementos visuais customizados */
.step-input-endpoint,
.step-output-endpoint,
.btn-visual-endpoint {
    display: block !important;
    pointer-events: auto !important;
}

/* ✅ Estilos para endpoints visuais (já definidos inline, mas garantir) */
.jtk-endpoint[data-endpoint-type="input"] {
    background: #10B981 !important;
    border: 3px solid #059669 !important;
}

.jtk-endpoint[data-endpoint-type="output"] {
    background: #EF4444 !important;
    border: 3px solid #DC2626 !important;
}

/* ✅ Hover em conexões para remover */
.jtk-connector {
    cursor: pointer !important;
}

.jtk-connector:hover {
    stroke-width: 4 !important;
    opacity: 0.9 !important;
}

/* ✅ Responsividade para telas menores */
@media (max-width: 768px) {
    .flow-step-block {
        min-width: 180px;
        max-width: 240px;
        width: 200px;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 320px) !important;
        min-height: 400px !important;
    }
    
    .config-section {
        padding: 16px;
    }
    
    .config-section-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

@media (max-width: 640px) {
    .flow-step-block {
        min-width: 160px;
        max-width: 200px;
        width: 180px;
        font-size: 0.875rem;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 280px) !important;
        min-height: 350px !important;
    }
    
    .config-section {
        padding: 12px;
        border-radius: 8px;
    }
    
    .config-section-header {
        gap: 8px;
    }
    
    .config-section-title {
        font-size: 1rem;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    /* Grids responsivos */
    .grid.grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .grid.grid-cols-1.md\:grid-cols-3 {
        grid-template-columns: 1fr;
    }
}

/* ✅ Garantir que todos os containers sejam 100% em mobile */
@media (max-width: 640px) {
    /* Container principal - garantir 100% width */
    .max-w-full {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    /* Botões full width em mobile */
    .btn-action {
        width: 100%;
        justify-content: center;
    }
    
    /* Canvas do editor visual - garantir 100% em mobile */
    #flow-visual-canvas {
        width: 100% !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 0 !important;
    }
    
    /* Garantir que grids sejam sempre 1 coluna em mobile */
    .grid {
        grid-template-columns: 1fr !important;
    }
}

/* ✅ Garantir que elementos não quebrem o layout */
* {
    box-sizing: border-box;
}

/* ✅ Prevenir overflow horizontal */
body {
    overflow-x: hidden;
}

/* ✅ Garantir que modais sejam responsivos */
@media (max-width: 640px) {
    .fixed.inset-0.z-50 > .flex > div,
    [id^="flow-step-modal-"],
    [id^="condition-modal-"] {
        width: 95% !important;
        max-width: 95% !important;
        margin: 0 auto !important;
        padding: 1rem !important;
    }
}

.flow-step-block:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    z-index: 100 !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
    transition: all 0.2s ease;
}

.jtk-endpoint:hover {
    transform: scale(1.3);
    z-index: 50 !important;
}

.jtk-connector {
    cursor: pointer;
    transition: stroke-width 0.2s ease;
}

.jtk-connector:hover {
    stroke-width: 4 !important;
    filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.6));
}

/* ✅ Melhorar visual das conexões */
.jtk-connector path {
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* ✅ Estilo para conexões de botões customizados (vermelhas) */
.jtk-connector[data-button-connection="true"] {
    stroke: #FF6B6B !important;
    stroke-width: 3 !important;
}

.jtk-connector[data-button-connection="true"]:hover {
    stroke-width: 5 !important;
    filter: drop-shadow(0 0 6px rgba(255, 107, 107, 0.8));
}

/* ✅ Botão de remover conexão (ao passar mouse) - MELHORADO */
.jtk-overlay-connection-delete {
    background: #EF4444 !important;
    border-radius: 50% !important;
    width: 24px !important;
    height: 24px !important;
    cursor: pointer !important;
    opacity: 0;
    transition: all 0.2s ease;
    border: 2px solid #FFFFFF !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.jtk-overlay-connection-delete::before {
    content: '×' !important;
    color: #FFFFFF !important;
    font-size: 18px !important;
    font-weight: bold !important;
    line-height: 1 !important;
}

.jtk-connector:hover .jtk-overlay-connection-delete {
    opacity: 1 !important;
    transform: scale(1.1);
}

.jtk-connector:hover {
    cursor: pointer !important;
}

/* ✅ Indicador visual de que a linha pode ser removida */
.jtk-connector[data-removable="true"] {
    position: relative;
}

.jtk-connector[data-removable="true"]::after {
    content: '❌ Duplo clique para remover';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(239, 68, 68, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 1000;
}

.jtk-connector[data-removable="true"]:hover::after {
    opacity: 1;
}

/* ✅ Feedback visual ao arrastar */
.jtk-drag-select {
    border: 2px dashed #3B82F6;
    background: rgba(59, 130, 246, 0.1);
}

/* ✅ Tooltip para conexões */
.connection-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
}

/* ✅ Estilos para endpoints de botões customizados */
.btn-endpoint-marker,
.btn-visual-endpoint {
    position: absolute;
    width: 16px;
    height: 16px;
    background: #FF6B6B;
    border: 3px solid #FF0000;
    border-radius: 50%;
    cursor: crosshair;
    z-index: 30;
    box-shadow: 0 0 8px rgba(255, 107, 107, 0.8);
    transition: all 0.2s ease;
    pointer-events: all;
}

.btn-endpoint-marker:hover,
.btn-visual-endpoint:hover {
    background: #FF8787;
    border-color: #FF3333;
    transform: translateY(-50%) scale(1.3) !important;
    box-shadow: 0 0 12px rgba(255, 107, 107, 1);
}

.btn-endpoint-label {
    background: rgba(255, 107, 107, 0.9);
    color: #FFFFFF;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    pointer-events: none;
    border: 1px solid #FF0000;
}

.btn-endpoint-label-text {
    position: absolute;
    font-size: 10px;
    color: #FF6B6B;
    font-weight: bold;
    white-space: nowrap;
    pointer-events: none;
    transform: translateY(-50%);
    z-index: 25;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
}

/* Bot Config V2.0 - Design System */

.config-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .config-section {
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 20px;
    }
}

@media (min-width: 768px) {
    .config-section {
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }
}

.config-section-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

@media (min-width: 640px) {
    .config-section-header {
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
    }
}

.config-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #FFFFFF;
    word-wrap: break-word;
}

@media (min-width: 640px) {
    .config-section-title {
        font-size: 1.125rem;
    }
}

@media (min-width: 768px) {
    .config-section-title {
        font-size: 1.25rem;
    }
}

.config-section-description {
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-top: 4px;
    word-wrap: break-word;
}

@media (min-width: 640px) {
    .config-section-description {
        font-size: 0.875rem;
    }
}

.form-group {
    margin-bottom: 16px;
    width: 100%;
}

@media (min-width: 640px) {
    .form-group {
        margin-bottom: 20px;
    }
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #D1D1D1;
    margin-bottom: 8px;
}

.form-input {
    width: 100%;
    max-width: 100%;
    padding: 10px 12px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .form-input {
        padding: 12px 16px;
    }
}

.form-input:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-textarea {
    width: 100%;
    max-width: 100%;
    padding: 10px 12px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    resize: vertical;
    min-height: 100px;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .form-textarea {
        padding: 12px 16px;
        min-height: 120px;
    }
}

.form-textarea:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.tab-nav {
    display: flex;
    gap: 0;
    border-bottom: 2px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 24px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.tab-nav::-webkit-scrollbar {
    height: 4px;
}

.tab-nav::-webkit-scrollbar-track {
    background: transparent;
}

.tab-nav::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}

.tab-button {
    padding: 12px 16px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #9CA3AF;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
}

@media (min-width: 640px) {
    .tab-button {
        padding: 16px 24px;
    }
}

.tab-button:hover {
    color: #D1D1D1;
}

.tab-button.active {
    color: #FFB800;
    border-bottom-color: #FFB800;
}

.button-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
}

.order-bump-card {
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.05) 0%, rgba(255, 184, 0, 0.02) 100%);
    border: 1px solid rgba(255, 184, 0, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
}

.order-bump-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 184, 0, 0.1);
}

.order-bump-index {
    width: 32px;
    height: 32px;
    background: rgba(255, 184, 0, 0.1);
    border: 2px solid rgba(255, 184, 0, 0.4);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    color: #FFB800;
}

.button-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.button-index {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    font-weight: 700;
    color: #6EE7B7;
}

.info-box {
    padding: 16px;
    background: rgba(59, 130, 246, 0.05);
    border-left: 4px solid #3B82F6;
    border-radius: 0 8px 8px 0;
    margin-top: 12px;
}

/* ✅ UX MELHORIAS: Estilos para campos essenciais, preview e validação inline */

/* Campos Essenciais */
.essential-fields {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
}

.field-group {
    margin-bottom: 20px;
}

.field-label-essential {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #FFFFFF;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

.label-icon {
    font-size: 1.125rem;
}

.required-badge {
    color: #EF4444;
    font-weight: bold;
    margin-left: 2px;
}

.field-help {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-top: 6px;
    font-size: 13px;
    color: #9CA3AF;
    line-height: 1.5;
}

.field-help i {
    color: #3B82F6;
    margin-top: 2px;
    flex-shrink: 0;
}

.field-error {
    margin-top: 6px;
    padding: 8px 12px;
    background: rgba(239, 68, 68, 0.1);
    border-left: 3px solid #EF4444;
    border-radius: 4px;
    color: #FCA5A5;
    font-size: 13px;
}

.field-status {
    margin-top: 6px;
    font-size: 13px;
    font-weight: 500;
}

.field-status.valid {
    color: #10B981;
}

.field-status.invalid {
    color: #F59E0B;
}

.price-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.price-currency {
    color: #10B981;
    font-weight: 600;
    font-size: 1rem;
}

.field-input-price {
    flex: 1;
    text-align: center;
    font-weight: 600;
    font-size: 1.125rem;
}

.char-counter {
    text-align: right;
    font-size: 12px;
    color: #6B7280;
    margin-top: 4px;
}

/* Preview Sidebar */
.preview-sidebar {
    position: sticky;
    top: 80px;
    width: 100%;
    max-width: 360px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    background: rgba(17, 24, 39, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    /* ✅ Removido margin-left - grid já controla o espaçamento */
}

@media (max-width: 1024px) {
    .preview-sidebar {
        position: relative;
        top: 0;
        max-width: 100%;
        margin-top: 24px;
    }
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.preview-title {
    font-size: 1rem;
    font-weight: 700;
    color: #FFFFFF;
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-content {
    position: relative;
}

/* Telegram Preview Simulation */
.telegram-preview {
    background: #FFFFFF;
    border-radius: 8px;
    padding: 16px;
    min-height: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    margin-bottom: 16px;
}

/* Preview Stats */
.preview-stats {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: 0.75rem;
    color: #9CA3AF;
    font-weight: 500;
}

.stat-value {
    font-size: 0.875rem;
    color: #FFFFFF;
    font-weight: 600;
}

.stat-value.highlight {
    color: #10B981;
    font-size: 1rem;
}

.telegram-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #E5E7EB;
}

.telegram-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #0088CC;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFFFFF;
    font-size: 1.25rem;
}

.telegram-name {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
}

.telegram-time {
    font-size: 0.75rem;
    color: #6B7280;
}

.telegram-badge-access {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 6px;
    color: #22C55E;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 8px;
}

.telegram-message {
    margin-bottom: 12px;
}

.message-content {
    background: #E5E7EB;
    padding: 10px 14px;
    border-radius: 8px;
    color: #111827;
    font-size: 0.875rem;
    line-height: 1.5;
    max-width: 80%;
    word-wrap: break-word;
}

.message-time {
    font-size: 0.75rem;
    color: #6B7280;
    margin-top: 4px;
    margin-left: 4px;
}

.telegram-media {
    margin-bottom: 12px;
}

.media-placeholder {
    width: 200px;
    height: 150px;
    background: #F3F4F6;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #9CA3AF;
    font-size: 0.875rem;
}

.telegram-button-wrapper {
    margin-top: 16px;
}

.telegram-button {
    width: 100%;
    padding: 12px 20px;
    background: #0088CC;
    color: #FFFFFF;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
}

.telegram-button:hover {
    background: #006BA3;
}

.button-price {
    font-weight: 700;
    font-size: 1.125rem;
}

.telegram-order-bump {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #E5E7EB;
}

.order-bump-banner {
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
}

.banner-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.banner-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.banner-text {
    flex: 1;
}

.banner-title {
    font-weight: 700;
    color: #92400E;
    font-size: 0.875rem;
    margin-bottom: 4px;
}

.banner-message {
    color: #78350F;
    font-size: 0.75rem;
    line-height: 1.4;
}

.banner-price {
    font-weight: 700;
    color: #92400E;
    font-size: 1rem;
    flex-shrink: 0;
}

.order-bump-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.ob-button {
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.ob-accept {
    background: #10B981;
    color: #FFFFFF;
}

.ob-accept:hover {
    background: #059669;
}

.ob-decline {
    background: #F3F4F6;
    color: #374151;
}

.ob-decline:hover {
    background: #E5E7EB;
}

.preview-requirements {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.requirement-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

.requirement-item.valid {
    color: #10B981;
}

.requirement-item.invalid {
    color: #F59E0B;
}

/* Seções Colapsáveis */
.collapsible-section {
    margin-bottom: 16px;
}

.section-toggle {
    width: 100%;
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
}

.section-toggle:hover {
    background: rgba(255, 255, 255, 0.04);
    border-color: rgba(255, 255, 255, 0.12);
}

.section-toggle-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-toggle-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.section-icon {
    font-size: 1.5rem;
}

.section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #FFFFFF;
    margin-bottom: 4px;
}

.section-subtitle {
    font-size: 0.875rem;
    color: #9CA3AF;
}

.section-toggle-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.section-badge {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #6EE7B7;
}

.section-chevron {
    transition: transform 0.3s;
    color: #9CA3AF;
}

.section-chevron.rotate-180 {
    transform: rotate(180deg);
}

.section-content {
    margin-top: 16px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.01);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

/* Order Bump Cards Compactos */
.order-bumps-list {
    margin-bottom: 16px;
}

.order-bump-card-compact {
    background: rgba(255, 184, 0, 0.05);
    border: 1px solid rgba(255, 184, 0, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
}

.order-bump-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-bump-card-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.order-bump-badge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.order-bump-badge.enabled {
    background: rgba(255, 184, 0, 0.2);
    border: 2px solid rgba(255, 184, 0, 0.5);
    color: #FFB800;
}

.order-bump-badge.disabled {
    background: rgba(107, 114, 128, 0.2);
    border: 2px solid rgba(107, 114, 128, 0.3);
    color: #9CA3AF;
}

.order-bump-name {
    font-weight: 600;
    color: #FFFFFF;
    font-size: 0.875rem;
    margin-bottom: 2px;
}

.order-bump-price {
    font-size: 0.75rem;
    color: #9CA3AF;
}

.order-bump-card-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #374151;
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background-color: #FFB800;
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.02);
    color: #9CA3AF;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    color: #FFFFFF;
}

.btn-icon-danger {
    border-color: rgba(239, 68, 68, 0.3);
    color: #FCA5A5;
}

.btn-icon-danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #EF4444;
    color: #FFFFFF;
}

.btn-add-item {
    width: 100%;
    padding: 12px;
    background: rgba(255, 184, 0, 0.1);
    border: 2px dashed rgba(255, 184, 0, 0.3);
    border-radius: 8px;
    color: #FFB800;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-add-item:hover {
    background: rgba(255, 184, 0, 0.15);
    border-color: rgba(255, 184, 0, 0.5);
}

.stats-box {
    margin-top: 16px;
    padding: 16px;
    background: rgba(16, 185, 129, 0.05);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 8px;
    display: flex;
    gap: 24px;
}

.stat-item {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 1.125rem;
    font-weight: 700;
    color: #6EE7B7;
}

.info-banner {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 8px;
    margin-bottom: 16px;
}

.info-banner i {
    color: #60A5FA;
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.info-banner strong {
    display: block;
    color: #93C5FD;
    margin-bottom: 4px;
    font-size: 0.875rem;
}

.info-banner p {
    color: #DBEAFE;
    font-size: 0.875rem;
    line-height: 1.5;
    margin: 0;
}

/* Auto-save Indicator */
.save-status {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    background: rgba(17, 24, 39, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #FFFFFF;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
}

.save-status.saving {
    color: #F59E0B;
}

.save-status.saved {
    color: #10B981;
}

.save-status.error {
    color: #EF4444;
}

/* Layout com Preview */
.layout-with-preview {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 24px;
    align-items: start;
}

@media (max-width: 1024px) {
    .layout-with-preview {
        grid-template-columns: 1fr;
    }
}

.info-box-success {
    background: rgba(16, 185, 129, 0.05);
    border-left-color: #10B981;
}

.info-box-warning {
    background: rgba(255, 184, 0, 0.05);
    border-left-color: #FFB800;
}

.order-bump-section {
    background: rgba(255, 184, 0, 0.03);
    border: 1px solid rgba(255, 184, 0, 0.15);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.subscription-section {
    background: rgba(255, 184, 0, 0.03);
    border: 1px solid rgba(255, 184, 0, 0.15);
    border-radius: 12px;
    padding: 20px;
}

/* Botões de Ação - IDÊNTICO ao Dashboard */
.btn-action {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-action:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.btn-action i {
    margin-right: 0.5rem;
}

/* Todas as variantes usam o mesmo estilo dourado */
.btn-action-primary,
.btn-action-success,
.btn-action-info {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-action-primary:hover,
.btn-action-success:hover,
.btn-action-info:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Botões de Precificação (Downsells) */
.pricing-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 700;
    transition: all 0.15s ease;
    cursor: pointer;
}

.pricing-btn-active {
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    border: 2px solid var(--brand-gold-500);
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
}

.pricing-btn-inactive {
    color: #9CA3AF;
    background: #1F2937;
    border: 2px solid #374151;
}

.pricing-btn-inactive:hover {
    color: #D1D5DB;
    border-color: #4B5563;
    background: #374151;
}
</style>
<script>
    window.stripSurrogateChars = function (value) {
        if (!value) {
            return '';
        }
        try {
            // ✅ CORREÇÃO CRÍTICA: Remover APENAS surrogates inválidos (isolados)
            // Preservar pares de surrogates válidos (emojis, caracteres Unicode especiais)
            // Surrogates válidos vêm em pares: high surrogate (\uD800-\uDBFF) + low surrogate (\uDC00-\uDFFF)
            // Surrogates inválidos são isolados ou fora de ordem
            
            // Não remover nada - deixar o texto como está
            // O Telegram e o banco de dados suportam UTF-8 completo
            return value;
        } catch (err) {
            return value || '';
        }
    };
</script>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8" x-data="botConfigApp()" x-init="init()">
    
    <!-- Header -->
    <div class="mb-4 sm:mb-6 md:mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4">
        <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto">
            <a href="{{ url_for('dashboard') }}" 
               class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-700 text-gray-400 hover:text-white hover:border-yellow-500 transition-all flex-shrink-0">
                <i class="fas fa-arrow-left text-sm sm:text-base"></i>
            </a>
            <div class="min-w-0 flex-1">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-white truncate">{{ bot.name }}</h1>
                <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">@{{ bot.username }}</p>
            </div>
        </div>
        <div class="flex items-center space-x-2 sm:space-x-3 w-full sm:w-auto">
            <!-- ❌ REMOVIDO: Meta Pixel agora é configurado POR POOL (não por bot) -->
            <!-- Acesse: Redirecionadores → Editar Pool → Meta Pixel -->
            <button @click="saveConfig()" 
                    :disabled="loading"
                    :class="{'opacity-50 cursor-not-allowed': loading}"
                    class="btn-action btn-action-primary w-full sm:w-auto text-sm sm:text-base px-3 sm:px-6 py-2 sm:py-3">
                <span x-show="!loading">
                    <i class="fas fa-save mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Salvar Configurações</span>
                    <span class="sm:hidden">Salvar</span>
                </span>
                <span x-show="loading">
                    <i class="fas fa-spinner fa-spin mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Salvando...</span>
                    <span class="sm:hidden">Salvando</span>
                </span>
            </button>
        </div>
    </div>

    <!-- ✅ UX MELHORIAS: Indicador de Auto-save -->
    <div x-show="getSaveStatusText()" 
         x-cloak
         class="save-status"
         :class="{
             'saving': saveStatus === 'saving',
             'saved': saveStatus === 'saved',
             'error': saveStatus === 'error'
         }"
         x-text="getSaveStatusText()"></div>
    
    <!-- Tabs -->
    <div class="tab-nav overflow-x-auto -mx-2 sm:-mx-4 md:-mx-6 lg:-mx-8 px-2 sm:px-4 md:px-6 lg:px-8">
        <div class="flex gap-1 sm:gap-2 min-w-max">
            <button @click="activeTab = 'welcome'" 
                    :class="{'active': activeTab === 'welcome'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-home mr-1 sm:mr-2"></i><span class="hidden sm:inline">Boas-vindas</span><span class="sm:hidden">Boas-vindas</span>
            </button>
            <button @click="activeTab = 'flow'" 
                    :class="{'active': activeTab === 'flow'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-project-diagram mr-1 sm:mr-2"></i><span class="hidden sm:inline">Fluxo</span><span class="sm:hidden">Fluxo</span>
            </button>
            <button @click="activeTab = 'buttons'" 
                    :class="{'active': activeTab === 'buttons'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-shopping-cart mr-1 sm:mr-2"></i><span class="hidden sm:inline">Botões</span><span class="sm:hidden">Botões</span>
            </button>
            <button @click="activeTab = 'downsells'" 
                    :class="{'active': activeTab === 'downsells'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-arrow-down mr-1 sm:mr-2"></i><span class="hidden sm:inline">Downsells</span><span class="sm:hidden">Down</span>
            </button>
            <button @click="activeTab = 'upsells'" 
                    :class="{'active': activeTab === 'upsells'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-arrow-up mr-1 sm:mr-2"></i><span class="hidden sm:inline">Upsells</span><span class="sm:hidden">Up</span>
            </button>
            <button @click="activeTab = 'access'" 
                    :class="{'active': activeTab === 'access'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-key mr-1 sm:mr-2"></i><span class="hidden sm:inline">Acesso</span><span class="sm:hidden">Acesso</span>
            </button>
            <button @click="activeTab = 'remarketing'" 
                    :class="{'active': activeTab === 'remarketing'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-bullhorn mr-1 sm:mr-2"></i><span class="hidden sm:inline">Remarketing</span><span class="sm:hidden">Remark</span>
            </button>
            <button @click="activeTab = 'settings'" 
                    :class="{'active': activeTab === 'settings'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-cog mr-1 sm:mr-2"></i><span class="hidden sm:inline">Configurações</span><span class="sm:hidden">Config</span>
            </button>
        </div>
    </div>

    <!-- Tab Content: Welcome -->
    <div x-show="activeTab === 'welcome'" x-cloak>
        <!-- ⚠️ Aviso quando Fluxo está ativado -->
        <div x-show="config.flow_enabled" 
             x-cloak
             class="mb-6 p-4 bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 rounded-xl">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                <div class="flex-1">
                    <div class="text-yellow-400 font-bold mb-1">⚠️ Fluxo Visual Ativado</div>
                    <div class="text-sm text-gray-300">
                        O <strong>Fluxo Visual</strong> está ativo e será executado ao invés da mensagem de Boas-vindas quando o usuário iniciar o bot.
                        <br>
                        <span class="text-xs text-gray-400 mt-1 block">
                            As configurações de Boas-vindas abaixo são mantidas como fallback caso o Fluxo seja desativado.
                        </span>
                    </div>
                    <button @click="activeTab = 'flow'" 
                            class="mt-3 px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                        <i class="fas fa-project-diagram mr-2"></i>
                        Ir para Editor de Fluxo
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-home text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Mensagem de Boas-vindas</div>
                    <div class="config-section-description">
                        <span x-show="!config.flow_enabled">Primeira impressão quando o usuário inicia o bot</span>
                        <span x-show="config.flow_enabled" class="text-gray-400">Configuração mantida como fallback (Fluxo Visual ativo)</span>
                    </div>
                </div>
            </div>

            <!-- Mensagem -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-comment-dots mr-2 text-yellow-500"></i>
                    Mensagem de Texto
                </label>
                <textarea x-model="config.welcome_message"
                          class="form-textarea"
                          maxlength="4096"
                          @input="validateWelcomeMessage()"
                          placeholder="Olá! Bem-vindo ao nosso bot de vendas...&#10;&#10;Escolha uma das opções abaixo:"></textarea>
                <p class="text-xs mt-1" x-show="config.welcome_message">
                    <span class="text-gray-500">Caracteres: </span>
                    <span :class="{'text-green-400 font-bold': getWelcomeMessageLength() <= 4096, 'text-red-400 font-bold': getWelcomeMessageLength() > 4096}" 
                          x-text="getWelcomeMessageLength()"></span>
                    <span class="text-gray-500"> / </span>
                    <span class="text-gray-400 font-bold">4096</span>
                    <span x-show="getWelcomeMessageLength() > 4096" 
                          class="text-red-400 ml-2 font-bold">
                        ❌ Excede o limite do Telegram (4096)!
                    </span>
                </p>
            </div>

            <!-- Mídia -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        URL da Mídia
                    </label>
                    <input type="url" 
                           x-model="config.welcome_media_url" 
                           @input="validateWelcomeMessage()"
                           @change="validateWelcomeMessage()"
                           class="form-input"
                           placeholder="https://t.me/canal/123">
                    <p class="text-xs text-gray-500 mt-2">Link do Telegram (vídeo, foto ou áudio)</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-image mr-2 text-blue-500"></i>
                        Tipo de Mídia Principal
                    </label>
                    <div class="flex gap-3 mt-2">
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': config.welcome_media_type === 'video'}">
                            <input type="radio" x-model="config.welcome_media_type" value="video" class="text-blue-500">
                            <i class="fas fa-video text-blue-500"></i>
                            <span class="text-sm text-white">Vídeo</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': config.welcome_media_type === 'photo'}">
                            <input type="radio" x-model="config.welcome_media_type" value="photo" class="text-blue-500">
                            <i class="fas fa-camera text-blue-500"></i>
                            <span class="text-sm text-white">Foto</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label flex items-center gap-2">
                        <input type="checkbox" 
                               x-model="config.welcome_audio_enabled"
                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                               style="accent-color: #3B82F6;">
                        <i class="fas fa-microphone mr-1 text-purple-500"></i>
                        <span>Adicionar Áudio Complementar (opcional)</span>
                    </label>
                    <div x-show="config.welcome_audio_enabled" x-cloak class="mt-2">
                        <input type="url" 
                               x-model="config.welcome_audio_url" 
                               class="form-input"
                               placeholder="https://t.me/canal/789">
                        <p class="text-xs text-gray-500 mt-2">Link do áudio no Telegram (será enviado após a mídia principal)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Flow -->
    <div x-show="activeTab === 'flow'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-project-diagram text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Editor de Fluxograma Visual</div>
                    <div class="config-section-description">Crie fluxos personalizados com blocos conectados</div>
                </div>
            </div>

            <!-- Toggle Ativar Fluxo -->
            <div class="form-group">
                <label class="flex items-center gap-2">
                    <input type="checkbox" 
                           x-model="config.flow_enabled"
                           @change="onFlowToggle()"
                           class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                           style="accent-color: #3B82F6;">
                    <i class="fas fa-toggle-on mr-1 text-blue-500"></i>
                    <span class="text-white font-medium">Ativar Fluxo Visual</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">
                    Quando ativado, desativa automaticamente Boas-vindas. O fluxo será executado ao invés de welcome_message.
                </p>
            </div>

            <!-- Lista Visual de Steps (Padrão) -->
            <div x-show="config.flow_enabled" x-cloak class="mt-6">
                <!-- ⚠️ Aviso se não houver step inicial -->
                <div x-show="config.flow_steps && config.flow_steps.length > 0 && !config.flow_start_step_id" 
                     x-cloak
                     class="mb-4 p-4 bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 rounded-xl">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                        <div class="flex-1">
                            <div class="text-yellow-400 font-bold mb-1">⚠️ Step Inicial Não Definido</div>
                            <div class="text-sm text-gray-300">
                                O fluxo precisa de um step inicial para começar quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.
                                <br>
                                <span class="text-xs text-gray-400 mt-1 block">
                                    Clique no botão "Inicial" em qualquer step para defini-lo como inicial, ou o primeiro step será usado automaticamente.
                                </span>
                            </div>
                            <button @click="setFlowStartStep(sortedFlowSteps[0]?.id)" 
                                    x-show="sortedFlowSteps.length > 0"
                                    class="mt-3 px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                <i class="fas fa-play mr-2"></i>
                                Definir Primeiro Step como Inicial
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ✅ Info do step inicial definido -->
                <div x-show="config.flow_start_step_id" 
                     x-cloak
                     class="mb-4 p-4 bg-green-500 bg-opacity-25 border-2 border-green-500 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        <div class="flex-1">
                            <div class="text-green-400 font-bold mb-1">✅ Step Inicial Definido</div>
                            <div class="text-sm text-gray-200">
                                O fluxo iniciará no step marcado com <span class="text-yellow-400 font-bold">⭐ Inicial</span> quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white">Steps do Fluxo</h3>
                    <div class="flex items-center gap-3">
                        <button @click="addFlowStep()" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-plus mr-2"></i>Adicionar Step
                        </button>
                    </div>
                </div>

                <!-- ✅ EDITOR VISUAL (Canvas com linhas) - SEMPRE VISÍVEL -->
                <div class="mb-6 w-full overflow-hidden">
                    <div class="bg-gray-900 rounded-lg border-2 border-blue-500 p-2 sm:p-3 md:p-4 w-full max-w-full">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-project-diagram text-blue-400 text-xl"></i>
                                <h4 class="text-white font-bold text-sm sm:text-base">Editor Visual de Fluxo</h4>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-400 flex-wrap">
                                <i class="fas fa-info-circle flex-shrink-0"></i>
                                <span class="text-xs sm:text-sm">Arraste os blocos para reposicionar • Clique e arraste para conectar • <strong class="text-red-400">Duplo clique ou botão direito na linha para remover</strong></span>
                            </div>
                        </div>
                        <!-- ✅ Mensagem se não houver steps -->
                        <div x-show="!config.flow_steps || config.flow_steps.length === 0" 
                             x-cloak
                             class="text-center py-12 text-gray-400">
                            <i class="fas fa-project-diagram text-4xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium mb-2">Nenhum step criado ainda</p>
                            <p class="text-sm">Adicione um step clicando em "Adicionar Step" acima</p>
                        </div>
                        <!-- ✅ Canvas apenas se houver steps -->
                        <div x-show="config.flow_steps && config.flow_steps.length > 0"
                             x-cloak
                             x-init="$nextTick(() => { initVisualFlowEditor(); })"
                             class="w-full overflow-hidden">
                            <div id="flow-visual-canvas" 
                                 class="relative w-full bg-gray-950 rounded border border-gray-700"
                                 style="height: calc(100vh - 380px); min-height: 500px; max-height: 90vh; overflow: auto; width: 100%; max-width: 100%; box-sizing: border-box; position: relative; touch-action: pan-x pan-y; overscroll-behavior: contain; cursor: grab;">
                                <!-- Steps serão renderizados aqui via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ✅ REMOVIDO: Lista de Steps - Agora apenas Visual (Editor Visual sempre ativo) -->
            </div>
        </div>
    </div>

    <!-- Tab Content: Buttons -->
    <div x-show="activeTab === 'buttons'" x-cloak>
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-white">🛍️ Botões de Venda</h2>
                <p class="text-sm text-gray-500 mt-1">Configure seus produtos e ofertas</p>
            </div>
            <button @click="addButton()" class="btn-action btn-action-success">
                <i class="fas fa-plus mr-2"></i>
                Adicionar Produto
            </button>
        </div>

        <!-- Lista de Botões com Preview -->
        <template x-if="config.main_buttons.length > 0">
            <div class="space-y-6">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="layout-with-preview">
                        <!-- Lado Esquerdo: Configuração -->
                        <div class="flex-1">
                            <div class="button-card">
                                <!-- Header -->
                                <div class="button-card-header">
                                    <div class="flex items-center gap-3">
                                        <div class="button-index" x-text="index + 1"></div>
                                        <div>
                                            <h3 class="text-sm font-bold text-white">Produto <span x-text="index + 1"></span></h3>
                                            <p class="text-xs text-gray-500">Configure preço e ofertas bônus</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <!-- ✅ Toggle de Assinatura no Header -->
                                        <label class="flex items-center gap-2 cursor-pointer" 
                                               :title="(button.subscription && button.subscription.enabled) ? 'Este produto é uma assinatura' : 'Este produto é uma assinatura?'">
                                            <input type="checkbox" 
                                                   x-model="button.subscription.enabled"
                                                   @change="if (!button.subscription) button.subscription = {enabled: true, duration_type: 'days', duration_value: 30, vip_chat_id: '', vip_group_link: '', validation_status: null}"
                                                   class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-yellow-500 focus:ring-yellow-500 focus:ring-2">
                                            <span class="text-xs font-bold" 
                                                  :class="(button.subscription && button.subscription.enabled) ? 'text-yellow-400' : 'text-gray-500'">
                                                <i class="fas fa-calendar-times mr-1"></i>Assinatura
                                            </span>
                                        </label>
                                        <button @click="removeButton(index)" 
                                                class="w-10 h-10 flex items-center justify-center rounded-lg border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10 transition-all"
                                                title="Remover produto">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- ✅ CAMPOS ESSENCIAIS (Sempre Visíveis) -->
                                <div class="essential-fields">
                                    <div class="field-group">
                                        <label class="field-label-essential">
                                            <span class="label-icon">📝</span>
                                            <span>Nome do Produto</span>
                                            <span class="required-badge">*</span>
                                        </label>
                                        <input type="text" 
                                               x-model="button.text" 
                                               class="field-input"
                                               placeholder="Ex: Curso Completo de INSS"
                                               @input="validateField('text', button.text, index); updatePreviewDebounced()"
                                               @blur="validateField('text', button.text, index)">
                                        <div class="field-help">
                                            <i class="fas fa-info-circle"></i>
                                            <span>Este nome aparecerá no botão. Seja claro e direto.</span>
                                        </div>
                                        <div x-show="fieldErrors[`text_${index}`]" 
                                             x-cloak
                                             class="field-error"
                                             x-text="fieldErrors[`text_${index}`]"></div>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label-essential">
                                            <span class="label-icon">💰</span>
                                            <span>Preço de Venda</span>
                                            <span class="required-badge">*</span>
                                        </label>
                                        <div class="price-input-wrapper">
                                            <span class="price-currency">R$</span>
                                            <input type="number" 
                                                   x-model.number="button.price" 
                                                   step="0.01"
                                                   min="0.01"
                                                   class="field-input field-input-price"
                                                   placeholder="19.97"
                                                   @input="validateField('price', button.price, index); updatePreviewDebounced()"
                                                   @blur="validateField('price', button.price, index)">
                                        </div>
                                        <div class="field-help">
                                            <i class="fas fa-lightbulb"></i>
                                            <span><strong>Dica:</strong> Preços terminados em .97 convertem melhor!</span>
                                        </div>
                                        <div class="field-status" 
                                             :class="{'valid': isValidPrice(button.price), 'invalid': !isValidPrice(button.price)}">
                                            <span x-show="isValidPrice(button.price)">✅ Preço válido</span>
                                            <span x-show="!isValidPrice(button.price)">⚠️ Preço inválido (mínimo R$ 3,00)</span>
                                        </div>
                                        <div x-show="fieldErrors[`price_${index}`]" 
                                             x-cloak
                                             class="field-error"
                                             x-text="fieldErrors[`price_${index}`]"></div>
                                    </div>

                                    <!-- ✅ ACESSO IMEDIATO (Campo visível na interface) -->
                                    <div class="field-group">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" 
                                                   x-model="button.immediate_access"
                                                   class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-yellow-500 focus:ring-yellow-500 focus:ring-2">
                                            <span class="field-label">
                                                <span class="label-icon">⚡</span>
                                                <span>Acesso Imediato</span>
                                            </span>
                                        </label>
                                        <div class="field-help">
                                            <i class="fas fa-info-circle"></i>
                                            <span>Cliente recebe o acesso instantaneamente após o pagamento (sem entrar em grupo VIP).</span>
                                        </div>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">
                                            <span class="label-icon">📦</span>
                                            <span>Descrição do Produto</span>
                                        </label>
                                        <textarea x-model="button.description" 
                                                  class="field-textarea"
                                                  placeholder="O que está incluído neste produto?"
                                                  rows="3"
                                                  maxlength="200"
                                                  @input="updateCharCount('description', button.description, 200, index); updatePreviewDebounced()"></textarea>
                                        <div class="field-help">
                                            <i class="fas fa-info-circle"></i>
                                            <span>Esta descrição aparecerá na mensagem de boas-vindas.</span>
                                        </div>
                                        <div class="char-counter">
                                            <span x-text="charCounts[`description_${index}`] || (button.description ? button.description.length : 0)"></span>/200 caracteres
                                        </div>
                                    </div>
                                </div>

                                <!-- ✅ SEÇÃO COLAPSÁVEL: Ofertas Bônus -->
                                <div class="collapsible-section">
                                    <button type="button" 
                                            @click="toggleSection(`order_bumps_${index}`)"
                                            class="section-toggle">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-gift text-yellow-500 text-lg"></i>
                                            <div class="flex-1 text-left">
                                                <h4 class="text-sm font-bold text-white">
                                                    Ofertas Bônus <span x-text="getActiveOrderBumpsCount(index)"></span>
                                                    <span class="text-xs text-gray-500" x-show="getActiveOrderBumpsCount(index) > 0">(ativo)</span>
                                                </h4>
                                                <p class="text-xs text-gray-500">Aumente o ticket médio com ofertas complementares</p>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-gray-500" 
                                                      x-show="getActiveOrderBumpsCount(index) > 0">
                                                    +R$ <span x-text="calculateTotalBonusPrice(index).toFixed(2)"></span>
                                                </span>
                                                <i class="fas fa-chevron-down transition-transform duration-200"
                                                   :class="{'rotate-180': expandedSections[`order_bumps_${index}`]}"></i>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <div x-show="expandedSections[`order_bumps_${index}`]" 
                                         x-collapse
                                         class="collapsible-content">
                                        <div class="flex justify-between items-center mb-4">
                                            <div class="info-banner">
                                                <i class="fas fa-lightbulb"></i>
                                                <span><strong>Dica:</strong> Ofereça bônus complementares para aumentar sua receita em até 80%!</span>
                                            </div>
                                            <button @click="addOrderBump(index)" 
                                                    class="ob-button ob-button-default">
                                                <i class="fas fa-plus mr-1"></i>
                                                Adicionar Oferta
                                            </button>
                                        </div>

                            <!-- Lista de Order Bumps -->
                            <template x-if="button.order_bumps && button.order_bumps.length > 0">
                                <div class="space-y-4">
                                    <template x-for="(orderBump, bumpIndex) in button.order_bumps" :key="bumpIndex">
                                        <div class="order-bump-card">
                                            <div class="order-bump-header">
                                                <div class="flex items-center gap-3">
                                                    <div class="order-bump-index" x-text="bumpIndex + 1"></div>
                                                    <div>
                                                        <h4 class="text-sm font-bold text-white">Order Bump <span x-text="bumpIndex + 1"></span></h4>
                                                        <p class="text-xs text-gray-500">Oferta sequencial</p>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" 
                                                               x-model="orderBump.enabled"
                                                               class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                                        <span class="text-xs text-white">Ativo</span>
                                                    </label>
                                                    <button @click="removeOrderBump(index, bumpIndex)" 
                                                            class="w-8 h-8 flex items-center justify-center rounded-lg border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10 transition-all">
                                                        <i class="fas fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div x-show="orderBump.enabled" class="space-y-4">
                                                <div class="form-group">
                                                    <label class="form-label">Mensagem da Oferta</label>
                                                    <textarea x-model="orderBump.message"
                                                              class="form-textarea"
                                                              maxlength="900"
                                                              @input="orderBump.message = stripSurrogateChars(orderBump.message || '').slice(0, 900)"
                                                              placeholder="🎁 Oferta Especial!&#10;&#10;Adicione este bônus por apenas +R$ 5!"></textarea>
                                                    <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                                                </div>

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Preço Adicional (R$)</label>
                                                        <input type="number" 
                                                               x-model="orderBump.price" 
                                                               step="0.01"
                                                               class="form-input text-center font-mono"
                                                               placeholder="5.00">
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="form-label">Descrição do Bônus</label>
                                                        <input type="text" 
                                                               x-model="orderBump.description" 
                                                               class="form-input"
                                                               placeholder="Acesso Vitalício">
                                                    </div>
                                                </div>

                                                <!-- Mídia do Order Bump -->
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-link mr-2 text-blue-500"></i>
                                                            URL da Mídia (opcional)
                                                        </label>
                                                        <input type="url" 
                                                               x-model="orderBump.media_url" 
                                                               class="form-input"
                                                               placeholder="https://t.me/canal/789">
                                                        <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-image mr-2 text-blue-500"></i>
                                                            Tipo de Mídia
                                                        </label>
                                                        <div class="flex gap-3 mt-2">
                                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                                   :class="{'border-blue-500 bg-blue-500 bg-opacity-10': orderBump.media_type === 'video'}">
                                                                <input type="radio" x-model="orderBump.media_type" value="video" class="text-blue-500">
                                                                <i class="fas fa-video text-blue-500"></i>
                                                                <span class="text-sm text-white">Vídeo</span>
                                                            </label>
                                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                                   :class="{'border-blue-500 bg-blue-500 bg-opacity-10': orderBump.media_type === 'photo'}">
                                                                <input type="radio" x-model="orderBump.media_type" value="photo" class="text-blue-500">
                                                                <i class="fas fa-camera text-blue-500"></i>
                                                                <span class="text-sm text-white">Foto</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Botões Personalizados -->
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-check-circle mr-2 text-green-400"></i>
                                                            Botão Aceitar (opcional)
                                                        </label>
                                                        <input type="text" 
                                                               x-model="orderBump.accept_text" 
                                                               class="form-input"
                                                               placeholder="SIM! Quero esse bônus!">
                                                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padrão</p>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-times-circle mr-2 text-red-400"></i>
                                                            Botão Recusar (opcional)
                                                        </label>
                                                        <input type="text" 
                                                               x-model="orderBump.decline_text" 
                                                               class="form-input"
                                                               placeholder="Não, obrigado">
                                                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padrão</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Empty State -->
                            <template x-if="!button.order_bumps || button.order_bumps.length === 0">
                                <div class="text-center py-8 border-2 border-dashed border-gray-700 rounded-lg">
                                    <div class="text-4xl mb-3">🎁</div>
                                    <h4 class="text-lg font-bold text-white mb-2">Nenhum Order Bump</h4>
                                    <p class="text-gray-500 mb-4">Adicione ofertas sequenciais para aumentar o ticket médio</p>
                                    <button @click="addOrderBump(index)" 
                                            class="px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                        <i class="fas fa-plus mr-2"></i>
                                        Adicionar Primeiro Order Bump
                                    </button>
                                </div>
                            </template>

                            <div class="info-box-warning info-box">
                                <p class="text-sm text-gray-300">
                                    <i class="fas fa-chart-line mr-2 text-yellow-500"></i>
                                    <strong>Conversão:</strong> Múltiplos order bumps convertem até 80% mais! Se o usuário recusar um, receberá o próximo automaticamente.
                                </p>
                            </div>
                        </div>

                        <!-- ✅ SISTEMA DE ASSINATURAS -->
                        <div class="subscription-section mt-6 border-t border-gray-800 pt-6" x-show="button.subscription && button.subscription.enabled">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar-times text-yellow-500"></i>
                                    <span class="text-sm font-bold text-white">Configuração de Assinatura (Acesso Temporário ao Grupo VIP)</span>
                                </div>
                                <div class="flex items-center gap-2 px-3 py-1 bg-yellow-500 bg-opacity-20 border border-yellow-400 rounded-lg">
                                    <i class="fas fa-check-circle text-yellow-400 text-xs"></i>
                                    <span class="text-xs font-bold text-yellow-300">Ativo</span>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-clock mr-2 text-yellow-500"></i>
                                            Tipo de Duração
                                        </label>
                                        <select x-model="button.subscription.duration_type" class="form-input">
                                            <option value="hours">Horas</option>
                                            <option value="days">Dias</option>
                                            <option value="weeks">Semanas</option>
                                            <option value="months">Meses</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-hashtag mr-2 text-yellow-500"></i>
                                            Valor
                                        </label>
                                        <input type="number" 
                                               x-model.number="button.subscription.duration_value"
                                               min="1"
                                               class="form-input text-center font-mono"
                                               placeholder="30">
                                        <p class="text-xs text-gray-500 mt-1">Ex: 30 dias, 2 semanas, 1 mês</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-users mr-2 text-yellow-500"></i>
                                            Status
                                        </label>
                                        <div class="flex items-center gap-2 mt-2">
                                            <span x-show="!button.subscription.validation_status" class="text-xs text-gray-500">Não validado</span>
                                            <span x-show="button.subscription.validation_status === 'validating'" class="text-xs text-yellow-500">
                                                <i class="fas fa-spinner fa-spin mr-1"></i> Validando...
                                            </span>
                                            <span x-show="button.subscription.validation_status === 'valid'" class="text-xs text-green-500">
                                                <i class="fas fa-check-circle mr-1"></i> Válido
                                            </span>
                                            <span x-show="button.subscription.validation_status === 'invalid'" class="text-xs text-red-500">
                                                <i class="fas fa-times-circle mr-1"></i> Inválido
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-id-card mr-2 text-yellow-500"></i>
                                            Chat ID do Grupo VIP
                                        </label>
                                        <input type="text" 
                                               x-model="button.subscription.vip_chat_id"
                                               class="form-input font-mono"
                                               placeholder="-1001234567890 ou link t.me/c/...">
                                        <p class="text-xs text-gray-500 mt-1">ID do grupo (ex: -1001234567890) ou link do Telegram</p>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-link mr-2 text-yellow-500"></i>
                                            Link do Grupo (opcional)
                                        </label>
                                        <input type="text" 
                                               x-model="button.subscription.vip_group_link"
                                               class="form-input"
                                               placeholder="https://t.me/...">
                                        <p class="text-xs text-gray-500 mt-1">Link completo do grupo (para referência)</p>
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <button @click="validateSubscription(index)" 
                                            :disabled="button.subscription.validation_status === 'validating' || (!button.subscription.vip_chat_id && !button.subscription.vip_group_link)"
                                            class="px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        Validar Configuração
                                    </button>
                                </div>

                                <div class="info-box-warning info-box">
                                    <p class="text-sm text-gray-300">
                                        <i class="fas fa-info-circle mr-2 text-yellow-500"></i>
                                        <strong>Como funciona:</strong> Após o pagamento, o lead recebe acesso ao grupo VIP. A contagem de tempo começa quando ele entrar no grupo. Quando o tempo expirar, ele será removido automaticamente.
                                    </p>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- ✅ PREVIEW EM TEMPO REAL (Sidebar) - AO LADO -->
                        <div class="preview-sidebar" x-show="showPreview">
                            <div class="telegram-preview">
                                <div class="telegram-header">
                                    <div class="telegram-avatar">👤</div>
                                    <div>
                                        <div class="telegram-name">Bot do Telegram</div>
                                        <div class="telegram-time">agora</div>
                                    </div>
                                </div>
                                <div class="telegram-message">
                                    <div x-show="button.description" class="telegram-text" x-text="button.description || 'Descrição do produto aparecerá aqui...'"></div>
                                    <div class="telegram-buttons">
                                        <div class="telegram-button" x-show="button.text || button.price">
                                            <span x-text="button.text || 'Nome do produto'"></span>
                                            <span class="telegram-price" x-show="button.price && button.price > 0">
                                                por R$ <span x-text="formatPriceBR(button.price)"></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div x-show="button.immediate_access" class="telegram-badge-access mt-2">
                                        <i class="fas fa-bolt text-xs"></i>
                                        <span class="text-xs">Acesso Imediato</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estatísticas do Produto -->
                            <div class="preview-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Preço Base:</span>
                                    <span class="stat-value">R$ <span x-text="parseFloat(button.price || 0).toFixed(2)"></span></span>
                                </div>
                                <div class="stat-item" x-show="getActiveOrderBumpsCount(index) > 0">
                                    <span class="stat-label">Bônus Total:</span>
                                    <span class="stat-value">+R$ <span x-text="calculateTotalBonusPrice(index).toFixed(2)"></span></span>
                                </div>
                                <div class="stat-item" x-show="getActiveOrderBumpsCount(index) > 0">
                                    <div>
                                        <span class="stat-label">Ticket Médio (estimado):</span>
                                        <span class="text-xs text-gray-400 block mt-0.5">Média com 30% de aceite nos bônus</span>
                                    </div>
                                    <span class="stat-value highlight">R$ <span x-text="calculateAverageTicket(index).toFixed(2)"></span></span>
                                </div>
                                <div class="stat-item" x-show="getActiveOrderBumpsCount(index) > 0">
                                    <span class="stat-label">Ofertas Bônus:</span>
                                    <span class="stat-value"><span x-text="getActiveOrderBumpsCount(index)"></span> ativa(s)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="config.main_buttons.length === 0">
            <div class="text-center py-16">
                <div class="text-6xl mb-4">🛍️</div>
                <h3 class="text-xl font-bold text-white mb-2">Nenhum botão criado</h3>
                <p class="text-gray-500 mb-6">Adicione seus primeiros botões de venda</p>
                <button @click="addButton()" class="btn-action btn-action-success">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Primeiro Botão
                </button>
            </div>
        </template>
    </div>

    <!-- Botões de Redirecionamento (dentro da tab Botões) -->
    <div x-show="activeTab === 'buttons'" x-cloak class="mt-8">
        <div class="border-t border-gray-800 pt-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-external-link-alt text-blue-500"></i>
                        Botões de Link
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Botões que levam para links externos (sem pagamento)</p>
                </div>
                <button @click="addRedirectButton()" class="btn-action btn-action-info">
                    <i class="fas fa-plus"></i>
                    Adicionar Link
                </button>
            </div>

            <template x-if="config.redirect_buttons.length > 0">
                <div class="space-y-3">
                    <template x-for="(button, index) in config.redirect_buttons" :key="index">
                        <div class="flex items-center gap-3 p-4 bg-gray-900 border border-gray-800 rounded-lg">
                            <i class="fas fa-link text-blue-500"></i>
                            <input type="text" 
                                   x-model="button.text" 
                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white text-sm"
                                   placeholder="Texto do botão">
                            <input type="url" 
                                   x-model="button.url" 
                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white text-sm font-mono"
                                   placeholder="https://...">
                            <button @click="removeRedirectButton(index)" 
                                    class="w-10 h-10 flex items-center justify-center rounded border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </template>

            <template x-if="config.redirect_buttons.length === 0">
                <div class="text-center py-8 border-2 border-dashed border-gray-800 rounded-lg">
                    <i class="fas fa-external-link-alt text-4xl text-gray-700 mb-2"></i>
                    <p class="text-sm text-gray-500">Nenhum botão de link configurado</p>
                    <p class="text-xs text-gray-600 mt-1">Use para grupos, canais, sites externos, etc.</p>
                </div>
            </template>
        </div>
    </div>

    <!-- Tab Content: Downsells -->
    <div x-show="activeTab === 'downsells'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-arrow-down text-2xl text-red-400"></i>
                <div>
                    <div class="config-section-title">Downsells</div>
                    <div class="config-section-description">Ofertas enviadas quando o pagamento não é confirmado</div>
                </div>
                <label class="ml-auto flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" 
                           x-model="config.downsells_enabled"
                           class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                    <span class="text-sm font-bold text-white">Habilitar</span>
                </label>
            </div>

            <div x-show="config.downsells_enabled" class="space-y-4">
                <template x-for="(downsell, index) in config.downsells" :key="index">
                    <div class="button-card">
                        <div class="button-card-header">
                            <h4 class="text-sm font-bold text-white">Downsell <span x-text="index + 1"></span></h4>
                            <button @click="removeDownsell(index)" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Delay (minutos)</label>
                                <input type="number" x-model="downsell.delay_minutes" class="form-input" placeholder="5">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensagem</label>
                                <textarea x-model="downsell.message"
                                          class="form-textarea"
                                          maxlength="900"
                                          @input="downsell.message = stripSurrogateChars(downsell.message || '').slice(0, 900)"
                                          placeholder="Oferta especial!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                            </div>

                            <!-- ✅ MODO DE PRECIFICAÇÃO (Preço Fixo vs Desconto %) -->
                            <div class="p-4 bg-gray-900 border border-gray-800 rounded-xl">
                                <label class="form-label mb-3">
                                    <i class="fas fa-calculator mr-2" style="color: var(--brand-gold-500);"></i>
                                    <span class="text-white font-bold">Modo de Precificação</span>
                                </label>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <button type="button"
                                            @click="downsell.pricing_mode = 'fixed'"
                                            :class="(downsell.pricing_mode || 'fixed') === 'fixed' ? 'pricing-btn-active' : 'pricing-btn-inactive'"
                                            class="pricing-btn">
                                        <i class="fas fa-dollar-sign"></i>
                                        Preço Fixo
                                    </button>
                                    <button type="button"
                                            @click="downsell.pricing_mode = 'percentage'"
                                            :class="downsell.pricing_mode === 'percentage' ? 'pricing-btn-active' : 'pricing-btn-inactive'"
                                            class="pricing-btn">
                                        <i class="fas fa-percent"></i>
                                        Desconto %
                                    </button>
                                </div>

                                <!-- Modo: Preço Fixo -->
                                <div x-show="(downsell.pricing_mode || 'fixed') === 'fixed'" class="form-group">
                                    <label class="form-label">Preço Fixo (R$)</label>
                                    <input type="number" 
                                           x-model="downsell.price" 
                                           step="0.01" 
                                           class="form-input text-center font-mono font-bold"
                                           placeholder="14.97">
                                    <div class="info-box mt-2">
                                        <p class="text-xs text-gray-400">
                                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                                            Valor fixo do downsell
                                        </p>
                                    </div>
                                </div>

                                <!-- Modo: Desconto Percentual -->
                                <div x-show="downsell.pricing_mode === 'percentage'" class="form-group">
                                    <label class="form-label">Desconto Percentual (%)</label>
                                    <input type="number" 
                                           x-model="downsell.discount_percentage" 
                                           min="1" 
                                           max="95" 
                                           step="1" 
                                           class="form-input text-center font-mono font-bold"
                                           placeholder="50">
                                    <div class="info-box-warning info-box mt-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-magic mr-1" style="color: var(--brand-gold-500);"></i>
                                            <strong style="color: var(--brand-gold-500);">Exemplo:</strong> 
                                            50% de R$ 19,97 = R$ 9,99
                                        </p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            O desconto é calculado sobre o preço do botão que o cliente clicou
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mídia (URL + Tipo) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-link mr-2 text-blue-500"></i>
                                        URL da Mídia (opcional)
                                    </label>
                                    <input type="url" 
                                           x-model="downsell.media_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/123">
                                    <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-image mr-2 text-blue-500"></i>
                                            Tipo de Mídia Principal
                                        </label>
                                        <div class="flex gap-3 mt-2">
                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-colors flex-1"
                                                   :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.media_type === 'video'}">
                                                <input type="radio" x-model="downsell.media_type" value="video" class="text-yellow-500">
                                                <i class="fas fa-video text-yellow-500"></i>
                                                <span class="text-sm text-white">Vídeo</span>
                                            </label>
                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-colors flex-1"
                                                   :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.media_type === 'photo'}">
                                                <input type="radio" x-model="downsell.media_type" value="photo" class="text-yellow-500">
                                                <i class="fas fa-camera text-yellow-500"></i>
                                                <span class="text-sm text-white">Foto</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label flex items-center gap-2">
                                            <input type="checkbox" 
                                                   x-model="downsell.audio_enabled"
                                                   class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                                   style="accent-color: #A855F7;">
                                            <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                            <span>Adicionar Áudio Complementar</span>
                                        </label>
                                        <div x-show="downsell.audio_enabled" x-cloak class="mt-2">
                                            <input type="url" 
                                                   x-model="downsell.audio_url" 
                                                   class="form-input"
                                                   placeholder="https://t.me/canal/audio2">
                                            <p class="text-xs text-gray-500 mt-2">Áudio enviado após a mídia principal</p>
                                        </div>
                                    </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mouse-pointer mr-2 text-green-400"></i>
                                    Texto do Botão (opcional)
                                </label>
                                <input type="text" 
                                       x-model="downsell.button_text" 
                                       class="form-input" 
                                       placeholder="🛒 Comprar Agora!">
                                <div class="info-box mt-2">
                                    <p class="text-xs text-gray-400">
                                        <i class="fas fa-lightbulb mr-1" style="color: var(--brand-gold-500);"></i>
                                        Deixe vazio para usar: "🛒 Comprar por R$ XX,XX"
                                    </p>
                                </div>
                            </div>

                            <!-- Order Bump para Downsell V2.0 -->
                            <div class="order-bump-section">
                                <div class="flex items-center justify-between mb-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" 
                                               x-model="downsell.order_bump.enabled"
                                               class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                        <span class="text-sm font-bold text-white">
                                            <i class="fas fa-gift mr-2 text-yellow-500"></i>
                                            Order Bump (Oferta Extra no Downsell)
                                        </span>
                                    </label>
                                    <span x-show="downsell.order_bump.enabled" 
                                          class="px-3 py-1.5 bg-green-500 bg-opacity-25 border-2 border-green-400 rounded-full text-xs font-bold text-white shadow-lg"
                                          style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%);">
                                        <i class="fas fa-check-circle mr-1 text-green-300"></i>
                                        ATIVO
                                    </span>
                                </div>

                                <div x-show="downsell.order_bump.enabled" class="space-y-4">
                                    <!-- ✅ V2.0: Order Bumps dos Botões Principais (Botões Clicáveis) -->
                                    <div class="form-group" x-show="getAvailableOrderBumps().length > 0">
                                        <label class="form-label mb-3">
                                            <i class="fas fa-gift mr-2 text-yellow-500"></i>
                                            Order Bumps Configurados nos Botões
                                        </label>
                                        <p class="text-xs text-gray-500 mb-3">
                                            Clique em um order bump abaixo para usá-lo neste downsell. Estes são os order bumps que você já configurou na aba "Botões".
                                        </p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            <template x-for="(orderBumpRef, idx) in getAvailableOrderBumps()" :key="idx">
                                                <button 
                                                    type="button"
                                                    @click="useOrderBumpFromButtons(downsell, orderBumpRef.buttonIndex, orderBumpRef.bumpIndex)"
                                                    class="p-4 bg-gray-800 border-2 rounded-lg transition-all text-left hover:border-yellow-500 hover:bg-gray-750"
                                                    :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.order_bump.button_index === orderBumpRef.buttonIndex && downsell.order_bump.bump_index === orderBumpRef.bumpIndex, 'border-gray-700': downsell.order_bump.button_index !== orderBumpRef.buttonIndex || downsell.order_bump.bump_index !== orderBumpRef.bumpIndex}"
                                                >
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-gift text-yellow-500"></i>
                                                            <span class="text-sm font-bold text-white">
                                                                Botão <span x-text="orderBumpRef.buttonIndex + 1"></span> - OB <span x-text="orderBumpRef.bumpIndex + 1"></span>
                                                            </span>
                                                        </div>
                                                        <span x-show="downsell.order_bump.button_index === orderBumpRef.buttonIndex && downsell.order_bump.bump_index === orderBumpRef.bumpIndex" 
                                                              class="px-2 py-1 bg-green-500 bg-opacity-25 border border-green-400 rounded text-xs text-green-300">
                                                            <i class="fas fa-check-circle"></i>
                                                        </span>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mb-1 line-clamp-2" x-text="(orderBumpRef.orderBump.message || 'Sem mensagem').substring(0, 60) + '...'"></p>
                                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-700">
                                                        <div>
                                                            <span class="text-xs font-bold text-yellow-500" x-show="orderBumpRef.orderBump.price > 0">
                                                                R$ <span x-text="parseFloat(orderBumpRef.orderBump.price || 0).toFixed(2)"></span>
                                                            </span>
                                                            <span class="text-xs text-gray-500" x-show="orderBumpRef.orderBump.price === 0">
                                                                Sem preço
                                                            </span>
                                                        </div>
                                                        <span class="text-xs text-gray-400 truncate max-w-[60%]" x-text="orderBumpRef.orderBump.description || 'Sem descrição'"></span>
                                                    </div>
                                                </button>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Empty State: Nenhum Order Bump Configurado -->
                                    <div x-show="getAvailableOrderBumps().length === 0" class="info-box-warning info-box">
                                        <p class="text-sm text-gray-300">
                                            <i class="fas fa-info-circle mr-2 text-yellow-500"></i>
                                            <strong>Nenhum order bump configurado:</strong> Vá na aba "Botões", configure seus botões principais e adicione order bumps lá. 
                                            Eles aparecerão aqui como botões clicáveis para reutilizar nos downsells.
                                        </p>
                                    </div>

                                    <!-- Divider: Configuração Manual -->
                                    <div class="flex items-center gap-3 my-4">
                                        <div class="flex-1 border-t border-gray-700"></div>
                                        <span class="text-xs text-gray-500 font-semibold">OU CONFIGURE MANUALMENTE</span>
                                        <div class="flex-1 border-t border-gray-700"></div>
                                    </div>

                                    <!-- Configuração Manual -->
                                    <div>
                                    <div class="form-group">
                                        <label class="form-label">Mensagem do Order Bump</label>
                                        <textarea x-model="downsell.order_bump.message"
                                                  class="form-textarea"
                                                  maxlength="900"
                                                  @input="downsell.order_bump.message = stripSurrogateChars(downsell.order_bump.message || '').slice(0, 900)"
                                                  placeholder="🎁 Oferta Especial!&#10;&#10;Adicione este bônus por apenas +R$ 5!"></textarea>
                                        <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Preço Adicional (R$)</label>
                                            <input type="number" 
                                                   x-model="downsell.order_bump.price" 
                                                   step="0.01"
                                                   class="form-input text-center font-mono"
                                                   placeholder="5.00">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Descrição do Bônus</label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.description" 
                                                   class="form-input"
                                                   placeholder="Acesso Vitalício">
                                        </div>
                                    </div>

                                    <!-- Mídia do Order Bump -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-link mr-2 text-blue-500"></i>
                                                URL da Mídia (opcional)
                                            </label>
                                            <input type="url" 
                                                   x-model="downsell.order_bump.media_url" 
                                                   class="form-input"
                                                   placeholder="https://t.me/canal/789">
                                            <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-image mr-2 text-blue-500"></i>
                                                Tipo de Mídia
                                            </label>
                                            <div class="flex gap-3 mt-2">
                                                <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                       :class="{'border-blue-500 bg-blue-500 bg-opacity-10': downsell.order_bump.media_type === 'video'}">
                                                    <input type="radio" x-model="downsell.order_bump.media_type" value="video" class="text-blue-500">
                                                    <i class="fas fa-video text-blue-500"></i>
                                                    <span class="text-sm text-white">Vídeo</span>
                                                </label>
                                                <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                       :class="{'border-blue-500 bg-blue-500 bg-opacity-10': downsell.order_bump.media_type === 'photo'}">
                                                    <input type="radio" x-model="downsell.order_bump.media_type" value="photo" class="text-blue-500">
                                                    <i class="fas fa-camera text-blue-500"></i>
                                                    <span class="text-sm text-white">Foto</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botões Personalizados -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-check-circle mr-2 text-green-400"></i>
                                                Botão Aceitar (opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.accept_text" 
                                                   class="form-input"
                                                   placeholder="SIM! Quero esse bônus!">
                                            <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padrão</p>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-times-circle mr-2 text-red-400"></i>
                                                Botão Recusar (opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.decline_text" 
                                                   class="form-input"
                                                   placeholder="Não, obrigado">
                                            <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padrão</p>
                                        </div>
                                    </div>

                                    </div>

                                    <!-- Preview do Order Bump Selecionado dos Botões -->
                                    <div x-show="downsell.order_bump.button_index !== null && downsell.order_bump.button_index !== undefined && downsell.order_bump.bump_index !== null && downsell.order_bump.bump_index !== undefined" 
                                         class="info-box-success info-box" 
                                         style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10B981;">
                                        <div class="flex items-start gap-3">
                                            <i class="fas fa-check-circle text-green-400 text-xl mt-1"></i>
                                            <div class="flex-1">
                                                <p class="text-sm font-bold text-white mb-2">
                                                    ✅ Order Bump dos Botões Selecionado
                                                </p>
                                                <div class="space-y-1 text-sm text-gray-300">
                                                    <p><strong>Origem:</strong> Botão <span x-text="(downsell.order_bump.button_index || 0) + 1"></span> - Order Bump <span x-text="(downsell.order_bump.bump_index || 0) + 1"></span></p>
                                                    <p><strong>Preço:</strong> R$ <span x-text="(parseFloat(downsell.order_bump.price) || 0).toFixed(2)"></span></p>
                                                    <p><strong>Descrição:</strong> <span x-text="downsell.order_bump.description || 'Sem descrição'"></span></p>
                                                    <p x-show="downsell.order_bump.message" class="mt-2 text-xs text-gray-400 line-clamp-2"><strong>Mensagem:</strong> <span x-text="downsell.order_bump.message"></span></p>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-info-circle mr-1"></i>
                                                    Este order bump está sendo reutilizado dos botões principais. Para alterar, edite na aba "Botões" ou configure manualmente acima.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="addDownsell()" class="w-full py-3 border-2 border-dashed border-gray-700 rounded-lg text-gray-400 hover:border-yellow-500 hover:text-yellow-500 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Downsell
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Upsells -->
    <div x-show="activeTab === 'upsells'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-arrow-up text-2xl text-green-400"></i>
                <div>
                    <div class="config-section-title">Upsells</div>
                    <div class="config-section-description">Ofertas enviadas APÓS compra aprovada</div>
                </div>
                <label class="ml-auto flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" 
                           x-model="config.upsells_enabled"
                           class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-green-500">
                    <span class="text-sm font-bold text-white">Habilitar</span>
                </label>
            </div>

            <div x-show="config.upsells_enabled" class="space-y-4">
                <template x-for="(upsell, index) in config.upsells" :key="index">
                    <div class="button-card">
                        <div class="button-card-header">
                            <h4 class="text-sm font-bold text-white">Upsell <span x-text="index + 1"></span></h4>
                            <button @click="removeUpsell(index)" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Produto Trigger (opcional)</label>
                                <input type="text" x-model="upsell.trigger_product" class="form-input" placeholder="Ex: INSS Básico (vazio = todos)">
                                <p class="text-xs text-gray-500 mt-1">Deixe vazio para disparar em todas as compras</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Delay (minutos)</label>
                                <input type="number" x-model="upsell.delay_minutes" class="form-input" placeholder="0">
                                <p class="text-xs text-gray-500 mt-1">0 = envio imediato após pagamento</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensagem</label>
                                <textarea x-model="upsell.message"
                                          class="form-textarea"
                                          maxlength="900"
                                          @input="upsell.message = stripSurrogateChars(upsell.message || '').slice(0, 900)"
                                          placeholder="🔥 Upgrade para Premium!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                            </div>

                            <!-- Mídia (URL + Tipo) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-link mr-2 text-blue-500"></i>
                                        URL da Mídia (opcional)
                                    </label>
                                    <input type="url" 
                                           x-model="upsell.media_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/456">
                                    <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-image mr-2 text-blue-500"></i>
                                        Tipo de Mídia Principal
                                    </label>
                                    <div class="flex gap-3 mt-2">
                                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': upsell.media_type === 'video'}">
                                            <input type="radio" x-model="upsell.media_type" value="video" class="text-blue-500">
                                            <i class="fas fa-video text-blue-500"></i>
                                            <span class="text-sm text-white">Vídeo</span>
                                        </label>
                                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': upsell.media_type === 'photo'}">
                                            <input type="radio" x-model="upsell.media_type" value="photo" class="text-blue-500">
                                            <i class="fas fa-camera text-blue-500"></i>
                                            <span class="text-sm text-white">Foto</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label flex items-center gap-2">
                                        <input type="checkbox" 
                                               x-model="upsell.audio_enabled"
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               style="accent-color: #A855F7;">
                                        <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                        <span>Adicionar Áudio Complementar</span>
                                    </label>
                                    <div x-show="upsell.audio_enabled" x-cloak class="mt-2">
                                        <input type="url" 
                                               x-model="upsell.audio_url" 
                                               class="form-input"
                                               placeholder="https://t.me/canal/audio3">
                                        <p class="text-xs text-gray-500 mt-2">Áudio enviado após a mídia principal</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-box-warning info-box">
                                <p class="text-sm text-gray-300">
                                    <i class="fas fa-rocket mr-2 text-yellow-500"></i>
                                    <strong>Dica:</strong> <strong>Vídeos</strong> aumentam conversão em upsells (cliente já confia).
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Nome do Produto</label>
                                    <input type="text" x-model="upsell.product_name" class="form-input" placeholder="INSS Premium">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Preço (R$)</label>
                                    <input type="number" x-model="upsell.price" step="0.01" class="form-input" placeholder="97.00">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mouse-pointer mr-2 text-green-400"></i>
                                    Texto do Botão (opcional)
                                </label>
                                <input type="text" 
                                       x-model="upsell.button_text" 
                                       class="form-input" 
                                       placeholder="🚀 Quero fazer Upgrade!">
                                <div class="info-box mt-2">
                                    <p class="text-xs text-gray-400">
                                        <i class="fas fa-lightbulb mr-1" style="color: var(--brand-gold-500);"></i>
                                        Deixe vazio para usar texto padrão
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="addUpsell()" class="w-full py-3 border-2 border-dashed border-gray-700 rounded-lg text-gray-400 hover:border-green-500 hover:text-green-500 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Upsell
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Access -->
    <div x-show="activeTab === 'access'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-key text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Acesso ao Produto</div>
                    <div class="config-section-description">Link de entrega e mensagens</div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Link -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        Link de Acesso
                    </label>
                    
                    <!-- ✅ Mensagem quando Meta Pixel está ativo -->
                    <div x-show="config.has_meta_pixel" 
                         x-cloak
                         class="mb-3 p-4 bg-blue-900 bg-opacity-20 border border-blue-500 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-400 mt-1"></i>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-blue-300 mb-1">
                                    Meta Pixel Ativo (Pool: <span x-text="config.pool_name || 'N/A'"></span>)
                                </p>
                                <p class="text-xs text-gray-300 leading-relaxed">
                                    ✅ O link de entrega será gerado automaticamente quando o pagamento for confirmado.<br>
                                    ✅ Este campo será usado como <strong>redirecionamento final</strong> após o Purchase disparar.<br>
                                    ✅ Configure aqui o link para onde o lead será redirecionado após acessar o entregável.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <input type="url" 
                           x-model="config.access_link" 
                           class="form-input"
                           :class="{'bg-opacity-50': config.has_meta_pixel}"
                           :placeholder="config.has_meta_pixel ? 'https://t.me/+seugrupo (Link final após Purchase)' : 'https://t.me/+seugrupo'">
                    <div class="info-box mt-2">
                        <p class="text-sm text-gray-300" x-show="!config.has_meta_pixel">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Pode ser grupo/canal do Telegram, área de membros, etc.
                        </p>
                        <p class="text-sm text-gray-300" x-show="config.has_meta_pixel" x-cloak>
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Este será o link final. O sistema gerará automaticamente um link de entrega (<code class="px-1 py-0.5 bg-gray-900 rounded text-yellow-400 text-xs">/delivery/&lt;token&gt;</code>) que dispara o Purchase e depois redireciona para este link.
                        </p>
                    </div>
                </div>

                <!-- Mensagem Sucesso -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        Mensagem de Pagamento Aprovado
                    </label>
                    <textarea x-model="config.success_message" 
                              class="form-textarea"
                              placeholder="✅ Pagamento confirmado!&#10;&#10;Acesse seu produto: {link}"></textarea>
                    <div class="info-box-success info-box mt-2">
                        <p class="text-sm text-gray-300">
                            <strong class="text-green-400">Variáveis:</strong>
                            <code class="ml-2 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{produto}</code>
                            <code class="ml-1 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{valor}</code>
                            <code class="ml-1 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{link}</code>
                        </p>
                    </div>
                </div>

                <!-- Mensagem Pendente -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock mr-2 text-yellow-500"></i>
                        Mensagem de Pagamento Pendente
                    </label>
                    <textarea x-model="config.pending_message" 
                              class="form-textarea"
                              placeholder="⏳ Aguardando confirmação do pagamento..."></textarea>
                    <div class="info-box-warning info-box mt-2">
                        <p class="text-sm text-gray-300">
                            <strong class="text-yellow-400">Variável:</strong>
                            <code class="ml-2 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{pix_code}</code>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Remarketing -->
    <div x-show="activeTab === 'remarketing'" x-cloak x-data="remarketingApp()">
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-bullhorn text-2xl text-yellow-500"></i>
                <div>
                    <div class="config-section-title">Campanhas de Remarketing</div>
                    <div class="config-section-description">Recupere clientes que não compraram</div>
                </div>
                <div class="ml-auto">
                    <button @click="showCreateModal = true" class="btn-action btn-action-success">
                        <i class="fas fa-plus"></i>
                        Nova Campanha
                    </button>
                </div>
            </div>

            <div class="info-box-warning info-box mb-6">
                <p class="text-sm text-gray-300">
                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                    <strong class="text-yellow-500">Remarketing:</strong> Envie mensagens automáticas para usuários que iniciaram conversa mas não compraram. Configure público-alvo, delay e mensagem personalizada.
                </p>
            </div>

            <!-- Analytics Detalhados -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-yellow-500 transition-all">
                    <div class="text-3xl font-bold text-yellow-500" x-text="campaigns.length || 0"></div>
                    <div class="text-sm text-gray-500 mt-1">Campanhas Criadas</div>
                </div>
                
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-blue-400 transition-all">
                    <div class="text-3xl font-bold text-blue-400" x-text="getTotalSent()"></div>
                    <div class="text-sm text-gray-500 mt-1">Mensagens Enviadas</div>
                </div>
                
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-green-400 transition-all">
                    <div class="text-3xl font-bold text-green-400" x-text="getDeliveryRate() + '%'"></div>
                    <div class="text-sm text-gray-500 mt-1">Taxa de Entrega</div>
                </div>
                
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-green-400 transition-all">
                    <div class="text-3xl font-bold text-green-400" x-text="getClickRate() + '%'"></div>
                    <div class="text-sm text-gray-500 mt-1">Taxa de Cliques</div>
                </div>
            </div>

            <!-- Métricas Adicionais -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-green-300" x-text="getTotalClicks()"></div>
                    <div class="text-xs text-gray-500 mt-1">Total de Cliques</div>
                </div>
                
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-red-400" x-text="getTotalFailed()"></div>
                    <div class="text-xs text-gray-500 mt-1">Falhas no Envio</div>
                </div>
                
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-gray-400" x-text="getTotalBlocked()"></div>
                    <div class="text-xs text-gray-500 mt-1">Usuários Bloqueados</div>
                </div>
                
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-yellow-500" x-text="'R$ ' + getTotalRevenue().toFixed(2)"></div>
                    <div class="text-xs text-gray-500 mt-1">Receita Gerada</div>
                </div>
            </div>

            <!-- Info Box: Dica de Performance -->
            <div class="info-box mb-6" style="background: rgba(16, 185, 129, 0.05); border-left: 4px solid #10B981; padding: 12px; border-radius: 0 8px 8px 0;">
                <p class="text-sm text-gray-300">
                    <i class="fas fa-chart-line mr-2 text-green-400"></i>
                    <strong class="text-green-400">Análise de Performance:</strong>
                    <span x-show="getClickRate() > 10" class="text-green-300">Excelente! Taxa de cliques acima de 10% é considerada ótima.</span>
                    <span x-show="getClickRate() <= 10 && getClickRate() > 5" class="text-blue-300">Bom! Continue testando mensagens diferentes para melhorar.</span>
                    <span x-show="getClickRate() <= 5 && getClickRate() > 0" class="text-yellow-300">Teste mensagens mais persuasivas e ofertas melhores.</span>
                    <span x-show="getClickRate() === 0 && campaigns.length > 0" class="text-gray-300">Envie suas primeiras campanhas para começar a coletar dados.</span>
                    <span x-show="campaigns.length === 0" class="text-gray-300">Crie sua primeira campanha para ver as métricas aqui.</span>
                </p>
            </div>

            <!-- Lista de Campanhas -->
            <div x-show="campaigns.length > 0" class="space-y-4">
                <template x-for="campaign in campaigns" :key="campaign.id">
                    <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl hover:border-yellow-500 transition-all"
                         :class="{'cursor-pointer': campaign.status === 'completed' || campaign.status === 'sending'}"
                         @click="if(campaign.status === 'completed' || campaign.status === 'sending') { viewCampaignStats(campaign) }">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                    <span x-text="campaign.name"></span>
                                    <i x-show="campaign.status === 'completed' || campaign.status === 'sending'" 
                                       class="fas fa-chart-bar text-yellow-500 text-sm"></i>
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    <i class="fas fa-users mr-1"></i>
                                    Público: <span x-text="getAudienceLabel(campaign.target_audience)"></span>
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span :class="{
                                    'bg-yellow-500 bg-opacity-20 text-yellow-400': campaign.status === 'draft',
                                    'bg-blue-500 bg-opacity-20 text-blue-400': campaign.status === 'scheduled',
                                    'bg-green-500 bg-opacity-30 text-green-300 font-semibold': campaign.status === 'sending',
                                    'bg-gray-500 bg-opacity-40 text-gray-300 border border-gray-500': campaign.status === 'completed'
                                }" class="px-3 py-1 rounded-full text-xs font-bold">
                                    <span x-text="getStatusLabel(campaign.status)"></span>
                                </span>
                                <button @click.stop="sendCampaign(campaign.id)" 
                                        x-show="campaign.status === 'draft'"
                                        class="px-3 py-1.5 bg-yellow-500 text-black rounded-lg text-sm font-bold hover:bg-yellow-400 transition-all">
                                    <i class="fas fa-paper-plane mr-1"></i> Enviar
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold text-white" x-text="campaign.total_targets || 0"></div>
                                <div class="text-xs text-gray-500">Alvos</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold text-green-400" x-text="campaign.total_sent || 0"></div>
                                <div class="text-xs text-gray-500">Enviados</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold text-blue-400" x-text="campaign.total_clicks || 0"></div>
                                <div class="text-xs text-gray-500">Cliques</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold" style="color: var(--brand-gold-500);" x-text="'R$ ' + (campaign.revenue_generated || 0).toFixed(2)"></div>
                                <div class="text-xs text-gray-500">Receita</div>
                            </div>
                        </div>
                        
                        <!-- Dica: Clique para ver detalhes -->
                        <div x-show="campaign.status === 'completed' || campaign.status === 'sending'" 
                             class="mt-4 text-center text-xs text-yellow-500 opacity-60 hover:opacity-100 transition-opacity">
                            <i class="fas fa-mouse-pointer mr-1"></i>
                            Clique para ver estatísticas detalhadas
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div x-show="campaigns.length === 0" class="text-center py-12 border-2 border-dashed border-gray-700 rounded-xl">
                <i class="fas fa-bullhorn text-5xl text-yellow-500 mb-4" style="opacity: 0.5;"></i>
                <h3 class="text-xl font-bold text-white mb-2">Nenhuma campanha criada</h3>
                <p class="text-gray-500 mb-6">Crie sua primeira campanha de remarketing</p>
                <button @click="showCreateModal = true" class="btn-action btn-action-success">
                    <i class="fas fa-plus"></i>
                    Criar Primeira Campanha
                </button>
            </div>
        </div>

        <!-- Modal: Criar Campanha -->
        <div x-show="showCreateModal" 
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             style="background: rgba(0,0,0,0.8);">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div @click.away="showCreateModal = false" 
                     class="bg-gray-900 rounded-xl max-w-2xl w-full p-6 border border-gray-800">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white">Nova Campanha de Remarketing</h3>
                        <button @click="showCreateModal = false" class="text-gray-500 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Nome da Campanha</label>
                            <input type="text" x-model="newCampaign.name" class="form-input" placeholder="Ex: Recuperação de Carrinho">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mensagem</label>
                            <textarea x-model="newCampaign.message" class="form-textarea" rows="4" placeholder="Olá! Notamos que você estava interessado..."></textarea>
                        </div>

                        <!-- Mídia (Padrão 2 colunas) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-link mr-2 text-blue-500"></i>
                                    URL da Mídia (opcional)
                                </label>
                                <input type="url" x-model="newCampaign.media_url" class="form-input" placeholder="https://t.me/canal/123">
                                <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-image mr-2 text-blue-500"></i>
                                    Tipo de Mídia Principal
                                </label>
                                <div class="flex gap-3 mt-2">
                                    <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                           :class="{'border-blue-500 bg-blue-500 bg-opacity-10': newCampaign.media_type === 'video'}">
                                        <input type="radio" x-model="newCampaign.media_type" value="video" class="text-blue-500">
                                        <i class="fas fa-video text-blue-500"></i>
                                        <span class="text-sm text-white">Vídeo</span>
                                    </label>
                                    <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                           :class="{'border-blue-500 bg-blue-500 bg-opacity-10': newCampaign.media_type === 'photo'}">
                                        <input type="radio" x-model="newCampaign.media_type" value="photo" class="text-blue-500">
                                        <i class="fas fa-camera text-blue-500"></i>
                                        <span class="text-sm text-white">Foto</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label flex items-center gap-2">
                                    <input type="checkbox" 
                                           x-model="newCampaign.audio_enabled"
                                           class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                           style="accent-color: #A855F7;">
                                    <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                    <span>Adicionar Áudio Complementar</span>
                                </label>
                                <div x-show="newCampaign.audio_enabled" x-cloak class="mt-2">
                                    <input type="url" 
                                           x-model="newCampaign.audio_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/audioremkt">
                                    <p class="text-xs text-gray-500 mt-2">Áudio enviado após a mídia principal</p>
                                </div>
                            </div>
                        </div>

                        <!-- ✅ BOTÕES DE PRODUTO (igual ao Remarketing Geral) -->
                        <div class="form-group p-4 rounded-xl" style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="flex items-center justify-between mb-3">
                                <label class="form-label mb-0">
                                    <i class="fas fa-tag mr-2 text-emerald-400"></i>
                                    Botões de Produto
                                </label>
                                <button type="button" 
                                        @click="newCampaign.buttons = newCampaign.buttons || []; newCampaign.buttons.push({ text: '', price: 0, description: '' })"
                                        class="px-3 py-1 text-xs font-bold rounded-lg text-black"
                                        style="background: linear-gradient(to right, #10B981, #059669);">
                                    <i class="fas fa-plus mr-1"></i>
                                    Adicionar Botão
                                </button>
                            </div>
                            
                            <!-- Lista de botões -->
                            <template x-if="!newCampaign.buttons || newCampaign.buttons.length === 0">
                                <div class="text-center py-6 text-gray-500 text-sm">
                                    <i class="fas fa-hand-pointer text-2xl mb-2"></i>
                                    <p>Nenhum botão adicionado</p>
                                    <p class="text-xs mt-1">Clique em "Adicionar Botão" para criar opções de produtos</p>
                                </div>
                            </template>
                            
                            <div class="space-y-3" x-show="newCampaign.buttons && newCampaign.buttons.length > 0">
                                <template x-for="(button, index) in newCampaign.buttons" :key="index">
                                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-bold text-emerald-400">
                                                <i class="fas fa-tag mr-1"></i>
                                                Botão <span x-text="index + 1"></span>
                                            </span>
                                            <button type="button" 
                                                    @click="newCampaign.buttons.splice(index, 1)"
                                                    class="text-xs text-red-400 hover:text-red-300">
                                                <i class="fas fa-trash mr-1"></i>
                                                Remover
                                            </button>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <div class="md:col-span-2">
                                                <label class="block text-xs text-gray-400 mb-1">Texto do Botão</label>
                                                <input type="text" 
                                                       x-model="button.text"
                                                       class="form-input text-sm"
                                                       placeholder="Ex: Comprar Produto Premium">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-400 mb-1">Preço (R$)</label>
                                                <input type="number" 
                                                       x-model.number="button.price"
                                                       step="0.01"
                                                       min="0"
                                                       class="form-input text-sm font-mono font-bold"
                                                       placeholder="19.97">
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <label class="block text-xs text-gray-400 mb-1">Descrição do Produto</label>
                                            <input type="text" 
                                                   x-model="button.description"
                                                   class="form-input text-sm"
                                                   placeholder="Acesso completo + Bônus exclusivos">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-users mr-2 text-yellow-500"></i>
                                    Público-Alvo
                                </label>
                                <select x-model="newCampaign.target_audience" class="form-input">
                                    <option value="non_buyers">Não compraram</option>
                                    <option value="abandoned_cart">Carrinho abandonado</option>
                                    <option value="inactive">Inativos</option>
                                    <option value="all">Todos</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-clock mr-2 text-yellow-500"></i>
                                    Dias sem contato
                                </label>
                                <input type="number" x-model="newCampaign.days_since_last_contact" class="form-input" placeholder="3">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" 
                                       x-model="newCampaign.exclude_buyers"
                                       class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                <span class="text-sm text-white font-semibold">
                                    <i class="fas fa-user-slash mr-1 text-red-400"></i>
                                    Excluir compradores
                                </span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">Não enviar para quem já comprou</p>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="showCreateModal = false" 
                                    class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button @click="createCampaign()" 
                                    :disabled="!newCampaign.name || !newCampaign.message"
                                    :class="{'opacity-50 cursor-not-allowed': !newCampaign.name || !newCampaign.message}"
                                    class="btn-action btn-action-success">
                                <i class="fas fa-plus"></i>
                                Criar Campanha
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Estatísticas da Campanha -->
        <div x-show="showStatsModal" 
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             style="background: rgba(0,0,0,0.9);">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div @click.away="showStatsModal = false" 
                     class="bg-gray-900 rounded-2xl max-w-4xl w-full p-8 border-2 border-yellow-500">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                                <i class="fas fa-chart-line text-yellow-500"></i>
                                Estatísticas da Campanha
                            </h3>
                            <p class="text-sm text-gray-500 mt-1" x-text="selectedCampaign?.name"></p>
                        </div>
                        <button @click="showStatsModal = false" class="text-gray-500 hover:text-white">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <!-- Métricas Principais -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-blue-400" x-text="selectedCampaign?.total_targets || 0"></div>
                            <div class="text-sm text-gray-500 mt-1">Total de Alvos</div>
                        </div>
                        
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-green-400" x-text="selectedCampaign?.total_sent || 0"></div>
                            <div class="text-sm text-gray-500 mt-1">Mensagens Enviadas</div>
                        </div>
                        
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-purple-400" x-text="selectedCampaign?.total_clicks || 0"></div>
                            <div class="text-sm text-gray-500 mt-1">Total de Cliques</div>
                        </div>
                        
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-yellow-500" x-text="'R$ ' + (selectedCampaign?.revenue_generated || 0).toFixed(2)"></div>
                            <div class="text-sm text-gray-500 mt-1">Receita Gerada</div>
                        </div>
                    </div>

                    <!-- Taxas e Performance -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-2xl font-bold text-green-300" x-text="getCampaignDeliveryRate(selectedCampaign) + '%'"></div>
                            <div class="text-xs text-gray-500 mt-1">Taxa de Entrega</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-2xl font-bold text-blue-300" x-text="getCampaignClickRate(selectedCampaign) + '%'"></div>
                            <div class="text-xs text-gray-500 mt-1">Taxa de Cliques</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-2xl font-bold text-purple-300" x-text="getCampaignConversionRate(selectedCampaign) + '%'"></div>
                            <div class="text-xs text-gray-500 mt-1">Taxa de Conversão</div>
                        </div>
                    </div>

                    <!-- Detalhes Adicionais -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">Falhas no Envio</div>
                            <div class="text-xl font-bold text-red-400" x-text="selectedCampaign?.total_failed || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">Usuários Bloqueados</div>
                            <div class="text-xl font-bold text-gray-400" x-text="selectedCampaign?.total_blocked || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">Status</div>
                            <div class="text-xl font-bold" :class="{
                                'text-yellow-400': selectedCampaign?.status === 'draft',
                                'text-green-400': selectedCampaign?.status === 'sending',
                                'text-gray-400': selectedCampaign?.status === 'completed'
                            }" x-text="getStatusLabel(selectedCampaign?.status)"></div>
                        </div>
                    </div>

                    <!-- Info da Campanha -->
                    <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg mb-6">
                        <h4 class="text-sm font-bold text-white mb-3">Detalhes da Campanha</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-500">Público-Alvo:</span>
                                <span class="text-white ml-2" x-text="getAudienceLabel(selectedCampaign?.target_audience)"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">Delay:</span>
                                <span class="text-white ml-2" x-text="selectedCampaign?.days_since_last_contact + ' dias'"></span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <span class="text-gray-500">Mensagem:</span>
                            <p class="text-white mt-1 text-sm bg-gray-900 p-3 rounded" x-text="selectedCampaign?.message"></p>
                        </div>
                    </div>

                    <!-- Análise de Performance -->
                    <div class="p-4 rounded-lg" :class="{
                        'bg-green-500 bg-opacity-10 border border-green-500': getCampaignClickRate(selectedCampaign) > 10,
                        'bg-blue-500 bg-opacity-10 border border-blue-500': getCampaignClickRate(selectedCampaign) <= 10 && getCampaignClickRate(selectedCampaign) > 5,
                        'bg-yellow-500 bg-opacity-10 border border-yellow-500': getCampaignClickRate(selectedCampaign) <= 5
                    }">
                        <p class="text-sm">
                            <i class="fas fa-lightbulb mr-2"></i>
                            <strong>Análise:</strong>
                            <span x-show="getCampaignClickRate(selectedCampaign) > 10">🎉 Excelente performance! Continue com esse tipo de mensagem.</span>
                            <span x-show="getCampaignClickRate(selectedCampaign) <= 10 && getCampaignClickRate(selectedCampaign) > 5">👍 Boa performance! Teste variações para melhorar ainda mais.</span>
                            <span x-show="getCampaignClickRate(selectedCampaign) <= 5">💡 Performance pode melhorar. Teste mensagens mais diretas e ofertas melhores.</span>
                        </p>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button @click="showStatsModal = false" 
                                class="px-6 py-2 bg-yellow-500 text-black rounded-lg hover:bg-yellow-400 font-bold">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Settings (Trocar Token) -->
    <div x-show="activeTab === 'settings'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-cog text-2xl text-gray-400"></i>
                <div>
                    <div class="config-section-title">Configurações do Bot</div>
                    <div class="config-section-description">Token do Telegram e configurações avançadas</div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Trocar Token -->
                <div class="p-6 bg-gray-900 border-2 border-red-500 rounded-xl">
                    <div class="flex items-start gap-3 mb-6 p-4 bg-red-500 bg-opacity-15 rounded-lg border-l-4 border-red-500">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                        <div>
                            <h3 class="text-xl font-bold text-red-400 mb-2">Trocar Token do Bot</h3>
                            <p class="text-sm text-white font-medium mb-3">
                                Use esta opção se você precisa reconectar o bot ou trocar para um novo token do BotFather.
                            </p>
                            <div class="p-3 bg-red-600 bg-opacity-30 rounded-lg border border-red-400">
                                <p class="text-sm text-white font-bold">
                                    <i class="fas fa-skull-crossbones mr-2 text-red-300"></i>
                                    <strong class="text-red-300">ATENÇÃO CRÍTICA:</strong> Ao trocar o token, você estará criando um novo bot no Telegram. 
                                    <strong class="text-yellow-300">TODOS os usuários que já interagiram com o bot anterior serão RESETADOS</strong> e precisarão iniciar uma nova conversa com o novo bot!
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key mr-2" style="color: var(--brand-gold-500);"></i>
                            <span class="text-white font-bold">Novo Token do Telegram</span>
                        </label>
                        <input type="text" 
                               x-model="newBotToken" 
                               class="form-input font-mono text-white"
                               placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                        <p class="text-sm text-gray-300 mt-2 font-medium">
                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                            Obtenha um novo token com o <strong class="text-blue-400">@BotFather</strong> no Telegram
                        </p>
                    </div>

                    <button @click="changeBotToken()" 
                            :disabled="!newBotToken || loading"
                            :class="{'opacity-50 cursor-not-allowed': !newBotToken || loading}"
                            class="w-full px-4 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition-all flex items-center justify-center gap-2 text-base">
                        <i class="fas fa-sync-alt"></i>
                        <span x-show="!loading">Atualizar Token</span>
                        <span x-show="loading">Atualizando...</span>
                    </button>

                    <div class="mt-4 p-4 bg-green-500 bg-opacity-15 rounded-lg border-l-4 border-green-500">
                        <p class="text-sm text-white font-medium">
                            <i class="fas fa-shield-alt mr-2 text-green-400"></i>
                            <strong class="text-green-400">Segurança:</strong> O token é criptografado e nunca será exibido após salvo.
                        </p>
                    </div>
                </div>

                <!-- Informações do Bot -->
                <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        Informações do Bot
                    </h3>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Nome:</span>
                            <span class="text-white font-semibold">{{ bot.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Username:</span>
                            <span class="text-white font-mono">@{{ bot.username }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Status:</span>
                            <span class="text-green-400 font-semibold">
                                <i class="fas fa-circle text-xs mr-1"></i>
                                {% if bot.is_active %}Ativo{% else %}Pausado{% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">ID:</span>
                            <span class="text-white font-mono">#{{ bot.id }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ✅ CRÍTICO: Registrar componente no Alpine.js ANTES do Alpine processar o HTML
// ✅ O Alpine.js está sendo carregado com defer, então precisa registrar via alpine:init
// ✅ TAMBÉM tentar registrar imediatamente se Alpine já estiver disponível
(function() {
    'use strict';
    
    function registerBotConfigApp() {
        if (typeof Alpine === 'undefined' || !Alpine.data) {
            console.error('❌ Alpine.js não está disponível!');
            return false;
        }
        
        console.log('✅ Registrando botConfigApp...');
        Alpine.data('botConfigApp', () => ({
        activeTab: 'welcome',
        loading: false,
        newBotToken: '',  // ✅ NOVO: Para trocar token
        flowViewMode: 'visual',  // ✅ Sempre Visual (Lista removida)
        jsPlumbInstance: null,  // ✅ Instância do jsPlumb
        
        // ✅ UX MELHORIAS: Validação inline, preview e auto-save
        fieldErrors: {},
        charCounts: {},
        expandedSections: {},
        saveStatus: '', // 'saving', 'saved', 'error', ''
        showPreview: true,
        lastSavedData: null,
        autoSaveTimer: null,
        previewUpdateTimeout: null,
        
        config: {
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            welcome_audio_enabled: false,
            welcome_audio_url: '',
            main_buttons: [],
            redirect_buttons: [],
            downsells_enabled: false,
            downsells: [],
            upsells_enabled: false,
            upsells: [],
            access_link: '',
            success_message: '',
            pending_message: '',
            has_meta_pixel: false,  // ✅ Se bot está associado a pool com Meta Pixel ativo
            pool_name: null,          // ✅ Nome do pool (se houver)
            flow_enabled: false,      // ✅ Ativar fluxo visual
            flow_steps: [],           // ✅ Steps do fluxo
            flow_start_step_id: null  // ✅ ID do step inicial do fluxo (/start inicia aqui)
        },
        
        async init() {
            console.log('🔧 Bot Config V2.0 inicializando...');
            await this.loadConfig();
            console.log('✅ Config carregado!');
            // ✅ UX MELHORIAS: Iniciar auto-save
            this.lastSavedData = JSON.stringify(this.config);
            this.startAutoSave();
        },
        
        async loadConfig() {
            try {
                console.log('📡 Buscando config da API...');
                const response = await fetch('/api/bots/{{ bot.id }}/config');
                
                console.log('📊 Response status:', response.status);
                
                if (!response.ok) {
                    console.error('❌ Erro na resposta:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('❌ Erro detalhado:', errorText);
                    return;
                }
                
                const data = await response.json();
                console.log('📦 Dados recebidos da API:', data);
                
                if (response.ok) {
                    console.log('✅ Mesclando dados com config atual...');
                    console.log('🔧 Config ANTES:', JSON.stringify(this.config, null, 2));
                    
                    this.config = {
                        ...this.config,
                        ...data
                    };
                    
                    // ✅ Garantir que campos de áudio existem (compatibilidade com configs antigos)
                    if (!this.config.hasOwnProperty('welcome_audio_enabled')) this.config.welcome_audio_enabled = false;
                    if (!this.config.hasOwnProperty('welcome_audio_url')) this.config.welcome_audio_url = '';
                    
                    console.log('🔧 Config DEPOIS:', JSON.stringify(this.config, null, 2));
                    
                    // ✅ Migrar order_bump para order_bumps array
                    if (Array.isArray(this.config.main_buttons)) {
                        this.config.main_buttons.forEach(button => {
                            // Migrar order_bump antigo para order_bumps array
                            if (button.hasOwnProperty('order_bump') && !button.hasOwnProperty('order_bumps')) {
                                if (button.order_bump && button.order_bump.enabled) {
                                    button.order_bumps = [button.order_bump];
                                } else {
                                    button.order_bumps = [];
                                }
                                delete button.order_bump; // Remover estrutura antiga
                            }
                            
                            // Garantir que order_bumps existe
                            if (!button.hasOwnProperty('order_bumps')) {
                                button.order_bumps = [];
                            }
                            
                            // Inicializar cada order bump
                            if (Array.isArray(button.order_bumps)) {
                                button.order_bumps.forEach(orderBump => {
                                    if (!orderBump.hasOwnProperty('enabled')) orderBump.enabled = true;
                                    if (!orderBump.hasOwnProperty('message')) orderBump.message = '';
                                    if (!orderBump.hasOwnProperty('price')) orderBump.price = 0;
                                    if (!orderBump.hasOwnProperty('description')) orderBump.description = '';
                                    if (!orderBump.hasOwnProperty('media_url')) orderBump.media_url = '';
                                    if (!orderBump.hasOwnProperty('media_type')) orderBump.media_type = 'photo';
                                    if (!orderBump.hasOwnProperty('accept_text')) orderBump.accept_text = '';
                                    if (!orderBump.hasOwnProperty('decline_text')) orderBump.decline_text = '';
                                });
                            }
                        });
                    }
                    
                    // ✅ Inicializar campos de downsells (compatibilidade com sistema antigo)
                    if (Array.isArray(this.config.downsells)) {
                        this.config.downsells.forEach(downsell => {
                            if (!downsell.hasOwnProperty('pricing_mode')) downsell.pricing_mode = 'fixed';
                            if (!downsell.hasOwnProperty('discount_percentage')) downsell.discount_percentage = 50;
                            if (!downsell.hasOwnProperty('button_text')) downsell.button_text = '';
                            if (!downsell.hasOwnProperty('media_type')) downsell.media_type = 'video';
                            if (!downsell.hasOwnProperty('audio_enabled')) downsell.audio_enabled = false;
                            if (!downsell.hasOwnProperty('audio_url')) downsell.audio_url = '';
                            if (!downsell.hasOwnProperty('order_bump')) {
                                downsell.order_bump = {
                                    enabled: false,
                                    button_index: null,  // ✅ V2.0: Índice do botão principal
                                    bump_index: null,    // ✅ V2.0: Índice do order bump no botão
                                    message: '',
                                    price: 0,
                                    description: '',
                                    media_url: '',
                                    media_type: 'video',
                                    accept_text: '',
                                    decline_text: '',
                                    audio_enabled: false,
                                    audio_url: ''
                                };
                            } else {
                                // Garantir que button_index e bump_index existem (compatibilidade)
                                if (!downsell.order_bump.hasOwnProperty('button_index')) {
                                    downsell.order_bump.button_index = null;
                                }
                                if (!downsell.order_bump.hasOwnProperty('bump_index')) {
                                    downsell.order_bump.bump_index = null;
                                }
                            }
                        });
                    }
                    
                    // Garantir arrays existem
                    if (!this.config.downsells) this.config.downsells = [];
                    if (!this.config.upsells) this.config.upsells = [];
                    
                    // ✅ Inicializar campos de upsells (compatibilidade)
                    if (Array.isArray(this.config.upsells)) {
                        this.config.upsells.forEach(upsell => {
                            if (!upsell.hasOwnProperty('media_type')) upsell.media_type = 'video';
                            if (!upsell.hasOwnProperty('audio_enabled')) upsell.audio_enabled = false;
                            if (!upsell.hasOwnProperty('audio_url')) upsell.audio_url = '';
                        });
                    }
                    
                    // ✅ Garantir campos de fluxo existem (compatibilidade)
                    if (!this.config.hasOwnProperty('flow_enabled')) this.config.flow_enabled = false;
                    if (!this.config.hasOwnProperty('flow_steps')) this.config.flow_steps = [];
                    if (!Array.isArray(this.config.flow_steps)) this.config.flow_steps = [];
                    if (!this.config.hasOwnProperty('flow_start_step_id')) this.config.flow_start_step_id = null;
                    
                    // ✅ Inicializar steps do fluxo
                    if (Array.isArray(this.config.flow_steps)) {
                        this.config.flow_steps.forEach(step => {
                            if (!step.hasOwnProperty('id')) step.id = `step_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            if (!step.hasOwnProperty('name')) step.name = null;
                            if (!step.hasOwnProperty('type')) step.type = 'content';
                            if (!step.hasOwnProperty('order')) step.order = 0;
                            if (!step.hasOwnProperty('config')) step.config = {};
                            if (!step.hasOwnProperty('connections')) step.connections = {};
                            if (!step.hasOwnProperty('delay_seconds')) step.delay_seconds = 0;
                        });
                        
                        // ✅ Auto-definir step inicial se não existe e fluxo está ativo
                        if (this.config.flow_enabled && this.config.flow_steps.length > 0 && !this.config.flow_start_step_id) {
                            const sortedSteps = [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                            let startStep = null;
                            // Buscar step com order=1 primeiro
                            for (const step of sortedSteps) {
                                if (step.order === 1) {
                                    startStep = step;
                                    break;
                                }
                            }
                            // Se não encontrou order=1, usar primeiro step
                            if (!startStep && sortedSteps.length > 0) {
                                startStep = sortedSteps[0];
                            }
                            if (startStep) {
                                this.config.flow_start_step_id = startStep.id;
                                console.log(`✅ Step inicial auto-definido: ${startStep.id} (order=${startStep.order || 0})`);
                            }
                        }
                    }
                    
                    console.log('✅ Config final carregado com sucesso!');
                    console.log('📊 Config completo:', this.config);
                    
                    // ✅ UX MELHORIAS: Salvar dados iniciais para auto-save
                    this.lastSavedData = JSON.stringify(this.config);
                } else {
                    console.error('❌ Erro na resposta da API:', data);
                    alert('❌ Erro ao carregar configuração. Verifique o console do navegador (F12).');
                }
            } catch (error) {
                console.error('❌ ERRO CRÍTICO ao carregar config:', error);
                console.error('Stack:', error.stack);
                alert('❌ Erro ao carregar configuração: ' + error.message + '\nAbra o console (F12) para mais detalhes.');
            }
        },
        
        // ✅ VALIDAÇÃO: Mensagem de boas-vindas (preservar emojis e caracteres especiais)
        validateWelcomeMessage() {
            if (!this.config.welcome_message) {
                return;
            }
            
            // ✅ REMOVIDO: Sanitização que corrompia emojis e caracteres especiais
            // O texto é preservado como está (Telegram e banco suportam UTF-8 completo)
            // Não aplicar stripSurrogateChars - estava corrompendo emojis válidos
            
            // ✅ REMOVIDO: Validação restritiva - permitir testar mídia com texto > 1024
            // Apenas aviso se exceder 4096 (limite absoluto do Telegram)
            if (this.config.welcome_message.length > 4096) {
                this.config.welcome_message = this.config.welcome_message.slice(0, 4096);
                console.warn(`⚠️ Mensagem truncada para 4096 caracteres (limite absoluto do Telegram)`);
            }
        },
        
        // ✅ OBTER TAMANHO: Mensagem de boas-vindas
        getWelcomeMessageLength() {
            if (!this.config.welcome_message) {
                return 0;
            }
            return this.config.welcome_message.length;
        },
        
        async saveConfig(isAutoSave = false) {
            if (!isAutoSave) {
                console.log('🔄 Iniciando salvamento de configuração...');
                this.loading = true;
            }
            
            try {
                // ✅ VALIDAÇÃO: Apenas verificar limite absoluto do Telegram (4096)
                if (this.config.welcome_message && this.config.welcome_message.length > 4096) {
                    if (!isAutoSave) {
                        alert(`❌ Mensagem muito longa! O máximo é 4096 caracteres (Telegram). Você tem ${this.config.welcome_message.length} caracteres.`);
                        this.loading = false;
                    }
                    return false;
                }
                
                // ✅ AVISO: Se tem mídia e texto > 1024, apenas avisar (não bloquear)
                if (this.config.welcome_media_url && this.config.welcome_message && this.config.welcome_message.length > 1024) {
                    console.warn(`⚠️ Testando: Mensagem com mídia tem ${this.config.welcome_message.length} caracteres (recomendado: 1024 para caption)`);
                }
                
                if (!isAutoSave) {
                    console.log('📊 Dados a serem enviados:', this.config);
                }
                
                const response = await fetch('/api/bots/{{ bot.id }}/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                });
                
                if (!isAutoSave) {
                    console.log('📡 Resposta recebida:', response.status, response.statusText);
                }
                
                const data = await response.json();
                
                if (!isAutoSave) {
                    console.log('📊 Dados da resposta:', data);
                }
                
                if (response.ok) {
                    if (!isAutoSave) {
                        console.log('✅ Configurações salvas com sucesso!');
                        this.showNotification('✅ Configurações salvas!', 'success');
                    }
                    return true;
                } else {
                    if (!isAutoSave) {
                        console.error('❌ Erro na resposta:', data);
                        alert('Erro: ' + data.error);
                    }
                    return false;
                }
            } catch (error) {
                if (!isAutoSave) {
                    console.error('💥 Erro na requisição:', error);
                    alert('Erro: ' + error.message);
                }
                return false;
            } finally {
                if (!isAutoSave) {
                    console.log('🏁 Finalizando salvamento...');
                    this.loading = false;
                }
            }
        },
        
        // ✅ UX MELHORIAS: Funções de validação inline
        validateField(fieldName, value, buttonIndex) {
            const errorKey = `${fieldName}_${buttonIndex}`;
            
            switch(fieldName) {
                case 'text':
                    if (!value || value.trim().length === 0) {
                        this.$set(this.fieldErrors, errorKey, 'Nome do produto é obrigatório');
                        return false;
                    }
                    if (value.length > 40) {
                        this.$set(this.fieldErrors, errorKey, 'Nome muito longo (máximo 40 caracteres)');
                        return false;
                    }
                    this.$set(this.fieldErrors, errorKey, null);
                    return true;
                    
                case 'price':
                    if (!value || value <= 0) {
                        this.$set(this.fieldErrors, errorKey, 'Preço deve ser maior que zero');
                        return false;
                    }
                    if (value < 3) {
                        this.$set(this.fieldErrors, errorKey, 'Preço mínimo é R$ 3,00');
                        return false;
                    }
                    this.$set(this.fieldErrors, errorKey, null);
                    return true;
                    
                default:
                    return true;
            }
        },
        
        isValidPrice(price) {
            return price && price > 0 && price >= 3;
        },
        
        updateCharCount(fieldName, value, maxLength, index) {
            const countKey = `${fieldName}_${index}`;
            this.$set(this.charCounts, countKey, (value || '').length);
        },
        
        formatPrice(price) {
            if (!price) return '0.00';
            return parseFloat(price).toFixed(2);
        },
        
        formatPriceBR(price) {
            if (!price) return '0,00';
            return parseFloat(price).toFixed(2).replace('.', ',');
        },
        
        toggleSection(sectionKey) {
            this.$set(this.expandedSections, sectionKey, !this.expandedSections[sectionKey]);
        },
        
        // ✅ UX MELHORIAS: Auto-save
        startAutoSave() {
            clearInterval(this.autoSaveTimer);
            this.autoSaveTimer = setInterval(async () => {
                const currentData = JSON.stringify(this.config);
                if (currentData !== this.lastSavedData) {
                    this.saveStatus = 'saving';
                    const success = await this.saveConfig(true);
                    if (success) {
                        this.saveStatus = 'saved';
                        this.lastSavedData = currentData;
                        setTimeout(() => {
                            if (this.saveStatus === 'saved') this.saveStatus = '';
                        }, 2000);
                    } else {
                        this.saveStatus = 'error';
                    }
                }
            }, 5000);
        },
        
        stopAutoSave() {
            if (this.autoSaveTimer) {
                clearInterval(this.autoSaveTimer);
                this.autoSaveTimer = null;
            }
        },
        
        getSaveStatusText() {
            switch(this.saveStatus) {
                case 'saving': return '💾 Salvando...';
                case 'saved': return '✅ Salvo';
                case 'error': return '❌ Erro ao salvar';
                default: return '';
            }
        },
        
        // ✅ UX MELHORIAS: Funções para Preview e Cálculos
        calculateTotalBonusPrice(buttonIndex) {
            const button = this.config.main_buttons[buttonIndex];
            if (!button || !button.order_bumps) return 0;
            return button.order_bumps
                .filter(ob => ob.enabled)
                .reduce((sum, ob) => sum + (parseFloat(ob.price) || 0), 0);
        },
        
        calculateAverageTicket(buttonIndex) {
            const button = this.config.main_buttons[buttonIndex];
            if (!button) return 0;
            const basePrice = parseFloat(button.price) || 0;
            const bonusPrice = this.calculateTotalBonusPrice(buttonIndex);
            // Estimativa: 30% de conversão nos order bumps
            return basePrice + (bonusPrice * 0.3);
        },
        
        getActiveOrderBumpsCount(buttonIndex) {
            const button = this.config.main_buttons[buttonIndex];
            if (!button || !button.order_bumps) return 0;
            return button.order_bumps.filter(ob => ob.enabled).length;
        },
        
        // ✅ UX MELHORIAS: Validação completa de botão
        validateButtonComplete(button, index) {
            const errors = [];
            
            // Validações básicas
            if (!button.text || button.text.trim().length === 0) {
                errors.push('Nome do produto é obrigatório');
            }
            if (!button.price || button.price <= 0) {
                errors.push('Preço deve ser maior que zero');
            }
            if (button.price && button.price < 3) {
                errors.push('Preço mínimo é R$ 3,00 (limite dos gateways)');
            }
            
            // Validações de relacionamento
            if (button.order_bumps && button.order_bumps.length > 0) {
                const activeBumps = button.order_bumps.filter(ob => ob.enabled);
                const totalBonus = activeBumps.reduce((sum, ob) => sum + (parseFloat(ob.price) || 0), 0);
                const totalPrice = (parseFloat(button.price) || 0) + totalBonus;
                
                if (totalPrice > 1000) {
                    errors.push(`Preço total (R$ ${totalPrice.toFixed(2)}) é muito alto. Considere reduzir para melhor conversão.`);
                }
                
                activeBumps.forEach((bump, bumpIndex) => {
                    if (parseFloat(bump.price) > parseFloat(button.price)) {
                        errors.push(`Oferta Bônus ${bumpIndex + 1}: Preço do bônus (R$ ${parseFloat(bump.price).toFixed(2)}) não pode ser maior que o produto principal (R$ ${parseFloat(button.price).toFixed(2)})`);
                    }
                    if (!bump.description || bump.description.trim().length === 0) {
                        errors.push(`Oferta Bônus ${bumpIndex + 1}: Descrição do bônus é obrigatória`);
                    }
                });
            }
            
            // Validação de assinatura
            if (button.subscription && button.subscription.enabled) {
                if (!button.subscription.vip_chat_id && !button.subscription.vip_group_link) {
                    errors.push('Assinatura: Chat ID ou link do grupo VIP é obrigatório');
                }
                if (!button.subscription.duration_value || button.subscription.duration_value <= 0) {
                    errors.push('Assinatura: Duração deve ser maior que zero');
                }
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        },
        
        // ✅ UX MELHORIAS: Debounce para preview (performance)
        updatePreviewDebounced() {
            clearTimeout(this.previewUpdateTimeout);
            this.previewUpdateTimeout = setTimeout(() => {
                // Preview atualiza automaticamente via Alpine.js reatividade
                // Esta função pode ser usada para cálculos pesados se necessário
            }, 500);
        },
        
        addButton() {
            this.config.main_buttons.push({
                text: '',
                price: 0,
                description: '',
                immediate_access: false,  // ✅ ACESSO IMEDIATO
                order_bumps: [],  // ✅ ARRAY DE ORDER BUMPS
                subscription: {   // ✅ SISTEMA DE ASSINATURAS
                    enabled: false,
                    duration_type: 'days',
                    duration_value: 30,
                    vip_chat_id: '',
                    vip_group_link: '',
                    validation_status: null
                }
            });
        },
        
        addOrderBump(buttonIndex) {
            if (!this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps = [];
            }
            
            this.config.main_buttons[buttonIndex].order_bumps.push({
                enabled: true,
                message: '',
                price: 0,
                description: '',
                media_url: '',
                media_type: 'photo',
                accept_text: '',
                decline_text: ''
            });
        },
        
        removeOrderBump(buttonIndex, bumpIndex) {
            if (confirm('Remover este order bump?')) {
                this.config.main_buttons[buttonIndex].order_bumps.splice(bumpIndex, 1);
            }
        },
        
        removeButton(index) {
            if (confirm('Remover este produto?')) {
                this.config.main_buttons.splice(index, 1);
            }
        },
        
        addRedirectButton() {
            this.config.redirect_buttons.push({
                text: '',
                url: ''
            });
        },
        
        removeRedirectButton(index) {
            this.config.redirect_buttons.splice(index, 1);
        },
        
        // ✅ SISTEMA DE ASSINATURAS - Validação de subscription
        async validateSubscription(buttonIndex) {
            const button = this.config.main_buttons[buttonIndex];
            if (!button || !button.subscription) return;
            
            const subscription = button.subscription;
            
            if (!subscription.vip_chat_id && !subscription.vip_group_link) {
                this.showNotification('⚠️ Informe o Chat ID ou Link do grupo VIP', 'error');
                return;
            }
            
            subscription.validation_status = 'validating';
            
            try {
                const response = await fetch(`/api/bots/{{ bot.id }}/validate-subscription`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        vip_chat_id: subscription.vip_chat_id,
                        vip_group_link: subscription.vip_group_link
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    subscription.validation_status = 'valid';
                    subscription.vip_chat_id = data.chat_id;  // Atualizar com chat_id validado
                    this.showNotification('✅ Configuração de assinatura validada com sucesso!', 'success');
                } else {
                    subscription.validation_status = 'invalid';
                    this.showNotification(`❌ ${data.error || 'Erro ao validar configuração'}`, 'error');
                }
            } catch (error) {
                subscription.validation_status = 'invalid';
                this.showNotification('❌ Erro ao validar configuração. Verifique sua conexão.', 'error');
                console.error('Erro ao validar subscription:', error);
            }
        },
        
        addDownsell() {
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                pricing_mode: 'fixed',
                price: 0,
                discount_percentage: 50,
                button_text: '',
                order_bump: {
                    enabled: false,
                    button_index: null,  // ✅ V2.0: Índice do botão principal
                    bump_index: null,    // ✅ V2.0: Índice do order bump no botão
                    message: '',
                    price: 0,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: '',
                    decline_text: '',
                    audio_enabled: false,
                    audio_url: ''
                }
            });
        },
        
        // ✅ V2.0: Extrair Order Bumps dos Botões Principais
        getAvailableOrderBumps() {
            const available = [];
            if (!Array.isArray(this.config.main_buttons)) {
                return available;
            }
            
            this.config.main_buttons.forEach((button, buttonIndex) => {
                if (Array.isArray(button.order_bumps)) {
                    button.order_bumps.forEach((orderBump, bumpIndex) => {
                        if (orderBump.enabled !== false) {  // Considerar apenas os ativos
                            available.push({
                                buttonIndex: buttonIndex,
                                bumpIndex: bumpIndex,
                                orderBump: orderBump,
                                buttonText: button.text || `Botão ${buttonIndex + 1}`
                            });
                        }
                    });
                }
            });
            
            return available;
        },
        
        // ✅ V2.0: Usar Order Bump dos Botões Principais no Downsell
        useOrderBumpFromButtons(downsell, buttonIndex, bumpIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) {
                alert('Botão não encontrado');
                return;
            }
            
            const button = this.config.main_buttons[buttonIndex];
            if (!button.order_bumps || !button.order_bumps[bumpIndex]) {
                alert('Order bump não encontrado');
                return;
            }
            
            const orderBump = button.order_bumps[bumpIndex];
            
            // Debug: Log dos dados originais
            console.log('📦 Order Bump original:', orderBump);
            console.log('💰 Preço original:', orderBump.price, 'Tipo:', typeof orderBump.price);
            
            // Garantir que order_bump existe no downsell
            if (!downsell.order_bump) {
                downsell.order_bump = {
                    enabled: false,
                    button_index: null,
                    bump_index: null,
                    message: '',
                    price: 0,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: '',
                    decline_text: '',
                    audio_enabled: false,
                    audio_url: ''
                };
            }
            
            // Copiar dados do order bump dos botões para o downsell
            downsell.order_bump.button_index = buttonIndex;
            downsell.order_bump.bump_index = bumpIndex;
            downsell.order_bump.message = orderBump.message || '';
            
            // ✅ Tratamento robusto do preço
            let priceValue = 0;
            if (orderBump.price !== null && orderBump.price !== undefined && orderBump.price !== '') {
                priceValue = parseFloat(orderBump.price);
                if (isNaN(priceValue)) {
                    priceValue = 0;
                }
            }
            downsell.order_bump.price = priceValue;
            
            downsell.order_bump.description = orderBump.description || '';
            downsell.order_bump.media_url = orderBump.media_url || '';
            downsell.order_bump.media_type = orderBump.media_type || 'photo';
            downsell.order_bump.accept_text = orderBump.accept_text || '';
            downsell.order_bump.decline_text = orderBump.decline_text || '';
            downsell.order_bump.audio_enabled = orderBump.audio_enabled || false;
            downsell.order_bump.audio_url = orderBump.audio_url || '';
            
            // Ativar automaticamente
            downsell.order_bump.enabled = true;
            
            console.log(`✅ Order bump do Botão ${buttonIndex + 1} - OB ${bumpIndex + 1} aplicado ao downsell`);
            console.log('📊 Dados copiados:', downsell.order_bump);
        },
        
        removeDownsell(index) {
            this.config.downsells.splice(index, 1);
        },
        
        addUpsell() {
            this.config.upsells.push({
                trigger_product: '',
                delay_minutes: 0,
                message: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                product_name: '',
                price: 0,
                button_text: ''
            });
        },
        
        removeUpsell(index) {
            this.config.upsells.splice(index, 1);
        },
        
        // ✅ NOVO: Trocar Token do Bot
        async changeBotToken() {
            if (!this.newBotToken.trim()) {
                this.showNotification('Digite um token válido', 'error');
                return;
            }
            
            if (!confirm('⚠️ ATENÇÃO CRÍTICA!\n\nAo trocar o token, você criará um NOVO BOT no Telegram.\n\nTODOS os usuários que já interagiram com o bot anterior serão RESETADOS e precisarão iniciar uma nova conversa!\n\nTem CERTEZA que deseja continuar?')) {
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/token', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: this.newBotToken.trim() })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.showNotification('✅ Token atualizado! Bot reconectando...', 'success');
                    this.newBotToken = '';
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    this.showNotification('Erro: ' + (data.error || 'Token inválido'), 'error');
                }
            } catch (error) {
                this.showNotification('Erro ao atualizar token: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },
        
        // ✅ FLUXO VISUAL - Funções de gerenciamento
        onFlowToggle() {
            if (!this.config.flow_enabled) {
                if (this.config.flow_steps && this.config.flow_steps.length > 0) {
                    if (!confirm('⚠️ Ao desativar o fluxo, os steps não serão removidos, mas não serão executados.\n\nDeseja continuar?')) {
                        this.config.flow_enabled = true;
                        return;
                    }
                }
            } else {
                if (!this.config.flow_steps || this.config.flow_steps.length === 0) {
                    if (confirm('📝 Você ainda não tem steps configurados. Deseja adicionar o primeiro step agora?')) {
                        this.addFlowStep();
                    } else {
                        this.config.flow_enabled = false;
                        return;
                    }
                }
                
                // ✅ AUTO-DEFINIR STEP INICIAL quando fluxo é ativado
                if (this.config.flow_steps && this.config.flow_steps.length > 0 && !this.config.flow_start_step_id) {
                    const sortedSteps = [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                    let startStep = null;
                    // Buscar step com order=1 primeiro
                    for (const step of sortedSteps) {
                        if (step.order === 1) {
                            startStep = step;
                            break;
                        }
                    }
                    // Se não encontrou order=1, usar primeiro step
                    if (!startStep && sortedSteps.length > 0) {
                        startStep = sortedSteps[0];
                    }
                    if (startStep) {
                        this.config.flow_start_step_id = startStep.id;
                        this.showNotification(`✅ Step inicial definido automaticamente: ${this.getStepTitle(startStep.type)} (order=${startStep.order || 0})`, 'success');
                    }
                }
            }
        },
        
        // ✅ Definir step como inicial
        setFlowStartStep(stepId) {
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) {
                this.showNotification('❌ Step não encontrado', 'error');
                return;
            }
            
            // Validar se step não é do tipo 'access' (não faz sentido ser inicial)
            if (step.type === 'access') {
                if (!confirm('⚠️ Step do tipo "Acesso" não deve ser inicial (ele libera acesso e finaliza o fluxo).\n\nDeseja continuar mesmo assim?')) {
                    return;
                }
            }
            
            this.config.flow_start_step_id = stepId;
            this.showNotification(`✅ Step inicial definido: ${this.getStepTitle(step.type)} (order=${step.order || 0})`, 'success');
        },
        
        get sortedFlowSteps() {
            if (!this.config.flow_steps || !Array.isArray(this.config.flow_steps)) return [];
            return [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
        },
        
        getStepIcon(type) {
            const icons = {'content': '📸', 'payment': '💰', 'message': '💬', 'audio': '🎵', 'video': '🎥', 'buttons': '🔘', 'access': '✅'};
            return icons[type] || '📦';
        },
        
        initVisualFlowEditor() {
            /**
             * ✅ QI 500: Editor Visual de Fluxo com jsPlumb
             * Renderiza steps como blocos arrastáveis com conexões visuais
             * ✅ PAN (arrastar canvas) e ZOOM (scroll para aumentar/diminuir)
             */
            console.log('🎨 Inicializando editor visual...');
            const self = this;
            const canvas = document.getElementById('flow-visual-canvas');
            if (!canvas) {
                console.error('❌ Canvas não encontrado!');
                return;
            }
            
            console.log('✅ Canvas encontrado:', canvas);
            console.log('📊 Steps disponíveis:', this.sortedFlowSteps.length);
            
            // ✅ PAN E ZOOM: Estado inicial
            let canvasState = {
                isPanning: false,
                startX: 0,
                startY: 0,
                scrollLeft: 0,
                scrollTop: 0,
                zoom: 1.0,
                minZoom: 0.5,
                maxZoom: 2.0,
                zoomStep: 0.1
            };
            
            // ✅ CRÍTICO: Flag para indicar quando está arrastando conexão (endpoint)
            // ✅ Isso previne que PAN interfira com o drag de conexões do jsPlumb
            let isDraggingConnection = false;
            
            // ✅ PAN: Iniciar arrasto do canvas (clicar e segurar no canvas vazio)
            const startPan = (e) => {
                // ✅ CRÍTICO: NÃO iniciar PAN se estiver arrastando conexão ou endpoint
                if (isDraggingConnection) return;
                
                // Verificar se clicou no canvas vazio (não em um card)
                const target = e.target;
                if (target === canvas || target.closest('#flow-visual-canvas') === canvas) {
                    // ✅ CRÍTICO: Verificar se não clicou em endpoint (bolinha verde/vermelha)
                    const isEndpoint = target.closest('.jtk-endpoint') || 
                                      target.closest('.step-input-endpoint') || 
                                      target.closest('.step-output-endpoint') || 
                                      target.closest('.btn-visual-endpoint') ||
                                      target.classList.contains('jtk-endpoint') ||
                                      target.classList.contains('step-input-endpoint') ||
                                      target.classList.contains('step-output-endpoint') ||
                                      target.classList.contains('btn-visual-endpoint');
                    
                    // Verificar se não clicou em um card ou botão
                    if (!target.closest('.flow-step-block') && !target.closest('button') && !isEndpoint) {
                        canvasState.isPanning = true;
                        canvasState.startX = e.pageX - canvas.offsetLeft;
                        canvasState.startY = e.pageY - canvas.offsetTop;
                        canvasState.scrollLeft = canvas.scrollLeft;
                        canvasState.scrollTop = canvas.scrollTop;
                        canvas.style.cursor = 'grabbing';
                        canvas.style.userSelect = 'none';
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }
            };
            
            // ✅ PAN: Arrastar canvas
            const pan = (e) => {
                // ✅ CRÍTICO: NÃO fazer PAN se estiver arrastando conexão
                if (isDraggingConnection || !canvasState.isPanning) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const x = e.pageX - canvas.offsetLeft;
                const y = e.pageY - canvas.offsetTop;
                
                const walkX = (x - canvasState.startX) * 1.5; // Velocidade do pan
                const walkY = (y - canvasState.startY) * 1.5;
                
                canvas.scrollLeft = canvasState.scrollLeft - walkX;
                canvas.scrollTop = canvasState.scrollTop - walkY;
            };
            
            // ✅ PAN: Parar arrasto
            const stopPan = (e) => {
                // ✅ CRÍTICO: NÃO parar PAN se estiver arrastando conexão
                if (isDraggingConnection) return;
                
                if (canvasState.isPanning) {
                    canvasState.isPanning = false;
                    canvas.style.cursor = 'default';
                    canvas.style.userSelect = 'none';
                }
            };
            
            // ✅ ZOOM: Aplicar zoom no canvas e elementos
            const applyZoom = (delta) => {
                const oldZoom = canvasState.zoom;
                canvasState.zoom += delta;
                canvasState.zoom = Math.max(canvasState.minZoom, Math.min(canvasState.maxZoom, canvasState.zoom));
                
                if (oldZoom !== canvasState.zoom) {
                    // ✅ Aplicar zoom via CSS transform no container interno (melhor performance)
                    // Criar ou usar container interno para zoom
                    let zoomContainer = canvas.querySelector('.zoom-container');
                    if (!zoomContainer) {
                        // Criar container se não existir
                        zoomContainer = document.createElement('div');
                        zoomContainer.className = 'zoom-container';
                        zoomContainer.style.width = '100%';
                        zoomContainer.style.height = '100%';
                        zoomContainer.style.position = 'relative';
                        zoomContainer.style.transformOrigin = 'top left';
                        
                        // Mover conteúdo do canvas para o container
                        while (canvas.firstChild) {
                            zoomContainer.appendChild(canvas.firstChild);
                        }
                        canvas.appendChild(zoomContainer);
                    }
                    
                    // Aplicar transform no container
                    zoomContainer.style.transform = `scale(${canvasState.zoom})`;
                    zoomContainer.style.transformOrigin = 'top left';
                    
                    // Ajustar largura/altura do container baseado no zoom
                    const contentWidth = zoomContainer.scrollWidth || canvas.scrollWidth;
                    const contentHeight = zoomContainer.scrollHeight || canvas.scrollHeight;
                    zoomContainer.style.width = `${contentWidth * canvasState.zoom}px`;
                    zoomContainer.style.height = `${contentHeight * canvasState.zoom}px`;
                    
                    // Redesenhar conexões do jsPlumb após zoom
                    if (this.jsPlumbInstance) {
                        setTimeout(() => {
                            try {
                                if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                    this.jsPlumbInstance.repaintEverything();
                                } else if (typeof this.jsPlumbInstance.repaint === 'function') {
                                    this.jsPlumbInstance.repaint();
                                }
                            } catch (e) {
                                console.warn('⚠️ Erro ao redesenhar após zoom:', e);
                            }
                        }, 50);
                    }
                    
                    console.log(`🔍 Zoom: ${(canvasState.zoom * 100).toFixed(0)}%`);
                }
            };
            
            // ✅ ZOOM: Scroll do mouse para aumentar/diminuir
            const handleZoom = (e) => {
                // Verificar se não está arrastando o canvas (pan)
                if (canvasState.isPanning) return;
                
                // Verificar se não está arrastando um card
                if (globalDragState.isDragging) return;
                
                // Verificar se não está sobre um card ou botão (permitir zoom mesmo assim, mas não prevenir default)
                const target = e.target;
                const isOverInteractive = target.closest('.flow-step-block') || target.closest('button') || target.closest('.jtk-endpoint');
                
                // Se não estiver sobre elemento interativo, prevenir scroll padrão e aplicar zoom
                if (!isOverInteractive) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Detectar direção do scroll (Ctrl+Scroll ou apenas Scroll)
                    const delta = e.deltaY > 0 ? -canvasState.zoomStep : canvasState.zoomStep;
                    applyZoom(delta);
                }
            };
            
            // ✅ Event listeners para PAN
            canvas.addEventListener('mousedown', startPan);
            canvas.addEventListener('mousemove', pan);
            canvas.addEventListener('mouseup', stopPan);
            canvas.addEventListener('mouseleave', stopPan);
            
            // ✅ Event listeners para PAN (touch)
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    startPan({
                        target: e.target,
                        pageX: touch.pageX,
                        pageY: touch.pageY,
                        preventDefault: () => e.preventDefault(),
                        stopPropagation: () => e.stopPropagation()
                    });
                }
            }, { passive: false });
            
            canvas.addEventListener('touchmove', (e) => {
                if (canvasState.isPanning && e.touches.length === 1) {
                    const touch = e.touches[0];
                    pan({
                        pageX: touch.pageX,
                        pageY: touch.pageY,
                        preventDefault: () => e.preventDefault(),
                        stopPropagation: () => e.stopPropagation()
                    });
                }
            }, { passive: false });
            
            canvas.addEventListener('touchend', stopPan);
            canvas.addEventListener('touchcancel', stopPan);
            
            // ✅ Event listener para ZOOM (scroll do mouse)
            canvas.addEventListener('wheel', handleZoom, { passive: false });
            
            // ✅ Controle global de drag state - garantir que apenas um card seja arrastado por vez
            let globalDragState = {
                isDragging: false,
                draggedElement: null
            };
            
            // ✅ Event listeners para prevenir scroll durante drag
            let scrollPreventionHandlers = {
                wheel: null,
                touchmove: null
            };
            
            // ✅ Função para prevenir scroll durante drag - SEM position: fixed (evita card pular)
            const preventScrollDuringDrag = (isDragging) => {
                if (isDragging) {
                    // ✅ Apenas desabilitar overflow do canvas (não mexer no body)
                    canvas.style.overflow = 'hidden';
                    canvas.style.touchAction = 'none';
                    
                    // ✅ Prevenir scroll do body sem position: fixed
                    document.body.style.overflow = 'hidden';
                    
                    // ✅ Salvar posição atual do scroll para restaurar depois
                    if (!canvas.dataset.scrollTop) {
                        canvas.dataset.scrollTop = canvas.scrollTop;
                        canvas.dataset.scrollLeft = canvas.scrollLeft;
                    }
                    
                    // ✅ Adicionar event listeners para prevenir scroll via wheel/touch
                    if (!scrollPreventionHandlers.wheel) {
                        scrollPreventionHandlers.wheel = (e) => {
                            // Apenas prevenir se estiver arrastando
                            if (globalDragState.isDragging) {
                                e.preventDefault();
                                e.stopPropagation();
                                return false;
                            }
                        };
                        scrollPreventionHandlers.touchmove = (e) => {
                            // Apenas prevenir se estiver arrastando
                            if (globalDragState.isDragging) {
                                e.preventDefault();
                                e.stopPropagation();
                                return false;
                            }
                        };
                        
                        // Adicionar listeners no canvas e window
                        canvas.addEventListener('wheel', scrollPreventionHandlers.wheel, { passive: false });
                        canvas.addEventListener('touchmove', scrollPreventionHandlers.touchmove, { passive: false });
                        window.addEventListener('wheel', scrollPreventionHandlers.wheel, { passive: false });
                        window.addEventListener('touchmove', scrollPreventionHandlers.touchmove, { passive: false });
                    }
                } else {
                    // ✅ Remover event listeners
                    if (scrollPreventionHandlers.wheel) {
                        canvas.removeEventListener('wheel', scrollPreventionHandlers.wheel);
                        canvas.removeEventListener('touchmove', scrollPreventionHandlers.touchmove);
                        window.removeEventListener('wheel', scrollPreventionHandlers.wheel);
                        window.removeEventListener('touchmove', scrollPreventionHandlers.touchmove);
                        scrollPreventionHandlers.wheel = null;
                        scrollPreventionHandlers.touchmove = null;
                    }
                    
                    // ✅ Restaurar overflow
                    canvas.style.overflow = 'auto';
                    canvas.style.touchAction = 'auto';
                    document.body.style.overflow = '';
                    
                    // ✅ Restaurar posição do scroll se necessário
                    if (canvas.dataset.scrollTop) {
                        canvas.scrollTop = parseInt(canvas.dataset.scrollTop) || 0;
                        canvas.scrollLeft = parseInt(canvas.dataset.scrollLeft) || 0;
                        delete canvas.dataset.scrollTop;
                        delete canvas.dataset.scrollLeft;
                    }
                }
            };
            
            // ✅ Ajustar dimensões do canvas para responsividade
            const adjustCanvasSize = () => {
                const container = canvas.parentElement;
                if (container) {
                    // Calcular altura disponível baseada na viewport
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;
                    
                    // Altura aproximada dos elementos acima do canvas
                    let headerHeight = 200; // Header padrão
                    if (viewportWidth < 640) {
                        headerHeight = 250; // Mobile: mais espaço para header
                    } else if (viewportWidth < 768) {
                        headerHeight = 220; // Tablet
                    }
                    
                    // Altura disponível (viewport - header - margens)
                    const availableHeight = viewportHeight - headerHeight - 40; // 40px de margem
                    
                    // Altura mínima e máxima baseada no tamanho da tela
                    const minHeight = viewportWidth < 640 ? 350 : viewportWidth < 768 ? 400 : 500;
                    const maxHeight = Math.min(availableHeight, viewportHeight * 0.85); // Máximo 85% da viewport
                    
                    // Aplicar altura calculada
                    const finalHeight = Math.max(minHeight, Math.min(maxHeight, availableHeight));
                    canvas.style.height = `${finalHeight}px`;
                    canvas.style.width = '100%';
                    canvas.style.maxWidth = '100%';
                    
                    // Garantir que o container também seja 100%
                    if (container) {
                        container.style.width = '100%';
                        container.style.maxWidth = '100%';
                    }
                    
                    console.log(`📐 Canvas ajustado: ${canvas.style.width} x ${canvas.style.height} (viewport: ${viewportWidth}x${viewportHeight})`);
                }
            };
            
            // Ajustar tamanho inicial
            adjustCanvasSize();
            
            // ✅ Ajustar tamanho ao redimensionar a janela (sempre visual agora)
            window.addEventListener('resize', () => {
                adjustCanvasSize();
                // Redesenhar conexões após resize
                setTimeout(() => {
                    try {
                        if (this.jsPlumbInstance && typeof this.jsPlumbInstance.repaintEverything === 'function') {
                            this.jsPlumbInstance.repaintEverything();
                        } else if (this.jsPlumbInstance && typeof this.jsPlumbInstance.repaint === 'function') {
                            this.jsPlumbInstance.repaint();
                        }
                    } catch (e) {
                        console.warn('⚠️ Erro ao repaint após resize:', e);
                    }
                }, 100);
            });
            
            // Limpar canvas
            canvas.innerHTML = '';
            
            // Aguardar DOM renderizar
            setTimeout(() => {
                try {
                    // ✅ Verificar jsPlumb disponível
                    console.log('🔍 Verificando jsPlumb...');
                    console.log('typeof jsPlumb:', typeof jsPlumb);
                    console.log('jsPlumb:', typeof jsPlumb !== 'undefined' ? (jsPlumb ? 'EXISTS' : 'null') : 'undefined');
                    console.log('window.jsPlumb:', window.jsPlumb);
                    console.log('window.jsPlumb?.jsPlumb:', window.jsPlumb?.jsPlumb);
                    
                    // jsPlumb 2.x usa API diferente
                    let jsPlumbInstance = null;
                    
                    // ✅ Priorizar jsPlumb 2.x (versão estável do CDN)
                    // jsPlumb 2.x pode estar em window.jsPlumb.jsPlumb ou jsPlumb diretamente
                    if (window.jsPlumb && window.jsPlumb.jsPlumb && typeof window.jsPlumb.jsPlumb.getInstance === 'function') {
                        console.log('✅ Usando window.jsPlumb.jsPlumb 2.x');
                        jsPlumbInstance = window.jsPlumb.jsPlumb.getInstance({
                            container: canvas,
                            paintStyle: { stroke: '#3B82F6', strokeWidth: 2 },
                            hoverPaintStyle: { stroke: '#60A5FA', strokeWidth: 3 },
                            endpointStyle: { fill: '#3B82F6', radius: 5 },
                            endpointHoverStyle: { fill: '#60A5FA', radius: 7 },
                            connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                            anchors: ['Right', 'Left', 'Top', 'Bottom'],
                            maxConnections: -1,
                            // ✅ CRÍTICO: Habilitar drag de conexões - linha segue o mouse
                            dragOptions: {
                                cursor: 'crosshair',
                                zIndex: 10000
                            }
                        });
                    } else if (typeof jsPlumb !== 'undefined' && jsPlumb && jsPlumb.jsPlumb && typeof jsPlumb.jsPlumb.getInstance === 'function') {
                        console.log('✅ Usando jsPlumb.jsPlumb 2.x (versão estável)');
                        jsPlumbInstance = jsPlumb.jsPlumb.getInstance({
                            container: canvas,
                            paintStyle: { stroke: '#3B82F6', strokeWidth: 2 },
                            hoverPaintStyle: { stroke: '#60A5FA', strokeWidth: 3 },
                            endpointStyle: { fill: '#3B82F6', radius: 5 },
                            endpointHoverStyle: { fill: '#60A5FA', radius: 7 },
                            connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                            anchors: ['Right', 'Left', 'Top', 'Bottom'],
                            maxConnections: -1,
                            // ✅ CRÍTICO: Habilitar drag de conexões - linha segue o mouse
                            dragOptions: {
                                cursor: 'crosshair',
                                zIndex: 10000
                            }
                        });
                    } else if (typeof jsPlumb !== 'undefined' && jsPlumb && typeof jsPlumb.getInstance === 'function') {
                        console.log('✅ Usando jsPlumb global (versão antiga)');
                        jsPlumbInstance = jsPlumb.getInstance({
                            container: canvas
                        });
                    } else if (window.jsPlumb && typeof window.jsPlumb.newInstance === 'function') {
                        console.log('✅ Usando jsPlumb.newInstance()');
                        jsPlumbInstance = window.jsPlumb.newInstance({
                            container: canvas
                        });
                    } else if (window.jsPlumb && typeof window.jsPlumb.getInstance === 'function') {
                        console.log('✅ Usando window.jsPlumb.getInstance()');
                        jsPlumbInstance = window.jsPlumb.getInstance({
                            container: canvas
                        });
                    } else if (window.jsPlumb) {
                        console.log('✅ Usando window.jsPlumb diretamente');
                        jsPlumbInstance = window.jsPlumb;
                        if (typeof jsPlumbInstance.ready === 'function') {
                            jsPlumbInstance.ready(() => {
                                if (typeof jsPlumbInstance.setContainer === 'function') {
                                    jsPlumbInstance.setContainer(canvas);
                                }
                            });
                        }
                    } else {
                        console.error('❌ jsPlumb não encontrado! Verificando variáveis...');
                        console.error('- typeof jsPlumb:', typeof jsPlumb);
                        console.error('- window.jsPlumb:', window.jsPlumb);
                        console.error('- window.jsPlumb?.jsPlumb:', window.jsPlumb?.jsPlumb);
                        throw new Error('jsPlumb não está disponível. Verifique se o CDN está carregando corretamente.');
                    }
                    
                    if (!jsPlumbInstance) {
                        throw new Error('Não foi possível criar instância do jsPlumb');
                    }
                    
                    // Destruir instância anterior se existir
                    if (this.jsPlumbInstance) {
                        try {
                            this.jsPlumbInstance.destroy();
                        } catch (e) {
                            console.warn('⚠️ Erro ao destruir instância anterior:', e);
                        }
                    }
                    
                    this.jsPlumbInstance = jsPlumbInstance;
                    
                    console.log('✅ Instância jsPlumb criada:', this.jsPlumbInstance);
                    
                    // ✅ Configurar container ANTES de tudo
                    try {
                        if (typeof jsPlumbInstance.setContainer === 'function') {
                            jsPlumbInstance.setContainer(canvas);
                        }
                    } catch (e) {
                        console.warn('⚠️ Erro ao setar container (pode ser normal):', e);
                    }
                    
                    // ✅ Verificar se jsPlumbInstance foi criado com sucesso
                    if (jsPlumbInstance) {
                        // ✅ Configurar estilos padrão
                        const defaultPaintStyle = { stroke: '#3B82F6', strokeWidth: 2 };
                        const defaultHoverPaintStyle = { stroke: '#60A5FA', strokeWidth: 3 };
                        const defaultEndpointStyle = { fill: '#3B82F6', radius: 5 };
                        const defaultEndpointHoverStyle = { fill: '#60A5FA', radius: 7 };
                        
                        // ✅ CRÍTICO: HABILITAR ARRASTE DE CONEXÕES - linha segue o mouse DURANTE O ARRASTE
                        // ✅ Configurar eventos para rastrear quando está arrastando conexão
                        try {
                            // jsPlumb 2.x: habilitar drag de conexões (linha segue mouse)
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                // ✅ Evento quando COMEÇA a arrastar (mousedown na bolinha vermelha)
                                this.jsPlumbInstance.bind('beforeStartConnect', (params, originalEvent) => {
                                    console.log('🎯 Iniciando conexão - linha deve seguir mouse:', params);
                                    // ✅ CRÍTICO: Marcar que está arrastando conexão - previne PAN interferir
                                    isDraggingConnection = true;
                                    // Parar PAN se estiver ativo
                                    if (canvasState.isPanning) {
                                        canvasState.isPanning = false;
                                        canvas.style.cursor = 'crosshair';
                                    }
                                    return true; // Permitir início da conexão
                                });
                                
                                // ✅ Evento DURANTE o drag (mousemove) - linha segue mouse
                                this.jsPlumbInstance.bind('connectionDrag', (connection, originalEvent) => {
                                    // ✅ CRÍTICO: Linha segue o mouse durante o arraste
                                    if (connection && originalEvent) {
                                        // NÃO chamar stopPropagation aqui - permite jsPlumb rastrear mouse
                                        // Apenas atualizar visualmente
                                        if (typeof this.jsPlumbInstance.repaint === 'function') {
                                            // Forçar repaint para linha seguir mouse
                                            this.jsPlumbInstance.repaint(connection.sourceId, connection.targetId);
                                        }
                                    }
                                });
                                
                                // ✅ Evento quando SOLTA a linha (mouseup)
                                this.jsPlumbInstance.bind('connectionDragStop', (connection, originalEvent) => {
                                    console.log('✅ Conexão solta:', connection);
                                    // ✅ CRÍTICO: Desmarcar flag - permite PAN novamente
                                    isDraggingConnection = false;
                                    
                                    if (connection && originalEvent) {
                                        // Repintar para garantir que está ordenado
                                        if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                            setTimeout(() => {
                                                this.jsPlumbInstance.repaintEverything();
                                            }, 50);
                                        }
                                    }
                                });
                                
                                // ✅ Evento quando conexão é criada
                                this.jsPlumbInstance.bind('connection', (connectionInfo) => {
                                    console.log('✅ Conexão criada:', connectionInfo);
                                    // ✅ Desmarcar flag após conexão ser criada
                                    isDraggingConnection = false;
                                });
                            }
                            
                            // jsPlumb 2.x: configurar para permitir drop em qualquer target
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('beforeDrop', (params) => {
                                    console.log('🎯 Tentando fazer drop:', params);
                                    // Permitir drop em qualquer target válido
                                    return true;
                                });
                                
                                // ✅ MELHORADO: Remover conexão com duplo clique OU botão direito OU arrastar endpoint para desconectar
                                // jsPlumb 2.x usa eventos diferentes
                                this.jsPlumbInstance.bind('connection:dblclick', (conn, event) => {
                                    if (event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                    }
                                    if (confirm('❓ Remover esta conexão?')) {
                                        try {
                                            this.jsPlumbInstance.deleteConnection(conn);
                                            console.log('✅ Conexão removida (duplo clique)');
                                            this.updateStepConnectionsFromConnection(conn);
                                        } catch (e) {
                                            console.error('❌ Erro ao remover conexão:', e);
                                        }
                                    }
                                });
                                
                                // ✅ Remover conexão com botão direito
                                this.jsPlumbInstance.bind('connection:contextmenu', (conn, event) => {
                                    if (event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                    }
                                    if (confirm('❓ Remover esta conexão?')) {
                                        try {
                                            this.jsPlumbInstance.deleteConnection(conn);
                                            console.log('✅ Conexão removida (botão direito)');
                                            this.updateStepConnectionsFromConnection(conn);
                                        } catch (e) {
                                            console.error('❌ Erro ao remover conexão:', e);
                                        }
                                    }
                                });
                                
                                // ✅ Remover conexão ao arrastar endpoint de volta para desconectar (soltar fora de um target válido)
                                this.jsPlumbInstance.bind('beforeStartDetach', (params) => {
                                    // Permitir desconectar e reconectar
                                    return true;
                                });
                                
                                this.jsPlumbInstance.bind('connectionDetached', (info) => {
                                    // Conexão desconectada (arrastou endpoint para fora)
                                    console.log('✅ Conexão desconectada:', info);
                                    this.updateStepConnectionsFromConnection(info);
                                    // Limpar target_step se for botão customizado
                                    if (info && info.sourceId && info.sourceId.startsWith('btn-endpoint-')) {
                                        const parts = info.sourceId.split('-');
                                        if (parts.length >= 4) {
                                            const stepId = parts.slice(2, -1).join('-');
                                            const btnType = parts[parts.length - 2];
                                            const btnIdx = parseInt(parts[parts.length - 1]);
                                            const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                            if (sourceStep && sourceStep.config && btnType === 'custom' && sourceStep.config.custom_buttons && sourceStep.config.custom_buttons[btnIdx]) {
                                                sourceStep.config.custom_buttons[btnIdx].target_step = '';
                                            }
                                        }
                                    }
                                });
                                
                                // Após conectar, garantir ordem correta
                                this.jsPlumbInstance.bind('connection', (info) => {
                                    // Quando uma nova conexão é criada
                                    console.log('✅ Nova conexão criada:', info);
                                    
                                    // ✅ Atualizar connections no step
                                    this.updateStepConnectionsFromConnection(info);
                                    
                                    // Repintar tudo para garantir ordem
                                    if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                        setTimeout(() => {
                                            this.jsPlumbInstance.repaintEverything();
                                        }, 50);
                                    }
                                });
                            }
                            
                            // jsPlumb 2.x: Configurar para permitir drag de endpoint (linha segue mouse)
                            if (typeof this.jsPlumbInstance.setSuspendDrawing === 'function') {
                                // Desabilitar desenho suspenso durante drag para melhor performance
                                this.jsPlumbInstance.setSuspendDrawing(false);
                            }
                            
                            // ✅ HABILITAR DRAG DE CONEXÕES - linha segue mouse ao arrastar da bolinha
                            // jsPlumb 2.x: habilitar interatividade de drag
                            if (typeof this.jsPlumbInstance.importDefaults === 'function') {
                                const defaults = {
                                    Connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                    PaintStyle: { stroke: '#EF4444', strokeWidth: 2 },  // ✅ Mudado para vermelho (saída)
                                    HoverPaintStyle: { stroke: '#F87171', strokeWidth: 3 },
                                    Endpoint: ['Dot', { radius: 10 }],
                                    EndpointStyle: { fill: '#EF4444', radius: 10 },  // ✅ Mudado para vermelho (saída)
                                    EndpointHoverStyle: { fill: '#F87171', radius: 12 },
                                    MaxConnections: -1,
                                    AllowNestedGroups: false
                                };
                                this.jsPlumbInstance.importDefaults(defaults);
                            }
                            
                            // ✅ Garantir que drag está habilitado globalmente
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                // Habilitar drag ao clicar em endpoint
                                this.jsPlumbInstance.bind('beforeStartDetach', (params) => {
                                    // Permitir desconectar e reconectar
                                    return true;
                                });
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao configurar drag de conexões (pode ser normal):', e);
                        }
                        
                        // Tentar configurar (pode variar conforme versão)
                        try {
                            if (typeof this.jsPlumbInstance.setDefaultConnectionType === 'function') {
                                this.jsPlumbInstance.setDefaultConnectionType({
                                    type: 'Flowchart',
                                    options: {
                                        stub: [10, 15],
                                        gap: 5,
                                        cornerRadius: 5,
                                        alwaysRespectStubs: true
                                    }
                                });
                            }
                            
                            if (typeof this.jsPlumbInstance.setDefaultConnectionStyle === 'function') {
                                this.jsPlumbInstance.setDefaultConnectionStyle(defaultPaintStyle);
                            }
                            if (typeof this.jsPlumbInstance.setDefaultConnectionHoverStyle === 'function') {
                                this.jsPlumbInstance.setDefaultConnectionHoverStyle(defaultHoverPaintStyle);
                            }
                            if (typeof this.jsPlumbInstance.setDefaultEndpointStyle === 'function') {
                                this.jsPlumbInstance.setDefaultEndpointStyle(defaultEndpointStyle);
                            }
                            if (typeof this.jsPlumbInstance.setDefaultEndpointHoverStyle === 'function') {
                                this.jsPlumbInstance.setDefaultEndpointHoverStyle(defaultEndpointHoverStyle);
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao configurar estilos padrão (pode ser normal):', e);
                        }
                        
                        // ✅ Renderizar steps como blocos
                        const steps = this.sortedFlowSteps;
                        const stepPositions = this.loadStepPositions(); // Carregar posições salvas
                        
                        steps.forEach((step, index) => {
                            const stepId = step.id;
                            const stepName = step.name || this.getStepTitle(step.type);
                            const stepIcon = this.getStepIcon(step.type);
                            const isInitial = this.config.flow_start_step_id === stepId;
                            
                            // Posição (salva ou calculada)
                            const savedPos = stepPositions[stepId];
                            const x = savedPos ? savedPos.x : 100 + (index % 3) * 250;
                            const y = savedPos ? savedPos.y : 100 + Math.floor(index / 3) * 150;
                            
                            // Criar elemento do step
                            const stepEl = document.createElement('div');
                            stepEl.id = `flow-step-${stepId}`;
                            stepEl.className = 'flow-step-block absolute cursor-move bg-gray-800 border-2 rounded-lg p-3 shadow-lg';
                            stepEl.style.left = `${x}px`;
                            stepEl.style.top = `${y}px`;
                            stepEl.style.width = '240px';
                            stepEl.style.zIndex = '10';
                            stepEl.setAttribute('data-step-id', stepId);
                            stepEl.setAttribute('data-step-type', step.type);
                            
                            // Cor baseada no tipo
                            let borderColor = 'border-blue-500';
                            let bgColor = 'bg-blue-900 bg-opacity-30';
                            if (step.type === 'access') borderColor = 'border-purple-500';
                            else if (step.type === 'message') borderColor = 'border-yellow-500';
                            else if (step.type === 'payment') borderColor = 'border-green-500'; // Mantido para compatibilidade com steps existentes
                            
                            stepEl.className += ` ${borderColor} ${bgColor}`;
                            
                            // Conteúdo do bloco (melhorado para usabilidade)
                            const stepPreview = step.config && step.config.message ? 
                                (step.config.message.substring(0, 40) + (step.config.message.length > 40 ? '...' : '')) : 
                                'Sem conteúdo';
                            
                            stepEl.innerHTML = `
                                <!-- ✅ Bola VERDE (entrada) sempre visível no lado esquerdo -->
                                <div style="position: absolute; left: -12px; top: 20px; width: 18px; height: 18px; background: #10B981; border: 3px solid #059669; border-radius: 50%; cursor: crosshair; z-index: 30; box-shadow: 0 0 10px rgba(16, 185, 129, 0.9);" 
                                     class="step-input-endpoint"
                                     title="🟢 Endpoint de Entrada - Conecte aqui para receber de outros cards">
                                </div>
                                <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-700">
                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                        ${isInitial ? '<i class="fas fa-star text-yellow-400 text-sm" title="⭐ Step Inicial"></i>' : ''}
                                        <span class="text-xl flex-shrink-0">${stepIcon}</span>
                                        <span class="text-white font-bold text-sm truncate" title="${stepName}">${stepName}</span>
                                    </div>
                                    <div class="w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0" title="Ordem: ${step.order || index + 1}">
                                        ${step.order || index + 1}
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 mb-2">
                                    ${this.getStepTitle(step.type)}
                                </div>
                                ${stepPreview && stepPreview !== 'Sem conteúdo' ? `
                                    <div class="text-xs text-gray-500 mb-2 truncate" title="${step.config.message || ''}">
                                        "${stepPreview}"
                                    </div>
                                ` : ''}
                                ${step.conditions && step.conditions.length > 0 ? `
                                    <div class="text-xs text-blue-400 mb-1">
                                        🔀 ${step.conditions.length} condição(ões)
                                    </div>
                                ` : ''}
                                ${(() => {
                                    // ✅ Coletar TODOS os botões (customizados + cadastrados)
                                    const allButtons = [];
                                    
                                    // Botões customizados
                                    if (step.config && step.config.custom_buttons) {
                                        step.config.custom_buttons.forEach((btn, idx) => {
                                            allButtons.push({
                                                type: 'custom',
                                                index: idx,
                                                text: btn.text || `Botão ${idx + 1}`,
                                                target_step: btn.target_step,
                                                price: null
                                            });
                                        });
                                    }
                                    
                                    // Botões cadastrados (main_buttons)
                                    if (step.config && step.config.selected_buttons && this.config.main_buttons) {
                                        step.config.selected_buttons.forEach((selected) => {
                                            if (selected.type === 'main' && selected.index !== undefined) {
                                                const mainBtn = this.config.main_buttons[selected.index];
                                                if (mainBtn) {
                                                    allButtons.push({
                                                        type: 'main',
                                                        index: selected.index,
                                                        text: mainBtn.text || `Botão ${selected.index + 1}`,
                                                        target_step: null, // Main buttons não têm target_step individual
                                                        price: mainBtn.price
                                                    });
                                                }
                                            }
                                        });
                                    }
                                    
                                    // Botões cadastrados (redirect_buttons)
                                    if (step.config && step.config.selected_buttons && this.config.redirect_buttons) {
                                        step.config.selected_buttons.forEach((selected) => {
                                            if (selected.type === 'redirect' && selected.index !== undefined) {
                                                const redirectBtn = this.config.redirect_buttons[selected.index];
                                                if (redirectBtn) {
                                                    allButtons.push({
                                                        type: 'redirect',
                                                        index: selected.index,
                                                        text: redirectBtn.text || `Link ${selected.index + 1}`,
                                                        target_step: null,
                                                        url: redirectBtn.url
                                                    });
                                                }
                                            }
                                        });
                                    }
                                    
                                    if (allButtons.length === 0) return '';
                                    
                                    return `
                                        <div class="mt-2 mb-2 border-t border-gray-700 pt-2">
                                            <div class="text-xs text-gray-500 mb-2">Botões:</div>
                                            <div class="space-y-1.5">
                                                ${allButtons.map((btn, idx) => `
                                                    <div class="relative group">
                                                        <div class="flex items-center gap-2 pr-6">
                                                            <div class="flex-1 px-3 py-2 bg-red-600 bg-opacity-60 border-2 border-red-500 rounded-lg text-xs font-semibold text-white truncate"
                                                                 title="${btn.text}${btn.price ? ' - R$ ' + parseFloat(btn.price).toFixed(2) : ''}${btn.target_step ? ' → Step ' + btn.target_step : ''}">
                                                                ${btn.text.length > 25 ? btn.text.substring(0, 22) + '...' : btn.text}
                                                                ${btn.price ? '<span class="text-xs opacity-90"> (R$ ' + parseFloat(btn.price).toFixed(2) + ')</span>' : ''}
                                                            </div>
                                                            <!-- ✅ Bola VERMELHA (saída) ao lado direito de cada botão -->
                                                            <div class="btn-visual-endpoint" 
                                                                 data-button-type="${btn.type}"
                                                                 data-button-index="${btn.index}"
                                                                 data-step-id="${stepId}"
                                                                 data-button-visual-idx="${idx}"
                                                                 style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: #EF4444; border: 3px solid #DC2626; border-radius: 50%; cursor: crosshair; z-index: 30; box-shadow: 0 0 10px rgba(239, 68, 68, 0.9); transition: all 0.2s ease;"
                                                                 title="🔴 Endpoint de Saída - Arraste para conectar ao endpoint VERDE de outro card">
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                })()}
                                ${(() => {
                                    // ✅ Mostrar bola VERMELHA (saída) se NÃO houver botões
                                    const hasButtons = (step.config && step.config.custom_buttons && step.config.custom_buttons.length > 0) ||
                                                     (step.config && step.config.selected_buttons && step.config.selected_buttons.length > 0);
                                    if (!hasButtons) {
                                        return `
                                            <!-- ✅ Bola VERMELHA (saída) no lado direito quando não há botões -->
                                            <div style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: #EF4444; border: 3px solid #DC2626; border-radius: 50%; cursor: crosshair; z-index: 30; box-shadow: 0 0 10px rgba(239, 68, 68, 0.9); transition: all 0.2s ease;" 
                                                 class="step-output-endpoint"
                                                 data-step-id="${stepId}"
                                                 title="🔴 Endpoint de Saída - Arraste para conectar ao endpoint VERDE de outro card">
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}
                                <div class="flex items-center gap-1 mt-2">
                                    <button onclick="window.editFlowStepFromVisual('${stepId}')" 
                                            class="flex-1 px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.removeFlowStepFromVisual('${stepId}')" 
                                            class="flex-1 px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            
                            canvas.appendChild(stepEl);
                            
                            // ✅ Tornar arrastável - PREVENIR SCROLL DA PÁGINA
                            try {
                                // ✅ Função auxiliar para verificar se o elemento é clicável (botão, input, etc)
                                const isClickableElement = (target) => {
                                    if (!target) return false;
                                    const tagName = target.tagName?.toLowerCase();
                                    const isButton = tagName === 'button' || target.closest('button');
                                    const isInput = ['input', 'textarea', 'select', 'a'].includes(tagName) || target.closest('input, textarea, select, a');
                                    const isIcon = target.closest('i.fas, i.far, i.fab');
                                    return isButton || isInput || isIcon;
                                };
                                
                                // ✅ Prevenir scroll durante drag - Desktop
                                const handleMouseDown = (e) => {
                                    // Se clicou em elemento clicável, não iniciar drag
                                    if (isClickableElement(e.target)) {
                                        return;
                                    }
                                    
                                    // ✅ Verificar se já há outro elemento sendo arrastado
                                    if (globalDragState.isDragging && globalDragState.draggedElement !== stepEl) {
                                        return; // Não permitir múltiplos drags simultâneos
                                    }
                                    
                                    // Atualizar estado global
                                    globalDragState.isDragging = true;
                                    globalDragState.draggedElement = stepEl;
                                    
                                    // Adicionar classe dragging para feedback visual
                                    stepEl.classList.add('dragging');
                                    
                                    // Prevenir scroll da página e do canvas durante drag
                                    preventScrollDuringDrag(true);
                                };
                                
                                const handleMouseUp = () => {
                                    // Remover classe dragging
                                    stepEl.classList.remove('dragging');
                                    
                                    // Atualizar estado global
                                    if (globalDragState.draggedElement === stepEl) {
                                        globalDragState.isDragging = false;
                                        globalDragState.draggedElement = null;
                                    }
                                    
                                    // Restaurar scroll
                                    preventScrollDuringDrag(false);
                                };
                                
                                // ✅ Prevenir scroll durante drag - Mobile/Touch
                                const handleTouchStart = (e) => {
                                    // Se tocou em elemento clicável, não iniciar drag
                                    if (isClickableElement(e.target)) {
                                        return;
                                    }
                                    
                                    // ✅ Verificar se já há outro elemento sendo arrastado
                                    if (globalDragState.isDragging && globalDragState.draggedElement !== stepEl) {
                                        return;
                                    }
                                    
                                    // Atualizar estado global
                                    globalDragState.isDragging = true;
                                    globalDragState.draggedElement = stepEl;
                                    
                                    // Adicionar classe dragging
                                    stepEl.classList.add('dragging');
                                    
                                    // Prevenir scroll
                                    preventScrollDuringDrag(true);
                                };
                                
                                const handleTouchEnd = () => {
                                    // Remover classe dragging
                                    stepEl.classList.remove('dragging');
                                    
                                    // Atualizar estado global
                                    if (globalDragState.draggedElement === stepEl) {
                                        globalDragState.isDragging = false;
                                        globalDragState.draggedElement = null;
                                    }
                                    
                                    // Restaurar scroll
                                    preventScrollDuringDrag(false);
                                };
                                
                                // ✅ Adicionar event listeners
                                stepEl.addEventListener('mousedown', handleMouseDown, { passive: true });
                                stepEl.addEventListener('mouseup', handleMouseUp, { passive: true });
                                stepEl.addEventListener('mouseleave', handleMouseUp, { passive: true });
                                
                                stepEl.addEventListener('touchstart', handleTouchStart, { passive: false });
                                stepEl.addEventListener('touchend', handleTouchEnd, { passive: true });
                                stepEl.addEventListener('touchcancel', handleTouchEnd, { passive: true });
                                
                                // ✅ Configurar draggable do jsPlumb
                                if (typeof this.jsPlumbInstance.draggable === 'function') {
                                    // jsPlumb 5.x
                                    this.jsPlumbInstance.draggable(stepEl, {
                                        containment: 'parent',
                                        grid: [10, 10],
                                        filter: 'button, input, textarea, select, a, i', // ✅ Não arrastar se clicar nestes elementos
                                        drag: (el, e) => {
                                            // ✅ Prevenir scroll durante drag
                                            if (e && e.originalEvent) {
                                                e.originalEvent.preventDefault();
                                                e.originalEvent.stopPropagation();
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            // Garantir que scroll está desabilitado
                                            preventScrollDuringDrag(true);
                                            
                                            // Adicionar classe dragging se ainda não tiver
                                            if (!stepEl.classList.contains('dragging')) {
                                                stepEl.classList.add('dragging');
                                            }
                                        },
                                        start: (el, e) => {
                                            // Verificar se não é elemento clicável
                                            if (e && e.originalEvent && isClickableElement(e.originalEvent.target)) {
                                                return false; // Cancelar drag
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            stepEl.classList.add('dragging');
                                            preventScrollDuringDrag(true);
                                        },
                                        stop: (el, e) => {
                                            // Remover classe dragging
                                            stepEl.classList.remove('dragging');
                                            
                                            // Atualizar estado global
                                            if (globalDragState.draggedElement === stepEl) {
                                                globalDragState.isDragging = false;
                                                globalDragState.draggedElement = null;
                                            }
                                            
                                            // Restaurar scroll após drag
                                            preventScrollDuringDrag(false);
                                            
                                            // Salvar posição quando arrastar
                                            const rect = stepEl.getBoundingClientRect();
                                            const canvasRect = canvas.getBoundingClientRect();
                                            const x = rect.left - canvasRect.left + canvas.scrollLeft;
                                            const y = rect.top - canvasRect.top + canvas.scrollTop;
                                            this.saveStepPosition(stepId, x, y);
                                        }
                                    });
                                } else if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                    // jsPlumb 2.x
                                    this.jsPlumbInstance.draggable(stepEl, {
                                        containment: 'parent',
                                        grid: [10, 10],
                                        filter: 'button, input, textarea, select, a, i', // ✅ Não arrastar se clicar nestes elementos
                                        drag: (el, e) => {
                                            // ✅ Prevenir scroll durante drag
                                            if (e && e.originalEvent) {
                                                e.originalEvent.preventDefault();
                                                e.originalEvent.stopPropagation();
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            preventScrollDuringDrag(true);
                                            
                                            if (!stepEl.classList.contains('dragging')) {
                                                stepEl.classList.add('dragging');
                                            }
                                        },
                                        start: (el, e) => {
                                            if (e && e.originalEvent && isClickableElement(e.originalEvent.target)) {
                                                return false;
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            stepEl.classList.add('dragging');
                                            preventScrollDuringDrag(true);
                                        },
                                        stop: (el, e) => {
                                            stepEl.classList.remove('dragging');
                                            
                                            // Atualizar estado global
                                            if (globalDragState.draggedElement === stepEl) {
                                                globalDragState.isDragging = false;
                                                globalDragState.draggedElement = null;
                                            }
                                            
                                            preventScrollDuringDrag(false);
                                            
                                            // Salvar posição
                                            const rect = stepEl.getBoundingClientRect();
                                            const canvasRect = canvas.getBoundingClientRect();
                                            const x = rect.left - canvasRect.left + canvas.scrollLeft;
                                            const y = rect.top - canvasRect.top + canvas.scrollTop;
                                            this.saveStepPosition(stepId, x, y);
                                        }
                                    });
                                }
                            } catch (e) {
                                console.error('❌ Erro ao tornar arrastável:', e);
                            }
                            
                            // ✅ CRÍTICO: NÃO usar makeTarget/makeSource no card inteiro!
                            // ✅ Endpoints serão criados APENAS nos elementos visuais (bolinhas) dentro do setTimeout abaixo
                            // ✅ Isso previne conexões automáticas ao clicar/arrastar o card
                            
                            // ✅ Adicionar endpoints INDIVIDUAIS para TODOS os botões (customizados + cadastrados)
                            // ✅ Usar os elementos visuais criados no HTML (.btn-visual-endpoint)
                            try {
                                // Aguardar DOM renderizar para encontrar os elementos
                                setTimeout(() => {
                                    const allButtonEndpoints = stepEl.querySelectorAll('.btn-visual-endpoint');
                                    
                                    // ✅ Primeiro, adicionar endpoint para bola vermelha geral (quando não há botões)
                                    const stepOutputEndpoint = stepEl.querySelector('.step-output-endpoint');
                                    if (stepOutputEndpoint) {
                                        const outputEndpointId = `source-${stepId}`;
                                        stepOutputEndpoint.id = outputEndpointId;
                                        stepOutputEndpoint.style.cursor = 'crosshair';
                                        
                                        // Adicionar efeito hover
                                        stepOutputEndpoint.addEventListener('mouseenter', () => {
                                            stepOutputEndpoint.style.transform = 'translateY(-50%) scale(1.3)';
                                            stepOutputEndpoint.style.boxShadow = '0 0 12px rgba(239, 68, 68, 1)';
                                        });
                                        stepOutputEndpoint.addEventListener('mouseleave', () => {
                                            stepOutputEndpoint.style.transform = 'translateY(-50%) scale(1)';
                                            stepOutputEndpoint.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.9)';
                                        });
                                        
                                        // ✅ Conectar bola vermelha geral ao jsPlumb - HABILITAR DRAG
                                        if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                            // ✅ CRÍTICO: Configurar para permitir drag da bolinha vermelha
                                            // ✅ CRÍTICO: makeSource permite drag automático - linha sai da bolinha e segue o mouse
                                            // ✅ Usar endpoint invisível (radius: 0) para não duplicar visualmente
                                            this.jsPlumbInstance.makeSource(stepOutputEndpoint, {
                                                anchor: 'Right',
                                                endpoint: ['Dot', { radius: 0 }], // ✅ Invisível - elemento HTML já é visível
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: -1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 2 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 3 },
                                                beforeDrop: () => { return true; },
                                                onMaxConnections: () => { console.log('⚠️ Máximo de conexões atingido'); }
                                            });
                                        } else if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                            // jsPlumb 5.x - Endpoint VERMELHO apenas na bolinha visual
                                            // ✅ Usar endpoint invisível (radius: 0) para não duplicar visualmente
                                            this.jsPlumbInstance.addEndpoint(stepOutputEndpoint, {
                                                anchor: 'Right',
                                                endpoint: ['Dot', { radius: 0 }], // ✅ Invisível - elemento HTML já é visível
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: -1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 2 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 3 },
                                                beforeDrop: () => { return true; }
                                            }, {
                                                uuid: outputEndpointId
                                            });
                                        }
                                        
                                        console.log(`✅ Bola vermelha geral conectada para step ${stepId}`);
                                    }
                                    
                                    // ✅ CRÍTICO: Criar endpoint VERDE (entrada) APENAS no elemento visual
                                    // ✅ Isso previne criação de conexões ao clicar no card inteiro
                                    const stepInputEndpoint = stepEl.querySelector('.step-input-endpoint');
                                    if (stepInputEndpoint) {
                                        const inputEndpointId = `target-${stepId}`;
                                        stepInputEndpoint.id = inputEndpointId;
                                        
                                        // Adicionar efeito hover no endpoint verde
                                        stepInputEndpoint.addEventListener('mouseenter', () => {
                                            stepInputEndpoint.style.transform = 'scale(1.3)';
                                            stepInputEndpoint.style.boxShadow = '0 0 12px rgba(16, 185, 129, 1)';
                                        });
                                        stepInputEndpoint.addEventListener('mouseleave', () => {
                                            stepInputEndpoint.style.transform = 'scale(1)';
                                            stepInputEndpoint.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.9)';
                                        });
                                        
                                        // ✅ Criar endpoint jsPlumb APENAS no elemento visual (bolinha verde)
                                        // ✅ CRÍTICO: Usar endpoint invisível do jsPlumb, mas manter elemento visual HTML visível
                                        if (typeof this.jsPlumbInstance.makeTarget === 'function') {
                                            // jsPlumb 2.x - Endpoint VERDE apenas na bolinha visual
                                            // ✅ Usar endpoint invisível (radius: 0) para não duplicar visualmente
                                            this.jsPlumbInstance.makeTarget(stepInputEndpoint, {
                                                anchor: 'Left',
                                                endpoint: ['Dot', { radius: 0 }], // ✅ Invisível - elemento HTML já é visível
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: false,
                                                isTarget: true,
                                                maxConnections: -1,
                                                dropOptions: { hoverClass: 'drop-hover', activeClass: 'drop-active' }
                                            });
                                        } else if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                            // jsPlumb 5.x - Endpoint VERDE apenas na bolinha visual
                                            // ✅ Usar endpoint invisível (radius: 0) para não duplicar visualmente
                                            this.jsPlumbInstance.addEndpoint(stepInputEndpoint, {
                                                anchor: 'Left',
                                                endpoint: ['Dot', { radius: 0 }], // ✅ Invisível - elemento HTML já é visível
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: false,
                                                isTarget: true,
                                                maxConnections: -1,
                                                dropOptions: { hoverClass: 'drop-hover', activeClass: 'drop-active' }
                                            }, {
                                                uuid: inputEndpointId
                                            });
                                        }
                                        
                                        console.log(`✅ Bola verde (entrada) conectada para step ${stepId}`);
                                    }
                                    
                                    // ✅ Agora, adicionar endpoints para cada botão
                                    allButtonEndpoints.forEach((endpointEl, visualIdx) => {
                                        const btnType = endpointEl.getAttribute('data-button-type');
                                        const btnIndex = endpointEl.getAttribute('data-button-index');
                                        const buttonEndpointId = `btn-endpoint-${stepId}-${btnType}-${btnIndex}-${visualIdx}`;
                                        
                                        // Obter texto do botão
                                        let btnText = '';
                                        if (btnType === 'custom' && step.config && step.config.custom_buttons) {
                                            const customBtn = step.config.custom_buttons[parseInt(btnIndex)];
                                            btnText = (customBtn && customBtn.text) ? customBtn.text.substring(0, 15) : `Botão ${btnIndex}`;
                                        } else if (btnType === 'main' && this.config.main_buttons) {
                                            const mainBtn = this.config.main_buttons[parseInt(btnIndex)];
                                            btnText = (mainBtn && mainBtn.text) ? mainBtn.text.substring(0, 15) : `Botão ${btnIndex}`;
                                        } else if (btnType === 'redirect' && this.config.redirect_buttons) {
                                            const redirectBtn = this.config.redirect_buttons[parseInt(btnIndex)];
                                            btnText = (redirectBtn && redirectBtn.text) ? redirectBtn.text.substring(0, 15) : `Link ${btnIndex}`;
                                        }
                                        
                                        if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                            // jsPlumb 2.x: usar o elemento visual como source
                                            endpointEl.id = buttonEndpointId;
                                            endpointEl.style.cursor = 'crosshair';
                                            
                                            // Adicionar efeito hover
                                            endpointEl.addEventListener('mouseenter', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1.3)';
                                                endpointEl.style.boxShadow = '0 0 12px rgba(255, 107, 107, 1)';
                                            });
                                            endpointEl.addEventListener('mouseleave', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1)';
                                                endpointEl.style.boxShadow = '0 0 8px rgba(255, 107, 107, 0.8)';
                                            });
                                            
                                            // ✅ CRÍTICO: makeSource permite drag automático - linha sai da bolinha e segue o mouse
                                            // ✅ Ao clicar e arrastar da bolinha vermelha, a linha deve sair dali e acompanhar o mouse
                                            // ✅ Usar endpoint invisível (radius: 0) para não duplicar visualmente
                                            this.jsPlumbInstance.makeSource(endpointEl, {
                                                anchor: 'Right',
                                                endpoint: ['Dot', { radius: 0 }], // ✅ Invisível - elemento HTML já é visível
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: 1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 3 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 4 },
                                                onMaxConnections: (info) => {
                                                    console.log('⚠️ Máximo de conexões atingido para este botão');
                                                }
                                            });
                                        } else if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                            // jsPlumb 5.x: criar endpoint usando posição do elemento visual
                                            endpointEl.id = buttonEndpointId;
                                            endpointEl.style.cursor = 'crosshair';
                                            
                                            // Adicionar efeito hover (VERMELHO)
                                            endpointEl.addEventListener('mouseenter', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1.3)';
                                                endpointEl.style.boxShadow = '0 0 12px rgba(239, 68, 68, 1)';
                                            });
                                            endpointEl.addEventListener('mouseleave', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1)';
                                                endpointEl.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.9)';
                                            });
                                            
                                            // Calcular posição relativa do endpoint
                                            const rect = endpointEl.getBoundingClientRect();
                                            const stepRect = stepEl.getBoundingClientRect();
                                            const relativeTop = (rect.top - stepRect.top + rect.height / 2) / stepRect.height;
                                            
                                            // ✅ HABILITAR ARRASTE: linha segue o mouse ao arrastar da bolinha VERMELHA
                                            // ✅ jsPlumb 5.x: usar elemento visual como base, mas endpoint no stepEl para posicionamento correto
                                            // ✅ Usar endpoint invisível (radius: 0) para não duplicar visualmente
                                            this.jsPlumbInstance.addEndpoint(stepEl, {
                                                anchor: ['Right', relativeTop, 1, 0, 0, 0],
                                                endpoint: ['Dot', { radius: 0 }], // ✅ Invisível - elemento HTML já é visível
                                                paintStyle: { fill: 'transparent', stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', stroke: 'transparent', strokeWidth: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: 1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 3 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 4 },
                                                beforeDrop: () => {
                                                    return true; // Permitir drop em qualquer target
                                                }
                                            }, {
                                                uuid: buttonEndpointId
                                            });
                                            
                                            // Adicionar label
                                            const endpoint = this.jsPlumbInstance.getEndpoint(buttonEndpointId);
                                            if (endpoint && endpoint.setLabel) {
                                                endpoint.setLabel({
                                                    label: btnText,
                                                    location: [0.5, -0.5],
                                                    cssClass: 'btn-endpoint-label'
                                                });
                                            }
                                            
                                            // ✅ NÃO criar endpoint verde aqui - já foi criado acima apenas no elemento visual
                                            // ✅ Isso previne duplicação e conexões automáticas ao clicar no card
                                        }
                                    });
                                }, 100); // Delay para garantir DOM renderizado
                            } catch (e) {
                                console.error('❌ Erro ao adicionar endpoints de botões:', e);
                            }
                        });
                        
                        // ✅ REMOVIDO: Conexões automáticas - linhas só aparecem quando usuário arrasta da bola vermelha para a verde
                        // As conexões serão criadas apenas quando o usuário arrastar manualmente os endpoints
                        // Isso dá mais controle ao usuário sobre como conectar os steps
                        console.log('✅ Endpoints criados! Arraste da bola VERMELHA (saída) para a bola VERDE (entrada) para criar conexões.');
                        
                        // ✅ OBSOLETO: Código de conexão automática removido - conexões devem ser criadas manualmente pelo usuário
                        /*
                        steps.forEach(step => {
                            const stepEl = document.getElementById(`flow-step-${step.id}`);
                            if (!stepEl) return;
                            
                            const connections = step.connections || {};
                            
                            // Conexão "next" (verde) - MELHORADA
                            if (connections.next) {
                                const targetEl = document.getElementById(`flow-step-${connections.next}`);
                                if (targetEl) {
                                    try {
                                        const connection = this.jsPlumbInstance.connect({
                                            source: stepEl,
                                            target: targetEl,
                                            paintStyle: { stroke: '#10B981', strokeWidth: 3, strokeLinecap: 'round', strokeLinejoin: 'round' },
                                            overlays: [
                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                ['Label', { 
                                                    label: 'Próximo', 
                                                    location: 0.5, 
                                                    cssClass: 'connection-label',
                                                    labelStyle: {
                                                        backgroundColor: 'rgba(16, 185, 129, 0.9)',
                                                        color: '#FFFFFF',
                                                        padding: '3px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: 'bold'
                                                    }
                                                }]
                                            ],
                                            detachable: true,
                                            reattach: true,
                                            deleteEndpointsOnDetach: false
                                        });
                                        
                                        // ✅ Adicionar feedback visual ao hover e marcação como removível
                                        if (connection) {
                                            if (connection.canvas) {
                                                connection.canvas.setAttribute('data-removable', 'true');
                                            }
                                            
                                            // Tentar adicionar eventos de hover (pode variar por versão do jsPlumb)
                                            try {
                                                if (connection.bind && typeof connection.bind === 'function') {
                                                    connection.bind('mouseenter', () => {
                                                        if (connection.canvas) {
                                                            connection.canvas.style.cursor = 'pointer';
                                                            connection.canvas.style.filter = 'drop-shadow(0 0 8px rgba(16, 185, 129, 0.9))';
                                                            connection.canvas.style.strokeWidth = '4';
                                                        }
                                                    });
                                                    connection.bind('mouseleave', () => {
                                                        if (connection.canvas) {
                                                            connection.canvas.style.filter = '';
                                                            connection.canvas.style.strokeWidth = '';
                                                        }
                                                    });
                                                }
                                            } catch (e) {
                                                // Pode não funcionar em algumas versões do jsPlumb, ignorar
                                            }
                                        }
                                    } catch (e) {
                                        console.error('❌ Erro ao conectar next:', e);
                                    }
                                }
                            }
                            
                            // Conexão "pending" (vermelho) - MELHORADA
                            if (connections.pending) {
                                const targetEl = document.getElementById(`flow-step-${connections.pending}`);
                                if (targetEl) {
                                    try {
                                        const connection = this.jsPlumbInstance.connect({
                                            source: stepEl,
                                            target: targetEl,
                                            paintStyle: { stroke: '#EF4444', strokeWidth: 3, strokeLinecap: 'round', strokeLinejoin: 'round', strokeDasharray: '5,5' },
                                            overlays: [
                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                ['Label', { 
                                                    label: 'Pendente', 
                                                    location: 0.5, 
                                                    cssClass: 'connection-label',
                                                    labelStyle: {
                                                        backgroundColor: 'rgba(239, 68, 68, 0.9)',
                                                        color: '#FFFFFF',
                                                        padding: '3px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: 'bold'
                                                    }
                                                }]
                                            ],
                                            detachable: true,
                                            reattach: true,
                                            deleteEndpointsOnDetach: false
                                        });
                                    } catch (e) {
                                        console.error('❌ Erro ao conectar pending:', e);
                                    }
                                }
                            }
                            
                            // Conexão "retry" (amarelo) - MELHORADA
                            if (connections.retry) {
                                const targetEl = document.getElementById(`flow-step-${connections.retry}`);
                                if (targetEl) {
                                    try {
                                        const connection = this.jsPlumbInstance.connect({
                                            source: stepEl,
                                            target: targetEl,
                                            paintStyle: { stroke: '#F59E0B', strokeWidth: 3, strokeLinecap: 'round', strokeLinejoin: 'round', strokeDasharray: '8,4' },
                                            overlays: [
                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                ['Label', { 
                                                    label: 'Retry', 
                                                    location: 0.5, 
                                                    cssClass: 'connection-label',
                                                    labelStyle: {
                                                        backgroundColor: 'rgba(245, 158, 11, 0.9)',
                                                        color: '#FFFFFF',
                                                        padding: '3px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: 'bold'
                                                    }
                                                }]
                                            ],
                                            detachable: true,
                                            reattach: true,
                                            deleteEndpointsOnDetach: false
                                        });
                                    } catch (e) {
                                        console.error('❌ Erro ao conectar retry:', e);
                                    }
                                }
                            }
                            
                            // ✅ Conectar botões customizados - REMOVIDO (conexões devem ser criadas manualmente)
                            // ✅ Cada botão customizado pode ter sua própria conexão para um step diferente
                            // ✅ Aguardar endpoints serem criados antes de conectar
                            // ✅ CÓDIGO REMOVIDO: Conexões automáticas de botões customizados foram removidas
                            // ✅ As conexões devem ser criadas manualmente pelo usuário arrastando da bola vermelha para a verde
                            // ✅ TODO O CÓDIGO DE CONEXÃO AUTOMÁTICA FOI REMOVIDO - NÃO HÁ MAIS COMENTÁRIOS ANINHADOS
                            // ✅ O código comentado abaixo foi removido para evitar erro de sintaxe com comentários aninhados
                            /*
                            setTimeout(() => {
                                if (step.config && step.config.custom_buttons && step.config.custom_buttons.length > 0) {
                                    step.config.custom_buttons.forEach((btn, btnIdx) => {
                                        if (btn.target_step) {
                                            const targetEl = document.getElementById(`flow-step-${btn.target_step}`);
                                            if (targetEl) {
                                                try {
                                                    // ✅ Usar novo formato de ID de endpoint
                                                    const buttonEndpointId = `btn-endpoint-${step.id}-custom-${btnIdx}-0`;
                                                    const btnText = (btn.text || `Botão ${btnIdx + 1}`).substring(0, 15); // Limitar tamanho do label
                                                    
                                                    // ✅ Tentar encontrar o elemento visual do endpoint também
                                                    const endpointVisualEl = stepEl.querySelector(`[data-button-type="custom"][data-button-index="${btnIdx}"]`);
                                                    
                                                    if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                                        // jsPlumb 5.x: conectar usando UUID do endpoint
                                                        // ✅ Buscar endpoint ou criar se não existir
                                                        let endpoint = null;
                                                        try {
                                                            endpoint = this.jsPlumbInstance.getEndpoint(buttonEndpointId);
                                                        } catch (e) {
                                                            console.warn('⚠️ Endpoint não encontrado, tentando usar elemento visual:', buttonEndpointId);
                                                        }
                                                        
                                                        // ✅ Se não encontrou por ID, tentar usar elemento visual
                                                        const sourceEl = endpoint || endpointVisualEl || stepEl;
                                                        
                                                        if (endpoint || endpointVisualEl) {
                                                            const connection = this.jsPlumbInstance.connect({
                                                                source: sourceEl,
                                                                target: targetEl,
                                                            paintStyle: { stroke: '#FF6B6B', strokeWidth: 3 },
                                                            overlays: [
                                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                                ['Label', { 
                                                                    label: btnText, 
                                                                    location: 0.5, 
                                                                    cssClass: 'connection-label',
                                                                    labelStyle: { 
                                                                        color: '#FF6B6B', 
                                                                        fontWeight: 'bold',
                                                                        fontSize: '11px',
                                                                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                        padding: '3px 8px',
                                                                        borderRadius: '4px',
                                                                        border: '1px solid #FF6B6B'
                                                                    }
                                                                }]
                                                            ],
                                                            detachable: true,
                                                            reattach: true
                                                        });
                                                        
                                                        // ✅ Marcar como conexão de botão customizado e removível
                                                        if (connection && connection.canvas) {
                                                            connection.canvas.setAttribute('data-button-connection', 'true');
                                                            connection.canvas.setAttribute('data-removable', 'true');
                                                        }
                                                    } else {
                                                        // Fallback: conectar diretamente usando ID do endpoint como string
                                                        const connection = this.jsPlumbInstance.connect({
                                                            source: buttonEndpointId,
                                                            target: targetEl,
                                                            paintStyle: { stroke: '#FF6B6B', strokeWidth: 3 },
                                                            overlays: [
                                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                                ['Label', { 
                                                                    label: btnText, 
                                                                    location: 0.5, 
                                                                    cssClass: 'connection-label',
                                                                    labelStyle: { 
                                                                        color: '#FF6B6B', 
                                                                        fontWeight: 'bold',
                                                                        fontSize: '11px',
                                                                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                        padding: '3px 8px',
                                                                        borderRadius: '4px',
                                                                        border: '1px solid #FF6B6B'
                                                                    }
                                                                }]
                                                            ],
                                                            detachable: true,
                                                            reattach: true
                                                        });
                                                        
                                                        // ✅ Marcar como conexão de botão customizado e removível
                                                        if (connection && connection.canvas) {
                                                            connection.canvas.setAttribute('data-button-connection', 'true');
                                                            connection.canvas.setAttribute('data-removable', 'true');
                                                        }
                                                    }
                                                    } else if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                                        // jsPlumb 2.x: conectar usando elemento visual do endpoint
                                                        const sourceEl = endpointVisualEl || document.getElementById(buttonEndpointId) || stepEl;
                                                    
                                                    const connection = this.jsPlumbInstance.connect({
                                                        source: sourceEl,
                                                        target: targetEl,
                                                        paintStyle: { stroke: '#FF6B6B', strokeWidth: 3 },
                                                        overlays: [
                                                            ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                            ['Label', { 
                                                                label: btnText, 
                                                                location: 0.5, 
                                                                cssClass: 'connection-label',
                                                                labelStyle: { 
                                                                    color: '#FF6B6B', 
                                                                    fontWeight: 'bold',
                                                                    fontSize: '11px',
                                                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                    padding: '3px 8px',
                                                                    borderRadius: '4px',
                                                                    border: '1px solid #FF6B6B'
                                                                }
                                                            }]
                                                        ],
                                                        detachable: true,
                                                        reattach: true
                                                    });
                                                    
                                                    // ✅ Marcar como conexão de botão customizado e removível
                                                    if (connection && connection.canvas) {
                                                        connection.canvas.setAttribute('data-button-connection', 'true');
                                                        connection.canvas.setAttribute('data-removable', 'true');
                                                    }
                                                }
                                                
                                                console.log(`✅ Botão "${btnText}" conectado de step ${step.id} para step ${btn.target_step}`);
                                            } catch (e) {
                                                console.error('❌ Erro ao conectar botão customizado:', e);
                                                console.error('   Step:', step.id, 'Botão:', btnIdx, 'Target:', btn.target_step);
                                            }
                                        }
                                    }
                                });
                            }
                            }, 200);
                            */
                            
                            // ✅ Conectar condições - REMOVIDO (conexões devem ser criadas manualmente)
                            // ✅ TODO O CÓDIGO DE CONEXÃO AUTOMÁTICA FOI REMOVIDO
                        
                        // ✅ PERMITIR REMOVER CONEXÕES - CRÍTICO PARA USABILIDADE
                        try {
                            // ✅ Double-click na conexão para remover
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('connection:dblclick', (connection, event) => {
                                    event.stopPropagation();
                                    event.preventDefault();
                                    
                                    if (confirm('❓ Remover esta conexão?')) {
                                        try {
                                            // ✅ Extrair informações da conexão para atualizar dados
                                            const sourceId = connection.sourceId || connection.source?.id || connection.sourceEndpoint?.uuid || '';
                                            const targetId = connection.targetId || connection.target?.id || connection.targetEndpoint?.uuid || '';
                                            
                                            // ✅ Verificar se é conexão de botão customizado
                                            if (sourceId.startsWith('btn-endpoint-')) {
                                                const parts = sourceId.split('-');
                                                if (parts.length >= 4) {
                                                    const stepId = parts.slice(2, -1).join('-');
                                                    const btnIdx = parseInt(parts[parts.length - 1]);
                                                    
                                                    const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                                    if (sourceStep && sourceStep.config && sourceStep.config.custom_buttons && sourceStep.config.custom_buttons[btnIdx]) {
                                                        sourceStep.config.custom_buttons[btnIdx].target_step = '';
                                                        this.showNotification(`✅ Conexão do botão "${sourceStep.config.custom_buttons[btnIdx].text}" removida`, 'success');
                                                    }
                                                }
                                            } else {
                                                // ✅ Conexão normal
                                                const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                                                const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                                                if (sourceStep && sourceStep.connections) {
                                                    if (sourceStep.connections.next === targetId.replace('target-', '').replace('flow-step-', '')) {
                                                        sourceStep.connections.next = '';
                                                    }
                                                    if (sourceStep.connections.pending === targetId.replace('target-', '').replace('flow-step-', '')) {
                                                        sourceStep.connections.pending = '';
                                                    }
                                                    if (sourceStep.connections.retry === targetId.replace('target-', '').replace('flow-step-', '')) {
                                                        sourceStep.connections.retry = '';
                                                    }
                                                    this.showNotification('✅ Conexão removida', 'success');
                                                }
                                            }
                                            
                                            // ✅ Remover conexão visualmente
                                            this.jsPlumbInstance.deleteConnection(connection);
                                        } catch (e) {
                                            console.error('❌ Erro ao remover conexão:', e);
                                            this.showNotification('❌ Erro ao remover conexão', 'error');
                                        }
                                    }
                                });
                            }
                            
                            // ✅ Click direito na conexão para remover (context menu)
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('connection:contextmenu', (connection, event) => {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    
                                    if (confirm('❓ Remover esta conexão?')) {
                                        try {
                                            const sourceId = connection.sourceId || connection.source?.id || connection.sourceEndpoint?.uuid || '';
                                            const targetId = connection.targetId || connection.target?.id || connection.targetEndpoint?.uuid || '';
                                            
                                            // ✅ Verificar se é conexão de botão customizado
                                            if (sourceId.startsWith('btn-endpoint-')) {
                                                const parts = sourceId.split('-');
                                                if (parts.length >= 4) {
                                                    const stepId = parts.slice(2, -1).join('-');
                                                    const btnIdx = parseInt(parts[parts.length - 1]);
                                                    
                                                    const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                                    if (sourceStep && sourceStep.config && sourceStep.config.custom_buttons && sourceStep.config.custom_buttons[btnIdx]) {
                                                        sourceStep.config.custom_buttons[btnIdx].target_step = '';
                                                        this.showNotification(`✅ Conexão do botão "${sourceStep.config.custom_buttons[btnIdx].text}" removida`, 'success');
                                                    }
                                                }
                                            } else {
                                                const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                                                const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                                                if (sourceStep && sourceStep.connections) {
                                                    const targetStepId = targetId.replace('target-', '').replace('flow-step-', '');
                                                    if (sourceStep.connections.next === targetStepId) sourceStep.connections.next = '';
                                                    if (sourceStep.connections.pending === targetStepId) sourceStep.connections.pending = '';
                                                    if (sourceStep.connections.retry === targetStepId) sourceStep.connections.retry = '';
                                                    this.showNotification('✅ Conexão removida', 'success');
                                                }
                                            }
                                            
                                            this.jsPlumbInstance.deleteConnection(connection);
                                        } catch (e) {
                                            console.error('❌ Erro ao remover conexão:', e);
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao bind delete connection (pode ser normal):', e);
                        }
                        
                        // ✅ Permitir criar conexões arrastando
                        try {
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('connection', (info) => {
                                    // ✅ Extrair informações da conexão
                                    let sourceId = '';
                                    let targetId = '';
                                    
                                    // Tentar várias formas de obter o sourceId
                                    if (info.sourceId) {
                                        sourceId = info.sourceId;
                                    } else if (info.source && info.source.id) {
                                        sourceId = info.source.id;
                                    } else if (info.source && info.source.uuid) {
                                        sourceId = info.source.uuid;
                                    } else if (info.sourceEndpoint && info.sourceEndpoint.uuid) {
                                        sourceId = info.sourceEndpoint.uuid;
                                    }
                                    
                                    // Tentar várias formas de obter o targetId
                                    if (info.targetId) {
                                        targetId = info.targetId.replace('target-', '');
                                    } else if (info.target && info.target.id) {
                                        targetId = info.target.id.replace('flow-step-', '').replace('target-', '');
                                    } else if (info.target && info.target.uuid) {
                                        targetId = info.target.uuid.replace('target-', '');
                                    } else if (info.targetEndpoint && info.targetEndpoint.uuid) {
                                        targetId = info.targetEndpoint.uuid.replace('target-', '');
                                    }
                                    
                                    if (!sourceId || !targetId) {
                                        console.warn('⚠️ Não foi possível extrair sourceId ou targetId da conexão:', info);
                                        return;
                                    }
                                    
                                    // ✅ Verificar se a conexão vem de um endpoint de botão customizado
                                    // Formato: btn-endpoint-{stepId}-{btnIdx}
                                    if (sourceId.startsWith('btn-endpoint-')) {
                                        const parts = sourceId.split('-');
                                        if (parts.length >= 4) {
                                            const stepId = parts.slice(2, -1).join('-'); // Pode ter hífens no stepId
                                            const btnIdx = parseInt(parts[parts.length - 1]);
                                            
                                            if (!isNaN(btnIdx)) {
                                                const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                                if (sourceStep && sourceStep.config && sourceStep.config.custom_buttons) {
                                                    const button = sourceStep.config.custom_buttons[btnIdx];
                                                    if (button) {
                                                        // ✅ Atualizar target_step do botão customizado
                                                        button.target_step = targetId;
                                                        const targetStepName = this.config.flow_steps.find(s => s.id === targetId)?.name || targetId;
                                                        this.showNotification(`✅ Botão "${button.text || 'Botão ' + (btnIdx + 1)}" conectado para "${targetStepName}"`, 'success');
                                                        console.log(`✅ Botão customizado "${button.text}" do step ${stepId} conectado para step ${targetId}`);
                                                        return; // Não processar mais
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    // ✅ Conexão normal (não é botão customizado)
                                    const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                                    const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                                    if (sourceStep) {
                                        if (!sourceStep.connections) sourceStep.connections = {};
                                        // Por padrão, salvar como "next"
                                        sourceStep.connections.next = targetId;
                                        const targetStepName = this.config.flow_steps.find(s => s.id === targetId)?.name || targetId;
                                        this.showNotification(`✅ Conexão criada: ${sourceStep.name || sourceStepId} → ${targetStepName}`, 'success');
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao bind connection (pode ser normal):', e);
                        }
                        
                        // ✅ Redesenhar após mudanças
                        try {
                            if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                this.jsPlumbInstance.repaintEverything();
                            } else if (typeof this.jsPlumbInstance.repaint === 'function') {
                                this.jsPlumbInstance.repaint();
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao repaint (pode ser normal):', e);
                        }
                        
                        console.log('✅ Editor visual inicializado! Blocos criados:', steps.length);
                    } else {
                        // ✅ Verificar se chegou até aqui (significa que passou pela verificação mas não entrou no if)
                        console.error('❌ jsPlumb não carregado');
                        console.error('🔍 Debug completo:');
                        console.error('- typeof jsPlumb:', typeof jsPlumb);
                        console.error('- jsPlumb:', typeof jsPlumb !== 'undefined' ? jsPlumb : 'undefined');
                        console.error('- window.jsPlumb:', window.jsPlumb);
                        console.error('- window.jsPlumb?.jsPlumb:', window.jsPlumb?.jsPlumb);
                        console.error('- Variáveis window com "plumb":', Object.keys(window).filter(k => k.toLowerCase().includes('plumb')));
                        
                        // ✅ Tentar carregar manualmente se não encontrou
                        if (typeof window.jsPlumb === 'undefined' && typeof jsPlumb === 'undefined') {
                            console.warn('⚠️ Tentando carregar jsPlumb manualmente...');
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js';
                            script.onload = () => {
                                console.log('✅ jsPlumb carregado manualmente! Tentando novamente...');
                                setTimeout(() => this.initVisualFlowEditor(), 200);
                            };
                            script.onerror = () => {
                                console.error('❌ Falha ao carregar jsPlumb manualmente');
                                this.showNotification('❌ Erro: jsPlumb não pôde ser carregado. Verifique sua conexão.', 'error');
                            };
                            document.head.appendChild(script);
                            return; // Sair da função, vai tentar novamente quando carregar
                        }
                        
                        this.showNotification('❌ Erro: jsPlumb não carregou. Verifique o console para detalhes.', 'error');
                    }
            } catch (error) {
                console.error('❌ Erro ao inicializar editor visual:', error);
                console.error('Stack:', error.stack);
                this.showNotification('❌ Erro ao inicializar editor visual. Verifique o console.', 'error');
            }
            }, 300); // Aumentar delay para garantir DOM renderizado
        },
        
        loadStepPositions() {
            /** Carrega posições salvas dos steps do localStorage */
            try {
                const saved = localStorage.getItem(`flow_positions_${this.config.bot_id || 'default'}`);
                return saved ? JSON.parse(saved) : {};
            } catch {
                return {};
            }
        },
        
        saveStepPosition(stepId, x, y) {
            /** Salva posição do step no localStorage */
            try {
                const positions = this.loadStepPositions();
                positions[stepId] = { x, y };
                localStorage.setItem(`flow_positions_${this.config.bot_id || 'default'}`, JSON.stringify(positions));
            } catch (e) {
                console.error('Erro ao salvar posição:', e);
            }
        },
        
        updateStepConnectionsFromConnection(connection) {
            /** ✅ Atualiza connections do step baseado em uma conexão jsPlumb criada ou removida */
            try {
                if (!connection) return;
                
                // Extrair IDs da conexão
                let sourceId = '';
                let targetId = '';
                
                if (connection.sourceId) sourceId = connection.sourceId;
                else if (connection.source && connection.source.id) sourceId = connection.source.id;
                else if (connection.sourceEndpoint && connection.sourceEndpoint.uuid) sourceId = connection.sourceEndpoint.uuid;
                
                if (connection.targetId) targetId = connection.targetId;
                else if (connection.target && connection.target.id) targetId = connection.target.id;
                else if (connection.targetEndpoint && connection.targetEndpoint.uuid) targetId = connection.targetEndpoint.uuid;
                
                if (!sourceId || !targetId) {
                    console.warn('⚠️ Não foi possível extrair IDs da conexão:', connection);
                    return;
                }
                
                // Extrair stepId do target (sempre é o mesmo formato)
                const targetStepId = targetId.replace('target-', '').replace('flow-step-', '');
                
                // ✅ Verificar se é conexão de botão customizado
                if (sourceId.startsWith('btn-endpoint-')) {
                    const parts = sourceId.split('-');
                    if (parts.length >= 4) {
                        const stepId = parts.slice(2, -1).join('-');
                        const btnType = parts[parts.length - 2];
                        const btnIdx = parseInt(parts[parts.length - 1]);
                        
                        if (!isNaN(btnIdx)) {
                            const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                            if (sourceStep && sourceStep.config) {
                                if (btnType === 'custom' && sourceStep.config.custom_buttons) {
                                    const button = sourceStep.config.custom_buttons[btnIdx];
                                    if (button) {
                                        // ✅ Atualizar target_step do botão customizado
                                        button.target_step = targetStepId;
                                        console.log(`✅ Conexão atualizada: Botão "${button.text}" → Step ${targetStepId}`);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    // ✅ Conexão normal (não é botão customizado)
                    const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                    const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                    if (sourceStep) {
                        if (!sourceStep.connections) sourceStep.connections = {};
                        // Por padrão, salvar como "next"
                        sourceStep.connections.next = targetStepId;
                        console.log(`✅ Conexão atualizada: Step ${sourceStepId} → Step ${targetStepId}`);
                    }
                }
            } catch (e) {
                console.error('❌ Erro ao atualizar conexões:', e);
            }
        },
        
        getStepTitle(type) {
            const titles = {'content': 'Conteúdo', 'payment': 'Pagamento', 'message': 'Mensagem', 'audio': 'Áudio', 'video': 'Vídeo', 'buttons': 'Botões', 'access': 'Acesso'};
            return titles[type] || 'Desconhecido';
        },
        
        addFlowStep() {
            const stepId = `step_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const maxOrder = this.sortedFlowSteps.length > 0 ? Math.max(...this.sortedFlowSteps.map(s => s.order || 0)) : 0;
            const newOrder = maxOrder + 1;
            
            this.config.flow_steps.push({
                id: stepId,
                name: null,  // Nome será definido pelo usuário no modal
                type: 'content',
                order: newOrder,
                config: { message: '', media_url: '', media_type: 'video', buttons: [] },
                connections: {},
                delay_seconds: 0
            });
            
            // ✅ Auto-definir como inicial se:
            // 1. É o primeiro step (sem steps anteriores)
            // 2. Ou não há step inicial definido e este tem order=1
            if (!this.config.flow_start_step_id) {
                if (this.config.flow_steps.length === 1 || newOrder === 1) {
                    this.config.flow_start_step_id = stepId;
                    this.showNotification(`✅ Step adicionado e definido como inicial automaticamente!`, 'success');
                } else {
                    this.showNotification('✅ Step adicionado!', 'success');
                }
            } else {
                this.showNotification('✅ Step adicionado!', 'success');
            }
            
            setTimeout(() => {
                this.editFlowStep(stepId);
                // ✅ Recarregar editor visual (sempre visual agora)
                setTimeout(() => this.initVisualFlowEditor(), 200);
            }, 100);
        },
        
        editFlowStep(stepId) {
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) {
                this.showNotification('❌ Step não encontrado', 'error');
                return;
            }
            
            const stepJson = JSON.stringify(step).replace(/"/g, '&quot;');
            const availableStepsJson = JSON.stringify(this.config.flow_steps.filter(s => s.id !== stepId)).replace(/"/g, '&quot;');
            
            const stepTypes = [
                { value: 'content', label: '📸 Conteúdo', desc: 'Mensagem com mídia e botões' },
                { value: 'message', label: '💬 Mensagem', desc: 'Mensagem simples de texto' },
                { value: 'audio', label: '🎵 Áudio', desc: 'Enviar áudio' },
                { value: 'video', label: '🖼️ Mídia Foto/Video', desc: 'Enviar foto ou vídeo' },
                { value: 'buttons', label: '🔘 Botões', desc: 'Enviar botões cadastrados' },
                { value: 'access', label: '✅ Acesso', desc: 'Liberar acesso (fim do fluxo)' }
            ];
            
            const availableSteps = this.config.flow_steps.filter(s => s.id !== stepId);
            const stepOptions = availableSteps.map(s => {
                const stepLabel = s.name ? s.name : this.getStepTitle(s.type);
                return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
            }).join('');
            
            // ✅ Prevenir scroll no body quando modal abrir
            document.body.style.overflow = 'hidden';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.id = `flow-step-modal-${stepId}`;
            
            // ✅ Restaurar scroll quando modal fechar (click fora ou X)
            const restoreScroll = () => {
                document.body.style.overflow = '';
            };
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    restoreScroll();
                }
            });
            
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto border-2 border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white"><i class="fas fa-edit mr-2 text-blue-500"></i>Editar Step</h3>
                        <button onclick="document.body.style.overflow = ''; document.getElementById('flow-step-modal-${stepId}').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form onsubmit="event.preventDefault(); if(window.flowStepEditor['saveStep_${stepId}']) window.flowStepEditor['saveStep_${stepId}']();">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-tag mr-2 text-blue-400"></i>Nome do Step
                            </label>
                            <input type="text" id="step-name-${stepId}" value="${(step.name || '').replace(/"/g, '&quot;')}" 
                                   placeholder="Ex: Boas-vindas, Apresentação, Pagamento..."
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500"
                                   maxlength="50">
                            <p class="text-xs text-gray-500 mt-1">Nome para identificar este step no fluxo (opcional, mas recomendado)</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-cog mr-2 text-blue-400"></i>Tipo de Step
                                <i class="fas fa-question-circle ml-2 text-gray-500 text-xs cursor-help" 
                                   title="📸 Conteúdo: Envia mensagem com mídia (foto/vídeo) e botões\n💬 Mensagem: Envia texto e pode incluir botões\n🎵 Áudio: Envia áudio e pode incluir botões\n🖼️ Mídia Foto/Video: Envia foto/vídeo e pode incluir botões\n✅ Acesso: Libera acesso e finaliza o fluxo"></i>
                            </label>
                            <select id="step-type-${stepId}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                ${stepTypes.map(t => `<option value="${t.value}" ${step.type === t.value ? 'selected' : ''}>${t.label} - ${t.desc}</option>`).join('')}
                            </select>
                            <div class="mt-2 p-3 bg-blue-500 bg-opacity-25 border border-blue-500 rounded-lg text-xs text-blue-200" id="step-type-help-${stepId}">
                                ${(() => {
                                    const helps = {
                                        'content': '📸 <strong>Conteúdo:</strong> Ideal para apresentação. Envia mensagem com foto/vídeo e botões.',
                                        'message': '💬 <strong>Mensagem:</strong> Envia texto e botões. Quando o lead responder, você pode configurar um step de verificação para processar a resposta.',
                                        'audio': '🎵 <strong>Áudio:</strong> Envia áudio do Telegram e pode incluir botões. Ideal para criar conexão pessoal.',
                                        'video': '🖼️ <strong>Mídia Foto/Video:</strong> Envia foto ou vídeo do Telegram e pode incluir botões. Perfeito para explicações detalhadas.',
                                        'access': '✅ <strong>Acesso:</strong> Libera acesso final e <strong>encerra o fluxo</strong>. Não deve ter conexões.'
                                    };
                                    return helps[step.type] || 'Selecione um tipo de step';
                                })()}
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Ordem</label>
                            <input type="number" id="step-order-${stepId}" value="${step.order || 0}" min="1" 
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white"
                                   oninput="document.getElementById('order-warning-${stepId}').style.display = (this.value == 1) ? 'block' : 'none'">
                            <!-- Aviso quando ordem = 1 -->
                            <div id="order-warning-${stepId}" 
                                 style="display: ${(step.order || 0) == 1 ? 'block' : 'none'}"
                                 class="mt-2 p-3 bg-yellow-500 bg-opacity-10 border border-yellow-500 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-star text-yellow-400 text-sm mt-0.5"></i>
                                    <div class="text-xs text-yellow-300">
                                        <strong>⭐ Step Inicial do Funil</strong>
                                        <br>
                                        <span class="text-yellow-400">Este step será o primeiro a ser executado quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Delay (segundos)</label>
                            <input type="number" id="step-delay-${stepId}" value="${step.delay_seconds || 0}" min="0" step="0.1"
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div class="mb-4" id="config-content-${stepId}">
                            ${(step.type === 'content' || step.type === 'message') ? 
                                '<label class="block text-sm font-medium text-gray-300 mb-2">Mensagem</label>' +
                                '<textarea id="step-message-' + stepId + '" rows="4" ' +
                                'class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                                (step.config && step.config.message ? String(step.config.message).replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '') +
                                '</textarea>' : ''}
                            ${(step.type === 'content' || step.type === 'video') ? 
                                '<label class="block text-sm font-medium text-gray-300 mb-2 mt-4">URL da Mídia</label>' +
                                '<input type="url" id="step-media-url-' + stepId + '" value="' +
                                (step.config && step.config.media_url ? String(step.config.media_url).replace(/"/g, '&quot;') : '') +
                                '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' : ''}
                            ${step.type === 'access' ? 
                                '<label class="block text-sm font-medium text-gray-300 mb-2">Link de Acesso (opcional)</label>' +
                                '<input type="url" id="step-link-' + stepId + '" value="' +
                                (step.config && step.config.link ? String(step.config.link).replace(/"/g, '&quot;') : '') +
                                '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' : ''}
                            ${(step.type !== 'access') ? (() => {
                                const self = this;
                                function escapeHtml(text) {
                                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                                    return String(text).replace(/[&<>"']/g, m => map[m]);
                                }
                                let html = '';
                                
                                // Botões principais (main_buttons)
                                if (self.config.main_buttons && self.config.main_buttons.length > 0) {
                                    html += '<div class="mb-4"><div class="text-xs font-bold text-blue-400 mb-2">💰 Botões de Pagamento</div>';
                                    self.config.main_buttons.forEach((button, index) => {
                                        const selected = (step.config && step.config.selected_buttons) ? 
                                            step.config.selected_buttons.some(b => b.type === 'main' && b.index === index) : false;
                                        const buttonText = button.text || 'Botão ' + (index + 1);
                                        const buttonPrice = button.price ? 'R$ ' + parseFloat(button.price).toFixed(2) : 'Sem preço';
                                        html += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-blue-500 transition-all mb-2">' +
                                            '<input type="checkbox" ' +
                                            'id="button-main-' + index + '-' + stepId + '" ' +
                                            (selected ? 'checked' : '') +
                                            ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-blue-500">' +
                                            '<div class="flex-1">' +
                                            '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                            '<div class="text-xs text-gray-400">' + escapeHtml(buttonPrice) + '</div>' +
                                            '</div>' +
                                            '</label>';
                                    });
                                    html += '</div>';
                                }
                                
                                // Botões de redirecionamento (redirect_buttons)
                                if (self.config.redirect_buttons && self.config.redirect_buttons.length > 0) {
                                    html += '<div><div class="text-xs font-bold text-green-400 mb-2">🔗 Botões de Link</div>';
                                    self.config.redirect_buttons.forEach((button, index) => {
                                        const selected = (step.config && step.config.selected_buttons) ? 
                                            step.config.selected_buttons.some(b => b.type === 'redirect' && b.index === index) : false;
                                        const buttonText = button.text || 'Link ' + (index + 1);
                                        const buttonUrl = button.url || 'Sem URL';
                                        html += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-green-500 transition-all mb-2">' +
                                            '<input type="checkbox" ' +
                                            'id="button-redirect-' + index + '-' + stepId + '" ' +
                                            (selected ? 'checked' : '') +
                                            ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-green-500">' +
                                            '<div class="flex-1">' +
                                            '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                            '<div class="text-xs text-gray-400 font-mono truncate">' + escapeHtml(buttonUrl) + '</div>' +
                                            '</div>' +
                                            '</label>';
                                    });
                                    html += '</div>';
                                }
                                
                                if (!html) {
                                    html = '<div class="text-center py-4 text-gray-500 text-sm">⚠️ Nenhum botão cadastrado na aba "Botões". <br><span class="text-xs">Adicione botões antes de usar este step.</span></div>';
                                }
                                
                                // ✅ Para TODOS os tipos (exceto access), mostrar ambas as opções: botões cadastrados E customizados
                                const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
                                const stepOptionsForBtn = availableSteps.map(s => {
                                    const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                    return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
                                }).join('');
                                
                                const customButtons = (step.config && step.config.custom_buttons) || [];
                                let customButtonsHtml = '';
                                if (customButtons.length === 0) {
                                    customButtonsHtml = '<div class="text-xs text-blue-300 italic text-center py-2">Nenhum botão adicionado. Clique em "Adicionar Botão" para criar um.</div>';
                                } else {
                                    customButtonsHtml = customButtons.map((btn, idx) => {
                                        // Construir options com selected correto
                                        const stepOptionsWithSelected = availableSteps.map(s => {
                                            const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                            const selected = (btn.target_step === s.id) ? ' selected' : '';
                                            return `<option value="${s.id}"${selected}>${s.order || 0} - ${stepLabel}</option>`;
                                        }).join('');
                                        
                                        return `
                                            <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-blue-600 mb-2">
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                                    <div class="md:col-span-2">
                                                        <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Botão</label>
                                                        <input type="text" 
                                                               name="custom-btn-text-${stepId}-${idx}" 
                                                               value="${escapeHtml(btn.text || '')}"
                                                               placeholder="Ex: Sim, quero!"
                                                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                                               maxlength="64">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-300 mb-1">🔗 Ir para Step</label>
                                                        <select name="custom-btn-target-${stepId}-${idx}" 
                                                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                                            <option value="">Nenhum</option>${stepOptionsWithSelected}
                                                        </select>
                                                    </div>
                                                </div>
                                                <button type="button" 
                                                        onclick="window.removeCustomButton('${stepId}', ${idx})"
                                                        class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                                                    <i class="fas fa-times mr-1"></i>Remover
                                                </button>
                                            </div>
                                        `;
                                    }).join('');
                                }
                                
                                return '<div class="mt-4 space-y-4">' +
                                    // ✅ Seção 1: Botões Cadastrados
                                    '<div class="p-4 bg-gray-800 rounded-lg border border-gray-700">' +
                                    '<label class="block text-sm font-bold text-gray-300 mb-3">' +
                                    '<i class="fas fa-list mr-2"></i>Botões Cadastrados (da aba "Botões")' +
                                    '</label>' +
                                    '<p class="text-xs text-gray-400 mb-3">Selecione botões já cadastrados na aba "Botões" para usar neste step.</p>' +
                                    '<div class="space-y-3 max-h-64 overflow-y-auto">' +
                                    html +
                                    '</div>' +
                                    '</div>' +
                                    // ✅ Seção 2: Botões Customizados
                                    '<div class="p-4 bg-blue-900 bg-opacity-30 border-2 border-blue-500 rounded-lg">' +
                                    '<label class="block text-sm font-bold text-blue-200 mb-3">' +
                                    '<i class="fas fa-toggle-on mr-2"></i>Botões Customizados (Cada botão pode levar a um step diferente)' +
                                    '</label>' +
                                    '<p class="text-xs text-blue-100 mb-3">Adicione botões personalizados. Cada botão pode levar o lead para um step diferente do fluxo. Conecte visualmente no editor de fluxo.</p>' +
                                    '<div id="custom-buttons-list-' + stepId + '" class="space-y-2 mb-3">' +
                                    customButtonsHtml +
                                    '</div>' +
                                    '<button type="button" ' +
                                    'onclick="window.addCustomButton(\'' + stepId + '\')"' +
                                    'class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">' +
                                    '<i class="fas fa-plus mr-2"></i>Adicionar Botão Customizado' +
                                    '</button>' +
                                    '</div>' +
                                    '</div>';
                            })() : ''}
                        </div>
                        ${step.type === 'message' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg border border-yellow-700">
                                <label class="block text-sm font-medium text-yellow-300 mb-2">
                                    <i class="fas fa-redo mr-2"></i>Quando lead enviar mensagem → Ir para Step:
                                </label>
                                <select id="step-retry-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white mb-2">
                                    <option value="">Nenhum (fluxo para aqui)</option>${stepOptions}
                                </select>
                                <div class="mt-2 p-2 bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded text-xs text-yellow-200">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>Como funciona:</strong> Após enviar esta mensagem, quando o lead responder com <strong>qualquer texto</strong>, o fluxo automaticamente irá para o step selecionado acima. 
                                    <br><span class="text-yellow-300 mt-1 block">💡 Útil para: verificar mensagens, processar respostas, criar loops de validação.</span>
                                </div>
                            </div>
                        ` : step.type === 'buttons' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg border border-purple-700">
                                <label class="block text-sm font-medium text-purple-300 mb-3">
                                    <i class="fas fa-toggle-on mr-2"></i>Tipo de Botões
                                </label>
                                <div class="mb-4">
                                    <label class="flex items-center gap-2 mb-2">
                                        <input type="radio" 
                                               name="button-type-${stepId}" 
                                               value="global" 
                                               ${(!step.config || !step.config.use_custom_buttons) ? 'checked' : ''}
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               onchange="document.getElementById('button-global-${stepId}').style.display = 'block'; document.getElementById('button-custom-${stepId}').style.display = 'none';"
                                               style="accent-color: #A855F7;">
                                        <span class="text-white">🌐 Botões Globais (da aba "Botões")</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" 
                                               name="button-type-${stepId}" 
                                               value="custom" 
                                               ${(step.config && step.config.use_custom_buttons) ? 'checked' : ''}
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               onchange="document.getElementById('button-global-${stepId}').style.display = 'none'; document.getElementById('button-custom-${stepId}').style.display = 'block';"
                                               style="accent-color: #A855F7;">
                                        <span class="text-white">✨ Botões Contextuais (específicos deste step)</span>
                                    </label>
                                </div>
                                
                                <!-- Botões Globais -->
                                <div id="button-global-${stepId}" style="display: ${(step.config && step.config.use_custom_buttons) ? 'none' : 'block'};">
                                    <p class="text-xs text-gray-400 mb-2">Selecione os botões cadastrados na aba "Botões":</p>
                                </div>
                                
                                <!-- Botões Contextuais -->
                                <div id="button-custom-${stepId}" style="display: ${(step.config && step.config.use_custom_buttons) ? 'block' : 'none'};">
                                    <div class="mb-3">
                                        <label class="block text-xs font-medium text-gray-300 mb-2">
                                            <i class="fas fa-plus-circle mr-1 text-purple-400"></i>Botões Contextuais
                                        </label>
                                        <div id="custom-buttons-list-${stepId}" class="space-y-2 mb-3">
                                            ${(() => {
                                                const customButtons = (step.config && step.config.custom_buttons) || [];
                                                if (customButtons.length === 0) {
                                                    return '<div class="text-xs text-gray-500 italic">Nenhum botão contextual adicionado. Clique em "Adicionar Botão Contextual" para criar um.</div>';
                                                }
                                                const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
                                                const stepOptions = availableSteps.map(s => {
                                                    const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                                    return `<option value="${s.id}" ${btn.target_step === s.id ? 'selected' : ''}>${s.order || 0} - ${stepLabel}</option>`;
                                                }).join('');
                                                return customButtons.map((btn, idx) => `
                                                    <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-purple-600 mb-2">
                                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                                            <div class="md:col-span-2">
                                                                <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Botão</label>
                                                                <input type="text" 
                                                                       name="custom-btn-text-${stepId}-${idx}" 
                                                                       value="${escapeHtml(btn.text || '')}"
                                                                       placeholder="Ex: Sim, quero!"
                                                                       class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                                                       maxlength="64">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-gray-300 mb-1">Ir para Step</label>
                                                                <select name="custom-btn-target-${stepId}-${idx}" 
                                                                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                                                    <option value="">Nenhum</option>${stepOptions}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <button type="button" 
                                                                onclick="window.removeCustomButton('${stepId}', ${idx})"
                                                                class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                                                            <i class="fas fa-times mr-1"></i>Remover
                                                        </button>
                                                    </div>
                                                `).join('');
                                            })()}
                                        </div>
                                        <button type="button" 
                                                onclick="window.addCustomButton('${stepId}')"
                                                class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-medium transition">
                                            <i class="fas fa-plus mr-2"></i>Adicionar Botão Contextual
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Próximo Step (só para botões globais) -->
                                <div id="step-next-global-${stepId}" style="display: ${(step.config && step.config.use_custom_buttons) ? 'none' : 'block'};" class="mt-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Próximo → Step:</label>
                                    <select id="step-next-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                        <option value="">Nenhum</option>${stepOptions}
                                    </select>
                                </div>
                            </div>
                        ` : step.type === 'content' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-arrow-right mr-2"></i>Próximo → Step (opcional):
                                </label>
                                <select id="step-next-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                    <option value="">Nenhum (botões customizados já têm destino)</option>${stepOptions}
                                </select>
                                <p class="text-xs text-gray-400 mt-2">
                                    💡 Se nenhum botão for clicado, o fluxo seguirá para este step. Se deixar vazio, o fluxo para aqui se nenhum botão for clicado.
                                </p>
                            </div>
                        ` : step.type !== 'access' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Próximo → Step:</label>
                                <select id="step-next-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                    <option value="">Nenhum</option>${stepOptions}
                                </select>
                            </div>
                        ` : ''}
                        
                        <!-- ✅ SISTEMA DE CONDIÇÕES (para todos os steps exceto 'access') -->
                        ${step.type !== 'access' ? `
                            <div class="mb-4 p-4 bg-blue-900 bg-opacity-30 border-2 border-blue-500 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-bold text-blue-200">
                                        <i class="fas fa-code-branch mr-2"></i>Condições (Decisões do Lead)
                                    </label>
                                    <button type="button" 
                                            onclick="addCondition('${stepId}')"
                                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-medium transition">
                                        <i class="fas fa-plus mr-1"></i>Adicionar
                                    </button>
                                </div>
                                <p class="text-xs text-blue-100 mb-3">
                                    Configure condições para que o lead tome decisões e siga caminhos diferentes no funil.
                                    <br><span class="text-blue-200 font-medium">💡 Exemplo: Se email válido → Step A, Se inválido → Step B</span>
                                </p>
                                <div id="conditions-list-${stepId}" class="space-y-2">
                                    ${(() => {
                                        const conditions = (step.conditions && step.conditions.length > 0) ? step.conditions : [];
                                        if (conditions.length === 0) {
                                            return '<div class="text-xs text-blue-300 italic text-center py-2">Nenhuma condição configurada. Adicione condições para criar fluxos condicionais.</div>';
                                        }
                                        const self = this;
                                        function escapeHtml(text) {
                                            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                                            return String(text).replace(/[&<>"']/g, m => map[m]);
                                        }
                                        return conditions.map((cond, idx) => {
                                            // Gerar label da condição inline (não depender de função externa)
                                            let condLabel = 'Condição';
                                            if (cond.type === 'text_validation') {
                                                const validation = cond.validation || 'any';
                                                const labels = {
                                                    'email': 'Se email válido',
                                                    'phone': 'Se telefone válido',
                                                    'cpf': 'Se CPF válido',
                                                    'contains': `Se texto contém "${cond.value || ''}"`,
                                                    'equals': `Se texto igual a "${cond.value || ''}"`,
                                                    'any': 'Se qualquer texto'
                                                };
                                                condLabel = labels[validation] || 'Se texto válido';
                                            } else if (cond.type === 'button_click') {
                                                condLabel = `Se botão "${cond.button_text || ''}" clicado`;
                                            } else if (cond.type === 'payment_status') {
                                                const status = cond.status || 'paid';
                                                const labels = {
                                                    'paid': 'Se pagamento confirmado',
                                                    'pending': 'Se pagamento pendente',
                                                    'failed': 'Se pagamento falhou',
                                                    'expired': 'Se pagamento expirado'
                                                };
                                                condLabel = labels[status] || 'Se status de pagamento';
                                            } else if (cond.type === 'time_elapsed') {
                                                condLabel = `Se ${cond.minutes || 5} minuto(s) decorrido(s)`;
                                            }
                                            
                                            const targetStepName = self.config.flow_steps.find(s => s.id === cond.target_step)?.name || 
                                                                   self.getStepTitle(self.config.flow_steps.find(s => s.id === cond.target_step)?.type) || 
                                                                   cond.target_step.substring(0, 12);
                                            return `
                                                <div data-condition class="p-3 bg-gray-900 rounded-lg border border-blue-600">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="px-2 py-0.5 bg-blue-600 text-white rounded text-xs font-bold">${idx + 1}</span>
                                                                <span class="text-sm font-semibold text-blue-200">${escapeHtml(condLabel)}</span>
                                                            </div>
                                                            <div class="text-xs text-blue-300">
                                                                → <span class="text-blue-200 font-bold">${escapeHtml(targetStepName)}</span>
                                                            </div>
                                                            ${cond.max_attempts && cond.max_attempts > 0 ? `
                                                                <div class="text-xs text-yellow-400 mt-1 flex items-center gap-1">
                                                                    <i class="fas fa-exclamation-triangle"></i>
                                                                    <span>Máximo: ${cond.max_attempts} tentativa(s)</span>
                                                                </div>
                                                            ` : ''}
                                                            ${cond.fallback_step ? `
                                                                <div class="text-xs text-purple-400 mt-1 flex items-center gap-1">
                                                                    <i class="fas fa-undo"></i>
                                                                    <span>Fallback: ${self.config.flow_steps.find(s => s.id === cond.fallback_step)?.name || cond.fallback_step.substring(0, 12)}</span>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                        <button type="button" 
                                                                onclick="removeCondition('${stepId}', ${idx})"
                                                                class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <button type="button" 
                                                            onclick="editCondition('${stepId}', ${idx})"
                                                            class="w-full mt-2 px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs">
                                                        <i class="fas fa-edit mr-1"></i>Editar
                                                    </button>
                                                </div>
                                            `;
                                        }).join('');
                                    })()}
                                </div>
                            </div>
                        ` : ''}
                        <!-- ✅ MENSAGEM DE ERRO PERSONALIZADA (para steps com condições) -->
                        ${step.type !== 'access' && step.conditions && step.conditions.length > 0 ? `
                            <div class="mb-4 p-4 bg-orange-900 bg-opacity-20 border border-orange-500 rounded-lg">
                                <label class="block text-sm font-medium text-orange-300 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Mensagem de Erro (opcional)
                                </label>
                                <input type="text" 
                                       id="step-error-message-${stepId}" 
                                       value="${(step.config && step.config.error_message ? step.config.error_message : '⚠️ Resposta não reconhecida. Por favor, tente novamente.').replace(/"/g, '&quot;')}" 
                                       placeholder="⚠️ Resposta não reconhecida. Por favor, tente novamente."
                                       class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500"
                                       maxlength="200">
                                <p class="text-xs text-orange-200 mt-1">
                                    Mensagem enviada quando nenhuma condição matchar. Deixe vazio para usar mensagem padrão.
                                </p>
                            </div>
                        ` : ''}
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" onclick="document.body.style.overflow = ''; document.getElementById('flow-step-modal-${stepId}').remove()" 
                                    class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancelar</button>
                            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                <i class="fas fa-save mr-2"></i>Salvar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Inicializar editor (bind this)
            const self = this;
            if (!window.flowStepEditor) {
                window.flowStepEditor = {};
            }
            
            // ✅ Função para atualizar conteúdo do modal baseado no tipo selecionado
            function updateConfigContent(stepId, stepType, currentStep) {
                const configDiv = document.getElementById(`config-content-${stepId}`);
                if (!configDiv) return;
                
                function escapeHtml(text) {
                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                    return String(text).replace(/[&<>"']/g, m => map[m]);
                }
                
                let html = '';
                
                if (stepType === 'content' || stepType === 'message') {
                    html += '<label class="block text-sm font-medium text-gray-300 mb-2">Mensagem</label>' +
                        '<textarea id="step-message-' + stepId + '" rows="4" ' +
                        'class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                        escapeHtml((currentStep.config && currentStep.config.message) || '') +
                        '</textarea>';
                }
                
                if (stepType === 'content' || stepType === 'video') {
                    html += '<label class="block text-sm font-medium text-gray-300 mb-2 mt-4">URL da Mídia</label>' +
                        '<input type="url" id="step-media-url-' + stepId + '" value="' +
                        escapeHtml((currentStep.config && currentStep.config.media_url) || '') +
                        '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">';
                }
                
                if (stepType === 'access') {
                    html += '<label class="block text-sm font-medium text-gray-300 mb-2">Link de Acesso (opcional)</label>' +
                        '<input type="url" id="step-link-' + stepId + '" value="' +
                        escapeHtml((currentStep.config && currentStep.config.link) || '') +
                        '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">';
                }
                
                // ✅ Para TODOS os tipos (exceto access), construir seção de botões
                if (stepType !== 'access') {
                    let buttonsHtml = '';
                    
                    // Botões principais (main_buttons)
                    if (self.config.main_buttons && self.config.main_buttons.length > 0) {
                        buttonsHtml += '<div class="mb-4"><div class="text-xs font-bold text-blue-400 mb-2">💰 Botões de Pagamento</div>';
                        self.config.main_buttons.forEach((button, index) => {
                            const selected = (currentStep.config && currentStep.config.selected_buttons) ? 
                                currentStep.config.selected_buttons.some(b => b.type === 'main' && b.index === index) : false;
                            const buttonText = button.text || 'Botão ' + (index + 1);
                            const buttonPrice = button.price ? 'R$ ' + parseFloat(button.price).toFixed(2) : 'Sem preço';
                            buttonsHtml += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-blue-500 transition-all mb-2">' +
                                '<input type="checkbox" ' +
                                'id="button-main-' + index + '-' + stepId + '" ' +
                                (selected ? 'checked' : '') +
                                ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-blue-500">' +
                                '<div class="flex-1">' +
                                '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                '<div class="text-xs text-gray-400">' + escapeHtml(buttonPrice) + '</div>' +
                                '</div>' +
                                '</label>';
                        });
                        buttonsHtml += '</div>';
                    }
                    
                    // Botões de redirecionamento (redirect_buttons)
                    if (self.config.redirect_buttons && self.config.redirect_buttons.length > 0) {
                        buttonsHtml += '<div><div class="text-xs font-bold text-green-400 mb-2">🔗 Botões de Link</div>';
                        self.config.redirect_buttons.forEach((button, index) => {
                            const selected = (currentStep.config && currentStep.config.selected_buttons) ? 
                                currentStep.config.selected_buttons.some(b => b.type === 'redirect' && b.index === index) : false;
                            const buttonText = button.text || 'Link ' + (index + 1);
                            const buttonUrl = button.url || 'Sem URL';
                            buttonsHtml += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-green-500 transition-all mb-2">' +
                                '<input type="checkbox" ' +
                                'id="button-redirect-' + index + '-' + stepId + '" ' +
                                (selected ? 'checked' : '') +
                                ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-green-500">' +
                                '<div class="flex-1">' +
                                '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                '<div class="text-xs text-gray-400 font-mono truncate">' + escapeHtml(buttonUrl) + '</div>' +
                                '</div>' +
                                '</label>';
                        });
                        buttonsHtml += '</div>';
                    }
                    
                    if (!buttonsHtml) {
                        buttonsHtml = '<div class="text-center py-4 text-gray-500 text-sm">⚠️ Nenhum botão cadastrado na aba "Botões". <br><span class="text-xs">Adicione botões antes de usar este step.</span></div>';
                    }
                    
                    // ✅ Para TODOS os tipos (exceto access), adicionar seção de botões
                    if (stepType !== 'access') {
                        const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
                        const stepOptionsForBtn = availableSteps.map(s => {
                            const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                            return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
                        }).join('');
                        
                        const customButtons = (currentStep.config && currentStep.config.custom_buttons) || [];
                        let customButtonsHtml = '';
                        if (customButtons.length === 0) {
                            customButtonsHtml = '<div class="text-xs text-blue-300 italic text-center py-2">Nenhum botão adicionado. Clique em "Adicionar Botão" para criar um.</div>';
                        } else {
                            customButtonsHtml = customButtons.map((btn, idx) => {
                                // Construir options com selected correto
                                const stepOptionsWithSelected = availableSteps.map(s => {
                                    const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                    const selected = (btn.target_step === s.id) ? ' selected' : '';
                                    return `<option value="${s.id}"${selected}>${s.order || 0} - ${stepLabel}</option>`;
                                }).join('');
                                
                                return `
                                    <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-blue-600 mb-2">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                            <div class="md:col-span-2">
                                                <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Botão</label>
                                                <input type="text" 
                                                       name="custom-btn-text-${stepId}-${idx}" 
                                                       value="${escapeHtml(btn.text || '')}"
                                                       placeholder="Ex: Sim, quero!"
                                                       class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                                       maxlength="64">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-300 mb-1">🔗 Ir para Step</label>
                                                <select name="custom-btn-target-${stepId}-${idx}" 
                                                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                                    <option value="">Nenhum</option>${stepOptionsWithSelected}
                                                </select>
                                            </div>
                                        </div>
                                        <button type="button" 
                                                onclick="window.removeCustomButton('${stepId}', ${idx})"
                                                class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                                            <i class="fas fa-times mr-1"></i>Remover
                                        </button>
                                    </div>
                                `;
                            }).join('');
                        }
                        
                        html += '<div class="mt-4 space-y-4">' +
                            // ✅ Seção 1: Botões Cadastrados
                            '<div class="p-4 bg-gray-800 rounded-lg border border-gray-700">' +
                            '<label class="block text-sm font-bold text-gray-300 mb-3">' +
                            '<i class="fas fa-list mr-2"></i>Botões Cadastrados (da aba "Botões")' +
                            '</label>' +
                            '<p class="text-xs text-gray-400 mb-3">Selecione botões já cadastrados na aba "Botões" para usar neste step.</p>' +
                            '<div class="space-y-3 max-h-64 overflow-y-auto">' +
                            buttonsHtml +
                            '</div>' +
                            '</div>' +
                            // ✅ Seção 2: Botões Customizados
                            '<div class="p-4 bg-blue-900 bg-opacity-30 border-2 border-blue-500 rounded-lg">' +
                            '<label class="block text-sm font-bold text-blue-200 mb-3">' +
                            '<i class="fas fa-toggle-on mr-2"></i>Botões Customizados (Cada botão pode levar a um step diferente)' +
                            '</label>' +
                            '<p class="text-xs text-blue-100 mb-3">Adicione botões personalizados. Cada botão pode levar o lead para um step diferente do fluxo. Conecte visualmente no editor de fluxo.</p>' +
                            '<div id="custom-buttons-list-' + stepId + '" class="space-y-2 mb-3">' +
                            customButtonsHtml +
                            '</div>' +
                            '<button type="button" ' +
                            'onclick="window.addCustomButton(\'' + stepId + '\')"' +
                            'class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">' +
                            '<i class="fas fa-plus mr-2"></i>Adicionar Botão Customizado' +
                            '</button>' +
                            '</div>' +
                            '</div>';
                    }
                }
                
                configDiv.innerHTML = html;
                
                // Atualizar conexões também
                const form = configDiv.closest('form');
                if (form) {
                    const stepOptions = self.config.flow_steps
                        .filter(s => s.id !== stepId)
                        .map(s => {
                            const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                            return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
                        })
                        .join('');
                    
                    // Remover conexões existentes
                    const existingConnections = form.querySelectorAll('[id*="step-next"], [id*="step-pending"], [id*="step-retry"]');
                    existingConnections.forEach(el => {
                        const container = el.closest('.mb-4.p-4.bg-gray-800');
                        if (container) container.remove();
                    });
                    
                    // Adicionar conexões baseado no tipo
                    let connectionsHtml = '';
                    if (stepType === 'message') {
                        const retryVal = (currentStep.connections && currentStep.connections.retry) || '';
                        connectionsHtml = '<div class="mb-4 p-4 bg-gray-800 rounded-lg border border-yellow-700">' +
                            '<label class="block text-sm font-medium text-yellow-300 mb-2">' +
                            '<i class="fas fa-redo mr-2"></i>Quando lead enviar mensagem → Ir para Step:' +
                            '</label>' +
                            '<select id="step-retry-' + stepId + '" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white mb-2">' +
                            '<option value="">Nenhum (fluxo para aqui)</option>' + stepOptions +
                            '</select>' +
                            '<div class="mt-2 p-2 bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded text-xs text-yellow-200">' +
                            '<i class="fas fa-info-circle mr-1"></i>' +
                            '<strong>Como funciona:</strong> Após enviar esta mensagem, quando o lead responder com <strong>qualquer texto</strong>, o fluxo automaticamente irá para o step selecionado acima. ' +
                            '<br><span class="text-yellow-300 mt-1 block">💡 Útil para: verificar mensagens, processar respostas, criar loops de validação.</span>' +
                            '</div>' +
                            '</div>';
                        setTimeout(() => {
                            const retrySelect = document.getElementById(`step-retry-${stepId}`);
                            if (retrySelect && retryVal) retrySelect.value = retryVal;
                        }, 10);
                    } else if (stepType === 'content') {
                        const nextVal = (currentStep.connections && currentStep.connections.next) || '';
                        connectionsHtml = '<div class="mb-4 p-4 bg-gray-800 rounded-lg border border-gray-600">' +
                            '<label class="block text-sm font-medium text-gray-300 mb-2">' +
                            '<i class="fas fa-arrow-right mr-2"></i>Próximo → Step (opcional):' +
                            '</label>' +
                            '<select id="step-next-' + stepId + '" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                            '<option value="">Nenhum (botões customizados já têm destino)</option>' + stepOptions +
                            '</select>' +
                            '<p class="text-xs text-gray-400 mt-2">' +
                            '💡 Se nenhum botão for clicado, o fluxo seguirá para este step. Se deixar vazio, o fluxo para aqui se nenhum botão for clicado.' +
                            '</p>' +
                            '</div>';
                        setTimeout(() => {
                            const nextSelect = document.getElementById(`step-next-${stepId}`);
                            if (nextSelect && nextVal) nextSelect.value = nextVal;
                        }, 10);
                    } else if (stepType !== 'access' && stepType !== 'payment' && stepType !== 'message' && stepType !== 'content') {
                        const nextVal = (currentStep.connections && currentStep.connections.next) || '';
                        connectionsHtml = '<div class="mb-4 p-4 bg-gray-800 rounded-lg">' +
                            '<label class="block text-sm font-medium text-gray-300 mb-2">Próximo → Step:</label>' +
                            '<select id="step-next-' + stepId + '" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                            '<option value="">Nenhum</option>' + stepOptions +
                            '</select>' +
                            '</div>';
                        setTimeout(() => {
                            const nextSelect = document.getElementById(`step-next-${stepId}`);
                            if (nextSelect && nextVal) nextSelect.value = nextVal;
                        }, 10);
                    }
                    
                    if (connectionsHtml) {
                        const buttonsContainer = form.querySelector('.flex.justify-end.gap-3.mt-6');
                        if (buttonsContainer) {
                            buttonsContainer.insertAdjacentHTML('beforebegin', connectionsHtml);
                        } else {
                            configDiv.insertAdjacentHTML('afterend', connectionsHtml);
                        }
                    }
                }
            }
            
            // ✅ Event listener para atualizar conteúdo quando o tipo muda
            const typeSelect = document.getElementById(`step-type-${stepId}`);
            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    const stepIndex = self.config.flow_steps.findIndex(s => s.id === stepId);
                    if (stepIndex === -1) return;
                    const currentStep = self.config.flow_steps[stepIndex];
                    
                    // Atualizar help explicativo
                    const helpDiv = document.getElementById(`step-type-help-${stepId}`);
                    if (helpDiv) {
                        const helps = {
                            'content': '📸 <strong>Conteúdo:</strong> Ideal para apresentação. Envia mensagem com foto/vídeo e botões.',
                            'message': '💬 <strong>Mensagem:</strong> Envia texto e botões. Quando o lead responder, você pode configurar um step de verificação para processar a resposta.',
                            'audio': '🎵 <strong>Áudio:</strong> Envia áudio do Telegram e pode incluir botões. Ideal para criar conexão pessoal.',
                            'video': '🖼️ <strong>Mídia Foto/Video:</strong> Envia foto ou vídeo do Telegram e pode incluir botões. Perfeito para explicações detalhadas.',
                            'access': '✅ <strong>Acesso:</strong> Libera acesso final e <strong>encerra o fluxo</strong>. Não deve ter conexões.'
                        };
                        helpDiv.innerHTML = helps[this.value] || 'Selecione um tipo de step';
                    }
                    
                    updateConfigContent(stepId, this.value, currentStep);
                });
            }
            window.flowStepEditor['saveStep_' + stepId] = function() {
                const stepIndex = self.config.flow_steps.findIndex(s => s.id === stepId);
                if (stepIndex === -1) return;
                
                const step = self.config.flow_steps[stepIndex];
                step.name = (document.getElementById(`step-name-${stepId}`)?.value || '').trim() || null;
                step.type = document.getElementById(`step-type-${stepId}`).value;
                step.order = parseInt(document.getElementById(`step-order-${stepId}`).value) || 1;
                step.delay_seconds = parseFloat(document.getElementById(`step-delay-${stepId}`).value) || 0;
                
                // ✅ VALIDAÇÕES DE UX
                let warnings = [];
                
                if (step.type === 'content' || step.type === 'message') {
                    step.config.message = document.getElementById(`step-message-${stepId}`)?.value || '';
                    if (!step.config.message || step.config.message.trim() === '') {
                        warnings.push('⚠️ Mensagem vazia - este step não enviará nenhum texto ao lead');
                    }
                }
                
                // Validar conexões faltantes (exceto 'access')
                if (step.type !== 'access') {
                    const nextSelect = document.getElementById(`step-next-${stepId}`);
                    const pendingSelect = document.getElementById(`step-pending-${stepId}`);
                    const retrySelect = document.getElementById(`step-retry-${stepId}`);
                    
                    const hasNext = nextSelect && nextSelect.value;
                    const hasPending = pendingSelect && pendingSelect.value;
                    const hasRetry = retrySelect && retrySelect.value;
                    
                    // ✅ Validar loops circulares (prevenir recursão infinita)
                    function checkCircularConnection(fromStepId, toStepId, visited = new Set(), depth = 0) {
                        if (depth > 20) return true; // Loop detectado (limite de segurança)
                        if (fromStepId === toStepId) return true; // Auto-referência direta
                        if (visited.has(toStepId)) return true; // Loop circular - voltou ao step já visitado
                        
                        visited.add(fromStepId);
                        const targetStep = self.config.flow_steps.find(s => s.id === toStepId);
                        if (!targetStep || !targetStep.connections) return false;
                        
                        // Se o step de destino conecta de volta ao step original, é um loop
                        if (targetStep.connections.next === fromStepId || 
                            targetStep.connections.pending === fromStepId || 
                            targetStep.connections.retry === fromStepId) {
                            return true;
                        }
                        
                        // Verificar conexões do step de destino recursivamente
                        if (targetStep.connections.next && checkCircularConnection(fromStepId, targetStep.connections.next, new Set(visited), depth + 1)) {
                            return true;
                        }
                        if (targetStep.connections.pending && checkCircularConnection(fromStepId, targetStep.connections.pending, new Set(visited), depth + 1)) {
                            return true;
                        }
                        if (targetStep.connections.retry && checkCircularConnection(fromStepId, targetStep.connections.retry, new Set(visited), depth + 1)) {
                            return true;
                        }
                        return false;
                    }
                    
                    if (hasNext && checkCircularConnection(stepId, hasNext)) {
                        warnings.push('⚠️ Loop circular detectado na conexão "Próximo"! Esta conexão pode causar recursão infinita. O fluxo pode ficar preso em loop.');
                    }
                    if (hasPending && checkCircularConnection(stepId, hasPending)) {
                        warnings.push('⚠️ Loop circular detectado na conexão "Se não pago"! Pode causar recursão infinita.');
                    }
                    if (hasRetry && checkCircularConnection(stepId, hasRetry)) {
                        warnings.push('⚠️ Loop circular detectado na conexão "Retry"! Pode causar recursão infinita.');
                    }
                    
                    if (step.type === 'message') {
                        // Message pode ter retry ou next
                        if (!hasRetry && !hasNext) {
                            warnings.push('⚠️ Step sem conexões - o fluxo pode parar aqui. Adicione uma conexão "Próximo" ou "Retry"');
                        }
                    } else if (!hasNext) {
                        warnings.push('⚠️ Step sem conexão "Próximo" - o fluxo pode parar aqui. Adicione uma conexão para continuar');
                    }
                }
                
                // Mostrar avisos (não bloquear, apenas alertar)
                if (warnings.length > 0) {
                    if (!confirm(warnings.join('\n') + '\n\nDeseja salvar mesmo assim?')) {
                        return; // Usuário cancelou
                    }
                }
                
                // ✅ Auto-numerar ordem sequencial após salvar (garantir sequência 1, 2, 3, 4...)
                const sortedSteps = [...self.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                sortedSteps.forEach((s, index) => {
                    const newOrder = index + 1;
                    if (s.order !== newOrder) {
                        s.order = newOrder;
                    }
                });
                
                if (step.type === 'content' || step.type === 'video') {
                    step.config.media_url = document.getElementById(`step-media-url-${stepId}`)?.value || '';
                    step.config.media_type = step.config.media_type || 'video';
                }
                if (step.type === 'access') {
                    step.config.link = document.getElementById(`step-link-${stepId}`)?.value || '';
                    step.config.message = step.config.message || 'Acesso liberado!';
                }
                // ✅ Para TODOS os tipos (exceto access), salvar tanto botões cadastrados quanto customizados
                if (step.type !== 'access') {
                    // ✅ 1. Salvar botões customizados
                    const customButtons = [];
                    const customButtonsList = document.getElementById(`custom-buttons-list-${stepId}`);
                    if (customButtonsList) {
                        // ✅ CORREÇÃO: Buscar pelos atributos name reais, não pelo índice do forEach
                        customButtonsList.querySelectorAll('[data-custom-button]').forEach((btnEl) => {
                            // Buscar input de texto (pode ter qualquer índice no name)
                            const textInput = btnEl.querySelector(`input[name^="custom-btn-text-${stepId}-"]`);
                            // Buscar select de target (pode ter qualquer índice no name)
                            const targetSelect = btnEl.querySelector(`select[name^="custom-btn-target-${stepId}-"]`);
                            
                            if (textInput) {
                                const text = textInput.value || '';
                                const targetStep = targetSelect ? (targetSelect.value || '') : '';
                                
                                if (text.trim()) {
                                    customButtons.push({
                                        text: text.trim(),
                                        target_step: targetStep || null
                                    });
                                }
                            }
                        });
                    }
                    if (!step.config) step.config = {};
                    step.config.custom_buttons = customButtons;
                    
                    // ✅ 2. Salvar botões cadastrados selecionados
                    const selectedButtons = [];
                    
                    // Verificar botões principais (main_buttons)
                    if (self.config.main_buttons) {
                        self.config.main_buttons.forEach((button, index) => {
                            const checkbox = document.getElementById(`button-main-${index}-${stepId}`);
                            if (checkbox && checkbox.checked) {
                                selectedButtons.push({ type: 'main', index: index });
                            }
                        });
                    }
                    
                    // Verificar botões de redirecionamento (redirect_buttons)
                    if (self.config.redirect_buttons) {
                        self.config.redirect_buttons.forEach((button, index) => {
                            const checkbox = document.getElementById(`button-redirect-${index}-${stepId}`);
                            if (checkbox && checkbox.checked) {
                                selectedButtons.push({ type: 'redirect', index: index });
                            }
                        });
                    }
                    
                    step.config.selected_buttons = selectedButtons;
                }
                
                if (step.type === 'message') {
                    step.connections.retry = document.getElementById(`step-retry-${stepId}`)?.value || '';
                    step.connections.next = document.getElementById(`step-next-${stepId}`)?.value || '';
                } else if (step.type === 'buttons' || (step.type !== 'access' && step.type !== 'payment' && step.type !== 'message')) {
                    step.connections.next = document.getElementById(`step-next-${stepId}`)?.value || '';
                }
                // ✅ Compatibilidade: Se for payment (steps antigos), manter lógica antiga
                if (step.type === 'payment') {
                    step.connections.next = document.getElementById(`step-next-${stepId}`)?.value || '';
                    step.connections.pending = document.getElementById(`step-pending-${stepId}`)?.value || '';
                }
                
                // ✅ SALVAR MENSAGEM DE ERRO PERSONALIZADA
                if (step.conditions && step.conditions.length > 0) {
                    const errorMessageInput = document.getElementById(`step-error-message-${stepId}`);
                    if (errorMessageInput) {
                        const errorMessage = errorMessageInput.value.trim();
                        if (errorMessage) {
                            if (!step.config) step.config = {};
                            step.config.error_message = errorMessage;
                        } else {
                            // Se vazio, usar padrão (será definido no backend)
                            if (step.config) {
                                delete step.config.error_message;
                            }
                        }
                    }
                }
                
                // ✅ SALVAR CONDIÇÕES
                const conditionsList = document.getElementById(`conditions-list-${stepId}`);
                if (conditionsList) {
                    const conditions = [];
                    conditionsList.querySelectorAll('[data-condition]').forEach((condEl, idx) => {
                        const condType = condEl.querySelector(`select[name="condition-type-${stepId}-${idx}"]`)?.value;
                        const targetStep = condEl.querySelector(`select[name="condition-target-${stepId}-${idx}"]`)?.value;
                        const order = idx + 1;
                        
                        if (condType && targetStep) {
                            const condition = {
                                id: `cond_${Date.now()}_${idx}`,
                                type: condType,
                                target_step: targetStep,
                                order: order
                            };
                            
                            // Configurações específicas por tipo
                            if (condType === 'text_validation') {
                                condition.validation = condEl.querySelector(`select[name="condition-validation-${stepId}-${idx}"]`)?.value || 'any';
                                if (condition.validation === 'contains' || condition.validation === 'equals') {
                                    condition.value = condEl.querySelector(`input[name="condition-value-${stepId}-${idx}"]`)?.value || '';
                                }
                                condition.max_attempts = parseInt(condEl.querySelector(`input[name="condition-max-attempts-${stepId}-${idx}"]`)?.value) || null;
                            } else if (condType === 'button_click') {
                                condition.button_text = condEl.querySelector(`input[name="condition-button-text-${stepId}-${idx}"]`)?.value || '';
                            } else if (condType === 'payment_status') {
                                condition.status = condEl.querySelector(`select[name="condition-payment-status-${stepId}-${idx}"]`)?.value || 'paid';
                            } else if (condType === 'time_elapsed') {
                                condition.minutes = parseInt(condEl.querySelector(`input[name="condition-minutes-${stepId}-${idx}"]`)?.value) || 5;
                            }
                            
                            conditions.push(condition);
                        }
                    });
                    step.conditions = conditions.length > 0 ? conditions : null;
                }
                
                document.body.style.overflow = '';
                document.getElementById(`flow-step-modal-${stepId}`).remove();
                self.showNotification('✅ Step salvo!', 'success');
                
                // ✅ Recarregar editor visual se estiver ativo
                // ✅ Recarregar editor visual (sempre visual agora)
                setTimeout(() => self.initVisualFlowEditor(), 200);
            };
        },
        
        duplicateFlowStep(stepId) {
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) {
                this.showNotification('❌ Step não encontrado', 'error');
                return;
            }
            
            // Criar cópia do step
            const newStepId = `step_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const maxOrder = this.sortedFlowSteps.length > 0 ? Math.max(...this.sortedFlowSteps.map(s => s.order || 0)) : 0;
            
            const duplicatedStep = {
                id: newStepId,
                name: step.name ? `${step.name} (Cópia)` : null,
                type: step.type,
                order: maxOrder + 1,
                config: JSON.parse(JSON.stringify(step.config || {})),
                connections: {},  // Não copiar conexões (evitar confusão)
                delay_seconds: step.delay_seconds || 0
            };
            
            this.config.flow_steps.push(duplicatedStep);
            this.showNotification(`✅ Step duplicado! Edite o novo step para configurar conexões.`, 'success');
        },
        
        addCustomButton(stepId) {
            const customButtonsList = document.getElementById(`custom-buttons-list-${stepId}`);
            if (!customButtonsList) return;
            
            const self = this;
            function escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }
            
            const btnIndex = customButtonsList.querySelectorAll('[data-custom-button]').length;
            const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
            const stepOptions = availableSteps.map(s => {
                const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
            }).join('');
            
            const btnHtml = `
                <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-purple-600 mb-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Botão</label>
                            <input type="text" 
                                   name="custom-btn-text-${stepId}-${btnIndex}" 
                                   placeholder="Ex: Sim, quero!"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                   maxlength="64">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-300 mb-1">Ir para Step</label>
                            <select name="custom-btn-target-${stepId}-${btnIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                <option value="">Nenhum</option>${stepOptions}
                            </select>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="window.removeCustomButton('${stepId}', ${btnIndex})"
                            class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                        <i class="fas fa-times mr-1"></i>Remover
                    </button>
                </div>
            `;
            
            customButtonsList.insertAdjacentHTML('beforeend', btnHtml);
        },
        
        removeCustomButton(stepId, btnIndex) {
            const customButtonsList = document.getElementById(`custom-buttons-list-${stepId}`);
            if (!customButtonsList) return;
            
            const btnEls = customButtonsList.querySelectorAll('[data-custom-button]');
            if (btnIndex >= 0 && btnIndex < btnEls.length) {
                btnEls[btnIndex].remove();
            }
            
            // Atualizar índices dos inputs
            customButtonsList.querySelectorAll('[data-custom-button]').forEach((btnEl, newIdx) => {
                const textInput = btnEl.querySelector('input[type="text"]');
                const targetSelect = btnEl.querySelector('select');
                const removeBtn = btnEl.querySelector('button[onclick*="removeCustomButton"]');
                
                if (textInput) {
                    const oldName = textInput.name;
                    textInput.name = oldName.replace(/-\d+-/, `-${newIdx}-`);
                }
                if (targetSelect) {
                    const oldName = targetSelect.name;
                    targetSelect.name = oldName.replace(/-\d+-/, `-${newIdx}-`);
                }
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeCustomButton('${stepId}', ${newIdx})`);
                }
            });
        },
        
        getConditionLabel(condition) {
            if (!condition) return 'Condição';
            
            if (condition.type === 'text_validation') {
                const validation = condition.validation || 'any';
                const labels = {
                    'email': 'Se email válido',
                    'phone': 'Se telefone válido',
                    'cpf': 'Se CPF válido',
                    'contains': `Se texto contém "${condition.value || ''}"`,
                    'equals': `Se texto igual a "${condition.value || ''}"`,
                    'any': 'Se qualquer texto'
                };
                return labels[validation] || 'Se texto válido';
            } else if (condition.type === 'button_click') {
                return `Se botão "${condition.button_text || ''}" clicado`;
            } else if (condition.type === 'payment_status') {
                const status = condition.status || 'paid';
                const labels = {
                    'paid': 'Se pagamento confirmado',
                    'pending': 'Se pagamento pendente',
                    'failed': 'Se pagamento falhou',
                    'expired': 'Se pagamento expirado'
                };
                return labels[status] || 'Se status de pagamento';
            } else if (condition.type === 'time_elapsed') {
                return `Se ${condition.minutes || 5} minuto(s) decorrido(s)`;
            }
            
            return 'Condição';
        },
        
        addCondition(stepId) {
            this.editCondition(stepId, -1); // -1 = nova condição
        },
        
        editCondition(stepId, condIndex) {
            const self = this;
            const step = self.config.flow_steps.find(s => s.id === stepId);
            if (!step) return;
            
            const isNew = condIndex < 0;
            const condition = isNew ? null : (step.conditions && step.conditions[condIndex]) || null;
            
            const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
            const stepOptions = availableSteps.map(s => {
                const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                return `<option value="${s.id}" ${condition && condition.target_step === s.id ? 'selected' : ''}>${s.order || 0} - ${stepLabel}</option>`;
            }).join('');
            
            // Determinar tipos de condição disponíveis baseado no tipo do step
            let availableConditionTypes = [];
            if (step.type === 'message') {
                availableConditionTypes = [
                    { value: 'text_validation', label: '💬 Validação de Texto' }
                ];
            } else if (step.type === 'buttons') {
                availableConditionTypes = [
                    { value: 'button_click', label: '🔘 Clique em Botão' }
                ];
            } else if (step.type === 'payment') {
                availableConditionTypes = [
                    { value: 'payment_status', label: '💰 Status de Pagamento' }
                ];
            } else {
                // Para outros tipos, permitir condições de tempo
                availableConditionTypes = [
                    { value: 'time_elapsed', label: '⏰ Tempo Decorrido' }
                ];
            }
            
            const conditionTypeOptions = availableConditionTypes.map(t => 
                `<option value="${t.value}" ${condition && condition.type === t.value ? 'selected' : ''}>${t.label}</option>`
            ).join('');
            
            // Renderizar campos específicos baseado no tipo
            function renderConditionConfig(condType, cond) {
                if (condType === 'text_validation') {
                    const validation = cond ? (cond.validation || 'any') : 'any';
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Tipo de Validação:</label>
                            <select name="condition-validation-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                    onchange="updateConditionConfig('${stepId}', ${condIndex}, this.value)">
                                <option value="email" ${validation === 'email' ? 'selected' : ''}>Email válido</option>
                                <option value="phone" ${validation === 'phone' ? 'selected' : ''}>Telefone válido</option>
                                <option value="cpf" ${validation === 'cpf' ? 'selected' : ''}>CPF válido</option>
                                <option value="contains" ${validation === 'contains' ? 'selected' : ''}>Texto contém</option>
                                <option value="equals" ${validation === 'equals' ? 'selected' : ''}>Texto igual a</option>
                                <option value="any" ${validation === 'any' ? 'selected' : ''}>Qualquer texto</option>
                            </select>
                        </div>
                        <div id="condition-value-field-${stepId}-${condIndex}" class="mb-3" style="display: ${(validation === 'contains' || validation === 'equals') ? 'block' : 'none'};">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Valor esperado:</label>
                            <input type="text" 
                                   name="condition-value-${stepId}-${condIndex}" 
                                   value="${cond && cond.value ? cond.value.replace(/"/g, '&quot;') : ''}"
                                   placeholder="Ex: sim, não, ok..."
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Máximo de tentativas (opcional):</label>
                            <input type="number" 
                                   name="condition-max-attempts-${stepId}-${condIndex}" 
                                   value="${cond && cond.max_attempts ? cond.max_attempts : ''}"
                                   min="1" max="10"
                                   placeholder="Deixe vazio para ilimitado"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <p class="text-xs text-yellow-300 mt-1">
                                Quando atingir este limite, usará "Fallback Step" (se configurado)
                            </p>
                        </div>
                    `;
                } else if (condType === 'button_click') {
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Texto do botão:</label>
                            <input type="text" 
                                   name="condition-button-text-${stepId}-${condIndex}" 
                                   value="${cond && cond.button_text ? cond.button_text.replace(/"/g, '&quot;') : ''}"
                                   placeholder="Ex: Sim, quero!"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Máximo de tentativas (opcional):</label>
                            <input type="number" 
                                   name="condition-max-attempts-${stepId}-${condIndex}" 
                                   value="${cond && cond.max_attempts ? cond.max_attempts : ''}"
                                   min="1" max="10"
                                   placeholder="Deixe vazio para ilimitado"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <p class="text-xs text-yellow-300 mt-1">
                                Quando atingir este limite, usará "Fallback Step" (se configurado)
                            </p>
                        </div>
                    `;
                } else if (condType === 'payment_status') {
                    const status = cond ? (cond.status || 'paid') : 'paid';
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Status do pagamento:</label>
                            <select name="condition-payment-status-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                <option value="paid" ${status === 'paid' ? 'selected' : ''}>✅ Confirmado (pago)</option>
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>⏳ Pendente</option>
                                <option value="failed" ${status === 'failed' ? 'selected' : ''}>❌ Falhou</option>
                                <option value="expired" ${status === 'expired' ? 'selected' : ''}>⏰ Expirado</option>
                            </select>
                        </div>
                    `;
                } else if (condType === 'time_elapsed') {
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Minutos decorridos:</label>
                            <input type="number" 
                                   name="condition-minutes-${stepId}-${condIndex}" 
                                   value="${cond && cond.minutes ? cond.minutes : 5}"
                                   min="1" max="1440"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                    `;
                }
                return '';
            }
            
            const currentCondType = condition ? condition.type : (availableConditionTypes[0] ? availableConditionTypes[0].value : 'text_validation');
            const configHtml = renderConditionConfig(currentCondType, condition);
            
            // ✅ Modal de condição é sobreposto ao modal de step (não precisa prevenir scroll - já está hidden)
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60]';
            modal.id = `condition-modal-${stepId}-${condIndex}`;
            
            // ✅ Click fora do modal para fechar (mas não restaurar scroll - modal de step ainda está aberto)
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto border-2 border-blue-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-blue-300">
                            <i class="fas fa-code-branch mr-2"></i>${isNew ? 'Nova' : 'Editar'} Condição
                        </h3>
                        <button onclick="document.getElementById('condition-modal-${stepId}-${condIndex}').remove()" 
                                class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form onsubmit="event.preventDefault(); saveCondition('${stepId}', ${condIndex});">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Tipo de Condição:</label>
                            <select id="condition-type-select-${stepId}-${condIndex}" 
                                    name="condition-type-${stepId}-${condIndex}"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white"
                                    onchange="updateConditionConfig('${stepId}', ${condIndex}, null)">
                                ${conditionTypeOptions}
                            </select>
                        </div>
                        <div id="condition-config-${stepId}-${condIndex}">
                            ${configHtml}
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Ir para Step (quando condição matchar):</label>
                            <select name="condition-target-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                <option value="">Selecione um step...</option>${stepOptions.map(opt => {
                                    const match = opt.match(/value="([^"]+)"/);
                                    const value = match ? match[1] : '';
                                    const selected = (condition && condition.target_step === value) ? 'selected' : '';
                                    return opt.replace(/<option/, '<option ' + selected);
                                }).join('')}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-undo mr-2 text-purple-400"></i>Fallback Step (opcional)
                            </label>
                            <select name="condition-fallback-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                <option value="">Nenhum (continuar para próxima condição)</option>${stepOptions.map(opt => {
                                    const match = opt.match(/value="([^"]+)"/);
                                    const value = match ? match[1] : '';
                                    const selected = (condition && condition.fallback_step === value) ? 'selected' : '';
                                    return opt.replace(/<option/, '<option ' + selected);
                                }).join('')}
                            </select>
                            <p class="text-xs text-purple-300 mt-1">
                                Step usado quando max_attempts atingir (apenas para condições de texto/botão)
                            </p>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" 
                                    onclick="document.getElementById('condition-modal-${stepId}-${condIndex}').remove()" 
                                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg"
                                    style="z-index: 61;">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                <i class="fas fa-save mr-2"></i>Salvar Condição
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        },
        
        removeCondition(stepId, condIndex) {
            if (!confirm('⚠️ Remover esta condição?')) return;
            
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) return;
            
            if (step.conditions && step.conditions.length > condIndex) {
                step.conditions.splice(condIndex, 1);
            }
            
            // Recarregar modal do step para atualizar lista
            const stepModal = document.getElementById(`flow-step-modal-${stepId}`);
            if (stepModal) {
                // Manter overflow hidden (modal será recriado)
                stepModal.remove();
                setTimeout(() => this.editFlowStep(stepId), 100);
            }
        },
        
        saveCondition(stepId, condIndex) {
            const self = this;
            const step = self.config.flow_steps.find(s => s.id === stepId);
            if (!step) return;
            
            const modal = document.getElementById(`condition-modal-${stepId}-${condIndex}`);
            if (!modal) return;
            
            const isNew = condIndex < 0;
            const condType = modal.querySelector(`select[name="condition-type-${stepId}-${condIndex}"]`)?.value;
            const targetStep = modal.querySelector(`select[name="condition-target-${stepId}-${condIndex}"]`)?.value;
            
            if (!condType || !targetStep) {
                alert('⚠️ Preencha todos os campos obrigatórios');
                return;
            }
            
            const condition = {
                id: isNew ? `cond_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` : (step.conditions && step.conditions[condIndex] ? step.conditions[condIndex].id : `cond_${Date.now()}`),
                type: condType,
                target_step: targetStep,
                order: isNew ? ((step.conditions && step.conditions.length) || 0) + 1 : condIndex + 1
            };
            
            // ✅ NOVO: Salvar fallback_step (opcional)
            const fallbackStep = modal.querySelector(`select[name="condition-fallback-${stepId}-${condIndex}"]`)?.value || '';
            if (fallbackStep) {
                condition.fallback_step = fallbackStep;
            }
            
            // Configurações específicas por tipo
            if (condType === 'text_validation') {
                condition.validation = modal.querySelector(`select[name="condition-validation-${stepId}-${condIndex}"]`)?.value || 'any';
                if (condition.validation === 'contains' || condition.validation === 'equals') {
                    condition.value = modal.querySelector(`input[name="condition-value-${stepId}-${condIndex}"]`)?.value || '';
                }
                const maxAttempts = modal.querySelector(`input[name="condition-max-attempts-${stepId}-${condIndex}"]`)?.value;
                condition.max_attempts = maxAttempts ? parseInt(maxAttempts) : null;
            } else if (condType === 'button_click') {
                condition.button_text = modal.querySelector(`input[name="condition-button-text-${stepId}-${condIndex}"]`)?.value || '';
                const maxAttempts = modal.querySelector(`input[name="condition-max-attempts-${stepId}-${condIndex}"]`)?.value;
                condition.max_attempts = maxAttempts ? parseInt(maxAttempts) : null;
            } else if (condType === 'payment_status') {
                condition.status = modal.querySelector(`select[name="condition-payment-status-${stepId}-${condIndex}"]`)?.value || 'paid';
            } else if (condType === 'time_elapsed') {
                condition.minutes = parseInt(modal.querySelector(`input[name="condition-minutes-${stepId}-${condIndex}"]`)?.value) || 5;
            }
            
            // Adicionar ou atualizar condição
            if (!step.conditions) step.conditions = [];
            
            if (isNew) {
                step.conditions.push(condition);
            } else {
                step.conditions[condIndex] = condition;
            }
            
            // Reordenar condições
            step.conditions.forEach((c, idx) => {
                c.order = idx + 1;
            });
            
            // Fechar modal de condição (modal de step ainda está aberto)
            modal.remove();
            
            // Recarregar modal do step para atualizar lista de condições
            const stepModal = document.getElementById(`flow-step-modal-${stepId}`);
            if (stepModal) {
                // Manter overflow hidden (modal será recriado)
                stepModal.remove();
                setTimeout(() => self.editFlowStep(stepId), 100);
            } else {
                // Se modal de step não existe mais, restaurar scroll
                document.body.style.overflow = '';
            }
        },
        
        updateConditionConfig(stepId, condIndex, validationType) {
            const modal = document.getElementById(`condition-modal-${stepId}-${condIndex}`);
            if (!modal) return;
            
            const typeSelect = modal.querySelector(`#condition-type-select-${stepId}-${condIndex}`);
            const condType = validationType || (typeSelect ? typeSelect.value : null);
            if (!condType) return;
            
            const configDiv = modal.querySelector(`#condition-config-${stepId}-${condIndex}`);
            if (!configDiv) return;
            
            // Buscar condição existente se estiver editando
            const self = this;
            const step = self.config.flow_steps.find(s => s.id === stepId);
            const condition = step && step.conditions && step.conditions[condIndex] ? step.conditions[condIndex] : null;
            
            // Renderizar campos específicos
            let configHtml = '';
            if (condType === 'text_validation') {
                const validation = validationType || (condition ? condition.validation : 'any');
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Tipo de Validação:</label>
                        <select name="condition-validation-${stepId}-${condIndex}" 
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                onchange="updateConditionConfig('${stepId}', ${condIndex}, this.value)">
                            <option value="email" ${validation === 'email' ? 'selected' : ''}>Email válido</option>
                            <option value="phone" ${validation === 'phone' ? 'selected' : ''}>Telefone válido</option>
                            <option value="cpf" ${validation === 'cpf' ? 'selected' : ''}>CPF válido</option>
                            <option value="contains" ${validation === 'contains' ? 'selected' : ''}>Texto contém</option>
                            <option value="equals" ${validation === 'equals' ? 'selected' : ''}>Texto igual a</option>
                            <option value="any" ${validation === 'any' ? 'selected' : ''}>Qualquer texto</option>
                        </select>
                    </div>
                    <div id="condition-value-field-${stepId}-${condIndex}" class="mb-3" style="display: ${(validation === 'contains' || validation === 'equals') ? 'block' : 'none'};">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Valor esperado:</label>
                        <input type="text" 
                               name="condition-value-${stepId}-${condIndex}" 
                               value="${condition && condition.value ? condition.value.replace(/"/g, '&quot;') : ''}"
                               placeholder="Ex: sim, não, ok..."
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Máximo de tentativas (opcional):</label>
                        <input type="number" 
                               name="condition-max-attempts-${stepId}-${condIndex}" 
                               value="${condition && condition.max_attempts ? condition.max_attempts : ''}"
                               min="1" max="10"
                               placeholder="Deixe vazio para ilimitado"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                `;
            } else if (condType === 'button_click') {
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Texto do botão:</label>
                        <input type="text" 
                               name="condition-button-text-${stepId}-${condIndex}" 
                               value="${condition && condition.button_text ? condition.button_text.replace(/"/g, '&quot;') : ''}"
                               placeholder="Ex: Sim, quero!"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                `;
            } else if (condType === 'payment_status') {
                const status = condition ? (condition.status || 'paid') : 'paid';
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Status do pagamento:</label>
                        <select name="condition-payment-status-${stepId}-${condIndex}" 
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <option value="paid" ${status === 'paid' ? 'selected' : ''}>✅ Confirmado (pago)</option>
                            <option value="pending" ${status === 'pending' ? 'selected' : ''}>⏳ Pendente</option>
                            <option value="failed" ${status === 'failed' ? 'selected' : ''}>❌ Falhou</option>
                            <option value="expired" ${status === 'expired' ? 'selected' : ''}>⏰ Expirado</option>
                        </select>
                    </div>
                `;
            } else if (condType === 'time_elapsed') {
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Minutos decorridos:</label>
                        <input type="number" 
                               name="condition-minutes-${stepId}-${condIndex}" 
                               value="${condition && condition.minutes ? condition.minutes : 5}"
                               min="1" max="1440"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                `;
            }
            
            configDiv.innerHTML = configHtml;
        },
        
        removeFlowStep(stepId) {
            if (!confirm('⚠️ Remover este step? Isso pode quebrar conexões de outros steps.')) return;
            
            // ✅ Se este step é o inicial, limpar e auto-definir novo
            const wasStartStep = this.config.flow_start_step_id === stepId;
            
            this.config.flow_steps = this.config.flow_steps.filter(s => s.id !== stepId);
            
            // Limpar conexões que apontavam para este step
            this.config.flow_steps.forEach(step => {
                if (step.connections) {
                    if (step.connections.next === stepId) step.connections.next = '';
                    if (step.connections.pending === stepId) step.connections.pending = '';
                    if (step.connections.retry === stepId) step.connections.retry = '';
                }
            });
            
            // ✅ Auto-definir novo step inicial se o removido era o inicial
            if (wasStartStep) {
                this.config.flow_start_step_id = null;
                if (this.config.flow_steps.length > 0) {
                    // Buscar step com order=1 primeiro
                    const sortedSteps = [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                    let newStartStep = null;
                    for (const step of sortedSteps) {
                        if (step.order === 1) {
                            newStartStep = step;
                            break;
                        }
                    }
                    // Se não encontrou order=1, usar primeiro step
                    if (!newStartStep && sortedSteps.length > 0) {
                        newStartStep = sortedSteps[0];
                    }
                    if (newStartStep) {
                        this.config.flow_start_step_id = newStartStep.id;
                        this.showNotification(`✅ Step removido! Novo step inicial definido automaticamente: ${this.getStepTitle(newStartStep.type)} (order=${newStartStep.order || 0})`, 'success');
                    } else {
                        this.showNotification('✅ Step removido! ⚠️ Defina um step inicial.', 'success');
                    }
                } else {
                    this.config.flow_start_step_id = null;
                    this.showNotification('✅ Step removido!', 'success');
                }
            } else {
                this.showNotification('✅ Step removido!', 'success');
            }
            
            // ✅ Recarregar editor visual (sempre visual agora)
            setTimeout(() => this.initVisualFlowEditor(), 100);
        },
        
        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 text-white font-bold ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    }));
    console.log('✅ botConfigApp registrado com sucesso!');
    return true;
    }
    
    // ✅ Tentar registrar imediatamente se Alpine já estiver disponível
    if (typeof Alpine !== 'undefined' && Alpine.data) {
        registerBotConfigApp();
    }
    
    // ✅ Registrar quando Alpine.js estiver pronto
    document.addEventListener('alpine:init', () => {
        if (!registerBotConfigApp()) {
            console.error('❌ Falha ao registrar botConfigApp via alpine:init');
        }
        
        // ✅ Remarketing App (componente separado) - DENTRO de alpine:init
        Alpine.data('remarketingApp', () => ({
        campaigns: [],
        showCreateModal: false,
        showStatsModal: false,
        selectedCampaign: null,
        newCampaign: {
            name: '',
            message: '',
            media_url: '',
            media_type: 'video',
            audio_enabled: false,
            audio_url: '',
            target_audience: 'non_buyers',
            days_since_last_contact: 3,
            exclude_buyers: true,
            cooldown_hours: 6,  // ✅ Fixo: 6 horas (não aparece para usuário)
            buttons: []  // ✅ NOVO: Botões de produto (igual ao Remarketing Geral)
        },
        
        async init() {
            await this.loadCampaigns();
        },
        
        async loadCampaigns() {
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/remarketing/campaigns');
                const data = await response.json();
                if (response.ok) {
                    this.campaigns = data;
                }
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
            }
        },
        
        async createCampaign() {
            if (!this.newCampaign.name || !this.newCampaign.message) {
                alert('Preencha nome e mensagem');
                return;
            }
            
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/remarketing/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newCampaign)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.campaigns.unshift(data);
                    this.showCreateModal = false;
                    this.resetForm();
                    this.showNotification('✅ Campanha criada!', 'success');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao criar campanha: ' + error.message);
            }
        },
        
        async sendCampaign(campaignId) {
            if (!confirm('Enviar esta campanha agora?')) return;
            
            try {
                const response = await fetch(`/api/bots/{{ bot.id }}/remarketing/campaigns/${campaignId}/send`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    await this.loadCampaigns();
                    this.showNotification('✅ Campanha enviada!', 'success');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao enviar campanha: ' + error.message);
            }
        },
        
        resetForm() {
            this.newCampaign = {
                name: '',
                message: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                target_audience: 'non_buyers',
                days_since_last_contact: 3,
                exclude_buyers: true,
                cooldown_hours: 6,  // ✅ Fixo: 6 horas
                buttons: []  // ✅ NOVO: Botões de produto
            };
        },
        
        getAudienceLabel(audience) {
            const labels = {
                'non_buyers': 'Não compraram',
                'abandoned_cart': 'Carrinho abandonado',
                'inactive': 'Inativos',
                'all': 'Todos'
            };
            return labels[audience] || audience;
        },
        
        getStatusLabel(status) {
            const labels = {
                'draft': 'Rascunho',
                'scheduled': 'Agendada',
                'sending': 'Enviando',
                'completed': 'Concluída',
                'paused': 'Pausada',
                'failed': 'Falhou'
            };
            return labels[status] || status;
        },
        
        // ✅ Cálculos de Analytics
        getTotalSent() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_sent || 0), 0);
        },
        
        getDeliveryRate() {
            const totalSent = this.getTotalSent();
            const totalFailed = this.campaigns.reduce((sum, c) => sum + (c.total_failed || 0), 0);
            if (totalSent === 0) return 0;
            return ((totalSent - totalFailed) / totalSent * 100).toFixed(1);
        },
        
        getClickRate() {
            const totalSent = this.getTotalSent();
            const totalClicks = this.getTotalClicks();
            if (totalSent === 0) return 0;
            return (totalClicks / totalSent * 100).toFixed(1);
        },
        
        getTotalClicks() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_clicks || 0), 0);
        },
        
        getTotalFailed() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_failed || 0), 0);
        },
        
        getTotalBlocked() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_blocked || 0), 0);
        },
        
        getTotalRevenue() {
            return this.campaigns.reduce((sum, c) => sum + (c.revenue_generated || 0), 0);
        },
        
        // ✅ Funções para Modal de Estatísticas
        viewCampaignStats(campaign) {
            this.selectedCampaign = campaign;
            this.showStatsModal = true;
        },
        
        getCampaignDeliveryRate(campaign) {
            if (!campaign || !campaign.total_sent) return 0;
            const delivered = campaign.total_sent - (campaign.total_failed || 0);
            return (delivered / campaign.total_sent * 100).toFixed(1);
        },
        
        getCampaignClickRate(campaign) {
            if (!campaign || !campaign.total_sent) return 0;
            return ((campaign.total_clicks || 0) / campaign.total_sent * 100).toFixed(1);
        },
        
        getCampaignConversionRate(campaign) {
            if (!campaign || !campaign.total_sent) return 0;
            // Assumindo que conversão = cliques que geraram receita
            const conversions = campaign.total_clicks || 0;
            return (conversions / campaign.total_sent * 100).toFixed(1);
        },
        
        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 text-white font-bold ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    }));
    console.log('✅ remarketingApp registrado com sucesso!');
}); // ✅ Fecha document.addEventListener('alpine:init', ...)

// ✅ FALLBACK: Se Alpine.js já estiver disponível, tentar registrar imediatamente
// ✅ Isso é necessário porque o alpine:init pode não ser disparado se o Alpine já inicializou
if (typeof window !== 'undefined' && typeof window.Alpine !== 'undefined' && window.Alpine.data) {
    // Verificar se já foi registrado
    try {
        // Tentar acessar o componente para ver se existe
        const testComponent = window.Alpine.data('botConfigApp');
        if (!testComponent) {
            console.warn('⚠️ botConfigApp não foi registrado via alpine:init! O Alpine pode ter inicializado antes do script executar.');
        } else {
            console.log('✅ botConfigApp já está registrado!');
        }
    } catch (e) {
        console.warn('⚠️ Erro ao verificar botConfigApp:', e);
    }
}
})(); // ✅ Fecha IIFE

// ✅ Funções globais para condições (acessam contexto Alpine via DOM)
// Estas funções devem ficar FORA de alpine:init para serem acessíveis globalmente
window.addCondition = function(stepId) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.addCondition) {
        alpineData.addCondition(stepId);
    }
};

window.editCondition = function(stepId, condIndex) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.editCondition) {
        alpineData.editCondition(stepId, condIndex);
    }
};

window.removeCondition = function(stepId, condIndex) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.removeCondition) {
        alpineData.removeCondition(stepId, condIndex);
    }
};

window.saveCondition = function(stepId, condIndex) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.saveCondition) {
        alpineData.saveCondition(stepId, condIndex);
    }
};

window.updateConditionConfig = function(stepId, condIndex, validationType) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.updateConditionConfig) {
        alpineData.updateConditionConfig(stepId, condIndex, validationType);
    }
};

// ✅ Funções globais para editor visual
window.editFlowStepFromVisual = function(stepId) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.editFlowStep) {
        alpineData.editFlowStep(stepId);
    }
};

window.removeFlowStepFromVisual = function(stepId) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.removeFlowStep) {
        if (confirm('⚠️ Remover este step? Todas as conexões serão perdidas.')) {
            alpineData.removeFlowStep(stepId);
            // ✅ Recarregar editor visual após remover (sempre visual agora)
            setTimeout(() => {
                alpineData.initVisualFlowEditor();
            }, 100);
        }
    }
};

// ✅ Funções globais para botões customizados
window.addCustomButton = function(stepId) {
    try {
        // ✅ DEBUG: Log para verificar stepId
        console.log('🔍 Tentando adicionar botão customizado para stepId:', stepId);
        
        // Tentar encontrar o container
        let container = document.getElementById(`custom-buttons-list-${stepId}`);
        
        // ✅ Se não encontrar, tentar buscar por atributo data ou classe
        if (!container) {
            console.warn('⚠️ Container não encontrado pelo ID, tentando buscar no modal...');
            // Buscar no modal atual
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            if (modal) {
                container = modal.querySelector(`[id*="custom-buttons-list"]`);
                if (container) {
                    console.log('✅ Container encontrado no modal:', container.id);
                }
            }
        }
        
        if (!container) {
            // ✅ Tentar aguardar um pouco e buscar novamente (pode ser problema de timing)
            console.warn('⚠️ Container não encontrado imediatamente, aguardando 100ms...');
            setTimeout(() => {
                container = document.getElementById(`custom-buttons-list-${stepId}`);
                if (container) {
                    console.log('✅ Container encontrado após aguardar!');
                    // Chamar função novamente
                    window.addCustomButton(stepId);
                    return;
                }
                
                // ✅ DEBUG: Listar todos os elementos com "custom-buttons" no ID
                const allContainers = document.querySelectorAll('[id*="custom-buttons"]');
                console.error('❌ Container de botões customizados não encontrado:', `custom-buttons-list-${stepId}`);
                console.log('🔍 Containers encontrados no DOM:', Array.from(allContainers).map(el => el.id));
                console.log('🔍 StepId recebido:', stepId);
                console.log('🔍 Tipo do stepId:', typeof stepId);
                
                // Verificar se o modal existe
                const modal = document.querySelector('.fixed.inset-0.bg-black');
                console.log('🔍 Modal encontrado:', !!modal);
                if (modal) {
                    console.log('🔍 HTML do modal (primeiros 500 chars):', modal.innerHTML.substring(0, 500));
                }
                
                alert(`❌ Erro: Container de botões não encontrado para stepId: ${stepId}\n\nVerifique o console para mais detalhes.`);
            }, 100);
            return;
        }
        
        // Buscar dados do Alpine para obter steps disponíveis
        const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
        if (!alpineData || !alpineData.config) {
            console.error('❌ Dados do Alpine não encontrados');
            alert('❌ Erro: Dados não carregados. Tente recarregar a página.');
            return;
        }
        
        // Buscar steps disponíveis (exceto o step atual)
        const flowSteps = alpineData.config.flow_steps || [];
        const availableSteps = flowSteps.filter(s => s && s.id !== stepId);
        
        // Função auxiliar para escapar HTML
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }
        
        // Função auxiliar para obter título do step
        function getStepTitle(type) {
            const titles = {'content': 'Conteúdo', 'payment': 'Pagamento', 'message': 'Mensagem', 'audio': 'Áudio', 'video': 'Vídeo', 'buttons': 'Botões', 'access': 'Acesso'};
            return titles[type] || 'Desconhecido';
        }
        
        // Contar botões existentes para gerar índice único
        const existingButtons = container.querySelectorAll('[data-custom-button]');
        const newIndex = existingButtons.length;
        
        // Construir options do select
        const stepOptions = availableSteps.map(s => {
            const stepLabel = (s.name && s.name.trim()) ? s.name : getStepTitle(s.type);
            return `<option value="${s.id}">${s.order || 0} - ${escapeHtml(stepLabel)}</option>`;
        }).join('');
        
        // Criar HTML do novo botão
        const buttonHtml = `
            <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-blue-600 mb-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Botão</label>
                        <input type="text" 
                               name="custom-btn-text-${stepId}-${newIndex}" 
                               value=""
                               placeholder="Ex: Sim, quero!"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                               maxlength="64">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">🔗 Ir para Step</label>
                        <select name="custom-btn-target-${stepId}-${newIndex}" 
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <option value="">Nenhum</option>${stepOptions}
                        </select>
                    </div>
                </div>
                <button type="button" 
                        onclick="window.removeCustomButton('${stepId}', ${newIndex})"
                        class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                    <i class="fas fa-times mr-1"></i>Remover
                </button>
            </div>
        `;
        
        // Remover mensagem "Nenhum botão adicionado" se existir
        const emptyMessage = container.querySelector('.text-center');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        // Adicionar novo botão ao container
        container.insertAdjacentHTML('beforeend', buttonHtml);
        
        // Scroll suave para o novo botão
        const newButton = container.lastElementChild;
        if (newButton) {
            newButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            // Focar no input de texto do novo botão
            const textInput = newButton.querySelector('input[type="text"]');
            if (textInput) {
                setTimeout(() => textInput.focus(), 100);
            }
        }
    } catch (error) {
        console.error('❌ Erro ao adicionar botão customizado:', error);
        alert('❌ Erro ao adicionar botão. Verifique o console para mais detalhes.');
    }
};

window.removeCustomButton = function(stepId, index) {
    const container = document.getElementById(`custom-buttons-list-${stepId}`);
    if (!container) {
        console.error('❌ Container de botões customizados não encontrado:', `custom-buttons-list-${stepId}`);
        return;
    }
    
    // ✅ CORREÇÃO: Buscar o botão pelo índice ou pelo elemento clicado
    const buttons = Array.from(container.querySelectorAll('[data-custom-button]'));
    let buttonToRemove = null;
    
    // Se index for fornecido, usar índice
    if (typeof index === 'number' && index >= 0 && index < buttons.length) {
        buttonToRemove = buttons[index];
    } else {
        // Tentar encontrar pelo evento (se chamado via onclick)
        const event = window.event || arguments[2];
        if (event && event.target) {
            buttonToRemove = event.target.closest('[data-custom-button]');
        }
    }
    
    if (!buttonToRemove) {
        console.error('❌ Botão customizado não encontrado para remover');
        return;
    }
    
    // Remover o botão
    buttonToRemove.remove();
    
    // Se não houver mais botões, mostrar mensagem
    const remainingButtons = container.querySelectorAll('[data-custom-button]');
    if (remainingButtons.length === 0) {
        container.innerHTML = '<div class="text-xs text-blue-300 italic text-center py-2">Nenhum botão adicionado. Clique em "Adicionar Botão" para criar um.</div>';
    } else {
        // Reindexar os botões restantes para manter índices sequenciais
        remainingButtons.forEach((btn, newIdx) => {
            // Atualizar names dos inputs e selects
            const textInput = btn.querySelector(`input[name^="custom-btn-text-${stepId}-"]`);
            const targetSelect = btn.querySelector(`select[name^="custom-btn-target-${stepId}-"]`);
            const removeButton = btn.querySelector('button[onclick*="removeCustomButton"]');
            
            if (textInput) {
                textInput.name = `custom-btn-text-${stepId}-${newIdx}`;
            }
            
            if (targetSelect) {
                targetSelect.name = `custom-btn-target-${stepId}-${newIdx}`;
            }
            
            if (removeButton) {
                removeButton.setAttribute('onclick', `window.removeCustomButton('${stepId}', ${newIdx})`);
            }
        });
    }
};
</script>
{% endblock %}