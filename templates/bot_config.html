{% extends "base.html" %}
{% block title %}Configurar Bot - {{ bot.name }}{% endblock %}

{% block extra_head %}
<style>
/* ============================================
   BOT CONFIG - CSS COMPLETO
   Design System: Dashboard Dark Theme
   ============================================ */

/* CSS do Flow Editor V3.0 */
#flow-visual-canvas {
    background: #0D0F15 !important;
    background-image: 
        radial-gradient(circle, rgba(255, 255, 255, 0.25) 1.5px, transparent 1.5px) !important;
    background-size: 20px 20px !important;
    font-family: 'Inter', sans-serif;
    user-select: none;
    -webkit-user-select: none;
    cursor: default;
    position: relative;
    will-change: transform;
}

#flow-visual-canvas.panning {
    cursor: grabbing !important;
}

#flow-visual-canvas input,
#flow-visual-canvas textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

.flow-step-block {
    position: absolute;
    width: 300px;
    min-height: 180px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 14px;
    cursor: move;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    animation: stepFadeIn 0.3s ease-out;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    touch-action: none;
    will-change: transform;
}

@keyframes stepFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.flow-step-block:hover {
    border-color: #242836;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    transform: translateY(-2px);
    z-index: 100;
}

.flow-step-block.dragging {
    cursor: grabbing !important;
    opacity: 0.98;
    transform: scale(1.02);
    z-index: 1000 !important;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
    border-color: #FFFFFF;
    transition: none;
}

.flow-step-block.flow-step-initial {
    border-color: #FFB800;
    box-shadow: 
        0 0 0 3px rgba(255, 184, 0, 0.3),
        0 0 24px rgba(255, 184, 0, 0.4),
        0 8px 24px rgba(0, 0, 0, 0.5);
    animation: initialPulse 2s ease-in-out infinite;
}

@keyframes initialPulse {
    0%, 100% {
        box-shadow: 
            0 0 0 3px rgba(255, 184, 0, 0.3),
            0 0 24px rgba(255, 184, 0, 0.4),
            0 8px 24px rgba(0, 0, 0, 0.5);
    }
    50% {
        box-shadow: 
            0 0 0 4px rgba(255, 184, 0, 0.4),
            0 0 32px rgba(255, 184, 0, 0.6),
            0 8px 24px rgba(0, 0, 0, 0.5);
    }
}

.flow-step-block.flow-step-selected {
    border-color: #FFFFFF;
    box-shadow: 
        0 0 0 2px rgba(255, 255, 255, 0.3),
        0 8px 24px rgba(0, 0, 0, 0.5);
}

.flow-step-header {
    padding: 20px 16px;
    background: #E02727;
    border-radius: 14px 14px 0 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(224, 39, 39, 0.3);
}

.flow-step-header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    position: relative;
}

.flow-step-icon-center {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #FFFFFF;
}

.flow-step-title-center {
    font-size: 16px;
    font-weight: 700;
    color: #FFFFFF;
    font-family: 'Inter', sans-serif;
    text-align: center;
    letter-spacing: 0.3px;
}

.flow-step-start-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 18px;
    animation: starPulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 4px rgba(255, 184, 0, 0.8));
    z-index: 10;
}

@keyframes starPulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.15);
        opacity: 0.9;
    }
}

.flow-step-body {
    padding: 20px 16px;
    background: #0F0F14;
    min-height: 100px;
    border-top: 1px solid #242836;
}

.flow-step-preview {
    color: #FFFFFF;
    font-size: 13px;
    line-height: 1.7;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: 'Inter', sans-serif;
}

.flow-step-footer {
    padding: 14px 16px;
    border-top: 1px solid #242836;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    background: #0F0F14;
    border-radius: 0 0 14px 14px;
}

.flow-step-btn-action {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    background: #E02727;
    color: #FFFFFF;
    font-weight: 700;
    box-shadow: 0 2px 6px rgba(224, 39, 39, 0.3);
}

.flow-step-btn-action:hover {
    background: #ff3f3f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(224, 39, 39, 0.5);
}

.flow-step-btn-action:active {
    transform: translateY(0);
}

.connection-label-white {
    pointer-events: none;
    user-select: none;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    color: #FFFFFF !important;
    background-color: #0D0F15 !important;
    border: 1px solid #242836 !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
    transition: all 0.2s ease;
    display: block !important;
    pointer-events: auto !important;
}

.jtk-endpoint:hover {
    transform: scale(1.3);
    z-index: 50 !important;
}

.jtk-connector {
    cursor: pointer !important;
    transition: stroke-width 0.2s ease, opacity 0.2s ease;
    stroke: #FFFFFF !important;
    stroke-width: 2.5 !important;
    stroke-opacity: 0.9 !important;
}

.jtk-connector:hover {
    stroke-width: 3.5 !important;
    stroke-opacity: 1 !important;
}

.jtk-connector path {
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke: #FFFFFF !important;
}

.jtk-connector.jtk-connector-new {
    animation: connectionGlow 0.5s ease-out;
}

@keyframes connectionGlow {
    0% {
        opacity: 0;
        stroke-opacity: 0;
    }
    50% {
        stroke-opacity: 1;
    }
    100% {
        opacity: 1;
        stroke-opacity: 0.9;
    }
}

.flow-step-block button,
.flow-step-block input,
.flow-step-block textarea,
.flow-step-block select,
.flow-step-block a,
.flow-step-block i {
    cursor: pointer !important;
    pointer-events: auto !important;
    user-select: auto !important;
}

/* CSS para Forms, Tabs, Modals */
.config-section {
    background: #13151C;
    border: 1px solid #242836;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
}

.config-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.config-section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #FFFFFF;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #A1A1A9;
    margin-bottom: 8px;
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-textarea {
    width: 100%;
    padding: 12px 16px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
}

.form-textarea:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-select {
    width: 100%;
    padding: 12px 16px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    cursor: pointer;
}

.form-select:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #FFB800;
    color: #000000;
}

.btn-primary:hover {
    background: #FFC633;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
}

.btn-danger {
    background: #EF4444;
    color: #FFFFFF;
}

.btn-danger:hover {
    background: #DC2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-secondary {
    background: #242836;
    color: #FFFFFF;
}

.btn-secondary:hover {
    background: #2D3142;
}

.tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 1px solid #242836;
    overflow-x: auto;
}

.tab {
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: #A1A1A9;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tab:hover {
    color: #FFFFFF;
}

.tab.active {
    color: #FFB800;
    border-bottom-color: #FFB800;
}

.modal {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
}

.modal-content {
    background: #13151C;
    border: 1px solid #242836;
    border-radius: 12px;
    padding: 24px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    width: 100%;
}

@media (min-width: 640px) {
    .modal-content {
        max-width: 600px;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #FFFFFF;
}

.modal-close {
    background: transparent;
    border: none;
    color: #A1A1A9;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: #242836;
    color: #FFFFFF;
}

/* Responsividade */
@media (max-width: 768px) {
    .flow-step-block {
        min-width: 180px;
        max-width: 240px;
        width: 200px;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 320px) !important;
        min-height: 400px !important;
    }
    
    .config-section {
        padding: 16px;
    }
    
    .config-section-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

@media (max-width: 640px) {
    .flow-step-block {
        min-width: 160px;
        max-width: 200px;
        width: 180px;
        font-size: 0.875rem;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 280px) !important;
        min-height: 350px !important;
    }
    
    .config-section {
        padding: 12px;
        border-radius: 8px;
    }
    
    .config-section-header {
        gap: 8px;
    }
    
    .config-section-title {
        font-size: 1rem;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .grid.grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .grid.grid-cols-1.md\:grid-cols-3 {
        grid-template-columns: 1fr;
    }
    
    .max-w-full {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    .btn-action {
        width: 100%;
        justify-content: center;
    }
    
    #flow-visual-canvas {
        width: 100% !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 0 !important;
    }
    
    .grid {
        grid-template-columns: 1fr !important;
    }
    
    .fixed.inset-0.z-50 > .flex > div,
    [id^="flow-step-modal-"],
    [id^="condition-modal-"] {
        width: 95% !important;
        max-width: 95% !important;
        margin: 0 auto !important;
        padding: 1rem !important;
    }
}

* {
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
}
</style>
<script>
    window.stripSurrogateChars = function (value) {
        if (!value) {
            return '';
        }
        try {
            return value;
        } catch (err) {
            return value || '';
        }
    };
</script>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8" x-data="botConfigApp()" x-init="init()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-white mb-2">Configurar Bot: {{ bot.name }}</h1>
        <p class="text-gray-400">Configure todas as opções do seu bot</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button @click="activeTab = 'welcome'" :class="{'active': activeTab === 'welcome'}" class="tab">
            <i class="fas fa-comment"></i> Mensagem Inicial
        </button>
        <button @click="activeTab = 'buttons'" :class="{'active': activeTab === 'buttons'}" class="tab">
            <i class="fas fa-mouse-pointer"></i> Botões Principais
        </button>
        <button @click="activeTab = 'subscriptions'" :class="{'active': activeTab === 'subscriptions'}" class="tab">
            <i class="fas fa-crown"></i> Assinaturas
        </button>
        <button @click="activeTab = 'downsells'" :class="{'active': activeTab === 'downsells'}" class="tab">
            <i class="fas fa-arrow-down"></i> Downsells
        </button>
        <button @click="activeTab = 'upsells'" :class="{'active': activeTab === 'upsells'}" class="tab">
            <i class="fas fa-arrow-up"></i> Upsells
        </button>
        <button @click="activeTab = 'redirect'" :class="{'active': activeTab === 'redirect'}" class="tab">
            <i class="fas fa-external-link-alt"></i> Redirecionamento
        </button>
        <button @click="activeTab = 'flow'" :class="{'active': activeTab === 'flow'}" class="tab">
            <i class="fas fa-project-diagram"></i> Fluxo Visual
        </button>
        <button @click="activeTab = 'settings'" :class="{'active': activeTab === 'settings'}" class="tab">
            <i class="fas fa-cog"></i> Configurações
        </button>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-yellow-500"></i>
        <p class="mt-4 text-gray-400">Carregando...</p>
    </div>

    <!-- Tab Content -->
    <div x-show="!loading">
        <!-- Welcome Tab -->
        <div x-show="activeTab === 'welcome'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Mensagem Inicial</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mensagem de Boas-vindas</label>
                <textarea 
                    x-model="config.welcome_message" 
                    class="form-textarea"
                    placeholder="Digite a mensagem de boas-vindas..."
                    :maxlength="4096"
                ></textarea>
                <p class="text-sm text-gray-400 mt-2">
                    <span x-text="(config.welcome_message || '').length"></span> / 4096 caracteres
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">Tipo de Mídia</label>
                <select x-model="config.welcome_media_type" class="form-select">
                    <option value="video">Vídeo</option>
                    <option value="photo">Foto</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">URL da Mídia</label>
                <input 
                    type="text" 
                    x-model="config.welcome_media_url" 
                    class="form-input"
                    placeholder="https://..."
                />
            </div>

            <div class="form-group">
                <label class="flex items-center gap-2">
                    <input type="checkbox" x-model="config.welcome_audio_enabled" />
                    <span class="form-label">Habilitar Áudio Complementar</span>
                </label>
            </div>

            <div x-show="config.welcome_audio_enabled" class="form-group">
                <label class="form-label">URL do Áudio</label>
                <input 
                    type="text" 
                    x-model="config.welcome_audio_url" 
                    class="form-input"
                    placeholder="https://..."
                />
            </div>
        </div>

        <!-- Buttons Tab -->
        <div x-show="activeTab === 'buttons'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Botões Principais</h2>
                <button @click="addButton()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Botão
                </button>
            </div>

            <div class="space-y-6">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Botão <span x-text="index + 1"></span></h3>
                            <button @click="removeButton(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Botão</label>
                            <input 
                                type="text" 
                                x-model="button.text"
                                @blur="validateProductField(index, 'text')"
                                class="form-input"
                                placeholder="Ex: Comprar Agora"
                                maxlength="64"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Preço (R$)</label>
                            <input 
                                type="number" 
                                x-model.number="button.price"
                                @blur="validateProductField(index, 'price')"
                                class="form-input"
                                placeholder="0.00"
                                step="0.01"
                                min="0"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Descrição</label>
                            <textarea 
                                x-model="button.description" 
                                class="form-textarea"
                                placeholder="Descrição do produto..."
                            ></textarea>
                        </div>

                        <!-- Preview do Botão -->
                        <div class="mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Preview do Botão</h4>
                            <div class="bg-gray-900 p-3 rounded border border-gray-600">
                                <div class="text-white font-semibold mb-1" x-text="button.text || 'Texto do botão'"></div>
                                <div class="text-gray-400 text-sm mb-2" x-text="button.description || 'Descrição do produto'"></div>
                                <div class="text-yellow-400 font-bold" x-show="button.price">
                                    R$ <span x-text="button.price?.toFixed(2) || '0.00'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Bumps -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-md font-semibold text-white">Order Bumps</h4>
                                <button @click="addOrderBump(index)" class="btn btn-secondary">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>

                            <template x-for="(bump, bumpIndex) in (button.order_bumps || [])" :key="bumpIndex">
                                <div class="border border-gray-600 rounded p-3 mt-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-400">Order Bump <span x-text="bumpIndex + 1"></span></span>
                                        <button @click="removeOrderBump(index, bumpIndex)" class="text-red-400 hover:text-red-300">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>

                                    <div class="form-group">
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" x-model="bump.enabled" />
                                            <span class="form-label">Habilitado</span>
                                        </label>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Mensagem</label>
                                        <textarea x-model="bump.message" class="form-textarea"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Preço (R$)</label>
                                        <input type="number" x-model.number="bump.price" class="form-input" step="0.01" min="0" />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Descrição</label>
                                        <textarea x-model="bump.description" class="form-textarea"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Tipo de Mídia</label>
                                        <select x-model="bump.media_type" class="form-select">
                                            <option value="video">Vídeo</option>
                                            <option value="photo">Foto</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">URL da Mídia</label>
                                        <input type="text" x-model="bump.media_url" class="form-input" placeholder="https://..." />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Texto do Botão Aceitar</label>
                                        <input type="text" x-model="bump.accept_text" class="form-input" placeholder="Sim, eu quero!" />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Texto do Botão Recusar</label>
                                        <input type="text" x-model="bump.decline_text" class="form-input" placeholder="Não, obrigado" />
                                    </div>

                                    <!-- Preview do Order Bump -->
                                    <div class="mt-3 p-3 bg-gray-800 rounded border border-gray-600" x-show="bump.enabled">
                                        <h5 class="text-xs font-semibold text-gray-300 mb-2">Preview do Order Bump</h5>
                                        <div class="bg-gray-900 p-2 rounded text-sm">
                                            <div class="text-white mb-1" x-text="bump.message || 'Mensagem do order bump'"></div>
                                            <div class="text-gray-400 text-xs mb-2" x-text="bump.description || 'Descrição'"></div>
                                            <div class="flex gap-2">
                                                <button class="px-3 py-1 bg-green-600 text-white rounded text-xs" x-text="bump.accept_text || 'Sim, eu quero!'"></button>
                                                <button class="px-3 py-1 bg-gray-600 text-white rounded text-xs" x-text="bump.decline_text || 'Não, obrigado'"></button>
                                            </div>
                                            <div class="text-yellow-400 text-xs mt-2" x-show="bump.price">
                                                + R$ <span x-text="bump.price?.toFixed(2) || '0.00'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Subscriptions Tab -->
        <div x-show="activeTab === 'subscriptions'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Assinaturas VIP</h2>
            </div>
            <p class="text-gray-400 mb-4">Configure assinaturas VIP para os botões principais. Os usuários que comprarem receberão acesso ao grupo VIP pelo período configurado.</p>
            
            <div class="space-y-6">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">
                                Botão: <span x-text="button.text || 'Sem nome'"></span>
                            </h3>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" x-model="button.subscription.enabled" />
                                <span class="form-label">Habilitar Assinatura VIP</span>
                            </label>
                        </div>

                        <div x-show="button.subscription.enabled" class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Duração</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <select x-model="button.subscription.duration_type" class="form-select">
                                            <option value="hours">Horas</option>
                                            <option value="days">Dias</option>
                                            <option value="weeks">Semanas</option>
                                            <option value="months">Meses</option>
                                        </select>
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            x-model.number="button.subscription.duration_value" 
                                            class="form-input" 
                                            placeholder="Ex: 30"
                                            min="1"
                                        />
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2" x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                    Duração: <strong x-text="button.subscription.duration_value"></strong> 
                                    <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'mês' : 'meses')"></span>
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ID do Grupo VIP (Telegram)</label>
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        x-model="button.subscription.vip_chat_id" 
                                        class="form-input"
                                        placeholder="-1001234567890 ou https://t.me/joinchat/..."
                                        :class="{
                                            'border-green-500': button.subscription.validation_status === 'valid',
                                            'border-red-500': button.subscription.validation_status === 'invalid',
                                            'border-yellow-500': button.subscription.validation_status === 'validating',
                                            'border-gray-600': !button.subscription.validation_status
                                        }"
                                    />
                                    <i class="fas fa-check-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500" 
                                       x-show="button.subscription.validation_status === 'valid'"></i>
                                    <i class="fas fa-times-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500" 
                                       x-show="button.subscription.validation_status === 'invalid'"></i>
                                    <i class="fas fa-spinner fa-spin absolute right-3 top-1/2 transform -translate-y-1/2 text-yellow-500" 
                                       x-show="button.subscription.validation_status === 'validating'"></i>
                                </div>
                                <button 
                                    @click="validateSubscription(index)" 
                                    class="btn btn-secondary mt-2"
                                    :disabled="button.subscription.validation_status === 'validating' || !button.subscription.vip_chat_id"
                                >
                                    <i class="fas fa-check"></i> 
                                    <span x-show="button.subscription.validation_status !== 'validating'">Verificar se o Grupo está OK</span>
                                    <span x-show="button.subscription.validation_status === 'validating'">Verificando...</span>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Link do Grupo VIP (Alternativo)</label>
                                <input 
                                    type="text" 
                                    x-model="button.subscription.vip_group_link" 
                                    class="form-input"
                                    placeholder="https://t.me/joinchat/... ou https://t.me/c/..."
                                />
                            </div>

                            <div class="bg-yellow-500 bg-opacity-10 border border-yellow-400 border-opacity-30 rounded-lg p-4" 
                                 x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                <p class="text-sm text-yellow-300">
                                    <i class="fas fa-info-circle"></i> 
                                    Usuários que comprarem este produto terão acesso ao grupo VIP por 
                                    <strong x-text="button.subscription.duration_value"></strong> 
                                    <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'mês' : 'meses')"></span>.
                                </p>
                            </div>

                            <!-- Preview da Assinatura -->
                            <div class="mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
                                <h4 class="text-sm font-semibold text-gray-300 mb-2">Preview da Assinatura VIP</h4>
                                <div class="bg-gray-900 p-3 rounded border border-gray-600">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-crown text-yellow-400"></i>
                                        <span class="text-white font-semibold">Acesso VIP</span>
                                    </div>
                                    <div class="text-gray-400 text-sm" x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                        Duração: <span class="text-white" x-text="button.subscription.duration_value"></span> 
                                        <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'mês' : 'meses')"></span>
                                    </div>
                                    <div class="text-gray-400 text-sm" x-show="button.subscription.vip_chat_id || button.subscription.vip_group_link">
                                        <i class="fas fa-check-circle text-green-400"></i> Grupo configurado
                                    </div>
                                    <div class="text-gray-400 text-sm" x-show="!button.subscription.vip_chat_id && !button.subscription.vip_group_link">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i> Grupo não configurado
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Downsells Tab -->
        <div x-show="activeTab === 'downsells'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Downsells</h2>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="config.downsells_enabled" />
                        <span class="form-label">Habilitar Downsells</span>
                    </label>
                    <button @click="addDownsell()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Adicionar Downsell
                    </button>
                </div>
            </div>

            <div x-show="config.downsells_enabled" class="space-y-6 mt-4">
                <template x-for="(downsell, index) in config.downsells" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Downsell <span x-text="index + 1"></span></h3>
                            <button @click="removeDownsell(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Delay (minutos)</label>
                            <input type="number" x-model.number="downsell.delay_minutes" class="form-input" min="0" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mensagem</label>
                            <textarea x-model="downsell.message" class="form-textarea"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Modo de Preço</label>
                            <select x-model="downsell.pricing_mode" class="form-select">
                                <option value="fixed">Fixo</option>
                                <option value="percentage">Porcentagem</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" x-text="downsell.pricing_mode === 'percentage' ? 'Desconto (%)' : 'Preço (R$)'"></label>
                            <input 
                                type="number" 
                                x-model.number="downsell.pricing_mode === 'percentage' ? downsell.discount_percentage : downsell.price" 
                                class="form-input" 
                                step="0.01" 
                                min="0" 
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Botão</label>
                            <input type="text" x-model="downsell.button_text" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tipo de Mídia</label>
                            <select x-model="downsell.media_type" class="form-select">
                                <option value="video">Vídeo</option>
                                <option value="photo">Foto</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL da Mídia</label>
                            <input type="text" x-model="downsell.media_url" class="form-input" placeholder="https://..." />
                        </div>

                        <div class="form-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" x-model="downsell.audio_enabled" />
                                <span class="form-label">Habilitar Áudio Complementar</span>
                            </label>
                        </div>

                        <div x-show="downsell.audio_enabled" class="form-group">
                            <label class="form-label">URL do Áudio</label>
                            <input type="text" x-model="downsell.audio_url" class="form-input" placeholder="https://..." />
                        </div>

                        <!-- Order Bump do Downsell -->
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold text-white">Order Bump (Opcional)</h4>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" x-model="downsell.order_bump.enabled" />
                                    <span class="form-label">Habilitar Order Bump</span>
                                </label>
                            </div>

                            <div x-show="downsell.order_bump.enabled" class="space-y-4">
                                <!-- Opção: Usar Order Bump dos Botões Principais -->
                                <div class="form-group">
                                    <label class="form-label">Usar Order Bump Existente</label>
                                    <select 
                                        @change="if ($event.target.value) { const [btnIdx, bumpIdx] = $event.target.value.split('_').map(Number); useOrderBumpFromButtons(downsell, btnIdx, bumpIdx); }"
                                        class="form-select"
                                    >
                                        <option value="">Criar novo Order Bump</option>
                                        <template x-for="(button, btnIdx) in config.main_buttons" :key="btnIdx">
                                            <template x-for="(bump, bumpIdx) in (button.order_bumps || [])" :key="bumpIdx">
                                                <option :value="`${btnIdx}_${bumpIdx}`" x-text="button.text + ' - Order Bump ' + (bumpIdx + 1)"></option>
                                            </template>
                                        </template>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Mensagem do Order Bump</label>
                                    <textarea x-model="downsell.order_bump.message" class="form-textarea"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Preço do Order Bump (R$)</label>
                                    <input type="number" x-model.number="downsell.order_bump.price" class="form-input" step="0.01" min="0" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Descrição</label>
                                    <textarea x-model="downsell.order_bump.description" class="form-textarea"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Tipo de Mídia</label>
                                    <select x-model="downsell.order_bump.media_type" class="form-select">
                                        <option value="video">Vídeo</option>
                                        <option value="photo">Foto</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">URL da Mídia</label>
                                    <input type="text" x-model="downsell.order_bump.media_url" class="form-input" placeholder="https://..." />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Texto do Botão Aceitar</label>
                                    <input type="text" x-model="downsell.order_bump.accept_text" class="form-input" placeholder="Sim, eu quero!" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Texto do Botão Recusar</label>
                                    <input type="text" x-model="downsell.order_bump.decline_text" class="form-input" placeholder="Não, obrigado" />
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Upsells Tab -->
        <div x-show="activeTab === 'upsells'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Upsells</h2>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="config.upsells_enabled" />
                        <span class="form-label">Habilitar Upsells</span>
                    </label>
                    <button @click="addUpsell()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Adicionar Upsell
                    </button>
                </div>
            </div>

            <div x-show="config.upsells_enabled" class="space-y-6 mt-4">
                <template x-for="(upsell, index) in config.upsells" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Upsell <span x-text="index + 1"></span></h3>
                            <button @click="removeUpsell(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Produto Trigger</label>
                            <input type="text" x-model="upsell.trigger_product" class="form-input" placeholder="Nome do produto que dispara este upsell" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Delay (minutos)</label>
                            <input type="number" x-model.number="upsell.delay_minutes" class="form-input" min="0" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mensagem</label>
                            <textarea x-model="upsell.message" class="form-textarea"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Preço (R$)</label>
                            <input type="number" x-model.number="upsell.price" class="form-input" step="0.01" min="0" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nome do Produto</label>
                            <input type="text" x-model="upsell.product_name" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Botão</label>
                            <input type="text" x-model="upsell.button_text" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Link de Acesso</label>
                            <input type="text" x-model="upsell.access_link" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tipo de Mídia</label>
                            <select x-model="upsell.media_type" class="form-select">
                                <option value="video">Vídeo</option>
                                <option value="photo">Foto</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL da Mídia</label>
                            <input type="text" x-model="upsell.media_url" class="form-input" placeholder="https://..." />
                        </div>

                        <div class="form-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" x-model="upsell.audio_enabled" />
                                <span class="form-label">Habilitar Áudio Complementar</span>
                            </label>
                        </div>

                        <div x-show="upsell.audio_enabled" class="form-group">
                            <label class="form-label">URL do Áudio</label>
                            <input type="text" x-model="upsell.audio_url" class="form-input" placeholder="https://..." />
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Redirect Tab -->
        <div x-show="activeTab === 'redirect'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Botões de Redirecionamento</h2>
                <button @click="addRedirectButton()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Botão
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(button, index) in config.redirect_buttons" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Botão <span x-text="index + 1"></span></h3>
                            <button @click="removeRedirectButton(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Botão</label>
                            <input type="text" x-model="button.text" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="text" x-model="button.url" class="form-input" placeholder="https://..." />
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Flow Tab -->
        <div x-show="activeTab === 'flow'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Fluxo Visual</h2>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="config.flow_enabled" @change="onFlowToggle()" />
                        <span class="form-label">Habilitar Fluxo Visual</span>
                    </label>
                    <button @click="addFlowStep()" class="btn btn-primary" :disabled="!config.flow_enabled">
                        <i class="fas fa-plus"></i> Adicionar Step
                    </button>
                </div>
            </div>

            <div x-show="config.flow_enabled" class="mt-4">
                <div 
                    id="flow-visual-canvas" 
                    style="width: 100%; height: 600px; border: 1px solid #242836; border-radius: 8px;"
                    x-init="
                        if (config.flow_enabled && activeTab === 'flow') {
                            setTimeout(() => {
                                if (typeof FlowEditor !== 'undefined' && !window.flowEditor) {
                                    initVisualFlowEditor();
                                } else if (window.flowEditor && window.flowEditor.instance) {
                                    window.flowEditor.renderAllSteps();
                                    window.flowEditor.revalidateConnections();
                                }
                            }, 400);
                        }
                    "
                ></div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div x-show="activeTab === 'settings'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Configurações Gerais</h2>
            </div>

            <div class="form-group">
                <label class="form-label">Link de Acesso</label>
                <input type="text" x-model="config.access_link" class="form-input" placeholder="https://..." />
            </div>

            <div class="form-group">
                <label class="form-label">Mensagem de Sucesso</label>
                <textarea x-model="config.success_message" class="form-textarea"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Mensagem Pendente</label>
                <textarea x-model="config.pending_message" class="form-textarea"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Novo Token do Bot</label>
                <input type="text" x-model="new_bot_token" class="form-input" placeholder="123456789:ABCdef..." />
                <button @click="changeBotToken()" class="btn btn-primary mt-2" :disabled="!isValidBotToken(new_bot_token)">
                    <i class="fas fa-save"></i> Atualizar Token
                </button>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="mt-6 flex justify-end">
        <button @click="saveConfig()" class="btn btn-primary" :disabled="loading">
            <i class="fas fa-save"></i> Salvar Configuração
        </button>
    </div>

    <!-- Modal de Edição de Step -->
    <div x-show="showStepModal" class="modal" @click.self="closeStepModal()">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Editar Step</h3>
                <button @click="closeStepModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div x-show="editingStep" class="space-y-4">
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select x-model="editingStep.type" class="form-select">
                        <option value="message">Mensagem</option>
                        <option value="content">Conteúdo</option>
                        <option value="audio">Áudio</option>
                        <option value="video">Vídeo</option>
                        <option value="buttons">Botões</option>
                        <option value="payment">Pagamento</option>
                        <option value="access">Acesso</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Mensagem</label>
                    <textarea x-model="editingStep.config.message" class="form-textarea" placeholder="Digite a mensagem do step..."></textarea>
                </div>

                <div class="form-group" x-show="editingStep.type === 'message' || editingStep.type === 'content' || editingStep.type === 'video' || editingStep.type === 'audio'">
                    <label class="form-label">URL da Mídia</label>
                    <input type="text" x-model="editingStep.config.media_url" class="form-input" placeholder="https://..." />
                </div>

                <div class="form-group" x-show="editingStep.type === 'message' || editingStep.type === 'content' || editingStep.type === 'video'">
                    <label class="form-label">Tipo de Mídia</label>
                    <select x-model="editingStep.config.media_type" class="form-select">
                        <option value="video">Vídeo</option>
                        <option value="photo">Foto</option>
                    </select>
                </div>

                <div class="form-group" x-show="editingStep.type === 'audio'">
                    <label class="form-label">URL do Áudio</label>
                    <input type="text" x-model="editingStep.config.audio_url" class="form-input" placeholder="https://..." />
                </div>

                <div class="form-group" x-show="editingStep.type === 'payment'">
                    <label class="form-label">Preço (R$)</label>
                    <input type="number" x-model.number="editingStep.config.price" class="form-input" step="0.01" min="0" />
                </div>

                <div class="form-group" x-show="editingStep.type === 'payment'">
                    <label class="form-label">Nome do Produto</label>
                    <input type="text" x-model="editingStep.config.product_name" class="form-input" />
                </div>

                <div class="form-group" x-show="editingStep.type === 'access'">
                    <label class="form-label">Link de Acesso</label>
                    <input type="text" x-model="editingStep.config.access_link" class="form-input" placeholder="https://..." />
                </div>

                <div class="form-group">
                    <label class="form-label">Delay (segundos)</label>
                    <input type="number" x-model.number="editingStep.delay_seconds" class="form-input" min="0" />
                </div>

                <div class="form-group">
                    <label class="form-label">Título do Step (Opcional)</label>
                    <input type="text" x-model="editingStep.title" class="form-input" placeholder="Deixe vazio para usar tipo padrão" />
                </div>

                <!-- Conexões -->
                <div class="border-t border-gray-700 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-white">Conexões</h4>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Próximo Step (Next)</label>
                        <select x-model="editingStep.connections.next" class="form-select">
                            <option value="">Nenhum</option>
                            <template x-for="step in getAvailableStepsForConnection(editingStep.id)" :key="step.id">
                                <option :value="step.id" x-text="getStepTypeLabel(step.type) + ' - ' + (step.config?.message?.substring(0, 30) || step.id)"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Step Pendente (Pending)</label>
                        <select x-model="editingStep.connections.pending" class="form-select">
                            <option value="">Nenhum</option>
                            <template x-for="step in getAvailableStepsForConnection(editingStep.id)" :key="step.id">
                                <option :value="step.id" x-text="getStepTypeLabel(step.type) + ' - ' + (step.config?.message?.substring(0, 30) || step.id)"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Step de Retry (Retry)</label>
                        <select x-model="editingStep.connections.retry" class="form-select">
                            <option value="">Nenhum</option>
                            <template x-for="step in getAvailableStepsForConnection(editingStep.id)" :key="step.id">
                                <option :value="step.id" x-text="getStepTypeLabel(step.type) + ' - ' + (step.config?.message?.substring(0, 30) || step.id)"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <!-- Condições -->
                <div class="border-t border-gray-700 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-white">Condições</h4>
                        <button @click="addCondition()" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Adicionar Condição
                        </button>
                    </div>

                    <template x-for="(condition, condIndex) in (editingStep.conditions || [])" :key="condition.id || condIndex">
                        <div class="border border-gray-600 rounded p-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Condição <span x-text="condIndex + 1"></span></span>
                                <button @click="removeCondition(condIndex)" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Condição</label>
                                <select x-model="condition.type" class="form-select">
                                    <option value="text_validation">Validação de Texto</option>
                                    <option value="button_click">Clique em Botão</option>
                                    <option value="payment_status">Status de Pagamento</option>
                                    <option value="time_elapsed">Tempo Decorrido</option>
                                </select>
                            </div>

                            <div class="form-group" x-show="condition.type === 'text_validation'">
                                <label class="form-label">Validação</label>
                                <select x-model="condition.validation" class="form-select">
                                    <option value="any">Qualquer texto</option>
                                    <option value="exact">Texto exato</option>
                                    <option value="contains">Contém texto</option>
                                </select>
                            </div>

                            <div class="form-group" x-show="condition.type === 'text_validation' && condition.validation !== 'any'">
                                <label class="form-label">Texto de Validação</label>
                                <input type="text" x-model="condition.text" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Step de Destino</label>
                                <select x-model="condition.target_step" class="form-select">
                                    <option value="">Nenhum</option>
                                    <template x-for="step in getAvailableStepsForConnection(editingStep.id)" :key="step.id">
                                        <option :value="step.id" x-text="getStepTypeLabel(step.type) + ' - ' + (step.config?.message?.substring(0, 30) || step.id)"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Botões Customizados -->
                <div class="border-t border-gray-700 pt-4" x-show="editingStep.type === 'buttons'">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-white">Botões Customizados</h4>
                        <button @click="addCustomButton()" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Adicionar Botão
                        </button>
                    </div>

                    <template x-for="(btn, btnIndex) in (editingStep.config.custom_buttons || [])" :key="btnIndex">
                        <div class="border border-gray-600 rounded p-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Botão <span x-text="btnIndex + 1"></span></span>
                                <button @click="removeCustomButton(btnIndex)" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Texto do Botão</label>
                                <input type="text" x-model="btn.text" class="form-input" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Step de Destino</label>
                                <select x-model="btn.target_step" class="form-select">
                                    <option value="">Nenhum</option>
                                    <template x-for="step in getAvailableStepsForConnection(editingStep.id)" :key="step.id">
                                        <option :value="step.id" x-text="getStepTypeLabel(step.type) + ' - ' + (step.config?.message?.substring(0, 30) || step.id)"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                    <button @click="closeStepModal()" class="btn btn-secondary">Cancelar</button>
                    <button @click="saveStep()" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Flow Editor JS -->
<script src="{{ url_for('static', filename='js/flow_editor.js') }}?v=2.0.1"></script>
<script>
function botConfigApp() {
    return {
        bot_id: {{ bot.id }},
        loading: false,
        activeTab: 'welcome',
        config: {
            id: null,
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            welcome_audio_enabled: false,
            welcome_audio_url: '',
            main_buttons: [],
            redirect_buttons: [],
            downsells_enabled: false,
            downsells: [],
            upsells_enabled: false,
            upsells: [],
            access_link: '',
            success_message: '',
            pending_message: '',
            flow_enabled: false,
            flow_steps: [],
            flow_start_step_id: null,
            has_meta_pixel: false
        },
        new_bot_token: '',
        subscriptionGuideExpanded: false,
        subscriptionGuideTab: 'telegram',
        showStepModal: false,
        editingStep: null,
        editingStepIndex: -1,

        async init() {
            await this.loadConfig();
            this.watchFlowSteps();
        },

        async loadConfig() {
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                console.log('📦 Dados carregados da API:', data);
                
                if (data && typeof data === 'object') {
                    this.config.id = data.id || null;
                    this.config.welcome_message = data.welcome_message || '';
                    this.config.welcome_media_url = data.welcome_media_url || '';
                    this.config.welcome_media_type = data.welcome_media_type || 'video';
                    this.config.welcome_audio_enabled = data.welcome_audio_enabled || false;
                    this.config.welcome_audio_url = data.welcome_audio_url || '';
                    
                    const defaultSubscription = {
                        enabled: false,
                        duration_type: 'days',
                        duration_value: null,
                        vip_chat_id: '',
                        vip_group_link: '',
                        validation_status: null
                    };
                    
                    this.config.main_buttons = (data.main_buttons || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.redirect_buttons = data.redirect_buttons || [];
                    this.config.downsells_enabled = data.downsells_enabled || false;
                    this.config.downsells = (data.downsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.upsells_enabled = data.upsells_enabled || false;
                    this.config.upsells = (data.upsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.access_link = data.access_link || '';
                    this.config.success_message = data.success_message || '';
                    this.config.pending_message = data.pending_message || '';
                    this.config.flow_enabled = data.flow_enabled || false;
                    this.config.flow_steps = data.flow_steps || [];
                    this.config.flow_start_step_id = data.flow_start_step_id || null;
                    this.config.has_meta_pixel = data.has_meta_pixel || false;
                    
                    console.log('✅ Configuração carregada:', {
                        buttons: this.config.main_buttons?.length || 0,
                        downsells: this.config.downsells?.length || 0,
                        upsells: this.config.upsells?.length || 0
                    });

                    if (this.config.flow_enabled) {
                        this.$nextTick(() => {
                            setTimeout(() => {
                                this.initVisualFlowEditor();
                            }, 300);
                        });
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao carregar configuração:', error);
                alert('Erro ao carregar configuração. Recarregue a página.');
            } finally {
                this.loading = false;
            }
        },

        async saveConfig() {
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.config)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                if (data && typeof data === 'object' && !data.error) {
                    alert('Configuração salva com sucesso!');
                    Object.assign(this.config, data);
                } else {
                    alert(data.error || 'Erro ao salvar configuração');
                }
            } catch (error) {
                console.error('Erro ao salvar configuração:', error);
                alert(error.message || 'Erro ao salvar configuração');
            } finally {
                this.loading = false;
            }
        },

        addButton() {
            if (!this.config.main_buttons) {
                this.config.main_buttons = [];
            }
            this.config.main_buttons.push({
                text: '',
                price: null,
                description: '',
                order_bumps: [],
                subscription: {
                    enabled: false,
                    duration_type: 'days',
                    duration_value: null,
                    vip_chat_id: '',
                    vip_group_link: '',
                    validation_status: null
                }
            });
        },

        removeButton(index) {
            if (this.config.main_buttons && this.config.main_buttons[index]) {
                this.config.main_buttons.splice(index, 1);
            }
        },

        addOrderBump(buttonIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            if (!this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps = [];
            }
            this.config.main_buttons[buttonIndex].order_bumps.push({
                enabled: false,
                message: '',
                price: null,
                description: '',
                media_url: '',
                media_type: 'video',
                accept_text: 'Sim, eu quero!',
                decline_text: 'Não, obrigado'
            });
        },

        removeOrderBump(buttonIndex, bumpIndex) {
            if (this.config.main_buttons && 
                this.config.main_buttons[buttonIndex] && 
                this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps.splice(bumpIndex, 1);
            }
        },

        validateProductField(index, field) {
            if (!this.config.main_buttons || !this.config.main_buttons[index]) return;
            const button = this.config.main_buttons[index];
            if (field === 'text' && button.text) {
                button.text = button.text.trim().slice(0, 64);
            } else if (field === 'price' && button.price !== null) {
                button.price = Math.max(0, parseFloat(button.price) || 0);
            }
        },

        async validateSubscription(buttonIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            const button = this.config.main_buttons[buttonIndex];
            if (!button.subscription || !button.subscription.enabled) return;

            const vipChatId = button.subscription.vip_chat_id;
            if (!vipChatId) {
                button.subscription.validation_status = 'invalid';
                return;
            }

            try {
                const response = await fetch(`/api/bots/${this.bot_id}/validate-subscription`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vip_chat_id: vipChatId
                    })
                });
                const data = await response.json();
                if (data.success && data.is_valid) {
                    button.subscription.validation_status = 'valid';
                } else {
                    button.subscription.validation_status = 'invalid';
                }
            } catch (error) {
                console.error('Erro ao validar assinatura:', error);
                button.subscription.validation_status = 'invalid';
            }
        },

        setFlowStartStep(stepId) {
            this.config.flow_start_step_id = stepId;
        },

        get sortedFlowSteps() {
            if (!this.config.flow_steps) return [];
            return [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
        },

        async changeBotToken() {
            if (!this.new_bot_token || !this.isValidBotToken(this.new_bot_token)) {
                alert('Token inválido');
                return;
            }
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/token`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: this.new_bot_token
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Token atualizado com sucesso!');
                    this.new_bot_token = '';
                    location.reload();
                } else {
                    alert(data.error || 'Erro ao atualizar token');
                }
            } catch (error) {
                console.error('Erro ao atualizar token:', error);
                alert('Erro ao atualizar token');
            } finally {
                this.loading = false;
            }
        },

        isValidBotToken(token) {
            return token && token.length >= 30 && token.length <= 45 && token.includes(':');
        },

        stripSurrogateChars(value) {
            return window.stripSurrogateChars ? window.stripSurrogateChars(value) : (value || '');
        },

        addDownsell() {
            if (!this.config.downsells) {
                this.config.downsells = [];
            }
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                price: null,
                pricing_mode: 'fixed',
                discount_percentage: null,
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                order_bump: {
                    enabled: false,
                    message: '',
                    price: null,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: 'Sim, eu quero!',
                    decline_text: 'Não, obrigado',
                    button_index: null,
                    bump_index: null
                }
            });
        },

        removeDownsell(index) {
            if (this.config.downsells && this.config.downsells[index]) {
                this.config.downsells.splice(index, 1);
            }
        },

        addUpsell() {
            if (!this.config.upsells) {
                this.config.upsells = [];
            }
            this.config.upsells.push({
                trigger_product: '',
                delay_minutes: 0,
                message: '',
                price: null,
                product_name: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                access_link: ''
            });
        },

        removeUpsell(index) {
            if (this.config.upsells && this.config.upsells[index]) {
                this.config.upsells.splice(index, 1);
            }
        },

        addRedirectButton() {
            if (!this.config.redirect_buttons) {
                this.config.redirect_buttons = [];
            }
            this.config.redirect_buttons.push({
                text: '',
                url: ''
            });
        },

        removeRedirectButton(index) {
            if (this.config.redirect_buttons && this.config.redirect_buttons[index]) {
                this.config.redirect_buttons.splice(index, 1);
            }
        },

        useOrderBumpFromButtons(downsell, buttonIndex, bumpIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            const button = this.config.main_buttons[buttonIndex];
            if (!button.order_bumps || !button.order_bumps[bumpIndex]) return;
            
            const orderBump = button.order_bumps[bumpIndex];
            
            if (!downsell.order_bump) {
                downsell.order_bump = {};
            }
            
            downsell.order_bump.enabled = true;
            downsell.order_bump.message = orderBump.message || '';
            downsell.order_bump.price = orderBump.price || null;
            downsell.order_bump.description = orderBump.description || '';
            downsell.order_bump.media_url = orderBump.media_url || '';
            downsell.order_bump.media_type = orderBump.media_type || 'video';
            downsell.order_bump.accept_text = orderBump.accept_text || 'Sim, eu quero!';
            downsell.order_bump.decline_text = orderBump.decline_text || 'Não, obrigado';
            downsell.order_bump.button_index = buttonIndex;
            downsell.order_bump.bump_index = bumpIndex;
        },

        onFlowToggle() {
            console.log('Flow enabled:', this.config.flow_enabled);
            
            if (this.config.flow_enabled) {
                this.$nextTick(() => {
                    setTimeout(() => {
                        this.initVisualFlowEditor();
                    }, 200);
                });
            } else {
                if (window.flowEditor) {
                    try {
                        window.flowEditor.destroy();
                        window.flowEditor = null;
                    } catch (e) {
                        console.warn('⚠️ Erro ao destruir editor:', e);
                    }
                }
            }
        },

        initVisualFlowEditor() {
            if (!this.config.flow_enabled) {
                console.log('ℹ️ Flow desabilitado - não inicializando editor');
                return;
            }
            
            this.$nextTick(() => {
                const canvas = document.getElementById('flow-visual-canvas');
                if (!canvas) {
                    console.error('❌ Canvas não encontrado');
                    return;
                }
                
                if (typeof jsPlumb === 'undefined') {
                    console.error('❌ jsPlumb não está disponível');
                    return;
                }
                
                if (window.flowEditor) {
                    try {
                        window.flowEditor.destroy();
                    } catch (e) {
                        console.warn('⚠️ Erro ao destruir editor anterior:', e);
                    }
                }
                
                try {
                    if (typeof FlowEditor === 'undefined') {
                        console.error('❌ FlowEditor não está disponível. Verifique se flow_editor.js foi carregado.');
                        return;
                    }
                    
                    window.flowEditor = new FlowEditor('flow-visual-canvas', this);
                    console.log('✅ Editor visual inicializado');
                } catch (error) {
                    console.error('❌ Erro ao inicializar editor:', error);
                    console.error('Stack:', error.stack);
                    setTimeout(() => {
                        try {
                            window.flowEditor = new FlowEditor('flow-visual-canvas', this);
                            console.log('✅ Editor visual inicializado (tentativa 2)');
                        } catch (e2) {
                            console.error('❌ Erro na tentativa 2:', e2);
                        }
                    }, 1000);
                }
            });
        },
        
        openStepModal(stepId) {
            if (!this.config.flow_steps) {
                console.error('❌ flow_steps não existe');
                return;
            }
            
            const step = this.config.flow_steps.find(s => String(s.id) === String(stepId));
            if (!step) {
                console.error(`❌ Step ${stepId} não encontrado`);
                return;
            }
            
            this.editingStepIndex = this.config.flow_steps.indexOf(step);
            
            this.editingStep = JSON.parse(JSON.stringify(step));
            
            if (!this.editingStep.connections) {
                this.editingStep.connections = {};
            }
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            if (!this.editingStep.position) {
                this.editingStep.position = { x: 100, y: 100 };
            }
            
            this.showStepModal = true;
        },
        
        closeStepModal() {
            this.showStepModal = false;
            this.editingStep = null;
            this.editingStepIndex = -1;
        },
        
        saveStep() {
            if (!this.editingStep || this.editingStepIndex === -1) {
                alert('Erro: Step não encontrado');
                return;
            }
            
            if (!this.editingStep.type) {
                alert('Tipo do step é obrigatório');
                return;
            }
            
            if (!this.editingStep.connections) {
                this.editingStep.connections = {};
            }
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            if (!this.editingStep.position) {
                const existingStep = this.config.flow_steps[this.editingStepIndex];
                this.editingStep.position = existingStep.position || { x: 100, y: 100 };
            }
            
            const existingStep = this.config.flow_steps[this.editingStepIndex];
            this.config.flow_steps[this.editingStepIndex] = {
                ...existingStep,
                ...this.editingStep,
                id: existingStep.id,
                position: this.editingStep.position || existingStep.position || { x: 100, y: 100 },
                connections: this.editingStep.connections || {},
                config: this.editingStep.config || {},
                conditions: this.editingStep.conditions || []
            };
            
            this.$nextTick(() => {
                if (window.flowEditor) {
                    window.flowEditor.renderAllSteps();
                }
            });
            
            this.closeStepModal();
        },
        
        addFlowStep() {
            console.log('🔵 addFlowStep() chamado');
            
            if (!this.config.flow_steps) {
                this.config.flow_steps = [];
            }
            
            if (!this.config.flow_enabled) {
                this.config.flow_enabled = true;
                console.log('✅ Flow habilitado automaticamente');
            }
            
            const stepId = `step_${Date.now()}`;
            
            const existingSteps = this.config.flow_steps.length;
            const cols = Math.ceil(Math.sqrt(existingSteps + 1));
            const row = Math.floor(existingSteps / cols);
            const col = existingSteps % cols;
            
            const newStep = {
                id: stepId,
                type: 'message',
                order: existingSteps,
                config: {
                    message: '',
                    media_url: '',
                    media_type: 'video'
                },
                connections: {},
                conditions: [],
                delay_seconds: 0,
                position: {
                    x: 100 + (col * 280),
                    y: 100 + (row * 180)
                }
            };
            
            this.config.flow_steps.push(newStep);
            console.log('✅ Step adicionado:', stepId, 'Total:', this.config.flow_steps.length);
            
            this.$nextTick(() => {
                console.log('🔄 $nextTick executado, aguardando DOM...');
                setTimeout(() => {
                    console.log('🔄 Timeout executado, verificando editor...');
                    if (!window.flowEditor) {
                        console.log('🆕 Inicializando editor...');
                        this.initVisualFlowEditor();
                    } else {
                        console.log('🔄 Re-renderizando steps...');
                        try {
                            window.flowEditor.renderAllSteps();
                            console.log('✅ Steps re-renderizados');
                        } catch (e) {
                            console.error('❌ Erro ao re-renderizar:', e);
                            this.initVisualFlowEditor();
                        }
                    }
                }, 500);
            });
        },
        
        removeFlowStep(stepId) {
            if (window.flowEditor) {
                window.flowEditor.deleteStep(stepId);
            }
        },
        
        addCondition() {
            if (!this.editingStep) return;
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            this.editingStep.conditions.push({
                id: `cond_${Date.now()}`,
                type: 'text_validation',
                validation: 'any',
                target_step: '',
                order: this.editingStep.conditions.length
            });
        },
        
        removeCondition(index) {
            if (!this.editingStep || !this.editingStep.conditions) return;
            this.editingStep.conditions.splice(index, 1);
        },
        
        addCustomButton() {
            if (!this.editingStep) return;
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.config.custom_buttons) {
                this.editingStep.config.custom_buttons = [];
            }
            this.editingStep.config.custom_buttons.push({
                text: '',
                target_step: ''
            });
        },
        
        removeCustomButton(index) {
            if (!this.editingStep || !this.editingStep.config || !this.editingStep.config.custom_buttons) return;
            this.editingStep.config.custom_buttons.splice(index, 1);
        },
        
        watchFlowSteps() {
            this.$watch('config.flow_steps', (newSteps, oldSteps) => {
                if (window.flowEditor && newSteps) {
                    clearTimeout(this._flowStepsWatchTimeout);
                    this._flowStepsWatchTimeout = setTimeout(() => {
                        window.flowEditor.renderAllSteps();
                    }, 100);
                }
            }, { deep: true });
        },
        
        getStepTypeLabel(type) {
            const labels = {
                content: 'Conteúdo',
                message: 'Mensagem',
                audio: 'Áudio',
                video: 'Vídeo',
                buttons: 'Botões',
                payment: 'Pagamento',
                access: 'Acesso'
            };
            return labels[type] || type;
        },
        
        getStepTypeIcon(type) {
            const icons = {
                content: 'fa-file-alt',
                message: 'fa-comment',
                audio: 'fa-headphones',
                video: 'fa-video',
                buttons: 'fa-mouse-pointer',
                payment: 'fa-credit-card',
                access: 'fa-key'
            };
            return icons[type] || 'fa-circle';
        },
        
        getConditionTypeLabel(type) {
            const labels = {
                text_validation: 'Validação de Texto',
                button_click: 'Clique em Botão',
                payment_status: 'Status de Pagamento',
                time_elapsed: 'Tempo Decorrido'
            };
            return labels[type] || type;
        },

        getAvailableStepsForConnection(currentStepId) {
            if (!this.config.flow_steps) return [];
            return this.config.flow_steps.filter(step => String(step.id) !== String(currentStepId));
        },

        getWelcomeMessageLength() {
            const baseLength = (this.config.welcome_message || '').length;
            const mediaLength = this.config.welcome_media_url ? 200 : 0;
            return baseLength + mediaLength;
        },

        validateWelcomeMessage() {
            // Validação já feita via getWelcomeMessageLength()
        }
    };
}
</script>
{% endblock %}
