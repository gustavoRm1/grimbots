{% extends "base.html" %}
{% block title %}Configurar Bot - {{ bot.name }}{% endblock %}

{% block extra_head %}
<style>
/* ✅ Editor Visual de Fluxo - jsPlumb Styles */
.connection-label {
    background: rgba(0, 0, 0, 0.8);
    color: #FFFFFF;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    pointer-events: none;
}

.flow-step-block {
    transition: transform 0.2s, box-shadow 0.2s;
    min-width: 200px;
    max-width: 280px;
    width: 240px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    touch-action: none;
    -webkit-touch-callout: none;
}

/* ✅ Prevenir seleção de texto durante drag */
.flow-step-block.dragging {
    cursor: grabbing !important;
    user-select: none !important;
    pointer-events: all;
    opacity: 0.9;
    transform: scale(1.05);
    z-index: 1000 !important;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.8) !important;
}

.flow-step-block:not(.dragging) {
    cursor: move;
}

/* ✅ Garantir que botões dentro do card não sejam arrastáveis */
.flow-step-block button,
.flow-step-block input,
.flow-step-block textarea,
.flow-step-block select,
.flow-step-block a,
.flow-step-block i {
    cursor: pointer !important;
    pointer-events: auto !important;
    user-select: auto !important;
}

/* ✅ Prevenir que o canvas seja arrastável */
#flow-visual-canvas {
    user-select: none;
    -webkit-user-select: none;
    cursor: default;
    position: relative;
}

/* ✅ PAN: Cursor de arrasto quando estiver arrastando o canvas */
#flow-visual-canvas.panning {
    cursor: grabbing !important;
}

/* ✅ ZOOM: Garantir que elementos internos possam ser escalados */
#flow-visual-canvas .jtk-surface-canvas {
    transition: transform 0.1s ease-out;
}

/* ✅ Permitir seleção apenas em inputs dentro do canvas */
#flow-visual-canvas input,
#flow-visual-canvas textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

/* ✅ Estilos para drop zones durante drag de conexões */
.drop-hover {
    border-color: #10B981 !important;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.5) !important;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

.drop-active {
    border-color: #34D399 !important;
    box-shadow: 0 0 20px rgba(52, 211, 153, 0.7) !important;
    transform: scale(1.05);
}

/* ✅ Garantir que linhas de conexão sejam arrastáveis */
.jtk-connector {
    cursor: move !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
}

.jtk-endpoint-connected {
    cursor: crosshair !important;
}

/* ✅ Endpoints VERDE (entrada) e VERMELHO (saída) */
/* ✅ CRÍTICO: Ocultar endpoints jsPlumb padrão - usamos apenas elementos visuais HTML */
.jtk-endpoint {
    display: none !important; /* ✅ Ocultar endpoints jsPlumb - usamos apenas elementos visuais */
}

/* ✅ Estilos para blocos de steps no canvas - VERSÃO PROFISSIONAL */
.flow-step-block {
    position: absolute;
    width: 260px;
    min-height: 140px;
    background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
    border: 2px solid #374151;
    border-radius: 12px;
    box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 2px 4px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    cursor: move;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    animation: stepFadeIn 0.3s ease-out;
}

@keyframes stepFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.flow-step-block:hover {
    border-color: #4B5563;
    box-shadow: 
        0 8px 24px rgba(0, 0, 0, 0.5),
        0 4px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
}

.flow-step-block.dragging {
    cursor: grabbing !important;
    opacity: 0.95;
    transform: scale(1.08) rotate(1deg);
    z-index: 1000 !important;
    box-shadow: 
        0 16px 48px rgba(0, 0, 0, 0.6),
        0 8px 16px rgba(0, 0, 0, 0.4),
        0 0 0 4px rgba(59, 130, 246, 0.2);
    border-color: #3B82F6;
}

.flow-step-block.flow-step-initial {
    border-color: #FFB800;
    box-shadow: 
        0 0 0 3px rgba(255, 184, 0, 0.2),
        0 0 24px rgba(255, 184, 0, 0.4),
        0 8px 24px rgba(0, 0, 0, 0.5);
    animation: initialPulse 2s ease-in-out infinite;
}

@keyframes initialPulse {
    0%, 100% {
        box-shadow: 
            0 0 0 3px rgba(255, 184, 0, 0.2),
            0 0 24px rgba(255, 184, 0, 0.4),
            0 8px 24px rgba(0, 0, 0, 0.5);
    }
    50% {
        box-shadow: 
            0 0 0 4px rgba(255, 184, 0, 0.3),
            0 0 32px rgba(255, 184, 0, 0.6),
            0 8px 24px rgba(0, 0, 0, 0.5);
    }
}

.flow-step-block.flow-step-selected {
    border-color: #3B82F6;
    box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.2),
        0 8px 24px rgba(59, 130, 246, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.3);
}

.flow-step-header {
    padding: 14px 16px;
    border-radius: 10px 10px 0 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-weight: 700;
    position: relative;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    backdrop-filter: blur(10px);
}

.flow-step-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    font-size: 18px;
    box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s;
}

.flow-step-block:hover .flow-step-icon {
    transform: scale(1.1);
    box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.3);
}

.flow-step-title {
    flex: 1;
    font-size: 15px;
    letter-spacing: 0.3px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.flow-step-start-badge {
    font-size: 20px;
    animation: starPulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 4px rgba(255, 184, 0, 0.8));
}

@keyframes starPulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.15);
        opacity: 0.9;
    }
}

.flow-step-body {
    padding: 14px 16px;
    background: linear-gradient(180deg, #111827 0%, #0F172A 100%);
    min-height: 70px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.flow-step-preview {
    color: #9CA3AF;
    font-size: 12px;
    line-height: 1.5;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.flow-step-footer {
    padding: 10px 14px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    background: linear-gradient(180deg, #0F172A 0%, #111827 100%);
    border-radius: 0 0 10px 10px;
}

.flow-step-btn-edit,
.flow-step-btn-delete,
.flow-step-btn-start {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 13px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.flow-step-btn-edit {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
}

.flow-step-btn-edit:hover {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
}

.flow-step-btn-edit:active {
    transform: translateY(0);
}

.flow-step-btn-delete {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
    color: white;
}

.flow-step-btn-delete:hover {
    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
}

.flow-step-btn-delete:active {
    transform: translateY(0);
}

.flow-step-btn-start {
    background: linear-gradient(135deg, #FFB800 0%, #F59E0B 100%);
    color: #000;
    font-weight: bold;
}

.flow-step-btn-start:hover {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 184, 0, 0.4);
}

.flow-step-btn-start:active {
    transform: translateY(0);
}

/* ✅ Labels de conexão - ELEGANTES */
.connection-label {
    pointer-events: none;
    user-select: none;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 9px;
    padding: 3px 8px;
    border-radius: 12px;
    backdrop-filter: blur(8px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

/* ✅ Endpoints visíveis (quando necessário) - MELHORADOS */
.jtk-endpoint-connected {
    display: block !important;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #10B981;
    border: 3px solid white;
    box-shadow: 
        0 2px 6px rgba(0, 0, 0, 0.4),
        0 0 0 2px rgba(16, 185, 129, 0.3);
    transition: all 0.2s;
}

.jtk-endpoint-connected:hover {
    background: #34D399;
    transform: scale(1.3);
    box-shadow: 
        0 4px 12px rgba(16, 185, 129, 0.6),
        0 0 0 3px rgba(16, 185, 129, 0.4);
}

/* ✅ Grid Background para Canvas */
#flow-visual-canvas {
    background-image: 
        linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    background-position: 0 0, 0 0;
}

/* ✅ Melhorias nas conexões jsPlumb */
.jtk-connector {
    transition: stroke-width 0.2s, opacity 0.2s;
}

.jtk-connector:hover {
    stroke-width: 3 !important;
    opacity: 0.9 !important;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}

/* ✅ Animação ao criar conexão */
@keyframes connectionDraw {
    from {
        stroke-dasharray: 1000;
        stroke-dashoffset: 1000;
    }
    to {
        stroke-dasharray: 1000;
        stroke-dashoffset: 0;
    }
}

.jtk-connector.jtk-connector-new {
    animation: connectionDraw 0.5s ease-out;
}

/* ✅ Manter visíveis apenas nossos elementos visuais customizados */
.step-input-endpoint,
.step-output-endpoint,
.btn-visual-endpoint {
    display: block !important;
    pointer-events: auto !important;
}

/* ✅ Estilos para endpoints visuais (já definidos inline, mas garantir) */
.jtk-endpoint[data-endpoint-type="input"] {
    background: #10B981 !important;
    border: 3px solid #059669 !important;
}

.jtk-endpoint[data-endpoint-type="output"] {
    background: #EF4444 !important;
    border: 3px solid #DC2626 !important;
}

/* ✅ Hover em conexões para remover */
.jtk-connector {
    cursor: pointer !important;
}

.jtk-connector:hover {
    stroke-width: 4 !important;
    opacity: 0.9 !important;
}

/* ✅ Responsividade para telas menores */
@media (max-width: 768px) {
    .flow-step-block {
        min-width: 180px;
        max-width: 240px;
        width: 200px;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 320px) !important;
        min-height: 400px !important;
    }
    
    .config-section {
        padding: 16px;
    }
    
    .config-section-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

@media (max-width: 640px) {
    .flow-step-block {
        min-width: 160px;
        max-width: 200px;
        width: 180px;
        font-size: 0.875rem;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 280px) !important;
        min-height: 350px !important;
    }
    
    .config-section {
        padding: 12px;
        border-radius: 8px;
    }
    
    .config-section-header {
        gap: 8px;
    }
    
    .config-section-title {
        font-size: 1rem;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    /* Grids responsivos */
    .grid.grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .grid.grid-cols-1.md\:grid-cols-3 {
        grid-template-columns: 1fr;
    }
}

/* ✅ Garantir que todos os containers sejam 100% em mobile */
@media (max-width: 640px) {
    /* Container principal - garantir 100% width */
    .max-w-full {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    /* Botões full width em mobile */
    .btn-action {
        width: 100%;
        justify-content: center;
    }
    
    /* Canvas do editor visual - garantir 100% em mobile */
    #flow-visual-canvas {
        width: 100% !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 0 !important;
    }
    
    /* Garantir que grids sejam sempre 1 coluna em mobile */
    .grid {
        grid-template-columns: 1fr !important;
    }
}

/* ✅ Garantir que elementos não quebrem o layout */
* {
    box-sizing: border-box;
}

/* ✅ Prevenir overflow horizontal */
body {
    overflow-x: hidden;
}

/* ✅ Garantir que modais sejam responsivos */
@media (max-width: 640px) {
    .fixed.inset-0.z-50 > .flex > div,
    [id^="flow-step-modal-"],
    [id^="condition-modal-"] {
        width: 95% !important;
        max-width: 95% !important;
        margin: 0 auto !important;
        padding: 1rem !important;
    }
}

.flow-step-block:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    z-index: 100 !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
    transition: all 0.2s ease;
}

.jtk-endpoint:hover {
    transform: scale(1.3);
    z-index: 50 !important;
}

.jtk-connector {
    cursor: pointer;
    transition: stroke-width 0.2s ease;
}

.jtk-connector:hover {
    stroke-width: 4 !important;
    filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.6));
}

/* ✅ Melhorar visual das conexões */
.jtk-connector path {
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* ✅ Estilo para conexões de botões customizados (vermelhas) */
.jtk-connector[data-button-connection="true"] {
    stroke: #FF6B6B !important;
    stroke-width: 3 !important;
}

.jtk-connector[data-button-connection="true"]:hover {
    stroke-width: 5 !important;
    filter: drop-shadow(0 0 6px rgba(255, 107, 107, 0.8));
}

/* ✅ Botão de remover conexão (ao passar mouse) - MELHORADO */
.jtk-overlay-connection-delete {
    background: #EF4444 !important;
    border-radius: 50% !important;
    width: 24px !important;
    height: 24px !important;
    cursor: pointer !important;
    opacity: 0;
    transition: all 0.2s ease;
    border: 2px solid #FFFFFF !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.jtk-overlay-connection-delete::before {
    content: '×' !important;
    color: #FFFFFF !important;
    font-size: 18px !important;
    font-weight: bold !important;
    line-height: 1 !important;
}

.jtk-connector:hover .jtk-overlay-connection-delete {
    opacity: 1 !important;
    transform: scale(1.1);
}

.jtk-connector:hover {
    cursor: pointer !important;
}

/* ✅ Indicador visual de que a linha pode ser removida */
.jtk-connector[data-removable="true"] {
    position: relative;
}

.jtk-connector[data-removable="true"]::after {
    content: '❌ Duplo clique para remover';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(239, 68, 68, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 1000;
}

.jtk-connector[data-removable="true"]:hover::after {
    opacity: 1;
}

/* ✅ Feedback visual ao arrastar */
.jtk-drag-select {
    border: 2px dashed #3B82F6;
    background: rgba(59, 130, 246, 0.1);
}

/* ✅ Tooltip para conexões */
.connection-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
}

/* ✅ Estilos para endpoints de botões customizados */
.btn-endpoint-marker,
.btn-visual-endpoint {
    position: absolute;
    width: 16px;
    height: 16px;
    background: #FF6B6B;
    border: 3px solid #FF0000;
    border-radius: 50%;
    cursor: crosshair;
    z-index: 30;
    box-shadow: 0 0 8px rgba(255, 107, 107, 0.8);
    transition: all 0.2s ease;
    pointer-events: all;
}

.btn-endpoint-marker:hover,
.btn-visual-endpoint:hover {
    background: #FF8787;
    border-color: #FF3333;
    transform: translateY(-50%) scale(1.3) !important;
    box-shadow: 0 0 12px rgba(255, 107, 107, 1);
}

.btn-endpoint-label {
    background: rgba(255, 107, 107, 0.9);
    color: #FFFFFF;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    pointer-events: none;
    border: 1px solid #FF0000;
}

.btn-endpoint-label-text {
    position: absolute;
    font-size: 10px;
    color: #FF6B6B;
    font-weight: bold;
    white-space: nowrap;
    pointer-events: none;
    transform: translateY(-50%);
    z-index: 25;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
}

/* Bot Config V2.0 - Design System */

.config-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .config-section {
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 20px;
    }
}

@media (min-width: 768px) {
    .config-section {
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }
}

.config-section-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

@media (min-width: 640px) {
    .config-section-header {
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
    }
}

.config-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #FFFFFF;
    word-wrap: break-word;
}

@media (min-width: 640px) {
    .config-section-title {
        font-size: 1.125rem;
    }
}

@media (min-width: 768px) {
    .config-section-title {
        font-size: 1.25rem;
    }
}

.config-section-description {
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-top: 4px;
    word-wrap: break-word;
}

@media (min-width: 640px) {
    .config-section-description {
        font-size: 0.875rem;
    }
}

.form-group {
    margin-bottom: 16px;
    width: 100%;
}

@media (min-width: 640px) {
    .form-group {
        margin-bottom: 20px;
    }
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #D1D1D1;
    margin-bottom: 8px;
}

.form-input {
    width: 100%;
    max-width: 100%;
    padding: 10px 12px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .form-input {
        padding: 12px 16px;
    }
}

.form-input:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-textarea {
    width: 100%;
    max-width: 100%;
    padding: 10px 12px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    resize: vertical;
    min-height: 100px;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .form-textarea {
        padding: 12px 16px;
        min-height: 120px;
    }
}

.form-textarea:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.tab-nav {
    display: flex;
    gap: 0;
    border-bottom: 2px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 24px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.tab-nav::-webkit-scrollbar {
    height: 4px;
}

.tab-nav::-webkit-scrollbar-track {
    background: transparent;
}

.tab-nav::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}

.tab-button {
    padding: 12px 16px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #9CA3AF;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
}

@media (min-width: 640px) {
    .tab-button {
        padding: 16px 24px;
    }
}

.tab-button:hover {
    color: #D1D1D1;
}

.tab-button.active {
    color: #FFB800;
    border-bottom-color: #FFB800;
}

.button-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
}

.order-bump-card {
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.05) 0%, rgba(255, 184, 0, 0.02) 100%);
    border: 1px solid rgba(255, 184, 0, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
}

.order-bump-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 184, 0, 0.1);
}

.order-bump-index {
    width: 32px;
    height: 32px;
    background: rgba(255, 184, 0, 0.1);
    border: 2px solid rgba(255, 184, 0, 0.4);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    color: #FFB800;
}

.button-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.button-index {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    font-weight: 700;
    color: #6EE7B7;
}

.info-box {
    padding: 16px;
    background: rgba(59, 130, 246, 0.05);
    border-left: 4px solid #3B82F6;
    border-radius: 0 8px 8px 0;
    margin-top: 12px;
}

/* ✅ UX MELHORIAS: Estilos para campos essenciais, preview e validação inline */

/* ✅ UX ORDER BUMPS: Estilos específicos para melhor experiência */

/* Layout Order Bump: Configuração + Preview */
.order-bump-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
}

@media (max-width: 1024px) {
    .order-bump-layout {
        grid-template-columns: 1fr;
    }
}

/* Preview Order Bump no Telegram */
.order-bump-preview-card {
    position: sticky;
    top: 20px;
    background: #FFFFFF;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    min-height: 400px;
}

.order-bump-banner-preview {
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    position: relative;
}

.order-bump-badge-preview {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #F59E0B;
    color: #FFFFFF;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.order-bump-message-preview {
    color: #78350F;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin-bottom: 12px;
}

.order-bump-price-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(146, 64, 14, 0.2);
}

.order-bump-price-label {
    color: #92400E;
    font-weight: 600;
    font-size: 0.875rem;
}

.order-bump-price-value {
    color: #92400E;
    font-weight: 700;
    font-size: 1.125rem;
}

.order-bump-buttons-preview {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 12px;
}

.order-bump-btn-accept-preview {
    padding: 10px 16px;
    background: #10B981;
    color: #FFFFFF;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    text-align: center;
    cursor: default;
}

.order-bump-btn-decline-preview {
    padding: 10px 16px;
    background: #F3F4F6;
    color: #374151;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    text-align: center;
    cursor: default;
}

.order-bump-media-preview {
    width: 100%;
    height: 150px;
    background: #F3F4F6;
    border: 2px dashed #D1D5DB;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6B7280;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 12px;
    opacity: 0.95;
}

.order-bump-description-preview {
    color: #92400E;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 8px;
}

/* Indicador de Ordem Sequencial */
.order-bump-sequence-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 6px;
    margin-bottom: 16px;
}

.order-bump-sequence-badge {
    background: #F59E0B;
    color: #FFFFFF;
    font-weight: 700;
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 4px;
}

.order-bump-sequence-text {
    font-size: 0.75rem;
    color: #FCD34D;
}

/* Estatísticas de Conversão */
.order-bump-stats {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.5);
    border-radius: 8px;
    padding: 14px;
    margin-top: 16px;
}

.order-bump-stats-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #10B981;
    margin-bottom: 10px;
    opacity: 1;
}

.order-bump-stats-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #FFFFFF;
    margin-bottom: 8px;
    opacity: 1;
    font-weight: 500;
}

.order-bump-stats-value {
    font-weight: 700;
    color: #10B981;
    font-size: 0.95rem;
    opacity: 1;
}

/* Card de Order Bump Melhorado */
.order-bump-card-enhanced {
    background: rgba(255, 184, 0, 0.05);
    border: 2px solid rgba(255, 184, 0, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    position: relative;
}

.order-bump-card-enhanced:hover {
    border-color: rgba(255, 184, 0, 0.4);
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.2);
}

.order-bump-card-enhanced.disabled {
    opacity: 0.85;
    border-color: rgba(107, 114, 128, 0.4);
    background: rgba(107, 114, 128, 0.08);
}

.order-bump-card-enhanced.disabled:hover {
    border-color: rgba(107, 114, 128, 0.5);
    box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
}

/* Melhorar visibilidade do conteúdo quando desabilitado */
.order-bump-card-enhanced.disabled .form-input,
.order-bump-card-enhanced.disabled .form-textarea,
.order-bump-card-enhanced.disabled .form-label {
    opacity: 1 !important;
}

.order-bump-card-enhanced.disabled h4,
.order-bump-card-enhanced.disabled .text-white,
.order-bump-card-enhanced.disabled .text-gray-500 {
    opacity: 1 !important;
}

/* Layout 2 Colunas: Informações + Preview */
.product-config-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
}

@media (max-width: 1024px) {
    .product-config-layout {
        grid-template-columns: 1fr;
    }
}

/* Campos Essenciais - Destaque Visual */
.essential-field-group {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
}

.field-with-validation {
    position: relative;
}

.field-validation-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.125rem;
    pointer-events: none;
}

.field-validation-icon.valid {
    color: #10B981;
}

.field-validation-icon.warning {
    color: #F59E0B;
}

.field-validation-icon.error {
    color: #EF4444;
}

/* Input com validação - padding ajustado via inline styles no HTML */

/* Preço Destaque Visual */
.price-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.price-currency-symbol {
    position: absolute;
    left: 16px;
    color: #10B981;
    font-weight: 700;
    font-size: 1.125rem;
    pointer-events: none;
    z-index: 1;
}

.price-input-wrapper .form-input {
    padding-left: 36px;
    text-align: right;
    font-weight: 600;
    font-size: 1.125rem;
}

/* Contador de Caracteres */
.char-counter-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 6px;
}

.char-counter {
    font-size: 0.75rem;
    color: #9CA3AF;
}

.char-counter.warning {
    color: #F59E0B;
}

.char-counter.error {
    color: #EF4444;
}

/* Preview Telegram */
.telegram-preview-card {
    position: sticky;
    top: 20px;
    background: #FFFFFF;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    min-height: 400px;
}

.telegram-preview-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #E5E7EB;
    margin-bottom: 16px;
}

.telegram-avatar-preview {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFFFFF;
    font-weight: 700;
    font-size: 1.125rem;
}

.telegram-info-preview {
    flex: 1;
}

.telegram-name-preview {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
}

.telegram-time-preview {
    font-size: 0.75rem;
    color: #6B7280;
}

.telegram-message-preview {
    background: #F3F4F6;
    padding: 12px 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    min-height: 100px;
}

.product-name-preview {
    font-weight: 700;
    color: #111827;
    font-size: 1rem;
    margin-bottom: 8px;
}

.product-description-preview {
    color: #4B5563;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.product-price-preview {
    font-weight: 700;
    color: #10B981;
    font-size: 1.5rem;
    margin: 12px 0;
}

.telegram-button-preview {
    width: 100%;
    padding: 14px 20px;
    background: #0088CC;
    color: #FFFFFF;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    cursor: default;
}

.telegram-button-preview:hover {
    background: #006BA3;
}

.empty-state-preview {
    text-align: center;
    padding: 40px 20px;
    color: #9CA3AF;
}

.empty-state-preview-icon {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.8;
}

.empty-state-preview-text {
    font-size: 0.875rem;
    color: #9CA3AF;
    opacity: 0.9;
}

/* Tooltip Contextual */
.field-help-tooltip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-left: 8px;
    cursor: help;
}

.tooltip-icon {
    color: #6B7280;
    font-size: 0.875rem;
}

.field-help-text {
    margin-top: 6px;
    font-size: 0.75rem;
    color: #9CA3AF;
    line-height: 1.4;
}

/* Label com Badge Obrigatório */
.label-with-badge {
    display: flex;
    align-items: center;
    gap: 6px;
}

.required-badge {
    color: #EF4444;
    font-size: 0.75rem;
    font-weight: 700;
}

/* Animações Suaves */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.field-validation-icon {
    animation: fadeIn 0.2s ease;
}

.product-config-layout {
    animation: fadeIn 0.3s ease;
}


/* Order Bump Cards Compactos */
.order-bumps-list {
    margin-bottom: 16px;
}

.order-bump-card-compact {
    background: rgba(255, 184, 0, 0.05);
    border: 1px solid rgba(255, 184, 0, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
}

.order-bump-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.order-bump-card-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.order-bump-badge {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.order-bump-badge.enabled {
    background: rgba(255, 184, 0, 0.2);
    border: 2px solid rgba(255, 184, 0, 0.5);
    color: #FFB800;
}

.order-bump-badge.disabled {
    background: rgba(107, 114, 128, 0.2);
    border: 2px solid rgba(107, 114, 128, 0.3);
    color: #9CA3AF;
}

.order-bump-name {
    font-weight: 600;
    color: #FFFFFF;
    font-size: 0.875rem;
    margin-bottom: 2px;
}

.order-bump-price {
    font-size: 0.75rem;
    color: #9CA3AF;
}

.order-bump-card-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #374151;
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background-color: #FFB800;
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.btn-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.02);
    color: #9CA3AF;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    color: #FFFFFF;
}

.btn-icon-danger {
    border-color: rgba(239, 68, 68, 0.3);
    color: #FCA5A5;
}

.btn-icon-danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: #EF4444;
    color: #FFFFFF;
}

.btn-add-item {
    width: 100%;
    padding: 12px;
    background: rgba(255, 184, 0, 0.1);
    border: 2px dashed rgba(255, 184, 0, 0.3);
    border-radius: 8px;
    color: #FFB800;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-add-item:hover {
    background: rgba(255, 184, 0, 0.15);
    border-color: rgba(255, 184, 0, 0.5);
}

.stats-box {
    margin-top: 16px;
    padding: 16px;
    background: rgba(16, 185, 129, 0.05);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 8px;
    display: flex;
    gap: 24px;
}

.stat-item {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 1.125rem;
    font-weight: 700;
    color: #6EE7B7;
}

.info-banner {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 8px;
    margin-bottom: 16px;
}

.info-banner i {
    color: #60A5FA;
    font-size: 1.25rem;
    flex-shrink: 0;
    margin-top: 2px;
}

.info-banner strong {
    display: block;
    color: #93C5FD;
    margin-bottom: 4px;
    font-size: 0.875rem;
}

.info-banner p {
    color: #DBEAFE;
    font-size: 0.875rem;
    line-height: 1.5;
    margin: 0;
}


.info-box-success {
    background: rgba(16, 185, 129, 0.05);
    border-left-color: #10B981;
}

.info-box-warning {
    background: rgba(255, 184, 0, 0.05);
    border-left-color: #FFB800;
}

.order-bump-section {
    background: rgba(255, 184, 0, 0.03);
    border: 1px solid rgba(255, 184, 0, 0.15);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.subscription-section {
    background: rgba(255, 184, 0, 0.03);
    border: 1px solid rgba(255, 184, 0, 0.15);
    border-radius: 12px;
    padding: 20px;
}

/* Card de Ativação de Assinatura */
.subscription-activation-card {
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.08) 0%, rgba(255, 184, 0, 0.03) 100%);
    border: 2px solid rgba(255, 184, 0, 0.2);
    border-radius: 12px;
    padding: 24px;
}

.subscription-icon-large {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: #FFFFFF;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* ✅ UX ASSINATURAS: Estilos para melhor experiência */

/* Layout Assinatura: Configuração + Preview */
.subscription-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
}

@media (max-width: 1024px) {
    .subscription-layout {
        grid-template-columns: 1fr;
    }
}

/* Card de Explicação Visual */
.subscription-explanation-card {
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
    border: 2px solid rgba(255, 184, 0, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.subscription-flow-steps {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: 16px;
}

.subscription-flow-step {
    flex: 1;
    text-align: center;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    position: relative;
}

.subscription-flow-step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #F59E0B;
    color: #FFFFFF;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
}

.subscription-flow-step-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #FFFFFF;
    margin-bottom: 4px;
}

.subscription-flow-step-desc {
    font-size: 0.625rem;
    color: #9CA3AF;
}

.subscription-flow-arrow {
    color: #F59E0B;
    font-size: 1.5rem;
    flex-shrink: 0;
}

/* Preview do Cliente */
.subscription-preview-card {
    position: sticky;
    top: 20px;
    background: #FFFFFF;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    min-height: 400px;
}

.subscription-preview-message {
    background: #E5E7EB;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
}

.subscription-preview-title {
    font-weight: 700;
    color: #111827;
    font-size: 1rem;
    margin-bottom: 8px;
}

.subscription-preview-duration {
    color: #4B5563;
    font-size: 0.875rem;
    margin-bottom: 12px;
}

.subscription-preview-button {
    width: 100%;
    padding: 14px 20px;
    background: #0088CC;
    color: #FFFFFF;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    cursor: default;
    margin-bottom: 16px;
}

.subscription-preview-info {
    background: rgba(255, 184, 0, 0.1);
    border-left: 4px solid #F59E0B;
    padding: 12px;
    border-radius: 4px;
    font-size: 0.75rem;
    color: #78350F;
}

/* Guia de Como Encontrar Chat ID */
/* CSS antigo removido - usando versão colapsável abaixo */

.subscription-guide-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #60A5FA;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.subscription-guide-steps {
    list-style: none;
    padding: 0;
    margin: 0;
}

.subscription-guide-steps li {
    font-size: 0.75rem;
    color: #DBEAFE;
    margin-bottom: 6px;
    padding-left: 20px;
    position: relative;
}

.subscription-guide-steps li:before {
    content: counter(step-counter);
    counter-increment: step-counter;
    position: absolute;
    left: 0;
    background: #3B82F6;
    color: #FFFFFF;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    font-weight: 700;
}

.subscription-guide-steps {
    counter-reset: step-counter;
}

/* Validação Visual */
.subscription-validation-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 8px;
}

.subscription-validation-badge.valid {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid rgba(16, 185, 129, 0.4);
    color: #10B981;
}

.subscription-validation-badge.invalid {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #EF4444;
}

.subscription-validation-badge.pending {
    background: rgba(245, 158, 11, 0.2);
    border: 1px solid rgba(245, 158, 11, 0.4);
    color: #F59E0B;
}

/* Exemplo de Chat ID */
.subscription-chat-id-example {
    background: rgba(17, 24, 39, 0.5);
    border: 1px dashed rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: monospace;
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-top: 8px;
    display: inline-block;
}

/* Responsividade para Fluxo Visual */
@media (max-width: 768px) {
    .subscription-flow-steps {
        flex-direction: column;
        gap: 8px;
    }
    
    .subscription-flow-arrow {
        transform: rotate(90deg);
        margin: 4px 0;
    }
    
    .subscription-flow-step {
        width: 100%;
    }
}

/* ✅ Tutorial Visual de Como Encontrar ID do Grupo - Colapsável */
.subscription-guide-card {
    background: rgba(59, 130, 246, 0.08);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
    padding: 0;
    margin-top: 12px;
    overflow: hidden;
}

/* Header do Card Colapsável */
.subscription-guide-header-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: transparent;
    border: none;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
}

.subscription-guide-header-button:hover {
    background: rgba(59, 130, 246, 0.12);
}

.subscription-guide-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.subscription-guide-header-icon {
    color: #FCD34D;
    font-size: 1.125rem;
}

.subscription-guide-header-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #FFFFFF;
}

.subscription-guide-header-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

.subscription-guide-header-hint {
    font-size: 0.75rem;
    color: #9CA3AF;
    font-weight: 500;
}

.subscription-guide-chevron {
    color: #9CA3AF;
    font-size: 0.875rem;
    transition: transform 0.3s ease;
}

.subscription-guide-chevron.rotated {
    transform: rotate(180deg);
}

.subscription-guide-content {
    padding: 16px;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* CSS duplicado removido - usando versão acima */

.subscription-guide-header-button:hover {
    background: rgba(255, 255, 255, 0.05);
}

.subscription-guide-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.subscription-guide-header-icon {
    color: #60A5FA;
    font-size: 1.125rem;
}

.subscription-guide-header-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #FFFFFF;
}

.subscription-guide-header-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.subscription-guide-header-hint {
    font-size: 0.75rem;
    color: #9CA3AF;
}

.subscription-guide-chevron {
    color: #9CA3AF;
    font-size: 0.875rem;
    transition: transform 0.3s ease;
}

.subscription-guide-chevron.rotated {
    transform: rotate(180deg);
}

.subscription-guide-content {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* ✅ Tutorial Visual de Como Encontrar ID do Grupo */
.subscription-guide-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    border-bottom: 2px solid rgba(59, 130, 246, 0.2);
}

.subscription-guide-tab {
    padding: 10px 16px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: #9CA3AF;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
}

.subscription-guide-tab:hover {
    color: #60A5FA;
}

.subscription-guide-tab.active {
    color: #60A5FA;
    border-bottom-color: #3B82F6;
}

.subscription-guide-step-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.subscription-guide-step-number {
    width: 36px;
    height: 36px;
    min-width: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: #FFFFFF;
    font-weight: 700;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.subscription-guide-step-content {
    flex: 1;
}

.subscription-guide-step-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #FFFFFF;
    margin-bottom: 6px;
    line-height: 1.4;
}

.subscription-guide-step-desc {
    font-size: 0.75rem;
    color: #D1D5DB;
    line-height: 1.5;
}

.subscription-guide-step-highlight {
    background: rgba(59, 130, 246, 0.15);
    border-left: 3px solid #3B82F6;
    padding: 8px 12px;
    border-radius: 4px;
    margin-top: 8px;
    font-size: 0.75rem;
    color: #DBEAFE;
}

.subscription-guide-important-tips {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.subscription-guide-tips-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #FCD34D;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.subscription-guide-tip-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 10px;
    font-size: 0.75rem;
    color: #FDE68A;
    line-height: 1.5;
}

.subscription-guide-tip-icon {
    color: #F59E0B;
    font-size: 0.875rem;
    margin-top: 2px;
    flex-shrink: 0;
}

.subscription-guide-bot-name {
    background: rgba(0, 136, 204, 0.2);
    border: 1px solid rgba(0, 136, 204, 0.4);
    border-radius: 6px;
    padding: 6px 10px;
    font-family: monospace;
    font-weight: 600;
    color: #7DD3FC;
    display: inline-block;
    font-size: 0.75rem;
}

.subscription-guide-example-id {
    background: rgba(17, 24, 39, 0.6);
    border: 1px dashed rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    padding: 10px 14px;
    font-family: monospace;
    font-size: 0.8rem;
    color: #10B981;
    margin-top: 8px;
    display: inline-block;
    font-weight: 600;
}

.subscription-guide-tutorial {
    margin-top: 16px;
}

/* Ajustes de Responsividade para o Tutorial */
@media (max-width: 640px) {
    .subscription-guide-step-card {
        flex-direction: column;
        text-align: center;
    }
    
    .subscription-guide-step-number {
        margin: 0 auto 12px;
    }
    
    .subscription-guide-tabs {
        flex-direction: column;
    }
    
    .subscription-guide-tab {
        width: 100%;
        border-bottom: none;
        border-left: 3px solid transparent;
        text-align: left;
    }
    
    .subscription-guide-tab.active {
        border-left-color: #3B82F6;
        border-bottom-color: transparent;
    }
}

/* Botões de Ação - IDÊNTICO ao Dashboard */
.btn-action {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-action:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.btn-action i {
    margin-right: 0.5rem;
}

/* Todas as variantes usam o mesmo estilo dourado */
.btn-action-primary,
.btn-action-success,
.btn-action-info {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-action-primary:hover,
.btn-action-success:hover,
.btn-action-info:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Botões de Precificação (Downsells) */
.pricing-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 700;
    transition: all 0.15s ease;
    cursor: pointer;
}

.pricing-btn-active {
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    border: 2px solid var(--brand-gold-500);
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
}

.pricing-btn-inactive {
    color: #9CA3AF;
    background: #1F2937;
    border: 2px solid #374151;
}

.pricing-btn-inactive:hover {
    color: #D1D5DB;
    border-color: #4B5563;
    background: #374151;
}
</style>
<script>
    window.stripSurrogateChars = function (value) {
        if (!value) {
            return '';
        }
        try {
            // ✅ CORREÇÃO CRÍTICA: Remover APENAS surrogates inválidos (isolados)
            // Preservar pares de surrogates válidos (emojis, caracteres Unicode especiais)
            // Surrogates válidos vêm em pares: high surrogate (\uD800-\uDBFF) + low surrogate (\uDC00-\uDFFF)
            // Surrogates inválidos são isolados ou fora de ordem
            
            // Não remover nada - deixar o texto como está
            // O Telegram e o banco de dados suportam UTF-8 completo
            return value;
        } catch (err) {
            return value || '';
        }
    };
</script>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8" x-data="botConfigApp()" x-init="init()">
    
    <!-- Header -->
    <div class="mb-4 sm:mb-6 md:mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4">
        <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto">
            <a href="{{ url_for('dashboard') }}" 
               class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-700 text-gray-400 hover:text-white hover:border-yellow-500 transition-all flex-shrink-0">
                <i class="fas fa-arrow-left text-sm sm:text-base"></i>
            </a>
            <div class="min-w-0 flex-1">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-white truncate">{{ bot.name }}</h1>
                <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">@{{ bot.username }}</p>
            </div>
        </div>
        <div class="flex items-center space-x-2 sm:space-x-3 w-full sm:w-auto">
            <!-- ❌ REMOVIDO: Meta Pixel agora é configurado POR POOL (não por bot) -->
            <!-- Acesse: Redirecionadores → Editar Pool → Meta Pixel -->
            <button @click="saveConfig()" 
                    :disabled="loading"
                    :class="{'opacity-50 cursor-not-allowed': loading}"
                    class="btn-action btn-action-primary w-full sm:w-auto text-sm sm:text-base px-3 sm:px-6 py-2 sm:py-3">
                <span x-show="!loading">
                    <i class="fas fa-save mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Salvar Configurações</span>
                    <span class="sm:hidden">Salvar</span>
                </span>
                <span x-show="loading">
                    <i class="fas fa-spinner fa-spin mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Salvando...</span>
                    <span class="sm:hidden">Salvando</span>
                </span>
            </button>
        </div>
    </div>

    
    <!-- Tabs -->
    <div class="tab-nav overflow-x-auto -mx-2 sm:-mx-4 md:-mx-6 lg:-mx-8 px-2 sm:px-4 md:px-6 lg:px-8">
        <div class="flex gap-1 sm:gap-2 min-w-max">
            <button @click="activeTab = 'welcome'" 
                    :class="{'active': activeTab === 'welcome'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-home mr-1 sm:mr-2"></i><span class="hidden sm:inline">Boas-vindas</span><span class="sm:hidden">Boas-vindas</span>
            </button>
            <button @click="activeTab = 'flow'" 
                    :class="{'active': activeTab === 'flow'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-project-diagram mr-1 sm:mr-2"></i><span class="hidden sm:inline">Fluxo</span><span class="sm:hidden">Fluxo</span>
            </button>
            <button @click="activeTab = 'buttons'" 
                    :class="{'active': activeTab === 'buttons'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-shopping-cart mr-1 sm:mr-2"></i><span class="hidden sm:inline">Botões</span><span class="sm:hidden">Botões</span>
            </button>
            <button @click="activeTab = 'downsells'" 
                    :class="{'active': activeTab === 'downsells'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-arrow-down mr-1 sm:mr-2"></i><span class="hidden sm:inline">Downsells</span><span class="sm:hidden">Down</span>
            </button>
            <button @click="activeTab = 'upsells'" 
                    :class="{'active': activeTab === 'upsells'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-arrow-up mr-1 sm:mr-2"></i><span class="hidden sm:inline">Upsells</span><span class="sm:hidden">Up</span>
            </button>
            <button @click="activeTab = 'access'" 
                    :class="{'active': activeTab === 'access'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-key mr-1 sm:mr-2"></i><span class="hidden sm:inline">Acesso</span><span class="sm:hidden">Acesso</span>
            </button>
            <button @click="activeTab = 'settings'" 
                    :class="{'active': activeTab === 'settings'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-cog mr-1 sm:mr-2"></i><span class="hidden sm:inline">Configurações</span><span class="sm:hidden">Config</span>
            </button>
        </div>
    </div>

    <!-- Tab Content: Welcome -->
    <div x-show="activeTab === 'welcome'" x-cloak>
        <!-- ⚠️ Aviso quando Fluxo está ativado -->
        <div x-show="config.flow_enabled" 
             x-cloak
             class="mb-6 p-4 bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 rounded-xl">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                <div class="flex-1">
                    <div class="text-yellow-400 font-bold mb-1">⚠️ Fluxo Visual Ativado</div>
                    <div class="text-sm text-gray-300">
                        O <strong>Fluxo Visual</strong> está ativo e será executado ao invés da mensagem de Boas-vindas quando o usuário iniciar o bot.
                        <br>
                        <span class="text-xs text-gray-400 mt-1 block">
                            As configurações de Boas-vindas abaixo são mantidas como fallback caso o Fluxo seja desativado.
                        </span>
                    </div>
                    <button @click="activeTab = 'flow'" 
                            class="mt-3 px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                        <i class="fas fa-project-diagram mr-2"></i>
                        Ir para Editor de Fluxo
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-home text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Mensagem de Boas-vindas</div>
                    <div class="config-section-description">
                        <span x-show="!config.flow_enabled">Primeira impressão quando o usuário inicia o bot</span>
                        <span x-show="config.flow_enabled" class="text-gray-400">Configuração mantida como fallback (Fluxo Visual ativo)</span>
                    </div>
                </div>
            </div>

            <!-- Mensagem -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-comment-dots mr-2 text-yellow-500"></i>
                    Mensagem de Texto
                </label>
                <textarea x-model="config.welcome_message"
                          class="form-textarea"
                          maxlength="4096"
                          @input="validateWelcomeMessage()"
                          placeholder="Olá! Bem-vindo ao nosso bot de vendas...&#10;&#10;Escolha uma das opções abaixo:"></textarea>
                <p class="text-xs mt-1" x-show="config.welcome_message">
                    <span class="text-gray-500">Caracteres: </span>
                    <span :class="{'text-green-400 font-bold': getWelcomeMessageLength() <= 4096, 'text-red-400 font-bold': getWelcomeMessageLength() > 4096}" 
                          x-text="getWelcomeMessageLength()"></span>
                    <span class="text-gray-500"> / </span>
                    <span class="text-gray-400 font-bold">4096</span>
                    <span x-show="getWelcomeMessageLength() > 4096" 
                          class="text-red-400 ml-2 font-bold">
                        ❌ Excede o limite do Telegram (4096)!
                    </span>
                </p>
            </div>

            <!-- Mídia -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        URL da Mídia
                    </label>
                    <input type="url" 
                           x-model="config.welcome_media_url" 
                           @input="validateWelcomeMessage()"
                           @change="validateWelcomeMessage()"
                           class="form-input"
                           placeholder="https://t.me/canal/123">
                    <p class="text-xs text-gray-500 mt-2">Link do Telegram (vídeo, foto ou áudio)</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-image mr-2 text-blue-500"></i>
                        Tipo de Mídia Principal
                    </label>
                    <div class="flex gap-3 mt-2">
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': config.welcome_media_type === 'video'}">
                            <input type="radio" x-model="config.welcome_media_type" value="video" class="text-blue-500">
                            <i class="fas fa-video text-blue-500"></i>
                            <span class="text-sm text-white">Vídeo</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': config.welcome_media_type === 'photo'}">
                            <input type="radio" x-model="config.welcome_media_type" value="photo" class="text-blue-500">
                            <i class="fas fa-camera text-blue-500"></i>
                            <span class="text-sm text-white">Foto</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label flex items-center gap-2">
                        <input type="checkbox" 
                               x-model="config.welcome_audio_enabled"
                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                               style="accent-color: #3B82F6;">
                        <i class="fas fa-microphone mr-1 text-purple-500"></i>
                        <span>Adicionar Áudio Complementar (opcional)</span>
                    </label>
                    <div x-show="config.welcome_audio_enabled" x-cloak class="mt-2">
                        <input type="url" 
                               x-model="config.welcome_audio_url" 
                               class="form-input"
                               placeholder="https://t.me/canal/789">
                        <p class="text-xs text-gray-500 mt-2">Link do áudio no Telegram (será enviado após a mídia principal)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Flow -->
    <div x-show="activeTab === 'flow'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-project-diagram text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Editor de Fluxograma Visual</div>
                    <div class="config-section-description">Crie fluxos personalizados com blocos conectados</div>
                </div>
            </div>

            <!-- Toggle Ativar Fluxo -->
            <div class="form-group">
                <label class="flex items-center gap-2">
                    <input type="checkbox" 
                           x-model="config.flow_enabled"
                           @change="onFlowToggle()"
                           class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                           style="accent-color: #3B82F6;">
                    <i class="fas fa-toggle-on mr-1 text-blue-500"></i>
                    <span class="text-white font-medium">Ativar Fluxo Visual</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">
                    Quando ativado, desativa automaticamente Boas-vindas. O fluxo será executado ao invés de welcome_message.
                </p>
            </div>

            <!-- Lista Visual de Steps (Padrão) -->
            <div x-show="config.flow_enabled" x-cloak class="mt-6">
                <!-- ⚠️ Aviso se não houver step inicial -->
                <div x-show="config.flow_steps && config.flow_steps.length > 0 && !config.flow_start_step_id" 
                     x-cloak
                     class="mb-4 p-4 bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 rounded-xl">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                        <div class="flex-1">
                            <div class="text-yellow-400 font-bold mb-1">⚠️ Step Inicial Não Definido</div>
                            <div class="text-sm text-gray-300">
                                O fluxo precisa de um step inicial para começar quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.
                                <br>
                                <span class="text-xs text-gray-400 mt-1 block">
                                    Clique no botão "Inicial" em qualquer step para defini-lo como inicial, ou o primeiro step será usado automaticamente.
                                </span>
                            </div>
                            <button @click="setFlowStartStep(sortedFlowSteps[0]?.id)" 
                                    x-show="sortedFlowSteps.length > 0"
                                    class="mt-3 px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                <i class="fas fa-play mr-2"></i>
                                Definir Primeiro Step como Inicial
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ✅ Info do step inicial definido -->
                <div x-show="config.flow_start_step_id" 
                     x-cloak
                     class="mb-4 p-4 bg-green-500 bg-opacity-25 border-2 border-green-500 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        <div class="flex-1">
                            <div class="text-green-400 font-bold mb-1">✅ Step Inicial Definido</div>
                            <div class="text-sm text-gray-200">
                                O fluxo iniciará no step marcado com <span class="text-yellow-400 font-bold">⭐ Inicial</span> quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white">Steps do Fluxo</h3>
                    <div class="flex items-center gap-3">
                        <button @click="addFlowStep()" 
                                type="button"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-plus mr-2"></i>Adicionar Step
                        </button>
                    </div>
                </div>

                <!-- ✅ EDITOR VISUAL (Canvas com linhas) - SEMPRE VISÍVEL -->
                <div class="mb-6 w-full overflow-hidden">
                    <div class="bg-gray-900 rounded-lg border-2 border-blue-500 p-2 sm:p-3 md:p-4 w-full max-w-full">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-project-diagram text-blue-400 text-xl"></i>
                                <h4 class="text-white font-bold text-sm sm:text-base">Editor Visual de Fluxo</h4>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-400 flex-wrap">
                                <i class="fas fa-info-circle flex-shrink-0"></i>
                                <span class="text-xs sm:text-sm">Arraste os blocos para reposicionar • Clique e arraste para conectar • <strong class="text-red-400">Duplo clique ou botão direito na linha para remover</strong></span>
                            </div>
                        </div>
                        <!-- ✅ Mensagem se não houver steps -->
                        <div x-show="!config.flow_steps || config.flow_steps.length === 0" 
                             x-cloak
                             class="text-center py-12 text-gray-400">
                            <i class="fas fa-project-diagram text-4xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium mb-2">Nenhum step criado ainda</p>
                            <p class="text-sm">Adicione um step clicando em "Adicionar Step" acima</p>
                        </div>
                        <!-- ✅ Canvas apenas se houver steps -->
                        <div x-show="config.flow_steps && config.flow_steps.length > 0"
                             x-cloak
                             x-init="$watch('config.flow_steps.length', (newLength) => {
                                 if (newLength > 0 && config.flow_enabled) {
                                     $nextTick(() => {
                                         setTimeout(() => {
                                             if (!window.flowEditor) {
                                                 initVisualFlowEditor();
                                             } else {
                                                 window.flowEditor.renderAllSteps();
                                             }
                                         }, 300);
                                     });
                                 }
                             }); $nextTick(() => { 
                                 if (config.flow_steps && config.flow_steps.length > 0 && config.flow_enabled) {
                                     setTimeout(() => { 
                                         initVisualFlowEditor(); 
                                     }, 300); 
                                 }
                             })"
                             class="w-full overflow-hidden">
                            <div class="relative w-full">
                                <!-- Controles de Zoom (opcional) -->
                                <div class="absolute top-4 right-4 z-10 flex flex-col gap-2 bg-gray-900 bg-opacity-90 rounded-lg p-2 border border-gray-700">
                                    <button onclick="window.flowEditor?.zoomIn()" 
                                            class="w-8 h-8 flex items-center justify-center bg-gray-800 hover:bg-gray-700 rounded text-white transition"
                                            title="Zoom In">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                    <button onclick="window.flowEditor?.zoomOut()" 
                                            class="w-8 h-8 flex items-center justify-center bg-gray-800 hover:bg-gray-700 rounded text-white transition"
                                            title="Zoom Out">
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <button onclick="window.flowEditor?.zoomReset()" 
                                            class="w-8 h-8 flex items-center justify-center bg-gray-800 hover:bg-gray-700 rounded text-white transition"
                                            title="Reset Zoom">
                                        <i class="fas fa-search text-xs"></i>
                                    </button>
                                </div>
                                
                                <div id="flow-visual-canvas" 
                                     class="relative w-full bg-gray-950 rounded border border-gray-700 flow-canvas-container"
                                     style="height: calc(100vh - 380px); min-height: 500px; max-height: 90vh; overflow: auto; width: 100%; max-width: 100%; box-sizing: border-box; position: relative; touch-action: pan-x pan-y; overscroll-behavior: contain; cursor: grab;">
                                    <!-- Steps serão renderizados aqui via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ✅ REMOVIDO: Lista de Steps - Agora apenas Visual (Editor Visual sempre ativo) -->
            </div>
        </div>
    </div>

    <!-- Tab Content: Buttons -->
    <div x-show="activeTab === 'buttons'" x-cloak>
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-white">🛍️ Botões de Venda</h2>
                <p class="text-sm text-gray-500 mt-1">Configure seus produtos e ofertas</p>
            </div>
            <button @click="addButton()" class="btn-action btn-action-success">
                <i class="fas fa-plus mr-2"></i>
                Adicionar Produto
            </button>
        </div>

        <!-- Lista de Botões com Preview -->
        <template x-if="config.main_buttons.length > 0">
            <div class="space-y-6">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="button-card">
                                <!-- Header -->
                                <div class="button-card-header">
                                    <div class="flex items-center gap-3">
                                        <div class="button-index" x-text="index + 1"></div>
                                        <div>
                                            <h3 class="text-sm font-bold text-white">Produto <span x-text="index + 1"></span></h3>
                                            <p class="text-xs text-gray-500">Configure preço e ofertas bônus</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <!-- Badge de Status (quando ativado) -->
                                        <div x-show="button.subscription && button.subscription.enabled" 
                                             x-cloak
                                             class="flex items-center gap-2 px-4 py-2 bg-yellow-500 bg-opacity-20 border-2 border-yellow-400 rounded-lg">
                                            <i class="fas fa-calendar-times text-yellow-400"></i>
                                            <span class="text-sm font-bold text-yellow-300">✓ Acesso Temporário Ativo</span>
                                        </div>
                                        <button @click="removeButton(index)" 
                                                class="w-10 h-10 flex items-center justify-center rounded-lg border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10 transition-all"
                                                title="Remover produto">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Campos do Produto -->
                                <div class="space-y-4">
                                        <!-- Grupo de Campos Essenciais -->
                                        <div class="essential-field-group">
                                            <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                                <i class="fas fa-info-circle text-blue-400"></i>
                                                Informações Essenciais
                                            </h4>
                                            
                                            <!-- Nome do Produto -->
                                            <div class="form-group">
                                                <label class="form-label label-with-badge">
                                                    Nome do Produto
                                                    <span class="required-badge">*</span>
                                                    <span class="field-help-tooltip" title="Nome que aparece no botão do Telegram">
                                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                                    </span>
                                                </label>
                                                <div class="field-with-validation">
                                                    <input type="text" 
                                                           x-model="button.text" 
                                                           @input="validateProductField(index, 'text')"
                                                           class="form-input"
                                                           placeholder="Ex: Curso Completo de INSS"
                                                           :style="(button.text && button.text.trim().length >= 3) || (button.text && button.text.trim().length > 0 && button.text.trim().length < 3) ? 'padding-right: 40px;' : ''"
                                                           :class="{
                                                               'border-green-500': button.text && button.text.trim().length >= 3,
                                                               'border-red-500': button.text && button.text.trim().length > 0 && button.text.trim().length < 3,
                                                               'border-gray-600': !button.text
                                                           }">
                                                    <i class="fas fa-check-circle field-validation-icon valid" 
                                                       x-show="button.text && button.text.trim().length >= 3"></i>
                                                    <i class="fas fa-exclamation-circle field-validation-icon error" 
                                                       x-show="button.text && button.text.trim().length > 0 && button.text.trim().length < 3"></i>
                                                </div>
                                                <p class="field-help-text" x-show="!button.text || button.text.trim().length < 3">
                                                    <i class="fas fa-lightbulb mr-1"></i>
                                                    Use um nome claro e atrativo. Mínimo 3 caracteres.
                                                </p>
                                            </div>

                                            <!-- Preço de Venda -->
                                            <div class="form-group">
                                                <label class="form-label label-with-badge">
                                                    Preço de Venda
                                                    <span class="required-badge">*</span>
                                                    <span class="field-help-tooltip" title="Valor que o cliente pagará pelo produto">
                                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                                    </span>
                                                </label>
                                                <div class="price-input-wrapper">
                                                    <span class="price-currency-symbol">R$</span>
                                                    <div class="field-with-validation flex-1">
                                                        <input type="number" 
                                                               x-model.number="button.price" 
                                                               @input="validateProductField(index, 'price')"
                                                               step="0.01"
                                                               min="0.01"
                                                               class="form-input"
                                                               placeholder="19.97"
                                                               :style="(button.price && button.price > 0) || (button.price !== null && button.price <= 0) ? 'padding-right: 40px;' : ''"
                                                               :class="{
                                                                   'border-green-500': button.price && button.price > 0,
                                                                   'border-red-500': button.price !== null && button.price <= 0,
                                                                   'border-gray-600': !button.price
                                                               }">
                                                        <i class="fas fa-check-circle field-validation-icon valid" 
                                                           x-show="button.price && button.price > 0"></i>
                                                        <i class="fas fa-exclamation-circle field-validation-icon error" 
                                                           x-show="button.price !== null && button.price <= 0"></i>
                                                    </div>
                                                </div>
                                                <p class="field-help-text" x-show="!button.price || button.price <= 0">
                                                    <i class="fas fa-lightbulb mr-1"></i>
                                                    Preço deve ser maior que zero. Use ponto (.) para decimais.
                                                </p>
                                            </div>

                                            <!-- Descrição do Produto -->
                                            <div class="form-group">
                                                <label class="form-label">
                                                    Descrição do Produto
                                                    <span class="field-help-tooltip" title="Texto que aparece na mensagem do Telegram explicando o produto">
                                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                                    </span>
                                                </label>
                                                <textarea x-model="button.description" 
                                                          @input="validateProductField(index, 'description')"
                                                          class="form-textarea"
                                                          placeholder="Descreva o que está incluído neste produto..."
                                                          rows="4"
                                                          maxlength="500"></textarea>
                                                <div class="char-counter-wrapper">
                                                    <p class="field-help-text">
                                                        <i class="fas fa-info-circle mr-1"></i>
                                                        Explique claramente o valor do produto. Use quebras de linha para organizar.
                                                    </p>
                                                    <span class="char-counter" 
                                                          :class="{
                                                              'warning': button.description && button.description.length > 400,
                                                              'error': button.description && button.description.length > 500
                                                          }"
                                                          x-text="(button.description?.length || 0) + '/500'">
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                </div>

                                <!-- ✅ UX MELHORADO: Order Bumps com Preview Visual -->
                                <div class="order-bump-section mt-6">
                                    <div class="flex justify-between items-center mb-6">
                                        <div class="flex items-center gap-3">
                                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                                <i class="fas fa-gift text-yellow-500"></i>
                                                Order Bumps
                                            </h4>
                                        </div>
                                        <button @click="addOrderBump(index)" 
                                                class="btn-action btn-action-success">
                                            <i class="fas fa-plus mr-2"></i>
                                            Adicionar Order Bump
                                        </button>
                                    </div>

                                    <!-- Lista de Order Bumps com Preview -->
                                    <template x-if="button.order_bumps && button.order_bumps.length > 0">
                                        <div class="space-y-6">
                                            <template x-for="(orderBump, bumpIndex) in button.order_bumps" :key="bumpIndex">
                                                <div class="order-bump-card-enhanced" 
                                                     :class="{'disabled': !orderBump.enabled}">
                                                    <!-- Header do Order Bump -->
                                                    <div class="flex justify-between items-start mb-4">
                                                        <div class="flex items-center gap-3">
                                                            <div class="order-bump-sequence-indicator">
                                                                <span class="order-bump-sequence-badge" x-text="bumpIndex + 1"></span>
                                                                <span class="order-bump-sequence-text">
                                                                    <span x-show="bumpIndex === 0">Primeiro Order Bump</span>
                                                                    <span x-show="bumpIndex > 0">Order Bump Sequencial (após recusa do anterior)</span>
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <label class="flex items-center gap-2 cursor-pointer px-3 py-1.5 bg-gray-800 border rounded-lg transition-all"
                                                                   :class="orderBump.enabled ? 'border-green-500 bg-green-500 bg-opacity-10' : 'border-gray-600'">
                                                                <input type="checkbox" 
                                                                       x-model="orderBump.enabled"
                                                                       class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                                            </label>
                                                            <button @click="removeOrderBump(index, bumpIndex)" 
                                                                    class="w-10 h-10 flex items-center justify-center rounded-lg border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10 transition-all"
                                                                    title="Remover order bump">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Layout: Configuração + Preview -->
                                                    <div x-show="orderBump.enabled" class="order-bump-layout">
                                                        <!-- Coluna Esquerda: Configuração -->
                                                        <div class="flex-1 space-y-4">
                                                            <!-- Mensagem do Order Bump -->
                                                            <div class="essential-field-group">
                                                                <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                                                    <i class="fas fa-comment-alt text-yellow-500"></i>
                                                                    Mensagem do Order Bump
                                                                    <span class="required-badge">*</span>
                                                                </h4>
                                                                <div class="form-group">
                                                                    <label class="form-label">
                                                                        <span class="field-help-tooltip" title="Mensagem que aparece no banner amarelo do Telegram">
                                                                            <i class="fas fa-question-circle tooltip-icon"></i>
                                                                        </span>
                                                                    </label>
                                                                    <textarea x-model="orderBump.message"
                                                                              class="form-textarea"
                                                                              maxlength="900"
                                                                              @input="orderBump.message = stripSurrogateChars(orderBump.message || '').slice(0, 900)"
                                                                              placeholder="🎁 Oferta Especial!&#10;&#10;Adicione este bônus por apenas +R$ 5!&#10;&#10;Ganhe acesso vitalício a conteúdos exclusivos!"
                                                                              rows="5"
                                                                              :class="{
                                                                                  'border-green-500': orderBump.message && orderBump.message.trim().length >= 10,
                                                                                  'border-red-500': orderBump.message && orderBump.message.trim().length > 0 && orderBump.message.trim().length < 10,
                                                                                  'border-gray-600': !orderBump.message
                                                                              }"></textarea>
                                                                    <div class="char-counter-wrapper mt-2">
                                                                        <p class="field-help-text">
                                                                            <i class="fas fa-lightbulb mr-1"></i>
                                                                            Use emojis e texto atrativo! Mínimo 10 caracteres recomendado.
                                                                        </p>
                                                                        <span class="char-counter"
                                                                              :class="{
                                                                                  'warning': orderBump.message && orderBump.message.length > 800,
                                                                                  'error': orderBump.message && orderBump.message.length > 900
                                                                              }"
                                                                              x-text="(orderBump.message?.length || 0) + '/900'">
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Preço e Descrição -->
                                                            <div class="essential-field-group">
                                                                <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                                                    <i class="fas fa-dollar-sign text-green-400"></i>
                                                                    Preço e Descrição
                                                                </h4>
                                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                    <div class="form-group">
                                                                        <label class="form-label label-with-badge">
                                                                            Preço Adicional
                                                                            <span class="required-badge">*</span>
                                                                        </label>
                                                                        <div class="price-input-wrapper">
                                                                            <span class="price-currency-symbol">+R$</span>
                                                                            <input type="number" 
                                                                                   x-model="orderBump.price" 
                                                                                   step="0.01"
                                                                                   min="0.01"
                                                                                   class="form-input"
                                                                                   placeholder="5.00"
                                                                                   :class="{
                                                                                       'border-green-500': orderBump.price && orderBump.price > 0,
                                                                                       'border-red-500': orderBump.price !== null && orderBump.price <= 0,
                                                                                       'border-gray-600': !orderBump.price
                                                                                   }">
                                                                        </div>
                                                                        <p class="field-help-text mt-1">
                                                                            <i class="fas fa-info-circle mr-1"></i>
                                                                            Valor adicional que o cliente pagará pelo bônus
                                                                        </p>
                                                                    </div>

                                                                    <div class="form-group">
                                                                        <label class="form-label">
                                                                            Descrição do Bônus
                                                                            <span class="field-help-tooltip" title="Nome curto do bônus (ex: Acesso Vitalício)">
                                                                                <i class="fas fa-question-circle tooltip-icon"></i>
                                                                            </span>
                                                                        </label>
                                                                        <input type="text" 
                                                                               x-model="orderBump.description" 
                                                                               class="form-input"
                                                                               placeholder="Ex: Acesso Vitalício, Bônus Exclusivo, etc.">
                                                                        <p class="field-help-text mt-1">
                                                                            <i class="fas fa-lightbulb mr-1"></i>
                                                                            Nome curto e atrativo do bônus
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Mídia (Opcional) -->
                                                            <div class="essential-field-group">
                                                                <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                                                    <i class="fas fa-image text-blue-400"></i>
                                                                    Mídia (Opcional)
                                                                </h4>
                                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                    <div class="form-group">
                                                                        <label class="form-label">
                                                                            <i class="fas fa-link mr-2 text-blue-500"></i>
                                                                            URL da Mídia
                                                                        </label>
                                                                        <input type="url" 
                                                                               x-model="orderBump.media_url" 
                                                                               class="form-input"
                                                                               placeholder="https://t.me/canal/789">
                                                                        <p class="field-help-text mt-1">Link do Telegram (vídeo ou foto)</p>
                                                                    </div>

                                                                    <div class="form-group">
                                                                        <label class="form-label">
                                                                            <i class="fas fa-image mr-2 text-blue-500"></i>
                                                                            Tipo de Mídia
                                                                        </label>
                                                                        <div class="flex gap-3 mt-2">
                                                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                                                   :class="{'border-blue-500 bg-blue-500 bg-opacity-10': orderBump.media_type === 'video'}">
                                                                                <input type="radio" x-model="orderBump.media_type" value="video" class="text-blue-500">
                                                                                <i class="fas fa-video text-blue-500"></i>
                                                                                <span class="text-sm text-white">Vídeo</span>
                                                                            </label>
                                                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                                                   :class="{'border-blue-500 bg-blue-500 bg-opacity-10': orderBump.media_type === 'photo'}">
                                                                                <input type="radio" x-model="orderBump.media_type" value="photo" class="text-blue-500">
                                                                                <i class="fas fa-camera text-blue-500"></i>
                                                                                <span class="text-sm text-white">Foto</span>
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Botões Personalizados (Opcional) -->
                                                            <div class="essential-field-group">
                                                                <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                                                    <i class="fas fa-mouse-pointer text-purple-400"></i>
                                                                    Botões Personalizados (Opcional)
                                                                </h4>
                                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                    <div class="form-group">
                                                                        <label class="form-label">
                                                                            <i class="fas fa-check-circle mr-2 text-green-400"></i>
                                                                            Texto do Botão Aceitar
                                                                        </label>
                                                                        <input type="text" 
                                                                               x-model="orderBump.accept_text" 
                                                                               class="form-input"
                                                                               placeholder="SIM! Quero esse bônus!">
                                                                        <p class="field-help-text mt-1">Deixe vazio para usar: "SIM! Quero esse bônus!"</p>
                                                                    </div>

                                                                    <div class="form-group">
                                                                        <label class="form-label">
                                                                            <i class="fas fa-times-circle mr-2 text-red-400"></i>
                                                                            Texto do Botão Recusar
                                                                        </label>
                                                                        <input type="text" 
                                                                               x-model="orderBump.decline_text" 
                                                                               class="form-input"
                                                                               placeholder="Não, obrigado">
                                                                        <p class="field-help-text mt-1">Deixe vazio para usar: "Não, obrigado"</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Coluna Direita: Preview do Telegram -->
                                                        <div class="order-bump-preview-card">
                                                            <div class="telegram-preview-header">
                                                                <div class="telegram-avatar-preview">
                                                                    <i class="fas fa-robot"></i>
                                                                </div>
                                                                <div class="telegram-info-preview">
                                                                    <div class="telegram-name-preview">Seu Bot</div>
                                                                    <div class="telegram-time-preview">Agora</div>
                                                                </div>
                                                            </div>

                                                            <!-- Preview do Order Bump -->
                                                            <template x-if="orderBump.message && orderBump.message.trim().length >= 10">
                                                                <div>
                                                                    <!-- Banner Amarelo -->
                                                                    <div class="order-bump-banner-preview">
                                                                        <div class="order-bump-badge-preview" x-text="'ORDER BUMP ' + (bumpIndex + 1)"></div>
                                                                        <div class="order-bump-message-preview" x-text="orderBump.message"></div>
                                                                        
                                                                        <template x-if="orderBump.media_url">
                                                                            <div class="order-bump-media-preview">
                                                                                <i class="fas" :class="orderBump.media_type === 'video' ? 'fa-video' : 'fa-image'"></i>
                                                                                <span class="ml-2" x-text="orderBump.media_type === 'video' ? 'Vídeo' : 'Foto'"></span>
                                                                            </div>
                                                                        </template>

                                                                        <!-- Botões -->
                                                                        <div class="order-bump-buttons-preview">
                                                                            <button class="order-bump-btn-accept-preview">
                                                                                <span x-text="orderBump.accept_text || 'SIM! Quero esse bônus!'"></span>
                                                                            </button>
                                                                            <button class="order-bump-btn-decline-preview">
                                                                                <span x-text="orderBump.decline_text || 'Não, obrigado'"></span>
                                                                            </button>
                                                                        </div>
                                                                    </div>

                                                                </div>
                                                            </template>
                                                            <template x-if="!orderBump.message || orderBump.message.trim().length < 10">
                                                                <div class="empty-state-preview">
                                                                    <div class="empty-state-preview-icon">🎁</div>
                                                                    <div class="empty-state-preview-text">
                                                                        Configure a mensagem do Order Bump para ver o preview
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Empty State Melhorado -->
                                    <template x-if="!button.order_bumps || button.order_bumps.length === 0">
                                        <div class="text-center py-12 border-2 border-dashed border-gray-700 rounded-xl bg-gray-900 bg-opacity-50">
                                            <div class="text-6xl mb-4">🎁</div>
                                            <h4 class="text-xl font-bold text-white mb-2">Nenhum Order Bump Configurado</h4>
                                            <p class="text-gray-400 mb-2">Order Bumps aparecem após o cliente escolher o produto</p>
                                            <p class="text-sm text-gray-500 mb-6">Adicione Order Bumps sequenciais para aumentar o ticket médio em até 80%!</p>
                                            <button @click="addOrderBump(index)" 
                                                    class="px-6 py-3 bg-yellow-500 bg-opacity-25 border-2 border-yellow-400 rounded-lg text-base font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                                <i class="fas fa-plus mr-2"></i>
                                                Adicionar Primeiro Order Bump
                                            </button>
                                        </div>
                                    </template>
                                </div>

                        <!-- ✅ UX MELHORADO: SISTEMA DE ASSINATURAS Auto-Intuitivo -->
                        <!-- Seção de Assinatura: Sempre Visível para Melhor UX -->
                        <div class="subscription-section mt-6 border-t border-gray-800 pt-6">
                            <!-- Card de Ativação/Explicação (quando desativado) -->
                            <div x-show="!button.subscription || !button.subscription.enabled" 
                                 x-cloak
                                 class="subscription-activation-card mb-6">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0">
                                        <div class="subscription-icon-large">
                                            <i class="fas fa-calendar-times"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                            <i class="fas fa-calendar-times text-yellow-500"></i>
                                            Acesso Temporário ao Grupo VIP
                                        </h3>
                                        <p class="text-sm text-gray-300 mb-4 leading-relaxed">
                                            Transforme este produto em uma <strong>assinatura temporária</strong>. O cliente receberá acesso ao grupo VIP por um período determinado. O tempo começa a contar quando ele entrar no grupo e expira automaticamente.
                                        </p>
                                        
                                        <!-- Benefícios Rápidos -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                            <div class="flex items-start gap-2 p-3 bg-gray-900 bg-opacity-80 border border-gray-700 rounded-lg">
                                                <i class="fas fa-clock text-yellow-400 mt-0.5 text-base"></i>
                                                <div>
                                                    <p class="text-sm font-bold text-white mb-1">Tempo Configurável</p>
                                                    <p class="text-xs text-gray-300 leading-relaxed">Horas, dias, semanas ou meses</p>
                                                </div>
                                            </div>
                                            <div class="flex items-start gap-2 p-3 bg-gray-900 bg-opacity-80 border border-gray-700 rounded-lg">
                                                <i class="fas fa-robot text-blue-400 mt-0.5 text-base"></i>
                                                <div>
                                                    <p class="text-sm font-bold text-white mb-1">Remoção Automática</p>
                                                    <p class="text-xs text-gray-300 leading-relaxed">Sistema remove quando expira</p>
                                                </div>
                                            </div>
                                            <div class="flex items-start gap-2 p-3 bg-gray-900 bg-opacity-80 border border-gray-700 rounded-lg">
                                                <i class="fas fa-shield-check text-green-400 mt-0.5 text-base"></i>
                                                <div>
                                                    <p class="text-sm font-bold text-white mb-1">Controle Total</p>
                                                    <p class="text-xs text-gray-300 leading-relaxed">Você define o tempo de acesso</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Botão de Ativação Destacado -->
                                        <button @click="if (!button.subscription) button.subscription = {enabled: true, duration_type: 'days', duration_value: 30, vip_chat_id: '', vip_group_link: '', validation_status: null}; button.subscription.enabled = true"
                                                class="w-full px-6 py-4 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold rounded-lg shadow-lg transition-all transform hover:scale-[1.02] flex items-center justify-center gap-3">
                                            <i class="fas fa-power-off text-xl"></i>
                                            <span>Ativar Acesso Temporário</span>
                                        </button>
                                        <p class="text-xs text-gray-400 text-center mt-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Você poderá configurar o tempo e grupo VIP após ativar
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuração (quando ativado) -->
                            <div x-show="button.subscription && button.subscription.enabled" x-cloak>
                            <!-- Header Melhorado -->
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-white flex items-center gap-2 mb-1">
                                        <i class="fas fa-calendar-times text-yellow-500"></i>
                                        Configuração de Acesso Temporário
                                    </h3>
                                    <p class="text-sm text-gray-400">Configure quanto tempo o cliente terá acesso ao grupo VIP após comprar</p>
                                </div>
                                <button @click="button.subscription.enabled = false"
                                        class="flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded-lg text-sm font-bold text-gray-300 transition-all">
                                    <i class="fas fa-times"></i>
                                    Desativar
                                </button>
                            </div>

                            <!-- Card de Explicação Visual do Fluxo -->
                            <div class="subscription-explanation-card mb-6">
                                <h4 class="text-base font-bold text-white mb-3 flex items-center gap-2">
                                    <i class="fas fa-question-circle text-yellow-500"></i>
                                    O que é Assinatura?
                                </h4>
                                <p class="text-sm text-gray-300 mb-4">
                                    Ao comprar este produto, o cliente recebe acesso temporário a um grupo VIP no Telegram. O tempo de acesso é contado a partir do momento que ele entra no grupo e expira automaticamente.
                                </p>
                                
                                <!-- Fluxo Visual -->
                                <div class="subscription-flow-steps">
                                    <div class="subscription-flow-step">
                                        <div class="subscription-flow-step-number">1</div>
                                        <div class="subscription-flow-step-title">Cliente Compra</div>
                                        <div class="subscription-flow-step-desc">Pagamento aprovado</div>
                                    </div>
                                    <div class="subscription-flow-arrow">→</div>
                                    <div class="subscription-flow-step">
                                        <div class="subscription-flow-step-number">2</div>
                                        <div class="subscription-flow-step-title">Recebe Acesso</div>
                                        <div class="subscription-flow-step-desc">Link para o grupo VIP</div>
                                    </div>
                                    <div class="subscription-flow-arrow">→</div>
                                    <div class="subscription-flow-step">
                                        <div class="subscription-flow-step-number">3</div>
                                        <div class="subscription-flow-step-title">Entra no Grupo</div>
                                        <div class="subscription-flow-step-desc">Contagem inicia</div>
                                    </div>
                                    <div class="subscription-flow-arrow">→</div>
                                    <div class="subscription-flow-step">
                                        <div class="subscription-flow-step-number">4</div>
                                        <div class="subscription-flow-step-title">Tempo Expira</div>
                                        <div class="subscription-flow-step-desc">Removido automaticamente</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Layout: Configuração + Preview -->
                            <div class="subscription-layout">
                                <!-- Coluna Esquerda: Configuração -->
                                <div class="flex-1 space-y-4">
                                    <!-- Card: Tempo de Acesso - UX Melhorada -->
                                    <div class="essential-field-group">
                                        <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                            <i class="fas fa-clock text-yellow-500"></i>
                                            ⏱️ Por Quanto Tempo o Cliente Terá Acesso?
                                            <span class="required-badge">*</span>
                                        </h4>
                                        
                                        <!-- Preview do Tempo Configurado -->
                                        <div class="mb-4 p-4 bg-yellow-500 bg-opacity-10 border border-yellow-400 border-opacity-30 rounded-lg" 
                                             x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                            <div class="flex items-center gap-3">
                                                <i class="fas fa-check-circle text-yellow-400 text-xl"></i>
                                                <div>
                                                    <p class="text-sm font-bold text-white">
                                                        Acesso configurado:
                                                    </p>
                                                    <p class="text-lg font-bold text-yellow-400 mt-1">
                                                        <span x-text="button.subscription.duration_value"></span> 
                                                        <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'mês' : 'meses')"></span>
                                                    </p>
                                                    <p class="text-xs text-gray-400 mt-1">
                                                        O contador inicia quando o cliente entrar no grupo
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="form-group">
                                                <label class="form-label">
                                                    Escolha a Unidade
                                                    <span class="field-help-tooltip" title="Como você quer medir o tempo de acesso?">
                                                        <i class="fas fa-question-circle tooltip-icon"></i>
                                                    </span>
                                                </label>
                                                <select x-model="button.subscription.duration_type" class="form-input">
                                                    <option value="hours">Horas</option>
                                                    <option value="days">Dias</option>
                                                    <option value="weeks">Semanas</option>
                                                    <option value="months">Meses</option>
                                                </select>
                                                <p class="field-help-text mt-1">
                                                    <i class="fas fa-info-circle mr-1"></i>
                                                    Selecione horas, dias, semanas ou meses
                                                </p>
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label label-with-badge">
                                                    Quantos?
                                                    <span class="required-badge">*</span>
                                                </label>
                                                <input type="number" 
                                                       x-model.number="button.subscription.duration_value"
                                                       min="1"
                                                       class="form-input text-center font-mono text-lg"
                                                       placeholder="Ex: 30"
                                                       :class="{
                                                           'border-green-500': button.subscription.duration_value && button.subscription.duration_value > 0,
                                                           'border-red-500': button.subscription.duration_value !== null && button.subscription.duration_value <= 0,
                                                           'border-gray-600': !button.subscription.duration_value
                                                       }">
                                                <p class="field-help-text mt-1">
                                                    <i class="fas fa-lightbulb mr-1"></i>
                                                    Digite o número (ex: 30 para 30 dias)
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Card: Grupo VIP - UX Melhorada -->
                                    <div class="essential-field-group">
                                        <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                            <i class="fas fa-users text-yellow-500"></i>
                                            👥 Qual Grupo VIP o Cliente Terá Acesso?
                                            <span class="required-badge">*</span>
                                        </h4>
                                        
                                        <div class="form-group">
                                            <label class="form-label label-with-badge">
                                                ID ou Link do Grupo VIP
                                                <span class="required-badge">*</span>
                                                <span class="field-help-tooltip" title="Cole o ID numérico do grupo ou o link completo">
                                                    <i class="fas fa-question-circle tooltip-icon"></i>
                                                </span>
                                            </label>
                                            <div class="relative">
                                                <input type="text" 
                                                       x-model="button.subscription.vip_chat_id"
                                                       class="form-input font-mono pr-10"
                                                       placeholder="Cole aqui: -1001234567890 ou https://t.me/joinchat/..."
                                                       :class="{
                                                           'border-green-500': button.subscription.validation_status === 'valid',
                                                           'border-red-500': button.subscription.validation_status === 'invalid',
                                                           'border-yellow-500': button.subscription.validation_status === 'validating',
                                                           'border-gray-600': !button.subscription.validation_status
                                                       }">
                                                <!-- Ícone de status no campo -->
                                                <i class="fas fa-check-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500" 
                                                   x-show="button.subscription.validation_status === 'valid'"></i>
                                                <i class="fas fa-times-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500" 
                                                   x-show="button.subscription.validation_status === 'invalid'"></i>
                                                <i class="fas fa-spinner fa-spin absolute right-3 top-1/2 transform -translate-y-1/2 text-yellow-500" 
                                                   x-show="button.subscription.validation_status === 'validating'"></i>
                                            </div>
                                            
                                            <!-- Botão de Validação Integrado -->
                                            <div class="mt-3">
                                                <button @click="validateSubscription(index)" 
                                                        :disabled="button.subscription.validation_status === 'validating' || !button.subscription.vip_chat_id"
                                                        class="w-full px-4 py-2.5 bg-yellow-500 bg-opacity-25 border-2 border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                                    <i class="fas fa-shield-check"></i>
                                                    <span x-show="button.subscription.validation_status !== 'validating'">Verificar se o Grupo está OK</span>
                                                    <span x-show="button.subscription.validation_status === 'validating'">Verificando...</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Status de Validação -->
                                            <template x-if="button.subscription.validation_status === 'valid'">
                                                <div class="subscription-validation-badge valid">
                                                    <i class="fas fa-check-circle"></i>
                                                    Grupo válido e acessível
                                                </div>
                                            </template>
                                            <template x-if="button.subscription.validation_status === 'invalid'">
                                                <div class="subscription-validation-badge invalid">
                                                    <i class="fas fa-times-circle"></i>
                                                    Grupo inválido ou inacessível
                                                </div>
                                            </template>
                                            <template x-if="button.subscription.validation_status === 'validating'">
                                                <div class="subscription-validation-badge pending">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                    Validando grupo...
                                                </div>
                                            </template>
                                            <template x-if="!button.subscription.validation_status && button.subscription.vip_chat_id">
                                                <div class="subscription-validation-badge pending">
                                                    <i class="fas fa-exclamation-circle"></i>
                                                    Clique em "Verificar Grupo" para validar
                                                </div>
                                            </template>

                                            <!-- ✅ Guia Visual Melhorado: Como Encontrar o ID (Colapsável) -->
                                            <div class="subscription-guide-card">
                                                <!-- Header Colapsável -->
                                                <button @click="subscriptionGuideExpanded = !subscriptionGuideExpanded"
                                                        class="subscription-guide-header-button">
                                                    <div class="subscription-guide-header-left">
                                                        <i class="fas fa-lightbulb subscription-guide-header-icon"></i>
                                                        <span class="subscription-guide-header-title">
                                                            📋 Como Encontrar o ID do Grupo/Canal?
                                                        </span>
                                                    </div>
                                                    <div class="subscription-guide-header-right">
                                                        <span class="subscription-guide-header-hint" x-show="!subscriptionGuideExpanded">
                                                            Clique para ver o tutorial
                                                        </span>
                                                        <i class="fas fa-chevron-down subscription-guide-chevron"
                                                           :class="{'rotated': subscriptionGuideExpanded}"></i>
                                                    </div>
                                                </button>
                                                
                                                <!-- Conteúdo Expansível -->
                                                <div x-show="subscriptionGuideExpanded" 
                                                     x-collapse
                                                     class="subscription-guide-content">
                                                    <!-- Tabs: Grupo ou Canal -->
                                                    <div class="subscription-guide-tabs">
                                                    <button @click="subscriptionGuideTab = 'group'" 
                                                            :class="{'active': subscriptionGuideTab === 'group'}"
                                                            class="subscription-guide-tab">
                                                        <i class="fas fa-users mr-2"></i>
                                                        Grupo
                                                    </button>
                                                    <button @click="subscriptionGuideTab = 'channel'" 
                                                            :class="{'active': subscriptionGuideTab === 'channel'}"
                                                            class="subscription-guide-tab">
                                                        <i class="fas fa-bullhorn mr-2"></i>
                                                        Canal
                                                    </button>
                                                </div>

                                                <!-- Tutorial para GRUPO -->
                                                <div x-show="subscriptionGuideTab === 'group'" class="subscription-guide-tutorial">
                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">1</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Entre no grupo e clique no ícone de editar
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Abra o grupo VIP no Telegram e clique no ícone de <strong>editar</strong> (⚙️) no canto superior direito
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">2</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Clique em "Administradores"
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                No menu de configurações, selecione a opção <strong>Administradores</strong>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">3</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Adicione o bot @ScanIDBot como administrador
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Clique no botão de <strong>adicionar administrador</strong> e busque pelo bot:
                                                                <div class="subscription-guide-bot-name mt-2">@ScanIDBot</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">4</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Dê as permissões necessárias ao bot
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Ative as permissões:
                                                                <div class="subscription-guide-step-highlight mt-2">
                                                                    ✅ Enviar mensagens<br>
                                                                    ✅ Gerenciar mensagens<br>
                                                                    ✅ Ver mensagens anteriores
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">5</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Copie o ID que o bot enviar
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Após adicionar o bot, ele enviará automaticamente uma mensagem com o ID do grupo:
                                                                <div class="subscription-guide-example-id mt-2">
                                                                    Forwarded from chat: -1002456312807
                                                                </div>
                                                                <div class="text-xs text-gray-400 mt-2">
                                                                    Copie apenas o número (ex: -1002456312807)
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Dicas Importantes para Grupo -->
                                                    <div class="subscription-guide-important-tips">
                                                        <div class="subscription-guide-tips-title">
                                                            <i class="fas fa-star"></i>
                                                            Dicas Importantes
                                                        </div>
                                                        <div class="subscription-guide-tip-item">
                                                            <i class="fas fa-circle subscription-guide-tip-icon" style="font-size: 0.5rem;"></i>
                                                            <span>IDs de grupos geralmente começam com <strong>-100</strong></span>
                                                        </div>
                                                        <div class="subscription-guide-tip-item">
                                                            <i class="fas fa-circle subscription-guide-tip-icon" style="font-size: 0.5rem;"></i>
                                                            <span><strong>Importante:</strong> Deixe o histórico do grupo visível nas configurações!</span>
                                                        </div>
                                                        <div class="subscription-guide-tip-item">
                                                            <i class="fas fa-circle subscription-guide-tip-icon" style="font-size: 0.5rem;"></i>
                                                            <span>Certifique-se de que o bot tenha permissões para enviar mensagens</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Tutorial para CANAL -->
                                                <div x-show="subscriptionGuideTab === 'channel'" class="subscription-guide-tutorial">
                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">1</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Busque o bot @ScanIDBot
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Na barra de pesquisa do Telegram, busque por:
                                                                <div class="subscription-guide-bot-name mt-2">@ScanIDBot</div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">2</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Encaminhe uma mensagem do canal
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Abra o canal e pegue <strong>qualquer mensagem</strong> que esteja lá. Depois, encaminhe essa mensagem para o bot @ScanIDBot
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">3</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Selecione o @ScanIDBot como destino
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Após clicar em encaminhar, selecione o <strong>@ScanIDBot</strong> como destino da mensagem
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">4</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Envie a mensagem para o bot
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                Clique no botão de <strong>enviar</strong> para encaminhar a mensagem. O bot processará e responderá com o ID do canal
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="subscription-guide-step-card">
                                                        <div class="subscription-guide-step-number">5</div>
                                                        <div class="subscription-guide-step-content">
                                                            <div class="subscription-guide-step-title">
                                                                Copie o ID que o bot enviar
                                                            </div>
                                                            <div class="subscription-guide-step-desc">
                                                                O bot responderá com uma mensagem como:
                                                                <div class="subscription-guide-example-id mt-2">
                                                                    Forwarded from chat: -1002271015104
                                                                </div>
                                                                <div class="text-xs text-gray-400 mt-2">
                                                                    Copie apenas o número (ex: -1002271015104)
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Dicas Importantes para Canal -->
                                                    <div class="subscription-guide-important-tips">
                                                        <div class="subscription-guide-tips-title">
                                                            <i class="fas fa-star"></i>
                                                            Dicas Importantes
                                                        </div>
                                                        <div class="subscription-guide-tip-item">
                                                            <i class="fas fa-circle subscription-guide-tip-icon" style="font-size: 0.5rem;"></i>
                                                            <span>IDs de canais geralmente começam com <strong>-100</strong></span>
                                                        </div>
                                                        <div class="subscription-guide-tip-item">
                                                            <i class="fas fa-circle subscription-guide-tip-icon" style="font-size: 0.5rem;"></i>
                                                            <span>Certifique-se de que o bot tenha permissão para enviar mensagens no seu canal</span>
                                                        </div>
                                                        <div class="subscription-guide-tip-item">
                                                            <i class="fas fa-circle subscription-guide-tip-icon" style="font-size: 0.5rem;"></i>
                                                            <span>Você pode usar qualquer mensagem do canal para encaminhar</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                </div>
                                                <!-- Fim do Conteúdo Expansível -->
                                            </div>
                                        </div>

                                        <div class="form-group mt-4">
                                            <label class="form-label">
                                                <i class="fas fa-link mr-2 text-blue-400"></i>
                                                Link do Grupo (Opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="button.subscription.vip_group_link"
                                                   class="form-input"
                                                   placeholder="https://t.me/joinchat/... ou https://t.me/c/...">
                                            <p class="field-help-text mt-1">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Link completo do grupo (para referência e acesso direto)
                                            </p>
                                        </div>

                                    </div>
                                </div>

                                <!-- Coluna Direita: Preview do Cliente -->
                                <div class="subscription-preview-card">
                                    <div class="telegram-preview-header">
                                        <div class="telegram-avatar-preview">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="telegram-info-preview">
                                            <div class="telegram-name-preview">Seu Bot</div>
                                            <div class="telegram-time-preview">Após pagamento</div>
                                        </div>
                                    </div>

                                    <div class="subscription-preview-message">
                                        <div class="subscription-preview-title">
                                            ✅ Pagamento Aprovado!
                                        </div>
                                        <div class="subscription-preview-duration" x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                            🎉 Parabéns! Você ganhou acesso ao <strong>Grupo VIP</strong> por 
                                            <strong x-text="button.subscription.duration_value"></strong> 
                                            <span x-text="button.subscription.duration_type === 'hours' ? 'horas' : button.subscription.duration_type === 'days' ? 'dias' : button.subscription.duration_type === 'weeks' ? 'semanas' : 'meses'"></span>
                                            !
                                        </div>
                                        <div class="subscription-preview-duration" x-show="!button.subscription.duration_value || button.subscription.duration_value <= 0">
                                            🎉 Parabéns! Você ganhou acesso ao <strong>Grupo VIP</strong>!
                                            <br><span class="text-xs text-gray-500">Configure o tempo de acesso para ver o preview completo</span>
                                        </div>
                                    </div>

                                    <template x-if="button.subscription.vip_chat_id || button.subscription.vip_group_link">
                                        <button class="subscription-preview-button">
                                            <i class="fas fa-users"></i>
                                            <span>Entrar no Grupo VIP</span>
                                        </button>
                                    </template>
                                    <template x-if="!button.subscription.vip_chat_id && !button.subscription.vip_group_link">
                                        <button class="subscription-preview-button" style="opacity: 0.6; background: #9CA3AF; cursor: not-allowed;">
                                            <i class="fas fa-users"></i>
                                            <span>Configure o grupo VIP</span>
                                        </button>
                                    </template>

                                    <div class="subscription-preview-info">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>Importante:</strong> A contagem de tempo começa quando o cliente entrar no grupo. Após o tempo expirar, ele será removido automaticamente pelo sistema.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="config.main_buttons.length === 0">
            <div class="text-center py-16">
                <div class="text-6xl mb-4">🛍️</div>
                <h3 class="text-xl font-bold text-white mb-2">Nenhum botão criado</h3>
                <p class="text-gray-500 mb-6">Adicione seus primeiros botões de venda</p>
                <button @click="addButton()" class="btn-action btn-action-success">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Primeiro Botão
                </button>
            </div>
        </template>
    </div>

    <!-- Botões de Redirecionamento (dentro da tab Botões) -->
    <div x-show="activeTab === 'buttons'" x-cloak class="mt-8">
        <div class="border-t border-gray-800 pt-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-external-link-alt text-blue-500"></i>
                        Botões de Link
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Botões que levam para links externos (sem pagamento)</p>
                </div>
                <button @click="addRedirectButton()" class="btn-action btn-action-info">
                    <i class="fas fa-plus"></i>
                    Adicionar Link
                </button>
            </div>

            <template x-if="config.redirect_buttons.length > 0">
                <div class="space-y-3">
                    <template x-for="(button, index) in config.redirect_buttons" :key="index">
                        <div class="flex items-center gap-3 p-4 bg-gray-900 border border-gray-800 rounded-lg">
                            <i class="fas fa-link text-blue-500"></i>
                            <input type="text" 
                                   x-model="button.text" 
                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white text-sm"
                                   placeholder="Texto do botão">
                            <input type="url" 
                                   x-model="button.url" 
                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white text-sm font-mono"
                                   placeholder="https://...">
                            <button @click="removeRedirectButton(index)" 
                                    class="w-10 h-10 flex items-center justify-center rounded border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </template>

            <template x-if="config.redirect_buttons.length === 0">
                <div class="text-center py-8 border-2 border-dashed border-gray-800 rounded-lg">
                    <i class="fas fa-external-link-alt text-4xl text-gray-700 mb-2"></i>
                    <p class="text-sm text-gray-500">Nenhum botão de link configurado</p>
                    <p class="text-xs text-gray-600 mt-1">Use para grupos, canais, sites externos, etc.</p>
                </div>
            </template>
        </div>
    </div>

    <!-- Tab Content: Downsells -->
    <div x-show="activeTab === 'downsells'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-arrow-down text-2xl text-red-400"></i>
                <div>
                    <div class="config-section-title">Downsells</div>
                    <div class="config-section-description">Ofertas enviadas quando o pagamento não é confirmado</div>
                </div>
                <label class="ml-auto flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" 
                           x-model="config.downsells_enabled"
                           class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                    <span class="text-sm font-bold text-white">Habilitar</span>
                </label>
            </div>

            <div x-show="config.downsells_enabled" class="space-y-4">
                <template x-for="(downsell, index) in config.downsells" :key="index">
                    <div class="button-card">
                        <div class="button-card-header">
                            <h4 class="text-sm font-bold text-white">Downsell <span x-text="index + 1"></span></h4>
                            <button @click="removeDownsell(index)" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Delay (minutos)</label>
                                <input type="number" x-model="downsell.delay_minutes" class="form-input" placeholder="5">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensagem</label>
                                <textarea x-model="downsell.message"
                                          class="form-textarea"
                                          maxlength="900"
                                          @input="downsell.message = stripSurrogateChars(downsell.message || '').slice(0, 900)"
                                          placeholder="Oferta especial!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                            </div>

                            <!-- ✅ MODO DE PRECIFICAÇÃO (Preço Fixo vs Desconto %) -->
                            <div class="p-4 bg-gray-900 border border-gray-800 rounded-xl">
                                <label class="form-label mb-3">
                                    <i class="fas fa-calculator mr-2" style="color: var(--brand-gold-500);"></i>
                                    <span class="text-white font-bold">Modo de Precificação</span>
                                </label>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <button type="button"
                                            @click="downsell.pricing_mode = 'fixed'"
                                            :class="(downsell.pricing_mode || 'fixed') === 'fixed' ? 'pricing-btn-active' : 'pricing-btn-inactive'"
                                            class="pricing-btn">
                                        <i class="fas fa-dollar-sign"></i>
                                        Preço Fixo
                                    </button>
                                    <button type="button"
                                            @click="downsell.pricing_mode = 'percentage'"
                                            :class="downsell.pricing_mode === 'percentage' ? 'pricing-btn-active' : 'pricing-btn-inactive'"
                                            class="pricing-btn">
                                        <i class="fas fa-percent"></i>
                                        Desconto %
                                    </button>
                                </div>

                                <!-- Modo: Preço Fixo -->
                                <div x-show="(downsell.pricing_mode || 'fixed') === 'fixed'" class="form-group">
                                    <label class="form-label">Preço Fixo (R$)</label>
                                    <input type="number" 
                                           x-model="downsell.price" 
                                           step="0.01" 
                                           class="form-input text-center font-mono font-bold"
                                           placeholder="14.97">
                                    <div class="info-box mt-2">
                                        <p class="text-xs text-gray-400">
                                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                                            Valor fixo do downsell
                                        </p>
                                    </div>
                                </div>

                                <!-- Modo: Desconto Percentual -->
                                <div x-show="downsell.pricing_mode === 'percentage'" class="form-group">
                                    <label class="form-label">Desconto Percentual (%)</label>
                                    <input type="number" 
                                           x-model="downsell.discount_percentage" 
                                           min="1" 
                                           max="95" 
                                           step="1" 
                                           class="form-input text-center font-mono font-bold"
                                           placeholder="50">
                                    <div class="info-box-warning info-box mt-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-magic mr-1" style="color: var(--brand-gold-500);"></i>
                                            <strong style="color: var(--brand-gold-500);">Exemplo:</strong> 
                                            50% de R$ 19,97 = R$ 9,99
                                        </p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            O desconto é calculado sobre o preço do botão que o cliente clicou
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Mídia (URL + Tipo) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-link mr-2 text-blue-500"></i>
                                        URL da Mídia (opcional)
                                    </label>
                                    <input type="url" 
                                           x-model="downsell.media_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/123">
                                    <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-image mr-2 text-blue-500"></i>
                                            Tipo de Mídia Principal
                                        </label>
                                        <div class="flex gap-3 mt-2">
                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-colors flex-1"
                                                   :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.media_type === 'video'}">
                                                <input type="radio" x-model="downsell.media_type" value="video" class="text-yellow-500">
                                                <i class="fas fa-video text-yellow-500"></i>
                                                <span class="text-sm text-white">Vídeo</span>
                                            </label>
                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-colors flex-1"
                                                   :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.media_type === 'photo'}">
                                                <input type="radio" x-model="downsell.media_type" value="photo" class="text-yellow-500">
                                                <i class="fas fa-camera text-yellow-500"></i>
                                                <span class="text-sm text-white">Foto</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label flex items-center gap-2">
                                            <input type="checkbox" 
                                                   x-model="downsell.audio_enabled"
                                                   class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                                   style="accent-color: #A855F7;">
                                            <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                            <span>Adicionar Áudio Complementar</span>
                                        </label>
                                        <div x-show="downsell.audio_enabled" x-cloak class="mt-2">
                                            <input type="url" 
                                                   x-model="downsell.audio_url" 
                                                   class="form-input"
                                                   placeholder="https://t.me/canal/audio2">
                                            <p class="text-xs text-gray-500 mt-2">Áudio enviado após a mídia principal</p>
                                        </div>
                                    </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mouse-pointer mr-2 text-green-400"></i>
                                    Texto do Botão (opcional)
                                </label>
                                <input type="text" 
                                       x-model="downsell.button_text" 
                                       class="form-input" 
                                       placeholder="🛒 Comprar Agora!">
                                <div class="info-box mt-2">
                                    <p class="text-xs text-gray-400">
                                        <i class="fas fa-lightbulb mr-1" style="color: var(--brand-gold-500);"></i>
                                        Deixe vazio para usar: "🛒 Comprar por R$ XX,XX"
                                    </p>
                                </div>
                            </div>

                            <!-- Order Bump para Downsell V2.0 -->
                            <div class="order-bump-section">
                                <div class="flex items-center justify-between mb-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" 
                                               x-model="downsell.order_bump.enabled"
                                               class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                        <span class="text-sm font-bold text-white">
                                            <i class="fas fa-gift mr-2 text-yellow-500"></i>
                                            Order Bump (Oferta Extra no Downsell)
                                        </span>
                                    </label>
                                    <span x-show="downsell.order_bump.enabled" 
                                          class="px-3 py-1.5 bg-green-500 bg-opacity-25 border-2 border-green-400 rounded-full text-xs font-bold text-white shadow-lg"
                                          style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%);">
                                        <i class="fas fa-check-circle mr-1 text-green-300"></i>
                                        ATIVO
                                    </span>
                                </div>

                                <div x-show="downsell.order_bump.enabled" class="space-y-4">
                                    <!-- ✅ V2.0: Order Bumps dos Botões Principais (Botões Clicáveis) -->
                                    <div class="form-group" x-show="getAvailableOrderBumps().length > 0">
                                        <label class="form-label mb-3">
                                            <i class="fas fa-gift mr-2 text-yellow-500"></i>
                                            Order Bumps Configurados nos Botões
                                        </label>
                                        <p class="text-xs text-gray-500 mb-3">
                                            Clique em um order bump abaixo para usá-lo neste downsell. Estes são os order bumps que você já configurou na aba "Botões".
                                        </p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            <template x-for="(orderBumpRef, idx) in getAvailableOrderBumps()" :key="idx">
                                                <button 
                                                    type="button"
                                                    @click="useOrderBumpFromButtons(downsell, orderBumpRef.buttonIndex, orderBumpRef.bumpIndex)"
                                                    class="p-4 bg-gray-800 border-2 rounded-lg transition-all text-left hover:border-yellow-500 hover:bg-gray-750"
                                                    :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.order_bump.button_index === orderBumpRef.buttonIndex && downsell.order_bump.bump_index === orderBumpRef.bumpIndex, 'border-gray-700': downsell.order_bump.button_index !== orderBumpRef.buttonIndex || downsell.order_bump.bump_index !== orderBumpRef.bumpIndex}"
                                                >
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-gift text-yellow-500"></i>
                                                            <span class="text-sm font-bold text-white">
                                                                Botão <span x-text="orderBumpRef.buttonIndex + 1"></span> - OB <span x-text="orderBumpRef.bumpIndex + 1"></span>
                                                            </span>
                                                        </div>
                                                        <span x-show="downsell.order_bump.button_index === orderBumpRef.buttonIndex && downsell.order_bump.bump_index === orderBumpRef.bumpIndex" 
                                                              class="px-2 py-1 bg-green-500 bg-opacity-25 border border-green-400 rounded text-xs text-green-300">
                                                            <i class="fas fa-check-circle"></i>
                                                        </span>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mb-1 line-clamp-2" x-text="(orderBumpRef.message || 'Sem mensagem').substring(0, 60) + '...'"></p>
                                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-700">
                                                        <div>
                                                            <span class="text-xs font-bold text-yellow-500" x-show="orderBumpRef.price > 0">
                                                                R$ <span x-text="parseFloat(orderBumpRef.price || 0).toFixed(2)"></span>
                                                            </span>
                                                            <span class="text-xs text-gray-500" x-show="orderBumpRef.price === 0 || !orderBumpRef.price">
                                                                Sem preço
                                                            </span>
                                                        </div>
                                                        <span class="text-xs text-gray-400 truncate max-w-[60%]" x-text="orderBumpRef.description || 'Sem descrição'"></span>
                                                    </div>
                                                </button>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Empty State: Nenhum Order Bump Configurado -->
                                    <div x-show="getAvailableOrderBumps().length === 0" class="info-box-warning info-box">
                                        <p class="text-sm text-gray-300">
                                            <i class="fas fa-info-circle mr-2 text-yellow-500"></i>
                                            <strong>Nenhum order bump configurado:</strong> Vá na aba "Botões", configure seus botões principais e adicione order bumps lá. 
                                            Eles aparecerão aqui como botões clicáveis para reutilizar nos downsells.
                                        </p>
                                    </div>

                                    <!-- Divider: Configuração Manual -->
                                    <div class="flex items-center gap-3 my-4">
                                        <div class="flex-1 border-t border-gray-700"></div>
                                        <span class="text-xs text-gray-500 font-semibold">OU CONFIGURE MANUALMENTE</span>
                                        <div class="flex-1 border-t border-gray-700"></div>
                                    </div>

                                    <!-- Configuração Manual -->
                                    <div>
                                    <div class="form-group">
                                        <label class="form-label">Mensagem do Order Bump</label>
                                        <textarea x-model="downsell.order_bump.message"
                                                  class="form-textarea"
                                                  maxlength="900"
                                                  @input="downsell.order_bump.message = stripSurrogateChars(downsell.order_bump.message || '').slice(0, 900)"
                                                  placeholder="🎁 Oferta Especial!&#10;&#10;Adicione este bônus por apenas +R$ 5!"></textarea>
                                        <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Preço Adicional (R$)</label>
                                            <input type="number" 
                                                   x-model="downsell.order_bump.price" 
                                                   step="0.01"
                                                   class="form-input text-center font-mono"
                                                   placeholder="5.00">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Descrição do Bônus</label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.description" 
                                                   class="form-input"
                                                   placeholder="Acesso Vitalício">
                                        </div>
                                    </div>

                                    <!-- Mídia do Order Bump -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-link mr-2 text-blue-500"></i>
                                                URL da Mídia (opcional)
                                            </label>
                                            <input type="url" 
                                                   x-model="downsell.order_bump.media_url" 
                                                   class="form-input"
                                                   placeholder="https://t.me/canal/789">
                                            <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-image mr-2 text-blue-500"></i>
                                                Tipo de Mídia
                                            </label>
                                            <div class="flex gap-3 mt-2">
                                                <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                       :class="{'border-blue-500 bg-blue-500 bg-opacity-10': downsell.order_bump.media_type === 'video'}">
                                                    <input type="radio" x-model="downsell.order_bump.media_type" value="video" class="text-blue-500">
                                                    <i class="fas fa-video text-blue-500"></i>
                                                    <span class="text-sm text-white">Vídeo</span>
                                                </label>
                                                <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                       :class="{'border-blue-500 bg-blue-500 bg-opacity-10': downsell.order_bump.media_type === 'photo'}">
                                                    <input type="radio" x-model="downsell.order_bump.media_type" value="photo" class="text-blue-500">
                                                    <i class="fas fa-camera text-blue-500"></i>
                                                    <span class="text-sm text-white">Foto</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botões Personalizados -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-check-circle mr-2 text-green-400"></i>
                                                Botão Aceitar (opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.accept_text" 
                                                   class="form-input"
                                                   placeholder="SIM! Quero esse bônus!">
                                            <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padrão</p>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-times-circle mr-2 text-red-400"></i>
                                                Botão Recusar (opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.decline_text" 
                                                   class="form-input"
                                                   placeholder="Não, obrigado">
                                            <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padrão</p>
                                        </div>
                                    </div>

                                    </div>

                                    <!-- Preview do Order Bump Selecionado dos Botões -->
                                    <div x-show="downsell.order_bump.button_index !== null && downsell.order_bump.button_index !== undefined && downsell.order_bump.bump_index !== null && downsell.order_bump.bump_index !== undefined" 
                                         class="info-box-success info-box" 
                                         style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10B981;">
                                        <div class="flex items-start gap-3">
                                            <i class="fas fa-check-circle text-green-400 text-xl mt-1"></i>
                                            <div class="flex-1">
                                                <p class="text-sm font-bold text-white mb-2">
                                                    ✅ Order Bump dos Botões Selecionado
                                                </p>
                                                <div class="space-y-1 text-sm text-gray-300">
                                                    <p><strong>Origem:</strong> Botão <span x-text="(downsell.order_bump.button_index || 0) + 1"></span> - Order Bump <span x-text="(downsell.order_bump.bump_index || 0) + 1"></span></p>
                                                    <p><strong>Preço:</strong> R$ <span x-text="(parseFloat(downsell.order_bump.price) || 0).toFixed(2)"></span></p>
                                                    <p><strong>Descrição:</strong> <span x-text="downsell.order_bump.description || 'Sem descrição'"></span></p>
                                                    <p x-show="downsell.order_bump.message" class="mt-2 text-xs text-gray-400 line-clamp-2"><strong>Mensagem:</strong> <span x-text="downsell.order_bump.message"></span></p>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-info-circle mr-1"></i>
                                                    Este order bump está sendo reutilizado dos botões principais. Para alterar, edite na aba "Botões" ou configure manualmente acima.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="addDownsell()" class="w-full py-3 border-2 border-dashed border-gray-700 rounded-lg text-gray-400 hover:border-yellow-500 hover:text-yellow-500 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Downsell
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Upsells -->
    <div x-show="activeTab === 'upsells'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-arrow-up text-2xl text-green-400"></i>
                <div>
                    <div class="config-section-title">Upsells</div>
                    <div class="config-section-description">Ofertas enviadas APÓS compra aprovada</div>
                </div>
                <label class="ml-auto flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" 
                           x-model="config.upsells_enabled"
                           class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-green-500">
                    <span class="text-sm font-bold text-white">Habilitar</span>
                </label>
            </div>

            <div x-show="config.upsells_enabled" class="space-y-4">
                <template x-for="(upsell, index) in config.upsells" :key="index">
                    <div class="button-card">
                        <div class="button-card-header">
                            <h4 class="text-sm font-bold text-white">Upsell <span x-text="index + 1"></span></h4>
                            <button @click="removeUpsell(index)" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Produto Trigger (opcional)</label>
                                <input type="text" x-model="upsell.trigger_product" class="form-input" placeholder="Ex: INSS Básico (vazio = todos)">
                                <p class="text-xs text-gray-500 mt-1">Deixe vazio para disparar em todas as compras</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Delay (minutos)</label>
                                <input type="number" x-model="upsell.delay_minutes" class="form-input" placeholder="0">
                                <p class="text-xs text-gray-500 mt-1">0 = envio imediato após pagamento</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensagem</label>
                                <textarea x-model="upsell.message"
                                          class="form-textarea"
                                          maxlength="900"
                                          @input="upsell.message = stripSurrogateChars(upsell.message || '').slice(0, 900)"
                                          placeholder="🔥 Upgrade para Premium!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">Máximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                            </div>

                            <!-- Mídia (URL + Tipo) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-link mr-2 text-blue-500"></i>
                                        URL da Mídia (opcional)
                                    </label>
                                    <input type="url" 
                                           x-model="upsell.media_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/456">
                                    <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-image mr-2 text-blue-500"></i>
                                        Tipo de Mídia Principal
                                    </label>
                                    <div class="flex gap-3 mt-2">
                                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': upsell.media_type === 'video'}">
                                            <input type="radio" x-model="upsell.media_type" value="video" class="text-blue-500">
                                            <i class="fas fa-video text-blue-500"></i>
                                            <span class="text-sm text-white">Vídeo</span>
                                        </label>
                                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': upsell.media_type === 'photo'}">
                                            <input type="radio" x-model="upsell.media_type" value="photo" class="text-blue-500">
                                            <i class="fas fa-camera text-blue-500"></i>
                                            <span class="text-sm text-white">Foto</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label flex items-center gap-2">
                                        <input type="checkbox" 
                                               x-model="upsell.audio_enabled"
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               style="accent-color: #A855F7;">
                                        <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                        <span>Adicionar Áudio Complementar</span>
                                    </label>
                                    <div x-show="upsell.audio_enabled" x-cloak class="mt-2">
                                        <input type="url" 
                                               x-model="upsell.audio_url" 
                                               class="form-input"
                                               placeholder="https://t.me/canal/audio3">
                                        <p class="text-xs text-gray-500 mt-2">Áudio enviado após a mídia principal</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-box-warning info-box">
                                <p class="text-sm text-gray-300">
                                    <i class="fas fa-rocket mr-2 text-yellow-500"></i>
                                    <strong>Dica:</strong> <strong>Vídeos</strong> aumentam conversão em upsells (cliente já confia).
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Nome do Produto</label>
                                    <input type="text" x-model="upsell.product_name" class="form-input" placeholder="INSS Premium">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Preço (R$)</label>
                                    <input type="number" x-model="upsell.price" step="0.01" class="form-input" placeholder="97.00">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mouse-pointer mr-2 text-green-400"></i>
                                    Texto do Botão (opcional)
                                </label>
                                <input type="text" 
                                       x-model="upsell.button_text" 
                                       class="form-input" 
                                       placeholder="🚀 Quero fazer Upgrade!">
                                <div class="info-box mt-2">
                                    <p class="text-xs text-gray-400">
                                        <i class="fas fa-lightbulb mr-1" style="color: var(--brand-gold-500);"></i>
                                        Deixe vazio para usar texto padrão
                                    </p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-link mr-2 text-blue-400"></i>
                                    Link do Entregável
                                </label>
                                <input type="url" 
                                       x-model="upsell.access_link" 
                                       class="form-input" 
                                       placeholder="https://t.me/+seugrupo ou https://seusite.com/produto">
                                <p class="text-xs text-gray-500 mt-1">
                                    Link para onde o cliente será redirecionado após pagar este upsell
                                </p>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="addUpsell()" class="w-full py-3 border-2 border-dashed border-gray-700 rounded-lg text-gray-400 hover:border-green-500 hover:text-green-500 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Upsell
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Access -->
    <div x-show="activeTab === 'access'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-key text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Acesso ao Produto</div>
                    <div class="config-section-description">Link de entrega e mensagens</div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Link -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        Link de Acesso
                    </label>
                    
                    <input type="url" 
                           x-model="config.access_link" 
                           class="form-input"
                           :class="{'bg-opacity-50': config.has_meta_pixel}"
                           :placeholder="config.has_meta_pixel ? 'https://t.me/+seugrupo (Link final após Purchase)' : 'https://t.me/+seugrupo'">
                    <div class="info-box mt-2">
                        <p class="text-sm text-gray-300" x-show="!config.has_meta_pixel">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Pode ser grupo/canal do Telegram, área de membros, etc.
                        </p>
                    </div>
                </div>

                <!-- Mensagem Sucesso -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        Mensagem de Pagamento Aprovado
                    </label>
                    <textarea x-model="config.success_message" 
                              class="form-textarea"
                              placeholder="✅ Pagamento confirmado!&#10;&#10;Acesse seu produto: {link}"></textarea>
                    <div class="info-box-success info-box mt-2">
                        <p class="text-sm text-gray-300">
                            <strong class="text-green-400">Variáveis:</strong>
                            <code class="ml-2 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{produto}</code>
                            <code class="ml-1 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{valor}</code>
                            <code class="ml-1 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{link}</code>
                        </p>
                    </div>
                </div>

                <!-- Mensagem Pendente -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock mr-2 text-yellow-500"></i>
                        Mensagem de Pagamento Pendente
                    </label>
                    <textarea x-model="config.pending_message" 
                              class="form-textarea"
                              placeholder="⏳ Aguardando confirmação do pagamento..."></textarea>
                    <div class="info-box-warning info-box mt-2">
                        <p class="text-sm text-gray-300">
                            <strong class="text-yellow-400">Variável:</strong>
                            <code class="ml-2 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{pix_code}</code>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Settings (Trocar Token) -->
    <div x-show="activeTab === 'settings'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-cog text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Configurações do Bot</div>
                    <div class="config-section-description">Gerencie as configurações gerais do bot</div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-key mr-2 text-yellow-500"></i>
                    Trocar Token do Bot
                </label>
                <p class="text-xs text-gray-500 mb-3">Use esta opção apenas se precisar trocar o token do bot Telegram. Esta ação requer que você tenha acesso ao novo token.</p>
                <p class="text-sm text-yellow-400 font-bold mb-4">⚠️ Atenção: Trocar o token pode interromper o bot temporariamente até que ele seja reiniciado com o novo token.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Step - VERSÃO PROFISSIONAL -->
<div x-show="showStepModal" 
     x-cloak
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed z-50 inset-0 overflow-y-auto"
     style="background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px);"
     @click.away="closeStepModal()">
    <div class="flex items-center justify-center min-h-screen px-4 py-8">
        <div x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-gradient-to-br from-gray-900 via-gray-900 to-gray-950 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col"
             style="border: 2px solid rgba(255, 184, 0, 0.2); box-shadow: 0 25px 60px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(255, 255, 255, 0.05);"
             @click.stop>
            
            <!-- Header Profissional -->
            <div class="px-8 py-6 border-b border-gray-800 flex items-center justify-between bg-gradient-to-r from-gray-900 to-gray-800"
                 style="background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%);">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
                        <i class="fas fa-edit text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white mb-1">Editar Step</h3>
                        <p class="text-sm text-gray-400">Configure o step do fluxo visual</p>
                    </div>
                </div>
                <button @click="closeStepModal()" 
                        class="w-10 h-10 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-all">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Body com Scroll Suave -->
            <div class="flex-1 overflow-y-auto" style="scrollbar-width: thin; scrollbar-color: rgba(156, 163, 175, 0.3) transparent;">
                <div class="p-8 space-y-8" x-show="editingStep">
                    <!-- Seção: Tipo e Configuração Básica -->
                    <div class="bg-gray-800 bg-opacity-50 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-blue-500 bg-opacity-20 flex items-center justify-center">
                                <i class="fas fa-cog text-blue-400"></i>
                            </div>
                            <h4 class="text-lg font-bold text-white">Configuração Básica</h4>
                        </div>
                        
                        <!-- Tipo do Step -->
                        <div>
                            <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                <i class="fas fa-tag text-blue-400"></i>
                                Tipo do Step <span class="text-red-400">*</span>
                            </label>
                            <select x-model="editingStep.type" 
                                    class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 transition-all">
                                <option value="content">📄 Conteúdo</option>
                                <option value="message">💬 Mensagem</option>
                                <option value="audio">🎵 Áudio</option>
                                <option value="video">🎥 Vídeo</option>
                                <option value="buttons">🔘 Botões</option>
                                <option value="payment">💳 Pagamento</option>
                                <option value="access">🔑 Acesso</option>
                            </select>
                        </div>
                
                    </div>
                    
                    <!-- Seção: Configurações Específicas -->
                    <div class="bg-gray-800 bg-opacity-50 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-purple-500 bg-opacity-20 flex items-center justify-center">
                                <i class="fas fa-sliders-h text-purple-400"></i>
                            </div>
                            <h4 class="text-lg font-bold text-white">Configurações do Step</h4>
                        </div>
                        
                        <template x-if="editingStep.type === 'message' || editingStep.type === 'content'">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                        <i class="fas fa-comment text-purple-400"></i>
                                        Mensagem
                                    </label>
                                    <textarea x-model="editingStep.config.message" 
                                              class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:ring-opacity-20 transition-all resize-none" 
                                              rows="5"
                                              placeholder="Digite a mensagem que será enviada..."></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                            <i class="fas fa-link text-blue-400"></i>
                                            URL da Mídia
                                        </label>
                                        <input type="url" 
                                               x-model="editingStep.config.media_url" 
                                               class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 transition-all"
                                               placeholder="https://t.me/canal/123">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                            <i class="fas fa-image text-blue-400"></i>
                                            Tipo de Mídia
                                        </label>
                                        <select x-model="editingStep.config.media_type" 
                                                class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-20 transition-all">
                                            <option value="video">🎥 Vídeo</option>
                                            <option value="photo">📷 Foto</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </template>
                
                        <template x-if="editingStep.type === 'payment'">
                            <div class="space-y-5">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                            <i class="fas fa-dollar-sign text-green-400"></i>
                                            Valor (R$)
                                        </label>
                                        <input type="number" 
                                               x-model.number="editingStep.config.amount" 
                                               step="0.01"
                                               class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-20 transition-all"
                                               placeholder="19.97">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                            <i class="fas fa-tag text-green-400"></i>
                                            Descrição
                                        </label>
                                        <input type="text" 
                                               x-model="editingStep.config.description" 
                                               class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-20 transition-all"
                                               placeholder="Nome do produto">
                                    </div>
                                </div>
                                <div class="p-4 bg-gradient-to-r from-yellow-500 bg-opacity-10 to-orange-500 bg-opacity-10 border-2 border-yellow-500 border-opacity-30 rounded-lg">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-info-circle text-yellow-400 text-lg mt-0.5"></i>
                                        <div>
                                            <p class="text-sm font-bold text-yellow-300 mb-1">Importante</p>
                                            <p class="text-sm text-yellow-200">
                                                O step de pagamento deve ter conexões 'next' (pago) ou 'pending' (pendente) definidas.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                
                        <template x-if="editingStep.type === 'access'">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                        <i class="fas fa-check-circle text-cyan-400"></i>
                                        Mensagem de Sucesso
                                    </label>
                                    <textarea x-model="editingStep.config.message" 
                                              class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-20 transition-all resize-none" 
                                              rows="4"
                                              placeholder="✅ Acesso liberado!"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                        <i class="fas fa-link text-cyan-400"></i>
                                        Link de Acesso
                                    </label>
                                    <input type="url" 
                                           x-model="editingStep.config.link" 
                                           class="w-full px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-20 transition-all"
                                           placeholder="https://t.me/+seugrupo">
                                </div>
                            </div>
                        </template>
                
                        <template x-if="editingStep.type === 'buttons'">
                            <div class="space-y-5">
                                <div class="flex justify-between items-center mb-4">
                                    <label class="block text-sm font-bold text-white flex items-center gap-2">
                                        <i class="fas fa-mouse-pointer text-green-400"></i>
                                        Botões Customizados
                                    </label>
                                    <button @click="addCustomButton()" 
                                            class="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg text-sm font-medium transition-all shadow-lg hover:shadow-xl">
                                        <i class="fas fa-plus mr-2"></i>Adicionar Botão
                                    </button>
                                </div>
                                <template x-if="editingStep.config.custom_buttons && editingStep.config.custom_buttons.length > 0">
                                    <div class="space-y-3">
                                        <template x-for="(btn, idx) in editingStep.config.custom_buttons" :key="idx">
                                            <div class="flex gap-3 items-center p-4 bg-gray-900 rounded-lg border border-gray-700">
                                                <input type="text" 
                                                       x-model="btn.text" 
                                                       class="flex-1 px-4 py-2.5 bg-gray-800 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-20 transition-all"
                                                       placeholder="Texto do botão">
                                                <select x-model="btn.target_step" 
                                                        class="w-64 px-4 py-2.5 bg-gray-800 border-2 border-gray-700 rounded-lg text-white text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-20 transition-all">
                                                    <option value="">Selecione step...</option>
                                                    <template x-for="step in config.flow_steps" :key="step.id">
                                                        <option :value="step.id" 
                                                                :disabled="step.id === editingStep.id"
                                                                x-text="getStepTypeLabel(step.type) + ' (' + step.id.substring(0, 8) + '...)'"></option>
                                                    </template>
                                                </select>
                                                <button @click="removeCustomButton(idx)" 
                                                        class="px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all shadow-lg hover:shadow-xl">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                
                        <!-- Delay -->
                        <div>
                            <label class="block text-sm font-bold text-white mb-3 flex items-center gap-2">
                                <i class="fas fa-clock text-yellow-400"></i>
                                Delay (segundos)
                            </label>
                            <input type="number" 
                                   x-model.number="editingStep.delay_seconds" 
                                   min="0"
                                   class="w-32 px-4 py-3 bg-gray-900 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-20 transition-all"
                                   placeholder="0">
                            <p class="text-xs text-gray-400 mt-2">Tempo de espera antes de executar este step</p>
                        </div>
                    </div>
                    
                    <!-- Seção: Conexões -->
                    <div class="bg-gray-800 bg-opacity-50 rounded-xl p-6 border border-gray-700">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-lg bg-blue-500 bg-opacity-20 flex items-center justify-center">
                                <i class="fas fa-project-diagram text-blue-400"></i>
                            </div>
                            <h4 class="text-lg font-bold text-white">Conexões do Fluxo</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                            <div class="bg-green-500 bg-opacity-10 rounded-lg p-4 border border-green-500 border-opacity-30">
                                <label class="block text-sm font-bold text-green-400 mb-3 flex items-center gap-2">
                                    <i class="fas fa-check-circle"></i>
                                    Próximo (Next)
                                </label>
                                <select x-model="editingStep.connections.next" 
                                        class="w-full px-4 py-2.5 bg-gray-900 border-2 border-gray-700 rounded-lg text-white text-sm focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:ring-opacity-20 transition-all">
                                    <option value="">Selecione...</option>
                                    <template x-for="step in config.flow_steps" :key="step.id">
                                        <option :value="step.id" 
                                                :disabled="step.id === editingStep.id"
                                                x-text="getStepTypeLabel(step.type) + ' (' + step.id.substring(0, 8) + '...)'"></option>
                                    </template>
                                </select>
                                <p class="text-xs text-gray-400 mt-2">Step executado em caso de sucesso</p>
                            </div>
                            <div class="bg-yellow-500 bg-opacity-10 rounded-lg p-4 border border-yellow-500 border-opacity-30">
                                <label class="block text-sm font-bold text-yellow-400 mb-3 flex items-center gap-2">
                                    <i class="fas fa-clock"></i>
                                    Pendente (Pending)
                                </label>
                                <select x-model="editingStep.connections.pending" 
                                        class="w-full px-4 py-2.5 bg-gray-900 border-2 border-gray-700 rounded-lg text-white text-sm focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-20 transition-all">
                                    <option value="">Selecione...</option>
                                    <template x-for="step in config.flow_steps" :key="step.id">
                                        <option :value="step.id" 
                                                :disabled="step.id === editingStep.id"
                                                x-text="getStepTypeLabel(step.type) + ' (' + step.id.substring(0, 8) + '...)'"></option>
                                    </template>
                                </select>
                                <p class="text-xs text-gray-400 mt-2">Step executado se pendente</p>
                            </div>
                            <div class="bg-red-500 bg-opacity-10 rounded-lg p-4 border border-red-500 border-opacity-30">
                                <label class="block text-sm font-bold text-red-400 mb-3 flex items-center gap-2">
                                    <i class="fas fa-redo"></i>
                                    Retry (Erro)
                                </label>
                                <select x-model="editingStep.connections.retry" 
                                        class="w-full px-4 py-2.5 bg-gray-900 border-2 border-gray-700 rounded-lg text-white text-sm focus:border-red-500 focus:ring-2 focus:ring-red-500 focus:ring-opacity-20 transition-all">
                                    <option value="">Selecione...</option>
                                    <template x-for="step in config.flow_steps" :key="step.id">
                                        <option :value="step.id" 
                                                :disabled="step.id === editingStep.id"
                                                x-text="getStepTypeLabel(step.type) + ' (' + step.id.substring(0, 8) + '...)'"></option>
                                    </template>
                                </select>
                                <p class="text-xs text-gray-400 mt-2">Step executado em caso de erro</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção: Condições -->
                    <div class="bg-gray-800 bg-opacity-50 rounded-xl p-6 border border-gray-700">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-500 bg-opacity-20 flex items-center justify-center">
                                    <i class="fas fa-filter text-purple-400"></i>
                                </div>
                                <h4 class="text-lg font-bold text-white">Condições</h4>
                            </div>
                            <button @click="addCondition()" 
                                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg text-sm font-medium transition-all shadow-lg hover:shadow-xl">
                                <i class="fas fa-plus mr-2"></i>Adicionar Condição
                            </button>
                        </div>
                    <template x-if="editingStep.conditions && editingStep.conditions.length > 0">
                        <div class="space-y-3">
                            <template x-for="(condition, idx) in editingStep.conditions" :key="condition.id || idx">
                                <div class="p-4 bg-gray-800 rounded-lg">
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <label class="block text-xs font-bold text-white mb-1">Tipo</label>
                                            <select x-model="condition.type" class="form-input text-sm">
                                                <option value="text_validation">Validação de Texto</option>
                                                <option value="button_click">Clique em Botão</option>
                                                <option value="payment_status">Status de Pagamento</option>
                                                <option value="time_elapsed">Tempo Decorrido</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-white mb-1">Step Alvo</label>
                                            <select x-model="condition.target_step" class="form-input text-sm">
                                                <option value="">Selecione...</option>
                                                <template x-for="step in config.flow_steps" :key="step.id">
                                                    <option :value="step.id" 
                                                            :disabled="step.id === editingStep.id"
                                                            x-text="getStepTypeLabel(step.type)"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                    <template x-if="condition.type === 'text_validation'">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-bold text-white mb-1">Validação</label>
                                                <select x-model="condition.validation" class="form-input text-sm">
                                                    <option value="any">Qualquer texto</option>
                                                    <option value="email">Email</option>
                                                    <option value="phone">Telefone</option>
                                                    <option value="cpf">CPF</option>
                                                    <option value="contains">Contém</option>
                                                    <option value="equals">Igual a</option>
                                                </select>
                                            </div>
                                            <template x-if="condition.validation === 'contains' || condition.validation === 'equals'">
                                                <div>
                                                    <label class="block text-xs font-bold text-white mb-1">Valor</label>
                                                    <input type="text" 
                                                           x-model="condition.value" 
                                                           class="form-input text-sm"
                                                           placeholder="Texto...">
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="condition.type === 'button_click'">
                                        <div>
                                            <label class="block text-xs font-bold text-white mb-1">Texto do Botão</label>
                                            <input type="text" 
                                                   x-model="condition.button_text" 
                                                   class="form-input text-sm"
                                                   placeholder="Texto exato do botão">
                                        </div>
                                    </template>
                                    <template x-if="condition.type === 'payment_status'">
                                        <div>
                                            <label class="block text-xs font-bold text-white mb-1">Status</label>
                                            <select x-model="condition.status" class="form-input text-sm">
                                                <option value="paid">Pago</option>
                                                <option value="pending">Pendente</option>
                                                <option value="failed">Falhou</option>
                                                <option value="expired">Expirado</option>
                                            </select>
                                        </div>
                                    </template>
                                    <template x-if="condition.type === 'time_elapsed'">
                                        <div>
                                            <label class="block text-xs font-bold text-white mb-1">Minutos</label>
                                            <input type="number" 
                                                   x-model.number="condition.minutes" 
                                                   min="1"
                                                   class="form-input text-sm w-32"
                                                   placeholder="5">
                                        </div>
                                    </template>
                                        <div class="mt-4 flex justify-end">
                                            <button @click="removeCondition(idx)" 
                                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-all shadow-lg hover:shadow-xl">
                                                <i class="fas fa-trash mr-2"></i>Remover Condição
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
            </div>
            
                </div>
            </div>
            
            <!-- Footer Profissional -->
            <div class="px-8 py-6 border-t border-gray-800 flex justify-end gap-4 bg-gradient-to-r from-gray-900 to-gray-800"
                 style="background: linear-gradient(135deg, rgba(17, 24, 39, 0.95) 0%, rgba(31, 41, 55, 0.95) 100%);">
                <button @click="closeStepModal()" 
                        class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-xl">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button @click="saveStep()" 
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-xl">
                    <i class="fas fa-save mr-2"></i>Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Flow Editor JS -->
<script src="{{ url_for('static', filename='js/flow_editor.js') }}?v=2.0.1"></script>
<script>
function botConfigApp() {
    return {
        bot_id: {{ bot.id }},
        loading: false,
        activeTab: 'welcome',
        config: {
            id: null,
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            welcome_audio_enabled: false,
            welcome_audio_url: '',
            main_buttons: [],
            redirect_buttons: [],
            downsells_enabled: false,
            downsells: [],
            upsells_enabled: false,
            upsells: [],
            access_link: '',
            success_message: '',
            pending_message: '',
            flow_enabled: false,
            flow_steps: [],
            flow_start_step_id: null,
            has_meta_pixel: false
        },
        new_bot_token: '',
        subscriptionGuideExpanded: false,
        subscriptionGuideTab: 'telegram',

        async init() {
            await this.loadConfig();
            // Observar mudanças em flow_steps
            this.watchFlowSteps();
        },

        async loadConfig() {
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                console.log('📦 Dados carregados da API:', data);
                
                // ✅ CORREÇÃO: A API retorna o config diretamente, não dentro de {success: true, config: {...}}
                if (data && typeof data === 'object') {
                    // Atribuir todas as propriedades, incluindo arrays aninhados
                    this.config.id = data.id || null;
                    this.config.welcome_message = data.welcome_message || '';
                    this.config.welcome_media_url = data.welcome_media_url || '';
                    this.config.welcome_media_type = data.welcome_media_type || 'video';
                    this.config.welcome_audio_enabled = data.welcome_audio_enabled || false;
                    this.config.welcome_audio_url = data.welcome_audio_url || '';
                    // Garantir que subscription existe em todos os botões com objeto padrão
                    const defaultSubscription = {
                        enabled: false,
                        duration_type: 'days',
                        duration_value: null,
                        vip_chat_id: '',
                        vip_group_link: '',
                        validation_status: null
                    };
                    this.config.main_buttons = (data.main_buttons || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    this.config.redirect_buttons = data.redirect_buttons || [];
                    this.config.downsells_enabled = data.downsells_enabled || false;
                    this.config.downsells = (data.downsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    this.config.upsells_enabled = data.upsells_enabled || false;
                    this.config.upsells = (data.upsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    this.config.access_link = data.access_link || '';
                    this.config.success_message = data.success_message || '';
                    this.config.pending_message = data.pending_message || '';
                    this.config.flow_enabled = data.flow_enabled || false;
                    this.config.flow_steps = data.flow_steps || [];
                    this.config.flow_start_step_id = data.flow_start_step_id || null;
                    this.config.has_meta_pixel = data.has_meta_pixel || false;
                    
                    console.log('✅ Configuração carregada:', {
                        buttons: this.config.main_buttons?.length || 0,
                        downsells: this.config.downsells?.length || 0,
                        upsells: this.config.upsells?.length || 0
                    });
                }
            } catch (error) {
                console.error('❌ Erro ao carregar configuração:', error);
                alert('Erro ao carregar configuração. Recarregue a página.');
            } finally {
                this.loading = false;
            }
        },

        async saveConfig() {
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.config)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                // ✅ CORREÇÃO: A API retorna o config diretamente após salvar, não dentro de {success: true, config: {...}}
                if (data && typeof data === 'object' && !data.error) {
                    alert('Configuração salva com sucesso!');
                    Object.assign(this.config, data);
                } else {
                    alert(data.error || 'Erro ao salvar configuração');
                }
            } catch (error) {
                console.error('Erro ao salvar configuração:', error);
                alert(error.message || 'Erro ao salvar configuração');
            } finally {
                this.loading = false;
            }
        },

        addButton() {
            if (!this.config.main_buttons) {
                this.config.main_buttons = [];
            }
            this.config.main_buttons.push({
                text: '',
                price: null,
                description: '',
                order_bumps: [],
                subscription: null
            });
        },

        removeButton(index) {
            if (this.config.main_buttons && this.config.main_buttons[index]) {
                this.config.main_buttons.splice(index, 1);
            }
        },

        addOrderBump(buttonIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            if (!this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps = [];
            }
            this.config.main_buttons[buttonIndex].order_bumps.push({
                enabled: false,
                message: '',
                price: null,
                description: '',
                media_url: '',
                media_type: 'video',
                accept_text: 'Sim, eu quero!',
                decline_text: 'Não, obrigado'
            });
        },

        removeOrderBump(buttonIndex, bumpIndex) {
            if (this.config.main_buttons && 
                this.config.main_buttons[buttonIndex] && 
                this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps.splice(bumpIndex, 1);
            }
        },

        getAvailableOrderBumps() {
            if (!this.config.main_buttons) return [];
            const allBumps = [];
            this.config.main_buttons.forEach((button, btnIndex) => {
                if (button.order_bumps) {
                    button.order_bumps.forEach((bump, bumpIndex) => {
                        allBumps.push({
                            buttonIndex: btnIndex,
                            bumpIndex: bumpIndex,
                            buttonText: button.text || 'Botão sem nome',
                            ...bump
                        });
                    });
                }
            });
            return allBumps;
        },

        validateWelcomeMessage() {
            // Validação já feita via getWelcomeMessageLength()
        },

        getWelcomeMessageLength() {
            const baseLength = (this.config.welcome_message || '').length;
            const mediaLength = this.config.welcome_media_url ? 200 : 0;
            return baseLength + mediaLength;
        },

        validateProductField(index, field) {
            if (!this.config.main_buttons || !this.config.main_buttons[index]) return;
            const button = this.config.main_buttons[index];
            if (field === 'text' && button.text) {
                button.text = button.text.trim().slice(0, 64);
            } else if (field === 'price' && button.price !== null) {
                button.price = Math.max(0, parseFloat(button.price) || 0);
            }
        },

        async validateSubscription(buttonIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            const button = this.config.main_buttons[buttonIndex];
            if (!button.subscription || !button.subscription.enabled) return;

            const vipChatId = button.subscription.vip_chat_id;
            if (!vipChatId) {
                button.subscription.validation_status = 'invalid';
                return;
            }

            try {
                const response = await fetch(`/api/bots/${this.bot_id}/validate-subscription`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vip_chat_id: vipChatId
                    })
                });
                const data = await response.json();
                if (data.success && data.is_valid) {
                    button.subscription.validation_status = 'valid';
                } else {
                    button.subscription.validation_status = 'invalid';
                }
            } catch (error) {
                console.error('Erro ao validar assinatura:', error);
                button.subscription.validation_status = 'invalid';
            }
        },


        setFlowStartStep(stepId) {
            this.config.flow_start_step_id = stepId;
        },

        get sortedFlowSteps() {
            if (!this.config.flow_steps) return [];
            return [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
        },

        async changeBotToken() {
            if (!this.new_bot_token || !this.isValidBotToken(this.new_bot_token)) {
                alert('Token inválido');
                return;
            }
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/token`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: this.new_bot_token
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Token atualizado com sucesso!');
                    this.new_bot_token = '';
                    location.reload();
                } else {
                    alert(data.error || 'Erro ao atualizar token');
                }
            } catch (error) {
                console.error('Erro ao atualizar token:', error);
                alert('Erro ao atualizar token');
            } finally {
                this.loading = false;
            }
        },

        isValidBotToken(token) {
            return token && token.length >= 30 && token.length <= 45 && token.includes(':');
        },

        stripSurrogateChars(value) {
            return window.stripSurrogateChars ? window.stripSurrogateChars(value) : (value || '');
        },

        // Funções para Downsells
        addDownsell() {
            if (!this.config.downsells) {
                this.config.downsells = [];
            }
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                price: null,
                pricing_mode: 'fixed',
                discount_percentage: null,
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                order_bump: {
                    enabled: false,
                    message: '',
                    price: null,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: 'Sim, eu quero!',
                    decline_text: 'Não, obrigado',
                    button_index: null,
                    bump_index: null
                }
            });
        },

        removeDownsell(index) {
            if (this.config.downsells && this.config.downsells[index]) {
                this.config.downsells.splice(index, 1);
            }
        },

        // Funções para Upsells
        addUpsell() {
            if (!this.config.upsells) {
                this.config.upsells = [];
            }
            this.config.upsells.push({
                trigger_product: '',
                delay_minutes: 0,
                message: '',
                price: null,
                product_name: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                access_link: ''
            });
        },

        removeUpsell(index) {
            if (this.config.upsells && this.config.upsells[index]) {
                this.config.upsells.splice(index, 1);
            }
        },

        // Funções para Botões de Redirecionamento
        addRedirectButton() {
            if (!this.config.redirect_buttons) {
                this.config.redirect_buttons = [];
            }
            this.config.redirect_buttons.push({
                text: '',
                url: ''
            });
        },

        removeRedirectButton(index) {
            if (this.config.redirect_buttons && this.config.redirect_buttons[index]) {
                this.config.redirect_buttons.splice(index, 1);
            }
        },

        // Função para usar Order Bump dos Botões nos Downsells
        useOrderBumpFromButtons(downsell, buttonIndex, bumpIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            const button = this.config.main_buttons[buttonIndex];
            if (!button.order_bumps || !button.order_bumps[bumpIndex]) return;
            
            const orderBump = button.order_bumps[bumpIndex];
            
            // Copiar dados do order bump para o downsell
            if (!downsell.order_bump) {
                downsell.order_bump = {};
            }
            
            downsell.order_bump.enabled = true;
            downsell.order_bump.message = orderBump.message || '';
            downsell.order_bump.price = orderBump.price || null;
            downsell.order_bump.description = orderBump.description || '';
            downsell.order_bump.media_url = orderBump.media_url || '';
            downsell.order_bump.media_type = orderBump.media_type || 'video';
            downsell.order_bump.accept_text = orderBump.accept_text || 'Sim, eu quero!';
            downsell.order_bump.decline_text = orderBump.decline_text || 'Não, obrigado';
            downsell.order_bump.button_index = buttonIndex;
            downsell.order_bump.bump_index = bumpIndex;
        },

        // Função para toggle do Flow
        onFlowToggle() {
            console.log('Flow enabled:', this.config.flow_enabled);
            
            // Se flow foi habilitado, inicializar editor
            if (this.config.flow_enabled) {
                this.$nextTick(() => {
                    setTimeout(() => {
                        this.initVisualFlowEditor();
                    }, 200);
                });
            } else {
                // Se flow foi desabilitado, destruir editor
                if (window.flowEditor) {
                    try {
                        window.flowEditor.destroy();
                        window.flowEditor = null;
                    } catch (e) {
                        console.warn('⚠️ Erro ao destruir editor:', e);
                    }
                }
            }
        },

        // Função para inicializar o editor visual de fluxo
        initVisualFlowEditor() {
            // Verificar se flow está habilitado
            if (!this.config.flow_enabled) {
                console.log('ℹ️ Flow desabilitado - não inicializando editor');
                return;
            }
            
            // Aguardar próximo tick para garantir que DOM está pronto
            this.$nextTick(() => {
                const canvas = document.getElementById('flow-visual-canvas');
                if (!canvas) {
                    console.error('❌ Canvas não encontrado');
                    return;
                }
                
                // Verificar se jsPlumb está disponível
                if (typeof jsPlumb === 'undefined') {
                    console.error('❌ jsPlumb não está disponível');
                    return;
                }
                
                // Destruir instância anterior se existir
                if (window.flowEditor) {
                    try {
                        window.flowEditor.destroy();
                    } catch (e) {
                        console.warn('⚠️ Erro ao destruir editor anterior:', e);
                    }
                }
                
                // Criar nova instância
                try {
                    // Verificar se FlowEditor está disponível
                    if (typeof FlowEditor === 'undefined') {
                        console.error('❌ FlowEditor não está disponível. Verifique se flow_editor.js foi carregado.');
                        return;
                    }
                    
                    window.flowEditor = new FlowEditor('flow-visual-canvas', this);
                    console.log('✅ Editor visual inicializado');
                } catch (error) {
                    console.error('❌ Erro ao inicializar editor:', error);
                    console.error('Stack:', error.stack);
                    // Tentar novamente após um delay
                    setTimeout(() => {
                        try {
                            window.flowEditor = new FlowEditor('flow-visual-canvas', this);
                            console.log('✅ Editor visual inicializado (tentativa 2)');
                        } catch (e2) {
                            console.error('❌ Erro na tentativa 2:', e2);
                        }
                    }, 1000);
                }
            });
        },
        
        // Modal de edição de steps
        showStepModal: false,
        editingStep: null,
        editingStepIndex: -1,
        
        // Abrir modal de edição
        openStepModal(stepId) {
            if (!this.config.flow_steps) {
                console.error('❌ flow_steps não existe');
                return;
            }
            
            const step = this.config.flow_steps.find(s => String(s.id) === String(stepId));
            if (!step) {
                console.error(`❌ Step ${stepId} não encontrado`);
                return;
            }
            
            this.editingStepIndex = this.config.flow_steps.indexOf(step);
            
            // Deep copy com valores padrão garantidos
            this.editingStep = JSON.parse(JSON.stringify(step));
            
            // Garantir estrutura completa
            if (!this.editingStep.connections) {
                this.editingStep.connections = {};
            }
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            if (!this.editingStep.position) {
                this.editingStep.position = { x: 100, y: 100 };
            }
            
            this.showStepModal = true;
        },
        
        // Fechar modal
        closeStepModal() {
            this.showStepModal = false;
            this.editingStep = null;
            this.editingStepIndex = -1;
        },
        
        // Salvar step editado
        saveStep() {
            if (!this.editingStep || this.editingStepIndex === -1) {
                alert('Erro: Step não encontrado');
                return;
            }
            
            // Validar campos obrigatórios
            if (!this.editingStep.type) {
                alert('Tipo do step é obrigatório');
                return;
            }
            
            // Garantir que connections existe
            if (!this.editingStep.connections) {
                this.editingStep.connections = {};
            }
            
            // Garantir que config existe
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            
            // Garantir que conditions existe
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            
            // Garantir que position existe
            if (!this.editingStep.position) {
                const existingStep = this.config.flow_steps[this.editingStepIndex];
                this.editingStep.position = existingStep.position || { x: 100, y: 100 };
            }
            
            // Atualizar step no array (deep merge para preservar campos não editados)
            const existingStep = this.config.flow_steps[this.editingStepIndex];
            this.config.flow_steps[this.editingStepIndex] = {
                ...existingStep,
                ...this.editingStep,
                id: existingStep.id, // Preservar ID original
                position: this.editingStep.position || existingStep.position
            };
            
            // Re-renderizar canvas
            this.$nextTick(() => {
                if (window.flowEditor) {
                    window.flowEditor.renderAllSteps();
                }
            });
            
            // Fechar modal
            this.closeStepModal();
        },
        
        // Adicionar step (melhorado)
        addFlowStep() {
            console.log('🔵 addFlowStep() chamado');
            
            // Garantir que flow_steps existe
            if (!this.config.flow_steps) {
                this.config.flow_steps = [];
            }
            
            // Habilitar flow automaticamente se não estiver habilitado
            if (!this.config.flow_enabled) {
                this.config.flow_enabled = true;
                console.log('✅ Flow habilitado automaticamente');
            }
            
            const stepId = `step_${Date.now()}`;
            
            // Calcular posição inicial (evitar sobreposição)
            const existingSteps = this.config.flow_steps.length;
            const cols = Math.ceil(Math.sqrt(existingSteps + 1));
            const row = Math.floor(existingSteps / cols);
            const col = existingSteps % cols;
            
            const newStep = {
                id: stepId,
                type: 'message',
                order: existingSteps,
                config: {
                    message: '',
                    media_url: '',
                    media_type: 'video'
                },
                connections: {},
                conditions: [],
                delay_seconds: 0,
                position: {
                    x: 100 + (col * 280),
                    y: 100 + (row * 180)
                }
            };
            
            this.config.flow_steps.push(newStep);
            console.log('✅ Step adicionado:', stepId, 'Total:', this.config.flow_steps.length);
            
            // Re-renderizar canvas após próximo tick
            this.$nextTick(() => {
                console.log('🔄 $nextTick executado, aguardando DOM...');
                // Aguardar um pouco mais para garantir que DOM está pronto
                setTimeout(() => {
                    console.log('🔄 Timeout executado, verificando editor...');
                    // Se é o primeiro step ou editor não existe, inicializar
                    if (!window.flowEditor) {
                        console.log('🆕 Inicializando editor...');
                        this.initVisualFlowEditor();
                    } else {
                        console.log('🔄 Re-renderizando steps...');
                        // Se editor já existe, apenas re-renderizar
                        try {
                            window.flowEditor.renderAllSteps();
                            console.log('✅ Steps re-renderizados');
                        } catch (e) {
                            console.error('❌ Erro ao re-renderizar:', e);
                            // Tentar reinicializar se houver erro
                            this.initVisualFlowEditor();
                        }
                    }
                }, 500); // Aumentado para 500ms
            });
        },
        
        // Remover step
        removeFlowStep(stepId) {
            if (window.flowEditor) {
                window.flowEditor.deleteStep(stepId);
            }
        },
        
        // Adicionar condição ao step
        addCondition() {
            if (!this.editingStep) return;
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            this.editingStep.conditions.push({
                id: `cond_${Date.now()}`,
                type: 'text_validation',
                validation: 'any',
                target_step: '',
                order: this.editingStep.conditions.length
            });
        },
        
        // Remover condição
        removeCondition(index) {
            if (!this.editingStep || !this.editingStep.conditions) return;
            this.editingStep.conditions.splice(index, 1);
        },
        
        // Adicionar botão customizado ao step
        addCustomButton() {
            if (!this.editingStep) return;
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.config.custom_buttons) {
                this.editingStep.config.custom_buttons = [];
            }
            this.editingStep.config.custom_buttons.push({
                text: '',
                target_step: ''
            });
        },
        
        // Remover botão customizado
        removeCustomButton(index) {
            if (!this.editingStep || !this.editingStep.config || !this.editingStep.config.custom_buttons) return;
            this.editingStep.config.custom_buttons.splice(index, 1);
        },
        
        // Observar mudanças em flow_steps para sincronizar canvas
        watchFlowSteps() {
            // Usar $watch do Alpine para observar mudanças
            this.$watch('config.flow_steps', (newSteps, oldSteps) => {
                if (window.flowEditor && newSteps) {
                    // Debounce para evitar renderizações excessivas
                    clearTimeout(this._flowStepsWatchTimeout);
                    this._flowStepsWatchTimeout = setTimeout(() => {
                        window.flowEditor.renderAllSteps();
                    }, 100);
                }
            }, { deep: true });
        },
        
        // Utilitário: Label do tipo de step
        getStepTypeLabel(type) {
            const labels = {
                content: 'Conteúdo',
                message: 'Mensagem',
                audio: 'Áudio',
                video: 'Vídeo',
                buttons: 'Botões',
                payment: 'Pagamento',
                access: 'Acesso'
            };
            return labels[type] || type;
        }
    };
}
</script>
{% endblock %}