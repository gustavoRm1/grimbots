{% extends "base.html" %}
{% block title %}Configurar Bot - {{ bot.name }}{% endblock %}

{% block extra_head %}
<style>
/* ============================================
   BOT CONFIG - CSS COMPLETO
   Design System: Dashboard Dark Theme
   ============================================ */

/* ============================================
   üî• FLOW BUILDER V2.0 - UX PRO PREMIUM
   Manychat/Typebot-like - Anti-Lag, Anti-Duplica√ß√£o
   ============================================ */

/* Layout base */
#flow-builder {
    display: flex;
    height: calc(100vh - 240px);
    overflow: hidden;
    background: #0d0d0f;
    color: #e5e5e7;
    font-family: Inter, sans-serif;
}

/* Sidebar */
.flow-sidebar {
    width: 280px;
    background: #121214;
    border-right: 1px solid #1f1f22;
    padding: 20px;
    overflow-y: auto;
}

.flow-sidebar h2 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 12px;
    color: #f1f1f1;
}

/* Bot√µes de nodes */
.flow-btn {
    width: 100%;
    background: #1d1d21;
    border: 1px solid #2a2a2f;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 12px;
    cursor: pointer;
    color: #f1f1f1;
    transition: 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
}

.flow-btn:hover {
    background: #2a2a31;
    transform: translateX(2px);
    border-color: #3a3a3f;
}

.flow-btn:active {
    transform: translateX(0);
}

/* Canvas */
#flow-canvas {
    position: relative;
    flex: 1;
    background-size: 32px 32px;
    background-image: linear-gradient(#151518 1px, transparent 1px),
                      linear-gradient(90deg, #151518 1px, transparent 1px);
    overflow: hidden;
    will-change: transform;
    transform-origin: 0 0;
}

/* Node */
.flow-node {
    position: absolute;
    width: 260px;
    background: #18181b;
    border: 1px solid #2d2d33;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.4);
    cursor: grab;
    user-select: none;
    transition: box-shadow .2s;
    z-index: 10;
}

.flow-node:active {
    cursor: grabbing;
}

.flow-node:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
}

.flow-node.flow-node-start {
    border-color: #10b981;
    border-width: 2px;
}

.node-header {
    background: #202024;
    padding: 14px;
    border-radius: 14px 14px 0 0;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #f1f1f1;
    font-size: 13px;
    text-transform: uppercase;
}

.node-header button {
    background: transparent;
    border: none;
    color: #ccc;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s;
    font-size: 16px;
}

.node-header button:hover {
    background: #2c2c31;
    color: #fff;
}

.node-content {
    padding: 14px;
    color: #e5e5e7;
    font-size: 13px;
}

.node-button {
    background: #222227;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    position: relative;
    color: #e5e5e7;
}

.node-button-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.node-button-row .input {
    flex: 1;
}

.cond-branch {
    background: #222227;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    position: relative;
    color: #e5e5e7;
}

/* Endpoints */
.endpoint {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid #0d0d0f;
    position: absolute;
    z-index: 50;
    cursor: crosshair;
    transition: transform 0.2s;
}

.endpoint:hover {
    transform: scale(1.3);
}

.endpoint-in {
    background: #3b82f6;
    left: -7px;
    top: 50%;
    transform: translateY(-50%);
}

.endpoint-out {
    background: #10b981;
    right: -7px;
    top: 50%;
    transform: translateY(-50%);
}

/* Modal */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: #121214;
    padding: 24px;
    border-radius: 12px;
    width: 420px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid #2d2d33;
    color: #f1f1f1;
}

.modal-content h2 {
    color: #f1f1f1;
    margin-bottom: 16px;
}

.modal-content label {
    display: block;
    margin-bottom: 8px;
    color: #ccc;
    font-size: 13px;
}

.modal-content .input {
    width: 100%;
    background: #1d1d21;
    border: 1px solid #2a2a2f;
    padding: 10px;
    border-radius: 8px;
    color: #f1f1f1;
    margin-bottom: 12px;
}

.modal-content .input:focus {
    outline: none;
    border-color: #3b82f6;
}

/* Bot√µes do modal */
.btn-primary {
    background: #3b82f6;
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: #2a2a2f;
    color: #f1f1f1;
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid #3a3a3f;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-secondary:hover {
    background: #3a3a3f;
}

.btn-danger {
    background: #ef4444;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-danger:hover {
    background: #dc2626;
}

/* ============================================
   CSS DO FLOW EDITOR V3.0 (COMPATIBILIDADE)
   ============================================ */

.flow-wrapper {
    display: flex;
    height: calc(100vh - 300px);
    min-height: 600px;
    background: #0f1117;
    color: #fff;
    font-family: Inter, sans-serif;
    position: relative;
}

/* SIDEBAR */
.flow-sidebar {
    width: 240px;
    background: #161920;
    border-right: 1px solid #262a33;
    padding: 20px;
    overflow-y: auto;
}

.flow-sidebar .sidebar-title {
    font-size: 14px;
    margin-bottom: 8px;
    opacity: .7;
    text-transform: uppercase;
    color: #8b8f9a;
}

.block-item {
    padding: 12px;
    margin-bottom: 8px;
    background: #1f232d;
    border: 1px solid #2a2f3b;
    border-radius: 6px;
    cursor: grab;
    transition: .2s;
    color: #fff;
    font-size: 14px;
}

.block-item:hover {
    background: #292e3b;
    border-color: #3a3f50;
}

.block-item:active {
    cursor: grabbing;
}

/* TOPBAR */
.flow-topbar {
    position: fixed;
    top: 0;
    left: 240px;
    right: 0;
    height: 60px;
    background: #161920;
    border-bottom: 1px solid #262a33;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 10;
}

.flow-topbar .left {
    display: flex;
    align-items: center;
}

.flow-topbar .right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.flow-title {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    margin: 0;
}

/* CANVAS */
.flow-canvas {
    flex: 1;
    position: relative;
    overflow: hidden;
    margin-left: 240px;
    margin-top: 60px;
}

.flow-grid {
    position: absolute;
    width: 400%;
    height: 400%;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="40" height="40" fill="none" stroke="%23262a33" stroke-width="1" /></svg>');
    pointer-events: none;
    z-index: 0;
}

/* STEPS */
.flow-step {
    position: absolute;
    width: 240px;
    background: #1c1f27;
    border: 1px solid #303544;
    border-radius: 10px;
    padding: 0;
    cursor: grab;
    user-select: none;
    z-index: 10;
    transition: box-shadow 0.2s;
}

.flow-step:hover {
    box-shadow: 0 4px 12px rgba(76, 146, 255, 0.3);
}

.flow-step.flow-step-selected {
    border-color: #4c92ff;
    box-shadow: 0 0 0 2px rgba(76, 146, 255, 0.3);
}

.flow-step-header {
    padding: 12px;
    border-bottom: 1px solid #2b303d;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1f232d;
    border-radius: 10px 10px 0 0;
}

.flow-step-header span {
    font-size: 13px;
    font-weight: 600;
    color: #fff;
    text-transform: uppercase;
}

.delete-btn {
    background: transparent;
    border: none;
    color: #8b8f9a;
    cursor: pointer;
    font-size: 16px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: .2s;
}

.delete-btn:hover {
    background: #2b303d;
    color: #ff4444;
}

.flow-step-body {
    padding: 12px;
}

.flow-step-body .preview {
    font-size: 12px;
    color: #8b8f9a;
    margin: 0;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.endpoint {
    width: 14px;
    height: 14px;
    background: #4c92ff;
    border-radius: 50%;
    position: absolute;
    border: 2px solid #1c1f27;
    cursor: crosshair;
    z-index: 20;
}

.endpoint-in {
    top: 50%;
    left: -7px;
    transform: translateY(-50%);
}

.endpoint-out {
    top: 50%;
    right: -7px;
    transform: translateY(-50%);
}

.endpoint:hover {
    background: #6ba3ff;
    transform: translateY(-50%) scale(1.2);
}

/* MODAL */
.flow-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.flow-modal {
    width: 420px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    background: #161920;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #2f3441;
}

.flow-modal .modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    margin: 0 0 20px 0;
}

.flow-modal label {
    display: block;
    font-size: 13px;
    color: #8b8f9a;
    margin-bottom: 4px;
    margin-top: 12px;
}

.flow-modal .input,
.flow-modal .textarea {
    width: 100%;
    background: #1c1f27;
    border: 1px solid #2b303d;
    color: white;
    padding: 10px;
    border-radius: 6px;
    margin-top: 4px;
    margin-bottom: 12px;
    font-size: 14px;
    font-family: inherit;
}

.flow-modal .input:focus,
.flow-modal .textarea:focus {
    outline: none;
    border-color: #4c92ff;
}

.flow-modal .textarea {
    min-height: 100px;
    resize: vertical;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
}

.flow-modal .btn {
    padding: 10px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: .2s;
}

.flow-modal .btn.primary {
    background: #4c92ff;
    color: #fff;
}

.flow-modal .btn.primary:hover {
    background: #3a7de8;
}

.flow-modal .btn.ghost {
    background: transparent;
    border: 1px solid #3a3f50;
    color: #8b8f9a;
}

.flow-modal .btn.ghost:hover {
    background: #1f232d;
    color: #fff;
}

/* ============================================
   CSS DO FLOW EDITOR V3.0 (COMPATIBILIDADE)
   ============================================ */

/* Container do editor - confina o grid e controla overflow */
.flow-canvas-container {
    position: relative;
    overflow: hidden; /* Impede o grid de escapar da div */
    width: 100%;
    height: 100%;
    border-radius: 8px;
}

#flow-visual-canvas {
    background: #0D0F15 !important;
    /* üî• V2.0 BACKGROUND: Grid agora √© SVG, n√£o background-image */
    background-image: none !important;
    font-family: 'Inter', sans-serif;
    user-select: none;
    -webkit-user-select: none;
    cursor: default;
    position: absolute; /* Canvas interno que pode ser maior que container (virtual) */
    left: 0;
    top: 0;
    transform-origin: 0 0; /* Para zoom via transform */
    will-change: transform;
    /* CR√çTICO: Canvas NUNCA deve ter transform - apenas o contentContainer */
    transform: none !important;
    /* Canvas pode ser maior que container (virtual canvas) */
    min-width: 1200px;
    min-height: 800px;
}

/* üî• V2.0 BACKGROUND: Estilos para grid SVG */
.flow-background-svg {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: visible;
}

.jtk-background-grid {
    pointer-events: none;
}

.jtk-background-grid-major {
    stroke: rgba(255, 255, 255, 0.12);
    fill: rgba(255, 255, 255, 0.12);
}

.jtk-background-grid-minor {
    stroke: rgba(255, 255, 255, 0.06);
    fill: rgba(255, 255, 255, 0.06);
}

.jtk-background-border {
    stroke: rgba(255, 255, 255, 0.2);
    stroke-width: 2;
    fill: none;
}

/* üî• V2.0 CONNECTORS: Estilos melhorados para conectores */
.flow-connector-v2 {
    stroke: #FFFFFF;
    stroke-width: 2.5;
    fill: none;
    transition: stroke-width 0.2s ease, stroke-opacity 0.2s ease;
}

.flow-connector-v2-hover {
    stroke: #FFB800;
    stroke-width: 3.5;
    stroke-opacity: 1;
}

.flow-arrow-overlay-v2 {
    fill: #FFFFFF;
    stroke: #FFFFFF;
    stroke-width: 2;
}

.flow-label-overlay-v2 {
    background: rgba(13, 15, 21, 0.95);
    border: 1px solid rgba(36, 40, 54, 0.8);
    color: #FFFFFF;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    pointer-events: none;
}

.flow-label-button {
    background: rgba(255, 184, 0, 0.15);
    border-color: rgba(255, 184, 0, 0.5);
}

/* üî• V2.0 CONNECTORS: Melhorar visibilidade dos conectores */
.jtk-connector {
    z-index: 1000 !important;
    pointer-events: stroke !important;
}

.jtk-connector:hover {
    stroke-width: 3.5 !important;
    stroke: #FFB800 !important;
}

.jtk-connector.jtk-hover {
    stroke-width: 3.5 !important;
    stroke: #FFB800 !important;
}

/* Container interno que recebe o transform */
.flow-canvas-content {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    transform-origin: top left !important;
    will-change: transform !important;
    pointer-events: auto !important; /* üî• CR√çTICO: permitir eventos no container */
    z-index: 1 !important;
    overflow: visible !important; /* üî• CR√çTICO: permitir elementos fora do container */
}

#flow-visual-canvas.panning {
    cursor: grabbing !important;
}

#flow-visual-canvas input,
#flow-visual-canvas textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

.flow-step-block,
.flow-card {
    position: absolute !important; /* üî• CR√çTICO: absolute para posicionamento no canvas */
    width: 300px;
    min-height: 180px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 12px;
    cursor: move !important; /* üî• CR√çTICO: cursor move para indicar arrast√°vel */
    transition: none !important; /* Removido transition para evitar conflito com drag */
    overflow: visible !important; /* CR√çTICO: visible para nodes ficarem vis√≠veis fora do card */
    animation: stepFadeIn 0.3s ease-out;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3), 0 0 0 0 rgba(255, 255, 255, 0);
    user-select: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
    touch-action: pan-y !important; /* üî• CR√çTICO: permitir touch para drag */
    will-change: transform !important; /* üî• CR√çTICO: usar transform para melhor performance */
    pointer-events: auto !important; /* üî• CR√çTICO: garantir que eventos funcionam */
    z-index: 10 !important; /* üî• CR√çTICO: garantir z-index correto */
    /* CR√çTICO: necess√°rio para os nodes ABSOLUTOS terem refer√™ncia correta */
    transform-style: preserve-3d;
    perspective: 1000px;
}

/* CR√çTICO: Wrapper interno para refer√™ncia correta dos nodes absolutos */
.flow-step-block-inner {
    position: relative;
    width: 100%;
    height: 100%;
}

/* Input on left center, anchored to card */
.flow-step-node-input {
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    position: absolute;
    z-index: 60;
}

/* Global output right center when exists */
.flow-step-node-output {
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    position: absolute;
    z-index: 60;
}

/* üî• V5.0: Output global node (quando n√£o h√° bot√µes) */
.flow-step-node-output-global {
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    position: absolute;
    z-index: 60;
    pointer-events: none;
}

/* üî• V5.0: Drag handle no header */
/* üî• V7 PROFISSIONAL: Drag handle sempre interativo */
.flow-drag-handle {
    pointer-events: auto !important;
    cursor: move !important;
    z-index: 1 !important;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    cursor: move;
    z-index: 1;
    background: transparent;
}

.flow-drag-handle:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* Button endpoint container sits inside button item - right aligned */
.flow-step-button-endpoint-container {
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

@keyframes stepFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.flow-step-block:hover {
    border-color: #3B82F6;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3), 0 0 0 1px rgba(59, 130, 246, 0.2);
    transform: translateY(-1px);
    z-index: 100;
}

.flow-step-block.dragging {
    cursor: grabbing !important;
    opacity: 0.98;
    /* Transform ser√° aplicado via JS (translate3d) - n√£o usar scale aqui */
    z-index: 1000 !important;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
    border-color: #FFFFFF;
    transition: none !important; /* CR√çTICO: Desabilitar transi√ß√µes durante drag */
}

.flow-step-block.flow-step-initial {
    border-color: #FFB800;
    box-shadow: 
        0 0 0 3px rgba(255, 184, 0, 0.3),
        0 0 24px rgba(255, 184, 0, 0.4),
        0 8px 24px rgba(0, 0, 0, 0.5);
    animation: initialPulse 2s ease-in-out infinite;
}

/* üî• V9.0 CHATBOT BUILDER: Condition Node (Losango/Diamond) */
.flow-step-block[data-step-type="condition"] {
    width: 200px;
    height: 120px;
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
    border-radius: 0;
    min-height: 120px;
}

.flow-step-block[data-step-type="condition"] .flow-step-header {
    border-radius: 0;
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
}

.flow-step-block[data-step-type="condition"] .flow-step-block-inner {
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
}

/* üî• V9.0 CHATBOT BUILDER: Condition outputs (true/false) */
.flow-step-node-output-true {
    right: -8px;
    top: 30%;
    transform: translateY(-50%);
    position: absolute;
    z-index: 60;
    pointer-events: none;
}

.flow-step-node-output-false {
    right: -8px;
    top: 70%;
    transform: translateY(-50%);
    position: absolute;
    z-index: 60;
    pointer-events: none;
}


@keyframes initialPulse {
    0%, 100% {
        box-shadow: 
            0 0 0 3px rgba(255, 184, 0, 0.3),
            0 0 24px rgba(255, 184, 0, 0.4),
            0 8px 24px rgba(0, 0, 0, 0.5);
    }
    50% {
        box-shadow: 
            0 0 0 4px rgba(255, 184, 0, 0.4),
            0 0 32px rgba(255, 184, 0, 0.6),
            0 8px 24px rgba(0, 0, 0, 0.5);
    }
}

/* üî• V2.0: Selection Visual - Combinado com jtk-surface-selected-element */
.flow-step-block.flow-step-selected {
    border-color: #FFB800 !important;
    box-shadow: 
        0 0 0 2px rgba(255, 184, 0, 0.4) !important,
        0 0 0 4px rgba(255, 184, 0, 0.2) !important,
        0 8px 24px rgba(255, 184, 0, 0.3) !important;
    transform: scale(1.02);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 500 !important;
}

.flow-step-header {
    padding: 20px 16px;
    background: #E02727;
    border-radius: 14px 14px 0 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(224, 39, 39, 0.3);
}

.flow-step-header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    position: relative;
}

.flow-step-icon-center {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #FFFFFF;
}

.flow-step-title-center {
    font-size: 16px;
    font-weight: 700;
    color: #FFFFFF;
    font-family: 'Inter', sans-serif;
    text-align: center;
    letter-spacing: 0.3px;
}

.flow-step-start-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 18px;
    animation: starPulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 4px rgba(255, 184, 0, 0.8));
    z-index: 10;
}

@keyframes starPulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.15);
        opacity: 0.9;
    }
}

.flow-step-body {
    padding: 20px 16px;
    background: #0F0F14;
    min-height: 100px;
    border-top: 1px solid #242836;
    position: relative;
}

.flow-step-buttons-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 0;
}

.flow-step-button-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(224, 39, 39, 0.15) 0%, rgba(239, 68, 68, 0.15) 100%);
    border: 2px solid rgba(224, 39, 39, 0.4);
    border-radius: 10px;
    position: relative;
    min-height: 44px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(224, 39, 39, 0.15);
}

.flow-step-button-item:hover {
    background: linear-gradient(135deg, rgba(224, 39, 39, 0.25) 0%, rgba(239, 68, 68, 0.25) 100%);
    border-color: rgba(224, 39, 39, 0.6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(224, 39, 39, 0.25);
}

.flow-step-button-text {
    color: #FFFFFF;
    font-size: 14px;
    font-weight: 600;
    flex: 1;
    padding-right: 12px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.flow-step-button-endpoint-container {
    position: relative;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.flow-step-global-output-container {
    position: absolute;
    right: -15px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

/* ============================================
   NODES (ENTRADAS/SA√çDAS) - ESTILO MANYCHAT
   ============================================ */

/* ============================================
   NODES (ENTRADAS/SA√çDAS) - PADR√ÉO MANYCHAT EXATO
   ============================================ */

.node-input,
.node-output,
.flow-step-node-input,
.flow-step-node-output {
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #FFFFFF;
    border: 3px solid #27ae60;
    cursor: pointer;
    z-index: 50;
    pointer-events: auto;
    transition: all 0.15s ease;
}

/* Entrada - lado esquerdo, centro vertical */
.node-input,
.flow-step-node-input {
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    border-color: #27ae60;
    background: #FFFFFF;
}

.node-input:hover,
.flow-step-node-input:hover {
    background: #27ae60;
    border-color: #27ae60;
    transform: translateY(-50%) scale(1.15);
    box-shadow: 0 0 8px rgba(39, 174, 96, 0.5);
}

/* Sa√≠da - lado direito, centro vertical */
.node-output,
.flow-step-node-output {
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    border-color: #27ae60;
    background: #FFFFFF;
}

.node-output:hover,
.flow-step-node-output:hover {
    background: #27ae60;
    border-color: #27ae60;
    transform: translateY(-50%) scale(1.15);
    box-shadow: 0 0 8px rgba(39, 174, 96, 0.5);
}

.flow-step-media-preview {
    margin-bottom: 12px;
    border-radius: 10px;
    overflow: hidden;
    background: #13151C;
    border: 1px solid #242836;
}

.flow-step-thumbnail-container {
    width: 100%;
    height: 120px;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 12px;
    position: relative;
    background: #13151C;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #242836;
}

.flow-step-media-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 8px;
}

.flow-step-thumbnail-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2.5rem;
    pointer-events: none;
    border-radius: 8px;
}

.flow-step-media-fallback {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%);
    border: 2px solid rgba(59, 130, 246, 0.4);
    color: #FFFFFF;
    font-size: 14px;
    font-weight: 600;
}

.flow-step-media-fallback i {
    color: #60A5FA;
    font-size: 20px;
}

.flow-step-video-preview {
    position: relative;
}

.flow-step-video-thumbnail-container {
    position: relative;
    width: 100%;
    height: 120px;
    overflow: hidden;
    background: #0D0F15;
}

.flow-step-video-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.flow-step-video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.3);
    cursor: pointer;
}

.flow-step-video-overlay i {
    font-size: 48px;
    color: #FFFFFF;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    opacity: 0.9;
}

.flow-step-preview {
    color: #FFFFFF;
    font-size: 13px;
    line-height: 1.6;
    word-break: break-word;
    padding: 12px 14px;
    background: #13151C;
    border: 1px solid #242836;
    border-radius: 8px;
    margin-bottom: 12px;
    min-height: 40px;
    max-height: 100px;
    overflow: hidden;
    font-family: 'Inter', sans-serif;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.flow-step-footer {
    padding: 14px 16px;
    border-top: 1px solid #242836;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    background: #0F0F14;
    border-radius: 0 0 14px 14px;
}

.flow-step-btn-action {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    background: #E02727;
    color: #FFFFFF;
    font-weight: 700;
    box-shadow: 0 2px 6px rgba(224, 39, 39, 0.3);
    position: relative;
    z-index: 9999 !important;
    pointer-events: auto !important;
}

.flow-step-btn-action:hover {
    background: #ff3f3f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(224, 39, 39, 0.5);
}

.flow-step-btn-action:active {
    transform: translateY(0);
}

.connection-label-white {
    pointer-events: none;
    user-select: none;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    color: #FFFFFF !important;
    background-color: #0D0F15 !important;
    border: 1px solid #242836 !important;
}

/* === üî• V5.0 - ManyChat-Level Endpoints === */

/* ‚úÖ V2.0 FRONTEND: Cards consolidados - uma √∫nica defini√ß√£o */
/* üî• REMOVIDO: CSS duplicado - usar apenas a primeira defini√ß√£o acima */

/* ‚úÖ V2.0 FRONTEND: Sem transi√ß√µes durante drag */
.flow-step-block.dragging,
.flow-step-block.jtk-surface-element-dragging {
    transition: none !important;
    cursor: grabbing !important;
}

/* Ensure inner elements can use absolute positioning relative to card */
.flow-step-block > * { position: relative; }

/* ‚úÖ V2.0 FRONTEND: Endpoints consolidados - uma √∫nica defini√ß√£o completa */
.jtk-endpoint {
    z-index: 10000 !important;
    pointer-events: auto !important;
    cursor: crosshair !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.jtk-endpoint circle {
    r: 7 !important;
    fill: #10B981 !important;
    stroke: #FFFFFF !important;
    stroke-width: 2 !important;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)) !important;
    transition: all 0.2s ease !important;
}

.jtk-endpoint:hover circle {
    fill: #FFB800 !important;
    transform: scale(1.15) !important;
    filter: drop-shadow(0 4px 8px rgba(255, 184, 0, 0.6)) !important;
}

.jtk-endpoint.jtk-endpoint-connected circle {
    fill: #10B981 !important;
}

.jtk-endpoint.jtk-endpoint-disconnected circle {
    fill: #6B7280 !important;
}

/* Garantir que endpoints n√£o sejam bloqueados */
.jtk-endpoint * {
    pointer-events: auto !important;
    z-index: 10001 !important;
}

/* Garantir que SVG dos endpoints tamb√©m tenha z-index alto */
.jtk-overlay svg,
svg.jtk-overlay,
svg[class*="jtk"] {
    z-index: 10000 !important;
    pointer-events: none !important; /* SVG n√£o intercepta, apenas os endpoints */
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.jtk-overlay svg .jtk-endpoint,
svg.jtk-overlay .jtk-endpoint,
svg[class*="jtk"] .jtk-endpoint {
    pointer-events: auto !important;
}

/* üî• CR√çTICO: Garantir que elementos SVG do jsPlumb sejam sempre vis√≠veis */
svg circle,
svg .jtk-endpoint circle {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* üî• V7 PROFISSIONAL: Endpoints mais vis√≠veis e atraentes - ManyChat Level */
.jtk-endpoint circle {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)) !important;
    transition: all 0.2s ease !important;
}

.jtk-endpoint:hover circle {
    filter: drop-shadow(0 4px 8px rgba(255, 184, 0, 0.6)) !important;
    transform: scale(1.15) !important;
}

/* üî• V7 PROFISSIONAL: CSS Classes para Endpoints conforme documenta√ß√£o oficial */
.flow-endpoint-input {
    cursor: crosshair !important;
}

.flow-endpoint-input-hover,
.flow-endpoint-input:hover {
    transform: scale(1.2) !important;
    filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8)) !important;
}

.flow-endpoint-button {
    cursor: crosshair !important;
}

.flow-endpoint-button-hover,
.flow-endpoint-button:hover {
    transform: scale(1.2) !important;
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8)) !important;
}

.flow-endpoint-output {
    cursor: crosshair !important;
}

.flow-endpoint-output-hover,
.flow-endpoint-output:hover {
    transform: scale(1.2) !important;
    filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8)) !important;
}

.flow-endpoint-default {
    cursor: crosshair !important;
}

.flow-endpoint-default-hover,
.flow-endpoint-default:hover {
    transform: scale(1.2) !important;
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8)) !important;
}

/* üî• V2.0: Connectors e Overlays Profissionais */
.flow-connector {
    stroke: #FFFFFF;
    stroke-width: 2.5;
    stroke-opacity: 0.9;
    transition: all 0.2s ease;
}

.flow-connector-hover,
.flow-connector:hover {
    stroke: #FFB800;
    stroke-width: 3.5;
    stroke-opacity: 1;
    filter: drop-shadow(0 0 4px rgba(255, 184, 0, 0.5));
}

.flow-arrow-overlay {
    fill: #FFFFFF !important;
    stroke: #FFFFFF !important;
    stroke-width: 2 !important;
}

.flow-label-overlay {
    background: #0D0F15 !important;
    border: 1px solid #242836 !important;
    color: #FFFFFF !important;
    padding: 4px 8px !important;
    border-radius: 6px !important;
    font-size: 10px !important;
    font-weight: 600 !important;
    font-family: 'Inter', sans-serif !important;
    pointer-events: none !important;
}

/* üî• V2.0: Visual Feedback para M√∫ltipla Sele√ß√£o */
.flow-step-block.jtk-surface-selected-element:hover {
    transform: scale(1.03);
    box-shadow: 
        0 0 0 2px rgba(255, 184, 0, 0.5) !important,
        0 0 0 4px rgba(255, 184, 0, 0.3) !important,
        0 12px 32px rgba(255, 184, 0, 0.4) !important;
}

/* ‚úÖ V2.0 FRONTEND: Transi√ß√µes suaves (consolidado acima, removido duplica√ß√£o) */

.flow-step-block.dragging,
.flow-step-block.jtk-surface-element-dragging {
    cursor: grabbing !important;
}

/* üî• V7 PROFISSIONAL: Garantir que SVG overlay est√° acima de tudo */
#flow-visual-canvas svg {
    z-index: 10001 !important;
    pointer-events: none !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

#flow-visual-canvas svg .jtk-endpoint {
    pointer-events: auto !important;
    z-index: 10002 !important;
}

/* üî• V7 PROFISSIONAL: Endpoints de entrada (input) - verde */
.jtk-endpoint[data-endpoint-type="input"] circle,
svg circle[data-endpoint-type="input"] {
    fill: #10B981 !important;
    stroke: #FFFFFF !important;
    stroke-width: 2 !important;
    r: 7 !important;
}

/* üî• V7 PROFISSIONAL: Endpoints de sa√≠da (output) - branco */
.jtk-endpoint[data-endpoint-type="output"] circle,
.jtk-endpoint[data-endpoint-type="global"] circle,
svg circle[data-endpoint-type="output"],
svg circle[data-endpoint-type="global"] {
    fill: #FFFFFF !important;
    stroke: #0D0F15 !important;
    stroke-width: 2 !important;
    r: 7 !important;
}

/* üî• V7 PROFISSIONAL: Endpoints de bot√£o - branco menor */
.jtk-endpoint[data-endpoint-type="button"] circle,
svg circle[data-endpoint-type="button"] {
    fill: #FFFFFF !important;
    stroke: #0D0F15 !important;
    stroke-width: 2 !important;
    r: 6 !important;
}

/* üî• FASE 1: CSS Classes Oficiais jsPlumb conforme documenta√ß√£o */
/* UI Core - Nodes */
.jtk-node {
    position: relative;
}

.jtk-connected {
    /* Elemento tem uma ou mais conex√µes */
}

.jtk-surface-element-dragging {
    opacity: 0.95;
    z-index: 1000 !important;
    cursor: grabbing !important;
}

/* üî• V2.0: Most Recently Dragged - Visual Feedback */
.jtk-most-recently-dragged {
    transition: all 0.3s ease;
    box-shadow: 
        0 0 0 1px rgba(59, 130, 246, 0.3),
        0 4px 16px rgba(59, 130, 246, 0.2) !important;
}

/* Edges */
.jtk-connector-outline {
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 4;
    fill: none;
    pointer-events: none;
}

.jtk-label-overlay {
    pointer-events: none;
}

.jtk-overlay {
    pointer-events: none;
}

/* Surface */
.jtk-surface {
    position: relative;
}

.jtk-surface-canvas {
    position: relative;
}

/* üî• V2.0: Selection System - Visual Feedback */
.jtk-surface-selected-element {
    border-color: #FFB800 !important;
    box-shadow: 
        0 0 0 2px rgba(255, 184, 0, 0.4) !important,
        0 0 0 4px rgba(255, 184, 0, 0.2) !important,
        0 8px 24px rgba(255, 184, 0, 0.3) !important;
    transform: scale(1.02);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 500 !important;
}

/* üî• V2.0: Combinar com flow-step-selected */
.flow-step-block.jtk-surface-selected-element,
.flow-step-block.flow-step-selected {
    border-color: #FFB800 !important;
    box-shadow: 
        0 0 0 2px rgba(255, 184, 0, 0.4) !important,
        0 0 0 4px rgba(255, 184, 0, 0.2) !important,
        0 8px 24px rgba(255, 184, 0, 0.3) !important;
    transform: scale(1.02);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 500 !important;
}

/* üî• V2.0: Lasso Selection Visual */
.flow-lasso-selection {
    position: absolute;
    border: 2px dashed #3B82F6;
    background: rgba(59, 130, 246, 0.1);
    pointer-events: none;
    z-index: 10000;
    border-radius: 4px;
    animation: lassoPulse 1s ease-in-out infinite;
}

@keyframes lassoPulse {
    0%, 100% {
        border-color: #3B82F6;
        background: rgba(59, 130, 246, 0.1);
    }
    50% {
        border-color: #60A5FA;
        background: rgba(59, 130, 246, 0.15);
    }
}

.jtk-surface-selected-connection {
    stroke: #FFB800 !important;
    stroke-width: 3.5 !important;
}

.jtk-surface-panning {
    cursor: grabbing !important;
}

.jtk-surface-nopan {
    cursor: default !important;
}

/* Element Dragging */
.jtk-vertex-drag-active {
    border-color: rgba(255, 184, 0, 0.5) !important;
}

.jtk-vertex-drag-hover {
    border-color: #FFB800 !important;
    box-shadow: 0 0 0 2px rgba(255, 184, 0, 0.3) !important;
}

/* üî• V7 PROFISSIONAL: Canvas n√£o deve ter transform */
#flow-visual-canvas {
    transform: none !important;
    background-position: 0 0 !important;
}

/* Provide a visible pin outside the card for custom fallback */
.flow-step-pin {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #FFFFFF;
    border: 3px solid #0D0F15;
    box-shadow: 0 0 8px rgba(255,255,255,0.07);
    position: absolute;
    z-index: 1999;
    pointer-events: none; /* real interaction via jsPlumb endpoints */
}

/* Input pin positioning (left, centered vertically) */
.flow-step-pin.input {
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
}

/* Output pin positioning (right, centered vertically) */
.flow-step-pin.output {
    right: -10px;
    top: 50%;
    transform: translateY(-50%);
}

/* Button endpoint container inside button (visual only) */
.flow-step-button-endpoint-container {
    position: relative;
    pointer-events: none; /* let jsPlumb endpoint overlay be clickable */
    width: 20px;
    height: 20px;
}

/* üî• V7 PROFISSIONAL: Connectors estilo ManyChat/Typebot */
.jtk-connector,
.flow-connector {
    cursor: pointer !important;
    transition: stroke-width 0.2s cubic-bezier(0.4, 0, 0.2, 1), 
                stroke-opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1),
                stroke 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    stroke: #FFFFFF !important;
    stroke-width: 2.5 !important;
    stroke-opacity: 0.9 !important;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

.jtk-connector:hover,
.flow-connector-hover,
.jtk-connector.flow-connector-hover {
    stroke: #FFB800 !important; /* Amarelo no hover (estilo ManyChat) */
    stroke-width: 3.5 !important;
    stroke-opacity: 1 !important;
    filter: drop-shadow(0 2px 4px rgba(255, 184, 0, 0.4));
}

.jtk-connector path {
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke: #FFFFFF !important;
}

.jtk-connector.jtk-connector-new {
    animation: connectionGlow 0.5s ease-out;
}

@keyframes connectionGlow {
    0% {
        opacity: 0;
        stroke-opacity: 0;
    }
    50% {
        stroke-opacity: 1;
    }
    100% {
        opacity: 1;
        stroke-opacity: 0.9;
    }
}

/* üî• V7 PROFISSIONAL: Arrow Overlay conforme documenta√ß√£o oficial */
.flow-arrow-overlay {
    fill: #FFFFFF !important;
    stroke: #FFFFFF !important;
    stroke-width: 2 !important;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
}

.jtk-connector:hover .flow-arrow-overlay {
    fill: #FFB800 !important;
    stroke: #FFB800 !important;
    filter: drop-shadow(0 2px 4px rgba(255, 184, 0, 0.6));
}

/* üî• V7 PROFISSIONAL: Label Overlay conforme documenta√ß√£o oficial */
.flow-label-overlay {
    color: #FFFFFF !important;
    background-color: rgba(13, 15, 21, 0.95) !important;
    border: 1px solid rgba(36, 40, 54, 0.8) !important;
    padding: 4px 10px !important;
    border-radius: 6px !important;
    font-size: 11px !important;
    font-weight: 600 !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    white-space: nowrap !important;
    pointer-events: none !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    backdrop-filter: blur(4px) !important;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.jtk-connector:hover .flow-label-overlay {
    background-color: rgba(255, 184, 0, 0.15) !important;
    border-color: rgba(255, 184, 0, 0.5) !important;
    transform: scale(1.05) !important;
}

.flow-label-button {
    background-color: rgba(224, 39, 39, 0.95) !important;
    border-color: rgba(224, 39, 39, 1) !important;
}

.jtk-connector:hover .flow-label-button {
    background-color: rgba(255, 184, 0, 0.95) !important;
    border-color: rgba(255, 184, 0, 1) !important;
}

.flow-step-block button,
.flow-step-block input,
.flow-step-block textarea,
.flow-step-block select,
.flow-step-block a,
.flow-step-block i {
    cursor: pointer !important;
    pointer-events: auto !important;
    user-select: auto !important;
}

/* CSS para Forms, Tabs, Modals */
.config-section {
    background: #13151C;
    border: 1px solid #242836;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
}

.config-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.config-section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #FFFFFF;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #A1A1A9;
    margin-bottom: 8px;
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-textarea {
    width: 100%;
    padding: 12px 16px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
}

.form-textarea:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-select {
    width: 100%;
    padding: 12px 16px;
    background: #0F0F14;
    border: 1px solid #242836;
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    cursor: pointer;
}

.form-select:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #FFB800;
    color: #000000;
}

.btn-primary:hover {
    background: #FFC633;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
}

.btn-danger {
    background: #EF4444;
    color: #FFFFFF;
}

.btn-danger:hover {
    background: #DC2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-secondary {
    background: #242836;
    color: #FFFFFF;
}

.btn-secondary:hover {
    background: #2D3142;
}

.tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 1px solid #242836;
    overflow-x: auto;
}

.tab {
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: #A1A1A9;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.tab:hover {
    color: #FFFFFF;
}

.tab.active {
    color: #FFB800;
    border-bottom-color: #FFB800;
}

.modal {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
}

.modal-content {
    background: #13151C;
    border: 1px solid #242836;
    border-radius: 12px;
    padding: 24px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    width: 100%;
}

@media (min-width: 640px) {
    .modal-content {
        max-width: 600px;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #FFFFFF;
}

.modal-close {
    background: transparent;
    border: none;
    color: #A1A1A9;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: #242836;
    color: #FFFFFF;
}

/* Responsividade */
@media (max-width: 768px) {
    .flow-step-block {
        min-width: 180px;
        max-width: 240px;
        width: 200px;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 320px) !important;
        min-height: 400px !important;
    }
    
    .config-section {
        padding: 16px;
    }
    
    .config-section-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

@media (max-width: 640px) {
    .flow-step-block {
        min-width: 160px;
        max-width: 200px;
        width: 180px;
        font-size: 0.875rem;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 280px) !important;
        min-height: 350px !important;
    }
    
    .config-section {
        padding: 12px;
        border-radius: 8px;
    }
    
    .config-section-header {
        gap: 8px;
    }
    
    .config-section-title {
        font-size: 1rem;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .grid.grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .grid.grid-cols-1.md\:grid-cols-3 {
        grid-template-columns: 1fr;
    }
    
    .max-w-full {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    .btn-action {
        width: 100%;
        justify-content: center;
    }
    
    #flow-visual-canvas {
        width: 100% !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 0 !important;
    }
    
    .grid {
        grid-template-columns: 1fr !important;
    }
    
    .fixed.inset-0.z-50 > .flex > div,
    [id^="flow-step-modal-"],
    [id^="condition-modal-"] {
        width: 95% !important;
        max-width: 95% !important;
        margin: 0 auto !important;
        padding: 1rem !important;
    }
}

* {
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
}
</style>
<script>
    window.stripSurrogateChars = function (value) {
        if (!value) {
            return '';
        }
        try {
            return value;
        } catch (err) {
            return value || '';
        }
    };
</script>

<!-- ‚úÖ CR√çTICO: Definir botConfigApp ANTES do Alpine inicializar -->
<script>
// ‚úÖ Garantir que botConfigApp est√° dispon√≠vel globalmente ANTES do Alpine inicializar
// Fun√ß√£o tempor√°ria com todas as propriedades necess√°rias para evitar erros do Alpine
window.botConfigApp = function() {
    return {
        bot_id: {{ bot.id }},
        loading: true,
        activeTab: 'welcome',
        config: {
            id: null,
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            welcome_audio_enabled: false,
            welcome_audio_url: '',
            main_buttons: [],
            redirect_buttons: [],
            downsells_enabled: false,
            downsells: [],
            upsells_enabled: false,
            upsells: [],
            access_link: '',
            success_message: '',
            pending_message: '',
            flow_enabled: false,
            flow_steps: [],
            flow_start_step_id: null
        },
        new_bot_token: '',
        showStepModal: false,
        editingStep: null,
        detectedMediaType: null,
        detectedStepMediaType: null,
        subscriptionGuideExpanded: false,
        subscriptionGuideTab: 'telegram',
        editingStepIndex: -1,
        _saveMessage: null,
        _saveMessageTimeout: null,
        async init() {
            // Carregar configura√ß√£o imediatamente, mesmo na vers√£o tempor√°ria
            await this.loadConfig();
        },
        getWelcomeMessageLength() {
            return 0;
        },
        isValidBotToken() {
            return false;
        },
        detectMediaType() {},
        detectStepMediaType() {},
        changeBotToken() {},
        async saveConfig() {
            console.log('üîç saveConfig chamado (vers√£o tempor√°ria)');
            
            // Implementar salvamento direto (sempre funciona, n√£o depende da vers√£o completa)
            this.loading = true;
            try {
                console.log('üíæ Salvando configura√ß√£o...', {
                    bot_id: this.bot_id,
                    has_buttons: !!this.config.main_buttons,
                    buttons_count: this.config.main_buttons?.length || 0
                });
                
                const response = await fetch(`/api/bots/${this.bot_id}/config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.config)
                });
                
                console.log('üì° Resposta recebida:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
                    }
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Dados salvos:', data);
                console.log('‚úÖ Configura√ß√£o salva com sucesso!');
                alert('‚úÖ Configura√ß√£o salva com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar configura√ß√£o:', error);
                alert('‚ùå Erro ao salvar: ' + (error.message || 'Erro desconhecido'));
            } finally {
                this.loading = false;
            }
        },
        addButton() {
            console.log('üîç addButton chamado (vers√£o tempor√°ria)');
            if (!this.config.main_buttons) {
                this.config.main_buttons = [];
            }
            this.config.main_buttons.push({
                text: '',
                price: null,
                description: '',
                order_bumps: [],
                subscription: {
                    enabled: false,
                    duration_type: 'days',
                    duration_value: null,
                    vip_chat_id: '',
                    vip_group_link: '',
                    validation_status: null
                }
            });
            console.log('‚úÖ Bot√£o adicionado. Total:', this.config.main_buttons.length);
        },
        removeButton(index) {
            console.log('üîç removeButton chamado (vers√£o tempor√°ria)', index);
            if (this.config.main_buttons && this.config.main_buttons[index]) {
                this.config.main_buttons.splice(index, 1);
                console.log('‚úÖ Bot√£o removido. Total:', this.config.main_buttons.length);
            }
        },
        addOrderBump(buttonIndex) {
            console.log('üîç addOrderBump chamado (vers√£o tempor√°ria)', buttonIndex);
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            if (!this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps = [];
            }
            this.config.main_buttons[buttonIndex].order_bumps.push({
                enabled: false,
                message: '',
                price: null,
                description: '',
                media_type: 'video',
                media_url: '',
                audio_enabled: false,
                audio_url: '',
                accept_text: 'Sim, eu quero!',
                decline_text: 'N√£o, obrigado'
            });
            console.log('‚úÖ Order bump adicionado');
        },
        removeOrderBump(buttonIndex, bumpIndex) {
            console.log('üîç removeOrderBump chamado (vers√£o tempor√°ria)', buttonIndex, bumpIndex);
            if (this.config.main_buttons && 
                this.config.main_buttons[buttonIndex] && 
                this.config.main_buttons[buttonIndex].order_bumps &&
                this.config.main_buttons[buttonIndex].order_bumps[bumpIndex]) {
                this.config.main_buttons[buttonIndex].order_bumps.splice(bumpIndex, 1);
                console.log('‚úÖ Order bump removido');
            }
        },
        validateProductField() {},
        addDownsell() {
            console.log('üîç addDownsell chamado (vers√£o tempor√°ria)');
            if (!this.config.downsells) {
                this.config.downsells = [];
            }
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                price: null,
                pricing_mode: 'fixed',
                discount_percentage: null,
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                order_bump: {
                    enabled: false,
                    message: '',
                    price: null,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    audio_enabled: false,
                    audio_url: '',
                    accept_text: 'Sim, eu quero!',
                    decline_text: 'N√£o, obrigado'
                },
                subscription: {
                    enabled: false,
                    duration_type: 'days',
                    duration_value: null,
                    vip_chat_id: '',
                    vip_group_link: '',
                    validation_status: null
                }
            });
            console.log('‚úÖ Downsell adicionado. Total:', this.config.downsells.length);
        },
        removeDownsell(index) {
            console.log('üîç removeDownsell chamado (vers√£o tempor√°ria)', index);
            if (this.config.downsells && this.config.downsells[index]) {
                this.config.downsells.splice(index, 1);
                console.log('‚úÖ Downsell removido. Total:', this.config.downsells.length);
            }
        },
        addUpsell() {
            console.log('üîç addUpsell chamado (vers√£o tempor√°ria)');
            if (!this.config.upsells) {
                this.config.upsells = [];
            }
            this.config.upsells.push({
                trigger_product: '',
                delay_minutes: 0,
                message: '',
                price: null,
                product_name: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                access_link: '',
                subscription: {
                    enabled: false,
                    duration_type: 'days',
                    duration_value: null,
                    vip_chat_id: '',
                    vip_group_link: '',
                    validation_status: null
                }
            });
            console.log('‚úÖ Upsell adicionado. Total:', this.config.upsells.length);
        },
        removeUpsell(index) {
            console.log('üîç removeUpsell chamado (vers√£o tempor√°ria)', index);
            if (this.config.upsells && this.config.upsells[index]) {
                this.config.upsells.splice(index, 1);
                console.log('‚úÖ Upsell removido. Total:', this.config.upsells.length);
            }
        },
        addRedirectButton() {
            console.log('üîç addRedirectButton chamado (vers√£o tempor√°ria)');
            if (!this.config.redirect_buttons) {
                this.config.redirect_buttons = [];
            }
            this.config.redirect_buttons.push({
                text: '',
                url: ''
            });
            console.log('‚úÖ Bot√£o de redirecionamento adicionado. Total:', this.config.redirect_buttons.length);
        },
        removeRedirectButton(index) {
            console.log('üîç removeRedirectButton chamado (vers√£o tempor√°ria)', index);
            if (this.config.redirect_buttons && this.config.redirect_buttons[index]) {
                this.config.redirect_buttons.splice(index, 1);
                console.log('‚úÖ Bot√£o de redirecionamento removido. Total:', this.config.redirect_buttons.length);
            }
        },
        onFlowToggle() {},
        addFlowStep() {},
        removeFlowStep() {},
        addCondition() {},
        removeCondition() {},
        addCustomButton() {},
        removeCustomButton() {},
        getStepTypeLabel() { return ''; },
        getStepTypeIcon() { return ''; },
        getConditionTypeLabel() { return ''; },
        getAvailableStepsForConnection() { return []; },
        validateWelcomeMessage() {},
        openStepModal() {},
        closeStepModal() {},
        saveStep() {},
        watchFlowSteps() {},
        async loadConfig() {
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                console.log('üì¶ Dados carregados da API (vers√£o tempor√°ria):', data);
                
                if (data && typeof data === 'object') {
                    this.config.id = data.id || null;
                    this.config.welcome_message = data.welcome_message || '';
                    this.config.welcome_media_url = data.welcome_media_url || '';
                    this.config.welcome_media_type = data.welcome_media_type || 'video';
                    this.config.welcome_audio_enabled = data.welcome_audio_enabled || false;
                    this.config.welcome_audio_url = data.welcome_audio_url || '';
                    
                    const defaultSubscription = {
                        enabled: false,
                        duration_type: 'days',
                        duration_value: null,
                        vip_chat_id: '',
                        vip_group_link: '',
                        validation_status: null
                    };
                    
                    this.config.main_buttons = (data.main_buttons || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.redirect_buttons = data.redirect_buttons || [];
                    this.config.downsells_enabled = data.downsells_enabled || false;
                    this.config.downsells = (data.downsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.upsells_enabled = data.upsells_enabled || false;
                    this.config.upsells = (data.upsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.access_link = data.access_link || '';
                    this.config.success_message = data.success_message || '';
                    this.config.pending_message = data.pending_message || '';
                    this.config.flow_enabled = data.flow_enabled || false;
                    this.config.flow_steps = data.flow_steps || [];
                    this.config.flow_start_step_id = data.flow_start_step_id || null;
                    this.config.has_meta_pixel = data.has_meta_pixel || false;
                    
                    console.log('‚úÖ Configura√ß√£o carregada (vers√£o tempor√°ria):', {
                        buttons: this.config.main_buttons?.length || 0,
                        downsells: this.config.downsells?.length || 0,
                        upsells: this.config.upsells?.length || 0
                    });
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√£o:', error);
                alert('Erro ao carregar configura√ß√£o. Recarregue a p√°gina.');
            } finally {
                this.loading = false;
            }
        },
        initVisualFlowEditor() {}
    };
};
console.log('‚úÖ botConfigApp tempor√°rio definido (ser√° substitu√≠do pela vers√£o completa no extra_scripts)');
</script>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8" x-data="botConfigApp()" x-init="init()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-white mb-2">Configurar Bot: {{ bot.name }}</h1>
        <p class="text-gray-400">Configure todas as op√ß√µes do seu bot</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button @click="activeTab = 'welcome'" :class="{'active': activeTab === 'welcome'}" class="tab">
            <i class="fas fa-comment"></i> Mensagem Inicial
        </button>
        <button @click="activeTab = 'buttons'" :class="{'active': activeTab === 'buttons'}" class="tab">
            <i class="fas fa-mouse-pointer"></i> Bot√µes Principais
        </button>
        <button @click="activeTab = 'subscriptions'" :class="{'active': activeTab === 'subscriptions'}" class="tab">
            <i class="fas fa-crown"></i> Assinaturas
        </button>
        <button @click="activeTab = 'downsells'" :class="{'active': activeTab === 'downsells'}" class="tab">
            <i class="fas fa-arrow-down"></i> Downsells
        </button>
        <button @click="activeTab = 'upsells'" :class="{'active': activeTab === 'upsells'}" class="tab">
            <i class="fas fa-arrow-up"></i> Upsells
        </button>
        <button @click="activeTab = 'redirect'" :class="{'active': activeTab === 'redirect'}" class="tab">
            <i class="fas fa-external-link-alt"></i> Redirecionamento
        </button>
        <button @click="activeTab = 'flow'" :class="{'active': activeTab === 'flow'}" class="tab">
            <i class="fas fa-project-diagram"></i> Fluxo Visual
        </button>
        <button @click="activeTab = 'settings'" :class="{'active': activeTab === 'settings'}" class="tab">
            <i class="fas fa-cog"></i> Configura√ß√µes
        </button>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-yellow-500"></i>
        <p class="mt-4 text-gray-400">Carregando...</p>
    </div>

    <!-- Tab Content -->
    <div x-show="!loading">
        <!-- Welcome Tab -->
        <div x-show="activeTab === 'welcome'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Mensagem Inicial</h2>
            </div>
            
            <!-- Instru√ß√µes -->
            <div class="mb-6 p-4 rounded-lg border-2" style="background: rgba(59, 130, 246, 0.15); border-color: #3B82F6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center" style="box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);">
                        <i class="fas fa-info-circle text-white text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm font-bold mb-3" style="color: #93C5FD; text-shadow: 0 0 10px rgba(147, 197, 253, 0.5);">Como obter URLs do Telegram:</h4>
                        <ul class="text-xs space-y-2 list-disc list-inside" style="color: #DBEAFE;">
                            <li class="font-semibold">Envie a m√≠dia/√°udio para o bot <strong style="color: #FFFFFF;">@getidsbot</strong> ou <strong style="color: #FFFFFF;">@userinfobot</strong></li>
                            <li class="font-semibold">Copie o <code class="px-2 py-1 rounded font-mono font-bold" style="background: rgba(59, 130, 246, 0.3); color: #FFFFFF; border: 1px solid #3B82F6;">file_id</code> ou <code class="px-2 py-1 rounded font-mono font-bold" style="background: rgba(59, 130, 246, 0.3); color: #FFFFFF; border: 1px solid #3B82F6;">file_unique_id</code></li>
                            <li class="font-semibold">Ou use links diretos do Telegram: <code class="px-2 py-1 rounded font-mono font-bold" style="background: rgba(59, 130, 246, 0.3); color: #FFFFFF; border: 1px solid #3B82F6;">https://t.me/...</code></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Mensagem de Boas-vindas</label>
                <textarea 
                    x-model="config.welcome_message" 
                    class="form-textarea"
                    placeholder="Digite a mensagem de boas-vindas que ser√° enviada quando o usu√°rio iniciar uma conversa com o bot..."
                    :maxlength="4096"
                    rows="6"
                ></textarea>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm" :class="(config.welcome_message || '').length > 4000 ? 'text-red-400' : (config.welcome_message || '').length > 3500 ? 'text-yellow-400' : 'text-gray-400'">
                        <span x-text="(config.welcome_message || '').length"></span> / 4096 caracteres
                    </p>
                    <p class="text-xs text-gray-500" x-show="getWelcomeMessageLength() > 4096">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i> Tamanho total excede o limite do Telegram
                    </p>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">URL da M√≠dia (Foto ou V√≠deo)</label>
                <div class="relative">
                    <input 
                        type="text" 
                        x-model="config.welcome_media_url" 
                        @input="detectMediaType()"
                        class="form-input"
                        placeholder="Cole aqui o file_id ou URL do Telegram (foto ou v√≠deo)..."
                        :class="{
                            'border-green-500': config.welcome_media_url && (config.welcome_media_url.startsWith('http') || config.welcome_media_url.length > 10),
                            'border-red-500': config.welcome_media_url && config.welcome_media_url.length > 0 && !config.welcome_media_url.startsWith('http') && config.welcome_media_url.length < 10
                        }"
                    />
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                        <span x-show="config.welcome_media_url && detectedMediaType" 
                              class="text-xs font-semibold px-2 py-1 rounded"
                              :class="detectedMediaType === 'video' ? 'bg-red-500 bg-opacity-20 text-red-300' : 'bg-blue-500 bg-opacity-20 text-blue-300'"
                              x-text="detectedMediaType === 'video' ? 'üé• V√≠deo' : 'üì∑ Foto'"></span>
                        <i class="fas fa-check-circle text-green-500" 
                           x-show="config.welcome_media_url && (config.welcome_media_url.startsWith('http') || config.welcome_media_url.length > 10)"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-magic"></i> O tipo (foto/v√≠deo) √© detectado automaticamente pela URL ou extens√£o do arquivo
                </p>
                <!-- Campo hidden para o backend -->
                <input type="hidden" x-model="config.welcome_media_type" />
            </div>

            <div class="form-group">
                <label class="flex items-center gap-2">
                    <input type="checkbox" x-model="config.welcome_audio_enabled" />
                    <span class="form-label">Habilitar √Åudio Complementar</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">O √°udio ser√° enviado ap√≥s a m√≠dia (se houver) ou ap√≥s a mensagem</p>
            </div>

            <div x-show="config.welcome_audio_enabled" class="form-group">
                <label class="form-label">URL do √Åudio</label>
                <div class="relative">
                    <input 
                        type="text" 
                        x-model="config.welcome_audio_url" 
                        class="form-input"
                        placeholder="Cole aqui o file_id ou URL do √°udio do Telegram..."
                        :class="{
                            'border-green-500': config.welcome_audio_url && (config.welcome_audio_url.startsWith('http') || config.welcome_audio_url.length > 10),
                            'border-red-500': config.welcome_audio_url && config.welcome_audio_url.length > 0 && !config.welcome_audio_url.startsWith('http') && config.welcome_audio_url.length < 10
                        }"
                    />
                    <i class="fas fa-check-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500" 
                       x-show="config.welcome_audio_url && (config.welcome_audio_url.startsWith('http') || config.welcome_audio_url.length > 10)"></i>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lightbulb"></i> Pode ser um <code class="bg-gray-800 px-1 rounded">file_id</code> do Telegram ou uma URL
                </p>
            </div>

            <!-- Preview da Mensagem -->
            <div class="mt-6 border-t border-gray-700 pt-6">
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <div class="space-y-3">
                        <!-- Preview da Mensagem -->
                        <div x-show="config.welcome_message" class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-white whitespace-pre-wrap" x-text="config.welcome_message || 'Sua mensagem aparecer√° aqui...'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Preview da M√≠dia -->
                        <div x-show="config.welcome_media_url" class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i :class="(detectedMediaType || config.welcome_media_type) === 'video' ? 'fas fa-video text-white' : 'fas fa-image text-white'"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-white font-semibold" x-text="(detectedMediaType || config.welcome_media_type) === 'video' ? 'V√≠deo' : 'Foto'"></p>
                                    <p class="text-xs text-gray-400 truncate" x-text="config.welcome_media_url"></p>
                                    <p class="text-xs text-blue-400 mt-1" x-show="detectedMediaType">
                                        <i class="fas fa-magic"></i> Tipo detectado automaticamente
                                    </p>
                                </div>
                                <i class="fas fa-check-circle text-green-400"></i>
                            </div>
                        </div>

                        <!-- Preview do √Åudio -->
                        <div x-show="config.welcome_audio_enabled && config.welcome_audio_url" class="bg-gray-900 rounded-lg p-4 border border-gray-600">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-headphones text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-white font-semibold">√Åudio Complementar</p>
                                    <p class="text-xs text-gray-400 truncate" x-text="config.welcome_audio_url"></p>
                                </div>
                                <i class="fas fa-check-circle text-green-400"></i>
                            </div>
                        </div>

                        <!-- Mensagem quando n√£o h√° conte√∫do -->
                        <div x-show="!config.welcome_message && !config.welcome_media_url && (!config.welcome_audio_enabled || !config.welcome_audio_url)" 
                             class="text-center py-8 text-gray-500">
                            <i class="fas fa-comment-slash text-3xl mb-2"></i>
                            <p class="text-sm">Configure a mensagem inicial acima para ver o preview</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumo de Configura√ß√£o -->
            <div class="mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
                <h4 class="text-sm font-semibold text-gray-300 mb-3">Resumo da Configura√ß√£o</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-comment" :class="config.welcome_message ? 'text-green-400' : 'text-gray-500'"></i>
                        <span :class="config.welcome_message ? 'text-white' : 'text-gray-500'">
                            Mensagem: <strong x-text="config.welcome_message ? 'Configurada' : 'N√£o configurada'"></strong>
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i :class="(detectedMediaType || config.welcome_media_type) === 'video' ? 'fas fa-video' : 'fas fa-image'" 
                           :class="config.welcome_media_url ? 'text-green-400' : 'text-gray-500'"></i>
                        <span :class="config.welcome_media_url ? 'text-white' : 'text-gray-500'">
                            M√≠dia: <strong x-text="config.welcome_media_url ? ((detectedMediaType || config.welcome_media_type) === 'video' ? 'V√≠deo configurado' : 'Foto configurada') : 'N√£o configurada'"></strong>
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-headphones" :class="config.welcome_audio_enabled && config.welcome_audio_url ? 'text-green-400' : 'text-gray-500'"></i>
                        <span :class="config.welcome_audio_enabled && config.welcome_audio_url ? 'text-white' : 'text-gray-500'">
                            √Åudio: <strong x-text="config.welcome_audio_enabled && config.welcome_audio_url ? 'Configurado' : 'N√£o configurado'"></strong>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons Tab -->
        <div x-show="activeTab === 'buttons'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Bot√µes Principais</h2>
                <button @click="addButton()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Bot√£o
                </button>
            </div>

            <div class="space-y-6">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Bot√£o <span x-text="index + 1"></span></h3>
                            <button @click="removeButton(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Bot√£o</label>
                            <input 
                                type="text" 
                                x-model="button.text"
                                @blur="validateProductField(index, 'text')"
                                class="form-input"
                                placeholder="Ex: Comprar Agora"
                                maxlength="64"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Pre√ßo (R$)</label>
                            <input 
                                type="number" 
                                x-model.number="button.price"
                                @blur="validateProductField(index, 'price')"
                                class="form-input"
                                placeholder="0.00"
                                step="0.01"
                                min="0"
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <textarea 
                                x-model="button.description" 
                                class="form-textarea"
                                placeholder="Descri√ß√£o do produto..."
                            ></textarea>
                        </div>

                        <!-- Preview do Bot√£o -->
                        <div class="mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Preview do Bot√£o</h4>
                            <div class="bg-gray-900 p-3 rounded border border-gray-600">
                                <div class="text-white font-semibold mb-1" x-text="button.text || 'Texto do bot√£o'"></div>
                                <div class="text-gray-400 text-sm mb-2" x-text="button.description || 'Descri√ß√£o do produto'"></div>
                                <div class="text-yellow-400 font-bold" x-show="button.price">
                                    R$ <span x-text="(typeof button.price === 'number' ? button.price.toFixed(2) : (parseFloat(button.price) || 0).toFixed(2))"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Bumps -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-md font-semibold text-white">Order Bumps</h4>
                                <button @click="addOrderBump(index)" class="btn btn-secondary">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>

                            <template x-for="(bump, bumpIndex) in (button.order_bumps || [])" :key="bumpIndex">
                                <div class="border border-gray-600 rounded p-3 mt-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-400">Order Bump <span x-text="bumpIndex + 1"></span></span>
                                        <button @click="removeOrderBump(index, bumpIndex)" class="text-red-400 hover:text-red-300">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>

                                    <div class="form-group">
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" x-model="bump.enabled" />
                                            <span class="form-label">Habilitado</span>
                                        </label>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Mensagem</label>
                                        <textarea x-model="bump.message" class="form-textarea"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Pre√ßo (R$)</label>
                                        <input type="number" x-model.number="bump.price" class="form-input" step="0.01" min="0" />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Descri√ß√£o</label>
                                        <textarea x-model="bump.description" class="form-textarea"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Tipo de M√≠dia</label>
                                        <select x-model="bump.media_type" class="form-select">
                                            <option value="video">V√≠deo</option>
                                            <option value="photo">Foto</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">URL da M√≠dia</label>
                                        <input type="text" x-model="bump.media_url" class="form-input" placeholder="https://..." />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Texto do Bot√£o Aceitar</label>
                                        <input type="text" x-model="bump.accept_text" class="form-input" placeholder="Sim, eu quero!" />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Texto do Bot√£o Recusar</label>
                                        <input type="text" x-model="bump.decline_text" class="form-input" placeholder="N√£o, obrigado" />
                                    </div>

                                    <!-- Preview do Order Bump -->
                                    <div class="mt-3 p-3 bg-gray-800 rounded border border-gray-600" x-show="bump.enabled">
                                        <h5 class="text-xs font-semibold text-gray-300 mb-2">Preview do Order Bump</h5>
                                        <div class="bg-gray-900 p-2 rounded text-sm">
                                            <div class="text-white mb-1" x-text="bump.message || 'Mensagem do order bump'"></div>
                                            <div class="text-gray-400 text-xs mb-2" x-text="bump.description || 'Descri√ß√£o'"></div>
                                            <div class="flex gap-2">
                                                <button class="px-3 py-1 bg-green-600 text-white rounded text-xs" x-text="bump.accept_text || 'Sim, eu quero!'"></button>
                                                <button class="px-3 py-1 bg-gray-600 text-white rounded text-xs" x-text="bump.decline_text || 'N√£o, obrigado'"></button>
                                            </div>
                                            <div class="text-yellow-400 text-xs mt-2" x-show="bump.price">
                                                + R$ <span x-text="(typeof bump.price === 'number' ? bump.price.toFixed(2) : (parseFloat(bump.price) || 0).toFixed(2))"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Subscriptions Tab -->
        <div x-show="activeTab === 'subscriptions'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Assinaturas VIP</h2>
            </div>
            <p class="text-gray-400 mb-4">Configure assinaturas VIP para os bot√µes principais. Os usu√°rios que comprarem receber√£o acesso ao grupo VIP pelo per√≠odo configurado.</p>
            
            <div class="space-y-6">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">
                                Bot√£o: <span x-text="button.text || 'Sem nome'"></span>
                            </h3>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" x-model="button.subscription.enabled" />
                                <span class="form-label">Habilitar Assinatura VIP</span>
                            </label>
                        </div>

                        <div x-show="button.subscription.enabled" class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Dura√ß√£o</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <select x-model="button.subscription.duration_type" class="form-select">
                                            <option value="hours">Horas</option>
                                            <option value="days">Dias</option>
                                            <option value="weeks">Semanas</option>
                                            <option value="months">Meses</option>
                                        </select>
                                    </div>
                                    <div>
                                        <input 
                                            type="number" 
                                            x-model.number="button.subscription.duration_value" 
                                            class="form-input" 
                                            placeholder="Ex: 30"
                                            min="1"
                                        />
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2" x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                    Dura√ß√£o: <strong x-text="button.subscription.duration_value"></strong> 
                                    <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'm√™s' : 'meses')"></span>
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ID do Grupo VIP (Telegram)</label>
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        x-model="button.subscription.vip_chat_id" 
                                        class="form-input"
                                        placeholder="-1001234567890 ou https://t.me/joinchat/..."
                                        :class="{
                                            'border-green-500': button.subscription.validation_status === 'valid',
                                            'border-red-500': button.subscription.validation_status === 'invalid',
                                            'border-yellow-500': button.subscription.validation_status === 'validating',
                                            'border-gray-600': !button.subscription.validation_status
                                        }"
                                    />
                                    <i class="fas fa-check-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500" 
                                       x-show="button.subscription.validation_status === 'valid'"></i>
                                    <i class="fas fa-times-circle absolute right-3 top-1/2 transform -translate-y-1/2 text-red-500" 
                                       x-show="button.subscription.validation_status === 'invalid'"></i>
                                    <i class="fas fa-spinner fa-spin absolute right-3 top-1/2 transform -translate-y-1/2 text-yellow-500" 
                                       x-show="button.subscription.validation_status === 'validating'"></i>
                                </div>
                                <button 
                                    @click="validateSubscription(index)" 
                                    class="btn btn-secondary mt-2"
                                    :disabled="button.subscription.validation_status === 'validating' || !button.subscription.vip_chat_id"
                                >
                                    <i class="fas fa-check"></i> 
                                    <span x-show="button.subscription.validation_status !== 'validating'">Verificar se o Grupo est√° OK</span>
                                    <span x-show="button.subscription.validation_status === 'validating'">Verificando...</span>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Link do Grupo VIP (Alternativo)</label>
                                <input 
                                    type="text" 
                                    x-model="button.subscription.vip_group_link" 
                                    class="form-input"
                                    placeholder="https://t.me/joinchat/... ou https://t.me/c/..."
                                />
                            </div>

                            <div class="bg-yellow-500 bg-opacity-10 border border-yellow-400 border-opacity-30 rounded-lg p-4" 
                                 x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                <p class="text-sm text-yellow-300">
                                    <i class="fas fa-info-circle"></i> 
                                    Usu√°rios que comprarem este produto ter√£o acesso ao grupo VIP por 
                                    <strong x-text="button.subscription.duration_value"></strong> 
                                    <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'm√™s' : 'meses')"></span>.
                                </p>
                            </div>

                            <!-- Preview da Assinatura -->
                            <div class="mt-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
                                <h4 class="text-sm font-semibold text-gray-300 mb-2">Preview da Assinatura VIP</h4>
                                <div class="bg-gray-900 p-3 rounded border border-gray-600">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-crown text-yellow-400"></i>
                                        <span class="text-white font-semibold">Acesso VIP</span>
                                    </div>
                                    <div class="text-gray-400 text-sm" x-show="button.subscription.duration_value && button.subscription.duration_value > 0">
                                        Dura√ß√£o: <span class="text-white" x-text="button.subscription.duration_value"></span> 
                                        <span x-text="button.subscription.duration_type === 'hours' ? (button.subscription.duration_value == 1 ? 'hora' : 'horas') : button.subscription.duration_type === 'days' ? (button.subscription.duration_value == 1 ? 'dia' : 'dias') : button.subscription.duration_type === 'weeks' ? (button.subscription.duration_value == 1 ? 'semana' : 'semanas') : (button.subscription.duration_value == 1 ? 'm√™s' : 'meses')"></span>
                                    </div>
                                    <div class="text-gray-400 text-sm" x-show="button.subscription.vip_chat_id || button.subscription.vip_group_link">
                                        <i class="fas fa-check-circle text-green-400"></i> Grupo configurado
                                    </div>
                                    <div class="text-gray-400 text-sm" x-show="!button.subscription.vip_chat_id && !button.subscription.vip_group_link">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i> Grupo n√£o configurado
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Downsells Tab -->
        <div x-show="activeTab === 'downsells'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Downsells</h2>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="config.downsells_enabled" />
                        <span class="form-label">Habilitar Downsells</span>
                    </label>
                    <button @click="addDownsell()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Adicionar Downsell
                    </button>
                </div>
            </div>

            <div x-show="config.downsells_enabled" class="space-y-6 mt-4">
                <template x-for="(downsell, index) in config.downsells" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Downsell <span x-text="index + 1"></span></h3>
                            <button @click="removeDownsell(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Delay (minutos)</label>
                            <input type="number" x-model.number="downsell.delay_minutes" class="form-input" min="0" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mensagem</label>
                            <textarea x-model="downsell.message" class="form-textarea"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Modo de Pre√ßo</label>
                            <select x-model="downsell.pricing_mode" class="form-select">
                                <option value="fixed">Fixo</option>
                                <option value="percentage">Porcentagem</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" x-text="downsell.pricing_mode === 'percentage' ? 'Desconto (%)' : 'Pre√ßo (R$)'"></label>
                            <input 
                                type="number" 
                                x-model.number="downsell.pricing_mode === 'percentage' ? downsell.discount_percentage : downsell.price" 
                                class="form-input" 
                                step="0.01" 
                                min="0" 
                            />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Bot√£o</label>
                            <input type="text" x-model="downsell.button_text" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tipo de M√≠dia</label>
                            <select x-model="downsell.media_type" class="form-select">
                                <option value="video">V√≠deo</option>
                                <option value="photo">Foto</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL da M√≠dia</label>
                            <input type="text" x-model="downsell.media_url" class="form-input" placeholder="https://..." />
                        </div>

                        <div class="form-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" x-model="downsell.audio_enabled" />
                                <span class="form-label">Habilitar √Åudio Complementar</span>
                            </label>
                        </div>

                        <div x-show="downsell.audio_enabled" class="form-group">
                            <label class="form-label">URL do √Åudio</label>
                            <input type="text" x-model="downsell.audio_url" class="form-input" placeholder="https://..." />
                        </div>

                        <!-- Order Bump do Downsell -->
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-md font-semibold text-white">Order Bump (Opcional)</h4>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" x-model="downsell.order_bump.enabled" />
                                    <span class="form-label">Habilitar Order Bump</span>
                                </label>
                            </div>

                            <div x-show="downsell.order_bump.enabled" class="space-y-4">
                                <!-- Op√ß√£o: Usar Order Bump dos Bot√µes Principais -->
                                <div class="form-group">
                                    <label class="form-label">Usar Order Bump Existente</label>
                                    <select 
                                        @change="if ($event.target.value) { const [btnIdx, bumpIdx] = $event.target.value.split('_').map(Number); useOrderBumpFromButtons(downsell, btnIdx, bumpIdx); }"
                                        class="form-select"
                                    >
                                        <option value="">Criar novo Order Bump</option>
                                        <template x-for="(button, btnIdx) in config.main_buttons" :key="btnIdx">
                                            <template x-for="(bump, bumpIdx) in (button.order_bumps || [])" :key="bumpIdx">
                                                <option :value="`${btnIdx}_${bumpIdx}`" x-text="button.text + ' - Order Bump ' + (bumpIdx + 1)"></option>
                                            </template>
                                        </template>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Mensagem do Order Bump</label>
                                    <textarea x-model="downsell.order_bump.message" class="form-textarea"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Pre√ßo do Order Bump (R$)</label>
                                    <input type="number" x-model.number="downsell.order_bump.price" class="form-input" step="0.01" min="0" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Descri√ß√£o</label>
                                    <textarea x-model="downsell.order_bump.description" class="form-textarea"></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Tipo de M√≠dia</label>
                                    <select x-model="downsell.order_bump.media_type" class="form-select">
                                        <option value="video">V√≠deo</option>
                                        <option value="photo">Foto</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">URL da M√≠dia</label>
                                    <input type="text" x-model="downsell.order_bump.media_url" class="form-input" placeholder="https://..." />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Texto do Bot√£o Aceitar</label>
                                    <input type="text" x-model="downsell.order_bump.accept_text" class="form-input" placeholder="Sim, eu quero!" />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Texto do Bot√£o Recusar</label>
                                    <input type="text" x-model="downsell.order_bump.decline_text" class="form-input" placeholder="N√£o, obrigado" />
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Upsells Tab -->
        <div x-show="activeTab === 'upsells'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Upsells</h2>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="config.upsells_enabled" />
                        <span class="form-label">Habilitar Upsells</span>
                    </label>
                    <button @click="addUpsell()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Adicionar Upsell
                    </button>
                </div>
            </div>

            <div x-show="config.upsells_enabled" class="space-y-6 mt-4">
                <template x-for="(upsell, index) in config.upsells" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Upsell <span x-text="index + 1"></span></h3>
                            <button @click="removeUpsell(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Produto Trigger</label>
                            <input type="text" x-model="upsell.trigger_product" class="form-input" placeholder="Nome do produto que dispara este upsell" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Delay (minutos)</label>
                            <input type="number" x-model.number="upsell.delay_minutes" class="form-input" min="0" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mensagem</label>
                            <textarea x-model="upsell.message" class="form-textarea"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Pre√ßo (R$)</label>
                            <input type="number" x-model.number="upsell.price" class="form-input" step="0.01" min="0" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nome do Produto</label>
                            <input type="text" x-model="upsell.product_name" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Bot√£o</label>
                            <input type="text" x-model="upsell.button_text" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Link de Acesso</label>
                            <input type="text" x-model="upsell.access_link" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tipo de M√≠dia</label>
                            <select x-model="upsell.media_type" class="form-select">
                                <option value="video">V√≠deo</option>
                                <option value="photo">Foto</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL da M√≠dia</label>
                            <input type="text" x-model="upsell.media_url" class="form-input" placeholder="https://..." />
                        </div>

                        <div class="form-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" x-model="upsell.audio_enabled" />
                                <span class="form-label">Habilitar √Åudio Complementar</span>
                            </label>
                        </div>

                        <div x-show="upsell.audio_enabled" class="form-group">
                            <label class="form-label">URL do √Åudio</label>
                            <input type="text" x-model="upsell.audio_url" class="form-input" placeholder="https://..." />
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Redirect Tab -->
        <div x-show="activeTab === 'redirect'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Bot√µes de Redirecionamento</h2>
                <button @click="addRedirectButton()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Adicionar Bot√£o
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(button, index) in config.redirect_buttons" :key="index">
                    <div class="border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Bot√£o <span x-text="index + 1"></span></h3>
                            <button @click="removeRedirectButton(index)" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Texto do Bot√£o</label>
                            <input type="text" x-model="button.text" class="form-input" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="text" x-model="button.url" class="form-input" placeholder="https://..." />
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Flow Tab -->
        <div x-show="activeTab === 'flow'" class="config-section">
            <!-- Header da se√ß√£o -->
            <div class="config-section-header">
                <h2 class="config-section-title">Fluxo Visual</h2>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="config.flow_enabled" @change="onFlowToggle()" />
                        <span class="form-label">Habilitar Fluxo Visual</span>
                    </label>
                    <button @click="addFlowStep()" class="btn btn-primary" :disabled="!config.flow_enabled">
                        <i class="fas fa-plus"></i> Adicionar Step
                    </button>
                </div>
            </div>

            <!-- üî• FLOW BUILDER V2.0 - Editor Visual Premium -->
            <div x-show="config.flow_enabled" 
                 id="flow-builder"
                 x-data="FlowBuilderV2()" 
                 x-init="init()">
                
                <!-- Sidebar -->
                <div class="flow-sidebar">
                    <h2>Componentes</h2>

                    <button class="flow-btn" @click.stop="addNode('message')" type="button">üí¨ Mensagem</button>
                    <button class="flow-btn" @click.stop="addNode('button')" type="button">üîò Bot√µes</button>
                    <button class="flow-btn" @click.stop="addNode('condition')" type="button">üîÄ Condi√ß√£o</button>
                    <button class="flow-btn" @click.stop="addNode('payment')" type="button">üí≥ Pagamento</button>
                    <button class="flow-btn" @click.stop="addNode('delay')" type="button">‚è± Delay</button>
                    <button class="flow-btn" @click.stop="addNode('end')" type="button">üèÅ Final</button>

                    <hr style="border-color:#333;margin:18px 0">

                    <button class="flow-btn" @click.stop="saveFlow()" type="button">üíæ Salvar</button>
                    <button class="flow-btn" @click.stop="exportFlow()" type="button">‚¨Ü Exportar</button>
                    <button class="flow-btn" @click.stop="$refs.importer.click()" type="button">‚¨á Importar</button>
                    <input type="file" x-ref="importer" class="hidden" @change="importFlow($event)" accept=".json">
                </div>

                <!-- Canvas -->
                <div id="flow-canvas"
                     @wheel.prevent="zoom($event)"
                     @mousedown="startPan($event)"
                     style="position: relative; width: 100%; height: 100%; overflow: hidden; background: #0d0d0f; min-height: 500px;">
                    <!-- Mensagem inicial se n√£o houver nodes -->
                    <div x-show="nodes.length === 0" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; text-align: center; z-index: 1;">
                        <p style="font-size: 18px; margin-bottom: 10px; color: #999;">üé® Flow Builder V‚àû</p>
                        <p style="font-size: 14px; color: #666;">Clique nos bot√µes da sidebar para adicionar componentes ao fluxo</p>
                    </div>
                </div>

                <!-- Modal -->
                <template x-if="modal.open">
                    <div class="modal" @click.self="closeModal()">
                        <div class="modal-content">
                            <h2 class="text-xl font-bold mb-4">Editar Node</h2>

                            <label class="block mb-2">T√≠tulo</label>
                            <input class="input" x-model="modal.node.label">

                        <template x-if="modal.node.type === 'button'">
                            <div class="mt-4 space-y-2">
                                <template x-for="(btn, i) in modal.node.buttons">
                                    <div class="node-button-row">
                                        <input class="input" x-model="btn.label" placeholder="Texto do bot√£o">
                                        <input class="input" x-model="btn.target_step" placeholder="ID do step destino">
                                        <button class="btn-danger" @click="removeButton(i)">‚úñ</button>
                                    </div>
                                </template>
                                <button class="btn-secondary" @click="addButton()">+ Bot√£o</button>
                            </div>
                        </template>

                        <template x-if="modal.node.type === 'payment'">
                            <div class="mt-4 space-y-2">
                                <label class="block mb-2">Pre√ßo (R$)</label>
                                <input class="input" type="number" x-model.number="modal.node.config.price" step="0.01" min="0">
                                <label class="block mb-2">Nome do Produto</label>
                                <input class="input" x-model="modal.node.config.product_name">
                                <p class="text-xs text-gray-400 mt-2">
                                    üí° Configure conex√µes: "next" (se pago) e "pending" (se n√£o pago) arrastando do node.
                                </p>
                            </div>
                        </template>

                        <template x-if="modal.node.type === 'message'">
                            <div class="mt-4 space-y-2">
                                <label class="block mb-2">Mensagem</label>
                                <textarea class="input" x-model="modal.node.config.message" rows="4"></textarea>
                                <label class="block mb-2">URL da M√≠dia (opcional)</label>
                                <input class="input" x-model="modal.node.config.media_url" placeholder="https://...">
                            </div>
                        </template>

                        <template x-if="modal.node.type === 'access'">
                            <div class="mt-4 space-y-2">
                                <label class="block mb-2">Link de Acesso</label>
                                <input class="input" x-model="modal.node.config.link" placeholder="https://...">
                                <label class="block mb-2">Mensagem</label>
                                <textarea class="input" x-model="modal.node.config.message" rows="2"></textarea>
                            </div>
                        </template>

                        <div class="mt-4">
                            <label class="block mb-2">Atraso (segundos)</label>
                            <input class="input" type="number" x-model.number="modal.node.delay_seconds" min="0">
                        </div>

                        <div class="mt-4">
                            <button class="btn-secondary w-full mb-2" @click="setAsStartStep()" x-show="modal.node && modal.node.id !== startStepId" type="button">
                                ‚≠ê Definir como Step Inicial
                            </button>
                        </div>

                        <div class="mt-6 flex justify-between gap-2">
                            <button class="btn-danger" @click="deleteNode()" type="button">üóëÔ∏è Deletar</button>
                            <div class="flex gap-2">
                                <button class="btn-secondary" @click="closeModal()" type="button">Cancelar</button>
                                <button class="btn-primary" @click="applyEdit()" type="button">Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
            </div>
        </div>

        <!-- Settings Tab -->
        <div x-show="activeTab === 'settings'" class="config-section">
            <div class="config-section-header">
                <h2 class="config-section-title">Configura√ß√µes Gerais</h2>
            </div>

            <div class="form-group">
                <label class="form-label">Link de Acesso</label>
                <input type="text" x-model="config.access_link" class="form-input" placeholder="https://..." />
            </div>

            <div class="form-group">
                <label class="form-label">Mensagem de Sucesso</label>
                <textarea x-model="config.success_message" class="form-textarea"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Mensagem Pendente</label>
                <textarea x-model="config.pending_message" class="form-textarea"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Novo Token do Bot</label>
                <input type="text" x-model="new_bot_token" class="form-input" placeholder="123456789:ABCdef..." />
                <button @click="changeBotToken()" class="btn btn-primary mt-2" :disabled="!isValidBotToken(new_bot_token)">
                    <i class="fas fa-save"></i> Atualizar Token
                </button>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="mt-6 flex flex-col items-end gap-2">
        <!-- Mensagem de feedback -->
        <div x-show="_saveMessage" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             :class="_saveMessage?.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'"
             class="px-4 py-2 rounded-lg text-sm font-semibold shadow-lg"
             x-text="_saveMessage?.text">
        </div>
        
        <button @click="console.log('üîç Bot√£o clicado!'); saveConfig(); console.log('‚úÖ saveConfig chamado');" class="btn btn-primary" :disabled="loading">
            <i class="fas fa-save" :class="loading ? 'fa-spin' : ''"></i> 
            <span x-text="loading ? 'Salvando...' : 'Salvar Configura√ß√£o'"></span>
        </button>
    </div>

    <!-- Modal de Edi√ß√£o de Step -->
    <div x-show="showStepModal && editingStep" class="modal" @click.self="closeStepModal()">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Editar Step</h3>
                <button @click="closeStepModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div x-show="editingStep" class="space-y-4">
                <div class="form-group" x-show="editingStep">
                    <label class="form-label">Tipo</label>
                    <select x-model="editingStep.type" x-show="editingStep" class="form-select">
                        <option value="message">Mensagem</option>
                        <option value="payment">Pagamento</option>
                        <option value="access">Acesso</option>
                    </select>
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type !== 'payment'">
                    <label class="form-label">Mensagem</label>
                    <textarea x-model="editingStep.config.message" x-show="editingStep && editingStep.config" class="form-textarea" placeholder="Digite a mensagem do step..."></textarea>
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type !== 'payment'">
                    <label class="form-label">URL da M√≠dia</label>
                    <div class="relative">
                        <input type="text" x-model="editingStep.config.media_url" @input="detectStepMediaType()" x-show="editingStep && editingStep.config" class="form-input pr-20" placeholder="https://..." />
                        <div x-show="editingStep && editingStep.config && editingStep.config.media_url" class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                            <span x-show="editingStep && editingStep.config && (detectedStepMediaType || editingStep.config.media_type) === 'video'" class="text-xs font-semibold px-2 py-1 rounded" style="background: rgba(59, 130, 246, 0.2); color: #93C5FD; border: 1px solid rgba(59, 130, 246, 0.4);">
                                <i class="fas fa-video mr-1"></i>V√≠deo
                            </span>
                            <span x-show="editingStep && editingStep.config && (detectedStepMediaType || editingStep.config.media_type) === 'photo'" class="text-xs font-semibold px-2 py-1 rounded" style="background: rgba(16, 185, 129, 0.2); color: #6EE7B7; border: 1px solid rgba(16, 185, 129, 0.4);">
                                <i class="fas fa-image mr-1"></i>Foto
                            </span>
                        </div>
                    </div>
                    <input type="hidden" x-model="editingStep.config.media_type" x-show="editingStep && editingStep.config" />
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-magic mr-1"></i> O tipo (foto/v√≠deo) √© detectado automaticamente pela URL ou extens√£o do arquivo
                    </p>
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type !== 'payment'">
                    <label class="form-label">URL do √Åudio</label>
                    <input type="text" x-model="editingStep.config.audio_url" x-show="editingStep && editingStep.config" class="form-input" placeholder="https://..." />
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle"></i> √Åudio complementar (opcional) - ser√° enviado ap√≥s a m√≠dia principal
                    </p>
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type === 'payment'">
                    <label class="form-label">Pre√ßo (R$)</label>
                    <input type="number" x-model.number="editingStep.config.price" x-show="editingStep && editingStep.config" class="form-input" step="0.01" min="0" />
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type === 'payment'">
                    <label class="form-label">Nome do Produto</label>
                    <input type="text" x-model="editingStep.config.product_name" x-show="editingStep && editingStep.config" class="form-input" />
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type === 'payment'">
                    <label class="form-label">Nome do Bot√£o</label>
                    <input type="text" x-model="editingStep.config.button_text" x-show="editingStep && editingStep.config" class="form-input" placeholder="Ex: Comprar Agora" />
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type === 'access'">
                    <label class="form-label">Link de Acesso</label>
                    <input type="text" x-model="editingStep.config.access_link" x-show="editingStep && editingStep.config" class="form-input" placeholder="https://..." />
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type !== 'payment'">
                    <label class="form-label">Delay (segundos)</label>
                    <input type="number" x-model.number="editingStep.delay_seconds" x-show="editingStep" class="form-input" min="0" />
                </div>

                <div class="form-group" x-show="editingStep && editingStep.type !== 'payment'">
                    <label class="form-label">T√≠tulo do Step (Opcional)</label>
                    <input type="text" x-model="editingStep.title" x-show="editingStep" class="form-input" placeholder="Deixe vazio para usar tipo padr√£o" />
                </div>



                <!-- Bot√µes Customizados -->
                <div class="border-t border-gray-700 pt-4" x-show="editingStep && editingStep.type !== 'payment'">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-white">Bot√µes Customizados</h4>
                        <button @click="addCustomButton()" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Adicionar Bot√£o
                        </button>
                    </div>

                    <template x-for="(btn, btnIndex) in (editingStep?.config?.custom_buttons || [])" :key="btnIndex">
                        <div class="border border-gray-600 rounded p-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-400">Bot√£o <span x-text="btnIndex + 1"></span></span>
                                <button @click="removeCustomButton(btnIndex)" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Texto do Bot√£o</label>
                                <input type="text" x-model="btn.text" class="form-input" />
                            </div>

                        </div>
                    </template>
                    
                    <div x-show="(!editingStep?.config?.custom_buttons || editingStep?.config?.custom_buttons?.length === 0)" class="text-center py-4 text-gray-500 text-sm">
                        <i class="fas fa-info-circle mb-2"></i>
                        <p>Nenhum bot√£o customizado adicionado. Clique em "Adicionar Bot√£o" para criar.</p>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                    <button @click="closeStepModal()" class="btn btn-secondary">Cancelar</button>
                    <button @click="saveStep()" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- ‚úÖ CR√çTICO: A fun√ß√£o botConfigApp completa j√° foi definida no extra_head -->
<!-- Apenas garantir que est√° dispon√≠vel globalmente -->
<script>
if (typeof botConfigApp !== 'undefined' && !window.botConfigAppComplete) {
    window.botConfigApp = botConfigApp;
    window.botConfigAppComplete = true;
    console.log('‚úÖ botConfigApp completo dispon√≠vel globalmente');
} else {
    // Se n√£o foi definida no extra_head, definir aqui (fallback)
    function botConfigApp() {
    return {
        bot_id: {{ bot.id }},
        loading: false,
        activeTab: 'welcome',
        config: {
            id: null,
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            welcome_audio_enabled: false,
            welcome_audio_url: '',
            main_buttons: [],
            redirect_buttons: [],
            downsells_enabled: false,
            downsells: [],
            upsells_enabled: false,
            upsells: [],
            access_link: '',
            success_message: '',
            pending_message: '',
            flow_enabled: false,
            flow_steps: [],
            flow_start_step_id: null,
            has_meta_pixel: false
        },
        new_bot_token: '',
        subscriptionGuideExpanded: false,
        subscriptionGuideTab: 'telegram',
        showStepModal: false,
        editingStep: null,
        editingStepIndex: -1,
        detectedMediaType: null,
        detectedStepMediaType: null,
        _saveMessage: null,
        _saveMessageTimeout: null,

        detectMediaType() {
            const url = this.config.welcome_media_url || '';
            if (!url) {
                this.detectedMediaType = null;
                this.config.welcome_media_type = 'video'; // Default
                return;
            }

            // Detectar por extens√£o de arquivo
            const videoExtensions = ['.mp4', '.mov', '.avi', '.mkv', '.webm', '.m4v', '.3gp', '.flv'];
            const photoExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            
            const urlLower = url.toLowerCase();
            
            // Verificar extens√µes de v√≠deo
            if (videoExtensions.some(ext => urlLower.includes(ext) || urlLower.endsWith(ext))) {
                this.detectedMediaType = 'video';
                this.config.welcome_media_type = 'video';
                return;
            }
            
            // Verificar extens√µes de foto
            if (photoExtensions.some(ext => urlLower.includes(ext) || urlLower.endsWith(ext))) {
                this.detectedMediaType = 'photo';
                this.config.welcome_media_type = 'photo';
                return;
            }
            
            // Verificar padr√µes de URL do Telegram
            if (url.includes('video') || url.includes('Video')) {
                this.detectedMediaType = 'video';
                this.config.welcome_media_type = 'video';
                return;
            }
            
            if (url.includes('photo') || url.includes('Photo') || url.includes('image')) {
                this.detectedMediaType = 'photo';
                this.config.welcome_media_type = 'photo';
                return;
            }
            
            // Para file_id do Telegram, assumir v√≠deo como padr√£o (mais comum)
            // O backend pode detectar automaticamente pelo file_id
            if (url.length > 10 && !url.startsWith('http')) {
                this.detectedMediaType = 'video'; // Default para file_id
                this.config.welcome_media_type = 'video';
                return;
            }
            
            // Para URLs sem extens√£o clara, manter o tipo atual ou usar v√≠deo como padr√£o
            if (!this.detectedMediaType) {
                this.detectedMediaType = this.config.welcome_media_type || 'video';
            }
        },

        detectStepMediaType() {
            if (!this.editingStep || !this.editingStep.config) return;
            
            const url = this.editingStep.config.media_url || '';
            if (!url) {
                this.detectedStepMediaType = null;
                this.editingStep.config.media_type = 'video'; // Default
                return;
            }

            // Detectar por extens√£o de arquivo
            const videoExtensions = ['.mp4', '.mov', '.avi', '.mkv', '.webm', '.m4v', '.3gp', '.flv'];
            const photoExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            
            const urlLower = url.toLowerCase();
            
            // Verificar extens√µes de v√≠deo
            if (videoExtensions.some(ext => urlLower.includes(ext) || urlLower.endsWith(ext))) {
                this.detectedStepMediaType = 'video';
                this.editingStep.config.media_type = 'video';
                return;
            }
            
            // Verificar extens√µes de foto
            if (photoExtensions.some(ext => urlLower.includes(ext) || urlLower.endsWith(ext))) {
                this.detectedStepMediaType = 'photo';
                this.editingStep.config.media_type = 'photo';
                return;
            }
            
            // Verificar padr√µes de URL do Telegram
            if (url.includes('video') || url.includes('Video')) {
                this.detectedStepMediaType = 'video';
                this.editingStep.config.media_type = 'video';
                return;
            }
            
            if (url.includes('photo') || url.includes('Photo') || url.includes('image')) {
                this.detectedStepMediaType = 'photo';
                this.editingStep.config.media_type = 'photo';
                return;
            }
            
            // Para file_id do Telegram, assumir v√≠deo como padr√£o (mais comum)
            if (url.length > 10 && !url.startsWith('http')) {
                this.detectedStepMediaType = 'video'; // Default para file_id
                this.editingStep.config.media_type = 'video';
                return;
            }
            
            // Para URLs sem extens√£o clara, manter o tipo atual ou usar v√≠deo como padr√£o
            if (!this.detectedStepMediaType) {
                this.detectedStepMediaType = this.editingStep.config.media_type || 'video';
            }
        },

        async init() {
            await this.loadConfig();
            this.watchFlowSteps();
        },

        async loadConfig() {
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/config`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                console.log('üì¶ Dados carregados da API:', data);
                
                if (data && typeof data === 'object') {
                    this.config.id = data.id || null;
                    this.config.welcome_message = data.welcome_message || '';
                    this.config.welcome_media_url = data.welcome_media_url || '';
                    this.config.welcome_media_type = data.welcome_media_type || 'video';
                    this.config.welcome_audio_enabled = data.welcome_audio_enabled || false;
                    this.config.welcome_audio_url = data.welcome_audio_url || '';
                    
                    // Detectar tipo de m√≠dia automaticamente ao carregar
                    if (this.config.welcome_media_url) {
                        this.detectMediaType();
                    }
                    
                    const defaultSubscription = {
                        enabled: false,
                        duration_type: 'days',
                        duration_value: null,
                        vip_chat_id: '',
                        vip_group_link: '',
                        validation_status: null
                    };
                    
                    this.config.main_buttons = (data.main_buttons || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.redirect_buttons = data.redirect_buttons || [];
                    this.config.downsells_enabled = data.downsells_enabled || false;
                    this.config.downsells = (data.downsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.upsells_enabled = data.upsells_enabled || false;
                    this.config.upsells = (data.upsells || []).map(btn => ({
                        ...btn,
                        subscription: btn.subscription && typeof btn.subscription === 'object' 
                            ? { ...defaultSubscription, ...btn.subscription }
                            : defaultSubscription
                    }));
                    
                    this.config.access_link = data.access_link || '';
                    this.config.success_message = data.success_message || '';
                    this.config.pending_message = data.pending_message || '';
                    this.config.flow_enabled = data.flow_enabled || false;
                    this.config.flow_steps = data.flow_steps || [];
                    this.config.flow_start_step_id = data.flow_start_step_id || null;
                    this.config.has_meta_pixel = data.has_meta_pixel || false;
                    
                    console.log('‚úÖ Configura√ß√£o carregada:', {
                        buttons: this.config.main_buttons?.length || 0,
                        downsells: this.config.downsells?.length || 0,
                        upsells: this.config.upsells?.length || 0
                    });

                    if (this.config.flow_enabled) {
                        this.$nextTick(() => {
                            setTimeout(() => {
                                this.initVisualFlowEditor();
                            }, 300);
                        });
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√£o:', error);
                alert('Erro ao carregar configura√ß√£o. Recarregue a p√°gina.');
            } finally {
                this.loading = false;
            }
        },

        // Debounce para saveConfig (600ms) - evita m√∫ltiplas chamadas e n√£o bloqueia UI
        _saveConfigDebounce: null,
        _saveMessage: null,
        _saveMessageTimeout: null,
        
        async saveConfig() {
            // Cancelar debounce anterior
            if (this._saveConfigDebounce) {
                clearTimeout(this._saveConfigDebounce);
            }
            
            // Debounce de 600ms (conforme recomenda√ß√£o)
            this._saveConfigDebounce = setTimeout(async () => {
                this.loading = true;
                this._saveMessage = null;
                
                // Limpar mensagem anterior
                if (this._saveMessageTimeout) {
                    clearTimeout(this._saveMessageTimeout);
                }
                
                try {
                    console.log('üíæ Salvando configura√ß√£o...', {
                        bot_id: this.bot_id,
                        has_buttons: !!this.config.main_buttons,
                        buttons_count: this.config.main_buttons?.length || 0
                    });
                    
                    const response = await fetch(`/api/bots/${this.bot_id}/config`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.config)
                    });
                    
                    console.log('üì° Resposta recebida:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
                        }
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ Dados salvos:', data);
                    
                    if (data && typeof data === 'object' && !data.error) {
                        // Atualizar config com dados retornados
                        Object.assign(this.config, data);
                        
                        // ‚úÖ MELHORIA: Mostrar feedback de sucesso
                        this._saveMessage = { type: 'success', text: '‚úÖ Configura√ß√£o salva com sucesso!' };
                        console.log('‚úÖ Configura√ß√£o salva com sucesso!');
                        
                        // Limpar mensagem ap√≥s 3 segundos
                        this._saveMessageTimeout = setTimeout(() => {
                            this._saveMessage = null;
                        }, 3000);
                    } else {
                        const errorMsg = data.error || 'Erro ao salvar configura√ß√£o';
                        this._saveMessage = { type: 'error', text: `‚ùå ${errorMsg}` };
                        console.error('‚ùå Erro ao salvar:', errorMsg);
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar configura√ß√£o:', error);
                    const errorMsg = error.message || 'Erro ao salvar configura√ß√£o';
                    this._saveMessage = { type: 'error', text: `‚ùå ${errorMsg}` };
                    alert(errorMsg);
                } finally {
                    this.loading = false;
                    this._saveConfigDebounce = null;
                }
            }, 600);
        },
        
        /**
         * Vers√£o debounced de saveConfig (chamada externamente)
         */
        saveConfigDebounced() {
            this.saveConfig();
        },

        addButton() {
            if (!this.config.main_buttons) {
                this.config.main_buttons = [];
            }
            this.config.main_buttons.push({
                text: '',
                price: null,
                description: '',
                order_bumps: [],
                subscription: {
                    enabled: false,
                    duration_type: 'days',
                    duration_value: null,
                    vip_chat_id: '',
                    vip_group_link: '',
                    validation_status: null
                }
            });
        },

        removeButton(index) {
            if (this.config.main_buttons && this.config.main_buttons[index]) {
                this.config.main_buttons.splice(index, 1);
            }
        },

        addOrderBump(buttonIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            if (!this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps = [];
            }
            this.config.main_buttons[buttonIndex].order_bumps.push({
                enabled: false,
                message: '',
                price: null,
                description: '',
                media_url: '',
                media_type: 'video',
                accept_text: 'Sim, eu quero!',
                decline_text: 'N√£o, obrigado'
            });
        },

        removeOrderBump(buttonIndex, bumpIndex) {
            if (this.config.main_buttons && 
                this.config.main_buttons[buttonIndex] && 
                this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps.splice(bumpIndex, 1);
            }
        },

        validateProductField(index, field) {
            if (!this.config.main_buttons || !this.config.main_buttons[index]) return;
            const button = this.config.main_buttons[index];
            if (field === 'text' && button.text) {
                button.text = button.text.trim().slice(0, 64);
            } else if (field === 'price' && button.price !== null) {
                button.price = Math.max(0, parseFloat(button.price) || 0);
            }
        },

        async validateSubscription(buttonIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            const button = this.config.main_buttons[buttonIndex];
            if (!button.subscription || !button.subscription.enabled) return;

            const vipChatId = button.subscription.vip_chat_id;
            if (!vipChatId) {
                button.subscription.validation_status = 'invalid';
                return;
            }

            try {
                const response = await fetch(`/api/bots/${this.bot_id}/validate-subscription`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vip_chat_id: vipChatId
                    })
                });
                const data = await response.json();
                if (data.success && data.is_valid) {
                    button.subscription.validation_status = 'valid';
                } else {
                    button.subscription.validation_status = 'invalid';
                }
            } catch (error) {
                console.error('Erro ao validar assinatura:', error);
                button.subscription.validation_status = 'invalid';
            }
        },

        setFlowStartStep(stepId) {
            this.config.flow_start_step_id = stepId;
        },

        get sortedFlowSteps() {
            if (!this.config.flow_steps) return [];
            return [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
        },

        async changeBotToken() {
            if (!this.new_bot_token || !this.isValidBotToken(this.new_bot_token)) {
                alert('Token inv√°lido');
                return;
            }
            this.loading = true;
            try {
                const response = await fetch(`/api/bots/${this.bot_id}/token`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: this.new_bot_token
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Token atualizado com sucesso!');
                    this.new_bot_token = '';
                    location.reload();
                } else {
                    alert(data.error || 'Erro ao atualizar token');
                }
            } catch (error) {
                console.error('Erro ao atualizar token:', error);
                alert('Erro ao atualizar token');
            } finally {
                this.loading = false;
            }
        },

        isValidBotToken(token) {
            return token && token.length >= 30 && token.length <= 45 && token.includes(':');
        },

        stripSurrogateChars(value) {
            return window.stripSurrogateChars ? window.stripSurrogateChars(value) : (value || '');
        },

        addDownsell() {
            if (!this.config.downsells) {
                this.config.downsells = [];
            }
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                price: null,
                pricing_mode: 'fixed',
                discount_percentage: null,
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                order_bump: {
                    enabled: false,
                    message: '',
                    price: null,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: 'Sim, eu quero!',
                    decline_text: 'N√£o, obrigado',
                    button_index: null,
                    bump_index: null
                }
            });
        },

        removeDownsell(index) {
            if (this.config.downsells && this.config.downsells[index]) {
                this.config.downsells.splice(index, 1);
            }
        },

        addUpsell() {
            if (!this.config.upsells) {
                this.config.upsells = [];
            }
            this.config.upsells.push({
                trigger_product: '',
                delay_minutes: 0,
                message: '',
                price: null,
                product_name: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                button_text: '',
                access_link: ''
            });
        },

        removeUpsell(index) {
            if (this.config.upsells && this.config.upsells[index]) {
                this.config.upsells.splice(index, 1);
            }
        },

        addRedirectButton() {
            if (!this.config.redirect_buttons) {
                this.config.redirect_buttons = [];
            }
            this.config.redirect_buttons.push({
                text: '',
                url: ''
            });
        },

        removeRedirectButton(index) {
            if (this.config.redirect_buttons && this.config.redirect_buttons[index]) {
                this.config.redirect_buttons.splice(index, 1);
            }
        },

        useOrderBumpFromButtons(downsell, buttonIndex, bumpIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) return;
            const button = this.config.main_buttons[buttonIndex];
            if (!button.order_bumps || !button.order_bumps[bumpIndex]) return;
            
            const orderBump = button.order_bumps[bumpIndex];
            
            if (!downsell.order_bump) {
                downsell.order_bump = {};
            }
            
            downsell.order_bump.enabled = true;
            downsell.order_bump.message = orderBump.message || '';
            downsell.order_bump.price = orderBump.price || null;
            downsell.order_bump.description = orderBump.description || '';
            downsell.order_bump.media_url = orderBump.media_url || '';
            downsell.order_bump.media_type = orderBump.media_type || 'video';
            downsell.order_bump.accept_text = orderBump.accept_text || 'Sim, eu quero!';
            downsell.order_bump.decline_text = orderBump.decline_text || 'N√£o, obrigado';
            downsell.order_bump.button_index = buttonIndex;
            downsell.order_bump.bump_index = bumpIndex;
        },

        onFlowToggle() {
            console.log('Flow enabled:', this.config.flow_enabled);
            
            if (this.config.flow_enabled) {
                this.$nextTick(() => {
                    setTimeout(() => {
                        this.initVisualFlowEditor();
                    }, 200);
                });
            } else {
                // Limpar Flow Editor (jsPlumb)
                if (window.flowEditor) {
                    try {
                        window.flowEditor.destroy();
                        window.flowEditor = null;
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao destruir editor antigo:', e);
                    }
                }
            }
        },

        initVisualFlowEditor() {
            if (!this.config.flow_enabled) {
                console.log('‚ÑπÔ∏è Flow desabilitado - n√£o inicializando editor');
                return;
            }
            
            this.$nextTick(() => {
                const canvas = document.getElementById('flow-visual-canvas');
                if (!canvas) {
                    console.error('‚ùå Canvas n√£o encontrado');
                    return;
                }
                
                // Verificar jsPlumb e FlowEditor
                if (typeof jsPlumb === 'undefined') {
                    console.error('‚ùå jsPlumb n√£o est√° dispon√≠vel. Aguardando carregamento...');
                    setTimeout(() => this.initVisualFlowEditor(), 500);
                    return;
                }
                
                if (typeof window.FlowEditor === 'undefined') {
                    console.error('‚ùå FlowEditor n√£o est√° dispon√≠vel. Aguardando carregamento...');
                    setTimeout(() => this.initVisualFlowEditor(), 500);
                    return;
                }
                
                // Limpar editor anterior se existir
                if (window.flowEditor) {
                    try {
                        window.flowEditor.destroy();
                        window.flowEditor = null;
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao destruir editor antigo:', e);
                    }
                }
                
                // üî• CR√çTICO: N√ÉO limpar o contentContainer! Apenas remover steps
                const contentContainer = canvas.querySelector('.flow-canvas-content');
                if (contentContainer) {
                    // Remover apenas os steps, manter o contentContainer
                    Array.from(contentContainer.children).forEach(child => {
                        if (child.classList && child.classList.contains('flow-step-block')) {
                            child.remove();
                        }
                    });
                    console.log('‚úÖ ContentContainer preservado, apenas steps removidos');
                } else {
                    // Se n√£o existe, criar (mas n√£o limpar tudo)
                    const newContent = document.createElement('div');
                    newContent.className = 'flow-canvas-content';
                    newContent.style.cssText = 'position:absolute; left:0; top:0; width:100%; height:100%; transform-origin:0 0;';
                    canvas.appendChild(newContent);
                    console.log('‚úÖ ContentContainer criado');
                }
                
                // Expor Alpine context
                window.alpineFlowEditor = this;
                
                try {
                    // üî• V8 ULTRA: Criar inst√¢ncia e aguardar inicializa√ß√£o completa (ERRO 2)
                    window.flowEditor = new window.FlowEditor('flow-visual-canvas', this);
                    
                    // Aguardar inicializa√ß√£o completa antes de usar
                    window.flowEditor.init().then(() => {
                        console.log('‚úÖ Editor jsPlumb inicializado completamente (V8)');
                    }).catch(error => {
                        console.error('‚ùå Erro ao inicializar editor jsPlumb:', error);
                        console.error('Stack:', error.stack);
                        // Tentar novamente ap√≥s 1 segundo
                        setTimeout(() => this.initVisualFlowEditor(), 1000);
                    });
                } catch (error) {
                    console.error('‚ùå Erro ao criar inst√¢ncia do FlowEditor:', error);
                    console.error('Stack:', error.stack);
                    // Tentar novamente ap√≥s 1 segundo
                    setTimeout(() => this.initVisualFlowEditor(), 1000);
                }
            });
        },
        
        openStepModal(stepId) {
            if (!this.config.flow_steps) {
                console.error('‚ùå flow_steps n√£o existe');
                return;
            }
            
            const step = this.config.flow_steps.find(s => String(s.id) === String(stepId));
            if (!step) {
                console.error(`‚ùå Step ${stepId} n√£o encontrado`);
                return;
            }
            
            // CR√çTICO: Definir editingStepIndex ANTES de fazer deep clone
            this.editingStepIndex = this.config.flow_steps.indexOf(step);
            
            if (this.editingStepIndex === -1) {
                console.error(`‚ùå Step ${stepId} n√£o encontrado no array (index = -1)`);
                return;
            }
            
            // deep clone to avoid direct mutation until save
            this.editingStep = JSON.parse(JSON.stringify(step));
            if (!this.editingStep.config) this.editingStep.config = {};
            
            // Garantir que todas as propriedades existem ANTES de abrir o modal
            if (!this.editingStep.connections) {
                this.editingStep.connections = {};
            }
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            // Garantir propriedades do config
            if (this.editingStep.config.message === undefined) {
                this.editingStep.config.message = '';
            }
            if (this.editingStep.config.media_url === undefined) {
                this.editingStep.config.media_url = '';
            }
            if (this.editingStep.config.media_type === undefined) {
                this.editingStep.config.media_type = 'video';
            }
            if (this.editingStep.config.audio_url === undefined) {
                this.editingStep.config.audio_url = '';
            }
            if (this.editingStep.config.price === undefined) {
                this.editingStep.config.price = 0;
            }
            if (this.editingStep.config.product_name === undefined) {
                this.editingStep.config.product_name = '';
            }
            if (this.editingStep.config.button_text === undefined) {
                this.editingStep.config.button_text = '';
            }
            if (this.editingStep.config.access_link === undefined) {
                this.editingStep.config.access_link = '';
            }
            if (this.editingStep.config.custom_buttons === undefined) {
                this.editingStep.config.custom_buttons = [];
            }
            if (this.editingStep.delay_seconds === undefined) {
                this.editingStep.delay_seconds = 0;
            }
            if (this.editingStep.title === undefined) {
                this.editingStep.title = '';
            }
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            if (!this.editingStep.position) {
                this.editingStep.position = { x: 100, y: 100 };
            }
            
            // Detectar tipo de m√≠dia automaticamente se houver URL
            if (this.editingStep.config && this.editingStep.config.media_url) {
                this.detectStepMediaType();
            }
            
            this.showStepModal = true;
        },
        
        closeStepModal() {
            this.showStepModal = false;
            this.editingStep = null;
            this.editingStepIndex = -1;
        },
        
        saveStep() {
            if (!this.editingStep) {
                alert('Erro: Step n√£o encontrado (editingStep √© null)');
                console.error('‚ùå saveStep: editingStep √© null', {
                    editingStep: this.editingStep,
                    editingStepIndex: this.editingStepIndex,
                    flow_steps_length: this.config.flow_steps?.length
                });
                return;
            }
            
            // Se editingStepIndex n√£o foi definido ou √© inv√°lido, tentar encontrar pelo ID
            if (this.editingStepIndex === -1 || this.editingStepIndex === undefined || this.editingStepIndex === null) {
                const stepId = this.editingStep.id;
                if (stepId) {
                    this.editingStepIndex = this.config.flow_steps.findIndex(s => String(s.id) === String(stepId));
                }
                
                if (this.editingStepIndex === -1) {
                    alert('Erro: Step n√£o encontrado (√≠ndice inv√°lido)');
                    console.error('‚ùå saveStep: editingStepIndex inv√°lido', {
                        editingStepIndex: this.editingStepIndex,
                        editingStepId: this.editingStep?.id,
                        flow_steps: this.config.flow_steps
                    });
                    return;
                }
            }
            
            if (!this.editingStep.type) {
                alert('Tipo do step √© obrigat√≥rio');
                return;
            }
            
            const existingStep = this.config.flow_steps[this.editingStepIndex];
            
            if (!existingStep) {
                alert('Erro: Step n√£o encontrado no array');
                console.error('‚ùå saveStep: existingStep √© null', {
                    editingStepIndex: this.editingStepIndex,
                    flow_steps_length: this.config.flow_steps?.length
                });
                return;
            }
            
            // Preservar conex√µes existentes (feitas visualmente no canvas)
            // N√£o sobrescrever com conex√µes do editingStep, pois elas n√£o existem mais no modal
            if (!this.editingStep.connections) {
                this.editingStep.connections = existingStep.connections || {};
            }
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            if (!this.editingStep.position) {
                this.editingStep.position = existingStep.position || { x: 100, y: 100 };
            }
            
            // Mesclar preservando conex√µes existentes do step original
            // Compatibilidade: converter steps antigos automaticamente
            const updatedStep = {
                ...existingStep,
                ...this.editingStep,
                id: existingStep.id,
                position: this.editingStep.position || existingStep.position || { x: 100, y: 100 },
                // Preservar conex√µes existentes (gerenciadas visualmente pelo jsPlumb)
                connections: existingStep.connections || {},
                config: this.editingStep.config || {},
                conditions: this.editingStep.conditions || []
            };
            
            // Compatibilidade: garantir que custom_buttons existe e est√° inicializado
            if (!updatedStep.config.custom_buttons) {
                updatedStep.config.custom_buttons = [];
            }
            
            this.config.flow_steps[this.editingStepIndex] = updatedStep;
            
            this.$nextTick(() => {
                // Atualizar step no Flow Editor (jsPlumb)
                if (window.flowEditor && window.flowEditor.updateStepEndpoints) {
                    window.flowEditor.updateStepEndpoints(existingStep.id);
                    window.flowEditor.renderAllSteps();
                }
            });
            
            this.closeStepModal();
        },
        
        addFlowStep() {
            console.log('üîµ addFlowStep() chamado');
            
            if (!this.config.flow_steps) {
                this.config.flow_steps = [];
            }
            
            if (!this.config.flow_enabled) {
                this.config.flow_enabled = true;
                console.log('‚úÖ Flow habilitado automaticamente');
                // Garantir que estamos na tab flow
                if (this.activeTab !== 'flow') {
                    this.activeTab = 'flow';
                    console.log('‚úÖ Tab Flow ativada automaticamente');
                }
            }
            
            const stepId = `step_${Date.now()}`;
            
            const existingSteps = this.config.flow_steps.length;
            const cols = Math.ceil(Math.sqrt(existingSteps + 1));
            const row = Math.floor(existingSteps / cols);
            const col = existingSteps % cols;
            
            const newStep = {
                id: stepId,
                type: 'message',
                order: existingSteps,
                config: {
                    message: '',
                    media_url: '',
                    audio_url: '',
                    media_type: 'video',
                    custom_buttons: []
                },
                connections: {},
                conditions: [],
                delay_seconds: 0,
                position: {
                    x: 100 + (col * 280),
                    y: 100 + (row * 180)
                }
            };
            
            this.config.flow_steps.push(newStep);
            console.log('‚úÖ Step adicionado ao Alpine:', stepId, 'Total:', this.config.flow_steps.length);
            
            // üî• V8 ULTRA: Garantir que o editor est√° inicializado e renderizar (ERRO 8)
            // Debounce para prevenir m√∫ltiplas chamadas
            if (this._renderDebounceTimeout) {
                clearTimeout(this._renderDebounceTimeout);
            }
            
            this._renderDebounceTimeout = setTimeout(() => {
                this.$nextTick(async () => {
                    console.log('üîµ $nextTick executado ap√≥s adicionar step (V8 debounced)');
                    
                    // Fun√ß√£o para tentar renderizar
                    const tryRender = async () => {
                        console.log('üîµ Tentando renderizar steps...', {
                            hasFlowEditor: !!window.flowEditor,
                            hasRenderAllSteps: !!(window.flowEditor && typeof window.flowEditor.renderAllSteps === 'function'),
                            flowStepsCount: this.config.flow_steps?.length || 0
                        });
                        
                        // üî• V8 ULTRA: Verificar se editor est√° inicializado antes de usar (ERRO 2)
                        if (window.flowEditor) {
                            // Aguardar inicializa√ß√£o se necess√°rio
                            if (!window.flowEditor.isInitialized()) {
                                console.log('‚è≥ Editor n√£o inicializado, aguardando...');
                                try {
                                    await window.flowEditor.waitForInitialization(5000);
                                } catch(e) {
                                    console.error('‚ùå Timeout aguardando inicializa√ß√£o:', e);
                                    return false;
                                }
                            }
                            
                            if (typeof window.flowEditor.renderAllSteps === 'function') {
                                try {
                                    window.flowEditor.renderAllSteps();
                                    console.log('‚úÖ Steps re-renderizados (jsPlumb V8)');
                                    return true;
                                } catch(e) {
                                    console.error('‚ùå Erro ao chamar renderAllSteps:', e);
                                    return false;
                                }
                            }
                        }
                        return false;
                    };
                
                // Tentar renderizar imediatamente
                tryRender().then(success => {
                    if (success) {
                        return;
                    }
                });
                
                // Se n√£o funcionou, tentar inicializar o editor
                console.log('üÜï Editor n√£o inicializado. Inicializando agora...');
                
                // Verificar se FlowEditor e jsPlumb est√£o dispon√≠veis
                if (typeof window.FlowEditor === 'undefined' || typeof jsPlumb === 'undefined') {
                    console.warn('‚ö†Ô∏è FlowEditor ou jsPlumb n√£o est√° dispon√≠vel. Aguardando carregamento...');
                    // Aguardar at√© FlowEditor e jsPlumb estarem dispon√≠veis
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (typeof window.FlowEditor !== 'undefined' && typeof jsPlumb !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('‚úÖ FlowEditor e jsPlumb carregados, inicializando editor...');
                            this.initVisualFlowEditor();
                            setTimeout(async () => {
                                const success = await tryRender();
                                if (!success) {
                                    console.warn('‚ö†Ô∏è Tentando renderizar novamente ap√≥s 1s...');
                                    setTimeout(() => tryRender(), 1000);
                                }
                            }, 500);
                        } else if (attempts > 20) {
                            clearInterval(checkInterval);
                            console.error('‚ùå FlowEditor ou jsPlumb n√£o carregou ap√≥s 4 segundos');
                        }
                    }, 200);
                } else {
                    // FlowEditor est√° dispon√≠vel, inicializar
                    console.log('‚úÖ FlowEditor dispon√≠vel, inicializando...');
                    this.initVisualFlowEditor();
                    // Aguardar um pouco e tentar renderizar
                    setTimeout(async () => {
                        const success = await tryRender();
                        if (!success) {
                            console.warn('‚ö†Ô∏è Editor inicializado mas renderAllSteps ainda n√£o est√° dispon√≠vel. Tentando novamente...');
                            setTimeout(async () => {
                                const success2 = await tryRender();
                                if (!success2) {
                                    console.error('‚ùå Falha ao renderizar ap√≥s m√∫ltiplas tentativas');
                                }
                            }, 1000);
                        }
                    }, 500);
                }
                }, 300); // üî• V8 ULTRA: Debounce de 300ms para prevenir m√∫ltiplas chamadas (ERRO 8)
        },
        
        removeFlowStep(stepId) {
            // Remover do Alpine
            if (this.config.flow_steps) {
                const index = this.config.flow_steps.findIndex(s => String(s.id) === String(stepId));
                if (index !== -1) {
                    this.config.flow_steps.splice(index, 1);
                }
            }
            
            // Remover do Flow Editor (jsPlumb)
            if (window.flowEditor && window.flowEditor.deleteStep) {
                window.flowEditor.deleteStep(stepId);
            }
        },
        
        addCondition() {
            if (!this.editingStep) return;
            if (!this.editingStep.conditions) {
                this.editingStep.conditions = [];
            }
            this.editingStep.conditions.push({
                id: `cond_${Date.now()}`,
                type: 'text_validation',
                validation: 'any',
                target_step: '',
                order: this.editingStep.conditions.length
            });
        },
        
        removeCondition(index) {
            if (!this.editingStep || !this.editingStep.conditions) return;
            this.editingStep.conditions.splice(index, 1);
        },
        
        addCustomButton() {
            if (!this.editingStep) return;
            if (!this.editingStep.config) {
                this.editingStep.config = {};
            }
            if (!this.editingStep.config.custom_buttons) {
                this.editingStep.config.custom_buttons = [];
            }
            this.editingStep.config.custom_buttons.push({
                text: '',
                target_step: ''
            });
            
            // Atualizar endpoints automaticamente ap√≥s adicionar bot√£o (conforme especifica√ß√£o)
            this.$nextTick(() => {
                if (window.flowEditor && this.editingStep) {
                    window.flowEditor.updateStepEndpoints(this.editingStep.id);
                }
            });
        },
        
        removeCustomButton(index) {
            if (!this.editingStep || !this.editingStep.config || !this.editingStep.config.custom_buttons) return;
            this.editingStep.config.custom_buttons.splice(index, 1);
            
            // Atualizar no Flow Editor (jsPlumb)
            this.$nextTick(() => {
                if (window.flowEditor && this.editingStep && window.flowEditor.updateStepEndpoints) {
                    window.flowEditor.updateStepEndpoints(this.editingStep.id);
                }
            });
        },
        
        watchFlowSteps() {
            // Watcher otimizado para Flow Editor (jsPlumb)
            this.$watch('config.flow_steps', (newSteps, oldSteps) => {
                if (window.flowEditor && newSteps) {
                    clearTimeout(this._flowStepsWatchTimeout);
                    this._flowStepsWatchTimeout = setTimeout(() => {
                        // Re-renderizar tudo no Flow Editor
                        if (window.flowEditor && window.flowEditor.renderAllSteps) {
                            window.flowEditor.renderAllSteps();
                        }
                    }, 300);
                }
            }, { deep: true });
        },
        
        getStepTypeLabel(type) {
            const labels = {
                content: 'Conte√∫do',
                message: 'Mensagem',
                audio: '√Åudio',
                video: 'V√≠deo',
                buttons: 'Bot√µes',
                payment: 'Pagamento',
                access: 'Acesso'
            };
            return labels[type] || type;
        },
        
        getStepTypeIcon(type) {
            const icons = {
                content: 'fa-file-alt',
                message: 'fa-comment',
                audio: 'fa-headphones',
                video: 'fa-video',
                buttons: 'fa-mouse-pointer',
                payment: 'fa-credit-card',
                access: 'fa-key'
            };
            return icons[type] || 'fa-circle';
        },
        
        getConditionTypeLabel(type) {
            const labels = {
                text_validation: 'Valida√ß√£o de Texto',
                button_click: 'Clique em Bot√£o',
                payment_status: 'Status de Pagamento',
                time_elapsed: 'Tempo Decorrido'
            };
            return labels[type] || type;
        },

        getAvailableStepsForConnection(currentStepId) {
            if (!this.config.flow_steps) return [];
            return this.config.flow_steps.filter(step => String(step.id) !== String(currentStepId));
        },

        getWelcomeMessageLength() {
            const baseLength = (this.config.welcome_message || '').length;
            const mediaLength = this.config.welcome_media_url ? 200 : 0;
            return baseLength + mediaLength;
        },

        validateWelcomeMessage() {
            // Valida√ß√£o j√° feita via getWelcomeMessageLength()
        }
    };
}

// ‚úÖ CR√çTICO: Substituir fun√ß√£o tempor√°ria pela vers√£o completa
window.botConfigApp = botConfigApp;
window.botConfigAppComplete = true; // Marcar como completo
console.log('‚úÖ botConfigApp definido e dispon√≠vel globalmente (vers√£o completa)');

// üî• FLOW BUILDER V‚àû - Engine Completa (100% Compat√≠vel com Backend)
function FlowBuilderV2() {
    return {
        nodes: [],
        js: null,
        modal: { open: false, node: null },
        panX: 0,
        panY: 0,
        zoomLevel: 1,
        startStepId: null, // Step inicial do fluxo

        // ------------------------------
        // INIT
        // ------------------------------
        init() {
            console.log('üöÄ FlowBuilderV2.init() chamado');
            
            // Carregar nodes do config se existirem
            if (window.botConfigApp && window.botConfigApp.config && window.botConfigApp.config.flow_steps) {
                console.log('üì¶ Carregando steps existentes do config...');
                try {
                    const flowSteps = typeof window.botConfigApp.config.flow_steps === 'string' 
                        ? JSON.parse(window.botConfigApp.config.flow_steps)
                        : window.botConfigApp.config.flow_steps;
                    
                    if (Array.isArray(flowSteps)) {
                        // Converter steps do backend para nodes do front-end
                        this.nodes = flowSteps.map((step, index) => ({
                            id: step.id || 'node-' + crypto.randomUUID(),
                            type: step.type || 'message',
                            x: step.position?.x || 300 + (index * 50),
                            y: step.position?.y || 180 + (index * 50),
                            label: step.title || step.type.toUpperCase(),
                            buttons: step.type === 'button' ? (step.config?.custom_buttons || [{ label: 'Op√ß√£o 1' }]) : [],
                            config: step.config || {},
                            connections: step.connections || {},
                            conditions: step.conditions || [],
                            delay_seconds: step.delay_seconds || 0,
                            order: step.order || (index + 1)
                        }));
                        
                        // Carregar step inicial
                        this.startStepId = window.botConfigApp.config.flow_start_step_id || this.nodes[0]?.id || null;
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao carregar steps:', e);
                }
            }

            // Inicializar jsPlumb
            if (typeof jsPlumb !== 'undefined') {
                console.log('üîß Inicializando jsPlumb...');
                jsPlumb.ready(() => {
                    console.log('‚úÖ jsPlumb pronto');
                    this.js = jsPlumb.getInstance({
                        Container: "flow-canvas",
                        Connector: ["Bezier", { curviness: 55 }],
                        EndpointStyle: { fill: "#10b981", radius: 6 },
                        PaintStyle: { stroke: "#10b981", strokeWidth: 2 },
                        HoverPaintStyle: { stroke: "#3b82f6", strokeWidth: 3 }
                    });
                    console.log('‚úÖ Inst√¢ncia jsPlumb criada');

                    // Event listeners para conex√µes
                    this.js.bind('connection', (info) => {
                        this.onConnectionCreated(info);
                    });

                    this.js.bind('connectionDetached', (info) => {
                        this.onConnectionDetached(info);
                    });

                    // Renderizar nodes existentes (usar setTimeout para garantir que DOM est√° pronto)
                    setTimeout(() => {
                        this.nodes.forEach(node => this.renderNode(node));
                        setTimeout(() => {
                            this.restoreConnections();
                        }, 100);
                    }, 100);
                });
            } else {
                console.error('‚ùå jsPlumb n√£o est√° dispon√≠vel');
            }
        },

        // ------------------------------
        // ADD NODE
        // ------------------------------
        addNode(type) {
            try {
                console.log('üîò Bot√£o clicado: addNode', type);
                
                // Validar tipo
                const validTypes = ['message', 'button', 'condition', 'payment', 'delay', 'end', 'access'];
                if (!validTypes.includes(type)) {
                    console.error('‚ùå Tipo inv√°lido:', type);
                    alert('Tipo de node inv√°lido!');
                    return;
                }
                
                const id = "node-" + Date.now() + "-" + Math.random().toString(36).substr(2, 9);

                // Configura√ß√£o inicial baseada no tipo
                let initialConfig = {};
                let initialLabel = type.charAt(0).toUpperCase() + type.slice(1);
                
                if (type === "payment") {
                    initialConfig = { price: 0, product_name: "", amount: 0 };
                    initialLabel = "Pagamento PIX";
                } else if (type === "message") {
                    initialConfig = { message: "" };
                    initialLabel = "Mensagem";
                } else if (type === "button") {
                    initialConfig = { custom_buttons: [] };
                    initialLabel = "Bot√µes";
                } else if (type === "condition") {
                    initialConfig = { conditions: [] };
                    initialLabel = "Condi√ß√£o";
                } else if (type === "delay") {
                    initialConfig = {};
                    initialLabel = "Delay";
                } else if (type === "end") {
                    initialConfig = {};
                    initialLabel = "Fim";
                } else if (type === "access") {
                    initialConfig = { link: "", message: "Acesso liberado!" };
                    initialLabel = "Link de Acesso";
                }

                const node = {
                    id,
                    type,
                    x: 300 + (this.nodes.length * 50),
                    y: 180 + (this.nodes.length * 50),
                    label: initialLabel,
                    buttons: type === "button" ? [{ label: "Op√ß√£o 1", text: "Op√ß√£o 1", target_step: "" }] : [],
                    config: initialConfig,
                    connections: {},
                    conditions: [],
                    delay_seconds: 0,
                    order: this.nodes.length + 1
                };

                this.nodes.push(node);
                
                // Se √© o primeiro node, definir como step inicial
                if (this.nodes.length === 1) {
                    this.startStepId = node.id;
                    console.log('‚≠ê Primeiro node definido como step inicial:', node.id);
                }
                
                // Renderizar node ap√≥s um pequeno delay para garantir que DOM est√° pronto
                setTimeout(() => {
                    this.renderNode(node);
                    console.log('‚úÖ Node renderizado:', node.id);
                }, 100);
                
                console.log('‚úÖ Node adicionado com sucesso:', { id: node.id, type: node.type, total: this.nodes.length });
            } catch (e) {
                console.error('‚ùå Erro ao adicionar node:', e);
                alert('Erro ao adicionar node: ' + e.message);
            }
        },

        // ------------------------------
        // RENDER NODE
        // ------------------------------
        renderNode(node) {
            try {
                const canvas = document.getElementById("flow-canvas");
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Canvas n√£o encontrado');
                    return;
                }

                // Remove se j√° existe (evita duplica√ß√µes)
                const old = document.getElementById(node.id);
                if (old) old.remove();

                const div = document.createElement("div");
                div.className = "flow-node";
                div.id = node.id;
                div.style.left = node.x + "px";
                div.style.top = node.y + "px";
                div.style.position = "absolute";
                
                // Marcar step inicial visualmente
                if (node.id === this.startStepId) {
                    div.classList.add('flow-node-start');
                }

                div.innerHTML = `
                    <div class="node-header">
                        <span>${this.escapeHtml(node.label)}</span>
                        <button onclick="window.__editNode('${node.id}')" style="background:transparent;border:none;cursor:pointer;color:#ccc;padding:4px 8px;">‚öô</button>
                        ${node.id === this.startStepId ? '<span style="color:#10b981;font-size:10px;margin-left:8px;">START</span>' : ''}
                    </div>
                    <div class="endpoint endpoint-in" id="${node.id}-in"></div>
                    <div class="node-content">${this.renderContent(node)}</div>
                    ${node.type !== 'end' ? `<div class="endpoint endpoint-out" id="${node.id}-out"></div>` : ''}
                `;

                canvas.appendChild(div);

                // Montar endpoints e habilitar drag ap√≥s um pequeno delay
                setTimeout(() => {
                    this.mountEndpoints(node);
                    this.enableDrag(node);
                }, 50);
            } catch (e) {
                console.error('‚ùå Erro ao renderizar node:', e, node);
            }
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        renderContent(node) {
            if (node.type === 'message') {
                const msg = node.config?.message || '';
                return `<div style="font-size:12px;opacity:0.8">${msg.substring(0, 30) || 'Mensagem de texto'}${msg.length > 30 ? '...' : ''}</div>`;
            }
            if (node.type === 'button') {
                return node.buttons.map((btn, i) => 
                    `<div class="node-button" id="${node.id}-btn-${i}">${btn.label || btn.text || 'Bot√£o'}</div>`
                ).join('');
            }
            if (node.type === 'condition') {
                return `
                    <div class="cond-branch">Verdadeiro</div>
                    <div class="cond-branch">Falso</div>
                `;
            }
            if (node.type === 'payment') {
                const price = node.config?.price || node.config?.amount || 0;
                return `<div style="font-size:12px">Cobran√ßa - R$ ${price.toFixed(2)}</div>`;
            }
            if (node.type === 'delay') {
                const delay = node.delay_seconds || 0;
                return `<div style="font-size:12px">Aguardar ${delay}s</div>`;
            }
            if (node.type === 'access') {
                return '<div style="font-size:12px">Link de Acesso</div>';
            }
            if (node.type === 'end') {
                return '<div style="text-align:center;font-size:11px;opacity:0.8">FIM</div>';
            }
            return '';
        },

        // ------------------------------
        // ENDPOINTS (ANTI-DUPLICA√á√ÉO)
        // ------------------------------
        mountEndpoints(node) {
            if (!this.js) return;
            
            // üî• CR√çTICO: Remover endpoints antigos ANTES de criar novos
            this.js.deleteEndpoints(node.id);
            
            const el = document.getElementById(node.id);
            if (!el) return;

            // Input
            this.js.addEndpoint(node.id, {
                uuid: node.id + "-in",
                anchor: "Left",
                isTarget: true,
                maxConnections: -1
            });

            // Output (exceto para 'end')
            if (node.type !== 'end') {
                this.js.addEndpoint(node.id, {
                    uuid: node.id + "-out",
                    anchor: "Right",
                    isSource: true,
                    maxConnections: -1
                });
            }
        },

        // ------------------------------
        // CONNECTION HANDLERS
        // ------------------------------
        onConnectionCreated(info) {
            const sourceId = info.sourceId || info.source.id;
            const targetId = info.targetId || info.target.id;
            
            // Extrair IDs dos nodes (remover sufixos -in, -out)
            const sourceNodeId = sourceId.replace(/-in$|-out$|-btn-\d+$/, '');
            const targetNodeId = targetId.replace(/-in$|-out$|-btn-\d+$/, '');
            
            const sourceNode = this.nodes.find(n => n.id === sourceNodeId);
            if (!sourceNode) return;
            
            // üî• CR√çTICO: Mapear conex√£o jsPlumb para formato backend
            if (!sourceNode.connections) {
                sourceNode.connections = {};
            }
            
            // Se √© payment step, pode ter conex√£o 'pending'
            if (sourceNode.type === 'payment' && !sourceNode.connections.next) {
                sourceNode.connections.next = targetNodeId;
            } else if (sourceNode.type === 'payment' && sourceNode.connections.next && !sourceNode.connections.pending) {
                sourceNode.connections.pending = targetNodeId;
            } else {
                // Conex√£o normal (next)
                sourceNode.connections.next = targetNodeId;
            }
            
            console.log(`‚úÖ Conex√£o criada: ${sourceNodeId} ‚Üí ${targetNodeId}`, sourceNode.connections);
        },

        onConnectionDetached(info) {
            const sourceId = info.sourceId || info.source.id;
            const sourceNodeId = sourceId.replace(/-in$|-out$|-btn-\d+$/, '');
            
            const sourceNode = this.nodes.find(n => n.id === sourceNodeId);
            if (sourceNode && sourceNode.connections) {
                // Remover conex√£o
                if (sourceNode.connections.next) {
                    delete sourceNode.connections.next;
                }
                if (sourceNode.connections.pending) {
                    delete sourceNode.connections.pending;
                }
            }
        },

        restoreConnections() {
            if (!this.js) return;
            
            this.nodes.forEach(node => {
                if (!node.connections) return;
                
                // Restaurar conex√£o 'next'
                if (node.connections.next) {
                    const targetNode = document.getElementById(node.connections.next);
                    if (targetNode) {
                        try {
                            this.js.connect({
                                source: node.id,
                                target: node.connections.next,
                                anchors: ["Right", "Left"]
                            });
                        } catch (e) {
                            console.warn(`‚ö†Ô∏è Erro ao restaurar conex√£o: ${e}`);
                        }
                    }
                }
                
                // Restaurar conex√£o 'pending' (apenas para payment)
                if (node.type === 'payment' && node.connections.pending) {
                    const targetNode = document.getElementById(node.connections.pending);
                    if (targetNode) {
                        try {
                            this.js.connect({
                                source: node.id,
                                target: node.connections.pending,
                                anchors: ["Right", "Left"]
                            });
                        } catch (e) {
                            console.warn(`‚ö†Ô∏è Erro ao restaurar conex√£o pending: ${e}`);
                        }
                    }
                }
            });
            
            this.js.repaintEverything();
        },

        // ------------------------------
        // DRAG
        // ------------------------------
        enableDrag(node) {
            if (!this.js) return;
            
            this.js.draggable(node.id, {
                stop: (params) => {
                    const n = this.nodes.find(x => x.id === node.id);
                    if (n) {
                        n.x = params.pos[0];
                        n.y = params.pos[1];
                    }
                    // Redesenhar conex√µes ap√≥s mover
                    this.js.repaintEverything();
                }
            });
        },

        // ------------------------------
        // MODAL
        // ------------------------------
        openEdit(id) {
            try {
                const node = this.nodes.find(n => n.id === id);
                if (node) {
                    // Criar c√≥pia profunda do node
                    this.modal.node = JSON.parse(JSON.stringify(node));
                    
                    // Garantir que config existe
                    if (!this.modal.node.config) {
                        this.modal.node.config = {};
                    }
                    
                    // Garantir que buttons existe para tipo button
                    if (this.modal.node.type === 'button' && !this.modal.node.buttons) {
                        this.modal.node.buttons = [];
                    }
                    
                    this.modal.open = true;
                    console.log('‚úÖ Modal aberto para edi√ß√£o:', this.modal.node);
                } else {
                    console.warn('‚ö†Ô∏è Node n√£o encontrado:', id);
                }
            } catch (e) {
                console.error('‚ùå Erro ao abrir modal:', e);
            }
        },

        closeModal() {
            this.modal.open = false;
            this.modal.node = null;
        },

        applyEdit() {
            try {
                if (!this.modal.node || !this.modal.node.id) {
                    alert('‚ùå Erro: Node inv√°lido');
                    return;
                }
                
                const n = this.nodes.find(x => x.id === this.modal.node.id);
                if (n) {
                    // Atualizar node com dados do modal
                    Object.assign(n, {
                        label: this.modal.node.label,
                        config: this.modal.node.config || {},
                        buttons: this.modal.node.buttons || [],
                        delay_seconds: this.modal.node.delay_seconds || 0
                    });
                    
                    this.closeModal();
                    
                    // Re-renderizar node ap√≥s um pequeno delay
                    setTimeout(() => {
                        this.renderNode(n);
                    }, 50);
                    
                    console.log('‚úÖ Node atualizado:', n);
                } else {
                    alert('‚ùå Node n√£o encontrado');
                }
            } catch (e) {
                console.error('‚ùå Erro ao aplicar edi√ß√£o:', e);
                alert('‚ùå Erro ao salvar edi√ß√£o. Verifique o console.');
            }
        },

        addButton() {
            if (this.modal.node && !this.modal.node.buttons) {
                this.modal.node.buttons = [];
            }
            if (this.modal.node) {
                this.modal.node.buttons.push({ label: "Novo bot√£o", text: "Novo bot√£o" });
            }
        },

        removeButton(index) {
            if (this.modal.node && this.modal.node.buttons) {
                this.modal.node.buttons.splice(index, 1);
            }
        },

        setAsStartStep() {
            if (this.modal.node) {
                this.startStepId = this.modal.node.id;
                this.closeModal();
                // Re-renderizar todos os nodes para atualizar visual
                setTimeout(() => {
                    this.nodes.forEach(n => this.renderNode(n));
                }, 50);
            }
        },

        deleteNode() {
            if (!this.modal.node || !confirm(`Tem certeza que deseja deletar o node "${this.modal.node.label}"?`)) {
                return;
            }
            
            try {
                const nodeId = this.modal.node.id;
                
                // Remover conex√µes do jsPlumb
                if (this.js) {
                    this.js.deleteEveryConnection(nodeId);
                    this.js.deleteEndpoints(nodeId);
                }
                
                // Remover node do array
                this.nodes = this.nodes.filter(n => n.id !== nodeId);
                
                // Remover do DOM
                const nodeEl = document.getElementById(nodeId);
                if (nodeEl) {
                    nodeEl.remove();
                }
                
                // Se era o step inicial, definir outro
                if (this.startStepId === nodeId) {
                    this.startStepId = this.nodes[0]?.id || null;
                }
                
                // Remover conex√µes que apontam para este node
                this.nodes.forEach(node => {
                    if (node.connections) {
                        if (node.connections.next === nodeId) {
                            delete node.connections.next;
                        }
                        if (node.connections.pending === nodeId) {
                            delete node.connections.pending;
                        }
                        if (node.connections.retry === nodeId) {
                            delete node.connections.retry;
                        }
                    }
                });
                
                this.closeModal();
                
                // Re-renderizar todos os nodes
                setTimeout(() => {
                    this.nodes.forEach(n => this.renderNode(n));
                    if (this.js) {
                        this.js.repaintEverything();
                    }
                }, 50);
                
                console.log('‚úÖ Node deletado:', nodeId);
            } catch (e) {
                console.error('‚ùå Erro ao deletar node:', e);
                alert('‚ùå Erro ao deletar node. Verifique o console.');
            }
        },

        // ------------------------------
        // SAVE / IMPORT / EXPORT
        // ------------------------------
        saveFlow() {
            try {
                console.log('üíæ Bot√£o Salvar clicado');
                
                if (this.nodes.length === 0) {
                    alert('‚ö†Ô∏è Adicione pelo menos um node antes de salvar!');
                    return;
                }
                
                console.log('üìä Nodes para salvar:', this.nodes.length);

                // üî• CR√çTICO: Converter nodes para formato EXATO do backend
                const steps = this.nodes.map((node, index) => {
                    const step = {
                        id: node.id,
                        type: node.type,
                        order: node.order || (index + 1),
                        position: { x: node.x, y: node.y },
                        title: node.label || node.type.toUpperCase(),
                        config: node.config || {},
                        connections: node.connections || {},
                        conditions: node.conditions || [],
                        delay_seconds: node.delay_seconds || 0
                    };
                    
                    // üî• CR√çTICO: Garantir que custom_buttons tem formato correto
                    if (node.type === 'button' && node.buttons) {
                        step.config.custom_buttons = node.buttons.map(btn => ({
                            text: btn.label || btn.text || '',
                            target_step: btn.target_step || ''
                        }));
                    }
                    
                    return step;
                });

                // üî• VALIDA√á√ÉO: Verificar estrutura antes de salvar
                const validation = this.validateFlow(steps);
                if (!validation.valid) {
                    alert(`‚ùå Erro de valida√ß√£o:\n${validation.errors.join('\n')}`);
                    return;
                }

                // Salvar via botConfigApp
                if (window.botConfigApp && typeof window.botConfigApp.saveConfig === 'function') {
                    // Atualizar config
                    window.botConfigApp.config.flow_steps = JSON.stringify(steps);
                    window.botConfigApp.config.flow_start_step_id = this.startStepId;
                    window.botConfigApp.config.flow_enabled = true;
                    
                    // Salvar
                    window.botConfigApp.saveConfig();
                    
                    console.log('‚úÖ Fluxo salvo via botConfigApp:', {
                        steps_count: steps.length,
                        start_step_id: this.startStepId,
                        steps: steps
                    });
                    
                    alert('‚úÖ Fluxo salvo com sucesso!');
                } else {
                    // Fallback: chamada direta ao backend
                    const botId = window.botConfigApp?.bot_id || window.botId || document.querySelector('[data-bot-id]')?.dataset.botId || '';
                    
                    if (!botId) {
                        alert('‚ùå ID do bot n√£o encontrado. Tente recarregar a p√°gina.');
                        return;
                    }
                    
                    fetch(`/api/bots/${botId}/config`, {
                        method: "PUT",
                        headers: { 
                            "Content-Type": "application/json",
                            "X-CSRFToken": document.querySelector('[name=csrf_token]')?.value || ''
                        },
                        body: JSON.stringify({ 
                            flow_steps: steps,
                            flow_start_step_id: this.startStepId,
                            flow_enabled: true
                        })
                    }).then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    }).then(data => {
                        console.log('‚úÖ Fluxo salvo:', data);
                        alert('‚úÖ Fluxo salvo com sucesso!');
                    }).catch(e => {
                        console.error('‚ùå Erro ao salvar fluxo:', e);
                        alert('‚ùå Erro ao salvar fluxo. Verifique o console.');
                    });
                }
            } catch (e) {
                console.error('‚ùå Erro ao salvar fluxo:', e);
                alert('‚ùå Erro ao salvar fluxo. Verifique o console.');
            }
        },

        validateFlow(steps) {
            const errors = [];
            const stepIds = new Set();
            
            steps.forEach((step, index) => {
                // Validar campos obrigat√≥rios
                if (!step.id || !step.type) {
                    errors.push(`Step ${index}: deve ter 'id' e 'type'`);
                }
                
                // Validar IDs √∫nicos
                if (stepIds.has(step.id)) {
                    errors.push(`Step ${index}: ID duplicado '${step.id}'`);
                }
                stepIds.add(step.id);
                
                // Validar payment steps t√™m conex√µes
                if (step.type === 'payment') {
                    const conn = step.connections || {};
                    if (!conn.next && !conn.pending) {
                        errors.push(`Step ${step.id} (payment): deve ter conex√£o 'next' ou 'pending'`);
                    }
                }
                
                // Validar connections apontam para steps existentes
                if (step.connections) {
                    ['next', 'pending', 'retry'].forEach(connType => {
                        const targetId = step.connections[connType];
                        if (targetId && !stepIds.has(targetId)) {
                            // Aviso, n√£o erro (step pode ser criado depois)
                            console.warn(`‚ö†Ô∏è Step ${step.id}: conex√£o '${connType}' aponta para step inexistente: ${targetId}`);
                        }
                    });
                }
            });
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        },

        exportFlow() {
            try {
                console.log('‚¨Ü Bot√£o Exportar clicado');
                
                if (this.nodes.length === 0) {
                    alert('‚ö†Ô∏è N√£o h√° nodes para exportar!');
                    return;
                }
                
                console.log('üìä Nodes para exportar:', this.nodes.length);
                
                const steps = this.nodes.map((node, index) => ({
                    id: node.id,
                    type: node.type,
                    order: node.order || (index + 1),
                    position: { x: node.x, y: node.y },
                    title: node.label,
                    config: node.config || {},
                    connections: node.connections || {},
                    conditions: node.conditions || [],
                    delay_seconds: node.delay_seconds || 0
                }));
                
                const data = {
                    flow_enabled: true,
                    flow_start_step_id: this.startStepId,
                    flow_steps: steps
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `flow_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Fluxo exportado:', data);
                alert('‚úÖ Fluxo exportado com sucesso!');
            } catch (e) {
                console.error('‚ùå Erro ao exportar fluxo:', e);
                alert('‚ùå Erro ao exportar fluxo. Verifique o console.');
            }
        },

        clearFlow() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar todo o fluxo? Esta a√ß√£o n√£o pode ser desfeita!')) {
                return;
            }
            
            try {
                // Limpar jsPlumb
                if (this.js) {
                    this.js.deleteEveryConnection();
                    this.js.deleteEveryEndpoint();
                }
                
                // Limpar nodes
                this.nodes.forEach(node => {
                    const nodeEl = document.getElementById(node.id);
                    if (nodeEl) {
                        nodeEl.remove();
                    }
                });
                
                this.nodes = [];
                this.startStepId = null;
                
                console.log('‚úÖ Fluxo limpo');
                alert('‚úÖ Fluxo limpo com sucesso!');
            } catch (e) {
                console.error('‚ùå Erro ao limpar fluxo:', e);
                alert('‚ùå Erro ao limpar fluxo. Verifique o console.');
            }
        },

        importFlow(e) {
            try {
                console.log('‚¨á Bot√£o Importar - arquivo selecionado');
                
                const file = e.target.files[0];
                if (!file) {
                    console.warn('‚ö†Ô∏è Nenhum arquivo selecionado');
                    return;
                }
                
                console.log('üìÅ Arquivo selecionado:', file.name, file.size, 'bytes');
                
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        
                        if (data.flow_steps && Array.isArray(data.flow_steps)) {
                            // Limpar nodes existentes
                            if (this.js) {
                                this.js.deleteEveryEndpoint();
                                this.js.deleteEveryConnection();
                            }
                            
                            // Converter steps para nodes
                            this.nodes = data.flow_steps.map(step => ({
                                id: step.id,
                                type: step.type,
                                x: step.position?.x || 300,
                                y: step.position?.y || 180,
                                label: step.title || step.type.toUpperCase(),
                                buttons: step.type === 'button' ? (step.config?.custom_buttons || []) : [],
                                config: step.config || {},
                                connections: step.connections || {},
                                conditions: step.conditions || [],
                                delay_seconds: step.delay_seconds || 0,
                                order: step.order || 1
                            }));
                            
                            this.startStepId = data.flow_start_step_id || this.nodes[0]?.id || null;
                            
                            // Renderizar nodes ap√≥s um delay
                            setTimeout(() => {
                                this.nodes.forEach(n => this.renderNode(n));
                                setTimeout(() => {
                                    this.restoreConnections();
                                }, 200);
                            }, 100);
                            
                            alert('‚úÖ Fluxo importado com sucesso!');
                        } else {
                            alert('‚ùå Formato de arquivo inv√°lido. O arquivo deve conter flow_steps.');
                        }
                    } catch (e) {
                        console.error('‚ùå Erro ao importar fluxo:', e);
                        alert('‚ùå Erro ao importar fluxo. Verifique o formato do arquivo.');
                    }
                };
                reader.readAsText(file);
            } catch (e) {
                console.error('‚ùå Erro ao processar arquivo:', e);
                alert('‚ùå Erro ao processar arquivo.');
            }
        },

        // ------------------------------
        // PAN & ZOOM
        // ------------------------------
        startPan(e) {
            if (e.target.closest(".flow-node")) return;

            const startX = e.clientX;
            const startY = e.clientY;
            const initX = this.panX;
            const initY = this.panY;

            const move = ev => {
                this.panX = initX + (ev.clientX - startX);
                this.panY = initY + (ev.clientY - startY);
                const canvas = document.getElementById("flow-canvas");
                if (canvas) {
                    canvas.style.transform = `translate(${this.panX}px,${this.panY}px) scale(${this.zoomLevel})`;
                }
            };

            const stop = () => {
                window.removeEventListener("mousemove", move);
                window.removeEventListener("mouseup", stop);
            };

            window.addEventListener("mousemove", move);
            window.addEventListener("mouseup", stop);
        },

        zoom(e) {
            this.zoomLevel += e.deltaY > 0 ? -0.05 : 0.05;
            this.zoomLevel = Math.max(0.3, Math.min(1.5, this.zoomLevel));
            const canvas = document.getElementById("flow-canvas");
            if (canvas) {
                canvas.style.transform = `translate(${this.panX}px,${this.panY}px) scale(${this.zoomLevel})`;
            }
            if (this.js) {
                this.js.repaintEverything();
            }
        }
    };
}

// Permite edi√ß√£o externa
window.__editNode = function(id) {
    try {
        const root = document.querySelector("#flow-builder");
        if (root && root.__x && root.__x.$data) {
            root.__x.$data.openEdit(id);
        } else {
            console.warn('‚ö†Ô∏è FlowBuilderV2 n√£o encontrado ou n√£o inicializado');
        }
    } catch (e) {
        console.error('‚ùå Erro ao abrir edi√ß√£o:', e);
    }
};
</script>

<!-- Flow Editor JS (jsPlumb) -->
<!-- jsPlumb 2.15.6 -->
<script src="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
<!-- Flow Editor (jsPlumb) -->
<script src="{{ url_for('static', filename='js/flow_editor.js') }}?v=4.0.0"></script>
<script>
// Debug: Verificar se FlowEditor foi carregado
setTimeout(function() {
    console.log('üîç Verificando jsPlumb:', typeof jsPlumb);
    console.log('üîç Verificando FlowEditor:', typeof window.FlowEditor);
}, 1000);
</script>
{% endblock %}
