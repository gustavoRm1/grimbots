{% extends "base.html" %}

{% block title %}Configurar Bot - {{ bot.name }}{% endblock %}

{% block content %}
<!-- v2.2 - Order Bump com botões personalizáveis - Cache Fix -->
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="botConfigApp()" x-init="init()">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center">
            <a href="{{ url_for('dashboard') }}" class="text-textSecondary hover:text-accent500 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold text-textPrimary">{{ bot.name }}</h1>
                <p class="mt-1 text-sm text-textSecondary">@{{ bot.username }}</p>
            </div>
            <div class="ml-auto">
                <button @click="saveConfig()" 
                        :disabled="loading"
                        :class="{'opacity-50 cursor-not-allowed': loading}"
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-semibold text-black bg-gradient-to-r from-accent500 to-accent600 hover:shadow-accent-glow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent500 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-save mr-2"></i>
                    <span x-show="!loading">Salvar Configurações</span>
                    <span x-show="loading">Salvando...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="card !p-0 border border-white border-opacity-10">
        <div class="border-b border-white border-opacity-5">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'welcome'" 
                        :class="activeTab === 'welcome' ? 'tab-button active' : 'tab-button'"
                        class="whitespace-nowrap py-4 px-1 font-medium text-sm">
                    <i class="fas fa-home mr-2"></i>Boas-vindas
                </button>
                <button @click="activeTab = 'buttons'" 
                        :class="activeTab === 'buttons' ? 'tab-button active' : 'tab-button'"
                        class="whitespace-nowrap py-4 px-1 font-medium text-sm">
                    <i class="fas fa-hand-pointer mr-2"></i>Botões
                </button>
                <button @click="activeTab = 'downsells'" 
                        :class="activeTab === 'downsells' ? 'tab-button active' : 'tab-button'"
                        class="whitespace-nowrap py-4 px-1 font-medium text-sm">
                    <i class="fas fa-arrow-down mr-2"></i>Downsells
                </button>
                <button @click="activeTab = 'access'" 
                        :class="activeTab === 'access' ? 'tab-button active' : 'tab-button'"
                        class="whitespace-nowrap py-4 px-1 font-medium text-sm">
                    <i class="fas fa-link mr-2"></i>Acesso
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Welcome Tab - Redesenhado -->
            <div x-show="activeTab === 'welcome'" x-cloak>
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-textPrimary flex items-center">
                        <i class="fas fa-home text-accent500 mr-3"></i>
                        Mensagem de Boas-vindas
                    </h3>
                    <p class="text-sm text-textSecondary mt-2">Configure a primeira impressão que seus clientes terão ao iniciar o bot</p>
                </div>

                <!-- Info Helper -->
                <div class="mb-6 p-4 bg-info-500 bg-opacity-8 border-l-4 border-info-500 rounded-r-xl">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-lightbulb text-info-500 text-lg"></i>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-info-500 mb-1">Primeira Impressão</h4>
                            <p class="text-sm text-textPrimary leading-relaxed">
                                Esta mensagem será enviada quando o usuário clicar em <code class="px-2 py-1 bg-bg900 rounded text-accent400 font-mono text-xs">/start</code>. Use para dar as boas-vindas e apresentar seus produtos.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Mensagem -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-textSecondary flex items-center">
                            <i class="fas fa-comment-dots text-accent500 mr-2"></i>
                            Mensagem
                            <span class="text-danger-500 ml-1">*</span>
                        </label>
                        <textarea x-model="config.welcome_message" 
                                  rows="5" 
                                  class="w-full px-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-xl text-textPrimary placeholder-muted focus:outline-none focus:border-accent500 focus:ring-2 focus:ring-accent500 focus:ring-opacity-20 hover:border-opacity-15 transition-all resize-none"
                                  placeholder="Olá! Bem-vindo ao nosso bot de vendas..."></textarea>
                        <div class="flex items-start gap-2 p-3 bg-accent500 bg-opacity-8 rounded-lg border border-accent500 border-opacity-20">
                            <i class="fas fa-code text-accent500 mt-0.5"></i>
                            <p class="text-xs text-textSecondary">
                                <strong class="text-accent500">Tags HTML:</strong>
                                <code class="ml-2 px-1.5 py-0.5 bg-bg900 rounded text-accent400 font-mono text-xs">&lt;b&gt;negrito&lt;/b&gt;</code>
                                <code class="ml-1 px-1.5 py-0.5 bg-bg900 rounded text-accent400 font-mono text-xs">&lt;i&gt;itálico&lt;/i&gt;</code>
                            </p>
                        </div>
                    </div>

                    <!-- URL da Mídia -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-textSecondary flex items-center">
                            <i class="fas fa-link text-purple-500 mr-2"></i>
                            URL da Mídia
                            <span class="text-muted ml-2 text-xs font-normal">(Telegram)</span>
                        </label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-external-link-alt text-muted group-hover:text-textSecondary transition-colors"></i>
                            </div>
                            <input type="url" 
                                   x-model="config.welcome_media_url" 
                                   class="w-full pl-11 pr-4 py-3 bg-bg900 border border-white border-opacity-10 rounded-xl text-textPrimary placeholder-muted focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:ring-opacity-20 hover:border-opacity-15 transition-all"
                                   placeholder="https://t.me/canal/123">
                        </div>
                        <p class="text-xs text-muted ml-1">
                            Link de vídeo ou foto do seu canal (ex: https://t.me/alemaomidias/602)
                        </p>
                    </div>

                    <!-- Tipo de Mídia -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-textSecondary flex items-center">
                            <i class="fas fa-image text-purple-500 mr-2"></i>
                            Tipo de Mídia
                        </label>
                        <div class="flex gap-3">
                            <label class="flex items-center px-5 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg cursor-pointer hover:border-opacity-20 transition-all"
                                   :class="{'border-purple-500 border-opacity-40 bg-purple-500 bg-opacity-8': config.welcome_media_type === 'video'}">
                                <input type="radio" x-model="config.welcome_media_type" value="video"
                                       class="form-radio text-purple-500 h-4 w-4">
                                <i class="fas fa-video text-purple-500 ml-2 mr-1.5"></i>
                                <span class="ml-1 text-sm text-textPrimary font-medium">Vídeo</span>
                            </label>
                            <label class="flex items-center px-5 py-3 bg-bg900 border border-white border-opacity-10 rounded-lg cursor-pointer hover:border-opacity-20 transition-all"
                                   :class="{'border-purple-500 border-opacity-40 bg-purple-500 bg-opacity-8': config.welcome_media_type === 'photo'}">
                                <input type="radio" x-model="config.welcome_media_type" value="photo"
                                       class="form-radio text-purple-500 h-4 w-4">
                                <i class="fas fa-camera text-purple-500 ml-2 mr-1.5"></i>
                                <span class="ml-1 text-sm text-textPrimary font-medium">Foto</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons Tab - Redesenhado -->
            <div x-show="activeTab === 'buttons'" x-cloak>
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-textPrimary flex items-center">
                            <i class="fas fa-shopping-bag text-success-500 mr-3"></i>
                            Botões de Venda
                        </h3>
                        <p class="text-sm text-textSecondary mt-2">Adicione botões com valores para gerar PIX automaticamente</p>
                    </div>
                    <button @click="addButton()" 
                            class="inline-flex items-center px-4 py-2.5 border border-transparent rounded-xl text-sm font-semibold text-black bg-gradient-to-r from-success-500 to-green-700 hover:shadow-lg transition-all transform hover:-translate-y-0.5"
                            style="box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);">
                        <i class="fas fa-plus-circle mr-2"></i>
                        Adicionar Botão
                    </button>
                </div>

                <div class="space-y-6" x-show="config.main_buttons && config.main_buttons.length > 0">
                    <template x-for="(button, index) in config.main_buttons" :key="index">
                        <div class="bg-surface800 border border-white border-opacity-10 rounded-2xl p-6 hover:border-opacity-15 transition-all" 
                             x-init="if (!button.order_bump) { button.order_bump = { enabled: false, message: '', media_url: '', media_type: 'video', price: 0, description: '', accept_text: '', decline_text: '' }; }">
                            
                            <!-- Header do Card -->
                            <div class="flex justify-between items-center mb-5 pb-4 border-b border-white border-opacity-10">
                                <div class="flex items-center">
                                    <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-success-500 bg-opacity-15 border border-success-500 border-opacity-25">
                                        <span class="text-lg font-bold text-success-500" x-text="index + 1"></span>
                                    </div>
                                    <h4 class="ml-3 text-base font-bold text-textPrimary">
                                        Botão <span x-text="index + 1"></span>
                                    </h4>
                                </div>
                                <button @click="removeButton(index)" 
                                        class="flex items-center justify-center h-10 w-10 border-2 border-danger-500 border-opacity-30 text-danger-500 rounded-lg hover:bg-danger-500 hover:bg-opacity-15 hover:border-opacity-50 transition-all">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Campos do Botão -->
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 mb-5">
                                <div class="space-y-2">
                                    <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                        <i class="fas fa-font text-info-500 mr-1.5"></i>
                                        Texto do Botão
                                    </label>
                                    <input type="text" 
                                           x-model="button.text" 
                                           class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-info-500 focus:ring-1 focus:ring-info-500 focus:ring-opacity-20 transition-all text-sm"
                                           placeholder="Comprar por R$ 19,97">
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                        <i class="fas fa-dollar-sign text-success-500 mr-1.5"></i>
                                        Preço (R$)
                                    </label>
                                    <input type="number" 
                                           x-model="button.price" 
                                           step="0.01"
                                           class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-success-500 focus:ring-1 focus:ring-success-500 focus:ring-opacity-20 transition-all text-sm text-center font-mono"
                                           placeholder="19.97">
                                </div>
                                <div class="sm:col-span-2 space-y-2">
                                    <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                        <i class="fas fa-tag text-accent500 mr-1.5"></i>
                                        Descrição do Produto
                                    </label>
                                    <input type="text" 
                                           x-model="button.description" 
                                           class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-accent500 focus:ring-1 focus:ring-accent500 focus:ring-opacity-20 transition-all text-sm"
                                           placeholder="Curso Completo de...">
                                </div>
                            </div>
                            
                            <!-- Order Bump ESPECÍFICO deste botão - Redesenhado -->
                            <div class="mt-5 border-2 border-accent500 border-opacity-25 rounded-2xl p-5 bg-accent500 bg-opacity-8"
                                 style="box-shadow: 0 4px 12px rgba(255,186,8,0.1);">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" 
                                               x-model="button.order_bump.enabled" 
                                               :id="'order_bump_' + index"
                                               class="h-5 w-5 rounded border-accent500 border-opacity-30 bg-bg900 text-accent500 focus:ring-accent500 focus:ring-opacity-20">
                                        <label :for="'order_bump_' + index" class="ml-3 flex items-center text-base font-bold text-textPrimary cursor-pointer">
                                            <i class="fas fa-gift text-accent500 mr-2"></i>
                                            Order Bump Personalizado
                                        </label>
                                    </div>
                                    <span x-show="button.order_bump.enabled" 
                                          class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-bold bg-success-500 bg-opacity-20 text-success-500 border border-success-500 border-opacity-40">
                                        <i class="fas fa-check-circle mr-1.5"></i> ATIVO
                                    </span>
                                    <span x-show="!button.order_bump.enabled" 
                                          class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-bold bg-white bg-opacity-5 text-muted border border-white border-opacity-10">
                                        DESATIVADO
                                    </span>
                                </div>
                                <div x-show="!button.order_bump.enabled" 
                                     class="flex items-start gap-2 p-3 bg-danger-500 bg-opacity-10 border-l-4 border-danger-500 rounded-r-lg mb-3">
                                    <i class="fas fa-exclamation-triangle text-danger-500"></i>
                                    <p class="text-xs text-textPrimary font-semibold">
                                        Marque o checkbox acima para ativar o Order Bump!
                                    </p>
                                </div>
                                <p x-show="button.order_bump.enabled" class="text-xs text-textSecondary mb-4">
                                    Oferta especial exibida quando o cliente clicar neste botão
                                </p>
                                
                                <div class="space-y-4" x-show="button.order_bump.enabled">
                                    <!-- Mensagem do Order Bump -->
                                    <div class="space-y-2">
                                        <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                            <i class="fas fa-comment-alt text-accent500 mr-1.5"></i>
                                            Mensagem do Order Bump
                                            <span class="text-danger-500 ml-1">*</span>
                                        </label>
                                        <textarea x-model="button.order_bump.message" 
                                                  rows="3" 
                                                  class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-accent500 focus:ring-1 focus:ring-accent500 focus:ring-opacity-20 transition-all text-sm resize-none"
                                                  placeholder="Espere! Adicione este bônus especial por apenas +R$ 5!&#10;&#10;Você terá acesso vitalício..."></textarea>
                                    </div>
                                    
                                    <!-- Mídia do Order Bump -->
                                    <div class="space-y-2">
                                        <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                            <i class="fas fa-image text-purple-500 mr-1.5"></i>
                                            Mídia
                                            <span class="text-muted ml-2 text-xs font-normal">(Opcional)</span>
                                        </label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <input type="url" 
                                                   x-model="button.order_bump.media_url" 
                                                   class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:ring-opacity-20 transition-all text-xs"
                                                   placeholder="https://t.me/canal/123">
                                            <select x-model="button.order_bump.media_type" 
                                                    class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:ring-opacity-20 transition-all text-xs">
                                                <option value="video">Vídeo</option>
                                                <option value="photo">Foto</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Valores do Order Bump -->
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="space-y-2">
                                            <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                                <i class="fas fa-plus-circle text-success-500 mr-1.5"></i>
                                                Preço Adicional (R$)
                                            </label>
                                            <input type="number" 
                                                   x-model="button.order_bump.price" 
                                                   step="0.01"
                                                   class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-success-500 focus:ring-1 focus:ring-success-500 focus:ring-opacity-20 transition-all text-sm text-center font-mono"
                                                   placeholder="5.00">
                                        </div>
                                        <div class="space-y-2">
                                            <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                                <i class="fas fa-award text-accent500 mr-1.5"></i>
                                                Descrição do Bônus
                                            </label>
                                            <input type="text" 
                                                   x-model="button.order_bump.description" 
                                                   class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-accent500 focus:ring-1 focus:ring-accent500 focus:ring-opacity-20 transition-all text-sm"
                                                   placeholder="Acesso Vitalício">
                                        </div>
                                    </div>
                                    
                                    <!-- Personalizar Botões -->
                                    <div class="space-y-3">
                                        <label class="block text-xs font-semibold text-textSecondary flex items-center">
                                            <i class="fas fa-hand-pointer text-info-500 mr-1.5"></i>
                                            Personalizar Textos dos Botões
                                            <span class="text-muted ml-2 text-xs font-normal">(Opcional)</span>
                                        </label>
                                        
                                        <div class="grid grid-cols-1 gap-3">
                                            <div class="space-y-2">
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-check-circle text-success-500"></i>
                                                    <label class="block text-xs font-medium text-textSecondary">Botão de Aceitar (SIM)</label>
                                                </div>
                                                <input type="text" 
                                                       x-model="button.order_bump && button.order_bump.accept_text ? button.order_bump.accept_text : ''" 
                                                       @input="if (!button.order_bump) button.order_bump = {enabled: false, message: '', media_url: '', media_type: 'video', price: 0, description: '', accept_text: '', decline_text: ''}; button.order_bump.accept_text = $event.target.value"
                                                       class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-success-500 focus:ring-1 focus:ring-success-500 focus:ring-opacity-20 transition-all text-sm"
                                                       placeholder="Ex: SIM! Quero esse bônus!">
                                                <p class="text-xs text-muted ml-1">
                                                    Deixe vazio para usar: "SIM! Quero por R$ XX,XX"
                                                </p>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-times-circle text-danger-500"></i>
                                                    <label class="block text-xs font-medium text-textSecondary">Botão de Recusar (NÃO)</label>
                                                </div>
                                                <input type="text" 
                                                       x-model="button.order_bump && button.order_bump.decline_text ? button.order_bump.decline_text : ''" 
                                                       @input="if (!button.order_bump) button.order_bump = {enabled: false, message: '', media_url: '', media_type: 'video', price: 0, description: '', accept_text: '', decline_text: ''}; button.order_bump.decline_text = $event.target.value"
                                                       class="w-full px-3 py-2.5 bg-bg900 border border-white border-opacity-10 rounded-lg text-textPrimary placeholder-muted focus:outline-none focus:border-danger-500 focus:ring-1 focus:ring-danger-500 focus:ring-opacity-20 transition-all text-sm"
                                                       placeholder="Ex: Não, obrigado">
                                                <p class="text-xs text-muted ml-1">
                                                    Deixe vazio para usar: "NÃO, continuar com R$ XX,XX"
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dica Final -->
                                    <div class="flex items-start gap-2 p-3 bg-accent500 bg-opacity-8 border-l-4 border-accent500 rounded-r-lg">
                                        <i class="fas fa-lightbulb text-accent500"></i>
                                        <p class="text-xs text-textPrimary">
                                            <strong class="text-accent500">Dica de conversão:</strong> Order bumps com vídeo/foto convertem +40%! Use mídia de canal público do Telegram.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="!config.main_buttons || config.main_buttons.length === 0" class="text-center py-8 text-gray-500">
                        <i class="fas fa-hand-pointer text-4xl text-gray-300"></i>
                        <p class="mt-2 text-sm">Nenhum botão configurado. Adicione seu primeiro botão.</p>
                    </div>
                </div>
            </div>

            <!-- Order Bump Tab -->
            <div x-show="activeTab === 'order_bump'" x-cloak>
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Order Bumps Personalizados</h3>
                    <p class="text-sm text-gray-500 bg-yellow-50 border border-yellow-200 p-3 rounded-md">
                        <strong>⚠️ Atenção:</strong> Configure o Order Bump diretamente em cada botão na aba "Botões" acima!<br>
                        Cada oferta pode ter seu próprio order bump personalizado.
                    </p>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                    <h4 class="text-sm font-medium text-blue-900 mb-2">Como configurar Order Bumps:</h4>
                    <ol class="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                        <li>Vá na aba <strong>"Botões"</strong></li>
                        <li>Em cada botão, marque <strong>"Order Bump para este botão"</strong></li>
                        <li>Configure mensagem, preço e descrição específicos</li>
                        <li>Salve as configurações</li>
                    </ol>
                    <p class="mt-3 text-sm text-blue-700">
                        <strong>Exemplo:</strong><br>
                        • Botão "Plano R$ 19,97" → Order Bump: "Bônus A por +R$ 5"<br>
                        • Botão "Plano R$ 29,97" → Order Bump: "Bônus B por +R$ 10"
                    </p>
                </div>
            </div>

            <!-- Downsells Tab -->
            <div x-show="activeTab === 'downsells'" x-cloak>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Downsells</h3>
                        <p class="text-sm text-gray-500">Ofertas enviadas após X minutos sem pagamento</p>
                    </div>
                    <button @click="addDownsell()" 
                            class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Adicionar Downsell
                    </button>
                </div>

                <div class="mb-4">
                    <div class="flex items-center">
                        <input type="checkbox" 
                               x-model="config.downsells_enabled" 
                               id="downsells_enabled"
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="downsells_enabled" class="ml-2 block text-sm text-gray-900">
                            Habilitar Downsells
                        </label>
                    </div>
                </div>

                <div x-show="config.downsells_enabled" class="space-y-4">
                    <template x-for="(downsell, index) in config.downsells" :key="index">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="text-sm font-medium text-gray-700">Downsell <span x-text="index + 1"></span></h4>
                                <button @click="removeDownsell(index)" 
                                        class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Delay (minutos)</label>
                                    <input type="number" 
                                           x-model="downsell.delay_minutes" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                           placeholder="5">
                                    <p class="mt-1 text-xs text-gray-500">Tempo de espera antes de enviar a oferta</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Mensagem</label>
                                    <textarea x-model="downsell.message" 
                                              rows="3" 
                                              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                              placeholder="Oferta especial por tempo limitado!"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">URL da Mídia</label>
                                    <input type="url" 
                                           x-model="downsell.media_url" 
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                           placeholder="https://t.me/canal/789">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Preço (R$)</label>
                                    <input type="number" 
                                           x-model="downsell.price" 
                                           step="0.01"
                                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                           placeholder="14.97">
                                </div>
                                
                                <!-- Personalização do Botão -->
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <label class="block text-sm font-bold text-blue-900 mb-3">
                                        <i class="fas fa-mouse-pointer mr-1"></i>Personalizar Botão de Compra
                                    </label>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Texto do Botão</label>
                                        <input type="text" 
                                               x-model="downsell.button_text" 
                                               class="mt-1 block w-full border-2 border-blue-300 rounded-md shadow-sm py-3 px-4 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                               placeholder="Ex: 🛒 Comprar Agora!">
                                        <p class="text-xs text-blue-600 mt-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            <strong>Dica:</strong> Deixe vazio para usar: "🛒 Comprar por R$ XX,XX"
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="config.downsells.length === 0" class="text-center py-8 text-gray-500">
                        <i class="fas fa-arrow-down text-4xl text-gray-300"></i>
                        <p class="mt-2 text-sm">Nenhum downsell configurado.</p>
                    </div>
                </div>
            </div>

            <!-- Access Tab - Redesenhado -->
            <div x-show="activeTab === 'access'" x-cloak>
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-textPrimary flex items-center">
                        <i class="fas fa-key text-accent500 mr-3"></i>
                        Link de Acesso e Mensagens
                    </h3>
                    <p class="text-sm text-textSecondary mt-2">Configure o acesso ao produto e as mensagens de confirmação de pagamento</p>
                </div>

                <div class="space-y-6">
                    <!-- Link de Acesso -->
                    <div class="bg-surface800 rounded-2xl p-6 border border-white border-opacity-10">
                        <label class="block text-sm font-semibold text-textSecondary flex items-center mb-3">
                            <i class="fas fa-external-link-alt text-info-500 mr-2"></i>
                            Link de Acesso ao Produto
                        </label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-link text-muted group-hover:text-textSecondary transition-colors"></i>
                            </div>
                            <input type="url" 
                                   x-model="config.access_link" 
                                   class="w-full pl-11 pr-4 py-3.5 bg-bg900 border border-white border-opacity-10 rounded-xl text-textPrimary placeholder-muted focus:outline-none focus:border-info-500 focus:ring-2 focus:ring-info-500 focus:ring-opacity-20 hover:border-opacity-15 transition-all"
                                   placeholder="https://t.me/+seugrupo ou https://area-membros.com">
                        </div>
                        <div class="flex items-start gap-3 p-4 bg-info-500 bg-opacity-12 border-l-4 border-info-500 rounded-r-xl mt-3"
                             style="box-shadow: 0 2px 8px rgba(59, 130, 246, 0.12);">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-lg" style="color: #60A5FA; filter: brightness(1.3);"></i>
                            </div>
                            <p class="text-sm leading-relaxed" style="color: #FAFAFA; font-weight: 500;">
                                Pode ser um link de <strong style="color: #60A5FA; font-weight: 900;">grupo/canal privado</strong> do Telegram, área de membros, Google Drive, etc.
                            </p>
                        </div>
                    </div>

                    <!-- Mensagem de Sucesso -->
                    <div class="bg-surface800 rounded-2xl p-6 border border-success-500 border-opacity-20"
                         style="box-shadow: 0 4px 12px rgba(34, 197, 94, 0.1);">
                        <label class="block text-sm font-semibold text-textSecondary flex items-center mb-3">
                            <i class="fas fa-check-circle text-success-500 mr-2" style="filter: brightness(1.2);"></i>
                            Mensagem de Pagamento Confirmado
                        </label>
                        <textarea x-model="config.success_message" 
                                  rows="5" 
                                  class="w-full px-4 py-3.5 bg-bg900 border border-white border-opacity-10 rounded-xl text-textPrimary placeholder-muted focus:outline-none focus:border-success-500 focus:ring-2 focus:ring-success-500 focus:ring-opacity-20 hover:border-opacity-15 transition-all resize-none"
                                  placeholder="Parabéns! Seu pagamento foi aprovado!&#10;&#10;Acesse seu produto agora mesmo!"></textarea>
                        <div class="flex items-start gap-3 p-4 bg-success-500 bg-opacity-15 border-l-4 border-success-500 rounded-r-xl mt-3"
                             style="box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);">
                            <div class="flex-shrink-0">
                                <i class="fas fa-code text-xl" style="color: #22C55E; filter: brightness(1.3);"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm leading-relaxed" style="color: #FAFAFA; font-weight: 500;">
                                    <strong style="color: #22C55E; font-weight: 900; filter: brightness(1.15);">Variáveis disponíveis:</strong>
                                    <code class="ml-2 px-2 py-1 bg-bg900 rounded font-mono text-sm"
                                          style="color: #FFD23F; font-weight: 700; border: 1px solid rgba(255, 186, 8, 0.3);">{produto}</code>
                                    <code class="ml-1 px-2 py-1 bg-bg900 rounded font-mono text-sm"
                                          style="color: #FFD23F; font-weight: 700; border: 1px solid rgba(255, 186, 8, 0.3);">{valor}</code>
                                    <code class="ml-1 px-2 py-1 bg-bg900 rounded font-mono text-sm"
                                          style="color: #FFD23F; font-weight: 700; border: 1px solid rgba(255, 186, 8, 0.3);">{link}</code>
                                </p>
                                <p class="text-xs mt-2" style="color: #D1D1D1; font-weight: 500;">
                                    Deixe vazio para usar mensagem padrão do sistema
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Mensagem Pendente -->
                    <div class="bg-surface800 rounded-2xl p-6 border border-warning-500 border-opacity-20"
                         style="box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);">
                        <label class="block text-sm font-semibold text-textSecondary flex items-center mb-3">
                            <i class="fas fa-hourglass-half text-warning-500 mr-2" style="filter: brightness(1.2);"></i>
                            Mensagem de Pagamento Pendente
                        </label>
                        <textarea x-model="config.pending_message" 
                                  rows="5" 
                                  class="w-full px-4 py-3.5 bg-bg900 border border-white border-opacity-10 rounded-xl text-textPrimary placeholder-muted focus:outline-none focus:border-warning-500 focus:ring-2 focus:ring-warning-500 focus:ring-opacity-20 hover:border-opacity-15 transition-all resize-none"
                                  placeholder="Pagamento ainda não confirmado.&#10;&#10;Se já pagou, aguarde alguns minutos!"></textarea>
                        <div class="flex items-start gap-3 p-4 bg-warning-500 bg-opacity-15 border-l-4 border-warning-500 rounded-r-xl mt-3"
                             style="box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);">
                            <div class="flex-shrink-0">
                                <i class="fas fa-code text-xl" style="color: #FBBF24; filter: brightness(1.3);"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm leading-relaxed" style="color: #FAFAFA; font-weight: 500;">
                                    <strong style="color: #FBBF24; font-weight: 900; filter: brightness(1.2);">Variável disponível:</strong>
                                    <code class="ml-2 px-2 py-1 bg-bg900 rounded font-mono text-sm"
                                          style="color: #FFD23F; font-weight: 700; border: 1px solid rgba(255, 186, 8, 0.3);">{pix_code}</code>
                                </p>
                                <p class="text-xs mt-2" style="color: #D1D1D1; font-weight: 500;">
                                    Deixe vazio para usar mensagem padrão do sistema
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
function botConfigApp() {
    return {
        activeTab: 'welcome',
        loading: false,
        config: {
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            main_buttons: [],
            downsells_enabled: false,
            downsells: [],
            access_link: '',
            success_message: '',
            pending_message: ''
        },

        async init() {
            // Carregar configuração atual
            await this.loadConfig();
        },

        async loadConfig() {
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/config');
                const data = await response.json();
                
                if (response.ok) {
                    this.config = {
                        ...this.config,
                        ...data
                    };
                    
                    // Garantir que cada botão tenha order_bump completo
                    if (Array.isArray(this.config.main_buttons)) {
                        this.config.main_buttons.forEach(button => {
                            if (!button.order_bump) {
                                button.order_bump = {
                                    enabled: false,
                                    message: '',
                                    media_url: '',
                                    media_type: 'video',
                                    price: 0,
                                    description: '',
                                    accept_text: '',
                                    decline_text: ''
                                };
                            } else {
                                // Garantir campos novos em order bumps existentes
                                if (!button.order_bump.accept_text) button.order_bump.accept_text = '';
                                if (!button.order_bump.decline_text) button.order_bump.decline_text = '';
                            }
                        });
                    }
                    
                    // Garantir que cada downsell tenha button_text
                    if (Array.isArray(this.config.downsells)) {
                        this.config.downsells.forEach(downsell => {
                            if (!downsell.button_text) {
                                downsell.button_text = '';
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configuração:', error);
            }
        },

        async saveConfig() {
            this.loading = true;
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.config)
                });

                const data = await response.json();

                if (response.ok) {
                    this.showNotification('Configurações salvas com sucesso!', 'success');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao salvar configuração: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        addButton() {
            this.config.main_buttons.push({
                text: '',
                price: 0,
                description: '',
                order_bump: {
                    enabled: false,
                    message: '',
                    media_url: '',
                    media_type: 'video',
                    price: 0,
                    description: '',
                    accept_text: '',
                    decline_text: ''
                }
            });
        },

        removeButton(index) {
            this.config.main_buttons.splice(index, 1);
        },

        addDownsell() {
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                media_url: '',
                price: 0,
                button_text: ''
            });
        },

        removeDownsell(index) {
            this.config.downsells.splice(index, 1);
        },

        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    }
}
</script>
{% endblock %}

