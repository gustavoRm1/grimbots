{% extends "base.html" %}
{% block title %}Configurar Bot - {{ bot.name }}{% endblock %}

{% block extra_head %}
<style>
/* ‚úÖ Editor Visual de Fluxo - jsPlumb Styles */
.connection-label {
    background: rgba(0, 0, 0, 0.8);
    color: #FFFFFF;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    pointer-events: none;
}

.flow-step-block {
    transition: transform 0.2s, box-shadow 0.2s;
    min-width: 200px;
    max-width: 280px;
    width: 240px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    touch-action: none;
    -webkit-touch-callout: none;
}

/* ‚úÖ Prevenir sele√ß√£o de texto durante drag */
.flow-step-block.dragging {
    cursor: grabbing !important;
    user-select: none !important;
    pointer-events: all;
    opacity: 0.9;
    transform: scale(1.05);
    z-index: 1000 !important;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.8) !important;
}

.flow-step-block:not(.dragging) {
    cursor: move;
}

/* ‚úÖ Garantir que bot√µes dentro do card n√£o sejam arrast√°veis */
.flow-step-block button,
.flow-step-block input,
.flow-step-block textarea,
.flow-step-block select,
.flow-step-block a,
.flow-step-block i {
    cursor: pointer !important;
    pointer-events: auto !important;
    user-select: auto !important;
}

/* ‚úÖ Prevenir que o canvas seja arrast√°vel */
#flow-visual-canvas {
    user-select: none;
    -webkit-user-select: none;
    cursor: default;
    position: relative;
}

/* ‚úÖ PAN: Cursor de arrasto quando estiver arrastando o canvas */
#flow-visual-canvas.panning {
    cursor: grabbing !important;
}

/* ‚úÖ ZOOM: Garantir que elementos internos possam ser escalados */
#flow-visual-canvas .jtk-surface-canvas {
    transition: transform 0.1s ease-out;
}

/* ‚úÖ Permitir sele√ß√£o apenas em inputs dentro do canvas */
#flow-visual-canvas input,
#flow-visual-canvas textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
}

/* ‚úÖ Estilos para drop zones durante drag de conex√µes */
.drop-hover {
    border-color: #10B981 !important;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.5) !important;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

.drop-active {
    border-color: #34D399 !important;
    box-shadow: 0 0 20px rgba(52, 211, 153, 0.7) !important;
    transform: scale(1.05);
}

/* ‚úÖ Garantir que linhas de conex√£o sejam arrast√°veis */
.jtk-connector {
    cursor: move !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
}

.jtk-endpoint-connected {
    cursor: crosshair !important;
}

/* ‚úÖ Endpoints VERDE (entrada) e VERMELHO (sa√≠da) */
/* ‚úÖ CR√çTICO: Ocultar endpoints jsPlumb padr√£o - usamos apenas elementos visuais HTML */
.jtk-endpoint {
    display: none !important; /* ‚úÖ Ocultar endpoints jsPlumb - usamos apenas elementos visuais */
}

/* ‚úÖ Manter vis√≠veis apenas nossos elementos visuais customizados */
.step-input-endpoint,
.step-output-endpoint,
.btn-visual-endpoint {
    display: block !important;
    pointer-events: auto !important;
}

/* ‚úÖ Estilos para endpoints visuais (j√° definidos inline, mas garantir) */
.jtk-endpoint[data-endpoint-type="input"] {
    background: #10B981 !important;
    border: 3px solid #059669 !important;
}

.jtk-endpoint[data-endpoint-type="output"] {
    background: #EF4444 !important;
    border: 3px solid #DC2626 !important;
}

/* ‚úÖ Hover em conex√µes para remover */
.jtk-connector {
    cursor: pointer !important;
}

.jtk-connector:hover {
    stroke-width: 4 !important;
    opacity: 0.9 !important;
}

/* ‚úÖ Responsividade para telas menores */
@media (max-width: 768px) {
    .flow-step-block {
        min-width: 180px;
        max-width: 240px;
        width: 200px;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 320px) !important;
        min-height: 400px !important;
    }
    
    .config-section {
        padding: 16px;
    }
    
    .config-section-header {
        flex-direction: column;
        align-items: flex-start;
    }
}

@media (max-width: 640px) {
    .flow-step-block {
        min-width: 160px;
        max-width: 200px;
        width: 180px;
        font-size: 0.875rem;
    }
    
    #flow-visual-canvas {
        height: calc(100vh - 280px) !important;
        min-height: 350px !important;
    }
    
    .config-section {
        padding: 12px;
        border-radius: 8px;
    }
    
    .config-section-header {
        gap: 8px;
    }
    
    .config-section-title {
        font-size: 1rem;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    /* Grids responsivos */
    .grid.grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .grid.grid-cols-1.md\:grid-cols-3 {
        grid-template-columns: 1fr;
    }
}

/* ‚úÖ Garantir que todos os containers sejam 100% em mobile */
@media (max-width: 640px) {
    /* Container principal - garantir 100% width */
    .max-w-full {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    /* Bot√µes full width em mobile */
    .btn-action {
        width: 100%;
        justify-content: center;
    }
    
    /* Canvas do editor visual - garantir 100% em mobile */
    #flow-visual-canvas {
        width: 100% !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 0 !important;
    }
    
    /* Garantir que grids sejam sempre 1 coluna em mobile */
    .grid {
        grid-template-columns: 1fr !important;
    }
}

/* ‚úÖ Garantir que elementos n√£o quebrem o layout */
* {
    box-sizing: border-box;
}

/* ‚úÖ Prevenir overflow horizontal */
body {
    overflow-x: hidden;
}

/* ‚úÖ Garantir que modais sejam responsivos */
@media (max-width: 640px) {
    .fixed.inset-0.z-50 > .flex > div,
    [id^="flow-step-modal-"],
    [id^="condition-modal-"] {
        width: 95% !important;
        max-width: 95% !important;
        margin: 0 auto !important;
        padding: 1rem !important;
    }
}

.flow-step-block:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    z-index: 100 !important;
}

.jtk-endpoint {
    cursor: crosshair !important;
    transition: all 0.2s ease;
}

.jtk-endpoint:hover {
    transform: scale(1.3);
    z-index: 50 !important;
}

.jtk-connector {
    cursor: pointer;
    transition: stroke-width 0.2s ease;
}

.jtk-connector:hover {
    stroke-width: 4 !important;
    filter: drop-shadow(0 0 4px rgba(59, 130, 246, 0.6));
}

/* ‚úÖ Melhorar visual das conex√µes */
.jtk-connector path {
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* ‚úÖ Estilo para conex√µes de bot√µes customizados (vermelhas) */
.jtk-connector[data-button-connection="true"] {
    stroke: #FF6B6B !important;
    stroke-width: 3 !important;
}

.jtk-connector[data-button-connection="true"]:hover {
    stroke-width: 5 !important;
    filter: drop-shadow(0 0 6px rgba(255, 107, 107, 0.8));
}

/* ‚úÖ Bot√£o de remover conex√£o (ao passar mouse) - MELHORADO */
.jtk-overlay-connection-delete {
    background: #EF4444 !important;
    border-radius: 50% !important;
    width: 24px !important;
    height: 24px !important;
    cursor: pointer !important;
    opacity: 0;
    transition: all 0.2s ease;
    border: 2px solid #FFFFFF !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.jtk-overlay-connection-delete::before {
    content: '√ó' !important;
    color: #FFFFFF !important;
    font-size: 18px !important;
    font-weight: bold !important;
    line-height: 1 !important;
}

.jtk-connector:hover .jtk-overlay-connection-delete {
    opacity: 1 !important;
    transform: scale(1.1);
}

.jtk-connector:hover {
    cursor: pointer !important;
}

/* ‚úÖ Indicador visual de que a linha pode ser removida */
.jtk-connector[data-removable="true"] {
    position: relative;
}

.jtk-connector[data-removable="true"]::after {
    content: '‚ùå Duplo clique para remover';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(239, 68, 68, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 1000;
}

.jtk-connector[data-removable="true"]:hover::after {
    opacity: 1;
}

/* ‚úÖ Feedback visual ao arrastar */
.jtk-drag-select {
    border: 2px dashed #3B82F6;
    background: rgba(59, 130, 246, 0.1);
}

/* ‚úÖ Tooltip para conex√µes */
.connection-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
}

/* ‚úÖ Estilos para endpoints de bot√µes customizados */
.btn-endpoint-marker,
.btn-visual-endpoint {
    position: absolute;
    width: 16px;
    height: 16px;
    background: #FF6B6B;
    border: 3px solid #FF0000;
    border-radius: 50%;
    cursor: crosshair;
    z-index: 30;
    box-shadow: 0 0 8px rgba(255, 107, 107, 0.8);
    transition: all 0.2s ease;
    pointer-events: all;
}

.btn-endpoint-marker:hover,
.btn-visual-endpoint:hover {
    background: #FF8787;
    border-color: #FF3333;
    transform: translateY(-50%) scale(1.3) !important;
    box-shadow: 0 0 12px rgba(255, 107, 107, 1);
}

.btn-endpoint-label {
    background: rgba(255, 107, 107, 0.9);
    color: #FFFFFF;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    pointer-events: none;
    border: 1px solid #FF0000;
}

.btn-endpoint-label-text {
    position: absolute;
    font-size: 10px;
    color: #FF6B6B;
    font-weight: bold;
    white-space: nowrap;
    pointer-events: none;
    transform: translateY(-50%);
    z-index: 25;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
}

/* Bot Config V2.0 - Design System */

.config-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .config-section {
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 20px;
    }
}

@media (min-width: 768px) {
    .config-section {
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }
}

.config-section-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

@media (min-width: 640px) {
    .config-section-header {
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 16px;
    }
}

.config-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #FFFFFF;
    word-wrap: break-word;
}

@media (min-width: 640px) {
    .config-section-title {
        font-size: 1.125rem;
    }
}

@media (min-width: 768px) {
    .config-section-title {
        font-size: 1.25rem;
    }
}

.config-section-description {
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-top: 4px;
    word-wrap: break-word;
}

@media (min-width: 640px) {
    .config-section-description {
        font-size: 0.875rem;
    }
}

.form-group {
    margin-bottom: 16px;
    width: 100%;
}

@media (min-width: 640px) {
    .form-group {
        margin-bottom: 20px;
    }
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #D1D1D1;
    margin-bottom: 8px;
}

.form-input {
    width: 100%;
    max-width: 100%;
    padding: 10px 12px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .form-input {
        padding: 12px 16px;
    }
}

.form-input:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.form-textarea {
    width: 100%;
    max-width: 100%;
    padding: 10px 12px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    resize: vertical;
    min-height: 100px;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .form-textarea {
        padding: 12px 16px;
        min-height: 120px;
    }
}

.form-textarea:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

.tab-nav {
    display: flex;
    gap: 0;
    border-bottom: 2px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 24px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.tab-nav::-webkit-scrollbar {
    height: 4px;
}

.tab-nav::-webkit-scrollbar-track {
    background: transparent;
}

.tab-nav::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
}

.tab-button {
    padding: 12px 16px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #9CA3AF;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
}

@media (min-width: 640px) {
    .tab-button {
        padding: 16px 24px;
    }
}

.tab-button:hover {
    color: #D1D1D1;
}

.tab-button.active {
    color: #FFB800;
    border-bottom-color: #FFB800;
}

.button-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
}

.order-bump-card {
    background: linear-gradient(135deg, rgba(255, 184, 0, 0.05) 0%, rgba(255, 184, 0, 0.02) 100%);
    border: 1px solid rgba(255, 184, 0, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
}

.order-bump-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255, 184, 0, 0.1);
}

.order-bump-index {
    width: 32px;
    height: 32px;
    background: rgba(255, 184, 0, 0.1);
    border: 2px solid rgba(255, 184, 0, 0.4);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    color: #FFB800;
}

.button-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.button-index {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    font-weight: 700;
    color: #6EE7B7;
}

.info-box {
    padding: 16px;
    background: rgba(59, 130, 246, 0.05);
    border-left: 4px solid #3B82F6;
    border-radius: 0 8px 8px 0;
    margin-top: 12px;
}

.info-box-success {
    background: rgba(16, 185, 129, 0.05);
    border-left-color: #10B981;
}

.info-box-warning {
    background: rgba(255, 184, 0, 0.05);
    border-left-color: #FFB800;
}

.order-bump-section {
    background: rgba(255, 184, 0, 0.03);
    border: 1px solid rgba(255, 184, 0, 0.15);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

/* Bot√µes de A√ß√£o - ID√äNTICO ao Dashboard */
.btn-action {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-action:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.btn-action i {
    margin-right: 0.5rem;
}

/* Todas as variantes usam o mesmo estilo dourado */
.btn-action-primary,
.btn-action-success,
.btn-action-info {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    cursor: pointer;
    transition: all 0.15s ease;
}

.btn-action-primary:hover,
.btn-action-success:hover,
.btn-action-info:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Bot√µes de Precifica√ß√£o (Downsells) */
.pricing-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 700;
    transition: all 0.15s ease;
    cursor: pointer;
}

.pricing-btn-active {
    color: #111827;
    background-image: linear-gradient(to right, var(--brand-gold-500), var(--brand-gold-700));
    border: 2px solid var(--brand-gold-500);
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
}

.pricing-btn-inactive {
    color: #9CA3AF;
    background: #1F2937;
    border: 2px solid #374151;
}

.pricing-btn-inactive:hover {
    color: #D1D5DB;
    border-color: #4B5563;
    background: #374151;
}
</style>
<script>
    window.stripSurrogateChars = function (value) {
        if (!value) {
            return '';
        }
        try {
            // ‚úÖ CORRE√á√ÉO CR√çTICA: Remover APENAS surrogates inv√°lidos (isolados)
            // Preservar pares de surrogates v√°lidos (emojis, caracteres Unicode especiais)
            // Surrogates v√°lidos v√™m em pares: high surrogate (\uD800-\uDBFF) + low surrogate (\uDC00-\uDFFF)
            // Surrogates inv√°lidos s√£o isolados ou fora de ordem
            
            // N√£o remover nada - deixar o texto como est√°
            // O Telegram e o banco de dados suportam UTF-8 completo
            return value;
        } catch (err) {
            return value || '';
        }
    };
</script>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8" x-data="botConfigApp()" x-init="init()">
    
    <!-- Header -->
    <div class="mb-4 sm:mb-6 md:mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4">
        <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto">
            <a href="{{ url_for('dashboard') }}" 
               class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-700 text-gray-400 hover:text-white hover:border-yellow-500 transition-all flex-shrink-0">
                <i class="fas fa-arrow-left text-sm sm:text-base"></i>
            </a>
            <div class="min-w-0 flex-1">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-white truncate">{{ bot.name }}</h1>
                <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">@{{ bot.username }}</p>
            </div>
        </div>
        <div class="flex items-center space-x-2 sm:space-x-3 w-full sm:w-auto">
            <!-- ‚ùå REMOVIDO: Meta Pixel agora √© configurado POR POOL (n√£o por bot) -->
            <!-- Acesse: Redirecionadores ‚Üí Editar Pool ‚Üí Meta Pixel -->
            <button @click="saveConfig()" 
                    :disabled="loading"
                    :class="{'opacity-50 cursor-not-allowed': loading}"
                    class="btn-action btn-action-primary w-full sm:w-auto text-sm sm:text-base px-3 sm:px-6 py-2 sm:py-3">
                <span x-show="!loading">
                    <i class="fas fa-save mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Salvar Configura√ß√µes</span>
                    <span class="sm:hidden">Salvar</span>
                </span>
                <span x-show="loading">
                    <i class="fas fa-spinner fa-spin mr-1 sm:mr-2"></i>
                    <span class="hidden sm:inline">Salvando...</span>
                    <span class="sm:hidden">Salvando</span>
                </span>
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tab-nav overflow-x-auto -mx-2 sm:-mx-4 md:-mx-6 lg:-mx-8 px-2 sm:px-4 md:px-6 lg:px-8">
        <div class="flex gap-1 sm:gap-2 min-w-max">
            <button @click="activeTab = 'welcome'" 
                    :class="{'active': activeTab === 'welcome'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-home mr-1 sm:mr-2"></i><span class="hidden sm:inline">Boas-vindas</span><span class="sm:hidden">Boas-vindas</span>
            </button>
            <button @click="activeTab = 'flow'" 
                    :class="{'active': activeTab === 'flow'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-project-diagram mr-1 sm:mr-2"></i><span class="hidden sm:inline">Fluxo</span><span class="sm:hidden">Fluxo</span>
            </button>
            <button @click="activeTab = 'buttons'" 
                    :class="{'active': activeTab === 'buttons'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-shopping-cart mr-1 sm:mr-2"></i><span class="hidden sm:inline">Bot√µes</span><span class="sm:hidden">Bot√µes</span>
            </button>
            <button @click="activeTab = 'downsells'" 
                    :class="{'active': activeTab === 'downsells'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-arrow-down mr-1 sm:mr-2"></i><span class="hidden sm:inline">Downsells</span><span class="sm:hidden">Down</span>
            </button>
            <button @click="activeTab = 'upsells'" 
                    :class="{'active': activeTab === 'upsells'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-arrow-up mr-1 sm:mr-2"></i><span class="hidden sm:inline">Upsells</span><span class="sm:hidden">Up</span>
            </button>
            <button @click="activeTab = 'access'" 
                    :class="{'active': activeTab === 'access'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-key mr-1 sm:mr-2"></i><span class="hidden sm:inline">Acesso</span><span class="sm:hidden">Acesso</span>
            </button>
            <button @click="activeTab = 'remarketing'" 
                    :class="{'active': activeTab === 'remarketing'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-bullhorn mr-1 sm:mr-2"></i><span class="hidden sm:inline">Remarketing</span><span class="sm:hidden">Remark</span>
            </button>
            <button @click="activeTab = 'settings'" 
                    :class="{'active': activeTab === 'settings'}"
                    class="tab-button text-xs sm:text-sm whitespace-nowrap px-3 sm:px-6 py-2 sm:py-4">
                <i class="fas fa-cog mr-1 sm:mr-2"></i><span class="hidden sm:inline">Configura√ß√µes</span><span class="sm:hidden">Config</span>
            </button>
        </div>
    </div>

    <!-- Tab Content: Welcome -->
    <div x-show="activeTab === 'welcome'" x-cloak>
        <!-- ‚ö†Ô∏è Aviso quando Fluxo est√° ativado -->
        <div x-show="config.flow_enabled" 
             x-cloak
             class="mb-6 p-4 bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 rounded-xl">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                <div class="flex-1">
                    <div class="text-yellow-400 font-bold mb-1">‚ö†Ô∏è Fluxo Visual Ativado</div>
                    <div class="text-sm text-gray-300">
                        O <strong>Fluxo Visual</strong> est√° ativo e ser√° executado ao inv√©s da mensagem de Boas-vindas quando o usu√°rio iniciar o bot.
                        <br>
                        <span class="text-xs text-gray-400 mt-1 block">
                            As configura√ß√µes de Boas-vindas abaixo s√£o mantidas como fallback caso o Fluxo seja desativado.
                        </span>
                    </div>
                    <button @click="activeTab = 'flow'" 
                            class="mt-3 px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                        <i class="fas fa-project-diagram mr-2"></i>
                        Ir para Editor de Fluxo
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-home text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Mensagem de Boas-vindas</div>
                    <div class="config-section-description">
                        <span x-show="!config.flow_enabled">Primeira impress√£o quando o usu√°rio inicia o bot</span>
                        <span x-show="config.flow_enabled" class="text-gray-400">Configura√ß√£o mantida como fallback (Fluxo Visual ativo)</span>
                    </div>
                </div>
            </div>

            <!-- Mensagem -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-comment-dots mr-2 text-yellow-500"></i>
                    Mensagem de Texto
                </label>
                <textarea x-model="config.welcome_message"
                          class="form-textarea"
                          maxlength="4096"
                          @input="validateWelcomeMessage()"
                          placeholder="Ol√°! Bem-vindo ao nosso bot de vendas...&#10;&#10;Escolha uma das op√ß√µes abaixo:"></textarea>
                <p class="text-xs mt-1" x-show="config.welcome_message">
                    <span class="text-gray-500">Caracteres: </span>
                    <span :class="{'text-green-400 font-bold': getWelcomeMessageLength() <= 4096, 'text-red-400 font-bold': getWelcomeMessageLength() > 4096}" 
                          x-text="getWelcomeMessageLength()"></span>
                    <span class="text-gray-500"> / </span>
                    <span class="text-gray-400 font-bold">4096</span>
                    <span x-show="getWelcomeMessageLength() > 4096" 
                          class="text-red-400 ml-2 font-bold">
                        ‚ùå Excede o limite do Telegram (4096)!
                    </span>
                </p>
            </div>

            <!-- M√≠dia -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        URL da M√≠dia
                    </label>
                    <input type="url" 
                           x-model="config.welcome_media_url" 
                           @input="validateWelcomeMessage()"
                           @change="validateWelcomeMessage()"
                           class="form-input"
                           placeholder="https://t.me/canal/123">
                    <p class="text-xs text-gray-500 mt-2">Link do Telegram (v√≠deo, foto ou √°udio)</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-image mr-2 text-blue-500"></i>
                        Tipo de M√≠dia Principal
                    </label>
                    <div class="flex gap-3 mt-2">
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': config.welcome_media_type === 'video'}">
                            <input type="radio" x-model="config.welcome_media_type" value="video" class="text-blue-500">
                            <i class="fas fa-video text-blue-500"></i>
                            <span class="text-sm text-white">V√≠deo</span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': config.welcome_media_type === 'photo'}">
                            <input type="radio" x-model="config.welcome_media_type" value="photo" class="text-blue-500">
                            <i class="fas fa-camera text-blue-500"></i>
                            <span class="text-sm text-white">Foto</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label flex items-center gap-2">
                        <input type="checkbox" 
                               x-model="config.welcome_audio_enabled"
                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                               style="accent-color: #3B82F6;">
                        <i class="fas fa-microphone mr-1 text-purple-500"></i>
                        <span>Adicionar √Åudio Complementar (opcional)</span>
                    </label>
                    <div x-show="config.welcome_audio_enabled" x-cloak class="mt-2">
                        <input type="url" 
                               x-model="config.welcome_audio_url" 
                               class="form-input"
                               placeholder="https://t.me/canal/789">
                        <p class="text-xs text-gray-500 mt-2">Link do √°udio no Telegram (ser√° enviado ap√≥s a m√≠dia principal)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Flow -->
    <div x-show="activeTab === 'flow'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-project-diagram text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Editor de Fluxograma Visual</div>
                    <div class="config-section-description">Crie fluxos personalizados com blocos conectados</div>
                </div>
            </div>

            <!-- Toggle Ativar Fluxo -->
            <div class="form-group">
                <label class="flex items-center gap-2">
                    <input type="checkbox" 
                           x-model="config.flow_enabled"
                           @change="onFlowToggle()"
                           class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                           style="accent-color: #3B82F6;">
                    <i class="fas fa-toggle-on mr-1 text-blue-500"></i>
                    <span class="text-white font-medium">Ativar Fluxo Visual</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">
                    Quando ativado, desativa automaticamente Boas-vindas. O fluxo ser√° executado ao inv√©s de welcome_message.
                </p>
            </div>

            <!-- Lista Visual de Steps (Padr√£o) -->
            <div x-show="config.flow_enabled" x-cloak class="mt-6">
                <!-- ‚ö†Ô∏è Aviso se n√£o houver step inicial -->
                <div x-show="config.flow_steps && config.flow_steps.length > 0 && !config.flow_start_step_id" 
                     x-cloak
                     class="mb-4 p-4 bg-yellow-500 bg-opacity-10 border-2 border-yellow-500 rounded-xl">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
                        <div class="flex-1">
                            <div class="text-yellow-400 font-bold mb-1">‚ö†Ô∏è Step Inicial N√£o Definido</div>
                            <div class="text-sm text-gray-300">
                                O fluxo precisa de um step inicial para come√ßar quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.
                                <br>
                                <span class="text-xs text-gray-400 mt-1 block">
                                    Clique no bot√£o "Inicial" em qualquer step para defini-lo como inicial, ou o primeiro step ser√° usado automaticamente.
                                </span>
                            </div>
                            <button @click="setFlowStartStep(sortedFlowSteps[0]?.id)" 
                                    x-show="sortedFlowSteps.length > 0"
                                    class="mt-3 px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                <i class="fas fa-play mr-2"></i>
                                Definir Primeiro Step como Inicial
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ‚úÖ Info do step inicial definido -->
                <div x-show="config.flow_start_step_id" 
                     x-cloak
                     class="mb-4 p-4 bg-green-500 bg-opacity-25 border-2 border-green-500 rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        <div class="flex-1">
                            <div class="text-green-400 font-bold mb-1">‚úÖ Step Inicial Definido</div>
                            <div class="text-sm text-gray-200">
                                O fluxo iniciar√° no step marcado com <span class="text-yellow-400 font-bold">‚≠ê Inicial</span> quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white">Steps do Fluxo</h3>
                    <div class="flex items-center gap-3">
                        <button @click="addFlowStep()" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-plus mr-2"></i>Adicionar Step
                        </button>
                    </div>
                </div>

                <!-- ‚úÖ EDITOR VISUAL (Canvas com linhas) - SEMPRE VIS√çVEL -->
                <div class="mb-6 w-full overflow-hidden">
                    <div class="bg-gray-900 rounded-lg border-2 border-blue-500 p-2 sm:p-3 md:p-4 w-full max-w-full">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-project-diagram text-blue-400 text-xl"></i>
                                <h4 class="text-white font-bold text-sm sm:text-base">Editor Visual de Fluxo</h4>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-400 flex-wrap">
                                <i class="fas fa-info-circle flex-shrink-0"></i>
                                <span class="text-xs sm:text-sm">Arraste os blocos para reposicionar ‚Ä¢ Clique e arraste para conectar ‚Ä¢ <strong class="text-red-400">Duplo clique ou bot√£o direito na linha para remover</strong></span>
                            </div>
                        </div>
                        <!-- ‚úÖ Mensagem se n√£o houver steps -->
                        <div x-show="!config.flow_steps || config.flow_steps.length === 0" 
                             x-cloak
                             class="text-center py-12 text-gray-400">
                            <i class="fas fa-project-diagram text-4xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium mb-2">Nenhum step criado ainda</p>
                            <p class="text-sm">Adicione um step clicando em "Adicionar Step" acima</p>
                        </div>
                        <!-- ‚úÖ Canvas apenas se houver steps -->
                        <div x-show="config.flow_steps && config.flow_steps.length > 0"
                             x-cloak
                             x-init="$nextTick(() => { initVisualFlowEditor(); })"
                             class="w-full overflow-hidden">
                            <div id="flow-visual-canvas" 
                                 class="relative w-full bg-gray-950 rounded border border-gray-700"
                                 style="height: calc(100vh - 380px); min-height: 500px; max-height: 90vh; overflow: auto; width: 100%; max-width: 100%; box-sizing: border-box; position: relative; touch-action: pan-x pan-y; overscroll-behavior: contain; cursor: grab;">
                                <!-- Steps ser√£o renderizados aqui via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ REMOVIDO: Lista de Steps - Agora apenas Visual (Editor Visual sempre ativo) -->
            </div>
        </div>
    </div>

    <!-- Tab Content: Buttons -->
    <div x-show="activeTab === 'buttons'" x-cloak>
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-white">Bot√µes de Venda</h2>
                <p class="text-sm text-gray-500 mt-1">Bot√µes que geram PIX automaticamente</p>
            </div>
            <button @click="addButton()" class="btn-action btn-action-success">
                <i class="fas fa-plus mr-2"></i>
                Adicionar Bot√£o
            </button>
        </div>

        <!-- Lista de Bot√µes -->
        <template x-if="config.main_buttons.length > 0">
            <div class="space-y-4">
                <template x-for="(button, index) in config.main_buttons" :key="index">
                    <div class="button-card">
                        <!-- Header -->
                        <div class="button-card-header">
                            <div class="flex items-center gap-3">
                                <div class="button-index" x-text="index + 1"></div>
                                <div>
                                    <h3 class="text-sm font-bold text-white">Bot√£o <span x-text="index + 1"></span></h3>
                                    <p class="text-xs text-gray-500">Configure pre√ßo e order bump</p>
                                </div>
                            </div>
                            <button @click="removeButton(index)" 
                                    class="w-10 h-10 flex items-center justify-center rounded-lg border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10 transition-all">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <!-- Campos Principais -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-tag mr-2 text-yellow-500"></i>
                                    Texto do Bot√£o
                                </label>
                                <input type="text" 
                                       x-model="button.text" 
                                       class="form-input"
                                       placeholder="Comprar por R$ 19,97">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-dollar-sign mr-2 text-green-500"></i>
                                    Pre√ßo (R$)
                                </label>
                                <input type="number" 
                                       x-model="button.price" 
                                       step="0.01"
                                       class="form-input text-center font-mono"
                                       placeholder="19.97">
                            </div>

                            <div class="form-group md:col-span-2">
                                <label class="form-label">
                                    <i class="fas fa-box mr-2 text-blue-500"></i>
                                    Descri√ß√£o
                                </label>
                                <input type="text" 
                                       x-model="button.description" 
                                       class="form-input"
                                       placeholder="Curso Completo de...">
                            </div>
                        </div>

                        <!-- M√∫ltiplos Order Bumps -->
                        <div class="order-bumps-section">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-gift text-yellow-500"></i>
                                    <span class="text-sm font-bold text-white">Order Bumps (Ofertas Sequenciais)</span>
                                </div>
                                <button @click="addOrderBump(index)" 
                                        class="px-3 py-1.5 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-xs font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                    <i class="fas fa-plus mr-1"></i>
                                    Adicionar Order Bump
                                </button>
                            </div>

                            <!-- Lista de Order Bumps -->
                            <template x-if="button.order_bumps && button.order_bumps.length > 0">
                                <div class="space-y-4">
                                    <template x-for="(orderBump, bumpIndex) in button.order_bumps" :key="bumpIndex">
                                        <div class="order-bump-card">
                                            <div class="order-bump-header">
                                                <div class="flex items-center gap-3">
                                                    <div class="order-bump-index" x-text="bumpIndex + 1"></div>
                                                    <div>
                                                        <h4 class="text-sm font-bold text-white">Order Bump <span x-text="bumpIndex + 1"></span></h4>
                                                        <p class="text-xs text-gray-500">Oferta sequencial</p>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" 
                                                               x-model="orderBump.enabled"
                                                               class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                                        <span class="text-xs text-white">Ativo</span>
                                                    </label>
                                                    <button @click="removeOrderBump(index, bumpIndex)" 
                                                            class="w-8 h-8 flex items-center justify-center rounded-lg border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10 transition-all">
                                                        <i class="fas fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div x-show="orderBump.enabled" class="space-y-4">
                                                <div class="form-group">
                                                    <label class="form-label">Mensagem da Oferta</label>
                                                    <textarea x-model="orderBump.message"
                                                              class="form-textarea"
                                                              maxlength="900"
                                                              @input="orderBump.message = stripSurrogateChars(orderBump.message || '').slice(0, 900)"
                                                              placeholder="üéÅ Oferta Especial!&#10;&#10;Adicione este b√¥nus por apenas +R$ 5!"></textarea>
                                                    <p class="text-[11px] text-gray-400 mt-1">M√°ximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                                                </div>

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="form-group">
                                                        <label class="form-label">Pre√ßo Adicional (R$)</label>
                                                        <input type="number" 
                                                               x-model="orderBump.price" 
                                                               step="0.01"
                                                               class="form-input text-center font-mono"
                                                               placeholder="5.00">
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="form-label">Descri√ß√£o do B√¥nus</label>
                                                        <input type="text" 
                                                               x-model="orderBump.description" 
                                                               class="form-input"
                                                               placeholder="Acesso Vital√≠cio">
                                                    </div>
                                                </div>

                                                <!-- M√≠dia do Order Bump -->
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-link mr-2 text-blue-500"></i>
                                                            URL da M√≠dia (opcional)
                                                        </label>
                                                        <input type="url" 
                                                               x-model="orderBump.media_url" 
                                                               class="form-input"
                                                               placeholder="https://t.me/canal/789">
                                                        <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-image mr-2 text-blue-500"></i>
                                                            Tipo de M√≠dia
                                                        </label>
                                                        <div class="flex gap-3 mt-2">
                                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                                   :class="{'border-blue-500 bg-blue-500 bg-opacity-10': orderBump.media_type === 'video'}">
                                                                <input type="radio" x-model="orderBump.media_type" value="video" class="text-blue-500">
                                                                <i class="fas fa-video text-blue-500"></i>
                                                                <span class="text-sm text-white">V√≠deo</span>
                                                            </label>
                                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                                   :class="{'border-blue-500 bg-blue-500 bg-opacity-10': orderBump.media_type === 'photo'}">
                                                                <input type="radio" x-model="orderBump.media_type" value="photo" class="text-blue-500">
                                                                <i class="fas fa-camera text-blue-500"></i>
                                                                <span class="text-sm text-white">Foto</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Bot√µes Personalizados -->
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-check-circle mr-2 text-green-400"></i>
                                                            Bot√£o Aceitar (opcional)
                                                        </label>
                                                        <input type="text" 
                                                               x-model="orderBump.accept_text" 
                                                               class="form-input"
                                                               placeholder="SIM! Quero esse b√¥nus!">
                                                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padr√£o</p>
                                                    </div>

                                                    <div class="form-group">
                                                        <label class="form-label">
                                                            <i class="fas fa-times-circle mr-2 text-red-400"></i>
                                                            Bot√£o Recusar (opcional)
                                                        </label>
                                                        <input type="text" 
                                                               x-model="orderBump.decline_text" 
                                                               class="form-input"
                                                               placeholder="N√£o, obrigado">
                                                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padr√£o</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Empty State -->
                            <template x-if="!button.order_bumps || button.order_bumps.length === 0">
                                <div class="text-center py-8 border-2 border-dashed border-gray-700 rounded-lg">
                                    <div class="text-4xl mb-3">üéÅ</div>
                                    <h4 class="text-lg font-bold text-white mb-2">Nenhum Order Bump</h4>
                                    <p class="text-gray-500 mb-4">Adicione ofertas sequenciais para aumentar o ticket m√©dio</p>
                                    <button @click="addOrderBump(index)" 
                                            class="px-4 py-2 bg-yellow-500 bg-opacity-25 border border-yellow-400 rounded-lg text-sm font-bold text-yellow-300 hover:bg-yellow-500 hover:bg-opacity-50 transition-all">
                                        <i class="fas fa-plus mr-2"></i>
                                        Adicionar Primeiro Order Bump
                                    </button>
                                </div>
                            </template>

                            <div class="info-box-warning info-box">
                                <p class="text-sm text-gray-300">
                                    <i class="fas fa-chart-line mr-2 text-yellow-500"></i>
                                    <strong>Convers√£o:</strong> M√∫ltiplos order bumps convertem at√© 80% mais! Se o usu√°rio recusar um, receber√° o pr√≥ximo automaticamente.
                                </p>
                            </div>
                        </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="config.main_buttons.length === 0">
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üõçÔ∏è</div>
                <h3 class="text-xl font-bold text-white mb-2">Nenhum bot√£o criado</h3>
                <p class="text-gray-500 mb-6">Adicione seus primeiros bot√µes de venda</p>
                <button @click="addButton()" class="btn-action btn-action-success">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Primeiro Bot√£o
                </button>
            </div>
        </template>
    </div>

    <!-- Bot√µes de Redirecionamento (dentro da tab Bot√µes) -->
    <div x-show="activeTab === 'buttons'" x-cloak class="mt-8">
        <div class="border-t border-gray-800 pt-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-external-link-alt text-blue-500"></i>
                        Bot√µes de Link
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Bot√µes que levam para links externos (sem pagamento)</p>
                </div>
                <button @click="addRedirectButton()" class="btn-action btn-action-info">
                    <i class="fas fa-plus"></i>
                    Adicionar Link
                </button>
            </div>

            <template x-if="config.redirect_buttons.length > 0">
                <div class="space-y-3">
                    <template x-for="(button, index) in config.redirect_buttons" :key="index">
                        <div class="flex items-center gap-3 p-4 bg-gray-900 border border-gray-800 rounded-lg">
                            <i class="fas fa-link text-blue-500"></i>
                            <input type="text" 
                                   x-model="button.text" 
                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white text-sm"
                                   placeholder="Texto do bot√£o">
                            <input type="url" 
                                   x-model="button.url" 
                                   class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white text-sm font-mono"
                                   placeholder="https://...">
                            <button @click="removeRedirectButton(index)" 
                                    class="w-10 h-10 flex items-center justify-center rounded border border-red-500 text-red-400 hover:bg-red-500 hover:bg-opacity-10">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </template>

            <template x-if="config.redirect_buttons.length === 0">
                <div class="text-center py-8 border-2 border-dashed border-gray-800 rounded-lg">
                    <i class="fas fa-external-link-alt text-4xl text-gray-700 mb-2"></i>
                    <p class="text-sm text-gray-500">Nenhum bot√£o de link configurado</p>
                    <p class="text-xs text-gray-600 mt-1">Use para grupos, canais, sites externos, etc.</p>
                </div>
            </template>
        </div>
    </div>

    <!-- Tab Content: Downsells -->
    <div x-show="activeTab === 'downsells'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-arrow-down text-2xl text-red-400"></i>
                <div>
                    <div class="config-section-title">Downsells</div>
                    <div class="config-section-description">Ofertas enviadas quando o pagamento n√£o √© confirmado</div>
                </div>
                <label class="ml-auto flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" 
                           x-model="config.downsells_enabled"
                           class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                    <span class="text-sm font-bold text-white">Habilitar</span>
                </label>
            </div>

            <div x-show="config.downsells_enabled" class="space-y-4">
                <template x-for="(downsell, index) in config.downsells" :key="index">
                    <div class="button-card">
                        <div class="button-card-header">
                            <h4 class="text-sm font-bold text-white">Downsell <span x-text="index + 1"></span></h4>
                            <button @click="removeDownsell(index)" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Delay (minutos)</label>
                                <input type="number" x-model="downsell.delay_minutes" class="form-input" placeholder="5">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensagem</label>
                                <textarea x-model="downsell.message"
                                          class="form-textarea"
                                          maxlength="900"
                                          @input="downsell.message = stripSurrogateChars(downsell.message || '').slice(0, 900)"
                                          placeholder="Oferta especial!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">M√°ximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                            </div>

                            <!-- ‚úÖ MODO DE PRECIFICA√á√ÉO (Pre√ßo Fixo vs Desconto %) -->
                            <div class="p-4 bg-gray-900 border border-gray-800 rounded-xl">
                                <label class="form-label mb-3">
                                    <i class="fas fa-calculator mr-2" style="color: var(--brand-gold-500);"></i>
                                    <span class="text-white font-bold">Modo de Precifica√ß√£o</span>
                                </label>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <button type="button"
                                            @click="downsell.pricing_mode = 'fixed'"
                                            :class="(downsell.pricing_mode || 'fixed') === 'fixed' ? 'pricing-btn-active' : 'pricing-btn-inactive'"
                                            class="pricing-btn">
                                        <i class="fas fa-dollar-sign"></i>
                                        Pre√ßo Fixo
                                    </button>
                                    <button type="button"
                                            @click="downsell.pricing_mode = 'percentage'"
                                            :class="downsell.pricing_mode === 'percentage' ? 'pricing-btn-active' : 'pricing-btn-inactive'"
                                            class="pricing-btn">
                                        <i class="fas fa-percent"></i>
                                        Desconto %
                                    </button>
                                </div>

                                <!-- Modo: Pre√ßo Fixo -->
                                <div x-show="(downsell.pricing_mode || 'fixed') === 'fixed'" class="form-group">
                                    <label class="form-label">Pre√ßo Fixo (R$)</label>
                                    <input type="number" 
                                           x-model="downsell.price" 
                                           step="0.01" 
                                           class="form-input text-center font-mono font-bold"
                                           placeholder="14.97">
                                    <div class="info-box mt-2">
                                        <p class="text-xs text-gray-400">
                                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                                            Valor fixo do downsell
                                        </p>
                                    </div>
                                </div>

                                <!-- Modo: Desconto Percentual -->
                                <div x-show="downsell.pricing_mode === 'percentage'" class="form-group">
                                    <label class="form-label">Desconto Percentual (%)</label>
                                    <input type="number" 
                                           x-model="downsell.discount_percentage" 
                                           min="1" 
                                           max="95" 
                                           step="1" 
                                           class="form-input text-center font-mono font-bold"
                                           placeholder="50">
                                    <div class="info-box-warning info-box mt-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-magic mr-1" style="color: var(--brand-gold-500);"></i>
                                            <strong style="color: var(--brand-gold-500);">Exemplo:</strong> 
                                            50% de R$ 19,97 = R$ 9,99
                                        </p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            O desconto √© calculado sobre o pre√ßo do bot√£o que o cliente clicou
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- M√≠dia (URL + Tipo) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-link mr-2 text-blue-500"></i>
                                        URL da M√≠dia (opcional)
                                    </label>
                                    <input type="url" 
                                           x-model="downsell.media_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/123">
                                    <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                </div>

                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-image mr-2 text-blue-500"></i>
                                            Tipo de M√≠dia Principal
                                        </label>
                                        <div class="flex gap-3 mt-2">
                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-colors flex-1"
                                                   :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.media_type === 'video'}">
                                                <input type="radio" x-model="downsell.media_type" value="video" class="text-yellow-500">
                                                <i class="fas fa-video text-yellow-500"></i>
                                                <span class="text-sm text-white">V√≠deo</span>
                                            </label>
                                            <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-yellow-500 transition-colors flex-1"
                                                   :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.media_type === 'photo'}">
                                                <input type="radio" x-model="downsell.media_type" value="photo" class="text-yellow-500">
                                                <i class="fas fa-camera text-yellow-500"></i>
                                                <span class="text-sm text-white">Foto</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label flex items-center gap-2">
                                            <input type="checkbox" 
                                                   x-model="downsell.audio_enabled"
                                                   class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                                   style="accent-color: #A855F7;">
                                            <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                            <span>Adicionar √Åudio Complementar</span>
                                        </label>
                                        <div x-show="downsell.audio_enabled" x-cloak class="mt-2">
                                            <input type="url" 
                                                   x-model="downsell.audio_url" 
                                                   class="form-input"
                                                   placeholder="https://t.me/canal/audio2">
                                            <p class="text-xs text-gray-500 mt-2">√Åudio enviado ap√≥s a m√≠dia principal</p>
                                        </div>
                                    </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mouse-pointer mr-2 text-green-400"></i>
                                    Texto do Bot√£o (opcional)
                                </label>
                                <input type="text" 
                                       x-model="downsell.button_text" 
                                       class="form-input" 
                                       placeholder="üõí Comprar Agora!">
                                <div class="info-box mt-2">
                                    <p class="text-xs text-gray-400">
                                        <i class="fas fa-lightbulb mr-1" style="color: var(--brand-gold-500);"></i>
                                        Deixe vazio para usar: "üõí Comprar por R$ XX,XX"
                                    </p>
                                </div>
                            </div>

                            <!-- Order Bump para Downsell V2.0 -->
                            <div class="order-bump-section">
                                <div class="flex items-center justify-between mb-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" 
                                               x-model="downsell.order_bump.enabled"
                                               class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                        <span class="text-sm font-bold text-white">
                                            <i class="fas fa-gift mr-2 text-yellow-500"></i>
                                            Order Bump (Oferta Extra no Downsell)
                                        </span>
                                    </label>
                                    <span x-show="downsell.order_bump.enabled" 
                                          class="px-3 py-1.5 bg-green-500 bg-opacity-25 border-2 border-green-400 rounded-full text-xs font-bold text-white shadow-lg"
                                          style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%);">
                                        <i class="fas fa-check-circle mr-1 text-green-300"></i>
                                        ATIVO
                                    </span>
                                </div>

                                <div x-show="downsell.order_bump.enabled" class="space-y-4">
                                    <!-- ‚úÖ V2.0: Order Bumps dos Bot√µes Principais (Bot√µes Clic√°veis) -->
                                    <div class="form-group" x-show="getAvailableOrderBumps().length > 0">
                                        <label class="form-label mb-3">
                                            <i class="fas fa-gift mr-2 text-yellow-500"></i>
                                            Order Bumps Configurados nos Bot√µes
                                        </label>
                                        <p class="text-xs text-gray-500 mb-3">
                                            Clique em um order bump abaixo para us√°-lo neste downsell. Estes s√£o os order bumps que voc√™ j√° configurou na aba "Bot√µes".
                                        </p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            <template x-for="(orderBumpRef, idx) in getAvailableOrderBumps()" :key="idx">
                                                <button 
                                                    type="button"
                                                    @click="useOrderBumpFromButtons(downsell, orderBumpRef.buttonIndex, orderBumpRef.bumpIndex)"
                                                    class="p-4 bg-gray-800 border-2 rounded-lg transition-all text-left hover:border-yellow-500 hover:bg-gray-750"
                                                    :class="{'border-yellow-500 bg-yellow-500 bg-opacity-10': downsell.order_bump.button_index === orderBumpRef.buttonIndex && downsell.order_bump.bump_index === orderBumpRef.bumpIndex, 'border-gray-700': downsell.order_bump.button_index !== orderBumpRef.buttonIndex || downsell.order_bump.bump_index !== orderBumpRef.bumpIndex}"
                                                >
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-gift text-yellow-500"></i>
                                                            <span class="text-sm font-bold text-white">
                                                                Bot√£o <span x-text="orderBumpRef.buttonIndex + 1"></span> - OB <span x-text="orderBumpRef.bumpIndex + 1"></span>
                                                            </span>
                                                        </div>
                                                        <span x-show="downsell.order_bump.button_index === orderBumpRef.buttonIndex && downsell.order_bump.bump_index === orderBumpRef.bumpIndex" 
                                                              class="px-2 py-1 bg-green-500 bg-opacity-25 border border-green-400 rounded text-xs text-green-300">
                                                            <i class="fas fa-check-circle"></i>
                                                        </span>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mb-1 line-clamp-2" x-text="(orderBumpRef.orderBump.message || 'Sem mensagem').substring(0, 60) + '...'"></p>
                                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-700">
                                                        <div>
                                                            <span class="text-xs font-bold text-yellow-500" x-show="orderBumpRef.orderBump.price > 0">
                                                                R$ <span x-text="parseFloat(orderBumpRef.orderBump.price || 0).toFixed(2)"></span>
                                                            </span>
                                                            <span class="text-xs text-gray-500" x-show="orderBumpRef.orderBump.price === 0">
                                                                Sem pre√ßo
                                                            </span>
                                                        </div>
                                                        <span class="text-xs text-gray-400 truncate max-w-[60%]" x-text="orderBumpRef.orderBump.description || 'Sem descri√ß√£o'"></span>
                                                    </div>
                                                </button>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Empty State: Nenhum Order Bump Configurado -->
                                    <div x-show="getAvailableOrderBumps().length === 0" class="info-box-warning info-box">
                                        <p class="text-sm text-gray-300">
                                            <i class="fas fa-info-circle mr-2 text-yellow-500"></i>
                                            <strong>Nenhum order bump configurado:</strong> V√° na aba "Bot√µes", configure seus bot√µes principais e adicione order bumps l√°. 
                                            Eles aparecer√£o aqui como bot√µes clic√°veis para reutilizar nos downsells.
                                        </p>
                                    </div>

                                    <!-- Divider: Configura√ß√£o Manual -->
                                    <div class="flex items-center gap-3 my-4">
                                        <div class="flex-1 border-t border-gray-700"></div>
                                        <span class="text-xs text-gray-500 font-semibold">OU CONFIGURE MANUALMENTE</span>
                                        <div class="flex-1 border-t border-gray-700"></div>
                                    </div>

                                    <!-- Configura√ß√£o Manual -->
                                    <div>
                                    <div class="form-group">
                                        <label class="form-label">Mensagem do Order Bump</label>
                                        <textarea x-model="downsell.order_bump.message"
                                                  class="form-textarea"
                                                  maxlength="900"
                                                  @input="downsell.order_bump.message = stripSurrogateChars(downsell.order_bump.message || '').slice(0, 900)"
                                                  placeholder="üéÅ Oferta Especial!&#10;&#10;Adicione este b√¥nus por apenas +R$ 5!"></textarea>
                                        <p class="text-[11px] text-gray-400 mt-1">M√°ximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Pre√ßo Adicional (R$)</label>
                                            <input type="number" 
                                                   x-model="downsell.order_bump.price" 
                                                   step="0.01"
                                                   class="form-input text-center font-mono"
                                                   placeholder="5.00">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Descri√ß√£o do B√¥nus</label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.description" 
                                                   class="form-input"
                                                   placeholder="Acesso Vital√≠cio">
                                        </div>
                                    </div>

                                    <!-- M√≠dia do Order Bump -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-link mr-2 text-blue-500"></i>
                                                URL da M√≠dia (opcional)
                                            </label>
                                            <input type="url" 
                                                   x-model="downsell.order_bump.media_url" 
                                                   class="form-input"
                                                   placeholder="https://t.me/canal/789">
                                            <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-image mr-2 text-blue-500"></i>
                                                Tipo de M√≠dia
                                            </label>
                                            <div class="flex gap-3 mt-2">
                                                <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                       :class="{'border-blue-500 bg-blue-500 bg-opacity-10': downsell.order_bump.media_type === 'video'}">
                                                    <input type="radio" x-model="downsell.order_bump.media_type" value="video" class="text-blue-500">
                                                    <i class="fas fa-video text-blue-500"></i>
                                                    <span class="text-sm text-white">V√≠deo</span>
                                                </label>
                                                <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                                       :class="{'border-blue-500 bg-blue-500 bg-opacity-10': downsell.order_bump.media_type === 'photo'}">
                                                    <input type="radio" x-model="downsell.order_bump.media_type" value="photo" class="text-blue-500">
                                                    <i class="fas fa-camera text-blue-500"></i>
                                                    <span class="text-sm text-white">Foto</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bot√µes Personalizados -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-check-circle mr-2 text-green-400"></i>
                                                Bot√£o Aceitar (opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.accept_text" 
                                                   class="form-input"
                                                   placeholder="SIM! Quero esse b√¥nus!">
                                            <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padr√£o</p>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-times-circle mr-2 text-red-400"></i>
                                                Bot√£o Recusar (opcional)
                                            </label>
                                            <input type="text" 
                                                   x-model="downsell.order_bump.decline_text" 
                                                   class="form-input"
                                                   placeholder="N√£o, obrigado">
                                            <p class="text-xs text-gray-500 mt-1">Deixe vazio para texto padr√£o</p>
                                        </div>
                                    </div>

                                    </div>

                                    <!-- Preview do Order Bump Selecionado dos Bot√µes -->
                                    <div x-show="downsell.order_bump.button_index !== null && downsell.order_bump.button_index !== undefined && downsell.order_bump.bump_index !== null && downsell.order_bump.bump_index !== undefined" 
                                         class="info-box-success info-box" 
                                         style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10B981;">
                                        <div class="flex items-start gap-3">
                                            <i class="fas fa-check-circle text-green-400 text-xl mt-1"></i>
                                            <div class="flex-1">
                                                <p class="text-sm font-bold text-white mb-2">
                                                    ‚úÖ Order Bump dos Bot√µes Selecionado
                                                </p>
                                                <div class="space-y-1 text-sm text-gray-300">
                                                    <p><strong>Origem:</strong> Bot√£o <span x-text="(downsell.order_bump.button_index || 0) + 1"></span> - Order Bump <span x-text="(downsell.order_bump.bump_index || 0) + 1"></span></p>
                                                    <p><strong>Pre√ßo:</strong> R$ <span x-text="(parseFloat(downsell.order_bump.price) || 0).toFixed(2)"></span></p>
                                                    <p><strong>Descri√ß√£o:</strong> <span x-text="downsell.order_bump.description || 'Sem descri√ß√£o'"></span></p>
                                                    <p x-show="downsell.order_bump.message" class="mt-2 text-xs text-gray-400 line-clamp-2"><strong>Mensagem:</strong> <span x-text="downsell.order_bump.message"></span></p>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-2">
                                                    <i class="fas fa-info-circle mr-1"></i>
                                                    Este order bump est√° sendo reutilizado dos bot√µes principais. Para alterar, edite na aba "Bot√µes" ou configure manualmente acima.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="addDownsell()" class="w-full py-3 border-2 border-dashed border-gray-700 rounded-lg text-gray-400 hover:border-yellow-500 hover:text-yellow-500 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Downsell
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Upsells -->
    <div x-show="activeTab === 'upsells'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-arrow-up text-2xl text-green-400"></i>
                <div>
                    <div class="config-section-title">Upsells</div>
                    <div class="config-section-description">Ofertas enviadas AP√ìS compra aprovada</div>
                </div>
                <label class="ml-auto flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" 
                           x-model="config.upsells_enabled"
                           class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-green-500">
                    <span class="text-sm font-bold text-white">Habilitar</span>
                </label>
            </div>

            <div x-show="config.upsells_enabled" class="space-y-4">
                <template x-for="(upsell, index) in config.upsells" :key="index">
                    <div class="button-card">
                        <div class="button-card-header">
                            <h4 class="text-sm font-bold text-white">Upsell <span x-text="index + 1"></span></h4>
                            <button @click="removeUpsell(index)" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">Produto Trigger (opcional)</label>
                                <input type="text" x-model="upsell.trigger_product" class="form-input" placeholder="Ex: INSS B√°sico (vazio = todos)">
                                <p class="text-xs text-gray-500 mt-1">Deixe vazio para disparar em todas as compras</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Delay (minutos)</label>
                                <input type="number" x-model="upsell.delay_minutes" class="form-input" placeholder="0">
                                <p class="text-xs text-gray-500 mt-1">0 = envio imediato ap√≥s pagamento</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mensagem</label>
                                <textarea x-model="upsell.message"
                                          class="form-textarea"
                                          maxlength="900"
                                          @input="upsell.message = stripSurrogateChars(upsell.message || '').slice(0, 900)"
                                          placeholder="üî• Upgrade para Premium!"></textarea>
                                <p class="text-[11px] text-gray-400 mt-1">M√°ximo 900 caracteres. O campo bloqueia novos caracteres ao atingir o limite.</p>
                            </div>

                            <!-- M√≠dia (URL + Tipo) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-link mr-2 text-blue-500"></i>
                                        URL da M√≠dia (opcional)
                                    </label>
                                    <input type="url" 
                                           x-model="upsell.media_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/456">
                                    <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-image mr-2 text-blue-500"></i>
                                        Tipo de M√≠dia Principal
                                    </label>
                                    <div class="flex gap-3 mt-2">
                                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': upsell.media_type === 'video'}">
                                            <input type="radio" x-model="upsell.media_type" value="video" class="text-blue-500">
                                            <i class="fas fa-video text-blue-500"></i>
                                            <span class="text-sm text-white">V√≠deo</span>
                                        </label>
                                        <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                               :class="{'border-blue-500 bg-blue-500 bg-opacity-10': upsell.media_type === 'photo'}">
                                            <input type="radio" x-model="upsell.media_type" value="photo" class="text-blue-500">
                                            <i class="fas fa-camera text-blue-500"></i>
                                            <span class="text-sm text-white">Foto</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label flex items-center gap-2">
                                        <input type="checkbox" 
                                               x-model="upsell.audio_enabled"
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               style="accent-color: #A855F7;">
                                        <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                        <span>Adicionar √Åudio Complementar</span>
                                    </label>
                                    <div x-show="upsell.audio_enabled" x-cloak class="mt-2">
                                        <input type="url" 
                                               x-model="upsell.audio_url" 
                                               class="form-input"
                                               placeholder="https://t.me/canal/audio3">
                                        <p class="text-xs text-gray-500 mt-2">√Åudio enviado ap√≥s a m√≠dia principal</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-box-warning info-box">
                                <p class="text-sm text-gray-300">
                                    <i class="fas fa-rocket mr-2 text-yellow-500"></i>
                                    <strong>Dica:</strong> <strong>V√≠deos</strong> aumentam convers√£o em upsells (cliente j√° confia).
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Nome do Produto</label>
                                    <input type="text" x-model="upsell.product_name" class="form-input" placeholder="INSS Premium">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Pre√ßo (R$)</label>
                                    <input type="number" x-model="upsell.price" step="0.01" class="form-input" placeholder="97.00">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-mouse-pointer mr-2 text-green-400"></i>
                                    Texto do Bot√£o (opcional)
                                </label>
                                <input type="text" 
                                       x-model="upsell.button_text" 
                                       class="form-input" 
                                       placeholder="üöÄ Quero fazer Upgrade!">
                                <div class="info-box mt-2">
                                    <p class="text-xs text-gray-400">
                                        <i class="fas fa-lightbulb mr-1" style="color: var(--brand-gold-500);"></i>
                                        Deixe vazio para usar texto padr√£o
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <button @click="addUpsell()" class="w-full py-3 border-2 border-dashed border-gray-700 rounded-lg text-gray-400 hover:border-green-500 hover:text-green-500 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Adicionar Upsell
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Access -->
    <div x-show="activeTab === 'access'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-key text-2xl" style="color: var(--brand-gold-500);"></i>
                <div>
                    <div class="config-section-title">Acesso ao Produto</div>
                    <div class="config-section-description">Link de entrega e mensagens</div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Link -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        Link de Acesso
                    </label>
                    
                    <!-- ‚úÖ Mensagem quando Meta Pixel est√° ativo -->
                    <div x-show="config.has_meta_pixel" 
                         x-cloak
                         class="mb-3 p-4 bg-blue-900 bg-opacity-20 border border-blue-500 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-400 mt-1"></i>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-blue-300 mb-1">
                                    Meta Pixel Ativo (Pool: <span x-text="config.pool_name || 'N/A'"></span>)
                                </p>
                                <p class="text-xs text-gray-300 leading-relaxed">
                                    ‚úÖ O link de entrega ser√° gerado automaticamente quando o pagamento for confirmado.<br>
                                    ‚úÖ Este campo ser√° usado como <strong>redirecionamento final</strong> ap√≥s o Purchase disparar.<br>
                                    ‚úÖ Configure aqui o link para onde o lead ser√° redirecionado ap√≥s acessar o entreg√°vel.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <input type="url" 
                           x-model="config.access_link" 
                           class="form-input"
                           :class="{'bg-opacity-50': config.has_meta_pixel}"
                           :placeholder="config.has_meta_pixel ? 'https://t.me/+seugrupo (Link final ap√≥s Purchase)' : 'https://t.me/+seugrupo'">
                    <div class="info-box mt-2">
                        <p class="text-sm text-gray-300" x-show="!config.has_meta_pixel">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Pode ser grupo/canal do Telegram, √°rea de membros, etc.
                        </p>
                        <p class="text-sm text-gray-300" x-show="config.has_meta_pixel" x-cloak>
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Este ser√° o link final. O sistema gerar√° automaticamente um link de entrega (<code class="px-1 py-0.5 bg-gray-900 rounded text-yellow-400 text-xs">/delivery/&lt;token&gt;</code>) que dispara o Purchase e depois redireciona para este link.
                        </p>
                    </div>
                </div>

                <!-- Mensagem Sucesso -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-check-circle mr-2 text-green-500"></i>
                        Mensagem de Pagamento Aprovado
                    </label>
                    <textarea x-model="config.success_message" 
                              class="form-textarea"
                              placeholder="‚úÖ Pagamento confirmado!&#10;&#10;Acesse seu produto: {link}"></textarea>
                    <div class="info-box-success info-box mt-2">
                        <p class="text-sm text-gray-300">
                            <strong class="text-green-400">Vari√°veis:</strong>
                            <code class="ml-2 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{produto}</code>
                            <code class="ml-1 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{valor}</code>
                            <code class="ml-1 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{link}</code>
                        </p>
                    </div>
                </div>

                <!-- Mensagem Pendente -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock mr-2 text-yellow-500"></i>
                        Mensagem de Pagamento Pendente
                    </label>
                    <textarea x-model="config.pending_message" 
                              class="form-textarea"
                              placeholder="‚è≥ Aguardando confirma√ß√£o do pagamento..."></textarea>
                    <div class="info-box-warning info-box mt-2">
                        <p class="text-sm text-gray-300">
                            <strong class="text-yellow-400">Vari√°vel:</strong>
                            <code class="ml-2 px-2 py-1 bg-gray-900 rounded text-yellow-400 text-xs">{pix_code}</code>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Remarketing -->
    <div x-show="activeTab === 'remarketing'" x-cloak x-data="remarketingApp()">
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-bullhorn text-2xl text-yellow-500"></i>
                <div>
                    <div class="config-section-title">Campanhas de Remarketing</div>
                    <div class="config-section-description">Recupere clientes que n√£o compraram</div>
                </div>
                <div class="ml-auto">
                    <button @click="showCreateModal = true" class="btn-action btn-action-success">
                        <i class="fas fa-plus"></i>
                        Nova Campanha
                    </button>
                </div>
            </div>

            <div class="info-box-warning info-box mb-6">
                <p class="text-sm text-gray-300">
                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                    <strong class="text-yellow-500">Remarketing:</strong> Envie mensagens autom√°ticas para usu√°rios que iniciaram conversa mas n√£o compraram. Configure p√∫blico-alvo, delay e mensagem personalizada.
                </p>
            </div>

            <!-- Analytics Detalhados -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-yellow-500 transition-all">
                    <div class="text-3xl font-bold text-yellow-500" x-text="campaigns.length || 0"></div>
                    <div class="text-sm text-gray-500 mt-1">Campanhas Criadas</div>
                </div>
                
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-blue-400 transition-all">
                    <div class="text-3xl font-bold text-blue-400" x-text="getTotalSent()"></div>
                    <div class="text-sm text-gray-500 mt-1">Mensagens Enviadas</div>
                </div>
                
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-green-400 transition-all">
                    <div class="text-3xl font-bold text-green-400" x-text="getDeliveryRate() + '%'"></div>
                    <div class="text-sm text-gray-500 mt-1">Taxa de Entrega</div>
                </div>
                
                <div class="stat-box text-center p-5 bg-gray-900 border border-gray-800 rounded-xl hover:border-green-400 transition-all">
                    <div class="text-3xl font-bold text-green-400" x-text="getClickRate() + '%'"></div>
                    <div class="text-sm text-gray-500 mt-1">Taxa de Cliques</div>
                </div>
            </div>

            <!-- M√©tricas Adicionais -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-green-300" x-text="getTotalClicks()"></div>
                    <div class="text-xs text-gray-500 mt-1">Total de Cliques</div>
                </div>
                
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-red-400" x-text="getTotalFailed()"></div>
                    <div class="text-xs text-gray-500 mt-1">Falhas no Envio</div>
                </div>
                
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-gray-400" x-text="getTotalBlocked()"></div>
                    <div class="text-xs text-gray-500 mt-1">Usu√°rios Bloqueados</div>
                </div>
                
                <div class="text-center p-4 bg-gray-900 border border-gray-800 rounded-lg">
                    <div class="text-xl font-bold text-yellow-500" x-text="'R$ ' + getTotalRevenue().toFixed(2)"></div>
                    <div class="text-xs text-gray-500 mt-1">Receita Gerada</div>
                </div>
            </div>

            <!-- Info Box: Dica de Performance -->
            <div class="info-box mb-6" style="background: rgba(16, 185, 129, 0.05); border-left: 4px solid #10B981; padding: 12px; border-radius: 0 8px 8px 0;">
                <p class="text-sm text-gray-300">
                    <i class="fas fa-chart-line mr-2 text-green-400"></i>
                    <strong class="text-green-400">An√°lise de Performance:</strong>
                    <span x-show="getClickRate() > 10" class="text-green-300">Excelente! Taxa de cliques acima de 10% √© considerada √≥tima.</span>
                    <span x-show="getClickRate() <= 10 && getClickRate() > 5" class="text-blue-300">Bom! Continue testando mensagens diferentes para melhorar.</span>
                    <span x-show="getClickRate() <= 5 && getClickRate() > 0" class="text-yellow-300">Teste mensagens mais persuasivas e ofertas melhores.</span>
                    <span x-show="getClickRate() === 0 && campaigns.length > 0" class="text-gray-300">Envie suas primeiras campanhas para come√ßar a coletar dados.</span>
                    <span x-show="campaigns.length === 0" class="text-gray-300">Crie sua primeira campanha para ver as m√©tricas aqui.</span>
                </p>
            </div>

            <!-- Lista de Campanhas -->
            <div x-show="campaigns.length > 0" class="space-y-4">
                <template x-for="campaign in campaigns" :key="campaign.id">
                    <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl hover:border-yellow-500 transition-all"
                         :class="{'cursor-pointer': campaign.status === 'completed' || campaign.status === 'sending'}"
                         @click="if(campaign.status === 'completed' || campaign.status === 'sending') { viewCampaignStats(campaign) }">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                    <span x-text="campaign.name"></span>
                                    <i x-show="campaign.status === 'completed' || campaign.status === 'sending'" 
                                       class="fas fa-chart-bar text-yellow-500 text-sm"></i>
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    <i class="fas fa-users mr-1"></i>
                                    P√∫blico: <span x-text="getAudienceLabel(campaign.target_audience)"></span>
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span :class="{
                                    'bg-yellow-500 bg-opacity-20 text-yellow-400': campaign.status === 'draft',
                                    'bg-blue-500 bg-opacity-20 text-blue-400': campaign.status === 'scheduled',
                                    'bg-green-500 bg-opacity-30 text-green-300 font-semibold': campaign.status === 'sending',
                                    'bg-gray-500 bg-opacity-40 text-gray-300 border border-gray-500': campaign.status === 'completed'
                                }" class="px-3 py-1 rounded-full text-xs font-bold">
                                    <span x-text="getStatusLabel(campaign.status)"></span>
                                </span>
                                <button @click.stop="sendCampaign(campaign.id)" 
                                        x-show="campaign.status === 'draft'"
                                        class="px-3 py-1.5 bg-yellow-500 text-black rounded-lg text-sm font-bold hover:bg-yellow-400 transition-all">
                                    <i class="fas fa-paper-plane mr-1"></i> Enviar
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold text-white" x-text="campaign.total_targets || 0"></div>
                                <div class="text-xs text-gray-500">Alvos</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold text-green-400" x-text="campaign.total_sent || 0"></div>
                                <div class="text-xs text-gray-500">Enviados</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold text-blue-400" x-text="campaign.total_clicks || 0"></div>
                                <div class="text-xs text-gray-500">Cliques</div>
                            </div>
                            <div class="text-center p-3 bg-gray-800 rounded-lg">
                                <div class="text-2xl font-bold" style="color: var(--brand-gold-500);" x-text="'R$ ' + (campaign.revenue_generated || 0).toFixed(2)"></div>
                                <div class="text-xs text-gray-500">Receita</div>
                            </div>
                        </div>
                        
                        <!-- Dica: Clique para ver detalhes -->
                        <div x-show="campaign.status === 'completed' || campaign.status === 'sending'" 
                             class="mt-4 text-center text-xs text-yellow-500 opacity-60 hover:opacity-100 transition-opacity">
                            <i class="fas fa-mouse-pointer mr-1"></i>
                            Clique para ver estat√≠sticas detalhadas
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div x-show="campaigns.length === 0" class="text-center py-12 border-2 border-dashed border-gray-700 rounded-xl">
                <i class="fas fa-bullhorn text-5xl text-yellow-500 mb-4" style="opacity: 0.5;"></i>
                <h3 class="text-xl font-bold text-white mb-2">Nenhuma campanha criada</h3>
                <p class="text-gray-500 mb-6">Crie sua primeira campanha de remarketing</p>
                <button @click="showCreateModal = true" class="btn-action btn-action-success">
                    <i class="fas fa-plus"></i>
                    Criar Primeira Campanha
                </button>
            </div>
        </div>

        <!-- Modal: Criar Campanha -->
        <div x-show="showCreateModal" 
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             style="background: rgba(0,0,0,0.8);">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div @click.away="showCreateModal = false" 
                     class="bg-gray-900 rounded-xl max-w-2xl w-full p-6 border border-gray-800">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white">Nova Campanha de Remarketing</h3>
                        <button @click="showCreateModal = false" class="text-gray-500 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Nome da Campanha</label>
                            <input type="text" x-model="newCampaign.name" class="form-input" placeholder="Ex: Recupera√ß√£o de Carrinho">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mensagem</label>
                            <textarea x-model="newCampaign.message" class="form-textarea" rows="4" placeholder="Ol√°! Notamos que voc√™ estava interessado..."></textarea>
                        </div>

                        <!-- M√≠dia (Padr√£o 2 colunas) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-link mr-2 text-blue-500"></i>
                                    URL da M√≠dia (opcional)
                                </label>
                                <input type="url" x-model="newCampaign.media_url" class="form-input" placeholder="https://t.me/canal/123">
                                <p class="text-xs text-gray-500 mt-2">Link do Telegram</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-image mr-2 text-blue-500"></i>
                                    Tipo de M√≠dia Principal
                                </label>
                                <div class="flex gap-3 mt-2">
                                    <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                           :class="{'border-blue-500 bg-blue-500 bg-opacity-10': newCampaign.media_type === 'video'}">
                                        <input type="radio" x-model="newCampaign.media_type" value="video" class="text-blue-500">
                                        <i class="fas fa-video text-blue-500"></i>
                                        <span class="text-sm text-white">V√≠deo</span>
                                    </label>
                                    <label class="flex items-center gap-2 px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 transition-colors flex-1"
                                           :class="{'border-blue-500 bg-blue-500 bg-opacity-10': newCampaign.media_type === 'photo'}">
                                        <input type="radio" x-model="newCampaign.media_type" value="photo" class="text-blue-500">
                                        <i class="fas fa-camera text-blue-500"></i>
                                        <span class="text-sm text-white">Foto</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label flex items-center gap-2">
                                    <input type="checkbox" 
                                           x-model="newCampaign.audio_enabled"
                                           class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                           style="accent-color: #A855F7;">
                                    <i class="fas fa-microphone mr-1 text-purple-500"></i>
                                    <span>Adicionar √Åudio Complementar</span>
                                </label>
                                <div x-show="newCampaign.audio_enabled" x-cloak class="mt-2">
                                    <input type="url" 
                                           x-model="newCampaign.audio_url" 
                                           class="form-input"
                                           placeholder="https://t.me/canal/audioremkt">
                                    <p class="text-xs text-gray-500 mt-2">√Åudio enviado ap√≥s a m√≠dia principal</p>
                                </div>
                            </div>
                        </div>

                        <!-- ‚úÖ BOT√ïES DE PRODUTO (igual ao Remarketing Geral) -->
                        <div class="form-group p-4 rounded-xl" style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="flex items-center justify-between mb-3">
                                <label class="form-label mb-0">
                                    <i class="fas fa-tag mr-2 text-emerald-400"></i>
                                    Bot√µes de Produto
                                </label>
                                <button type="button" 
                                        @click="newCampaign.buttons = newCampaign.buttons || []; newCampaign.buttons.push({ text: '', price: 0, description: '' })"
                                        class="px-3 py-1 text-xs font-bold rounded-lg text-black"
                                        style="background: linear-gradient(to right, #10B981, #059669);">
                                    <i class="fas fa-plus mr-1"></i>
                                    Adicionar Bot√£o
                                </button>
                            </div>
                            
                            <!-- Lista de bot√µes -->
                            <template x-if="!newCampaign.buttons || newCampaign.buttons.length === 0">
                                <div class="text-center py-6 text-gray-500 text-sm">
                                    <i class="fas fa-hand-pointer text-2xl mb-2"></i>
                                    <p>Nenhum bot√£o adicionado</p>
                                    <p class="text-xs mt-1">Clique em "Adicionar Bot√£o" para criar op√ß√µes de produtos</p>
                                </div>
                            </template>
                            
                            <div class="space-y-3" x-show="newCampaign.buttons && newCampaign.buttons.length > 0">
                                <template x-for="(button, index) in newCampaign.buttons" :key="index">
                                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-bold text-emerald-400">
                                                <i class="fas fa-tag mr-1"></i>
                                                Bot√£o <span x-text="index + 1"></span>
                                            </span>
                                            <button type="button" 
                                                    @click="newCampaign.buttons.splice(index, 1)"
                                                    class="text-xs text-red-400 hover:text-red-300">
                                                <i class="fas fa-trash mr-1"></i>
                                                Remover
                                            </button>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <div class="md:col-span-2">
                                                <label class="block text-xs text-gray-400 mb-1">Texto do Bot√£o</label>
                                                <input type="text" 
                                                       x-model="button.text"
                                                       class="form-input text-sm"
                                                       placeholder="Ex: Comprar Produto Premium">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-400 mb-1">Pre√ßo (R$)</label>
                                                <input type="number" 
                                                       x-model.number="button.price"
                                                       step="0.01"
                                                       min="0"
                                                       class="form-input text-sm font-mono font-bold"
                                                       placeholder="19.97">
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <label class="block text-xs text-gray-400 mb-1">Descri√ß√£o do Produto</label>
                                            <input type="text" 
                                                   x-model="button.description"
                                                   class="form-input text-sm"
                                                   placeholder="Acesso completo + B√¥nus exclusivos">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-users mr-2 text-yellow-500"></i>
                                    P√∫blico-Alvo
                                </label>
                                <select x-model="newCampaign.target_audience" class="form-input">
                                    <option value="non_buyers">N√£o compraram</option>
                                    <option value="abandoned_cart">Carrinho abandonado</option>
                                    <option value="inactive">Inativos</option>
                                    <option value="all">Todos</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-clock mr-2 text-yellow-500"></i>
                                    Dias sem contato
                                </label>
                                <input type="number" x-model="newCampaign.days_since_last_contact" class="form-input" placeholder="3">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" 
                                       x-model="newCampaign.exclude_buyers"
                                       class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-yellow-500">
                                <span class="text-sm text-white font-semibold">
                                    <i class="fas fa-user-slash mr-1 text-red-400"></i>
                                    Excluir compradores
                                </span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">N√£o enviar para quem j√° comprou</p>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="showCreateModal = false" 
                                    class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button @click="createCampaign()" 
                                    :disabled="!newCampaign.name || !newCampaign.message"
                                    :class="{'opacity-50 cursor-not-allowed': !newCampaign.name || !newCampaign.message}"
                                    class="btn-action btn-action-success">
                                <i class="fas fa-plus"></i>
                                Criar Campanha
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Estat√≠sticas da Campanha -->
        <div x-show="showStatsModal" 
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             style="background: rgba(0,0,0,0.9);">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div @click.away="showStatsModal = false" 
                     class="bg-gray-900 rounded-2xl max-w-4xl w-full p-8 border-2 border-yellow-500">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                                <i class="fas fa-chart-line text-yellow-500"></i>
                                Estat√≠sticas da Campanha
                            </h3>
                            <p class="text-sm text-gray-500 mt-1" x-text="selectedCampaign?.name"></p>
                        </div>
                        <button @click="showStatsModal = false" class="text-gray-500 hover:text-white">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <!-- M√©tricas Principais -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-blue-400" x-text="selectedCampaign?.total_targets || 0"></div>
                            <div class="text-sm text-gray-500 mt-1">Total de Alvos</div>
                        </div>
                        
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-green-400" x-text="selectedCampaign?.total_sent || 0"></div>
                            <div class="text-sm text-gray-500 mt-1">Mensagens Enviadas</div>
                        </div>
                        
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-purple-400" x-text="selectedCampaign?.total_clicks || 0"></div>
                            <div class="text-sm text-gray-500 mt-1">Total de Cliques</div>
                        </div>
                        
                        <div class="text-center p-5 bg-gray-800 border border-gray-700 rounded-xl">
                            <div class="text-3xl font-bold text-yellow-500" x-text="'R$ ' + (selectedCampaign?.revenue_generated || 0).toFixed(2)"></div>
                            <div class="text-sm text-gray-500 mt-1">Receita Gerada</div>
                        </div>
                    </div>

                    <!-- Taxas e Performance -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-2xl font-bold text-green-300" x-text="getCampaignDeliveryRate(selectedCampaign) + '%'"></div>
                            <div class="text-xs text-gray-500 mt-1">Taxa de Entrega</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-2xl font-bold text-blue-300" x-text="getCampaignClickRate(selectedCampaign) + '%'"></div>
                            <div class="text-xs text-gray-500 mt-1">Taxa de Cliques</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-2xl font-bold text-purple-300" x-text="getCampaignConversionRate(selectedCampaign) + '%'"></div>
                            <div class="text-xs text-gray-500 mt-1">Taxa de Convers√£o</div>
                        </div>
                    </div>

                    <!-- Detalhes Adicionais -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">Falhas no Envio</div>
                            <div class="text-xl font-bold text-red-400" x-text="selectedCampaign?.total_failed || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">Usu√°rios Bloqueados</div>
                            <div class="text-xl font-bold text-gray-400" x-text="selectedCampaign?.total_blocked || 0"></div>
                        </div>
                        
                        <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">Status</div>
                            <div class="text-xl font-bold" :class="{
                                'text-yellow-400': selectedCampaign?.status === 'draft',
                                'text-green-400': selectedCampaign?.status === 'sending',
                                'text-gray-400': selectedCampaign?.status === 'completed'
                            }" x-text="getStatusLabel(selectedCampaign?.status)"></div>
                        </div>
                    </div>

                    <!-- Info da Campanha -->
                    <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg mb-6">
                        <h4 class="text-sm font-bold text-white mb-3">Detalhes da Campanha</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-500">P√∫blico-Alvo:</span>
                                <span class="text-white ml-2" x-text="getAudienceLabel(selectedCampaign?.target_audience)"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">Delay:</span>
                                <span class="text-white ml-2" x-text="selectedCampaign?.days_since_last_contact + ' dias'"></span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <span class="text-gray-500">Mensagem:</span>
                            <p class="text-white mt-1 text-sm bg-gray-900 p-3 rounded" x-text="selectedCampaign?.message"></p>
                        </div>
                    </div>

                    <!-- An√°lise de Performance -->
                    <div class="p-4 rounded-lg" :class="{
                        'bg-green-500 bg-opacity-10 border border-green-500': getCampaignClickRate(selectedCampaign) > 10,
                        'bg-blue-500 bg-opacity-10 border border-blue-500': getCampaignClickRate(selectedCampaign) <= 10 && getCampaignClickRate(selectedCampaign) > 5,
                        'bg-yellow-500 bg-opacity-10 border border-yellow-500': getCampaignClickRate(selectedCampaign) <= 5
                    }">
                        <p class="text-sm">
                            <i class="fas fa-lightbulb mr-2"></i>
                            <strong>An√°lise:</strong>
                            <span x-show="getCampaignClickRate(selectedCampaign) > 10">üéâ Excelente performance! Continue com esse tipo de mensagem.</span>
                            <span x-show="getCampaignClickRate(selectedCampaign) <= 10 && getCampaignClickRate(selectedCampaign) > 5">üëç Boa performance! Teste varia√ß√µes para melhorar ainda mais.</span>
                            <span x-show="getCampaignClickRate(selectedCampaign) <= 5">üí° Performance pode melhorar. Teste mensagens mais diretas e ofertas melhores.</span>
                        </p>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button @click="showStatsModal = false" 
                                class="px-6 py-2 bg-yellow-500 text-black rounded-lg hover:bg-yellow-400 font-bold">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Settings (Trocar Token) -->
    <div x-show="activeTab === 'settings'" x-cloak>
        <div class="config-section">
            <div class="config-section-header">
                <i class="fas fa-cog text-2xl text-gray-400"></i>
                <div>
                    <div class="config-section-title">Configura√ß√µes do Bot</div>
                    <div class="config-section-description">Token do Telegram e configura√ß√µes avan√ßadas</div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Trocar Token -->
                <div class="p-6 bg-gray-900 border-2 border-red-500 rounded-xl">
                    <div class="flex items-start gap-3 mb-6 p-4 bg-red-500 bg-opacity-15 rounded-lg border-l-4 border-red-500">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                        <div>
                            <h3 class="text-xl font-bold text-red-400 mb-2">Trocar Token do Bot</h3>
                            <p class="text-sm text-white font-medium mb-3">
                                Use esta op√ß√£o se voc√™ precisa reconectar o bot ou trocar para um novo token do BotFather.
                            </p>
                            <div class="p-3 bg-red-600 bg-opacity-30 rounded-lg border border-red-400">
                                <p class="text-sm text-white font-bold">
                                    <i class="fas fa-skull-crossbones mr-2 text-red-300"></i>
                                    <strong class="text-red-300">ATEN√á√ÉO CR√çTICA:</strong> Ao trocar o token, voc√™ estar√° criando um novo bot no Telegram. 
                                    <strong class="text-yellow-300">TODOS os usu√°rios que j√° interagiram com o bot anterior ser√£o RESETADOS</strong> e precisar√£o iniciar uma nova conversa com o novo bot!
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key mr-2" style="color: var(--brand-gold-500);"></i>
                            <span class="text-white font-bold">Novo Token do Telegram</span>
                        </label>
                        <input type="text" 
                               x-model="newBotToken" 
                               class="form-input font-mono text-white"
                               placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                        <p class="text-sm text-gray-300 mt-2 font-medium">
                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                            Obtenha um novo token com o <strong class="text-blue-400">@BotFather</strong> no Telegram
                        </p>
                    </div>

                    <button @click="changeBotToken()" 
                            :disabled="!newBotToken || loading"
                            :class="{'opacity-50 cursor-not-allowed': !newBotToken || loading}"
                            class="w-full px-4 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition-all flex items-center justify-center gap-2 text-base">
                        <i class="fas fa-sync-alt"></i>
                        <span x-show="!loading">Atualizar Token</span>
                        <span x-show="loading">Atualizando...</span>
                    </button>

                    <div class="mt-4 p-4 bg-green-500 bg-opacity-15 rounded-lg border-l-4 border-green-500">
                        <p class="text-sm text-white font-medium">
                            <i class="fas fa-shield-alt mr-2 text-green-400"></i>
                            <strong class="text-green-400">Seguran√ßa:</strong> O token √© criptografado e nunca ser√° exibido ap√≥s salvo.
                        </p>
                    </div>
                </div>

                <!-- Informa√ß√µes do Bot -->
                <div class="p-6 bg-gray-900 border border-gray-800 rounded-xl">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        Informa√ß√µes do Bot
                    </h3>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Nome:</span>
                            <span class="text-white font-semibold">{{ bot.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Username:</span>
                            <span class="text-white font-mono">@{{ bot.username }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Status:</span>
                            <span class="text-green-400 font-semibold">
                                <i class="fas fa-circle text-xs mr-1"></i>
                                {% if bot.is_active %}Ativo{% else %}Pausado{% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">ID:</span>
                            <span class="text-white font-mono">#{{ bot.id }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ‚úÖ CR√çTICO: Registrar componente no Alpine.js ANTES do Alpine processar o HTML
// ‚úÖ O Alpine.js est√° sendo carregado com defer, ent√£o precisa registrar via alpine:init
// ‚úÖ TAMB√âM tentar registrar imediatamente se Alpine j√° estiver dispon√≠vel
(function() {
    'use strict';
    
    function registerBotConfigApp() {
        if (typeof Alpine === 'undefined' || !Alpine.data) {
            console.error('‚ùå Alpine.js n√£o est√° dispon√≠vel!');
            return false;
        }
        
        console.log('‚úÖ Registrando botConfigApp...');
        Alpine.data('botConfigApp', () => ({
        activeTab: 'welcome',
        loading: false,
        newBotToken: '',  // ‚úÖ NOVO: Para trocar token
        flowViewMode: 'visual',  // ‚úÖ Sempre Visual (Lista removida)
        jsPlumbInstance: null,  // ‚úÖ Inst√¢ncia do jsPlumb
        
        config: {
            welcome_message: '',
            welcome_media_url: '',
            welcome_media_type: 'video',
            welcome_audio_enabled: false,
            welcome_audio_url: '',
            main_buttons: [],
            redirect_buttons: [],
            downsells_enabled: false,
            downsells: [],
            upsells_enabled: false,
            upsells: [],
            access_link: '',
            success_message: '',
            pending_message: '',
            has_meta_pixel: false,  // ‚úÖ Se bot est√° associado a pool com Meta Pixel ativo
            pool_name: null,          // ‚úÖ Nome do pool (se houver)
            flow_enabled: false,      // ‚úÖ Ativar fluxo visual
            flow_steps: [],           // ‚úÖ Steps do fluxo
            flow_start_step_id: null  // ‚úÖ ID do step inicial do fluxo (/start inicia aqui)
        },
        
        async init() {
            console.log('üîß Bot Config V2.0 inicializando...');
            await this.loadConfig();
            console.log('‚úÖ Config carregado!');
        },
        
        async loadConfig() {
            try {
                console.log('üì° Buscando config da API...');
                const response = await fetch('/api/bots/{{ bot.id }}/config');
                
                console.log('üìä Response status:', response.status);
                
                if (!response.ok) {
                    console.error('‚ùå Erro na resposta:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('‚ùå Erro detalhado:', errorText);
                    return;
                }
                
                const data = await response.json();
                console.log('üì¶ Dados recebidos da API:', data);
                
                if (response.ok) {
                    console.log('‚úÖ Mesclando dados com config atual...');
                    console.log('üîß Config ANTES:', JSON.stringify(this.config, null, 2));
                    
                    this.config = {
                        ...this.config,
                        ...data
                    };
                    
                    // ‚úÖ Garantir que campos de √°udio existem (compatibilidade com configs antigos)
                    if (!this.config.hasOwnProperty('welcome_audio_enabled')) this.config.welcome_audio_enabled = false;
                    if (!this.config.hasOwnProperty('welcome_audio_url')) this.config.welcome_audio_url = '';
                    
                    console.log('üîß Config DEPOIS:', JSON.stringify(this.config, null, 2));
                    
                    // ‚úÖ Migrar order_bump para order_bumps array
                    if (Array.isArray(this.config.main_buttons)) {
                        this.config.main_buttons.forEach(button => {
                            // Migrar order_bump antigo para order_bumps array
                            if (button.hasOwnProperty('order_bump') && !button.hasOwnProperty('order_bumps')) {
                                if (button.order_bump && button.order_bump.enabled) {
                                    button.order_bumps = [button.order_bump];
                                } else {
                                    button.order_bumps = [];
                                }
                                delete button.order_bump; // Remover estrutura antiga
                            }
                            
                            // Garantir que order_bumps existe
                            if (!button.hasOwnProperty('order_bumps')) {
                                button.order_bumps = [];
                            }
                            
                            // Inicializar cada order bump
                            if (Array.isArray(button.order_bumps)) {
                                button.order_bumps.forEach(orderBump => {
                                    if (!orderBump.hasOwnProperty('enabled')) orderBump.enabled = true;
                                    if (!orderBump.hasOwnProperty('message')) orderBump.message = '';
                                    if (!orderBump.hasOwnProperty('price')) orderBump.price = 0;
                                    if (!orderBump.hasOwnProperty('description')) orderBump.description = '';
                                    if (!orderBump.hasOwnProperty('media_url')) orderBump.media_url = '';
                                    if (!orderBump.hasOwnProperty('media_type')) orderBump.media_type = 'photo';
                                    if (!orderBump.hasOwnProperty('accept_text')) orderBump.accept_text = '';
                                    if (!orderBump.hasOwnProperty('decline_text')) orderBump.decline_text = '';
                                });
                            }
                        });
                    }
                    
                    // ‚úÖ Inicializar campos de downsells (compatibilidade com sistema antigo)
                    if (Array.isArray(this.config.downsells)) {
                        this.config.downsells.forEach(downsell => {
                            if (!downsell.hasOwnProperty('pricing_mode')) downsell.pricing_mode = 'fixed';
                            if (!downsell.hasOwnProperty('discount_percentage')) downsell.discount_percentage = 50;
                            if (!downsell.hasOwnProperty('button_text')) downsell.button_text = '';
                            if (!downsell.hasOwnProperty('media_type')) downsell.media_type = 'video';
                            if (!downsell.hasOwnProperty('audio_enabled')) downsell.audio_enabled = false;
                            if (!downsell.hasOwnProperty('audio_url')) downsell.audio_url = '';
                            if (!downsell.hasOwnProperty('order_bump')) {
                                downsell.order_bump = {
                                    enabled: false,
                                    button_index: null,  // ‚úÖ V2.0: √çndice do bot√£o principal
                                    bump_index: null,    // ‚úÖ V2.0: √çndice do order bump no bot√£o
                                    message: '',
                                    price: 0,
                                    description: '',
                                    media_url: '',
                                    media_type: 'video',
                                    accept_text: '',
                                    decline_text: '',
                                    audio_enabled: false,
                                    audio_url: ''
                                };
                            } else {
                                // Garantir que button_index e bump_index existem (compatibilidade)
                                if (!downsell.order_bump.hasOwnProperty('button_index')) {
                                    downsell.order_bump.button_index = null;
                                }
                                if (!downsell.order_bump.hasOwnProperty('bump_index')) {
                                    downsell.order_bump.bump_index = null;
                                }
                            }
                        });
                    }
                    
                    // Garantir arrays existem
                    if (!this.config.downsells) this.config.downsells = [];
                    if (!this.config.upsells) this.config.upsells = [];
                    
                    // ‚úÖ Inicializar campos de upsells (compatibilidade)
                    if (Array.isArray(this.config.upsells)) {
                        this.config.upsells.forEach(upsell => {
                            if (!upsell.hasOwnProperty('media_type')) upsell.media_type = 'video';
                            if (!upsell.hasOwnProperty('audio_enabled')) upsell.audio_enabled = false;
                            if (!upsell.hasOwnProperty('audio_url')) upsell.audio_url = '';
                        });
                    }
                    
                    // ‚úÖ Garantir campos de fluxo existem (compatibilidade)
                    if (!this.config.hasOwnProperty('flow_enabled')) this.config.flow_enabled = false;
                    if (!this.config.hasOwnProperty('flow_steps')) this.config.flow_steps = [];
                    if (!Array.isArray(this.config.flow_steps)) this.config.flow_steps = [];
                    if (!this.config.hasOwnProperty('flow_start_step_id')) this.config.flow_start_step_id = null;
                    
                    // ‚úÖ Inicializar steps do fluxo
                    if (Array.isArray(this.config.flow_steps)) {
                        this.config.flow_steps.forEach(step => {
                            if (!step.hasOwnProperty('id')) step.id = `step_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            if (!step.hasOwnProperty('name')) step.name = null;
                            if (!step.hasOwnProperty('type')) step.type = 'content';
                            if (!step.hasOwnProperty('order')) step.order = 0;
                            if (!step.hasOwnProperty('config')) step.config = {};
                            if (!step.hasOwnProperty('connections')) step.connections = {};
                            if (!step.hasOwnProperty('delay_seconds')) step.delay_seconds = 0;
                        });
                        
                        // ‚úÖ Auto-definir step inicial se n√£o existe e fluxo est√° ativo
                        if (this.config.flow_enabled && this.config.flow_steps.length > 0 && !this.config.flow_start_step_id) {
                            const sortedSteps = [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                            let startStep = null;
                            // Buscar step com order=1 primeiro
                            for (const step of sortedSteps) {
                                if (step.order === 1) {
                                    startStep = step;
                                    break;
                                }
                            }
                            // Se n√£o encontrou order=1, usar primeiro step
                            if (!startStep && sortedSteps.length > 0) {
                                startStep = sortedSteps[0];
                            }
                            if (startStep) {
                                this.config.flow_start_step_id = startStep.id;
                                console.log(`‚úÖ Step inicial auto-definido: ${startStep.id} (order=${startStep.order || 0})`);
                            }
                        }
                    }
                    
                    console.log('‚úÖ Config final carregado com sucesso!');
                    console.log('üìä Config completo:', this.config);
                } else {
                    console.error('‚ùå Erro na resposta da API:', data);
                    alert('‚ùå Erro ao carregar configura√ß√£o. Verifique o console do navegador (F12).');
                }
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO ao carregar config:', error);
                console.error('Stack:', error.stack);
                alert('‚ùå Erro ao carregar configura√ß√£o: ' + error.message + '\nAbra o console (F12) para mais detalhes.');
            }
        },
        
        // ‚úÖ VALIDA√á√ÉO: Mensagem de boas-vindas (preservar emojis e caracteres especiais)
        validateWelcomeMessage() {
            if (!this.config.welcome_message) {
                return;
            }
            
            // ‚úÖ REMOVIDO: Sanitiza√ß√£o que corrompia emojis e caracteres especiais
            // O texto √© preservado como est√° (Telegram e banco suportam UTF-8 completo)
            // N√£o aplicar stripSurrogateChars - estava corrompendo emojis v√°lidos
            
            // ‚úÖ REMOVIDO: Valida√ß√£o restritiva - permitir testar m√≠dia com texto > 1024
            // Apenas aviso se exceder 4096 (limite absoluto do Telegram)
            if (this.config.welcome_message.length > 4096) {
                this.config.welcome_message = this.config.welcome_message.slice(0, 4096);
                console.warn(`‚ö†Ô∏è Mensagem truncada para 4096 caracteres (limite absoluto do Telegram)`);
            }
        },
        
        // ‚úÖ OBTER TAMANHO: Mensagem de boas-vindas
        getWelcomeMessageLength() {
            if (!this.config.welcome_message) {
                return 0;
            }
            return this.config.welcome_message.length;
        },
        
        async saveConfig() {
            console.log('üîÑ Iniciando salvamento de configura√ß√£o...');
            this.loading = true;
            
            try {
                // ‚úÖ VALIDA√á√ÉO: Apenas verificar limite absoluto do Telegram (4096)
                if (this.config.welcome_message && this.config.welcome_message.length > 4096) {
                    alert(`‚ùå Mensagem muito longa! O m√°ximo √© 4096 caracteres (Telegram). Voc√™ tem ${this.config.welcome_message.length} caracteres.`);
                    this.loading = false;
                    return;
                }
                
                // ‚úÖ AVISO: Se tem m√≠dia e texto > 1024, apenas avisar (n√£o bloquear)
                if (this.config.welcome_media_url && this.config.welcome_message && this.config.welcome_message.length > 1024) {
                    console.warn(`‚ö†Ô∏è Testando: Mensagem com m√≠dia tem ${this.config.welcome_message.length} caracteres (recomendado: 1024 para caption)`);
                }
                
                console.log('üìä Dados a serem enviados:', this.config);
                
                const response = await fetch('/api/bots/{{ bot.id }}/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.config)
                });
                
                console.log('üì° Resposta recebida:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('üìä Dados da resposta:', data);
                
                if (response.ok) {
                    console.log('‚úÖ Configura√ß√µes salvas com sucesso!');
                    this.showNotification('‚úÖ Configura√ß√µes salvas!', 'success');
                } else {
                    console.error('‚ùå Erro na resposta:', data);
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                console.error('üí• Erro na requisi√ß√£o:', error);
                alert('Erro: ' + error.message);
            } finally {
                console.log('üèÅ Finalizando salvamento...');
                this.loading = false;
            }
        },
        
        addButton() {
            this.config.main_buttons.push({
                text: '',
                price: 0,
                description: '',
                order_bumps: []  // ‚úÖ ARRAY DE ORDER BUMPS
            });
        },
        
        addOrderBump(buttonIndex) {
            if (!this.config.main_buttons[buttonIndex].order_bumps) {
                this.config.main_buttons[buttonIndex].order_bumps = [];
            }
            
            this.config.main_buttons[buttonIndex].order_bumps.push({
                enabled: true,
                message: '',
                price: 0,
                description: '',
                media_url: '',
                media_type: 'photo',
                accept_text: '',
                decline_text: ''
            });
        },
        
        removeOrderBump(buttonIndex, bumpIndex) {
            if (confirm('Remover este order bump?')) {
                this.config.main_buttons[buttonIndex].order_bumps.splice(bumpIndex, 1);
            }
        },
        
        removeButton(index) {
            if (confirm('Remover este produto?')) {
                this.config.main_buttons.splice(index, 1);
            }
        },
        
        addRedirectButton() {
            this.config.redirect_buttons.push({
                text: '',
                url: ''
            });
        },
        
        removeRedirectButton(index) {
            this.config.redirect_buttons.splice(index, 1);
        },
        
        addDownsell() {
            this.config.downsells.push({
                delay_minutes: 5,
                message: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                pricing_mode: 'fixed',
                price: 0,
                discount_percentage: 50,
                button_text: '',
                order_bump: {
                    enabled: false,
                    button_index: null,  // ‚úÖ V2.0: √çndice do bot√£o principal
                    bump_index: null,    // ‚úÖ V2.0: √çndice do order bump no bot√£o
                    message: '',
                    price: 0,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: '',
                    decline_text: '',
                    audio_enabled: false,
                    audio_url: ''
                }
            });
        },
        
        // ‚úÖ V2.0: Extrair Order Bumps dos Bot√µes Principais
        getAvailableOrderBumps() {
            const available = [];
            if (!Array.isArray(this.config.main_buttons)) {
                return available;
            }
            
            this.config.main_buttons.forEach((button, buttonIndex) => {
                if (Array.isArray(button.order_bumps)) {
                    button.order_bumps.forEach((orderBump, bumpIndex) => {
                        if (orderBump.enabled !== false) {  // Considerar apenas os ativos
                            available.push({
                                buttonIndex: buttonIndex,
                                bumpIndex: bumpIndex,
                                orderBump: orderBump,
                                buttonText: button.text || `Bot√£o ${buttonIndex + 1}`
                            });
                        }
                    });
                }
            });
            
            return available;
        },
        
        // ‚úÖ V2.0: Usar Order Bump dos Bot√µes Principais no Downsell
        useOrderBumpFromButtons(downsell, buttonIndex, bumpIndex) {
            if (!this.config.main_buttons || !this.config.main_buttons[buttonIndex]) {
                alert('Bot√£o n√£o encontrado');
                return;
            }
            
            const button = this.config.main_buttons[buttonIndex];
            if (!button.order_bumps || !button.order_bumps[bumpIndex]) {
                alert('Order bump n√£o encontrado');
                return;
            }
            
            const orderBump = button.order_bumps[bumpIndex];
            
            // Debug: Log dos dados originais
            console.log('üì¶ Order Bump original:', orderBump);
            console.log('üí∞ Pre√ßo original:', orderBump.price, 'Tipo:', typeof orderBump.price);
            
            // Garantir que order_bump existe no downsell
            if (!downsell.order_bump) {
                downsell.order_bump = {
                    enabled: false,
                    button_index: null,
                    bump_index: null,
                    message: '',
                    price: 0,
                    description: '',
                    media_url: '',
                    media_type: 'video',
                    accept_text: '',
                    decline_text: '',
                    audio_enabled: false,
                    audio_url: ''
                };
            }
            
            // Copiar dados do order bump dos bot√µes para o downsell
            downsell.order_bump.button_index = buttonIndex;
            downsell.order_bump.bump_index = bumpIndex;
            downsell.order_bump.message = orderBump.message || '';
            
            // ‚úÖ Tratamento robusto do pre√ßo
            let priceValue = 0;
            if (orderBump.price !== null && orderBump.price !== undefined && orderBump.price !== '') {
                priceValue = parseFloat(orderBump.price);
                if (isNaN(priceValue)) {
                    priceValue = 0;
                }
            }
            downsell.order_bump.price = priceValue;
            
            downsell.order_bump.description = orderBump.description || '';
            downsell.order_bump.media_url = orderBump.media_url || '';
            downsell.order_bump.media_type = orderBump.media_type || 'photo';
            downsell.order_bump.accept_text = orderBump.accept_text || '';
            downsell.order_bump.decline_text = orderBump.decline_text || '';
            downsell.order_bump.audio_enabled = orderBump.audio_enabled || false;
            downsell.order_bump.audio_url = orderBump.audio_url || '';
            
            // Ativar automaticamente
            downsell.order_bump.enabled = true;
            
            console.log(`‚úÖ Order bump do Bot√£o ${buttonIndex + 1} - OB ${bumpIndex + 1} aplicado ao downsell`);
            console.log('üìä Dados copiados:', downsell.order_bump);
        },
        
        removeDownsell(index) {
            this.config.downsells.splice(index, 1);
        },
        
        addUpsell() {
            this.config.upsells.push({
                trigger_product: '',
                delay_minutes: 0,
                message: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                product_name: '',
                price: 0,
                button_text: ''
            });
        },
        
        removeUpsell(index) {
            this.config.upsells.splice(index, 1);
        },
        
        // ‚úÖ NOVO: Trocar Token do Bot
        async changeBotToken() {
            if (!this.newBotToken.trim()) {
                this.showNotification('Digite um token v√°lido', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO CR√çTICA!\n\nAo trocar o token, voc√™ criar√° um NOVO BOT no Telegram.\n\nTODOS os usu√°rios que j√° interagiram com o bot anterior ser√£o RESETADOS e precisar√£o iniciar uma nova conversa!\n\nTem CERTEZA que deseja continuar?')) {
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/token', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: this.newBotToken.trim() })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.showNotification('‚úÖ Token atualizado! Bot reconectando...', 'success');
                    this.newBotToken = '';
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    this.showNotification('Erro: ' + (data.error || 'Token inv√°lido'), 'error');
                }
            } catch (error) {
                this.showNotification('Erro ao atualizar token: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },
        
        // ‚úÖ FLUXO VISUAL - Fun√ß√µes de gerenciamento
        onFlowToggle() {
            if (!this.config.flow_enabled) {
                if (this.config.flow_steps && this.config.flow_steps.length > 0) {
                    if (!confirm('‚ö†Ô∏è Ao desativar o fluxo, os steps n√£o ser√£o removidos, mas n√£o ser√£o executados.\n\nDeseja continuar?')) {
                        this.config.flow_enabled = true;
                        return;
                    }
                }
            } else {
                if (!this.config.flow_steps || this.config.flow_steps.length === 0) {
                    if (confirm('üìù Voc√™ ainda n√£o tem steps configurados. Deseja adicionar o primeiro step agora?')) {
                        this.addFlowStep();
                    } else {
                        this.config.flow_enabled = false;
                        return;
                    }
                }
                
                // ‚úÖ AUTO-DEFINIR STEP INICIAL quando fluxo √© ativado
                if (this.config.flow_steps && this.config.flow_steps.length > 0 && !this.config.flow_start_step_id) {
                    const sortedSteps = [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                    let startStep = null;
                    // Buscar step com order=1 primeiro
                    for (const step of sortedSteps) {
                        if (step.order === 1) {
                            startStep = step;
                            break;
                        }
                    }
                    // Se n√£o encontrou order=1, usar primeiro step
                    if (!startStep && sortedSteps.length > 0) {
                        startStep = sortedSteps[0];
                    }
                    if (startStep) {
                        this.config.flow_start_step_id = startStep.id;
                        this.showNotification(`‚úÖ Step inicial definido automaticamente: ${this.getStepTitle(startStep.type)} (order=${startStep.order || 0})`, 'success');
                    }
                }
            }
        },
        
        // ‚úÖ Definir step como inicial
        setFlowStartStep(stepId) {
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) {
                this.showNotification('‚ùå Step n√£o encontrado', 'error');
                return;
            }
            
            // Validar se step n√£o √© do tipo 'access' (n√£o faz sentido ser inicial)
            if (step.type === 'access') {
                if (!confirm('‚ö†Ô∏è Step do tipo "Acesso" n√£o deve ser inicial (ele libera acesso e finaliza o fluxo).\n\nDeseja continuar mesmo assim?')) {
                    return;
                }
            }
            
            this.config.flow_start_step_id = stepId;
            this.showNotification(`‚úÖ Step inicial definido: ${this.getStepTitle(step.type)} (order=${step.order || 0})`, 'success');
        },
        
        get sortedFlowSteps() {
            if (!this.config.flow_steps || !Array.isArray(this.config.flow_steps)) return [];
            return [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
        },
        
        getStepIcon(type) {
            const icons = {'content': 'üì∏', 'payment': 'üí∞', 'message': 'üí¨', 'audio': 'üéµ', 'video': 'üé•', 'buttons': 'üîò', 'access': '‚úÖ'};
            return icons[type] || 'üì¶';
        },
        
        initVisualFlowEditor() {
            /**
             * ‚úÖ QI 500: Editor Visual de Fluxo com jsPlumb
             * Renderiza steps como blocos arrast√°veis com conex√µes visuais
             * ‚úÖ PAN (arrastar canvas) e ZOOM (scroll para aumentar/diminuir)
             */
            console.log('üé® Inicializando editor visual...');
            const self = this;
            const canvas = document.getElementById('flow-visual-canvas');
            if (!canvas) {
                console.error('‚ùå Canvas n√£o encontrado!');
                return;
            }
            
            console.log('‚úÖ Canvas encontrado:', canvas);
            console.log('üìä Steps dispon√≠veis:', this.sortedFlowSteps.length);
            
            // ‚úÖ PAN E ZOOM: Estado inicial
            let canvasState = {
                isPanning: false,
                startX: 0,
                startY: 0,
                scrollLeft: 0,
                scrollTop: 0,
                zoom: 1.0,
                minZoom: 0.5,
                maxZoom: 2.0,
                zoomStep: 0.1
            };
            
            // ‚úÖ CR√çTICO: Flag para indicar quando est√° arrastando conex√£o (endpoint)
            // ‚úÖ Isso previne que PAN interfira com o drag de conex√µes do jsPlumb
            let isDraggingConnection = false;
            
            // ‚úÖ PAN: Iniciar arrasto do canvas (clicar e segurar no canvas vazio)
            const startPan = (e) => {
                // ‚úÖ CR√çTICO: N√ÉO iniciar PAN se estiver arrastando conex√£o ou endpoint
                if (isDraggingConnection) return;
                
                // Verificar se clicou no canvas vazio (n√£o em um card)
                const target = e.target;
                if (target === canvas || target.closest('#flow-visual-canvas') === canvas) {
                    // ‚úÖ CR√çTICO: Verificar se n√£o clicou em endpoint (bolinha verde/vermelha)
                    const isEndpoint = target.closest('.jtk-endpoint') || 
                                      target.closest('.step-input-endpoint') || 
                                      target.closest('.step-output-endpoint') || 
                                      target.closest('.btn-visual-endpoint') ||
                                      target.classList.contains('jtk-endpoint') ||
                                      target.classList.contains('step-input-endpoint') ||
                                      target.classList.contains('step-output-endpoint') ||
                                      target.classList.contains('btn-visual-endpoint');
                    
                    // Verificar se n√£o clicou em um card ou bot√£o
                    if (!target.closest('.flow-step-block') && !target.closest('button') && !isEndpoint) {
                        canvasState.isPanning = true;
                        canvasState.startX = e.pageX - canvas.offsetLeft;
                        canvasState.startY = e.pageY - canvas.offsetTop;
                        canvasState.scrollLeft = canvas.scrollLeft;
                        canvasState.scrollTop = canvas.scrollTop;
                        canvas.style.cursor = 'grabbing';
                        canvas.style.userSelect = 'none';
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }
            };
            
            // ‚úÖ PAN: Arrastar canvas
            const pan = (e) => {
                // ‚úÖ CR√çTICO: N√ÉO fazer PAN se estiver arrastando conex√£o
                if (isDraggingConnection || !canvasState.isPanning) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const x = e.pageX - canvas.offsetLeft;
                const y = e.pageY - canvas.offsetTop;
                
                const walkX = (x - canvasState.startX) * 1.5; // Velocidade do pan
                const walkY = (y - canvasState.startY) * 1.5;
                
                canvas.scrollLeft = canvasState.scrollLeft - walkX;
                canvas.scrollTop = canvasState.scrollTop - walkY;
            };
            
            // ‚úÖ PAN: Parar arrasto
            const stopPan = (e) => {
                // ‚úÖ CR√çTICO: N√ÉO parar PAN se estiver arrastando conex√£o
                if (isDraggingConnection) return;
                
                if (canvasState.isPanning) {
                    canvasState.isPanning = false;
                    canvas.style.cursor = 'default';
                    canvas.style.userSelect = 'none';
                }
            };
            
            // ‚úÖ ZOOM: Aplicar zoom no canvas e elementos
            const applyZoom = (delta) => {
                const oldZoom = canvasState.zoom;
                canvasState.zoom += delta;
                canvasState.zoom = Math.max(canvasState.minZoom, Math.min(canvasState.maxZoom, canvasState.zoom));
                
                if (oldZoom !== canvasState.zoom) {
                    // ‚úÖ Aplicar zoom via CSS transform no container interno (melhor performance)
                    // Criar ou usar container interno para zoom
                    let zoomContainer = canvas.querySelector('.zoom-container');
                    if (!zoomContainer) {
                        // Criar container se n√£o existir
                        zoomContainer = document.createElement('div');
                        zoomContainer.className = 'zoom-container';
                        zoomContainer.style.width = '100%';
                        zoomContainer.style.height = '100%';
                        zoomContainer.style.position = 'relative';
                        zoomContainer.style.transformOrigin = 'top left';
                        
                        // Mover conte√∫do do canvas para o container
                        while (canvas.firstChild) {
                            zoomContainer.appendChild(canvas.firstChild);
                        }
                        canvas.appendChild(zoomContainer);
                    }
                    
                    // Aplicar transform no container
                    zoomContainer.style.transform = `scale(${canvasState.zoom})`;
                    zoomContainer.style.transformOrigin = 'top left';
                    
                    // Ajustar largura/altura do container baseado no zoom
                    const contentWidth = zoomContainer.scrollWidth || canvas.scrollWidth;
                    const contentHeight = zoomContainer.scrollHeight || canvas.scrollHeight;
                    zoomContainer.style.width = `${contentWidth * canvasState.zoom}px`;
                    zoomContainer.style.height = `${contentHeight * canvasState.zoom}px`;
                    
                    // Redesenhar conex√µes do jsPlumb ap√≥s zoom
                    if (this.jsPlumbInstance) {
                        setTimeout(() => {
                            try {
                                if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                    this.jsPlumbInstance.repaintEverything();
                                } else if (typeof this.jsPlumbInstance.repaint === 'function') {
                                    this.jsPlumbInstance.repaint();
                                }
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Erro ao redesenhar ap√≥s zoom:', e);
                            }
                        }, 50);
                    }
                    
                    console.log(`üîç Zoom: ${(canvasState.zoom * 100).toFixed(0)}%`);
                }
            };
            
            // ‚úÖ ZOOM: Scroll do mouse para aumentar/diminuir
            const handleZoom = (e) => {
                // Verificar se n√£o est√° arrastando o canvas (pan)
                if (canvasState.isPanning) return;
                
                // Verificar se n√£o est√° arrastando um card
                if (globalDragState.isDragging) return;
                
                // Verificar se n√£o est√° sobre um card ou bot√£o (permitir zoom mesmo assim, mas n√£o prevenir default)
                const target = e.target;
                const isOverInteractive = target.closest('.flow-step-block') || target.closest('button') || target.closest('.jtk-endpoint');
                
                // Se n√£o estiver sobre elemento interativo, prevenir scroll padr√£o e aplicar zoom
                if (!isOverInteractive) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Detectar dire√ß√£o do scroll (Ctrl+Scroll ou apenas Scroll)
                    const delta = e.deltaY > 0 ? -canvasState.zoomStep : canvasState.zoomStep;
                    applyZoom(delta);
                }
            };
            
            // ‚úÖ Event listeners para PAN
            canvas.addEventListener('mousedown', startPan);
            canvas.addEventListener('mousemove', pan);
            canvas.addEventListener('mouseup', stopPan);
            canvas.addEventListener('mouseleave', stopPan);
            
            // ‚úÖ Event listeners para PAN (touch)
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    startPan({
                        target: e.target,
                        pageX: touch.pageX,
                        pageY: touch.pageY,
                        preventDefault: () => e.preventDefault(),
                        stopPropagation: () => e.stopPropagation()
                    });
                }
            }, { passive: false });
            
            canvas.addEventListener('touchmove', (e) => {
                if (canvasState.isPanning && e.touches.length === 1) {
                    const touch = e.touches[0];
                    pan({
                        pageX: touch.pageX,
                        pageY: touch.pageY,
                        preventDefault: () => e.preventDefault(),
                        stopPropagation: () => e.stopPropagation()
                    });
                }
            }, { passive: false });
            
            canvas.addEventListener('touchend', stopPan);
            canvas.addEventListener('touchcancel', stopPan);
            
            // ‚úÖ Event listener para ZOOM (scroll do mouse)
            canvas.addEventListener('wheel', handleZoom, { passive: false });
            
            // ‚úÖ Controle global de drag state - garantir que apenas um card seja arrastado por vez
            let globalDragState = {
                isDragging: false,
                draggedElement: null
            };
            
            // ‚úÖ Event listeners para prevenir scroll durante drag
            let scrollPreventionHandlers = {
                wheel: null,
                touchmove: null
            };
            
            // ‚úÖ Fun√ß√£o para prevenir scroll durante drag - SEM position: fixed (evita card pular)
            const preventScrollDuringDrag = (isDragging) => {
                if (isDragging) {
                    // ‚úÖ Apenas desabilitar overflow do canvas (n√£o mexer no body)
                    canvas.style.overflow = 'hidden';
                    canvas.style.touchAction = 'none';
                    
                    // ‚úÖ Prevenir scroll do body sem position: fixed
                    document.body.style.overflow = 'hidden';
                    
                    // ‚úÖ Salvar posi√ß√£o atual do scroll para restaurar depois
                    if (!canvas.dataset.scrollTop) {
                        canvas.dataset.scrollTop = canvas.scrollTop;
                        canvas.dataset.scrollLeft = canvas.scrollLeft;
                    }
                    
                    // ‚úÖ Adicionar event listeners para prevenir scroll via wheel/touch
                    if (!scrollPreventionHandlers.wheel) {
                        scrollPreventionHandlers.wheel = (e) => {
                            // Apenas prevenir se estiver arrastando
                            if (globalDragState.isDragging) {
                                e.preventDefault();
                                e.stopPropagation();
                                return false;
                            }
                        };
                        scrollPreventionHandlers.touchmove = (e) => {
                            // Apenas prevenir se estiver arrastando
                            if (globalDragState.isDragging) {
                                e.preventDefault();
                                e.stopPropagation();
                                return false;
                            }
                        };
                        
                        // Adicionar listeners no canvas e window
                        canvas.addEventListener('wheel', scrollPreventionHandlers.wheel, { passive: false });
                        canvas.addEventListener('touchmove', scrollPreventionHandlers.touchmove, { passive: false });
                        window.addEventListener('wheel', scrollPreventionHandlers.wheel, { passive: false });
                        window.addEventListener('touchmove', scrollPreventionHandlers.touchmove, { passive: false });
                    }
                } else {
                    // ‚úÖ Remover event listeners
                    if (scrollPreventionHandlers.wheel) {
                        canvas.removeEventListener('wheel', scrollPreventionHandlers.wheel);
                        canvas.removeEventListener('touchmove', scrollPreventionHandlers.touchmove);
                        window.removeEventListener('wheel', scrollPreventionHandlers.wheel);
                        window.removeEventListener('touchmove', scrollPreventionHandlers.touchmove);
                        scrollPreventionHandlers.wheel = null;
                        scrollPreventionHandlers.touchmove = null;
                    }
                    
                    // ‚úÖ Restaurar overflow
                    canvas.style.overflow = 'auto';
                    canvas.style.touchAction = 'auto';
                    document.body.style.overflow = '';
                    
                    // ‚úÖ Restaurar posi√ß√£o do scroll se necess√°rio
                    if (canvas.dataset.scrollTop) {
                        canvas.scrollTop = parseInt(canvas.dataset.scrollTop) || 0;
                        canvas.scrollLeft = parseInt(canvas.dataset.scrollLeft) || 0;
                        delete canvas.dataset.scrollTop;
                        delete canvas.dataset.scrollLeft;
                    }
                }
            };
            
            // ‚úÖ Ajustar dimens√µes do canvas para responsividade
            const adjustCanvasSize = () => {
                const container = canvas.parentElement;
                if (container) {
                    // Calcular altura dispon√≠vel baseada na viewport
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;
                    
                    // Altura aproximada dos elementos acima do canvas
                    let headerHeight = 200; // Header padr√£o
                    if (viewportWidth < 640) {
                        headerHeight = 250; // Mobile: mais espa√ßo para header
                    } else if (viewportWidth < 768) {
                        headerHeight = 220; // Tablet
                    }
                    
                    // Altura dispon√≠vel (viewport - header - margens)
                    const availableHeight = viewportHeight - headerHeight - 40; // 40px de margem
                    
                    // Altura m√≠nima e m√°xima baseada no tamanho da tela
                    const minHeight = viewportWidth < 640 ? 350 : viewportWidth < 768 ? 400 : 500;
                    const maxHeight = Math.min(availableHeight, viewportHeight * 0.85); // M√°ximo 85% da viewport
                    
                    // Aplicar altura calculada
                    const finalHeight = Math.max(minHeight, Math.min(maxHeight, availableHeight));
                    canvas.style.height = `${finalHeight}px`;
                    canvas.style.width = '100%';
                    canvas.style.maxWidth = '100%';
                    
                    // Garantir que o container tamb√©m seja 100%
                    if (container) {
                        container.style.width = '100%';
                        container.style.maxWidth = '100%';
                    }
                    
                    console.log(`üìê Canvas ajustado: ${canvas.style.width} x ${canvas.style.height} (viewport: ${viewportWidth}x${viewportHeight})`);
                }
            };
            
            // Ajustar tamanho inicial
            adjustCanvasSize();
            
            // ‚úÖ Ajustar tamanho ao redimensionar a janela (sempre visual agora)
            window.addEventListener('resize', () => {
                adjustCanvasSize();
                // Redesenhar conex√µes ap√≥s resize
                setTimeout(() => {
                    try {
                        if (this.jsPlumbInstance && typeof this.jsPlumbInstance.repaintEverything === 'function') {
                            this.jsPlumbInstance.repaintEverything();
                        } else if (this.jsPlumbInstance && typeof this.jsPlumbInstance.repaint === 'function') {
                            this.jsPlumbInstance.repaint();
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao repaint ap√≥s resize:', e);
                    }
                }, 100);
            });
            
            // Limpar canvas
            canvas.innerHTML = '';
            
            // Aguardar DOM renderizar
            setTimeout(() => {
                try {
                    // ‚úÖ Verificar jsPlumb dispon√≠vel
                    console.log('üîç Verificando jsPlumb...');
                    console.log('typeof jsPlumb:', typeof jsPlumb);
                    console.log('jsPlumb:', typeof jsPlumb !== 'undefined' ? (jsPlumb ? 'EXISTS' : 'null') : 'undefined');
                    console.log('window.jsPlumb:', window.jsPlumb);
                    console.log('window.jsPlumb?.jsPlumb:', window.jsPlumb?.jsPlumb);
                    
                    // jsPlumb 2.x usa API diferente
                    let jsPlumbInstance = null;
                    
                    // ‚úÖ Priorizar jsPlumb 2.x (vers√£o est√°vel do CDN)
                    // jsPlumb 2.x pode estar em window.jsPlumb.jsPlumb ou jsPlumb diretamente
                    if (window.jsPlumb && window.jsPlumb.jsPlumb && typeof window.jsPlumb.jsPlumb.getInstance === 'function') {
                        console.log('‚úÖ Usando window.jsPlumb.jsPlumb 2.x');
                        jsPlumbInstance = window.jsPlumb.jsPlumb.getInstance({
                            container: canvas,
                            paintStyle: { stroke: '#3B82F6', strokeWidth: 2 },
                            hoverPaintStyle: { stroke: '#60A5FA', strokeWidth: 3 },
                            endpointStyle: { fill: '#3B82F6', radius: 5 },
                            endpointHoverStyle: { fill: '#60A5FA', radius: 7 },
                            connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                            anchors: ['Right', 'Left', 'Top', 'Bottom'],
                            maxConnections: -1,
                            // ‚úÖ CR√çTICO: Habilitar drag de conex√µes - linha segue o mouse
                            dragOptions: {
                                cursor: 'crosshair',
                                zIndex: 10000
                            }
                        });
                    } else if (typeof jsPlumb !== 'undefined' && jsPlumb && jsPlumb.jsPlumb && typeof jsPlumb.jsPlumb.getInstance === 'function') {
                        console.log('‚úÖ Usando jsPlumb.jsPlumb 2.x (vers√£o est√°vel)');
                        jsPlumbInstance = jsPlumb.jsPlumb.getInstance({
                            container: canvas,
                            paintStyle: { stroke: '#3B82F6', strokeWidth: 2 },
                            hoverPaintStyle: { stroke: '#60A5FA', strokeWidth: 3 },
                            endpointStyle: { fill: '#3B82F6', radius: 5 },
                            endpointHoverStyle: { fill: '#60A5FA', radius: 7 },
                            connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                            anchors: ['Right', 'Left', 'Top', 'Bottom'],
                            maxConnections: -1,
                            // ‚úÖ CR√çTICO: Habilitar drag de conex√µes - linha segue o mouse
                            dragOptions: {
                                cursor: 'crosshair',
                                zIndex: 10000
                            }
                        });
                    } else if (typeof jsPlumb !== 'undefined' && jsPlumb && typeof jsPlumb.getInstance === 'function') {
                        console.log('‚úÖ Usando jsPlumb global (vers√£o antiga)');
                        jsPlumbInstance = jsPlumb.getInstance({
                            container: canvas
                        });
                    } else if (window.jsPlumb && typeof window.jsPlumb.newInstance === 'function') {
                        console.log('‚úÖ Usando jsPlumb.newInstance()');
                        jsPlumbInstance = window.jsPlumb.newInstance({
                            container: canvas
                        });
                    } else if (window.jsPlumb && typeof window.jsPlumb.getInstance === 'function') {
                        console.log('‚úÖ Usando window.jsPlumb.getInstance()');
                        jsPlumbInstance = window.jsPlumb.getInstance({
                            container: canvas
                        });
                    } else if (window.jsPlumb) {
                        console.log('‚úÖ Usando window.jsPlumb diretamente');
                        jsPlumbInstance = window.jsPlumb;
                        if (typeof jsPlumbInstance.ready === 'function') {
                            jsPlumbInstance.ready(() => {
                                if (typeof jsPlumbInstance.setContainer === 'function') {
                                    jsPlumbInstance.setContainer(canvas);
                                }
                            });
                        }
                    } else {
                        console.error('‚ùå jsPlumb n√£o encontrado! Verificando vari√°veis...');
                        console.error('- typeof jsPlumb:', typeof jsPlumb);
                        console.error('- window.jsPlumb:', window.jsPlumb);
                        console.error('- window.jsPlumb?.jsPlumb:', window.jsPlumb?.jsPlumb);
                        throw new Error('jsPlumb n√£o est√° dispon√≠vel. Verifique se o CDN est√° carregando corretamente.');
                    }
                    
                    if (!jsPlumbInstance) {
                        throw new Error('N√£o foi poss√≠vel criar inst√¢ncia do jsPlumb');
                    }
                    
                    // Destruir inst√¢ncia anterior se existir
                    if (this.jsPlumbInstance) {
                        try {
                            this.jsPlumbInstance.destroy();
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao destruir inst√¢ncia anterior:', e);
                        }
                    }
                    
                    this.jsPlumbInstance = jsPlumbInstance;
                    
                    console.log('‚úÖ Inst√¢ncia jsPlumb criada:', this.jsPlumbInstance);
                    
                    // ‚úÖ Configurar container ANTES de tudo
                    try {
                        if (typeof jsPlumbInstance.setContainer === 'function') {
                            jsPlumbInstance.setContainer(canvas);
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao setar container (pode ser normal):', e);
                    }
                    
                    // ‚úÖ Verificar se jsPlumbInstance foi criado com sucesso
                    if (jsPlumbInstance) {
                        // ‚úÖ Configurar estilos padr√£o
                        const defaultPaintStyle = { stroke: '#3B82F6', strokeWidth: 2 };
                        const defaultHoverPaintStyle = { stroke: '#60A5FA', strokeWidth: 3 };
                        const defaultEndpointStyle = { fill: '#3B82F6', radius: 5 };
                        const defaultEndpointHoverStyle = { fill: '#60A5FA', radius: 7 };
                        
                        // ‚úÖ CR√çTICO: HABILITAR ARRASTE DE CONEX√ïES - linha segue o mouse DURANTE O ARRASTE
                        // ‚úÖ Configurar eventos para rastrear quando est√° arrastando conex√£o
                        try {
                            // jsPlumb 2.x: habilitar drag de conex√µes (linha segue mouse)
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                // ‚úÖ Evento quando COME√áA a arrastar (mousedown na bolinha vermelha)
                                this.jsPlumbInstance.bind('beforeStartConnect', (params, originalEvent) => {
                                    console.log('üéØ Iniciando conex√£o - linha deve seguir mouse:', params);
                                    // ‚úÖ CR√çTICO: Marcar que est√° arrastando conex√£o - previne PAN interferir
                                    isDraggingConnection = true;
                                    // Parar PAN se estiver ativo
                                    if (canvasState.isPanning) {
                                        canvasState.isPanning = false;
                                        canvas.style.cursor = 'crosshair';
                                    }
                                    return true; // Permitir in√≠cio da conex√£o
                                });
                                
                                // ‚úÖ Evento DURANTE o drag (mousemove) - linha segue mouse
                                this.jsPlumbInstance.bind('connectionDrag', (connection, originalEvent) => {
                                    // ‚úÖ CR√çTICO: Linha segue o mouse durante o arraste
                                    if (connection && originalEvent) {
                                        // N√ÉO chamar stopPropagation aqui - permite jsPlumb rastrear mouse
                                        // Apenas atualizar visualmente
                                        if (typeof this.jsPlumbInstance.repaint === 'function') {
                                            // For√ßar repaint para linha seguir mouse
                                            this.jsPlumbInstance.repaint(connection.sourceId, connection.targetId);
                                        }
                                    }
                                });
                                
                                // ‚úÖ Evento quando SOLTA a linha (mouseup)
                                this.jsPlumbInstance.bind('connectionDragStop', (connection, originalEvent) => {
                                    console.log('‚úÖ Conex√£o solta:', connection);
                                    // ‚úÖ CR√çTICO: Desmarcar flag - permite PAN novamente
                                    isDraggingConnection = false;
                                    
                                    if (connection && originalEvent) {
                                        // Repintar para garantir que est√° ordenado
                                        if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                            setTimeout(() => {
                                                this.jsPlumbInstance.repaintEverything();
                                            }, 50);
                                        }
                                    }
                                });
                                
                                // ‚úÖ Evento quando conex√£o √© criada
                                this.jsPlumbInstance.bind('connection', (connectionInfo) => {
                                    console.log('‚úÖ Conex√£o criada:', connectionInfo);
                                    // ‚úÖ Desmarcar flag ap√≥s conex√£o ser criada
                                    isDraggingConnection = false;
                                });
                            }
                            
                            // jsPlumb 2.x: configurar para permitir drop em qualquer target
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('beforeDrop', (params) => {
                                    console.log('üéØ Tentando fazer drop:', params);
                                    // Permitir drop em qualquer target v√°lido
                                    return true;
                                });
                                
                                // ‚úÖ MELHORADO: Remover conex√£o com duplo clique OU bot√£o direito OU arrastar endpoint para desconectar
                                // jsPlumb 2.x usa eventos diferentes
                                this.jsPlumbInstance.bind('connection:dblclick', (conn, event) => {
                                    if (event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                    }
                                    if (confirm('‚ùì Remover esta conex√£o?')) {
                                        try {
                                            this.jsPlumbInstance.deleteConnection(conn);
                                            console.log('‚úÖ Conex√£o removida (duplo clique)');
                                            this.updateStepConnectionsFromConnection(conn);
                                        } catch (e) {
                                            console.error('‚ùå Erro ao remover conex√£o:', e);
                                        }
                                    }
                                });
                                
                                // ‚úÖ Remover conex√£o com bot√£o direito
                                this.jsPlumbInstance.bind('connection:contextmenu', (conn, event) => {
                                    if (event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                    }
                                    if (confirm('‚ùì Remover esta conex√£o?')) {
                                        try {
                                            this.jsPlumbInstance.deleteConnection(conn);
                                            console.log('‚úÖ Conex√£o removida (bot√£o direito)');
                                            this.updateStepConnectionsFromConnection(conn);
                                        } catch (e) {
                                            console.error('‚ùå Erro ao remover conex√£o:', e);
                                        }
                                    }
                                });
                                
                                // ‚úÖ Remover conex√£o ao arrastar endpoint de volta para desconectar (soltar fora de um target v√°lido)
                                this.jsPlumbInstance.bind('beforeStartDetach', (params) => {
                                    // Permitir desconectar e reconectar
                                    return true;
                                });
                                
                                this.jsPlumbInstance.bind('connectionDetached', (info) => {
                                    // Conex√£o desconectada (arrastou endpoint para fora)
                                    console.log('‚úÖ Conex√£o desconectada:', info);
                                    this.updateStepConnectionsFromConnection(info);
                                    // Limpar target_step se for bot√£o customizado
                                    if (info && info.sourceId && info.sourceId.startsWith('btn-endpoint-')) {
                                        const parts = info.sourceId.split('-');
                                        if (parts.length >= 4) {
                                            const stepId = parts.slice(2, -1).join('-');
                                            const btnType = parts[parts.length - 2];
                                            const btnIdx = parseInt(parts[parts.length - 1]);
                                            const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                            if (sourceStep && sourceStep.config && btnType === 'custom' && sourceStep.config.custom_buttons && sourceStep.config.custom_buttons[btnIdx]) {
                                                sourceStep.config.custom_buttons[btnIdx].target_step = '';
                                            }
                                        }
                                    }
                                });
                                
                                // Ap√≥s conectar, garantir ordem correta
                                this.jsPlumbInstance.bind('connection', (info) => {
                                    // Quando uma nova conex√£o √© criada
                                    console.log('‚úÖ Nova conex√£o criada:', info);
                                    
                                    // ‚úÖ Atualizar connections no step
                                    this.updateStepConnectionsFromConnection(info);
                                    
                                    // Repintar tudo para garantir ordem
                                    if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                        setTimeout(() => {
                                            this.jsPlumbInstance.repaintEverything();
                                        }, 50);
                                    }
                                });
                            }
                            
                            // jsPlumb 2.x: Configurar para permitir drag de endpoint (linha segue mouse)
                            if (typeof this.jsPlumbInstance.setSuspendDrawing === 'function') {
                                // Desabilitar desenho suspenso durante drag para melhor performance
                                this.jsPlumbInstance.setSuspendDrawing(false);
                            }
                            
                            // ‚úÖ HABILITAR DRAG DE CONEX√ïES - linha segue mouse ao arrastar da bolinha
                            // jsPlumb 2.x: habilitar interatividade de drag
                            if (typeof this.jsPlumbInstance.importDefaults === 'function') {
                                const defaults = {
                                    Connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                    PaintStyle: { stroke: '#EF4444', strokeWidth: 2 },  // ‚úÖ Mudado para vermelho (sa√≠da)
                                    HoverPaintStyle: { stroke: '#F87171', strokeWidth: 3 },
                                    Endpoint: ['Dot', { radius: 10 }],
                                    EndpointStyle: { fill: '#EF4444', radius: 10 },  // ‚úÖ Mudado para vermelho (sa√≠da)
                                    EndpointHoverStyle: { fill: '#F87171', radius: 12 },
                                    MaxConnections: -1,
                                    AllowNestedGroups: false
                                };
                                this.jsPlumbInstance.importDefaults(defaults);
                            }
                            
                            // ‚úÖ Garantir que drag est√° habilitado globalmente
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                // Habilitar drag ao clicar em endpoint
                                this.jsPlumbInstance.bind('beforeStartDetach', (params) => {
                                    // Permitir desconectar e reconectar
                                    return true;
                                });
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao configurar drag de conex√µes (pode ser normal):', e);
                        }
                        
                        // Tentar configurar (pode variar conforme vers√£o)
                        try {
                            if (typeof this.jsPlumbInstance.setDefaultConnectionType === 'function') {
                                this.jsPlumbInstance.setDefaultConnectionType({
                                    type: 'Flowchart',
                                    options: {
                                        stub: [10, 15],
                                        gap: 5,
                                        cornerRadius: 5,
                                        alwaysRespectStubs: true
                                    }
                                });
                            }
                            
                            if (typeof this.jsPlumbInstance.setDefaultConnectionStyle === 'function') {
                                this.jsPlumbInstance.setDefaultConnectionStyle(defaultPaintStyle);
                            }
                            if (typeof this.jsPlumbInstance.setDefaultConnectionHoverStyle === 'function') {
                                this.jsPlumbInstance.setDefaultConnectionHoverStyle(defaultHoverPaintStyle);
                            }
                            if (typeof this.jsPlumbInstance.setDefaultEndpointStyle === 'function') {
                                this.jsPlumbInstance.setDefaultEndpointStyle(defaultEndpointStyle);
                            }
                            if (typeof this.jsPlumbInstance.setDefaultEndpointHoverStyle === 'function') {
                                this.jsPlumbInstance.setDefaultEndpointHoverStyle(defaultEndpointHoverStyle);
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao configurar estilos padr√£o (pode ser normal):', e);
                        }
                        
                        // ‚úÖ Renderizar steps como blocos
                        const steps = this.sortedFlowSteps;
                        const stepPositions = this.loadStepPositions(); // Carregar posi√ß√µes salvas
                        
                        steps.forEach((step, index) => {
                            const stepId = step.id;
                            const stepName = step.name || this.getStepTitle(step.type);
                            const stepIcon = this.getStepIcon(step.type);
                            const isInitial = this.config.flow_start_step_id === stepId;
                            
                            // Posi√ß√£o (salva ou calculada)
                            const savedPos = stepPositions[stepId];
                            const x = savedPos ? savedPos.x : 100 + (index % 3) * 250;
                            const y = savedPos ? savedPos.y : 100 + Math.floor(index / 3) * 150;
                            
                            // Criar elemento do step
                            const stepEl = document.createElement('div');
                            stepEl.id = `flow-step-${stepId}`;
                            stepEl.className = 'flow-step-block absolute cursor-move bg-gray-800 border-2 rounded-lg p-3 shadow-lg';
                            stepEl.style.left = `${x}px`;
                            stepEl.style.top = `${y}px`;
                            stepEl.style.width = '240px';
                            stepEl.style.zIndex = '10';
                            stepEl.setAttribute('data-step-id', stepId);
                            stepEl.setAttribute('data-step-type', step.type);
                            
                            // Cor baseada no tipo
                            let borderColor = 'border-blue-500';
                            let bgColor = 'bg-blue-900 bg-opacity-30';
                            if (step.type === 'access') borderColor = 'border-purple-500';
                            else if (step.type === 'message') borderColor = 'border-yellow-500';
                            else if (step.type === 'payment') borderColor = 'border-green-500'; // Mantido para compatibilidade com steps existentes
                            
                            stepEl.className += ` ${borderColor} ${bgColor}`;
                            
                            // Conte√∫do do bloco (melhorado para usabilidade)
                            const stepPreview = step.config && step.config.message ? 
                                (step.config.message.substring(0, 40) + (step.config.message.length > 40 ? '...' : '')) : 
                                'Sem conte√∫do';
                            
                            stepEl.innerHTML = `
                                <!-- ‚úÖ Bola VERDE (entrada) sempre vis√≠vel no lado esquerdo -->
                                <div style="position: absolute; left: -12px; top: 20px; width: 18px; height: 18px; background: #10B981; border: 3px solid #059669; border-radius: 50%; cursor: crosshair; z-index: 30; box-shadow: 0 0 10px rgba(16, 185, 129, 0.9);" 
                                     class="step-input-endpoint"
                                     title="üü¢ Endpoint de Entrada - Conecte aqui para receber de outros cards">
                                </div>
                                <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-700">
                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                        ${isInitial ? '<i class="fas fa-star text-yellow-400 text-sm" title="‚≠ê Step Inicial"></i>' : ''}
                                        <span class="text-xl flex-shrink-0">${stepIcon}</span>
                                        <span class="text-white font-bold text-sm truncate" title="${stepName}">${stepName}</span>
                                    </div>
                                    <div class="w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold flex-shrink-0" title="Ordem: ${step.order || index + 1}">
                                        ${step.order || index + 1}
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 mb-2">
                                    ${this.getStepTitle(step.type)}
                                </div>
                                ${stepPreview && stepPreview !== 'Sem conte√∫do' ? `
                                    <div class="text-xs text-gray-500 mb-2 truncate" title="${step.config.message || ''}">
                                        "${stepPreview}"
                                    </div>
                                ` : ''}
                                ${step.conditions && step.conditions.length > 0 ? `
                                    <div class="text-xs text-blue-400 mb-1">
                                        üîÄ ${step.conditions.length} condi√ß√£o(√µes)
                                    </div>
                                ` : ''}
                                ${(() => {
                                    // ‚úÖ Coletar TODOS os bot√µes (customizados + cadastrados)
                                    const allButtons = [];
                                    
                                    // Bot√µes customizados
                                    if (step.config && step.config.custom_buttons) {
                                        step.config.custom_buttons.forEach((btn, idx) => {
                                            allButtons.push({
                                                type: 'custom',
                                                index: idx,
                                                text: btn.text || `Bot√£o ${idx + 1}`,
                                                target_step: btn.target_step,
                                                price: null
                                            });
                                        });
                                    }
                                    
                                    // Bot√µes cadastrados (main_buttons)
                                    if (step.config && step.config.selected_buttons && this.config.main_buttons) {
                                        step.config.selected_buttons.forEach((selected) => {
                                            if (selected.type === 'main' && selected.index !== undefined) {
                                                const mainBtn = this.config.main_buttons[selected.index];
                                                if (mainBtn) {
                                                    allButtons.push({
                                                        type: 'main',
                                                        index: selected.index,
                                                        text: mainBtn.text || `Bot√£o ${selected.index + 1}`,
                                                        target_step: null, // Main buttons n√£o t√™m target_step individual
                                                        price: mainBtn.price
                                                    });
                                                }
                                            }
                                        });
                                    }
                                    
                                    // Bot√µes cadastrados (redirect_buttons)
                                    if (step.config && step.config.selected_buttons && this.config.redirect_buttons) {
                                        step.config.selected_buttons.forEach((selected) => {
                                            if (selected.type === 'redirect' && selected.index !== undefined) {
                                                const redirectBtn = this.config.redirect_buttons[selected.index];
                                                if (redirectBtn) {
                                                    allButtons.push({
                                                        type: 'redirect',
                                                        index: selected.index,
                                                        text: redirectBtn.text || `Link ${selected.index + 1}`,
                                                        target_step: null,
                                                        url: redirectBtn.url
                                                    });
                                                }
                                            }
                                        });
                                    }
                                    
                                    if (allButtons.length === 0) return '';
                                    
                                    return `
                                        <div class="mt-2 mb-2 border-t border-gray-700 pt-2">
                                            <div class="text-xs text-gray-500 mb-2">Bot√µes:</div>
                                            <div class="space-y-1.5">
                                                ${allButtons.map((btn, idx) => `
                                                    <div class="relative group">
                                                        <div class="flex items-center gap-2 pr-6">
                                                            <div class="flex-1 px-3 py-2 bg-red-600 bg-opacity-60 border-2 border-red-500 rounded-lg text-xs font-semibold text-white truncate"
                                                                 title="${btn.text}${btn.price ? ' - R$ ' + parseFloat(btn.price).toFixed(2) : ''}${btn.target_step ? ' ‚Üí Step ' + btn.target_step : ''}">
                                                                ${btn.text.length > 25 ? btn.text.substring(0, 22) + '...' : btn.text}
                                                                ${btn.price ? '<span class="text-xs opacity-90"> (R$ ' + parseFloat(btn.price).toFixed(2) + ')</span>' : ''}
                                                            </div>
                                                            <!-- ‚úÖ Bola VERMELHA (sa√≠da) ao lado direito de cada bot√£o -->
                                                            <div class="btn-visual-endpoint" 
                                                                 data-button-type="${btn.type}"
                                                                 data-button-index="${btn.index}"
                                                                 data-step-id="${stepId}"
                                                                 data-button-visual-idx="${idx}"
                                                                 style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: #EF4444; border: 3px solid #DC2626; border-radius: 50%; cursor: crosshair; z-index: 30; box-shadow: 0 0 10px rgba(239, 68, 68, 0.9); transition: all 0.2s ease;"
                                                                 title="üî¥ Endpoint de Sa√≠da - Arraste para conectar ao endpoint VERDE de outro card">
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                })()}
                                ${(() => {
                                    // ‚úÖ Mostrar bola VERMELHA (sa√≠da) se N√ÉO houver bot√µes
                                    const hasButtons = (step.config && step.config.custom_buttons && step.config.custom_buttons.length > 0) ||
                                                     (step.config && step.config.selected_buttons && step.config.selected_buttons.length > 0);
                                    if (!hasButtons) {
                                        return `
                                            <!-- ‚úÖ Bola VERMELHA (sa√≠da) no lado direito quando n√£o h√° bot√µes -->
                                            <div style="position: absolute; right: -12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: #EF4444; border: 3px solid #DC2626; border-radius: 50%; cursor: crosshair; z-index: 30; box-shadow: 0 0 10px rgba(239, 68, 68, 0.9); transition: all 0.2s ease;" 
                                                 class="step-output-endpoint"
                                                 data-step-id="${stepId}"
                                                 title="üî¥ Endpoint de Sa√≠da - Arraste para conectar ao endpoint VERDE de outro card">
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}
                                <div class="flex items-center gap-1 mt-2">
                                    <button onclick="window.editFlowStepFromVisual('${stepId}')" 
                                            class="flex-1 px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.removeFlowStepFromVisual('${stepId}')" 
                                            class="flex-1 px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            
                            canvas.appendChild(stepEl);
                            
                            // ‚úÖ Tornar arrast√°vel - PREVENIR SCROLL DA P√ÅGINA
                            try {
                                // ‚úÖ Fun√ß√£o auxiliar para verificar se o elemento √© clic√°vel (bot√£o, input, etc)
                                const isClickableElement = (target) => {
                                    if (!target) return false;
                                    const tagName = target.tagName?.toLowerCase();
                                    const isButton = tagName === 'button' || target.closest('button');
                                    const isInput = ['input', 'textarea', 'select', 'a'].includes(tagName) || target.closest('input, textarea, select, a');
                                    const isIcon = target.closest('i.fas, i.far, i.fab');
                                    return isButton || isInput || isIcon;
                                };
                                
                                // ‚úÖ Prevenir scroll durante drag - Desktop
                                const handleMouseDown = (e) => {
                                    // Se clicou em elemento clic√°vel, n√£o iniciar drag
                                    if (isClickableElement(e.target)) {
                                        return;
                                    }
                                    
                                    // ‚úÖ Verificar se j√° h√° outro elemento sendo arrastado
                                    if (globalDragState.isDragging && globalDragState.draggedElement !== stepEl) {
                                        return; // N√£o permitir m√∫ltiplos drags simult√¢neos
                                    }
                                    
                                    // Atualizar estado global
                                    globalDragState.isDragging = true;
                                    globalDragState.draggedElement = stepEl;
                                    
                                    // Adicionar classe dragging para feedback visual
                                    stepEl.classList.add('dragging');
                                    
                                    // Prevenir scroll da p√°gina e do canvas durante drag
                                    preventScrollDuringDrag(true);
                                };
                                
                                const handleMouseUp = () => {
                                    // Remover classe dragging
                                    stepEl.classList.remove('dragging');
                                    
                                    // Atualizar estado global
                                    if (globalDragState.draggedElement === stepEl) {
                                        globalDragState.isDragging = false;
                                        globalDragState.draggedElement = null;
                                    }
                                    
                                    // Restaurar scroll
                                    preventScrollDuringDrag(false);
                                };
                                
                                // ‚úÖ Prevenir scroll durante drag - Mobile/Touch
                                const handleTouchStart = (e) => {
                                    // Se tocou em elemento clic√°vel, n√£o iniciar drag
                                    if (isClickableElement(e.target)) {
                                        return;
                                    }
                                    
                                    // ‚úÖ Verificar se j√° h√° outro elemento sendo arrastado
                                    if (globalDragState.isDragging && globalDragState.draggedElement !== stepEl) {
                                        return;
                                    }
                                    
                                    // Atualizar estado global
                                    globalDragState.isDragging = true;
                                    globalDragState.draggedElement = stepEl;
                                    
                                    // Adicionar classe dragging
                                    stepEl.classList.add('dragging');
                                    
                                    // Prevenir scroll
                                    preventScrollDuringDrag(true);
                                };
                                
                                const handleTouchEnd = () => {
                                    // Remover classe dragging
                                    stepEl.classList.remove('dragging');
                                    
                                    // Atualizar estado global
                                    if (globalDragState.draggedElement === stepEl) {
                                        globalDragState.isDragging = false;
                                        globalDragState.draggedElement = null;
                                    }
                                    
                                    // Restaurar scroll
                                    preventScrollDuringDrag(false);
                                };
                                
                                // ‚úÖ Adicionar event listeners
                                stepEl.addEventListener('mousedown', handleMouseDown, { passive: true });
                                stepEl.addEventListener('mouseup', handleMouseUp, { passive: true });
                                stepEl.addEventListener('mouseleave', handleMouseUp, { passive: true });
                                
                                stepEl.addEventListener('touchstart', handleTouchStart, { passive: false });
                                stepEl.addEventListener('touchend', handleTouchEnd, { passive: true });
                                stepEl.addEventListener('touchcancel', handleTouchEnd, { passive: true });
                                
                                // ‚úÖ Configurar draggable do jsPlumb
                                if (typeof this.jsPlumbInstance.draggable === 'function') {
                                    // jsPlumb 5.x
                                    this.jsPlumbInstance.draggable(stepEl, {
                                        containment: 'parent',
                                        grid: [10, 10],
                                        filter: 'button, input, textarea, select, a, i', // ‚úÖ N√£o arrastar se clicar nestes elementos
                                        drag: (el, e) => {
                                            // ‚úÖ Prevenir scroll durante drag
                                            if (e && e.originalEvent) {
                                                e.originalEvent.preventDefault();
                                                e.originalEvent.stopPropagation();
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            // Garantir que scroll est√° desabilitado
                                            preventScrollDuringDrag(true);
                                            
                                            // Adicionar classe dragging se ainda n√£o tiver
                                            if (!stepEl.classList.contains('dragging')) {
                                                stepEl.classList.add('dragging');
                                            }
                                        },
                                        start: (el, e) => {
                                            // Verificar se n√£o √© elemento clic√°vel
                                            if (e && e.originalEvent && isClickableElement(e.originalEvent.target)) {
                                                return false; // Cancelar drag
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            stepEl.classList.add('dragging');
                                            preventScrollDuringDrag(true);
                                        },
                                        stop: (el, e) => {
                                            // Remover classe dragging
                                            stepEl.classList.remove('dragging');
                                            
                                            // Atualizar estado global
                                            if (globalDragState.draggedElement === stepEl) {
                                                globalDragState.isDragging = false;
                                                globalDragState.draggedElement = null;
                                            }
                                            
                                            // Restaurar scroll ap√≥s drag
                                            preventScrollDuringDrag(false);
                                            
                                            // Salvar posi√ß√£o quando arrastar
                                            const rect = stepEl.getBoundingClientRect();
                                            const canvasRect = canvas.getBoundingClientRect();
                                            const x = rect.left - canvasRect.left + canvas.scrollLeft;
                                            const y = rect.top - canvasRect.top + canvas.scrollTop;
                                            this.saveStepPosition(stepId, x, y);
                                        }
                                    });
                                } else if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                    // jsPlumb 2.x
                                    this.jsPlumbInstance.draggable(stepEl, {
                                        containment: 'parent',
                                        grid: [10, 10],
                                        filter: 'button, input, textarea, select, a, i', // ‚úÖ N√£o arrastar se clicar nestes elementos
                                        drag: (el, e) => {
                                            // ‚úÖ Prevenir scroll durante drag
                                            if (e && e.originalEvent) {
                                                e.originalEvent.preventDefault();
                                                e.originalEvent.stopPropagation();
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            preventScrollDuringDrag(true);
                                            
                                            if (!stepEl.classList.contains('dragging')) {
                                                stepEl.classList.add('dragging');
                                            }
                                        },
                                        start: (el, e) => {
                                            if (e && e.originalEvent && isClickableElement(e.originalEvent.target)) {
                                                return false;
                                            }
                                            
                                            // Atualizar estado global
                                            globalDragState.isDragging = true;
                                            globalDragState.draggedElement = stepEl;
                                            
                                            stepEl.classList.add('dragging');
                                            preventScrollDuringDrag(true);
                                        },
                                        stop: (el, e) => {
                                            stepEl.classList.remove('dragging');
                                            
                                            // Atualizar estado global
                                            if (globalDragState.draggedElement === stepEl) {
                                                globalDragState.isDragging = false;
                                                globalDragState.draggedElement = null;
                                            }
                                            
                                            preventScrollDuringDrag(false);
                                            
                                            // Salvar posi√ß√£o
                                            const rect = stepEl.getBoundingClientRect();
                                            const canvasRect = canvas.getBoundingClientRect();
                                            const x = rect.left - canvasRect.left + canvas.scrollLeft;
                                            const y = rect.top - canvasRect.top + canvas.scrollTop;
                                            this.saveStepPosition(stepId, x, y);
                                        }
                                    });
                                }
                            } catch (e) {
                                console.error('‚ùå Erro ao tornar arrast√°vel:', e);
                            }
                            
                            // ‚úÖ CR√çTICO: N√ÉO usar makeTarget/makeSource no card inteiro!
                            // ‚úÖ Endpoints ser√£o criados APENAS nos elementos visuais (bolinhas) dentro do setTimeout abaixo
                            // ‚úÖ Isso previne conex√µes autom√°ticas ao clicar/arrastar o card
                            
                            // ‚úÖ Adicionar endpoints INDIVIDUAIS para TODOS os bot√µes (customizados + cadastrados)
                            // ‚úÖ Usar os elementos visuais criados no HTML (.btn-visual-endpoint)
                            try {
                                // Aguardar DOM renderizar para encontrar os elementos
                                setTimeout(() => {
                                    const allButtonEndpoints = stepEl.querySelectorAll('.btn-visual-endpoint');
                                    
                                    // ‚úÖ Primeiro, adicionar endpoint para bola vermelha geral (quando n√£o h√° bot√µes)
                                    const stepOutputEndpoint = stepEl.querySelector('.step-output-endpoint');
                                    if (stepOutputEndpoint) {
                                        const outputEndpointId = `source-${stepId}`;
                                        stepOutputEndpoint.id = outputEndpointId;
                                        stepOutputEndpoint.style.cursor = 'crosshair';
                                        
                                        // Adicionar efeito hover
                                        stepOutputEndpoint.addEventListener('mouseenter', () => {
                                            stepOutputEndpoint.style.transform = 'translateY(-50%) scale(1.3)';
                                            stepOutputEndpoint.style.boxShadow = '0 0 12px rgba(239, 68, 68, 1)';
                                        });
                                        stepOutputEndpoint.addEventListener('mouseleave', () => {
                                            stepOutputEndpoint.style.transform = 'translateY(-50%) scale(1)';
                                            stepOutputEndpoint.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.9)';
                                        });
                                        
                                        // ‚úÖ Conectar bola vermelha geral ao jsPlumb - HABILITAR DRAG
                                        if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                            // ‚úÖ CR√çTICO: Configurar para permitir drag da bolinha vermelha
                                            // ‚úÖ CR√çTICO: makeSource permite drag autom√°tico - linha sai da bolinha e segue o mouse
                                            // ‚úÖ Usar endpoint invis√≠vel (radius: 0) para n√£o duplicar visualmente
                                            this.jsPlumbInstance.makeSource(stepOutputEndpoint, {
                                                anchor: 'Right',
                                                endpoint: ['Dot', { radius: 0 }], // ‚úÖ Invis√≠vel - elemento HTML j√° √© vis√≠vel
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: -1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 2 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 3 },
                                                beforeDrop: () => { return true; },
                                                onMaxConnections: () => { console.log('‚ö†Ô∏è M√°ximo de conex√µes atingido'); }
                                            });
                                        } else if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                            // jsPlumb 5.x - Endpoint VERMELHO apenas na bolinha visual
                                            // ‚úÖ Usar endpoint invis√≠vel (radius: 0) para n√£o duplicar visualmente
                                            this.jsPlumbInstance.addEndpoint(stepOutputEndpoint, {
                                                anchor: 'Right',
                                                endpoint: ['Dot', { radius: 0 }], // ‚úÖ Invis√≠vel - elemento HTML j√° √© vis√≠vel
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: -1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 2 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 3 },
                                                beforeDrop: () => { return true; }
                                            }, {
                                                uuid: outputEndpointId
                                            });
                                        }
                                        
                                        console.log(`‚úÖ Bola vermelha geral conectada para step ${stepId}`);
                                    }
                                    
                                    // ‚úÖ CR√çTICO: Criar endpoint VERDE (entrada) APENAS no elemento visual
                                    // ‚úÖ Isso previne cria√ß√£o de conex√µes ao clicar no card inteiro
                                    const stepInputEndpoint = stepEl.querySelector('.step-input-endpoint');
                                    if (stepInputEndpoint) {
                                        const inputEndpointId = `target-${stepId}`;
                                        stepInputEndpoint.id = inputEndpointId;
                                        
                                        // Adicionar efeito hover no endpoint verde
                                        stepInputEndpoint.addEventListener('mouseenter', () => {
                                            stepInputEndpoint.style.transform = 'scale(1.3)';
                                            stepInputEndpoint.style.boxShadow = '0 0 12px rgba(16, 185, 129, 1)';
                                        });
                                        stepInputEndpoint.addEventListener('mouseleave', () => {
                                            stepInputEndpoint.style.transform = 'scale(1)';
                                            stepInputEndpoint.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.9)';
                                        });
                                        
                                        // ‚úÖ Criar endpoint jsPlumb APENAS no elemento visual (bolinha verde)
                                        // ‚úÖ CR√çTICO: Usar endpoint invis√≠vel do jsPlumb, mas manter elemento visual HTML vis√≠vel
                                        if (typeof this.jsPlumbInstance.makeTarget === 'function') {
                                            // jsPlumb 2.x - Endpoint VERDE apenas na bolinha visual
                                            // ‚úÖ Usar endpoint invis√≠vel (radius: 0) para n√£o duplicar visualmente
                                            this.jsPlumbInstance.makeTarget(stepInputEndpoint, {
                                                anchor: 'Left',
                                                endpoint: ['Dot', { radius: 0 }], // ‚úÖ Invis√≠vel - elemento HTML j√° √© vis√≠vel
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: false,
                                                isTarget: true,
                                                maxConnections: -1,
                                                dropOptions: { hoverClass: 'drop-hover', activeClass: 'drop-active' }
                                            });
                                        } else if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                            // jsPlumb 5.x - Endpoint VERDE apenas na bolinha visual
                                            // ‚úÖ Usar endpoint invis√≠vel (radius: 0) para n√£o duplicar visualmente
                                            this.jsPlumbInstance.addEndpoint(stepInputEndpoint, {
                                                anchor: 'Left',
                                                endpoint: ['Dot', { radius: 0 }], // ‚úÖ Invis√≠vel - elemento HTML j√° √© vis√≠vel
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: false,
                                                isTarget: true,
                                                maxConnections: -1,
                                                dropOptions: { hoverClass: 'drop-hover', activeClass: 'drop-active' }
                                            }, {
                                                uuid: inputEndpointId
                                            });
                                        }
                                        
                                        console.log(`‚úÖ Bola verde (entrada) conectada para step ${stepId}`);
                                    }
                                    
                                    // ‚úÖ Agora, adicionar endpoints para cada bot√£o
                                    allButtonEndpoints.forEach((endpointEl, visualIdx) => {
                                        const btnType = endpointEl.getAttribute('data-button-type');
                                        const btnIndex = endpointEl.getAttribute('data-button-index');
                                        const buttonEndpointId = `btn-endpoint-${stepId}-${btnType}-${btnIndex}-${visualIdx}`;
                                        
                                        // Obter texto do bot√£o
                                        let btnText = '';
                                        if (btnType === 'custom' && step.config && step.config.custom_buttons) {
                                            const customBtn = step.config.custom_buttons[parseInt(btnIndex)];
                                            btnText = (customBtn && customBtn.text) ? customBtn.text.substring(0, 15) : `Bot√£o ${btnIndex}`;
                                        } else if (btnType === 'main' && this.config.main_buttons) {
                                            const mainBtn = this.config.main_buttons[parseInt(btnIndex)];
                                            btnText = (mainBtn && mainBtn.text) ? mainBtn.text.substring(0, 15) : `Bot√£o ${btnIndex}`;
                                        } else if (btnType === 'redirect' && this.config.redirect_buttons) {
                                            const redirectBtn = this.config.redirect_buttons[parseInt(btnIndex)];
                                            btnText = (redirectBtn && redirectBtn.text) ? redirectBtn.text.substring(0, 15) : `Link ${btnIndex}`;
                                        }
                                        
                                        if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                            // jsPlumb 2.x: usar o elemento visual como source
                                            endpointEl.id = buttonEndpointId;
                                            endpointEl.style.cursor = 'crosshair';
                                            
                                            // Adicionar efeito hover
                                            endpointEl.addEventListener('mouseenter', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1.3)';
                                                endpointEl.style.boxShadow = '0 0 12px rgba(255, 107, 107, 1)';
                                            });
                                            endpointEl.addEventListener('mouseleave', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1)';
                                                endpointEl.style.boxShadow = '0 0 8px rgba(255, 107, 107, 0.8)';
                                            });
                                            
                                            // ‚úÖ CR√çTICO: makeSource permite drag autom√°tico - linha sai da bolinha e segue o mouse
                                            // ‚úÖ Ao clicar e arrastar da bolinha vermelha, a linha deve sair dali e acompanhar o mouse
                                            // ‚úÖ Usar endpoint invis√≠vel (radius: 0) para n√£o duplicar visualmente
                                            this.jsPlumbInstance.makeSource(endpointEl, {
                                                anchor: 'Right',
                                                endpoint: ['Dot', { radius: 0 }], // ‚úÖ Invis√≠vel - elemento HTML j√° √© vis√≠vel
                                                paintStyle: { fill: 'transparent', radius: 0, stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', radius: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: 1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 3 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 4 },
                                                onMaxConnections: (info) => {
                                                    console.log('‚ö†Ô∏è M√°ximo de conex√µes atingido para este bot√£o');
                                                }
                                            });
                                        } else if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                            // jsPlumb 5.x: criar endpoint usando posi√ß√£o do elemento visual
                                            endpointEl.id = buttonEndpointId;
                                            endpointEl.style.cursor = 'crosshair';
                                            
                                            // Adicionar efeito hover (VERMELHO)
                                            endpointEl.addEventListener('mouseenter', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1.3)';
                                                endpointEl.style.boxShadow = '0 0 12px rgba(239, 68, 68, 1)';
                                            });
                                            endpointEl.addEventListener('mouseleave', () => {
                                                endpointEl.style.transform = 'translateY(-50%) scale(1)';
                                                endpointEl.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.9)';
                                            });
                                            
                                            // Calcular posi√ß√£o relativa do endpoint
                                            const rect = endpointEl.getBoundingClientRect();
                                            const stepRect = stepEl.getBoundingClientRect();
                                            const relativeTop = (rect.top - stepRect.top + rect.height / 2) / stepRect.height;
                                            
                                            // ‚úÖ HABILITAR ARRASTE: linha segue o mouse ao arrastar da bolinha VERMELHA
                                            // ‚úÖ jsPlumb 5.x: usar elemento visual como base, mas endpoint no stepEl para posicionamento correto
                                            // ‚úÖ Usar endpoint invis√≠vel (radius: 0) para n√£o duplicar visualmente
                                            this.jsPlumbInstance.addEndpoint(stepEl, {
                                                anchor: ['Right', relativeTop, 1, 0, 0, 0],
                                                endpoint: ['Dot', { radius: 0 }], // ‚úÖ Invis√≠vel - elemento HTML j√° √© vis√≠vel
                                                paintStyle: { fill: 'transparent', stroke: 'transparent', strokeWidth: 0 },
                                                hoverPaintStyle: { fill: 'transparent', stroke: 'transparent', strokeWidth: 0 },
                                                isSource: true,
                                                isTarget: false,
                                                maxConnections: 1,
                                                connector: ['Flowchart', { stub: [10, 15], gap: 5, cornerRadius: 5, alwaysRespectStubs: true }],
                                                connectorStyle: { stroke: '#EF4444', strokeWidth: 3 },
                                                connectorHoverStyle: { stroke: '#F87171', strokeWidth: 4 },
                                                beforeDrop: () => {
                                                    return true; // Permitir drop em qualquer target
                                                }
                                            }, {
                                                uuid: buttonEndpointId
                                            });
                                            
                                            // Adicionar label
                                            const endpoint = this.jsPlumbInstance.getEndpoint(buttonEndpointId);
                                            if (endpoint && endpoint.setLabel) {
                                                endpoint.setLabel({
                                                    label: btnText,
                                                    location: [0.5, -0.5],
                                                    cssClass: 'btn-endpoint-label'
                                                });
                                            }
                                            
                                            // ‚úÖ N√ÉO criar endpoint verde aqui - j√° foi criado acima apenas no elemento visual
                                            // ‚úÖ Isso previne duplica√ß√£o e conex√µes autom√°ticas ao clicar no card
                                        }
                                    });
                                }, 100); // Delay para garantir DOM renderizado
                            } catch (e) {
                                console.error('‚ùå Erro ao adicionar endpoints de bot√µes:', e);
                            }
                        });
                        
                        // ‚úÖ REMOVIDO: Conex√µes autom√°ticas - linhas s√≥ aparecem quando usu√°rio arrasta da bola vermelha para a verde
                        // As conex√µes ser√£o criadas apenas quando o usu√°rio arrastar manualmente os endpoints
                        // Isso d√° mais controle ao usu√°rio sobre como conectar os steps
                        console.log('‚úÖ Endpoints criados! Arraste da bola VERMELHA (sa√≠da) para a bola VERDE (entrada) para criar conex√µes.');
                        
                        // ‚úÖ OBSOLETO: C√≥digo de conex√£o autom√°tica removido - conex√µes devem ser criadas manualmente pelo usu√°rio
                        /*
                        steps.forEach(step => {
                            const stepEl = document.getElementById(`flow-step-${step.id}`);
                            if (!stepEl) return;
                            
                            const connections = step.connections || {};
                            
                            // Conex√£o "next" (verde) - MELHORADA
                            if (connections.next) {
                                const targetEl = document.getElementById(`flow-step-${connections.next}`);
                                if (targetEl) {
                                    try {
                                        const connection = this.jsPlumbInstance.connect({
                                            source: stepEl,
                                            target: targetEl,
                                            paintStyle: { stroke: '#10B981', strokeWidth: 3, strokeLinecap: 'round', strokeLinejoin: 'round' },
                                            overlays: [
                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                ['Label', { 
                                                    label: 'Pr√≥ximo', 
                                                    location: 0.5, 
                                                    cssClass: 'connection-label',
                                                    labelStyle: {
                                                        backgroundColor: 'rgba(16, 185, 129, 0.9)',
                                                        color: '#FFFFFF',
                                                        padding: '3px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: 'bold'
                                                    }
                                                }]
                                            ],
                                            detachable: true,
                                            reattach: true,
                                            deleteEndpointsOnDetach: false
                                        });
                                        
                                        // ‚úÖ Adicionar feedback visual ao hover e marca√ß√£o como remov√≠vel
                                        if (connection) {
                                            if (connection.canvas) {
                                                connection.canvas.setAttribute('data-removable', 'true');
                                            }
                                            
                                            // Tentar adicionar eventos de hover (pode variar por vers√£o do jsPlumb)
                                            try {
                                                if (connection.bind && typeof connection.bind === 'function') {
                                                    connection.bind('mouseenter', () => {
                                                        if (connection.canvas) {
                                                            connection.canvas.style.cursor = 'pointer';
                                                            connection.canvas.style.filter = 'drop-shadow(0 0 8px rgba(16, 185, 129, 0.9))';
                                                            connection.canvas.style.strokeWidth = '4';
                                                        }
                                                    });
                                                    connection.bind('mouseleave', () => {
                                                        if (connection.canvas) {
                                                            connection.canvas.style.filter = '';
                                                            connection.canvas.style.strokeWidth = '';
                                                        }
                                                    });
                                                }
                                            } catch (e) {
                                                // Pode n√£o funcionar em algumas vers√µes do jsPlumb, ignorar
                                            }
                                        }
                                    } catch (e) {
                                        console.error('‚ùå Erro ao conectar next:', e);
                                    }
                                }
                            }
                            
                            // Conex√£o "pending" (vermelho) - MELHORADA
                            if (connections.pending) {
                                const targetEl = document.getElementById(`flow-step-${connections.pending}`);
                                if (targetEl) {
                                    try {
                                        const connection = this.jsPlumbInstance.connect({
                                            source: stepEl,
                                            target: targetEl,
                                            paintStyle: { stroke: '#EF4444', strokeWidth: 3, strokeLinecap: 'round', strokeLinejoin: 'round', strokeDasharray: '5,5' },
                                            overlays: [
                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                ['Label', { 
                                                    label: 'Pendente', 
                                                    location: 0.5, 
                                                    cssClass: 'connection-label',
                                                    labelStyle: {
                                                        backgroundColor: 'rgba(239, 68, 68, 0.9)',
                                                        color: '#FFFFFF',
                                                        padding: '3px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: 'bold'
                                                    }
                                                }]
                                            ],
                                            detachable: true,
                                            reattach: true,
                                            deleteEndpointsOnDetach: false
                                        });
                                    } catch (e) {
                                        console.error('‚ùå Erro ao conectar pending:', e);
                                    }
                                }
                            }
                            
                            // Conex√£o "retry" (amarelo) - MELHORADA
                            if (connections.retry) {
                                const targetEl = document.getElementById(`flow-step-${connections.retry}`);
                                if (targetEl) {
                                    try {
                                        const connection = this.jsPlumbInstance.connect({
                                            source: stepEl,
                                            target: targetEl,
                                            paintStyle: { stroke: '#F59E0B', strokeWidth: 3, strokeLinecap: 'round', strokeLinejoin: 'round', strokeDasharray: '8,4' },
                                            overlays: [
                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                ['Label', { 
                                                    label: 'Retry', 
                                                    location: 0.5, 
                                                    cssClass: 'connection-label',
                                                    labelStyle: {
                                                        backgroundColor: 'rgba(245, 158, 11, 0.9)',
                                                        color: '#FFFFFF',
                                                        padding: '3px 8px',
                                                        borderRadius: '4px',
                                                        fontSize: '11px',
                                                        fontWeight: 'bold'
                                                    }
                                                }]
                                            ],
                                            detachable: true,
                                            reattach: true,
                                            deleteEndpointsOnDetach: false
                                        });
                                    } catch (e) {
                                        console.error('‚ùå Erro ao conectar retry:', e);
                                    }
                                }
                            }
                            
                            // ‚úÖ Conectar bot√µes customizados - REMOVIDO (conex√µes devem ser criadas manualmente)
                            // ‚úÖ Cada bot√£o customizado pode ter sua pr√≥pria conex√£o para um step diferente
                            // ‚úÖ Aguardar endpoints serem criados antes de conectar
                            // ‚úÖ C√ìDIGO REMOVIDO: Conex√µes autom√°ticas de bot√µes customizados foram removidas
                            // ‚úÖ As conex√µes devem ser criadas manualmente pelo usu√°rio arrastando da bola vermelha para a verde
                            // ‚úÖ TODO O C√ìDIGO DE CONEX√ÉO AUTOM√ÅTICA FOI REMOVIDO - N√ÉO H√Å MAIS COMENT√ÅRIOS ANINHADOS
                            // ‚úÖ O c√≥digo comentado abaixo foi removido para evitar erro de sintaxe com coment√°rios aninhados
                            /*
                            setTimeout(() => {
                                if (step.config && step.config.custom_buttons && step.config.custom_buttons.length > 0) {
                                    step.config.custom_buttons.forEach((btn, btnIdx) => {
                                        if (btn.target_step) {
                                            const targetEl = document.getElementById(`flow-step-${btn.target_step}`);
                                            if (targetEl) {
                                                try {
                                                    // ‚úÖ Usar novo formato de ID de endpoint
                                                    const buttonEndpointId = `btn-endpoint-${step.id}-custom-${btnIdx}-0`;
                                                    const btnText = (btn.text || `Bot√£o ${btnIdx + 1}`).substring(0, 15); // Limitar tamanho do label
                                                    
                                                    // ‚úÖ Tentar encontrar o elemento visual do endpoint tamb√©m
                                                    const endpointVisualEl = stepEl.querySelector(`[data-button-type="custom"][data-button-index="${btnIdx}"]`);
                                                    
                                                    if (typeof this.jsPlumbInstance.addEndpoint === 'function') {
                                                        // jsPlumb 5.x: conectar usando UUID do endpoint
                                                        // ‚úÖ Buscar endpoint ou criar se n√£o existir
                                                        let endpoint = null;
                                                        try {
                                                            endpoint = this.jsPlumbInstance.getEndpoint(buttonEndpointId);
                                                        } catch (e) {
                                                            console.warn('‚ö†Ô∏è Endpoint n√£o encontrado, tentando usar elemento visual:', buttonEndpointId);
                                                        }
                                                        
                                                        // ‚úÖ Se n√£o encontrou por ID, tentar usar elemento visual
                                                        const sourceEl = endpoint || endpointVisualEl || stepEl;
                                                        
                                                        if (endpoint || endpointVisualEl) {
                                                            const connection = this.jsPlumbInstance.connect({
                                                                source: sourceEl,
                                                                target: targetEl,
                                                            paintStyle: { stroke: '#FF6B6B', strokeWidth: 3 },
                                                            overlays: [
                                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                                ['Label', { 
                                                                    label: btnText, 
                                                                    location: 0.5, 
                                                                    cssClass: 'connection-label',
                                                                    labelStyle: { 
                                                                        color: '#FF6B6B', 
                                                                        fontWeight: 'bold',
                                                                        fontSize: '11px',
                                                                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                        padding: '3px 8px',
                                                                        borderRadius: '4px',
                                                                        border: '1px solid #FF6B6B'
                                                                    }
                                                                }]
                                                            ],
                                                            detachable: true,
                                                            reattach: true
                                                        });
                                                        
                                                        // ‚úÖ Marcar como conex√£o de bot√£o customizado e remov√≠vel
                                                        if (connection && connection.canvas) {
                                                            connection.canvas.setAttribute('data-button-connection', 'true');
                                                            connection.canvas.setAttribute('data-removable', 'true');
                                                        }
                                                    } else {
                                                        // Fallback: conectar diretamente usando ID do endpoint como string
                                                        const connection = this.jsPlumbInstance.connect({
                                                            source: buttonEndpointId,
                                                            target: targetEl,
                                                            paintStyle: { stroke: '#FF6B6B', strokeWidth: 3 },
                                                            overlays: [
                                                                ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                                ['Label', { 
                                                                    label: btnText, 
                                                                    location: 0.5, 
                                                                    cssClass: 'connection-label',
                                                                    labelStyle: { 
                                                                        color: '#FF6B6B', 
                                                                        fontWeight: 'bold',
                                                                        fontSize: '11px',
                                                                        backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                        padding: '3px 8px',
                                                                        borderRadius: '4px',
                                                                        border: '1px solid #FF6B6B'
                                                                    }
                                                                }]
                                                            ],
                                                            detachable: true,
                                                            reattach: true
                                                        });
                                                        
                                                        // ‚úÖ Marcar como conex√£o de bot√£o customizado e remov√≠vel
                                                        if (connection && connection.canvas) {
                                                            connection.canvas.setAttribute('data-button-connection', 'true');
                                                            connection.canvas.setAttribute('data-removable', 'true');
                                                        }
                                                    }
                                                    } else if (typeof this.jsPlumbInstance.makeSource === 'function') {
                                                        // jsPlumb 2.x: conectar usando elemento visual do endpoint
                                                        const sourceEl = endpointVisualEl || document.getElementById(buttonEndpointId) || stepEl;
                                                    
                                                    const connection = this.jsPlumbInstance.connect({
                                                        source: sourceEl,
                                                        target: targetEl,
                                                        paintStyle: { stroke: '#FF6B6B', strokeWidth: 3 },
                                                        overlays: [
                                                            ['Arrow', { location: 1, width: 14, length: 14, foldback: 0.8 }],
                                                            ['Label', { 
                                                                label: btnText, 
                                                                location: 0.5, 
                                                                cssClass: 'connection-label',
                                                                labelStyle: { 
                                                                    color: '#FF6B6B', 
                                                                    fontWeight: 'bold',
                                                                    fontSize: '11px',
                                                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                                                    padding: '3px 8px',
                                                                    borderRadius: '4px',
                                                                    border: '1px solid #FF6B6B'
                                                                }
                                                            }]
                                                        ],
                                                        detachable: true,
                                                        reattach: true
                                                    });
                                                    
                                                    // ‚úÖ Marcar como conex√£o de bot√£o customizado e remov√≠vel
                                                    if (connection && connection.canvas) {
                                                        connection.canvas.setAttribute('data-button-connection', 'true');
                                                        connection.canvas.setAttribute('data-removable', 'true');
                                                    }
                                                }
                                                
                                                console.log(`‚úÖ Bot√£o "${btnText}" conectado de step ${step.id} para step ${btn.target_step}`);
                                            } catch (e) {
                                                console.error('‚ùå Erro ao conectar bot√£o customizado:', e);
                                                console.error('   Step:', step.id, 'Bot√£o:', btnIdx, 'Target:', btn.target_step);
                                            }
                                        }
                                    }
                                });
                            }
                            }, 200);
                            */
                            
                            // ‚úÖ Conectar condi√ß√µes - REMOVIDO (conex√µes devem ser criadas manualmente)
                            // ‚úÖ TODO O C√ìDIGO DE CONEX√ÉO AUTOM√ÅTICA FOI REMOVIDO
                        
                        // ‚úÖ PERMITIR REMOVER CONEX√ïES - CR√çTICO PARA USABILIDADE
                        try {
                            // ‚úÖ Double-click na conex√£o para remover
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('connection:dblclick', (connection, event) => {
                                    event.stopPropagation();
                                    event.preventDefault();
                                    
                                    if (confirm('‚ùì Remover esta conex√£o?')) {
                                        try {
                                            // ‚úÖ Extrair informa√ß√µes da conex√£o para atualizar dados
                                            const sourceId = connection.sourceId || connection.source?.id || connection.sourceEndpoint?.uuid || '';
                                            const targetId = connection.targetId || connection.target?.id || connection.targetEndpoint?.uuid || '';
                                            
                                            // ‚úÖ Verificar se √© conex√£o de bot√£o customizado
                                            if (sourceId.startsWith('btn-endpoint-')) {
                                                const parts = sourceId.split('-');
                                                if (parts.length >= 4) {
                                                    const stepId = parts.slice(2, -1).join('-');
                                                    const btnIdx = parseInt(parts[parts.length - 1]);
                                                    
                                                    const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                                    if (sourceStep && sourceStep.config && sourceStep.config.custom_buttons && sourceStep.config.custom_buttons[btnIdx]) {
                                                        sourceStep.config.custom_buttons[btnIdx].target_step = '';
                                                        this.showNotification(`‚úÖ Conex√£o do bot√£o "${sourceStep.config.custom_buttons[btnIdx].text}" removida`, 'success');
                                                    }
                                                }
                                            } else {
                                                // ‚úÖ Conex√£o normal
                                                const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                                                const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                                                if (sourceStep && sourceStep.connections) {
                                                    if (sourceStep.connections.next === targetId.replace('target-', '').replace('flow-step-', '')) {
                                                        sourceStep.connections.next = '';
                                                    }
                                                    if (sourceStep.connections.pending === targetId.replace('target-', '').replace('flow-step-', '')) {
                                                        sourceStep.connections.pending = '';
                                                    }
                                                    if (sourceStep.connections.retry === targetId.replace('target-', '').replace('flow-step-', '')) {
                                                        sourceStep.connections.retry = '';
                                                    }
                                                    this.showNotification('‚úÖ Conex√£o removida', 'success');
                                                }
                                            }
                                            
                                            // ‚úÖ Remover conex√£o visualmente
                                            this.jsPlumbInstance.deleteConnection(connection);
                                        } catch (e) {
                                            console.error('‚ùå Erro ao remover conex√£o:', e);
                                            this.showNotification('‚ùå Erro ao remover conex√£o', 'error');
                                        }
                                    }
                                });
                            }
                            
                            // ‚úÖ Click direito na conex√£o para remover (context menu)
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('connection:contextmenu', (connection, event) => {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    
                                    if (confirm('‚ùì Remover esta conex√£o?')) {
                                        try {
                                            const sourceId = connection.sourceId || connection.source?.id || connection.sourceEndpoint?.uuid || '';
                                            const targetId = connection.targetId || connection.target?.id || connection.targetEndpoint?.uuid || '';
                                            
                                            // ‚úÖ Verificar se √© conex√£o de bot√£o customizado
                                            if (sourceId.startsWith('btn-endpoint-')) {
                                                const parts = sourceId.split('-');
                                                if (parts.length >= 4) {
                                                    const stepId = parts.slice(2, -1).join('-');
                                                    const btnIdx = parseInt(parts[parts.length - 1]);
                                                    
                                                    const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                                    if (sourceStep && sourceStep.config && sourceStep.config.custom_buttons && sourceStep.config.custom_buttons[btnIdx]) {
                                                        sourceStep.config.custom_buttons[btnIdx].target_step = '';
                                                        this.showNotification(`‚úÖ Conex√£o do bot√£o "${sourceStep.config.custom_buttons[btnIdx].text}" removida`, 'success');
                                                    }
                                                }
                                            } else {
                                                const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                                                const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                                                if (sourceStep && sourceStep.connections) {
                                                    const targetStepId = targetId.replace('target-', '').replace('flow-step-', '');
                                                    if (sourceStep.connections.next === targetStepId) sourceStep.connections.next = '';
                                                    if (sourceStep.connections.pending === targetStepId) sourceStep.connections.pending = '';
                                                    if (sourceStep.connections.retry === targetStepId) sourceStep.connections.retry = '';
                                                    this.showNotification('‚úÖ Conex√£o removida', 'success');
                                                }
                                            }
                                            
                                            this.jsPlumbInstance.deleteConnection(connection);
                                        } catch (e) {
                                            console.error('‚ùå Erro ao remover conex√£o:', e);
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao bind delete connection (pode ser normal):', e);
                        }
                        
                        // ‚úÖ Permitir criar conex√µes arrastando
                        try {
                            if (typeof this.jsPlumbInstance.bind === 'function') {
                                this.jsPlumbInstance.bind('connection', (info) => {
                                    // ‚úÖ Extrair informa√ß√µes da conex√£o
                                    let sourceId = '';
                                    let targetId = '';
                                    
                                    // Tentar v√°rias formas de obter o sourceId
                                    if (info.sourceId) {
                                        sourceId = info.sourceId;
                                    } else if (info.source && info.source.id) {
                                        sourceId = info.source.id;
                                    } else if (info.source && info.source.uuid) {
                                        sourceId = info.source.uuid;
                                    } else if (info.sourceEndpoint && info.sourceEndpoint.uuid) {
                                        sourceId = info.sourceEndpoint.uuid;
                                    }
                                    
                                    // Tentar v√°rias formas de obter o targetId
                                    if (info.targetId) {
                                        targetId = info.targetId.replace('target-', '');
                                    } else if (info.target && info.target.id) {
                                        targetId = info.target.id.replace('flow-step-', '').replace('target-', '');
                                    } else if (info.target && info.target.uuid) {
                                        targetId = info.target.uuid.replace('target-', '');
                                    } else if (info.targetEndpoint && info.targetEndpoint.uuid) {
                                        targetId = info.targetEndpoint.uuid.replace('target-', '');
                                    }
                                    
                                    if (!sourceId || !targetId) {
                                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel extrair sourceId ou targetId da conex√£o:', info);
                                        return;
                                    }
                                    
                                    // ‚úÖ Verificar se a conex√£o vem de um endpoint de bot√£o customizado
                                    // Formato: btn-endpoint-{stepId}-{btnIdx}
                                    if (sourceId.startsWith('btn-endpoint-')) {
                                        const parts = sourceId.split('-');
                                        if (parts.length >= 4) {
                                            const stepId = parts.slice(2, -1).join('-'); // Pode ter h√≠fens no stepId
                                            const btnIdx = parseInt(parts[parts.length - 1]);
                                            
                                            if (!isNaN(btnIdx)) {
                                                const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                                                if (sourceStep && sourceStep.config && sourceStep.config.custom_buttons) {
                                                    const button = sourceStep.config.custom_buttons[btnIdx];
                                                    if (button) {
                                                        // ‚úÖ Atualizar target_step do bot√£o customizado
                                                        button.target_step = targetId;
                                                        const targetStepName = this.config.flow_steps.find(s => s.id === targetId)?.name || targetId;
                                                        this.showNotification(`‚úÖ Bot√£o "${button.text || 'Bot√£o ' + (btnIdx + 1)}" conectado para "${targetStepName}"`, 'success');
                                                        console.log(`‚úÖ Bot√£o customizado "${button.text}" do step ${stepId} conectado para step ${targetId}`);
                                                        return; // N√£o processar mais
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    // ‚úÖ Conex√£o normal (n√£o √© bot√£o customizado)
                                    const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                                    const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                                    if (sourceStep) {
                                        if (!sourceStep.connections) sourceStep.connections = {};
                                        // Por padr√£o, salvar como "next"
                                        sourceStep.connections.next = targetId;
                                        const targetStepName = this.config.flow_steps.find(s => s.id === targetId)?.name || targetId;
                                        this.showNotification(`‚úÖ Conex√£o criada: ${sourceStep.name || sourceStepId} ‚Üí ${targetStepName}`, 'success');
                                    }
                                });
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao bind connection (pode ser normal):', e);
                        }
                        
                        // ‚úÖ Redesenhar ap√≥s mudan√ßas
                        try {
                            if (typeof this.jsPlumbInstance.repaintEverything === 'function') {
                                this.jsPlumbInstance.repaintEverything();
                            } else if (typeof this.jsPlumbInstance.repaint === 'function') {
                                this.jsPlumbInstance.repaint();
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao repaint (pode ser normal):', e);
                        }
                        
                        console.log('‚úÖ Editor visual inicializado! Blocos criados:', steps.length);
                    } else {
                        // ‚úÖ Verificar se chegou at√© aqui (significa que passou pela verifica√ß√£o mas n√£o entrou no if)
                        console.error('‚ùå jsPlumb n√£o carregado');
                        console.error('üîç Debug completo:');
                        console.error('- typeof jsPlumb:', typeof jsPlumb);
                        console.error('- jsPlumb:', typeof jsPlumb !== 'undefined' ? jsPlumb : 'undefined');
                        console.error('- window.jsPlumb:', window.jsPlumb);
                        console.error('- window.jsPlumb?.jsPlumb:', window.jsPlumb?.jsPlumb);
                        console.error('- Vari√°veis window com "plumb":', Object.keys(window).filter(k => k.toLowerCase().includes('plumb')));
                        
                        // ‚úÖ Tentar carregar manualmente se n√£o encontrou
                        if (typeof window.jsPlumb === 'undefined' && typeof jsPlumb === 'undefined') {
                            console.warn('‚ö†Ô∏è Tentando carregar jsPlumb manualmente...');
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js';
                            script.onload = () => {
                                console.log('‚úÖ jsPlumb carregado manualmente! Tentando novamente...');
                                setTimeout(() => this.initVisualFlowEditor(), 200);
                            };
                            script.onerror = () => {
                                console.error('‚ùå Falha ao carregar jsPlumb manualmente');
                                this.showNotification('‚ùå Erro: jsPlumb n√£o p√¥de ser carregado. Verifique sua conex√£o.', 'error');
                            };
                            document.head.appendChild(script);
                            return; // Sair da fun√ß√£o, vai tentar novamente quando carregar
                        }
                        
                        this.showNotification('‚ùå Erro: jsPlumb n√£o carregou. Verifique o console para detalhes.', 'error');
                    }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar editor visual:', error);
                console.error('Stack:', error.stack);
                this.showNotification('‚ùå Erro ao inicializar editor visual. Verifique o console.', 'error');
            }
            }, 300); // Aumentar delay para garantir DOM renderizado
        },
        
        loadStepPositions() {
            /** Carrega posi√ß√µes salvas dos steps do localStorage */
            try {
                const saved = localStorage.getItem(`flow_positions_${this.config.bot_id || 'default'}`);
                return saved ? JSON.parse(saved) : {};
            } catch {
                return {};
            }
        },
        
        saveStepPosition(stepId, x, y) {
            /** Salva posi√ß√£o do step no localStorage */
            try {
                const positions = this.loadStepPositions();
                positions[stepId] = { x, y };
                localStorage.setItem(`flow_positions_${this.config.bot_id || 'default'}`, JSON.stringify(positions));
            } catch (e) {
                console.error('Erro ao salvar posi√ß√£o:', e);
            }
        },
        
        updateStepConnectionsFromConnection(connection) {
            /** ‚úÖ Atualiza connections do step baseado em uma conex√£o jsPlumb criada ou removida */
            try {
                if (!connection) return;
                
                // Extrair IDs da conex√£o
                let sourceId = '';
                let targetId = '';
                
                if (connection.sourceId) sourceId = connection.sourceId;
                else if (connection.source && connection.source.id) sourceId = connection.source.id;
                else if (connection.sourceEndpoint && connection.sourceEndpoint.uuid) sourceId = connection.sourceEndpoint.uuid;
                
                if (connection.targetId) targetId = connection.targetId;
                else if (connection.target && connection.target.id) targetId = connection.target.id;
                else if (connection.targetEndpoint && connection.targetEndpoint.uuid) targetId = connection.targetEndpoint.uuid;
                
                if (!sourceId || !targetId) {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel extrair IDs da conex√£o:', connection);
                    return;
                }
                
                // Extrair stepId do target (sempre √© o mesmo formato)
                const targetStepId = targetId.replace('target-', '').replace('flow-step-', '');
                
                // ‚úÖ Verificar se √© conex√£o de bot√£o customizado
                if (sourceId.startsWith('btn-endpoint-')) {
                    const parts = sourceId.split('-');
                    if (parts.length >= 4) {
                        const stepId = parts.slice(2, -1).join('-');
                        const btnType = parts[parts.length - 2];
                        const btnIdx = parseInt(parts[parts.length - 1]);
                        
                        if (!isNaN(btnIdx)) {
                            const sourceStep = this.config.flow_steps.find(s => s.id === stepId);
                            if (sourceStep && sourceStep.config) {
                                if (btnType === 'custom' && sourceStep.config.custom_buttons) {
                                    const button = sourceStep.config.custom_buttons[btnIdx];
                                    if (button) {
                                        // ‚úÖ Atualizar target_step do bot√£o customizado
                                        button.target_step = targetStepId;
                                        console.log(`‚úÖ Conex√£o atualizada: Bot√£o "${button.text}" ‚Üí Step ${targetStepId}`);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    // ‚úÖ Conex√£o normal (n√£o √© bot√£o customizado)
                    const sourceStepId = sourceId.replace('source-', '').replace('flow-step-', '');
                    const sourceStep = this.config.flow_steps.find(s => s.id === sourceStepId);
                    if (sourceStep) {
                        if (!sourceStep.connections) sourceStep.connections = {};
                        // Por padr√£o, salvar como "next"
                        sourceStep.connections.next = targetStepId;
                        console.log(`‚úÖ Conex√£o atualizada: Step ${sourceStepId} ‚Üí Step ${targetStepId}`);
                    }
                }
            } catch (e) {
                console.error('‚ùå Erro ao atualizar conex√µes:', e);
            }
        },
        
        getStepTitle(type) {
            const titles = {'content': 'Conte√∫do', 'payment': 'Pagamento', 'message': 'Mensagem', 'audio': '√Åudio', 'video': 'V√≠deo', 'buttons': 'Bot√µes', 'access': 'Acesso'};
            return titles[type] || 'Desconhecido';
        },
        
        addFlowStep() {
            const stepId = `step_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const maxOrder = this.sortedFlowSteps.length > 0 ? Math.max(...this.sortedFlowSteps.map(s => s.order || 0)) : 0;
            const newOrder = maxOrder + 1;
            
            this.config.flow_steps.push({
                id: stepId,
                name: null,  // Nome ser√° definido pelo usu√°rio no modal
                type: 'content',
                order: newOrder,
                config: { message: '', media_url: '', media_type: 'video', buttons: [] },
                connections: {},
                delay_seconds: 0
            });
            
            // ‚úÖ Auto-definir como inicial se:
            // 1. √â o primeiro step (sem steps anteriores)
            // 2. Ou n√£o h√° step inicial definido e este tem order=1
            if (!this.config.flow_start_step_id) {
                if (this.config.flow_steps.length === 1 || newOrder === 1) {
                    this.config.flow_start_step_id = stepId;
                    this.showNotification(`‚úÖ Step adicionado e definido como inicial automaticamente!`, 'success');
                } else {
                    this.showNotification('‚úÖ Step adicionado!', 'success');
                }
            } else {
                this.showNotification('‚úÖ Step adicionado!', 'success');
            }
            
            setTimeout(() => {
                this.editFlowStep(stepId);
                // ‚úÖ Recarregar editor visual (sempre visual agora)
                setTimeout(() => this.initVisualFlowEditor(), 200);
            }, 100);
        },
        
        editFlowStep(stepId) {
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) {
                this.showNotification('‚ùå Step n√£o encontrado', 'error');
                return;
            }
            
            const stepJson = JSON.stringify(step).replace(/"/g, '&quot;');
            const availableStepsJson = JSON.stringify(this.config.flow_steps.filter(s => s.id !== stepId)).replace(/"/g, '&quot;');
            
            const stepTypes = [
                { value: 'content', label: 'üì∏ Conte√∫do', desc: 'Mensagem com m√≠dia e bot√µes' },
                { value: 'message', label: 'üí¨ Mensagem', desc: 'Mensagem simples de texto' },
                { value: 'audio', label: 'üéµ √Åudio', desc: 'Enviar √°udio' },
                { value: 'video', label: 'üñºÔ∏è M√≠dia Foto/Video', desc: 'Enviar foto ou v√≠deo' },
                { value: 'buttons', label: 'üîò Bot√µes', desc: 'Enviar bot√µes cadastrados' },
                { value: 'access', label: '‚úÖ Acesso', desc: 'Liberar acesso (fim do fluxo)' }
            ];
            
            const availableSteps = this.config.flow_steps.filter(s => s.id !== stepId);
            const stepOptions = availableSteps.map(s => {
                const stepLabel = s.name ? s.name : this.getStepTitle(s.type);
                return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
            }).join('');
            
            // ‚úÖ Prevenir scroll no body quando modal abrir
            document.body.style.overflow = 'hidden';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.id = `flow-step-modal-${stepId}`;
            
            // ‚úÖ Restaurar scroll quando modal fechar (click fora ou X)
            const restoreScroll = () => {
                document.body.style.overflow = '';
            };
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    restoreScroll();
                }
            });
            
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto border-2 border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white"><i class="fas fa-edit mr-2 text-blue-500"></i>Editar Step</h3>
                        <button onclick="document.body.style.overflow = ''; document.getElementById('flow-step-modal-${stepId}').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form onsubmit="event.preventDefault(); if(window.flowStepEditor['saveStep_${stepId}']) window.flowStepEditor['saveStep_${stepId}']();">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-tag mr-2 text-blue-400"></i>Nome do Step
                            </label>
                            <input type="text" id="step-name-${stepId}" value="${(step.name || '').replace(/"/g, '&quot;')}" 
                                   placeholder="Ex: Boas-vindas, Apresenta√ß√£o, Pagamento..."
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500"
                                   maxlength="50">
                            <p class="text-xs text-gray-500 mt-1">Nome para identificar este step no fluxo (opcional, mas recomendado)</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-cog mr-2 text-blue-400"></i>Tipo de Step
                                <i class="fas fa-question-circle ml-2 text-gray-500 text-xs cursor-help" 
                                   title="üì∏ Conte√∫do: Envia mensagem com m√≠dia (foto/v√≠deo) e bot√µes\nüí¨ Mensagem: Envia texto e pode incluir bot√µes\nüéµ √Åudio: Envia √°udio e pode incluir bot√µes\nüñºÔ∏è M√≠dia Foto/Video: Envia foto/v√≠deo e pode incluir bot√µes\n‚úÖ Acesso: Libera acesso e finaliza o fluxo"></i>
                            </label>
                            <select id="step-type-${stepId}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                ${stepTypes.map(t => `<option value="${t.value}" ${step.type === t.value ? 'selected' : ''}>${t.label} - ${t.desc}</option>`).join('')}
                            </select>
                            <div class="mt-2 p-3 bg-blue-500 bg-opacity-25 border border-blue-500 rounded-lg text-xs text-blue-200" id="step-type-help-${stepId}">
                                ${(() => {
                                    const helps = {
                                        'content': 'üì∏ <strong>Conte√∫do:</strong> Ideal para apresenta√ß√£o. Envia mensagem com foto/v√≠deo e bot√µes.',
                                        'message': 'üí¨ <strong>Mensagem:</strong> Envia texto e bot√µes. Quando o lead responder, voc√™ pode configurar um step de verifica√ß√£o para processar a resposta.',
                                        'audio': 'üéµ <strong>√Åudio:</strong> Envia √°udio do Telegram e pode incluir bot√µes. Ideal para criar conex√£o pessoal.',
                                        'video': 'üñºÔ∏è <strong>M√≠dia Foto/Video:</strong> Envia foto ou v√≠deo do Telegram e pode incluir bot√µes. Perfeito para explica√ß√µes detalhadas.',
                                        'access': '‚úÖ <strong>Acesso:</strong> Libera acesso final e <strong>encerra o fluxo</strong>. N√£o deve ter conex√µes.'
                                    };
                                    return helps[step.type] || 'Selecione um tipo de step';
                                })()}
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Ordem</label>
                            <input type="number" id="step-order-${stepId}" value="${step.order || 0}" min="1" 
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white"
                                   oninput="document.getElementById('order-warning-${stepId}').style.display = (this.value == 1) ? 'block' : 'none'">
                            <!-- Aviso quando ordem = 1 -->
                            <div id="order-warning-${stepId}" 
                                 style="display: ${(step.order || 0) == 1 ? 'block' : 'none'}"
                                 class="mt-2 p-3 bg-yellow-500 bg-opacity-10 border border-yellow-500 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-star text-yellow-400 text-sm mt-0.5"></i>
                                    <div class="text-xs text-yellow-300">
                                        <strong>‚≠ê Step Inicial do Funil</strong>
                                        <br>
                                        <span class="text-yellow-400">Este step ser√° o primeiro a ser executado quando o lead enviar <code class="px-1 py-0.5 bg-gray-800 rounded">/start</code>.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Delay (segundos)</label>
                            <input type="number" id="step-delay-${stepId}" value="${step.delay_seconds || 0}" min="0" step="0.1"
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div class="mb-4" id="config-content-${stepId}">
                            ${(step.type === 'content' || step.type === 'message') ? 
                                '<label class="block text-sm font-medium text-gray-300 mb-2">Mensagem</label>' +
                                '<textarea id="step-message-' + stepId + '" rows="4" ' +
                                'class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                                (step.config && step.config.message ? String(step.config.message).replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '') +
                                '</textarea>' : ''}
                            ${(step.type === 'content' || step.type === 'video') ? 
                                '<label class="block text-sm font-medium text-gray-300 mb-2 mt-4">URL da M√≠dia</label>' +
                                '<input type="url" id="step-media-url-' + stepId + '" value="' +
                                (step.config && step.config.media_url ? String(step.config.media_url).replace(/"/g, '&quot;') : '') +
                                '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' : ''}
                            ${step.type === 'access' ? 
                                '<label class="block text-sm font-medium text-gray-300 mb-2">Link de Acesso (opcional)</label>' +
                                '<input type="url" id="step-link-' + stepId + '" value="' +
                                (step.config && step.config.link ? String(step.config.link).replace(/"/g, '&quot;') : '') +
                                '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' : ''}
                            ${(step.type !== 'access') ? (() => {
                                const self = this;
                                function escapeHtml(text) {
                                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                                    return String(text).replace(/[&<>"']/g, m => map[m]);
                                }
                                let html = '';
                                
                                // Bot√µes principais (main_buttons)
                                if (self.config.main_buttons && self.config.main_buttons.length > 0) {
                                    html += '<div class="mb-4"><div class="text-xs font-bold text-blue-400 mb-2">üí∞ Bot√µes de Pagamento</div>';
                                    self.config.main_buttons.forEach((button, index) => {
                                        const selected = (step.config && step.config.selected_buttons) ? 
                                            step.config.selected_buttons.some(b => b.type === 'main' && b.index === index) : false;
                                        const buttonText = button.text || 'Bot√£o ' + (index + 1);
                                        const buttonPrice = button.price ? 'R$ ' + parseFloat(button.price).toFixed(2) : 'Sem pre√ßo';
                                        html += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-blue-500 transition-all mb-2">' +
                                            '<input type="checkbox" ' +
                                            'id="button-main-' + index + '-' + stepId + '" ' +
                                            (selected ? 'checked' : '') +
                                            ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-blue-500">' +
                                            '<div class="flex-1">' +
                                            '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                            '<div class="text-xs text-gray-400">' + escapeHtml(buttonPrice) + '</div>' +
                                            '</div>' +
                                            '</label>';
                                    });
                                    html += '</div>';
                                }
                                
                                // Bot√µes de redirecionamento (redirect_buttons)
                                if (self.config.redirect_buttons && self.config.redirect_buttons.length > 0) {
                                    html += '<div><div class="text-xs font-bold text-green-400 mb-2">üîó Bot√µes de Link</div>';
                                    self.config.redirect_buttons.forEach((button, index) => {
                                        const selected = (step.config && step.config.selected_buttons) ? 
                                            step.config.selected_buttons.some(b => b.type === 'redirect' && b.index === index) : false;
                                        const buttonText = button.text || 'Link ' + (index + 1);
                                        const buttonUrl = button.url || 'Sem URL';
                                        html += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-green-500 transition-all mb-2">' +
                                            '<input type="checkbox" ' +
                                            'id="button-redirect-' + index + '-' + stepId + '" ' +
                                            (selected ? 'checked' : '') +
                                            ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-green-500">' +
                                            '<div class="flex-1">' +
                                            '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                            '<div class="text-xs text-gray-400 font-mono truncate">' + escapeHtml(buttonUrl) + '</div>' +
                                            '</div>' +
                                            '</label>';
                                    });
                                    html += '</div>';
                                }
                                
                                if (!html) {
                                    html = '<div class="text-center py-4 text-gray-500 text-sm">‚ö†Ô∏è Nenhum bot√£o cadastrado na aba "Bot√µes". <br><span class="text-xs">Adicione bot√µes antes de usar este step.</span></div>';
                                }
                                
                                // ‚úÖ Para TODOS os tipos (exceto access), mostrar ambas as op√ß√µes: bot√µes cadastrados E customizados
                                const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
                                const stepOptionsForBtn = availableSteps.map(s => {
                                    const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                    return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
                                }).join('');
                                
                                const customButtons = (step.config && step.config.custom_buttons) || [];
                                let customButtonsHtml = '';
                                if (customButtons.length === 0) {
                                    customButtonsHtml = '<div class="text-xs text-blue-300 italic text-center py-2">Nenhum bot√£o adicionado. Clique em "Adicionar Bot√£o" para criar um.</div>';
                                } else {
                                    customButtonsHtml = customButtons.map((btn, idx) => {
                                        // Construir options com selected correto
                                        const stepOptionsWithSelected = availableSteps.map(s => {
                                            const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                            const selected = (btn.target_step === s.id) ? ' selected' : '';
                                            return `<option value="${s.id}"${selected}>${s.order || 0} - ${stepLabel}</option>`;
                                        }).join('');
                                        
                                        return `
                                            <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-blue-600 mb-2">
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                                    <div class="md:col-span-2">
                                                        <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Bot√£o</label>
                                                        <input type="text" 
                                                               name="custom-btn-text-${stepId}-${idx}" 
                                                               value="${escapeHtml(btn.text || '')}"
                                                               placeholder="Ex: Sim, quero!"
                                                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                                               maxlength="64">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-medium text-gray-300 mb-1">üîó Ir para Step</label>
                                                        <select name="custom-btn-target-${stepId}-${idx}" 
                                                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                                            <option value="">Nenhum</option>${stepOptionsWithSelected}
                                                        </select>
                                                    </div>
                                                </div>
                                                <button type="button" 
                                                        onclick="window.removeCustomButton('${stepId}', ${idx})"
                                                        class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                                                    <i class="fas fa-times mr-1"></i>Remover
                                                </button>
                                            </div>
                                        `;
                                    }).join('');
                                }
                                
                                return '<div class="mt-4 space-y-4">' +
                                    // ‚úÖ Se√ß√£o 1: Bot√µes Cadastrados
                                    '<div class="p-4 bg-gray-800 rounded-lg border border-gray-700">' +
                                    '<label class="block text-sm font-bold text-gray-300 mb-3">' +
                                    '<i class="fas fa-list mr-2"></i>Bot√µes Cadastrados (da aba "Bot√µes")' +
                                    '</label>' +
                                    '<p class="text-xs text-gray-400 mb-3">Selecione bot√µes j√° cadastrados na aba "Bot√µes" para usar neste step.</p>' +
                                    '<div class="space-y-3 max-h-64 overflow-y-auto">' +
                                    html +
                                    '</div>' +
                                    '</div>' +
                                    // ‚úÖ Se√ß√£o 2: Bot√µes Customizados
                                    '<div class="p-4 bg-blue-900 bg-opacity-30 border-2 border-blue-500 rounded-lg">' +
                                    '<label class="block text-sm font-bold text-blue-200 mb-3">' +
                                    '<i class="fas fa-toggle-on mr-2"></i>Bot√µes Customizados (Cada bot√£o pode levar a um step diferente)' +
                                    '</label>' +
                                    '<p class="text-xs text-blue-100 mb-3">Adicione bot√µes personalizados. Cada bot√£o pode levar o lead para um step diferente do fluxo. Conecte visualmente no editor de fluxo.</p>' +
                                    '<div id="custom-buttons-list-' + stepId + '" class="space-y-2 mb-3">' +
                                    customButtonsHtml +
                                    '</div>' +
                                    '<button type="button" ' +
                                    'onclick="window.addCustomButton(\'' + stepId + '\')"' +
                                    'class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">' +
                                    '<i class="fas fa-plus mr-2"></i>Adicionar Bot√£o Customizado' +
                                    '</button>' +
                                    '</div>' +
                                    '</div>';
                            })() : ''}
                        </div>
                        ${step.type === 'message' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg border border-yellow-700">
                                <label class="block text-sm font-medium text-yellow-300 mb-2">
                                    <i class="fas fa-redo mr-2"></i>Quando lead enviar mensagem ‚Üí Ir para Step:
                                </label>
                                <select id="step-retry-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white mb-2">
                                    <option value="">Nenhum (fluxo para aqui)</option>${stepOptions}
                                </select>
                                <div class="mt-2 p-2 bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded text-xs text-yellow-200">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>Como funciona:</strong> Ap√≥s enviar esta mensagem, quando o lead responder com <strong>qualquer texto</strong>, o fluxo automaticamente ir√° para o step selecionado acima. 
                                    <br><span class="text-yellow-300 mt-1 block">üí° √ötil para: verificar mensagens, processar respostas, criar loops de valida√ß√£o.</span>
                                </div>
                            </div>
                        ` : step.type === 'buttons' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg border border-purple-700">
                                <label class="block text-sm font-medium text-purple-300 mb-3">
                                    <i class="fas fa-toggle-on mr-2"></i>Tipo de Bot√µes
                                </label>
                                <div class="mb-4">
                                    <label class="flex items-center gap-2 mb-2">
                                        <input type="radio" 
                                               name="button-type-${stepId}" 
                                               value="global" 
                                               ${(!step.config || !step.config.use_custom_buttons) ? 'checked' : ''}
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               onchange="document.getElementById('button-global-${stepId}').style.display = 'block'; document.getElementById('button-custom-${stepId}').style.display = 'none';"
                                               style="accent-color: #A855F7;">
                                        <span class="text-white">üåê Bot√µes Globais (da aba "Bot√µes")</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" 
                                               name="button-type-${stepId}" 
                                               value="custom" 
                                               ${(step.config && step.config.use_custom_buttons) ? 'checked' : ''}
                                               class="w-4 h-4 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                                               onchange="document.getElementById('button-global-${stepId}').style.display = 'none'; document.getElementById('button-custom-${stepId}').style.display = 'block';"
                                               style="accent-color: #A855F7;">
                                        <span class="text-white">‚ú® Bot√µes Contextuais (espec√≠ficos deste step)</span>
                                    </label>
                                </div>
                                
                                <!-- Bot√µes Globais -->
                                <div id="button-global-${stepId}" style="display: ${(step.config && step.config.use_custom_buttons) ? 'none' : 'block'};">
                                    <p class="text-xs text-gray-400 mb-2">Selecione os bot√µes cadastrados na aba "Bot√µes":</p>
                                </div>
                                
                                <!-- Bot√µes Contextuais -->
                                <div id="button-custom-${stepId}" style="display: ${(step.config && step.config.use_custom_buttons) ? 'block' : 'none'};">
                                    <div class="mb-3">
                                        <label class="block text-xs font-medium text-gray-300 mb-2">
                                            <i class="fas fa-plus-circle mr-1 text-purple-400"></i>Bot√µes Contextuais
                                        </label>
                                        <div id="custom-buttons-list-${stepId}" class="space-y-2 mb-3">
                                            ${(() => {
                                                const customButtons = (step.config && step.config.custom_buttons) || [];
                                                if (customButtons.length === 0) {
                                                    return '<div class="text-xs text-gray-500 italic">Nenhum bot√£o contextual adicionado. Clique em "Adicionar Bot√£o Contextual" para criar um.</div>';
                                                }
                                                const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
                                                const stepOptions = availableSteps.map(s => {
                                                    const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                                    return `<option value="${s.id}" ${btn.target_step === s.id ? 'selected' : ''}>${s.order || 0} - ${stepLabel}</option>`;
                                                }).join('');
                                                return customButtons.map((btn, idx) => `
                                                    <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-purple-600 mb-2">
                                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                                            <div class="md:col-span-2">
                                                                <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Bot√£o</label>
                                                                <input type="text" 
                                                                       name="custom-btn-text-${stepId}-${idx}" 
                                                                       value="${escapeHtml(btn.text || '')}"
                                                                       placeholder="Ex: Sim, quero!"
                                                                       class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                                                       maxlength="64">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-gray-300 mb-1">Ir para Step</label>
                                                                <select name="custom-btn-target-${stepId}-${idx}" 
                                                                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                                                    <option value="">Nenhum</option>${stepOptions}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <button type="button" 
                                                                onclick="window.removeCustomButton('${stepId}', ${idx})"
                                                                class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                                                            <i class="fas fa-times mr-1"></i>Remover
                                                        </button>
                                                    </div>
                                                `).join('');
                                            })()}
                                        </div>
                                        <button type="button" 
                                                onclick="window.addCustomButton('${stepId}')"
                                                class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-medium transition">
                                            <i class="fas fa-plus mr-2"></i>Adicionar Bot√£o Contextual
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Pr√≥ximo Step (s√≥ para bot√µes globais) -->
                                <div id="step-next-global-${stepId}" style="display: ${(step.config && step.config.use_custom_buttons) ? 'none' : 'block'};" class="mt-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Pr√≥ximo ‚Üí Step:</label>
                                    <select id="step-next-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                        <option value="">Nenhum</option>${stepOptions}
                                    </select>
                                </div>
                            </div>
                        ` : step.type === 'content' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-arrow-right mr-2"></i>Pr√≥ximo ‚Üí Step (opcional):
                                </label>
                                <select id="step-next-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                    <option value="">Nenhum (bot√µes customizados j√° t√™m destino)</option>${stepOptions}
                                </select>
                                <p class="text-xs text-gray-400 mt-2">
                                    üí° Se nenhum bot√£o for clicado, o fluxo seguir√° para este step. Se deixar vazio, o fluxo para aqui se nenhum bot√£o for clicado.
                                </p>
                            </div>
                        ` : step.type !== 'access' ? `
                            <div class="mb-4 p-4 bg-gray-800 rounded-lg">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pr√≥ximo ‚Üí Step:</label>
                                <select id="step-next-${stepId}" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                    <option value="">Nenhum</option>${stepOptions}
                                </select>
                            </div>
                        ` : ''}
                        
                        <!-- ‚úÖ SISTEMA DE CONDI√á√ïES (para todos os steps exceto 'access') -->
                        ${step.type !== 'access' ? `
                            <div class="mb-4 p-4 bg-blue-900 bg-opacity-30 border-2 border-blue-500 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-bold text-blue-200">
                                        <i class="fas fa-code-branch mr-2"></i>Condi√ß√µes (Decis√µes do Lead)
                                    </label>
                                    <button type="button" 
                                            onclick="addCondition('${stepId}')"
                                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-medium transition">
                                        <i class="fas fa-plus mr-1"></i>Adicionar
                                    </button>
                                </div>
                                <p class="text-xs text-blue-100 mb-3">
                                    Configure condi√ß√µes para que o lead tome decis√µes e siga caminhos diferentes no funil.
                                    <br><span class="text-blue-200 font-medium">üí° Exemplo: Se email v√°lido ‚Üí Step A, Se inv√°lido ‚Üí Step B</span>
                                </p>
                                <div id="conditions-list-${stepId}" class="space-y-2">
                                    ${(() => {
                                        const conditions = (step.conditions && step.conditions.length > 0) ? step.conditions : [];
                                        if (conditions.length === 0) {
                                            return '<div class="text-xs text-blue-300 italic text-center py-2">Nenhuma condi√ß√£o configurada. Adicione condi√ß√µes para criar fluxos condicionais.</div>';
                                        }
                                        const self = this;
                                        function escapeHtml(text) {
                                            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                                            return String(text).replace(/[&<>"']/g, m => map[m]);
                                        }
                                        return conditions.map((cond, idx) => {
                                            // Gerar label da condi√ß√£o inline (n√£o depender de fun√ß√£o externa)
                                            let condLabel = 'Condi√ß√£o';
                                            if (cond.type === 'text_validation') {
                                                const validation = cond.validation || 'any';
                                                const labels = {
                                                    'email': 'Se email v√°lido',
                                                    'phone': 'Se telefone v√°lido',
                                                    'cpf': 'Se CPF v√°lido',
                                                    'contains': `Se texto cont√©m "${cond.value || ''}"`,
                                                    'equals': `Se texto igual a "${cond.value || ''}"`,
                                                    'any': 'Se qualquer texto'
                                                };
                                                condLabel = labels[validation] || 'Se texto v√°lido';
                                            } else if (cond.type === 'button_click') {
                                                condLabel = `Se bot√£o "${cond.button_text || ''}" clicado`;
                                            } else if (cond.type === 'payment_status') {
                                                const status = cond.status || 'paid';
                                                const labels = {
                                                    'paid': 'Se pagamento confirmado',
                                                    'pending': 'Se pagamento pendente',
                                                    'failed': 'Se pagamento falhou',
                                                    'expired': 'Se pagamento expirado'
                                                };
                                                condLabel = labels[status] || 'Se status de pagamento';
                                            } else if (cond.type === 'time_elapsed') {
                                                condLabel = `Se ${cond.minutes || 5} minuto(s) decorrido(s)`;
                                            }
                                            
                                            const targetStepName = self.config.flow_steps.find(s => s.id === cond.target_step)?.name || 
                                                                   self.getStepTitle(self.config.flow_steps.find(s => s.id === cond.target_step)?.type) || 
                                                                   cond.target_step.substring(0, 12);
                                            return `
                                                <div data-condition class="p-3 bg-gray-900 rounded-lg border border-blue-600">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="px-2 py-0.5 bg-blue-600 text-white rounded text-xs font-bold">${idx + 1}</span>
                                                                <span class="text-sm font-semibold text-blue-200">${escapeHtml(condLabel)}</span>
                                                            </div>
                                                            <div class="text-xs text-blue-300">
                                                                ‚Üí <span class="text-blue-200 font-bold">${escapeHtml(targetStepName)}</span>
                                                            </div>
                                                            ${cond.max_attempts && cond.max_attempts > 0 ? `
                                                                <div class="text-xs text-yellow-400 mt-1 flex items-center gap-1">
                                                                    <i class="fas fa-exclamation-triangle"></i>
                                                                    <span>M√°ximo: ${cond.max_attempts} tentativa(s)</span>
                                                                </div>
                                                            ` : ''}
                                                            ${cond.fallback_step ? `
                                                                <div class="text-xs text-purple-400 mt-1 flex items-center gap-1">
                                                                    <i class="fas fa-undo"></i>
                                                                    <span>Fallback: ${self.config.flow_steps.find(s => s.id === cond.fallback_step)?.name || cond.fallback_step.substring(0, 12)}</span>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                        <button type="button" 
                                                                onclick="removeCondition('${stepId}', ${idx})"
                                                                class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <button type="button" 
                                                            onclick="editCondition('${stepId}', ${idx})"
                                                            class="w-full mt-2 px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs">
                                                        <i class="fas fa-edit mr-1"></i>Editar
                                                    </button>
                                                </div>
                                            `;
                                        }).join('');
                                    })()}
                                </div>
                            </div>
                        ` : ''}
                        <!-- ‚úÖ MENSAGEM DE ERRO PERSONALIZADA (para steps com condi√ß√µes) -->
                        ${step.type !== 'access' && step.conditions && step.conditions.length > 0 ? `
                            <div class="mb-4 p-4 bg-orange-900 bg-opacity-20 border border-orange-500 rounded-lg">
                                <label class="block text-sm font-medium text-orange-300 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Mensagem de Erro (opcional)
                                </label>
                                <input type="text" 
                                       id="step-error-message-${stepId}" 
                                       value="${(step.config && step.config.error_message ? step.config.error_message : '‚ö†Ô∏è Resposta n√£o reconhecida. Por favor, tente novamente.').replace(/"/g, '&quot;')}" 
                                       placeholder="‚ö†Ô∏è Resposta n√£o reconhecida. Por favor, tente novamente."
                                       class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500"
                                       maxlength="200">
                                <p class="text-xs text-orange-200 mt-1">
                                    Mensagem enviada quando nenhuma condi√ß√£o matchar. Deixe vazio para usar mensagem padr√£o.
                                </p>
                            </div>
                        ` : ''}
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" onclick="document.body.style.overflow = ''; document.getElementById('flow-step-modal-${stepId}').remove()" 
                                    class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancelar</button>
                            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                <i class="fas fa-save mr-2"></i>Salvar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Inicializar editor (bind this)
            const self = this;
            if (!window.flowStepEditor) {
                window.flowStepEditor = {};
            }
            
            // ‚úÖ Fun√ß√£o para atualizar conte√∫do do modal baseado no tipo selecionado
            function updateConfigContent(stepId, stepType, currentStep) {
                const configDiv = document.getElementById(`config-content-${stepId}`);
                if (!configDiv) return;
                
                function escapeHtml(text) {
                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                    return String(text).replace(/[&<>"']/g, m => map[m]);
                }
                
                let html = '';
                
                if (stepType === 'content' || stepType === 'message') {
                    html += '<label class="block text-sm font-medium text-gray-300 mb-2">Mensagem</label>' +
                        '<textarea id="step-message-' + stepId + '" rows="4" ' +
                        'class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                        escapeHtml((currentStep.config && currentStep.config.message) || '') +
                        '</textarea>';
                }
                
                if (stepType === 'content' || stepType === 'video') {
                    html += '<label class="block text-sm font-medium text-gray-300 mb-2 mt-4">URL da M√≠dia</label>' +
                        '<input type="url" id="step-media-url-' + stepId + '" value="' +
                        escapeHtml((currentStep.config && currentStep.config.media_url) || '') +
                        '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">';
                }
                
                if (stepType === 'access') {
                    html += '<label class="block text-sm font-medium text-gray-300 mb-2">Link de Acesso (opcional)</label>' +
                        '<input type="url" id="step-link-' + stepId + '" value="' +
                        escapeHtml((currentStep.config && currentStep.config.link) || '') +
                        '" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">';
                }
                
                // ‚úÖ Para TODOS os tipos (exceto access), construir se√ß√£o de bot√µes
                if (stepType !== 'access') {
                    let buttonsHtml = '';
                    
                    // Bot√µes principais (main_buttons)
                    if (self.config.main_buttons && self.config.main_buttons.length > 0) {
                        buttonsHtml += '<div class="mb-4"><div class="text-xs font-bold text-blue-400 mb-2">üí∞ Bot√µes de Pagamento</div>';
                        self.config.main_buttons.forEach((button, index) => {
                            const selected = (currentStep.config && currentStep.config.selected_buttons) ? 
                                currentStep.config.selected_buttons.some(b => b.type === 'main' && b.index === index) : false;
                            const buttonText = button.text || 'Bot√£o ' + (index + 1);
                            const buttonPrice = button.price ? 'R$ ' + parseFloat(button.price).toFixed(2) : 'Sem pre√ßo';
                            buttonsHtml += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-blue-500 transition-all mb-2">' +
                                '<input type="checkbox" ' +
                                'id="button-main-' + index + '-' + stepId + '" ' +
                                (selected ? 'checked' : '') +
                                ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-blue-500">' +
                                '<div class="flex-1">' +
                                '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                '<div class="text-xs text-gray-400">' + escapeHtml(buttonPrice) + '</div>' +
                                '</div>' +
                                '</label>';
                        });
                        buttonsHtml += '</div>';
                    }
                    
                    // Bot√µes de redirecionamento (redirect_buttons)
                    if (self.config.redirect_buttons && self.config.redirect_buttons.length > 0) {
                        buttonsHtml += '<div><div class="text-xs font-bold text-green-400 mb-2">üîó Bot√µes de Link</div>';
                        self.config.redirect_buttons.forEach((button, index) => {
                            const selected = (currentStep.config && currentStep.config.selected_buttons) ? 
                                currentStep.config.selected_buttons.some(b => b.type === 'redirect' && b.index === index) : false;
                            const buttonText = button.text || 'Link ' + (index + 1);
                            const buttonUrl = button.url || 'Sem URL';
                            buttonsHtml += '<label class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-850 border border-gray-700 hover:border-green-500 transition-all mb-2">' +
                                '<input type="checkbox" ' +
                                'id="button-redirect-' + index + '-' + stepId + '" ' +
                                (selected ? 'checked' : '') +
                                ' class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-green-500">' +
                                '<div class="flex-1">' +
                                '<div class="text-sm font-bold text-white">' + escapeHtml(buttonText) + '</div>' +
                                '<div class="text-xs text-gray-400 font-mono truncate">' + escapeHtml(buttonUrl) + '</div>' +
                                '</div>' +
                                '</label>';
                        });
                        buttonsHtml += '</div>';
                    }
                    
                    if (!buttonsHtml) {
                        buttonsHtml = '<div class="text-center py-4 text-gray-500 text-sm">‚ö†Ô∏è Nenhum bot√£o cadastrado na aba "Bot√µes". <br><span class="text-xs">Adicione bot√µes antes de usar este step.</span></div>';
                    }
                    
                    // ‚úÖ Para TODOS os tipos (exceto access), adicionar se√ß√£o de bot√µes
                    if (stepType !== 'access') {
                        const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
                        const stepOptionsForBtn = availableSteps.map(s => {
                            const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                            return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
                        }).join('');
                        
                        const customButtons = (currentStep.config && currentStep.config.custom_buttons) || [];
                        let customButtonsHtml = '';
                        if (customButtons.length === 0) {
                            customButtonsHtml = '<div class="text-xs text-blue-300 italic text-center py-2">Nenhum bot√£o adicionado. Clique em "Adicionar Bot√£o" para criar um.</div>';
                        } else {
                            customButtonsHtml = customButtons.map((btn, idx) => {
                                // Construir options com selected correto
                                const stepOptionsWithSelected = availableSteps.map(s => {
                                    const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                                    const selected = (btn.target_step === s.id) ? ' selected' : '';
                                    return `<option value="${s.id}"${selected}>${s.order || 0} - ${stepLabel}</option>`;
                                }).join('');
                                
                                return `
                                    <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-blue-600 mb-2">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                            <div class="md:col-span-2">
                                                <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Bot√£o</label>
                                                <input type="text" 
                                                       name="custom-btn-text-${stepId}-${idx}" 
                                                       value="${escapeHtml(btn.text || '')}"
                                                       placeholder="Ex: Sim, quero!"
                                                       class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                                       maxlength="64">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-300 mb-1">üîó Ir para Step</label>
                                                <select name="custom-btn-target-${stepId}-${idx}" 
                                                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                                    <option value="">Nenhum</option>${stepOptionsWithSelected}
                                                </select>
                                            </div>
                                        </div>
                                        <button type="button" 
                                                onclick="window.removeCustomButton('${stepId}', ${idx})"
                                                class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                                            <i class="fas fa-times mr-1"></i>Remover
                                        </button>
                                    </div>
                                `;
                            }).join('');
                        }
                        
                        html += '<div class="mt-4 space-y-4">' +
                            // ‚úÖ Se√ß√£o 1: Bot√µes Cadastrados
                            '<div class="p-4 bg-gray-800 rounded-lg border border-gray-700">' +
                            '<label class="block text-sm font-bold text-gray-300 mb-3">' +
                            '<i class="fas fa-list mr-2"></i>Bot√µes Cadastrados (da aba "Bot√µes")' +
                            '</label>' +
                            '<p class="text-xs text-gray-400 mb-3">Selecione bot√µes j√° cadastrados na aba "Bot√µes" para usar neste step.</p>' +
                            '<div class="space-y-3 max-h-64 overflow-y-auto">' +
                            buttonsHtml +
                            '</div>' +
                            '</div>' +
                            // ‚úÖ Se√ß√£o 2: Bot√µes Customizados
                            '<div class="p-4 bg-blue-900 bg-opacity-30 border-2 border-blue-500 rounded-lg">' +
                            '<label class="block text-sm font-bold text-blue-200 mb-3">' +
                            '<i class="fas fa-toggle-on mr-2"></i>Bot√µes Customizados (Cada bot√£o pode levar a um step diferente)' +
                            '</label>' +
                            '<p class="text-xs text-blue-100 mb-3">Adicione bot√µes personalizados. Cada bot√£o pode levar o lead para um step diferente do fluxo. Conecte visualmente no editor de fluxo.</p>' +
                            '<div id="custom-buttons-list-' + stepId + '" class="space-y-2 mb-3">' +
                            customButtonsHtml +
                            '</div>' +
                            '<button type="button" ' +
                            'onclick="window.addCustomButton(\'' + stepId + '\')"' +
                            'class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">' +
                            '<i class="fas fa-plus mr-2"></i>Adicionar Bot√£o Customizado' +
                            '</button>' +
                            '</div>' +
                            '</div>';
                    }
                }
                
                configDiv.innerHTML = html;
                
                // Atualizar conex√µes tamb√©m
                const form = configDiv.closest('form');
                if (form) {
                    const stepOptions = self.config.flow_steps
                        .filter(s => s.id !== stepId)
                        .map(s => {
                            const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                            return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
                        })
                        .join('');
                    
                    // Remover conex√µes existentes
                    const existingConnections = form.querySelectorAll('[id*="step-next"], [id*="step-pending"], [id*="step-retry"]');
                    existingConnections.forEach(el => {
                        const container = el.closest('.mb-4.p-4.bg-gray-800');
                        if (container) container.remove();
                    });
                    
                    // Adicionar conex√µes baseado no tipo
                    let connectionsHtml = '';
                    if (stepType === 'message') {
                        const retryVal = (currentStep.connections && currentStep.connections.retry) || '';
                        connectionsHtml = '<div class="mb-4 p-4 bg-gray-800 rounded-lg border border-yellow-700">' +
                            '<label class="block text-sm font-medium text-yellow-300 mb-2">' +
                            '<i class="fas fa-redo mr-2"></i>Quando lead enviar mensagem ‚Üí Ir para Step:' +
                            '</label>' +
                            '<select id="step-retry-' + stepId + '" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white mb-2">' +
                            '<option value="">Nenhum (fluxo para aqui)</option>' + stepOptions +
                            '</select>' +
                            '<div class="mt-2 p-2 bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded text-xs text-yellow-200">' +
                            '<i class="fas fa-info-circle mr-1"></i>' +
                            '<strong>Como funciona:</strong> Ap√≥s enviar esta mensagem, quando o lead responder com <strong>qualquer texto</strong>, o fluxo automaticamente ir√° para o step selecionado acima. ' +
                            '<br><span class="text-yellow-300 mt-1 block">üí° √ötil para: verificar mensagens, processar respostas, criar loops de valida√ß√£o.</span>' +
                            '</div>' +
                            '</div>';
                        setTimeout(() => {
                            const retrySelect = document.getElementById(`step-retry-${stepId}`);
                            if (retrySelect && retryVal) retrySelect.value = retryVal;
                        }, 10);
                    } else if (stepType === 'content') {
                        const nextVal = (currentStep.connections && currentStep.connections.next) || '';
                        connectionsHtml = '<div class="mb-4 p-4 bg-gray-800 rounded-lg border border-gray-600">' +
                            '<label class="block text-sm font-medium text-gray-300 mb-2">' +
                            '<i class="fas fa-arrow-right mr-2"></i>Pr√≥ximo ‚Üí Step (opcional):' +
                            '</label>' +
                            '<select id="step-next-' + stepId + '" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                            '<option value="">Nenhum (bot√µes customizados j√° t√™m destino)</option>' + stepOptions +
                            '</select>' +
                            '<p class="text-xs text-gray-400 mt-2">' +
                            'üí° Se nenhum bot√£o for clicado, o fluxo seguir√° para este step. Se deixar vazio, o fluxo para aqui se nenhum bot√£o for clicado.' +
                            '</p>' +
                            '</div>';
                        setTimeout(() => {
                            const nextSelect = document.getElementById(`step-next-${stepId}`);
                            if (nextSelect && nextVal) nextSelect.value = nextVal;
                        }, 10);
                    } else if (stepType !== 'access' && stepType !== 'payment' && stepType !== 'message' && stepType !== 'content') {
                        const nextVal = (currentStep.connections && currentStep.connections.next) || '';
                        connectionsHtml = '<div class="mb-4 p-4 bg-gray-800 rounded-lg">' +
                            '<label class="block text-sm font-medium text-gray-300 mb-2">Pr√≥ximo ‚Üí Step:</label>' +
                            '<select id="step-next-' + stepId + '" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white">' +
                            '<option value="">Nenhum</option>' + stepOptions +
                            '</select>' +
                            '</div>';
                        setTimeout(() => {
                            const nextSelect = document.getElementById(`step-next-${stepId}`);
                            if (nextSelect && nextVal) nextSelect.value = nextVal;
                        }, 10);
                    }
                    
                    if (connectionsHtml) {
                        const buttonsContainer = form.querySelector('.flex.justify-end.gap-3.mt-6');
                        if (buttonsContainer) {
                            buttonsContainer.insertAdjacentHTML('beforebegin', connectionsHtml);
                        } else {
                            configDiv.insertAdjacentHTML('afterend', connectionsHtml);
                        }
                    }
                }
            }
            
            // ‚úÖ Event listener para atualizar conte√∫do quando o tipo muda
            const typeSelect = document.getElementById(`step-type-${stepId}`);
            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    const stepIndex = self.config.flow_steps.findIndex(s => s.id === stepId);
                    if (stepIndex === -1) return;
                    const currentStep = self.config.flow_steps[stepIndex];
                    
                    // Atualizar help explicativo
                    const helpDiv = document.getElementById(`step-type-help-${stepId}`);
                    if (helpDiv) {
                        const helps = {
                            'content': 'üì∏ <strong>Conte√∫do:</strong> Ideal para apresenta√ß√£o. Envia mensagem com foto/v√≠deo e bot√µes.',
                            'message': 'üí¨ <strong>Mensagem:</strong> Envia texto e bot√µes. Quando o lead responder, voc√™ pode configurar um step de verifica√ß√£o para processar a resposta.',
                            'audio': 'üéµ <strong>√Åudio:</strong> Envia √°udio do Telegram e pode incluir bot√µes. Ideal para criar conex√£o pessoal.',
                            'video': 'üñºÔ∏è <strong>M√≠dia Foto/Video:</strong> Envia foto ou v√≠deo do Telegram e pode incluir bot√µes. Perfeito para explica√ß√µes detalhadas.',
                            'access': '‚úÖ <strong>Acesso:</strong> Libera acesso final e <strong>encerra o fluxo</strong>. N√£o deve ter conex√µes.'
                        };
                        helpDiv.innerHTML = helps[this.value] || 'Selecione um tipo de step';
                    }
                    
                    updateConfigContent(stepId, this.value, currentStep);
                });
            }
            window.flowStepEditor['saveStep_' + stepId] = function() {
                const stepIndex = self.config.flow_steps.findIndex(s => s.id === stepId);
                if (stepIndex === -1) return;
                
                const step = self.config.flow_steps[stepIndex];
                step.name = (document.getElementById(`step-name-${stepId}`)?.value || '').trim() || null;
                step.type = document.getElementById(`step-type-${stepId}`).value;
                step.order = parseInt(document.getElementById(`step-order-${stepId}`).value) || 1;
                step.delay_seconds = parseFloat(document.getElementById(`step-delay-${stepId}`).value) || 0;
                
                // ‚úÖ VALIDA√á√ïES DE UX
                let warnings = [];
                
                if (step.type === 'content' || step.type === 'message') {
                    step.config.message = document.getElementById(`step-message-${stepId}`)?.value || '';
                    if (!step.config.message || step.config.message.trim() === '') {
                        warnings.push('‚ö†Ô∏è Mensagem vazia - este step n√£o enviar√° nenhum texto ao lead');
                    }
                }
                
                // Validar conex√µes faltantes (exceto 'access')
                if (step.type !== 'access') {
                    const nextSelect = document.getElementById(`step-next-${stepId}`);
                    const pendingSelect = document.getElementById(`step-pending-${stepId}`);
                    const retrySelect = document.getElementById(`step-retry-${stepId}`);
                    
                    const hasNext = nextSelect && nextSelect.value;
                    const hasPending = pendingSelect && pendingSelect.value;
                    const hasRetry = retrySelect && retrySelect.value;
                    
                    // ‚úÖ Validar loops circulares (prevenir recurs√£o infinita)
                    function checkCircularConnection(fromStepId, toStepId, visited = new Set(), depth = 0) {
                        if (depth > 20) return true; // Loop detectado (limite de seguran√ßa)
                        if (fromStepId === toStepId) return true; // Auto-refer√™ncia direta
                        if (visited.has(toStepId)) return true; // Loop circular - voltou ao step j√° visitado
                        
                        visited.add(fromStepId);
                        const targetStep = self.config.flow_steps.find(s => s.id === toStepId);
                        if (!targetStep || !targetStep.connections) return false;
                        
                        // Se o step de destino conecta de volta ao step original, √© um loop
                        if (targetStep.connections.next === fromStepId || 
                            targetStep.connections.pending === fromStepId || 
                            targetStep.connections.retry === fromStepId) {
                            return true;
                        }
                        
                        // Verificar conex√µes do step de destino recursivamente
                        if (targetStep.connections.next && checkCircularConnection(fromStepId, targetStep.connections.next, new Set(visited), depth + 1)) {
                            return true;
                        }
                        if (targetStep.connections.pending && checkCircularConnection(fromStepId, targetStep.connections.pending, new Set(visited), depth + 1)) {
                            return true;
                        }
                        if (targetStep.connections.retry && checkCircularConnection(fromStepId, targetStep.connections.retry, new Set(visited), depth + 1)) {
                            return true;
                        }
                        return false;
                    }
                    
                    if (hasNext && checkCircularConnection(stepId, hasNext)) {
                        warnings.push('‚ö†Ô∏è Loop circular detectado na conex√£o "Pr√≥ximo"! Esta conex√£o pode causar recurs√£o infinita. O fluxo pode ficar preso em loop.');
                    }
                    if (hasPending && checkCircularConnection(stepId, hasPending)) {
                        warnings.push('‚ö†Ô∏è Loop circular detectado na conex√£o "Se n√£o pago"! Pode causar recurs√£o infinita.');
                    }
                    if (hasRetry && checkCircularConnection(stepId, hasRetry)) {
                        warnings.push('‚ö†Ô∏è Loop circular detectado na conex√£o "Retry"! Pode causar recurs√£o infinita.');
                    }
                    
                    if (step.type === 'message') {
                        // Message pode ter retry ou next
                        if (!hasRetry && !hasNext) {
                            warnings.push('‚ö†Ô∏è Step sem conex√µes - o fluxo pode parar aqui. Adicione uma conex√£o "Pr√≥ximo" ou "Retry"');
                        }
                    } else if (!hasNext) {
                        warnings.push('‚ö†Ô∏è Step sem conex√£o "Pr√≥ximo" - o fluxo pode parar aqui. Adicione uma conex√£o para continuar');
                    }
                }
                
                // Mostrar avisos (n√£o bloquear, apenas alertar)
                if (warnings.length > 0) {
                    if (!confirm(warnings.join('\n') + '\n\nDeseja salvar mesmo assim?')) {
                        return; // Usu√°rio cancelou
                    }
                }
                
                // ‚úÖ Auto-numerar ordem sequencial ap√≥s salvar (garantir sequ√™ncia 1, 2, 3, 4...)
                const sortedSteps = [...self.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                sortedSteps.forEach((s, index) => {
                    const newOrder = index + 1;
                    if (s.order !== newOrder) {
                        s.order = newOrder;
                    }
                });
                
                if (step.type === 'content' || step.type === 'video') {
                    step.config.media_url = document.getElementById(`step-media-url-${stepId}`)?.value || '';
                    step.config.media_type = step.config.media_type || 'video';
                }
                if (step.type === 'access') {
                    step.config.link = document.getElementById(`step-link-${stepId}`)?.value || '';
                    step.config.message = step.config.message || 'Acesso liberado!';
                }
                // ‚úÖ Para TODOS os tipos (exceto access), salvar tanto bot√µes cadastrados quanto customizados
                if (step.type !== 'access') {
                    // ‚úÖ 1. Salvar bot√µes customizados
                    const customButtons = [];
                    const customButtonsList = document.getElementById(`custom-buttons-list-${stepId}`);
                    if (customButtonsList) {
                        // ‚úÖ CORRE√á√ÉO: Buscar pelos atributos name reais, n√£o pelo √≠ndice do forEach
                        customButtonsList.querySelectorAll('[data-custom-button]').forEach((btnEl) => {
                            // Buscar input de texto (pode ter qualquer √≠ndice no name)
                            const textInput = btnEl.querySelector(`input[name^="custom-btn-text-${stepId}-"]`);
                            // Buscar select de target (pode ter qualquer √≠ndice no name)
                            const targetSelect = btnEl.querySelector(`select[name^="custom-btn-target-${stepId}-"]`);
                            
                            if (textInput) {
                                const text = textInput.value || '';
                                const targetStep = targetSelect ? (targetSelect.value || '') : '';
                                
                                if (text.trim()) {
                                    customButtons.push({
                                        text: text.trim(),
                                        target_step: targetStep || null
                                    });
                                }
                            }
                        });
                    }
                    if (!step.config) step.config = {};
                    step.config.custom_buttons = customButtons;
                    
                    // ‚úÖ 2. Salvar bot√µes cadastrados selecionados
                    const selectedButtons = [];
                    
                    // Verificar bot√µes principais (main_buttons)
                    if (self.config.main_buttons) {
                        self.config.main_buttons.forEach((button, index) => {
                            const checkbox = document.getElementById(`button-main-${index}-${stepId}`);
                            if (checkbox && checkbox.checked) {
                                selectedButtons.push({ type: 'main', index: index });
                            }
                        });
                    }
                    
                    // Verificar bot√µes de redirecionamento (redirect_buttons)
                    if (self.config.redirect_buttons) {
                        self.config.redirect_buttons.forEach((button, index) => {
                            const checkbox = document.getElementById(`button-redirect-${index}-${stepId}`);
                            if (checkbox && checkbox.checked) {
                                selectedButtons.push({ type: 'redirect', index: index });
                            }
                        });
                    }
                    
                    step.config.selected_buttons = selectedButtons;
                }
                
                if (step.type === 'message') {
                    step.connections.retry = document.getElementById(`step-retry-${stepId}`)?.value || '';
                    step.connections.next = document.getElementById(`step-next-${stepId}`)?.value || '';
                } else if (step.type === 'buttons' || (step.type !== 'access' && step.type !== 'payment' && step.type !== 'message')) {
                    step.connections.next = document.getElementById(`step-next-${stepId}`)?.value || '';
                }
                // ‚úÖ Compatibilidade: Se for payment (steps antigos), manter l√≥gica antiga
                if (step.type === 'payment') {
                    step.connections.next = document.getElementById(`step-next-${stepId}`)?.value || '';
                    step.connections.pending = document.getElementById(`step-pending-${stepId}`)?.value || '';
                }
                
                // ‚úÖ SALVAR MENSAGEM DE ERRO PERSONALIZADA
                if (step.conditions && step.conditions.length > 0) {
                    const errorMessageInput = document.getElementById(`step-error-message-${stepId}`);
                    if (errorMessageInput) {
                        const errorMessage = errorMessageInput.value.trim();
                        if (errorMessage) {
                            if (!step.config) step.config = {};
                            step.config.error_message = errorMessage;
                        } else {
                            // Se vazio, usar padr√£o (ser√° definido no backend)
                            if (step.config) {
                                delete step.config.error_message;
                            }
                        }
                    }
                }
                
                // ‚úÖ SALVAR CONDI√á√ïES
                const conditionsList = document.getElementById(`conditions-list-${stepId}`);
                if (conditionsList) {
                    const conditions = [];
                    conditionsList.querySelectorAll('[data-condition]').forEach((condEl, idx) => {
                        const condType = condEl.querySelector(`select[name="condition-type-${stepId}-${idx}"]`)?.value;
                        const targetStep = condEl.querySelector(`select[name="condition-target-${stepId}-${idx}"]`)?.value;
                        const order = idx + 1;
                        
                        if (condType && targetStep) {
                            const condition = {
                                id: `cond_${Date.now()}_${idx}`,
                                type: condType,
                                target_step: targetStep,
                                order: order
                            };
                            
                            // Configura√ß√µes espec√≠ficas por tipo
                            if (condType === 'text_validation') {
                                condition.validation = condEl.querySelector(`select[name="condition-validation-${stepId}-${idx}"]`)?.value || 'any';
                                if (condition.validation === 'contains' || condition.validation === 'equals') {
                                    condition.value = condEl.querySelector(`input[name="condition-value-${stepId}-${idx}"]`)?.value || '';
                                }
                                condition.max_attempts = parseInt(condEl.querySelector(`input[name="condition-max-attempts-${stepId}-${idx}"]`)?.value) || null;
                            } else if (condType === 'button_click') {
                                condition.button_text = condEl.querySelector(`input[name="condition-button-text-${stepId}-${idx}"]`)?.value || '';
                            } else if (condType === 'payment_status') {
                                condition.status = condEl.querySelector(`select[name="condition-payment-status-${stepId}-${idx}"]`)?.value || 'paid';
                            } else if (condType === 'time_elapsed') {
                                condition.minutes = parseInt(condEl.querySelector(`input[name="condition-minutes-${stepId}-${idx}"]`)?.value) || 5;
                            }
                            
                            conditions.push(condition);
                        }
                    });
                    step.conditions = conditions.length > 0 ? conditions : null;
                }
                
                document.body.style.overflow = '';
                document.getElementById(`flow-step-modal-${stepId}`).remove();
                self.showNotification('‚úÖ Step salvo!', 'success');
                
                // ‚úÖ Recarregar editor visual se estiver ativo
                // ‚úÖ Recarregar editor visual (sempre visual agora)
                setTimeout(() => self.initVisualFlowEditor(), 200);
            };
        },
        
        duplicateFlowStep(stepId) {
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) {
                this.showNotification('‚ùå Step n√£o encontrado', 'error');
                return;
            }
            
            // Criar c√≥pia do step
            const newStepId = `step_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const maxOrder = this.sortedFlowSteps.length > 0 ? Math.max(...this.sortedFlowSteps.map(s => s.order || 0)) : 0;
            
            const duplicatedStep = {
                id: newStepId,
                name: step.name ? `${step.name} (C√≥pia)` : null,
                type: step.type,
                order: maxOrder + 1,
                config: JSON.parse(JSON.stringify(step.config || {})),
                connections: {},  // N√£o copiar conex√µes (evitar confus√£o)
                delay_seconds: step.delay_seconds || 0
            };
            
            this.config.flow_steps.push(duplicatedStep);
            this.showNotification(`‚úÖ Step duplicado! Edite o novo step para configurar conex√µes.`, 'success');
        },
        
        addCustomButton(stepId) {
            const customButtonsList = document.getElementById(`custom-buttons-list-${stepId}`);
            if (!customButtonsList) return;
            
            const self = this;
            function escapeHtml(text) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }
            
            const btnIndex = customButtonsList.querySelectorAll('[data-custom-button]').length;
            const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
            const stepOptions = availableSteps.map(s => {
                const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                return `<option value="${s.id}">${s.order || 0} - ${stepLabel}</option>`;
            }).join('');
            
            const btnHtml = `
                <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-purple-600 mb-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Bot√£o</label>
                            <input type="text" 
                                   name="custom-btn-text-${stepId}-${btnIndex}" 
                                   placeholder="Ex: Sim, quero!"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                   maxlength="64">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-300 mb-1">Ir para Step</label>
                            <select name="custom-btn-target-${stepId}-${btnIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                <option value="">Nenhum</option>${stepOptions}
                            </select>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="window.removeCustomButton('${stepId}', ${btnIndex})"
                            class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                        <i class="fas fa-times mr-1"></i>Remover
                    </button>
                </div>
            `;
            
            customButtonsList.insertAdjacentHTML('beforeend', btnHtml);
        },
        
        removeCustomButton(stepId, btnIndex) {
            const customButtonsList = document.getElementById(`custom-buttons-list-${stepId}`);
            if (!customButtonsList) return;
            
            const btnEls = customButtonsList.querySelectorAll('[data-custom-button]');
            if (btnIndex >= 0 && btnIndex < btnEls.length) {
                btnEls[btnIndex].remove();
            }
            
            // Atualizar √≠ndices dos inputs
            customButtonsList.querySelectorAll('[data-custom-button]').forEach((btnEl, newIdx) => {
                const textInput = btnEl.querySelector('input[type="text"]');
                const targetSelect = btnEl.querySelector('select');
                const removeBtn = btnEl.querySelector('button[onclick*="removeCustomButton"]');
                
                if (textInput) {
                    const oldName = textInput.name;
                    textInput.name = oldName.replace(/-\d+-/, `-${newIdx}-`);
                }
                if (targetSelect) {
                    const oldName = targetSelect.name;
                    targetSelect.name = oldName.replace(/-\d+-/, `-${newIdx}-`);
                }
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeCustomButton('${stepId}', ${newIdx})`);
                }
            });
        },
        
        getConditionLabel(condition) {
            if (!condition) return 'Condi√ß√£o';
            
            if (condition.type === 'text_validation') {
                const validation = condition.validation || 'any';
                const labels = {
                    'email': 'Se email v√°lido',
                    'phone': 'Se telefone v√°lido',
                    'cpf': 'Se CPF v√°lido',
                    'contains': `Se texto cont√©m "${condition.value || ''}"`,
                    'equals': `Se texto igual a "${condition.value || ''}"`,
                    'any': 'Se qualquer texto'
                };
                return labels[validation] || 'Se texto v√°lido';
            } else if (condition.type === 'button_click') {
                return `Se bot√£o "${condition.button_text || ''}" clicado`;
            } else if (condition.type === 'payment_status') {
                const status = condition.status || 'paid';
                const labels = {
                    'paid': 'Se pagamento confirmado',
                    'pending': 'Se pagamento pendente',
                    'failed': 'Se pagamento falhou',
                    'expired': 'Se pagamento expirado'
                };
                return labels[status] || 'Se status de pagamento';
            } else if (condition.type === 'time_elapsed') {
                return `Se ${condition.minutes || 5} minuto(s) decorrido(s)`;
            }
            
            return 'Condi√ß√£o';
        },
        
        addCondition(stepId) {
            this.editCondition(stepId, -1); // -1 = nova condi√ß√£o
        },
        
        editCondition(stepId, condIndex) {
            const self = this;
            const step = self.config.flow_steps.find(s => s.id === stepId);
            if (!step) return;
            
            const isNew = condIndex < 0;
            const condition = isNew ? null : (step.conditions && step.conditions[condIndex]) || null;
            
            const availableSteps = self.config.flow_steps.filter(s => s.id !== stepId);
            const stepOptions = availableSteps.map(s => {
                const stepLabel = s.name ? s.name : self.getStepTitle(s.type);
                return `<option value="${s.id}" ${condition && condition.target_step === s.id ? 'selected' : ''}>${s.order || 0} - ${stepLabel}</option>`;
            }).join('');
            
            // Determinar tipos de condi√ß√£o dispon√≠veis baseado no tipo do step
            let availableConditionTypes = [];
            if (step.type === 'message') {
                availableConditionTypes = [
                    { value: 'text_validation', label: 'üí¨ Valida√ß√£o de Texto' }
                ];
            } else if (step.type === 'buttons') {
                availableConditionTypes = [
                    { value: 'button_click', label: 'üîò Clique em Bot√£o' }
                ];
            } else if (step.type === 'payment') {
                availableConditionTypes = [
                    { value: 'payment_status', label: 'üí∞ Status de Pagamento' }
                ];
            } else {
                // Para outros tipos, permitir condi√ß√µes de tempo
                availableConditionTypes = [
                    { value: 'time_elapsed', label: '‚è∞ Tempo Decorrido' }
                ];
            }
            
            const conditionTypeOptions = availableConditionTypes.map(t => 
                `<option value="${t.value}" ${condition && condition.type === t.value ? 'selected' : ''}>${t.label}</option>`
            ).join('');
            
            // Renderizar campos espec√≠ficos baseado no tipo
            function renderConditionConfig(condType, cond) {
                if (condType === 'text_validation') {
                    const validation = cond ? (cond.validation || 'any') : 'any';
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Tipo de Valida√ß√£o:</label>
                            <select name="condition-validation-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                    onchange="updateConditionConfig('${stepId}', ${condIndex}, this.value)">
                                <option value="email" ${validation === 'email' ? 'selected' : ''}>Email v√°lido</option>
                                <option value="phone" ${validation === 'phone' ? 'selected' : ''}>Telefone v√°lido</option>
                                <option value="cpf" ${validation === 'cpf' ? 'selected' : ''}>CPF v√°lido</option>
                                <option value="contains" ${validation === 'contains' ? 'selected' : ''}>Texto cont√©m</option>
                                <option value="equals" ${validation === 'equals' ? 'selected' : ''}>Texto igual a</option>
                                <option value="any" ${validation === 'any' ? 'selected' : ''}>Qualquer texto</option>
                            </select>
                        </div>
                        <div id="condition-value-field-${stepId}-${condIndex}" class="mb-3" style="display: ${(validation === 'contains' || validation === 'equals') ? 'block' : 'none'};">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Valor esperado:</label>
                            <input type="text" 
                                   name="condition-value-${stepId}-${condIndex}" 
                                   value="${cond && cond.value ? cond.value.replace(/"/g, '&quot;') : ''}"
                                   placeholder="Ex: sim, n√£o, ok..."
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">M√°ximo de tentativas (opcional):</label>
                            <input type="number" 
                                   name="condition-max-attempts-${stepId}-${condIndex}" 
                                   value="${cond && cond.max_attempts ? cond.max_attempts : ''}"
                                   min="1" max="10"
                                   placeholder="Deixe vazio para ilimitado"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <p class="text-xs text-yellow-300 mt-1">
                                Quando atingir este limite, usar√° "Fallback Step" (se configurado)
                            </p>
                        </div>
                    `;
                } else if (condType === 'button_click') {
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Texto do bot√£o:</label>
                            <input type="text" 
                                   name="condition-button-text-${stepId}-${condIndex}" 
                                   value="${cond && cond.button_text ? cond.button_text.replace(/"/g, '&quot;') : ''}"
                                   placeholder="Ex: Sim, quero!"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">M√°ximo de tentativas (opcional):</label>
                            <input type="number" 
                                   name="condition-max-attempts-${stepId}-${condIndex}" 
                                   value="${cond && cond.max_attempts ? cond.max_attempts : ''}"
                                   min="1" max="10"
                                   placeholder="Deixe vazio para ilimitado"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <p class="text-xs text-yellow-300 mt-1">
                                Quando atingir este limite, usar√° "Fallback Step" (se configurado)
                            </p>
                        </div>
                    `;
                } else if (condType === 'payment_status') {
                    const status = cond ? (cond.status || 'paid') : 'paid';
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Status do pagamento:</label>
                            <select name="condition-payment-status-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                                <option value="paid" ${status === 'paid' ? 'selected' : ''}>‚úÖ Confirmado (pago)</option>
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>‚è≥ Pendente</option>
                                <option value="failed" ${status === 'failed' ? 'selected' : ''}>‚ùå Falhou</option>
                                <option value="expired" ${status === 'expired' ? 'selected' : ''}>‚è∞ Expirado</option>
                            </select>
                        </div>
                    `;
                } else if (condType === 'time_elapsed') {
                    return `
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-300 mb-1">Minutos decorridos:</label>
                            <input type="number" 
                                   name="condition-minutes-${stepId}-${condIndex}" 
                                   value="${cond && cond.minutes ? cond.minutes : 5}"
                                   min="1" max="1440"
                                   class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                        </div>
                    `;
                }
                return '';
            }
            
            const currentCondType = condition ? condition.type : (availableConditionTypes[0] ? availableConditionTypes[0].value : 'text_validation');
            const configHtml = renderConditionConfig(currentCondType, condition);
            
            // ‚úÖ Modal de condi√ß√£o √© sobreposto ao modal de step (n√£o precisa prevenir scroll - j√° est√° hidden)
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60]';
            modal.id = `condition-modal-${stepId}-${condIndex}`;
            
            // ‚úÖ Click fora do modal para fechar (mas n√£o restaurar scroll - modal de step ainda est√° aberto)
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto border-2 border-blue-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-blue-300">
                            <i class="fas fa-code-branch mr-2"></i>${isNew ? 'Nova' : 'Editar'} Condi√ß√£o
                        </h3>
                        <button onclick="document.getElementById('condition-modal-${stepId}-${condIndex}').remove()" 
                                class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <form onsubmit="event.preventDefault(); saveCondition('${stepId}', ${condIndex});">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Tipo de Condi√ß√£o:</label>
                            <select id="condition-type-select-${stepId}-${condIndex}" 
                                    name="condition-type-${stepId}-${condIndex}"
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white"
                                    onchange="updateConditionConfig('${stepId}', ${condIndex}, null)">
                                ${conditionTypeOptions}
                            </select>
                        </div>
                        <div id="condition-config-${stepId}-${condIndex}">
                            ${configHtml}
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Ir para Step (quando condi√ß√£o matchar):</label>
                            <select name="condition-target-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                <option value="">Selecione um step...</option>${stepOptions.map(opt => {
                                    const match = opt.match(/value="([^"]+)"/);
                                    const value = match ? match[1] : '';
                                    const selected = (condition && condition.target_step === value) ? 'selected' : '';
                                    return opt.replace(/<option/, '<option ' + selected);
                                }).join('')}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-undo mr-2 text-purple-400"></i>Fallback Step (opcional)
                            </label>
                            <select name="condition-fallback-${stepId}-${condIndex}" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                <option value="">Nenhum (continuar para pr√≥xima condi√ß√£o)</option>${stepOptions.map(opt => {
                                    const match = opt.match(/value="([^"]+)"/);
                                    const value = match ? match[1] : '';
                                    const selected = (condition && condition.fallback_step === value) ? 'selected' : '';
                                    return opt.replace(/<option/, '<option ' + selected);
                                }).join('')}
                            </select>
                            <p class="text-xs text-purple-300 mt-1">
                                Step usado quando max_attempts atingir (apenas para condi√ß√µes de texto/bot√£o)
                            </p>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" 
                                    onclick="document.getElementById('condition-modal-${stepId}-${condIndex}').remove()" 
                                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg"
                                    style="z-index: 61;">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                <i class="fas fa-save mr-2"></i>Salvar Condi√ß√£o
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        },
        
        removeCondition(stepId, condIndex) {
            if (!confirm('‚ö†Ô∏è Remover esta condi√ß√£o?')) return;
            
            const step = this.config.flow_steps.find(s => s.id === stepId);
            if (!step) return;
            
            if (step.conditions && step.conditions.length > condIndex) {
                step.conditions.splice(condIndex, 1);
            }
            
            // Recarregar modal do step para atualizar lista
            const stepModal = document.getElementById(`flow-step-modal-${stepId}`);
            if (stepModal) {
                // Manter overflow hidden (modal ser√° recriado)
                stepModal.remove();
                setTimeout(() => this.editFlowStep(stepId), 100);
            }
        },
        
        saveCondition(stepId, condIndex) {
            const self = this;
            const step = self.config.flow_steps.find(s => s.id === stepId);
            if (!step) return;
            
            const modal = document.getElementById(`condition-modal-${stepId}-${condIndex}`);
            if (!modal) return;
            
            const isNew = condIndex < 0;
            const condType = modal.querySelector(`select[name="condition-type-${stepId}-${condIndex}"]`)?.value;
            const targetStep = modal.querySelector(`select[name="condition-target-${stepId}-${condIndex}"]`)?.value;
            
            if (!condType || !targetStep) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios');
                return;
            }
            
            const condition = {
                id: isNew ? `cond_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` : (step.conditions && step.conditions[condIndex] ? step.conditions[condIndex].id : `cond_${Date.now()}`),
                type: condType,
                target_step: targetStep,
                order: isNew ? ((step.conditions && step.conditions.length) || 0) + 1 : condIndex + 1
            };
            
            // ‚úÖ NOVO: Salvar fallback_step (opcional)
            const fallbackStep = modal.querySelector(`select[name="condition-fallback-${stepId}-${condIndex}"]`)?.value || '';
            if (fallbackStep) {
                condition.fallback_step = fallbackStep;
            }
            
            // Configura√ß√µes espec√≠ficas por tipo
            if (condType === 'text_validation') {
                condition.validation = modal.querySelector(`select[name="condition-validation-${stepId}-${condIndex}"]`)?.value || 'any';
                if (condition.validation === 'contains' || condition.validation === 'equals') {
                    condition.value = modal.querySelector(`input[name="condition-value-${stepId}-${condIndex}"]`)?.value || '';
                }
                const maxAttempts = modal.querySelector(`input[name="condition-max-attempts-${stepId}-${condIndex}"]`)?.value;
                condition.max_attempts = maxAttempts ? parseInt(maxAttempts) : null;
            } else if (condType === 'button_click') {
                condition.button_text = modal.querySelector(`input[name="condition-button-text-${stepId}-${condIndex}"]`)?.value || '';
                const maxAttempts = modal.querySelector(`input[name="condition-max-attempts-${stepId}-${condIndex}"]`)?.value;
                condition.max_attempts = maxAttempts ? parseInt(maxAttempts) : null;
            } else if (condType === 'payment_status') {
                condition.status = modal.querySelector(`select[name="condition-payment-status-${stepId}-${condIndex}"]`)?.value || 'paid';
            } else if (condType === 'time_elapsed') {
                condition.minutes = parseInt(modal.querySelector(`input[name="condition-minutes-${stepId}-${condIndex}"]`)?.value) || 5;
            }
            
            // Adicionar ou atualizar condi√ß√£o
            if (!step.conditions) step.conditions = [];
            
            if (isNew) {
                step.conditions.push(condition);
            } else {
                step.conditions[condIndex] = condition;
            }
            
            // Reordenar condi√ß√µes
            step.conditions.forEach((c, idx) => {
                c.order = idx + 1;
            });
            
            // Fechar modal de condi√ß√£o (modal de step ainda est√° aberto)
            modal.remove();
            
            // Recarregar modal do step para atualizar lista de condi√ß√µes
            const stepModal = document.getElementById(`flow-step-modal-${stepId}`);
            if (stepModal) {
                // Manter overflow hidden (modal ser√° recriado)
                stepModal.remove();
                setTimeout(() => self.editFlowStep(stepId), 100);
            } else {
                // Se modal de step n√£o existe mais, restaurar scroll
                document.body.style.overflow = '';
            }
        },
        
        updateConditionConfig(stepId, condIndex, validationType) {
            const modal = document.getElementById(`condition-modal-${stepId}-${condIndex}`);
            if (!modal) return;
            
            const typeSelect = modal.querySelector(`#condition-type-select-${stepId}-${condIndex}`);
            const condType = validationType || (typeSelect ? typeSelect.value : null);
            if (!condType) return;
            
            const configDiv = modal.querySelector(`#condition-config-${stepId}-${condIndex}`);
            if (!configDiv) return;
            
            // Buscar condi√ß√£o existente se estiver editando
            const self = this;
            const step = self.config.flow_steps.find(s => s.id === stepId);
            const condition = step && step.conditions && step.conditions[condIndex] ? step.conditions[condIndex] : null;
            
            // Renderizar campos espec√≠ficos
            let configHtml = '';
            if (condType === 'text_validation') {
                const validation = validationType || (condition ? condition.validation : 'any');
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Tipo de Valida√ß√£o:</label>
                        <select name="condition-validation-${stepId}-${condIndex}" 
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                                onchange="updateConditionConfig('${stepId}', ${condIndex}, this.value)">
                            <option value="email" ${validation === 'email' ? 'selected' : ''}>Email v√°lido</option>
                            <option value="phone" ${validation === 'phone' ? 'selected' : ''}>Telefone v√°lido</option>
                            <option value="cpf" ${validation === 'cpf' ? 'selected' : ''}>CPF v√°lido</option>
                            <option value="contains" ${validation === 'contains' ? 'selected' : ''}>Texto cont√©m</option>
                            <option value="equals" ${validation === 'equals' ? 'selected' : ''}>Texto igual a</option>
                            <option value="any" ${validation === 'any' ? 'selected' : ''}>Qualquer texto</option>
                        </select>
                    </div>
                    <div id="condition-value-field-${stepId}-${condIndex}" class="mb-3" style="display: ${(validation === 'contains' || validation === 'equals') ? 'block' : 'none'};">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Valor esperado:</label>
                        <input type="text" 
                               name="condition-value-${stepId}-${condIndex}" 
                               value="${condition && condition.value ? condition.value.replace(/"/g, '&quot;') : ''}"
                               placeholder="Ex: sim, n√£o, ok..."
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">M√°ximo de tentativas (opcional):</label>
                        <input type="number" 
                               name="condition-max-attempts-${stepId}-${condIndex}" 
                               value="${condition && condition.max_attempts ? condition.max_attempts : ''}"
                               min="1" max="10"
                               placeholder="Deixe vazio para ilimitado"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                `;
            } else if (condType === 'button_click') {
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Texto do bot√£o:</label>
                        <input type="text" 
                               name="condition-button-text-${stepId}-${condIndex}" 
                               value="${condition && condition.button_text ? condition.button_text.replace(/"/g, '&quot;') : ''}"
                               placeholder="Ex: Sim, quero!"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                `;
            } else if (condType === 'payment_status') {
                const status = condition ? (condition.status || 'paid') : 'paid';
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Status do pagamento:</label>
                        <select name="condition-payment-status-${stepId}-${condIndex}" 
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <option value="paid" ${status === 'paid' ? 'selected' : ''}>‚úÖ Confirmado (pago)</option>
                            <option value="pending" ${status === 'pending' ? 'selected' : ''}>‚è≥ Pendente</option>
                            <option value="failed" ${status === 'failed' ? 'selected' : ''}>‚ùå Falhou</option>
                            <option value="expired" ${status === 'expired' ? 'selected' : ''}>‚è∞ Expirado</option>
                        </select>
                    </div>
                `;
            } else if (condType === 'time_elapsed') {
                configHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Minutos decorridos:</label>
                        <input type="number" 
                               name="condition-minutes-${stepId}-${condIndex}" 
                               value="${condition && condition.minutes ? condition.minutes : 5}"
                               min="1" max="1440"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                    </div>
                `;
            }
            
            configDiv.innerHTML = configHtml;
        },
        
        removeFlowStep(stepId) {
            if (!confirm('‚ö†Ô∏è Remover este step? Isso pode quebrar conex√µes de outros steps.')) return;
            
            // ‚úÖ Se este step √© o inicial, limpar e auto-definir novo
            const wasStartStep = this.config.flow_start_step_id === stepId;
            
            this.config.flow_steps = this.config.flow_steps.filter(s => s.id !== stepId);
            
            // Limpar conex√µes que apontavam para este step
            this.config.flow_steps.forEach(step => {
                if (step.connections) {
                    if (step.connections.next === stepId) step.connections.next = '';
                    if (step.connections.pending === stepId) step.connections.pending = '';
                    if (step.connections.retry === stepId) step.connections.retry = '';
                }
            });
            
            // ‚úÖ Auto-definir novo step inicial se o removido era o inicial
            if (wasStartStep) {
                this.config.flow_start_step_id = null;
                if (this.config.flow_steps.length > 0) {
                    // Buscar step com order=1 primeiro
                    const sortedSteps = [...this.config.flow_steps].sort((a, b) => (a.order || 0) - (b.order || 0));
                    let newStartStep = null;
                    for (const step of sortedSteps) {
                        if (step.order === 1) {
                            newStartStep = step;
                            break;
                        }
                    }
                    // Se n√£o encontrou order=1, usar primeiro step
                    if (!newStartStep && sortedSteps.length > 0) {
                        newStartStep = sortedSteps[0];
                    }
                    if (newStartStep) {
                        this.config.flow_start_step_id = newStartStep.id;
                        this.showNotification(`‚úÖ Step removido! Novo step inicial definido automaticamente: ${this.getStepTitle(newStartStep.type)} (order=${newStartStep.order || 0})`, 'success');
                    } else {
                        this.showNotification('‚úÖ Step removido! ‚ö†Ô∏è Defina um step inicial.', 'success');
                    }
                } else {
                    this.config.flow_start_step_id = null;
                    this.showNotification('‚úÖ Step removido!', 'success');
                }
            } else {
                this.showNotification('‚úÖ Step removido!', 'success');
            }
            
            // ‚úÖ Recarregar editor visual (sempre visual agora)
            setTimeout(() => this.initVisualFlowEditor(), 100);
        },
        
        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 text-white font-bold ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    }));
    console.log('‚úÖ botConfigApp registrado com sucesso!');
    return true;
    }
    
    // ‚úÖ Tentar registrar imediatamente se Alpine j√° estiver dispon√≠vel
    if (typeof Alpine !== 'undefined' && Alpine.data) {
        registerBotConfigApp();
    }
    
    // ‚úÖ Registrar quando Alpine.js estiver pronto
    document.addEventListener('alpine:init', () => {
        if (!registerBotConfigApp()) {
            console.error('‚ùå Falha ao registrar botConfigApp via alpine:init');
        }
        
        // ‚úÖ Remarketing App (componente separado) - DENTRO de alpine:init
        Alpine.data('remarketingApp', () => ({
        campaigns: [],
        showCreateModal: false,
        showStatsModal: false,
        selectedCampaign: null,
        newCampaign: {
            name: '',
            message: '',
            media_url: '',
            media_type: 'video',
            audio_enabled: false,
            audio_url: '',
            target_audience: 'non_buyers',
            days_since_last_contact: 3,
            exclude_buyers: true,
            cooldown_hours: 6,  // ‚úÖ Fixo: 6 horas (n√£o aparece para usu√°rio)
            buttons: []  // ‚úÖ NOVO: Bot√µes de produto (igual ao Remarketing Geral)
        },
        
        async init() {
            await this.loadCampaigns();
        },
        
        async loadCampaigns() {
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/remarketing/campaigns');
                const data = await response.json();
                if (response.ok) {
                    this.campaigns = data;
                }
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
            }
        },
        
        async createCampaign() {
            if (!this.newCampaign.name || !this.newCampaign.message) {
                alert('Preencha nome e mensagem');
                return;
            }
            
            try {
                const response = await fetch('/api/bots/{{ bot.id }}/remarketing/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newCampaign)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.campaigns.unshift(data);
                    this.showCreateModal = false;
                    this.resetForm();
                    this.showNotification('‚úÖ Campanha criada!', 'success');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao criar campanha: ' + error.message);
            }
        },
        
        async sendCampaign(campaignId) {
            if (!confirm('Enviar esta campanha agora?')) return;
            
            try {
                const response = await fetch(`/api/bots/{{ bot.id }}/remarketing/campaigns/${campaignId}/send`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    await this.loadCampaigns();
                    this.showNotification('‚úÖ Campanha enviada!', 'success');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao enviar campanha: ' + error.message);
            }
        },
        
        resetForm() {
            this.newCampaign = {
                name: '',
                message: '',
                media_url: '',
                media_type: 'video',
                audio_enabled: false,
                audio_url: '',
                target_audience: 'non_buyers',
                days_since_last_contact: 3,
                exclude_buyers: true,
                cooldown_hours: 6,  // ‚úÖ Fixo: 6 horas
                buttons: []  // ‚úÖ NOVO: Bot√µes de produto
            };
        },
        
        getAudienceLabel(audience) {
            const labels = {
                'non_buyers': 'N√£o compraram',
                'abandoned_cart': 'Carrinho abandonado',
                'inactive': 'Inativos',
                'all': 'Todos'
            };
            return labels[audience] || audience;
        },
        
        getStatusLabel(status) {
            const labels = {
                'draft': 'Rascunho',
                'scheduled': 'Agendada',
                'sending': 'Enviando',
                'completed': 'Conclu√≠da',
                'paused': 'Pausada',
                'failed': 'Falhou'
            };
            return labels[status] || status;
        },
        
        // ‚úÖ C√°lculos de Analytics
        getTotalSent() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_sent || 0), 0);
        },
        
        getDeliveryRate() {
            const totalSent = this.getTotalSent();
            const totalFailed = this.campaigns.reduce((sum, c) => sum + (c.total_failed || 0), 0);
            if (totalSent === 0) return 0;
            return ((totalSent - totalFailed) / totalSent * 100).toFixed(1);
        },
        
        getClickRate() {
            const totalSent = this.getTotalSent();
            const totalClicks = this.getTotalClicks();
            if (totalSent === 0) return 0;
            return (totalClicks / totalSent * 100).toFixed(1);
        },
        
        getTotalClicks() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_clicks || 0), 0);
        },
        
        getTotalFailed() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_failed || 0), 0);
        },
        
        getTotalBlocked() {
            return this.campaigns.reduce((sum, c) => sum + (c.total_blocked || 0), 0);
        },
        
        getTotalRevenue() {
            return this.campaigns.reduce((sum, c) => sum + (c.revenue_generated || 0), 0);
        },
        
        // ‚úÖ Fun√ß√µes para Modal de Estat√≠sticas
        viewCampaignStats(campaign) {
            this.selectedCampaign = campaign;
            this.showStatsModal = true;
        },
        
        getCampaignDeliveryRate(campaign) {
            if (!campaign || !campaign.total_sent) return 0;
            const delivered = campaign.total_sent - (campaign.total_failed || 0);
            return (delivered / campaign.total_sent * 100).toFixed(1);
        },
        
        getCampaignClickRate(campaign) {
            if (!campaign || !campaign.total_sent) return 0;
            return ((campaign.total_clicks || 0) / campaign.total_sent * 100).toFixed(1);
        },
        
        getCampaignConversionRate(campaign) {
            if (!campaign || !campaign.total_sent) return 0;
            // Assumindo que convers√£o = cliques que geraram receita
            const conversions = campaign.total_clicks || 0;
            return (conversions / campaign.total_sent * 100).toFixed(1);
        },
        
        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 text-white font-bold ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    }));
    console.log('‚úÖ remarketingApp registrado com sucesso!');
}); // ‚úÖ Fecha document.addEventListener('alpine:init', ...)

// ‚úÖ FALLBACK: Se Alpine.js j√° estiver dispon√≠vel, tentar registrar imediatamente
// ‚úÖ Isso √© necess√°rio porque o alpine:init pode n√£o ser disparado se o Alpine j√° inicializou
if (typeof window !== 'undefined' && typeof window.Alpine !== 'undefined' && window.Alpine.data) {
    // Verificar se j√° foi registrado
    try {
        // Tentar acessar o componente para ver se existe
        const testComponent = window.Alpine.data('botConfigApp');
        if (!testComponent) {
            console.warn('‚ö†Ô∏è botConfigApp n√£o foi registrado via alpine:init! O Alpine pode ter inicializado antes do script executar.');
        } else {
            console.log('‚úÖ botConfigApp j√° est√° registrado!');
        }
    } catch (e) {
        console.warn('‚ö†Ô∏è Erro ao verificar botConfigApp:', e);
    }
}
})(); // ‚úÖ Fecha IIFE

// ‚úÖ Fun√ß√µes globais para condi√ß√µes (acessam contexto Alpine via DOM)
// Estas fun√ß√µes devem ficar FORA de alpine:init para serem acess√≠veis globalmente
window.addCondition = function(stepId) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.addCondition) {
        alpineData.addCondition(stepId);
    }
};

window.editCondition = function(stepId, condIndex) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.editCondition) {
        alpineData.editCondition(stepId, condIndex);
    }
};

window.removeCondition = function(stepId, condIndex) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.removeCondition) {
        alpineData.removeCondition(stepId, condIndex);
    }
};

window.saveCondition = function(stepId, condIndex) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.saveCondition) {
        alpineData.saveCondition(stepId, condIndex);
    }
};

window.updateConditionConfig = function(stepId, condIndex, validationType) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.updateConditionConfig) {
        alpineData.updateConditionConfig(stepId, condIndex, validationType);
    }
};

// ‚úÖ Fun√ß√µes globais para editor visual
window.editFlowStepFromVisual = function(stepId) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.editFlowStep) {
        alpineData.editFlowStep(stepId);
    }
};

window.removeFlowStepFromVisual = function(stepId) {
    const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
    if (alpineData && alpineData.removeFlowStep) {
        if (confirm('‚ö†Ô∏è Remover este step? Todas as conex√µes ser√£o perdidas.')) {
            alpineData.removeFlowStep(stepId);
            // ‚úÖ Recarregar editor visual ap√≥s remover (sempre visual agora)
            setTimeout(() => {
                alpineData.initVisualFlowEditor();
            }, 100);
        }
    }
};

// ‚úÖ Fun√ß√µes globais para bot√µes customizados
window.addCustomButton = function(stepId) {
    try {
        // ‚úÖ DEBUG: Log para verificar stepId
        console.log('üîç Tentando adicionar bot√£o customizado para stepId:', stepId);
        
        // Tentar encontrar o container
        let container = document.getElementById(`custom-buttons-list-${stepId}`);
        
        // ‚úÖ Se n√£o encontrar, tentar buscar por atributo data ou classe
        if (!container) {
            console.warn('‚ö†Ô∏è Container n√£o encontrado pelo ID, tentando buscar no modal...');
            // Buscar no modal atual
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            if (modal) {
                container = modal.querySelector(`[id*="custom-buttons-list"]`);
                if (container) {
                    console.log('‚úÖ Container encontrado no modal:', container.id);
                }
            }
        }
        
        if (!container) {
            // ‚úÖ Tentar aguardar um pouco e buscar novamente (pode ser problema de timing)
            console.warn('‚ö†Ô∏è Container n√£o encontrado imediatamente, aguardando 100ms...');
            setTimeout(() => {
                container = document.getElementById(`custom-buttons-list-${stepId}`);
                if (container) {
                    console.log('‚úÖ Container encontrado ap√≥s aguardar!');
                    // Chamar fun√ß√£o novamente
                    window.addCustomButton(stepId);
                    return;
                }
                
                // ‚úÖ DEBUG: Listar todos os elementos com "custom-buttons" no ID
                const allContainers = document.querySelectorAll('[id*="custom-buttons"]');
                console.error('‚ùå Container de bot√µes customizados n√£o encontrado:', `custom-buttons-list-${stepId}`);
                console.log('üîç Containers encontrados no DOM:', Array.from(allContainers).map(el => el.id));
                console.log('üîç StepId recebido:', stepId);
                console.log('üîç Tipo do stepId:', typeof stepId);
                
                // Verificar se o modal existe
                const modal = document.querySelector('.fixed.inset-0.bg-black');
                console.log('üîç Modal encontrado:', !!modal);
                if (modal) {
                    console.log('üîç HTML do modal (primeiros 500 chars):', modal.innerHTML.substring(0, 500));
                }
                
                alert(`‚ùå Erro: Container de bot√µes n√£o encontrado para stepId: ${stepId}\n\nVerifique o console para mais detalhes.`);
            }, 100);
            return;
        }
        
        // Buscar dados do Alpine para obter steps dispon√≠veis
        const alpineData = Alpine.$data(document.querySelector('[x-data*="botConfigApp"]'));
        if (!alpineData || !alpineData.config) {
            console.error('‚ùå Dados do Alpine n√£o encontrados');
            alert('‚ùå Erro: Dados n√£o carregados. Tente recarregar a p√°gina.');
            return;
        }
        
        // Buscar steps dispon√≠veis (exceto o step atual)
        const flowSteps = alpineData.config.flow_steps || [];
        const availableSteps = flowSteps.filter(s => s && s.id !== stepId);
        
        // Fun√ß√£o auxiliar para escapar HTML
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }
        
        // Fun√ß√£o auxiliar para obter t√≠tulo do step
        function getStepTitle(type) {
            const titles = {'content': 'Conte√∫do', 'payment': 'Pagamento', 'message': 'Mensagem', 'audio': '√Åudio', 'video': 'V√≠deo', 'buttons': 'Bot√µes', 'access': 'Acesso'};
            return titles[type] || 'Desconhecido';
        }
        
        // Contar bot√µes existentes para gerar √≠ndice √∫nico
        const existingButtons = container.querySelectorAll('[data-custom-button]');
        const newIndex = existingButtons.length;
        
        // Construir options do select
        const stepOptions = availableSteps.map(s => {
            const stepLabel = (s.name && s.name.trim()) ? s.name : getStepTitle(s.type);
            return `<option value="${s.id}">${s.order || 0} - ${escapeHtml(stepLabel)}</option>`;
        }).join('');
        
        // Criar HTML do novo bot√£o
        const buttonHtml = `
            <div data-custom-button class="p-3 bg-gray-900 rounded-lg border border-blue-600 mb-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-300 mb-1">Texto do Bot√£o</label>
                        <input type="text" 
                               name="custom-btn-text-${stepId}-${newIndex}" 
                               value=""
                               placeholder="Ex: Sim, quero!"
                               class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                               maxlength="64">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">üîó Ir para Step</label>
                        <select name="custom-btn-target-${stepId}-${newIndex}" 
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm">
                            <option value="">Nenhum</option>${stepOptions}
                        </select>
                    </div>
                </div>
                <button type="button" 
                        onclick="window.removeCustomButton('${stepId}', ${newIndex})"
                        class="w-full px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium transition">
                    <i class="fas fa-times mr-1"></i>Remover
                </button>
            </div>
        `;
        
        // Remover mensagem "Nenhum bot√£o adicionado" se existir
        const emptyMessage = container.querySelector('.text-center');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        // Adicionar novo bot√£o ao container
        container.insertAdjacentHTML('beforeend', buttonHtml);
        
        // Scroll suave para o novo bot√£o
        const newButton = container.lastElementChild;
        if (newButton) {
            newButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            // Focar no input de texto do novo bot√£o
            const textInput = newButton.querySelector('input[type="text"]');
            if (textInput) {
                setTimeout(() => textInput.focus(), 100);
            }
        }
    } catch (error) {
        console.error('‚ùå Erro ao adicionar bot√£o customizado:', error);
        alert('‚ùå Erro ao adicionar bot√£o. Verifique o console para mais detalhes.');
    }
};

window.removeCustomButton = function(stepId, index) {
    const container = document.getElementById(`custom-buttons-list-${stepId}`);
    if (!container) {
        console.error('‚ùå Container de bot√µes customizados n√£o encontrado:', `custom-buttons-list-${stepId}`);
        return;
    }
    
    // ‚úÖ CORRE√á√ÉO: Buscar o bot√£o pelo √≠ndice ou pelo elemento clicado
    const buttons = Array.from(container.querySelectorAll('[data-custom-button]'));
    let buttonToRemove = null;
    
    // Se index for fornecido, usar √≠ndice
    if (typeof index === 'number' && index >= 0 && index < buttons.length) {
        buttonToRemove = buttons[index];
    } else {
        // Tentar encontrar pelo evento (se chamado via onclick)
        const event = window.event || arguments[2];
        if (event && event.target) {
            buttonToRemove = event.target.closest('[data-custom-button]');
        }
    }
    
    if (!buttonToRemove) {
        console.error('‚ùå Bot√£o customizado n√£o encontrado para remover');
        return;
    }
    
    // Remover o bot√£o
    buttonToRemove.remove();
    
    // Se n√£o houver mais bot√µes, mostrar mensagem
    const remainingButtons = container.querySelectorAll('[data-custom-button]');
    if (remainingButtons.length === 0) {
        container.innerHTML = '<div class="text-xs text-blue-300 italic text-center py-2">Nenhum bot√£o adicionado. Clique em "Adicionar Bot√£o" para criar um.</div>';
    } else {
        // Reindexar os bot√µes restantes para manter √≠ndices sequenciais
        remainingButtons.forEach((btn, newIdx) => {
            // Atualizar names dos inputs e selects
            const textInput = btn.querySelector(`input[name^="custom-btn-text-${stepId}-"]`);
            const targetSelect = btn.querySelector(`select[name^="custom-btn-target-${stepId}-"]`);
            const removeButton = btn.querySelector('button[onclick*="removeCustomButton"]');
            
            if (textInput) {
                textInput.name = `custom-btn-text-${stepId}-${newIdx}`;
            }
            
            if (targetSelect) {
                targetSelect.name = `custom-btn-target-${stepId}-${newIdx}`;
            }
            
            if (removeButton) {
                removeButton.setAttribute('onclick', `window.removeCustomButton('${stepId}', ${newIdx})`);
            }
        });
    }
};
</script>
{% endblock %}