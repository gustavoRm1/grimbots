{% extends "base.html" %}
{% block title %}Configurações - grimbots{% endblock %}

{% block extra_head %}
<style>
/* Dashboard V2.0 - Design System (IDÊNTICO) */

/* Stats Cards Premium */
.stat-card {
    position: relative;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .stat-card {
        border-radius: 14px;
        padding: 20px;
    }
}

@media (min-width: 768px) {
    .stat-card {
        border-radius: 16px;
        padding: 24px;
    }
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand-gold-500), var(--brand-gold-700));
}

.stat-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 184, 0, 0.2);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 184, 0, 0.1);
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 900;
    line-height: 1;
    margin: 12px 0 6px 0;
    font-variant-numeric: tabular-nums;
}

@media (min-width: 640px) {
    .stat-value {
        font-size: 2rem;
        margin: 14px 0 7px 0;
    }
}

@media (min-width: 768px) {
    .stat-value {
        font-size: 2.5rem;
        margin: 16px 0 8px 0;
    }
}

.stat-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #9CA3AF;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Gateway Card (Estilo Bot Card) */
.gateway-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    padding: 16px;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

@media (min-width: 640px) {
    .gateway-card {
        border-radius: 12px;
        padding: 18px;
    }
}

@media (min-width: 768px) {
    .gateway-card {
        padding: 20px;
    }
}

.gateway-card:hover {
    border-color: rgba(255, 184, 0, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.gateway-status-active {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    color: #6EE7B7;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.gateway-status-verified {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    color: #60A5FA;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.gateway-status-unconfigured {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: rgba(107, 114, 128, 0.1);
    border: 1px solid rgba(107, 114, 128, 0.2);
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    color: #9CA3AF;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Action Buttons (IDÊNTICO Dashboard) */
.btn-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

@media (min-width: 640px) {
    .btn-action {
        padding: 9px 18px;
        font-size: 12.5px;
    }
}

@media (min-width: 768px) {
    .btn-action {
        padding: 10px 20px;
        font-size: 13px;
    }
}

.btn-action-primary {
    background: linear-gradient(135deg, #FFB800, #DAA520);
    color: #000000;
    box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
}

.btn-action-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 184, 0, 0.4);
}

.btn-action-success {
    background: #10B981;
    color: #FFFFFF;
}

.btn-action-success:hover {
    background: #059669;
    transform: translateY(-2px);
}

/* Chart Container (Para info boxes) */
.chart-container {
    position: relative;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
}

@media (min-width: 640px) {
    .chart-container {
        border-radius: 14px;
        padding: 20px;
    }
}

@media (min-width: 768px) {
    .chart-container {
        border-radius: 16px;
        padding: 24px;
    }
}

/* Form Inputs (Estilo Dashboard) */
.form-input {
    width: 100%;
    padding: 12px 16px;
    background: #1A1A1A;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #FFFFFF;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: #FFB800;
    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
}

/* Info Box */
.info-box {
    padding: 16px;
    background: rgba(59, 130, 246, 0.05);
    border-left: 4px solid #3B82F6;
    border-radius: 0 8px 8px 0;
    margin-bottom: 16px;
}

.info-box-warning {
    background: rgba(255, 184, 0, 0.05);
    border-left-color: #FFB800;
}

.info-box-success {
    background: rgba(16, 185, 129, 0.05);
    border-left-color: #10B981;
}

/* Tab Buttons - Responsivo */
.tab-button {
    padding: 12px 16px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #9CA3AF;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    top: 2px;
}

@media (min-width: 640px) {
    .tab-button {
        padding: 14px 20px;
        font-size: 0.8125rem;
    }
}

@media (min-width: 768px) {
    .tab-button {
        padding: 16px 24px;
        font-size: 0.875rem;
    }
}

.tab-button:hover {
    color: #D1D1D1;
}

.tab-button.active {
    color: #FFB800;
    border-bottom-color: #FFB800;
}

/* Scrollbar Hide for Mobile Tabs */
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.scrollbar-hide::-webkit-scrollbar {
    display: none;
}

/* ✅ Garantir responsividade completa para mobile */
@media (max-width: 640px) {
    .max-w-full {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    /* Prevenir overflow horizontal */
    * {
        box-sizing: border-box;
    }
    
    body {
        overflow-x: hidden;
    }
    
    /* Garantir que grids sejam sempre 1 coluna em mobile quando necessário */
    .grid.grid-cols-1.md\:grid-cols-2,
    .grid.grid-cols-2.md\:grid-cols-2,
    .grid.grid-cols-3 {
        grid-template-columns: 1fr !important;
    }
}

@media (min-width: 1024px) {
    .max-w-full {
        max-width: 100%;
        padding-left: 2rem;
        padding-right: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8" x-data="settingsApp()" x-init="init()">
    
    <!-- Header - Responsivo -->
    <div class="mb-4 sm:mb-6 md:mb-8">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-black text-white mb-2 truncate">
            Configurações ⚙️
        </h1>
        <p class="text-sm sm:text-base md:text-lg text-gray-400 truncate">
            Gerencie seu perfil e gateways de pagamento
        </p>
    </div>

    <!-- Tabs - Responsivo -->
    <div class="flex gap-0 border-b-2 border-gray-800 mb-4 sm:mb-6 md:mb-8 overflow-x-auto scrollbar-hide">
        <button @click="activeTab = 'profile'" 
                :class="{'active': activeTab === 'profile'}"
                class="tab-button whitespace-nowrap flex-shrink-0 text-xs sm:text-sm px-3 sm:px-4 md:px-6 py-3 sm:py-4">
            <i class="fas fa-user mr-1 sm:mr-2"></i><span class="hidden sm:inline">Perfil</span><span class="sm:hidden">Perfil</span>
        </button>
        <button @click="activeTab = 'gateways'" 
                :class="{'active': activeTab === 'gateways'}"
                class="tab-button whitespace-nowrap flex-shrink-0 text-xs sm:text-sm px-3 sm:px-4 md:px-6 py-3 sm:py-4">
            <i class="fas fa-credit-card mr-1 sm:mr-2"></i><span class="hidden sm:inline">Gateways</span><span class="sm:hidden">Gateways</span>
        </button>
        <button @click="activeTab = 'plan'" 
                :class="{'active': activeTab === 'plan'}"
                class="tab-button whitespace-nowrap flex-shrink-0 text-xs sm:text-sm px-3 sm:px-4 md:px-6 py-3 sm:py-4">
            <i class="fas fa-crown mr-1 sm:mr-2"></i><span class="hidden sm:inline">Plano</span><span class="sm:hidden">Plano</span>
        </button>
        <button @click="activeTab = 'notifications'" 
                :class="{'active': activeTab === 'notifications'}"
                class="tab-button whitespace-nowrap flex-shrink-0 text-xs sm:text-sm px-3 sm:px-4 md:px-6 py-3 sm:py-4">
            <i class="fas fa-bell mr-1 sm:mr-2"></i><span class="hidden sm:inline">Notificações</span><span class="sm:hidden">Notif.</span>
        </button>
    </div>

    <!-- Profile Tab - Responsivo -->
    <div x-show="activeTab === 'profile'" x-cloak>
        <div class="chart-container mb-4 sm:mb-6 md:mb-8">
            <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6">Informações do Perfil</h3>

            <form @submit.prevent="updateProfile()" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        <i class="fas fa-user mr-2 text-yellow-500"></i>
                        Nome Completo
                    </label>
                    <input type="text" 
                           x-model="profile.full_name" 
                           class="form-input"
                           placeholder="João Silva">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        <i class="fas fa-envelope mr-2 text-yellow-500"></i>
                        Email
                    </label>
                    <input type="email" 
                           x-model="profile.email" 
                           class="form-input"
                           placeholder="seu@email.com">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        <i class="fas fa-at mr-2 text-yellow-500"></i>
                        Username
                    </label>
                    <input type="text" 
                           x-model="profile.username" 
                           disabled
                           class="form-input opacity-50 cursor-not-allowed">
                    <p class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-lock mr-1"></i>
                        Username não pode ser alterado por segurança
                    </p>
                </div>

                <div class="pt-4">
                    <button type="submit" 
                            :disabled="loading"
                            :class="{'opacity-50 cursor-not-allowed': loading}"
                            class="btn-action btn-action-primary">
                        <i class="fas fa-save mr-2"></i>
                        <span x-text="loading ? 'Salvando...' : 'Salvar Alterações'"></span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Alterar Senha - Responsivo -->
        <div class="chart-container">
            <h3 class="text-xl sm:text-2xl font-bold text-white mb-4 sm:mb-6">Alterar Senha</h3>
            <form @submit.prevent="updatePassword()" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        <i class="fas fa-lock mr-2 text-yellow-500"></i>
                        Senha Atual
                    </label>
                    <input type="password" 
                           x-model="password.current" 
                           class="form-input"
                           placeholder="Digite sua senha atual">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-300 mb-2">
                        <i class="fas fa-key mr-2 text-yellow-500"></i>
                        Nova Senha
                    </label>
                    <input type="password" 
                           x-model="password.new" 
                           minlength="6"
                           class="form-input"
                           placeholder="Digite sua nova senha (mín. 6 caracteres)">
                </div>

                <div class="pt-4">
                    <button type="submit" 
                            :disabled="loading"
                            :class="{'opacity-50 cursor-not-allowed': loading}"
                            class="btn-action btn-action-primary">
                        <i class="fas fa-lock mr-2"></i>
                        Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gateways Tab - REDESENHADO (Estilo Dashboard) -->
    <div x-show="activeTab === 'gateways'" x-cloak>
        <!-- Stats Cards (Gateway Ativo) - Responsivo -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6 md:mb-8">
            <div class="stat-card">
                <div class="stat-label">Gateway Ativo</div>
                <template x-if="gatewaysList.find(g => g.is_active && g.is_verified)">
                    <div>
                        <div class="stat-value" style="color: #10B981;">
                            <span x-text="gatewaysList.find(g => g.is_active && g.is_verified)?.gateway_type.toUpperCase()"></span>
                        </div>
                        <div class="text-sm text-gray-500">Processando pagamentos agora</div>
                    </div>
                </template>
                <template x-if="!gatewaysList.find(g => g.is_active && g.is_verified)">
                    <div>
                        <div class="stat-value" style="color: #EF4444;">
                            Nenhum
                        </div>
                        <div class="text-sm text-gray-500">Configure um gateway abaixo</div>
                    </div>
                </template>
            </div>

            <div class="stat-card">
                <div class="stat-label">Gateways Configurados</div>
                <div class="stat-value" style="color: #FFB800;">
                    <span x-text="gatewaysList.filter(g => g.is_verified && g.gateway_type !== 'hoopay').length"></span><span class="text-2xl text-gray-600">/5</span>
                </div>
                <div class="text-sm text-gray-500">Gateways verificados</div>
            </div>
        </div>

        <!-- Info Boxes -->
        <div class="info-box-warning info-box">
            <p class="text-sm text-gray-300">
                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                <strong class="text-yellow-400">Importante:</strong> Configure pelo menos 1 gateway para que seus bots possam gerar PIX e processar vendas.
            </p>
        </div>

        <div class="info-box mb-8">
            <p class="text-sm text-gray-300">
                <i class="fas fa-shield-alt mr-2 text-blue-500"></i>
                <strong class="text-blue-400">Segurança:</strong> Suas credenciais são criptografadas e armazenadas com segurança. Nunca compartilhamos seus dados.
            </p>
        </div>

        <!-- Gateways Configurados (Ativar/Desativar) - Responsivo -->
        <div class="chart-container mb-4 sm:mb-6 md:mb-8" x-show="gatewaysList.filter(g => g.is_verified).length > 0">
            <div class="mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-white truncate">Gateways Configurados</h2>
                <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">Ative ou desative seus gateways com um clique</p>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <template x-for="gateway in gatewaysList.filter(g => g.is_verified && g.gateway_type !== 'hoopay')" :key="gateway.id">
                    <div class="gateway-card" :class="gateway.is_active ? 'border-green-500' : ''" x-data="{ editMode: false }">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                            <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                     style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(255, 184, 0, 0.05));">
                                    <template x-if="gateway.gateway_type === 'pushynpay'">
                                        <img src="{{ url_for('static', filename='img/pushyn.png') }}" alt="PushynPay" class="w-12 h-12 object-contain">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'paradise'">
                                        <img src="{{ url_for('static', filename='img/paradise.jpg') }}" alt="Paradise" class="w-12 h-12 object-cover rounded-lg">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'wiinpay'">
                                        <img src="{{ url_for('static', filename='img/wiinpay.ico') }}" alt="WiinPay" class="w-12 h-12 object-contain">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'atomopay'">
                                        <img src="{{ url_for('static', filename='img/atomopay.png') }}?v=2" 
                                             alt="Átomo Pay" 
                                             class="w-12 h-12 object-contain"
                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%23FFB800\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'12\' font-weight=\'bold\'%3EAP%3C/text%3E%3C/svg%3E';">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'syncpay'">
                                        <img src="{{ url_for('static', filename='img/syncpay.png') }}?v=1" 
                                             alt="SyncPay" 
                                             class="w-12 h-12 object-contain"
                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%233B82F6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'12\' font-weight=\'bold\'%3ESP%3C/text%3E%3C/svg%3E';">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'umbrellapag'">
                                        <img src="{{ url_for('static', filename='img/umbrellapag.png') }}" 
                                             alt="UmbrellaPag" 
                                             class="w-12 h-12 object-contain"
                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%236366F1\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\' font-weight=\'bold\'%3EUP%3C/text%3E%3C/svg%3E';">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'orionpay'">
                                        <img src="{{ url_for('static', filename='img/orionpay.svg') }}" 
                                             alt="OrionPay" 
                                             class="w-12 h-12 object-contain"
                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%238B5CF6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\' font-weight=\'bold\'%3EOP%3C/text%3E%3C/svg%3E';">
                                    </template>
                                    <template x-if="gateway.gateway_type === 'babylon'">
                                        <img src="{{ url_for('static', filename='img/babylon.png') }}" 
                                             alt="Babylon" 
                                             class="w-12 h-12 object-contain"
                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%23006699\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\' font-weight=\'bold\'%3EBY%3C/text%3E%3C/svg%3E';">
                                    </template>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-xs sm:text-sm font-bold text-white truncate" x-text="gateway.gateway_type.toUpperCase()"></h3>
                                    <p class="text-xs text-gray-500 truncate">Verificado e pronto</p>
                                </div>
                            </div>
                            <span :class="gateway.is_active ? 'gateway-status-active' : 'gateway-status-verified'" class="flex-shrink-0 text-xs">
                                <span class="w-2 h-2 rounded-full" 
                                      :class="gateway.is_active ? 'bg-green-400 animate-pulse' : 'bg-blue-400'"></span>
                                <span x-text="gateway.is_active ? 'Ativo' : 'Inativo'"></span>
                            </span>
                        </div>

                        <!-- Toggle Switch - Responsivo -->
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 p-3 sm:p-4 bg-black bg-opacity-20 rounded-lg mb-3">
                            <div>
                                <p class="text-sm font-bold text-white">Ativar Gateway</p>
                                <p class="text-xs text-gray-500">Processar pagamentos</p>
                            </div>
                            <button @click="toggleGateway(gateway.id, gateway.gateway_type)"
                                    :disabled="loading"
                                    class="relative inline-flex h-8 w-14 items-center rounded-full transition-colors"
                                    :class="gateway.is_active ? 'bg-green-500' : 'bg-gray-600'">
                                <span class="inline-block h-6 w-6 transform rounded-full bg-white transition-transform"
                                      :class="gateway.is_active ? 'translate-x-7' : 'translate-x-1'"></span>
                            </button>
                        </div>

                        <!-- Botões Editar e Apagar Credenciais - Responsivo -->
                        <div class="flex flex-col sm:flex-row gap-2 mb-3">
                            <button @click="editMode = !editMode; if (editMode) { editGateway = { ...gateway }; } else { editGateway = {}; }" 
                                    class="flex-1 py-2 px-3 sm:px-4 rounded-lg text-xs sm:text-sm font-bold transition-all"
                                    style="background: rgba(255, 184, 0, 0.1); color: #FFB800; border: 1px solid rgba(255, 184, 0, 0.3);">
                                <i class="fas mr-1 sm:mr-2" :class="editMode ? 'fa-times' : 'fa-edit'"></i>
                                <span x-text="editMode ? 'Cancelar' : 'Editar Credenciais'"></span>
                            </button>
                            <button @click="clearGatewayCredentials(gateway.id, gateway.gateway_type)" 
                                    :disabled="loading || editMode"
                                    class="flex-1 py-2 px-3 sm:px-4 rounded-lg text-xs sm:text-sm font-bold transition-all"
                                    :style="editMode ? 'background: rgba(107, 114, 128, 0.1); color: #6B7280; border: 1px solid rgba(107, 114, 128, 0.3); cursor: not-allowed;' : 'background: rgba(239, 68, 68, 0.1); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3);'">
                                <i class="fas mr-1 sm:mr-2 fa-trash"></i>
                                <span class="hidden sm:inline">Apagar Credenciais</span>
                                <span class="sm:hidden">Apagar</span>
                            </button>
                        </div>

                        <!-- Formulário de Edição (Expandível) -->
                        <div x-show="editMode" x-cloak class="space-y-3 p-4 bg-gray-900 rounded-lg border border-yellow-500 border-opacity-30">
                            <!-- PushynPay -->
                            <template x-if="gateway.gateway_type === 'pushynpay'">
                                <form @submit.prevent="updateGateway(gateway.id, 'pushynpay')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_key" 
                                                   class="form-input pr-10"
                                                   placeholder="●●●●●●●●">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- Paradise -->
                            <template x-if="gateway.gateway_type === 'paradise'">
                                <form @submit.prevent="updateGateway(gateway.id, 'paradise')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_key" 
                                                   class="form-input pr-10"
                                                   placeholder="sk_...">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-400 block mb-1">Offer Hash</label>
                                        <input type="text" 
                                               x-model="editGateway.offer_hash" 
                                               class="form-input"
                                               placeholder="hash-da-oferta">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-400 block mb-1">Product Hash</label>
                                        <input type="text" 
                                               x-model="editGateway.product_hash" 
                                               class="form-input"
                                               placeholder="prod_...">
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- WiinPay -->
                            <template x-if="gateway.gateway_type === 'wiinpay'">
                                <form @submit.prevent="updateGateway(gateway.id, 'wiinpay')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_key" 
                                                   class="form-input pr-10"
                                                   placeholder="●●●●●●●●">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- ✅ Split User ID removido: configuração interna da plataforma, não deve ser exibido ao usuário -->
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- Átomo Pay -->
                            <template x-if="gateway.gateway_type === 'atomopay'">
                                <form @submit.prevent="updateGateway(gateway.id, 'atomopay')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Token</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_token" 
                                                   class="form-input pr-10"
                                                   placeholder="●●●●●●●●">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-400 block mb-1">Product Hash <span class="text-red-400">*</span></label>
                                        <input type="text" 
                                               x-model="editGateway.product_hash" 
                                               class="form-input"
                                               placeholder="hash-do-produto"
                                               required>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Ofertas serão criadas dinamicamente para cada valor de transação
                                        </p>
                                    </div>
                                    <div class="info-box-warning info-box p-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Ofertas são criadas automaticamente para evitar conflitos de valor (order bumps, downsells, etc.)
                                        </p>
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- SyncPay -->
                            <template x-if="gateway.gateway_type === 'syncpay'">
                                <form @submit.prevent="updateGateway(gateway.id, 'syncpay')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">Client ID</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.client_id" 
                                                   class="form-input pr-10"
                                                   placeholder="UUID do Client ID">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">Client Secret</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.client_secret" 
                                                   class="form-input pr-10"
                                                   placeholder="UUID do Client Secret">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-box-warning info-box p-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Autenticação via Bearer Token (expira em 1h)
                                        </p>
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- UmbrellaPag -->
                            <template x-if="gateway.gateway_type === 'umbrellapag'">
                                <form @submit.prevent="updateGateway(gateway.id, 'umbrellapag')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_key" 
                                                   class="form-input pr-10"
                                                   placeholder="●●●●●●●●">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-gray-400 block mb-1">Product Hash <span class="text-gray-500 text-xs">(opcional)</span></label>
                                        <input type="text" 
                                               x-model="editGateway.product_hash" 
                                               class="form-input"
                                               placeholder="uniqueProductLinkId">
                                        <p class="text-xs text-gray-500 mt-1">
                                            Será criado dinamicamente se não informado
                                        </p>
                                    </div>
                                    <div class="info-box-warning info-box p-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Produtos são criados automaticamente para cada transação, permitindo valores diferentes
                                        </p>
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- OrionPay -->
                            <template x-if="gateway.gateway_type === 'orionpay'">
                                <form @submit.prevent="updateGateway(gateway.id, 'orionpay')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_key" 
                                                   class="form-input pr-10"
                                                   placeholder="opay_...">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>

                            <!-- Babylon -->
                            <template x-if="gateway.gateway_type === 'babylon'">
                                <form @submit.prevent="updateGateway(gateway.id, 'babylon')" class="space-y-3">
                                    <div x-data="{ show: false }">
                                        <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                                        <div class="relative">
                                            <input :type="show ? 'text' : 'password'" 
                                                   x-model="editGateway.api_key" 
                                                   class="form-input pr-10"
                                                   placeholder="Bearer token...">
                                            <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                                <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="info-box-warning info-box p-2">
                                        <p class="text-xs text-gray-300">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Autenticação via Bearer Token. Split configurado internamente pela plataforma.
                                        </p>
                                    </div>
                                    <button type="submit" :disabled="loading" class="btn-action btn-action-primary w-full">
                                        <i class="fas fa-save mr-2"></i>
                                        <span x-text="loading ? 'Salvando...' : 'Atualizar'"></span>
                                    </button>
                                </form>
                            </template>
                        </div>

                        <!-- Stats do Gateway - Responsivo -->
                        <div class="grid grid-cols-2 gap-2 sm:gap-3 mt-3 pt-3 border-t border-gray-800">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1 truncate">Transações</div>
                                <div class="text-xs sm:text-sm font-bold text-white truncate" x-text="gateway.total_transactions || 0"></div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1 truncate">Taxa Sucesso</div>
                                <div class="text-xs sm:text-sm font-bold text-green-400 truncate" x-text="gateway.success_rate ? gateway.success_rate.toFixed(1) + '%' : '0%'"></div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Adicionar Novo Gateway - Responsivo -->
        <div class="chart-container">
            <div class="mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-white truncate">Adicionar Novo Gateway</h2>
                <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">Configure suas credenciais pela primeira vez</p>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <!-- PushynPay -->
                <div class="gateway-card" x-show="!getGatewayStatus('pushynpay')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(255, 184, 0, 0.05));">
                                <img src="{{ url_for('static', filename='img/pushyn.png') }}" 
                                     alt="PushynPay" 
                                     class="w-12 h-12 object-contain">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">PushynPay</h3>
                                <p class="text-xs text-gray-500 truncate">Gateway Rápido</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('pushynpay')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.pushynpay.api_key" 
                                       class="form-input pr-10"
                                       placeholder="●●●●●●●●">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>
                </div>

                <!-- Paradise -->
                <div class="gateway-card" x-show="!getGatewayStatus('paradise')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(255, 184, 0, 0.05));">
                                <img src="{{ url_for('static', filename='img/paradise.jpg') }}" 
                                     alt="Paradise" 
                                     class="w-12 h-12 object-cover rounded-lg">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">Paradise</h3>
                                <p class="text-xs text-gray-500 truncate">Gateway Global</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('paradise')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.paradise.api_key" 
                                       class="form-input pr-10"
                                       placeholder="sk_...">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">Offer Hash</label>
                            <input type="text" 
                                   x-model="gateways.paradise.offer_hash" 
                                   class="form-input"
                                   placeholder="hash-da-oferta">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">Product Hash</label>
                            <input type="text" 
                                   x-model="gateways.paradise.product_hash" 
                                   class="form-input"
                                   placeholder="prod_...">
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>

            <div class="mt-6 space-y-4">
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(255, 184, 0, 0.12);">
                            <i class="fas fa-exclamation-triangle text-yellow-300"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-white">Webhook obrigatório • PARADISE</h4>
                            <p class="text-xs text-gray-400 mt-1">
                                Mantemos o pixel e o status de vendas sincronizados via webhook. Configure uma vez para evitar perda de tracking.
                            </p>
                        </div>
                    </div>

                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                        URL do webhook
                    </label>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                        <input type="text"
                               id="webhook-url-input-paradise"
                               readonly
                               value="https://app.grimbots.online/webhook/payment/paradise"
                               class="flex-1 form-input bg-black bg-opacity-40 font-mono text-sm text-yellow-400 cursor-text border border-gray-700"
                               @click="$event.target.select(); document.execCommand('copy'); copyWebhookUrlSpecific('paradise')">
                        <button type="button"
                                @click="copyWebhookUrlSpecific('paradise')"
                                class="btn-action btn-action-primary sm:w-auto w-full">
                            <i class="fas fa-copy mr-2"></i>
                            Copiar
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            Eventos para habilitar
                        </p>
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(16, 185, 129, 0.15); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3);">
                                approved
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(251, 191, 36, 0.15); color: #FBBF24; border: 1px solid rgba(251, 191, 36, 0.3);">
                                pending
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3);">
                                refunded
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(239, 68, 68, 0.15); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3);">
                                cancelled
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            Marque todos os eventos acima no painel do gateway.
                        </p>
                    </div>
                </div>

                <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-yellow-300"></i>
                        Passos rápidos
                    </p>
                    <ol class="ml-5 list-decimal space-y-2 text-xs text-gray-300">
                        <li>Copie a URL acima.</li>
                        <li>Acesse o painel do gateway <span class="text-yellow-300">PARADISE</span>.</li>
                        <li>Em “Webhook/Postback”, cole a URL e habilite os eventos listados.</li>
                        <li>Salve. Vendas e pixel passam a sincronizar em tempo real.</li>
                    </ol>
                </div>
            </div>
                </div>

                <!-- WiinPay -->
                <div class="gateway-card" x-show="!getGatewayStatus('wiinpay')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(255, 184, 0, 0.05));">
                                <img src="{{ url_for('static', filename='img/wiinpay.ico') }}" 
                                     alt="WiinPay" 
                                     class="w-12 h-12 object-contain">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">WiinPay</h3>
                                <p class="text-xs text-gray-500 truncate">Simples</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('wiinpay')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.wiinpay.api_key" 
                                       class="form-input pr-10"
                                       placeholder="●●●●●●●●">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box-warning info-box p-2">
                            <p class="text-xs text-gray-300">
                                <i class="fas fa-info-circle mr-1"></i>
                                Mínimo R$ 3,00
                            </p>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>
                </div>

                <!-- Átomo Pay -->
                <div class="gateway-card" x-show="!getGatewayStatus('atomopay')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(255, 184, 0, 0.05));">
                                <img src="{{ url_for('static', filename='img/atomopay.png') }}?v=2" 
                                     alt="Átomo Pay" 
                                     class="w-12 h-12 object-contain"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%23FFB800\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'12\' font-weight=\'bold\'%3EAP%3C/text%3E%3C/svg%3E';">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">Átomo Pay</h3>
                                <p class="text-xs text-gray-500 truncate">Verificado e pronto</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('atomopay')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Token</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.atomopay.api_token" 
                                       class="form-input pr-10"
                                       placeholder="●●●●●●●●">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">Product Hash <span class="text-red-400">*</span></label>
                            <input type="text" 
                                   x-model="gateways.atomopay.product_hash" 
                                   class="form-input"
                                   placeholder="hash-do-produto"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">
                                Ofertas serão criadas dinamicamente para cada valor de transação
                            </p>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>

            <div class="mt-6 space-y-4">
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(255, 184, 0, 0.12);">
                            <i class="fas fa-exclamation-triangle text-yellow-300"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-white">Webhook obrigatório • ÁTOMO PAY</h4>
                            <p class="text-xs text-gray-400 mt-1">
                                O webhook garante que o funil, o pixel e os relatórios reflitam cada pagamento em tempo real.
                            </p>
                        </div>
                    </div>

                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                        URL do webhook
                    </label>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                        <input type="text"
                               id="webhook-url-input-atomopay"
                               readonly
                               value="https://app.grimbots.online/webhook/payment/atomopay"
                               class="flex-1 form-input bg-black bg-opacity-40 font-mono text-sm text-yellow-400 cursor-text border border-gray-700"
                               @click="$event.target.select(); document.execCommand('copy'); copyWebhookUrlSpecific('atomopay')">
                        <button type="button"
                                @click="copyWebhookUrlSpecific('atomopay')"
                                class="btn-action btn-action-primary sm:w-auto w-full">
                            <i class="fas fa-copy mr-2"></i>
                            Copiar
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            Eventos para habilitar
                        </p>
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(16, 185, 129, 0.15); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3);">
                                approved
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(251, 191, 36, 0.15); color: #FBBF24; border: 1px solid rgba(251, 191, 36, 0.3);">
                                pending
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3);">
                                refunded
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(239, 68, 68, 0.15); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3);">
                                cancelled
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            Marque todos os eventos acima no painel do gateway.
                        </p>
                    </div>
                </div>

                <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-yellow-300"></i>
                        Passos rápidos
                    </p>
                    <ol class="ml-5 list-decimal space-y-2 text-xs text-gray-300">
                        <li>Copie a URL acima.</li>
                        <li>Acesse o painel do gateway <span class="text-yellow-300">ÁTOMO PAY</span>.</li>
                        <li>Em “Webhook/Postback”, cole a URL e habilite os eventos listados.</li>
                        <li>Salve. O funil passa a reagir em tempo real a cada venda.</li>
                    </ol>
                </div>
            </div>
                </div>

                <!-- SyncPay -->
                <div class="gateway-card" x-show="!getGatewayStatus('syncpay')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));">
                                <img src="{{ url_for('static', filename='img/syncpay.png') }}?v=1" 
                                     alt="SyncPay" 
                                     class="w-12 h-12 object-contain"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%233B82F6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'12\' font-weight=\'bold\'%3ESP%3C/text%3E%3C/svg%3E';">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">SyncPay</h3>
                                <p class="text-xs text-gray-500 truncate">Gateway Rápido</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('syncpay')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">Client ID</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.syncpay.client_id" 
                                       class="form-input pr-10"
                                       placeholder="UUID do Client ID">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">Client Secret</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.syncpay.client_secret" 
                                       class="form-input pr-10"
                                       placeholder="UUID do Client Secret">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>
                </div>

                <!-- Babylon -->
                <div class="gateway-card" x-show="!getGatewayStatus('babylon')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(0, 102, 153, 0.1), rgba(0, 102, 153, 0.05));">
                                <img src="{{ url_for('static', filename='img/babylon.png') }}" 
                                     alt="Babylon" 
                                     class="w-12 h-12 object-contain"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%23006699\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\' font-weight=\'bold\'%3EBY%3C/text%3E%3C/svg%3E';">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">Babylon</h3>
                                <p class="text-xs text-gray-500 truncate">Gateway Rápido</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('babylon')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Key</label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.babylon.api_key" 
                                       class="form-input pr-10"
                                       placeholder="Bearer token...">
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div class="info-box-warning info-box p-2">
                            <p class="text-xs text-gray-300">
                                <i class="fas fa-info-circle mr-1"></i>
                                Autenticação via Bearer Token. Split configurado internamente pela plataforma.
                            </p>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>
                </div>

                <!-- UmbrellaPag -->
                <div class="gateway-card" x-show="!getGatewayStatus('umbrellapag')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));">
                                <img src="{{ url_for('static', filename='img/umbrellapag.png') }}" 
                                     alt="UmbrellaPag" 
                                     class="w-12 h-12 object-contain"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%236366F1\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\' font-weight=\'bold\'%3EUP%3C/text%3E%3C/svg%3E';">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">UmbrellaPag</h3>
                                <p class="text-xs text-gray-500 truncate">Gateway Completo</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('umbrellapag')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Key <span class="text-red-400">*</span></label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.umbrellapag.api_key" 
                                       class="form-input pr-10"
                                       placeholder="●●●●●●●●"
                                       required>
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 block mb-1">Product Hash <span class="text-gray-500 text-xs">(opcional)</span></label>
                            <input type="text" 
                                   x-model="gateways.umbrellapag.product_hash" 
                                   class="form-input"
                                   placeholder="uniqueProductLinkId">
                            <p class="text-xs text-gray-500 mt-1">
                                Será criado dinamicamente se não informado
                            </p>
                        </div>
                        <div class="info-box-warning info-box p-2">
                            <p class="text-xs text-gray-300">
                                <i class="fas fa-info-circle mr-1"></i>
                                Produtos são criados automaticamente para cada transação, permitindo valores diferentes
                            </p>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>

            <div class="mt-6 space-y-4">
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(99, 102, 241, 0.12);">
                            <i class="fas fa-exclamation-triangle text-indigo-300"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-white">Webhook obrigatório • UMBRELLAPAG</h4>
                            <p class="text-xs text-gray-400 mt-1">
                                O webhook garante que o funil, o pixel e os relatórios reflitam cada pagamento em tempo real.
                            </p>
                        </div>
                    </div>

                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                        URL do webhook
                    </label>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                        <input type="text"
                               id="webhook-url-input-umbrellapag"
                               readonly
                               value="https://app.grimbots.online/webhook/payment/umbrellapag"
                               class="flex-1 form-input bg-black bg-opacity-40 font-mono text-sm text-indigo-400 cursor-text border border-gray-700"
                               @click="$event.target.select(); document.execCommand('copy'); copyWebhookUrlSpecific('umbrellapag')">
                        <button type="button"
                                @click="copyWebhookUrlSpecific('umbrellapag')"
                                class="btn-action btn-action-primary sm:w-auto w-full">
                            <i class="fas fa-copy mr-2"></i>
                            Copiar
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            Eventos para habilitar
                        </p>
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(16, 185, 129, 0.15); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3);">
                                PAID
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(251, 191, 36, 0.15); color: #FBBF24; border: 1px solid rgba(251, 191, 36, 0.3);">
                                PENDING
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(239, 68, 68, 0.15); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3);">
                                FAILED
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3);">
                                CANCELLED
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            Marque todos os eventos acima no painel do gateway.
                        </p>
                    </div>
                </div>

                <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-indigo-300"></i>
                        Passos rápidos
                    </p>
                    <ol class="ml-5 list-decimal space-y-2 text-xs text-gray-300">
                        <li>Copie a URL acima.</li>
                        <li>Acesse o painel do gateway <span class="text-indigo-300">UMBRELLAPAG</span>.</li>
                        <li>Em "Webhook", cole a URL e habilite os eventos listados.</li>
                        <li>Salve. O funil passa a reagir em tempo real a cada venda.</li>
                    </ol>
                </div>
            </div>
                </div>

                <!-- OrionPay -->
                <div class="gateway-card" x-show="!getGatewayStatus('orionpay')?.is_verified">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0" 
                                 style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));">
                                <img src="{{ url_for('static', filename='img/orionpay.svg') }}" 
                                     alt="OrionPay" 
                                     class="w-12 h-12 object-contain"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect width=\'48\' height=\'48\' fill=\'%238B5CF6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\' font-weight=\'bold\'%3EOP%3C/text%3E%3C/svg%3E';">
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs sm:text-sm font-bold text-white truncate">OrionPay</h3>
                                <p class="text-xs text-gray-500 truncate">Gateway Moderno</p>
                            </div>
                        </div>
                        <span class="gateway-status-unconfigured flex-shrink-0 text-xs">
                            <i class="fas fa-exclamation-circle"></i>
                            Novo
                        </span>
                    </div>

                    <form @submit.prevent="saveGateway('orionpay')" class="space-y-3">
                        <div x-data="{ show: false }">
                            <label class="text-xs font-bold text-gray-400 block mb-1">API Key <span class="text-red-400">*</span></label>
                            <div class="relative">
                                <input :type="show ? 'text' : 'password'" 
                                       x-model="gateways.orionpay.api_key" 
                                       class="form-input pr-10"
                                       placeholder="opay_..."
                                       required>
                                <button type="button" @click="show = !show" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                    <i class="fas" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" 
                                :disabled="loading"
                                class="btn-action btn-action-primary w-full">
                            <i class="fas fa-save mr-2"></i>
                            <span x-text="loading ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </form>

            <div class="mt-6 space-y-4">
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-start gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(139, 92, 246, 0.12);">
                            <i class="fas fa-exclamation-triangle text-purple-300"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-white">Webhook obrigatório • ORIONPAY</h4>
                            <p class="text-xs text-gray-400 mt-1">
                                O webhook garante que o funil, o pixel e os relatórios reflitam cada pagamento em tempo real.
                            </p>
                        </div>
                    </div>

                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                        URL do webhook
                    </label>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                        <input type="text"
                               id="webhook-url-input-orionpay"
                               readonly
                               value="https://app.grimbots.online/webhook/payment/orionpay"
                               class="flex-1 form-input bg-black bg-opacity-40 font-mono text-sm text-purple-400 cursor-text border border-gray-700"
                               @click="$event.target.select(); document.execCommand('copy'); copyWebhookUrlSpecific('orionpay')">
                        <button type="button"
                                @click="copyWebhookUrlSpecific('orionpay')"
                                class="btn-action btn-action-primary sm:w-auto w-full">
                            <i class="fas fa-copy mr-2"></i>
                            Copiar
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            Eventos para habilitar
                        </p>
                        <div class="flex flex-wrap gap-2 text-xs font-semibold">
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(16, 185, 129, 0.15); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3);">
                                payment.success
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(251, 191, 36, 0.15); color: #FBBF24; border: 1px solid rgba(251, 191, 36, 0.3);">
                                purchase.created
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-md" style="background: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.3);">
                                access.granted
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">
                            Marque todos os eventos acima no painel do gateway.
                        </p>
                    </div>
                </div>

                <div class="rounded-lg border border-gray-800 p-4 bg-gray-900 bg-opacity-60">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-purple-300"></i>
                        Passos rápidos
                    </p>
                    <ol class="ml-5 list-decimal space-y-2 text-xs text-gray-300">
                        <li>Copie a URL acima.</li>
                        <li>Acesse o painel do gateway <span class="text-purple-300">ORIONPAY</span>.</li>
                        <li>Em "Webhook", cole a URL e habilite os eventos listados.</li>
                        <li>Salve. O funil passa a reagir em tempo real a cada venda.</li>
                    </ol>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Tab - Responsivo -->
    <div x-show="activeTab === 'plan'" x-cloak>
        <div class="chart-container">
            <h2 class="text-xl sm:text-2xl font-bold text-white mb-3 sm:mb-4 truncate">💰 Modelo de Pricing</h2>
            <p class="text-sm sm:text-base text-gray-400 mb-4 sm:mb-6 truncate">Pague apenas quando vender - simples e transparente</p>

            <div class="stat-card mb-4 sm:mb-6 md:mb-8">
                <div class="stat-label">Taxa Atual</div>
                <div class="stat-value" style="color: #10B981;">2%</div>
                <div class="text-sm text-gray-500">de cada venda confirmada</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="gateway-card text-center">
                    <i class="fas fa-infinity text-4xl text-yellow-500 mb-3"></i>
                    <h5 class="font-bold text-white mb-2">Bots Ilimitados</h5>
                    <p class="text-sm text-gray-400">Sem mensalidade</p>
                </div>
                
                <div class="gateway-card text-center">
                    <i class="fas fa-rocket text-4xl text-yellow-500 mb-3"></i>
                    <h5 class="font-bold text-white mb-2">Sem Setup</h5>
                    <p class="text-sm text-gray-400">Comece agora</p>
                </div>
                
                <div class="gateway-card text-center">
                    <i class="fas fa-shield-alt text-4xl text-yellow-500 mb-3"></i>
                    <h5 class="font-bold text-white mb-2">100% Seguro</h5>
                    <p class="text-sm text-gray-400">Split automático</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Tab - Responsivo -->
    <div x-show="activeTab === 'notifications'" x-cloak>
        <div class="chart-container">
            <div class="flex items-center justify-between mb-4 sm:mb-6">
                <div class="min-w-0 flex-1">
                    <h3 class="text-xl sm:text-2xl font-bold text-white truncate">🔔 Notificações</h3>
                    <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">Configure quais notificações você quer receber</p>
                </div>
            </div>
            
            <!-- Status da Subscription - Responsivo -->
            <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-lg" :style="pushSubscriptionStatus.registered ? 'background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);' : 'background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);'">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                        <i class="fas text-lg sm:text-xl flex-shrink-0" :class="pushSubscriptionStatus.registered ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-red-500'"></i>
                        <div class="min-w-0 flex-1">
                            <div class="text-xs sm:text-sm font-bold text-white truncate">
                                <span x-show="pushSubscriptionStatus.registered">✅ Dispositivo Registrado</span>
                                <span x-show="!pushSubscriptionStatus.registered">⚠️ Dispositivo NÃO Registrado</span>
                            </div>
                            <div class="text-xs truncate" :class="pushSubscriptionStatus.registered ? 'text-green-400' : 'text-red-400'">
                                <span x-show="pushSubscriptionStatus.registered">Você receberá notificações push neste dispositivo</span>
                                <span x-show="!pushSubscriptionStatus.registered">Clique no botão abaixo para registrar seu dispositivo e receber notificações</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botão para Registrar Dispositivo - Responsivo -->
            <div class="mb-4 sm:mb-6" x-show="!pushSubscriptionStatus.registered">
                <button @click="registerPushNotifications()" 
                        :disabled="pushSubscriptionStatus.registering"
                        class="w-full py-2.5 sm:py-3 px-4 sm:px-6 rounded-lg text-xs sm:text-sm font-bold text-white transition-all flex items-center justify-center gap-2"
                        :class="pushSubscriptionStatus.registering ? 'bg-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700'">
                    <i class="fas" :class="pushSubscriptionStatus.registering ? 'fa-spinner fa-spin' : 'fa-bell'"></i>
                    <span class="hidden sm:inline" x-text="pushSubscriptionStatus.registering ? 'Registrando...' : '📱 Registrar Dispositivo para Notificações'"></span>
                    <span class="sm:hidden" x-text="pushSubscriptionStatus.registering ? 'Registrando...' : '📱 Registrar'"></span>
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Você precisará permitir notificações quando o navegador solicitar
                </p>
            </div>
            
            <div class="space-y-3">
                <label class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(16, 185, 129, 0.1);">
                            <i class="fas fa-check-circle text-green-500 text-sm sm:text-base"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="text-xs sm:text-sm font-semibold text-white truncate">Vendas Aprovadas</div>
                            <div class="text-xs text-gray-400 truncate">Receber notificação quando pagamento for confirmado</div>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                        <input type="checkbox" 
                               x-model="notificationSettings.notify_approved_sales"
                               @change="saveNotificationSettings(); if(notificationSettings.notify_approved_sales && !pushSubscriptionStatus.registered) registerPushNotifications(true);"
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </label>
                
                <label class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(255, 184, 0, 0.1);">
                            <i class="fas fa-clock text-yellow-500 text-sm sm:text-base"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="text-xs sm:text-sm font-semibold text-white truncate">Vendas Pendentes</div>
                            <div class="text-xs text-gray-400 truncate">Receber notificação quando pagamento estiver pendente</div>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                        <input type="checkbox" 
                               x-model="notificationSettings.notify_pending_sales"
                               @change="saveNotificationSettings(); if(notificationSettings.notify_pending_sales && !pushSubscriptionStatus.registered) registerPushNotifications(true);"
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-600"></div>
                    </label>
                </label>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
function settingsApp() {
    return {
        activeTab: 'profile',
        loading: false,
        profile: {
            full_name: '{{ current_user.full_name or "" }}',
            email: '{{ current_user.email }}',
            username: '{{ current_user.username }}'
        },
        password: {
            current: '',
            new: ''
        },
        gateways: {
            syncpay: { client_id: '', client_secret: '' },
            pushynpay: { api_key: '' },
            paradise: { api_key: '', offer_hash: '', product_hash: '' },
            wiinpay: { api_key: '' }, // ✅ split_user_id removido: configuração interna da plataforma
            atomopay: { api_token: '', product_hash: '' },
            umbrellapag: { api_key: '', product_hash: '' },
            babylon: { api_key: '' }
        },
        editGateway: {},
        gatewaysList: [],
        notificationSettings: {
            notify_approved_sales: true,
            notify_pending_sales: false
        },
        pushSubscriptionStatus: {
            registered: false,
            registering: false
        },
        serviceWorkerRegistration: null,

        async init() {
            await this.loadGateways();
            await this.loadNotificationSettings();
            await this.checkPushSubscriptionStatus();
            await this.initPWA();
        },

        // ✅ QI 500: Copiar URL do webhook específico
        copyWebhookUrlSpecific(gatewayType) {
            const inputId = `webhook-url-input-${gatewayType}`;
            const input = document.getElementById(inputId);
            if (input) {
                input.select();
                input.setSelectionRange(0, 99999);
                document.execCommand('copy');
                this.showNotification(`✅ URL do ${gatewayType.toUpperCase()} copiada!`);
            }
        },

        async loadGateways() {
            try {
                const response = await fetch('/api/gateways');
                const data = await response.json();
                if (response.ok) {
                    this.gatewaysList = data;
                }
            } catch (error) {
                console.error('Erro ao carregar gateways:', error);
            }
        },

        getGatewayStatus(type) {
            return this.gatewaysList.find(g => g.gateway_type === type);
        },

        async updateProfile() {
            this.loading = true;
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: this.profile.full_name,
                        email: this.profile.email
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    this.showNotification('Perfil atualizado!');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        async updatePassword() {
            if (!this.password.current || !this.password.new) {
                alert('Preencha todos os campos');
                return;
            }
            this.loading = true;
            try {
                const response = await fetch('/api/user/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: this.password.current,
                        new_password: this.password.new
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    this.showNotification('Senha alterada!');
                    this.password.current = '';
                    this.password.new = '';
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        async toggleGateway(gatewayId, gatewayType) {
            this.loading = true;
            try {
                const response = await fetch(`/api/gateways/${gatewayId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (response.ok) {
                    await this.loadGateways();
                    this.showNotification(data.is_active ? `${gatewayType.toUpperCase()} ativado!` : `${gatewayType.toUpperCase()} desativado`);
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        async saveGateway(type) {
            this.loading = true;
            try {
                const payload = { gateway_type: type, ...this.gateways[type] };
                // ✅ Remover split_user_id do payload para WiinPay (configuração interna, não editável pelo usuário)
                if (type === 'wiinpay' && payload.split_user_id) {
                    delete payload.split_user_id;
                }
                const response = await fetch('/api/gateways', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (response.ok) {
                    this.showNotification(`Gateway ${type} configurado!`);
                    await this.loadGateways();
                    // Limpar formulário (resetar para valores padrão)
                    if (type === 'syncpay') {
                        this.gateways[type] = { client_id: '', client_secret: '' };
                    } else if (type === 'paradise') {
                        this.gateways[type] = { api_key: '', offer_hash: '', product_hash: '' };
                    } else if (type === 'wiinpay') {
                        this.gateways[type] = { api_key: '' }; // ✅ split_user_id removido: configuração interna da plataforma
                    } else if (type === 'atomopay') {
                        this.gateways[type] = { api_token: '', product_hash: '' };
                    } else if (type === 'umbrellapag') {
                        this.gateways[type] = { api_key: '', product_hash: '' };
                    } else if (type === 'babylon') {
                        this.gateways[type] = { api_key: '' };
                    } else {
                        this.gateways[type] = { api_key: '' };
                    }
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        async updateGateway(gatewayId, type) {
            this.loading = true;
            try {
                const payload = { gateway_type: type, ...this.editGateway };
                // ✅ Remover split_user_id do payload para WiinPay (configuração interna, não editável pelo usuário)
                if (type === 'wiinpay' && payload.split_user_id) {
                    delete payload.split_user_id;
                }
                const response = await fetch(`/api/gateways/${gatewayId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (response.ok) {
                    this.showNotification(`Credenciais do ${type.toUpperCase()} atualizadas!`);
                    await this.loadGateways();
                    this.editGateway = {};
                    this.editMode = false;
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        async clearGatewayCredentials(gatewayId, gatewayType) {
            if (!confirm(`⚠️ Tem certeza que deseja apagar as credenciais do gateway ${gatewayType.toUpperCase()}?\n\nO gateway voltará para o estado "Adicionar Novo Gateway" e você precisará configurar novamente.`)) {
                return;
            }
            
            this.loading = true;
            try {
                const response = await fetch(`/api/gateways/${gatewayId}/clear-credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (response.ok) {
                    this.showNotification(`✅ Credenciais do ${gatewayType.toUpperCase()} apagadas!`);
                    await this.loadGateways();
                    this.editGateway = {};
                    this.editMode = false;
                } else {
                    alert('Erro: ' + (data.error || 'Erro ao apagar credenciais'));
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 text-white font-bold bg-green-500';
            notification.textContent = '✅ ' + message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        },

        // Carregar configurações de notificações
        async loadNotificationSettings() {
            try {
                const response = await fetch('/api/notification-settings');
                if (response.ok) {
                    const data = await response.json();
                    this.notificationSettings = {
                        notify_approved_sales: data.notify_approved_sales ?? true,
                        notify_pending_sales: data.notify_pending_sales ?? false
                    };
                    console.log('✅ Configurações de notificações carregadas:', this.notificationSettings);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar configurações:', error);
            }
        },
        
        // Salvar configurações de notificações
        async saveNotificationSettings() {
            try {
                const response = await fetch('/api/notification-settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(this.notificationSettings)
                });
                
                if (response.ok) {
                    this.showNotification('Configurações de notificações salvas!');
                    console.log('✅ Configurações de notificações salvas!');
                } else {
                    console.error('❌ Erro ao salvar configurações:', await response.text());
                }
            } catch (error) {
                console.error('❌ Erro ao salvar configurações:', error);
            }
        },
        
        // Verificar status da subscription
        async checkPushSubscriptionStatus() {
            try {
                const response = await fetch('/api/push/subscription-status');
                if (response.ok) {
                    const data = await response.json();
                    this.pushSubscriptionStatus.registered = data.has_active_subscription;
                    console.log('📱 Status da subscription:', data.has_active_subscription ? 'Registrada' : 'Não registrada');
                }
            } catch (error) {
                console.error('❌ Erro ao verificar status:', error);
            }
        },
        
        // Inicializar PWA e Service Worker
        async initPWA() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/static/sw.js');
                    console.log('✅ Service Worker registrado:', registration.scope);
                    this.serviceWorkerRegistration = registration;
                } catch (error) {
                    console.error('❌ Erro ao registrar Service Worker:', error);
                }
            }
        },
        
        // Registrar push notifications
        async registerPushNotifications(silent = false) {
            if (this.pushSubscriptionStatus.registering) return;
            
            this.pushSubscriptionStatus.registering = true;
            
            try {
                // Verificar Service Worker
                if (!('serviceWorker' in navigator)) {
                    alert('⚠️ Seu navegador não suporta notificações push');
                    this.pushSubscriptionStatus.registering = false;
                    return;
                }
                
                // Pegar registration do Service Worker
                let registration = this.serviceWorkerRegistration;
                if (!registration) {
                    registration = await navigator.serviceWorker.ready;
                }
                
                // Solicitar permissão
                if (Notification.permission === 'denied') {
                    alert('❌ Permissão de notificações foi negada. Vá em Configurações do navegador para permitir.');
                    this.pushSubscriptionStatus.registering = false;
                    return;
                }
                
                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        alert('❌ Permissão negada. Não é possível enviar notificações.');
                        this.pushSubscriptionStatus.registering = false;
                        return;
                    }
                }
                
                // Buscar chave VAPID
                const vapidPublicKey = await this.getVAPIDPublicKey();
                if (!vapidPublicKey) {
                    alert('❌ Chave VAPID não disponível no servidor');
                    this.pushSubscriptionStatus.registering = false;
                    return;
                }
                
                // Criar subscription
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: this.urlBase64ToUint8Array(vapidPublicKey)
                });
                
                // Enviar para servidor
                await this.sendSubscriptionToServer(subscription);
                
                // Atualizar status
                this.pushSubscriptionStatus.registered = true;
                
                if (!silent) {
                    this.showNotification('✅ Dispositivo registrado com sucesso! Você receberá notificações.');
                }
                
            } catch (error) {
                console.error('❌ Erro ao registrar notificações:', error);
                if (!silent) {
                    alert('❌ Erro ao registrar: ' + error.message);
                }
            } finally {
                this.pushSubscriptionStatus.registering = false;
            }
        },
        
        // Buscar chave VAPID pública
        async getVAPIDPublicKey() {
            try {
                const response = await fetch('/api/push/vapid-public-key');
                if (response.ok) {
                    const data = await response.json();
                    // ✅ Suporte para ambos os formatos (legacy e novo)
                    const key = data.public_key || data.publicKey;
                    if (!key) {
                        console.error('❌ Chave VAPID não encontrada na resposta:', data);
                        return null;
                    }
                    console.log('✅ Chave VAPID obtida, tamanho:', key.length, 'chars');
                    return key;
                } else {
                    const errorText = await response.text();
                    console.error('❌ Erro ao buscar chave VAPID:', response.status, errorText);
                }
            } catch (error) {
                console.error('❌ Erro ao buscar chave VAPID:', error);
            }
            return null;
        },
        
        // Converter chave VAPID de base64url para Uint8Array
        urlBase64ToUint8Array(base64String) {
            try {
                if (!base64String || typeof base64String !== 'string') {
                    throw new Error('Chave VAPID inválida: não é uma string');
                }
                
                // Remover espaços e quebras de linha
                base64String = base64String.trim();
                
                // Adicionar padding se necessário (base64url não usa padding, mas alguns casos precisam)
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                
                // Converter base64url para base64 padrão
                const base64 = (base64String + padding)
                    .replace(/\-/g, '+')  // base64url usa - ao invés de +
                    .replace(/_/g, '/');  // base64url usa _ ao invés de /
                
                // Decodificar base64
                const rawData = window.atob(base64);
                
                // Criar Uint8Array
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                
                console.log('✅ Chave VAPID convertida:', {
                    tamanhoOriginal: base64String.length,
                    tamanhoDecodificado: outputArray.length,
                    esperado: 65  // Chave pública ECC P-256 uncompressed: 1 byte prefixo (0x04) + 32 bytes X + 32 bytes Y
                });
                
                // ✅ Validar tamanho esperado: EXATAMENTE 65 bytes
                // Formato: 0x04 (1 byte) + coordenada X (32 bytes) + coordenada Y (32 bytes)
                if (outputArray.length !== 65) {
                    const errorMsg = `Chave VAPID inválida: tamanho ${outputArray.length} bytes (esperado: 65 bytes). Primeiro byte deve ser 0x04.`;
                    console.error('❌', errorMsg);
                    throw new Error(errorMsg);
                }
                
                // ✅ Validar prefixo (deve ser 0x04)
                if (outputArray[0] !== 0x04) {
                    const errorMsg = `Chave VAPID inválida: primeiro byte é 0x${outputArray[0].toString(16)} (esperado: 0x04)`;
                    console.error('❌', errorMsg);
                    throw new Error(errorMsg);
                }
                
                console.log('✅ Chave VAPID válida:', {
                    tamanho: outputArray.length,
                    prefixo: '0x' + outputArray[0].toString(16).padStart(2, '0'),
                    prontosParaUsar: true
                });
                
                return outputArray;
            } catch (error) {
                console.error('❌ Erro ao converter chave VAPID:', error);
                throw new Error('Erro ao converter chave VAPID: ' + error.message);
            }
        },
        
        // Enviar subscription para servidor
        async sendSubscriptionToServer(subscription) {
            try {
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        subscription: {
                            endpoint: subscription.endpoint,
                            keys: {
                                p256dh: this.arrayBufferToBase64(subscription.getKey('p256dh')),
                                auth: this.arrayBufferToBase64(subscription.getKey('auth'))
                            }
                        },
                        user_agent: navigator.userAgent,
                        device_info: this.getDeviceInfo()
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Subscription registrada no servidor:', data);
                    return true;
                } else {
                    console.error('❌ Erro ao registrar subscription:', await response.text());
                    return false;
                }
            } catch (error) {
                console.error('❌ Erro ao enviar subscription:', error);
                return false;
            }
        },
        
        // Converter ArrayBuffer para Base64
        arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        },
        
        // Detectar tipo de dispositivo
        getDeviceInfo() {
            const ua = navigator.userAgent;
            if (/mobile|android|iphone|ipad|ipod/i.test(ua)) {
                return 'mobile';
            }
            return 'desktop';
        }
    }
}

// ✅ QI 500: Funções para copiar URL do webhook (Alpine.js)
function copyWebhookUrlSpecific(gatewayType, inputElement = null) {
    const inputId = `webhook-url-input-${gatewayType}`;
    const input = inputElement || document.getElementById(inputId);
    if (input) {
        input.select();
        input.setSelectionRange(0, 99999); // Para mobile
        document.execCommand('copy');
        showCopiedTooltip(input);
        showNotification(`✅ URL do ${gatewayType.toUpperCase()} copiada!`);
    }
}

function showCopiedTooltip(element) {
    // Remover tooltip anterior se existir
    const existingTooltip = element.parentElement.querySelector('.webhook-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    const tooltip = document.createElement('div');
    tooltip.className = 'webhook-tooltip absolute -top-8 left-0 bg-black text-white text-xs px-2 py-1 rounded z-50';
    tooltip.textContent = 'Copiado!';
    element.parentElement.style.position = 'relative';
    element.parentElement.appendChild(tooltip);
    setTimeout(() => tooltip.remove(), 2000);
}

function showNotification(message) {
    // Remover notificação anterior se existir
    const existing = document.querySelector('.webhook-notification');
    if (existing) {
        existing.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'webhook-notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-2xl z-50 text-white font-bold bg-green-500';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

</script>
{% endblock %}
