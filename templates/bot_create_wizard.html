{% extends "base.html" %}

{% block title %}Criar Novo Bot - grimbots{% endblock %}

{% block extra_head %}
<script>
    window.stripSurrogateChars = function (value) {
        if (!value) {
            return '';
        }
        try {
            return value.replace(/[\uD800-\uDFFF]/g, '');
        } catch (err) {
            return '';
        }
    };
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8" 
     x-data="{
         currentStep: 1,
         totalSteps: 4,
         formData: {
             token: '',
             name: '',
             gateway_type: 'pushynpay',
             welcome_message: '',
             welcome_media_url: '',
             welcome_media_type: 'video',
             welcome_audio_enabled: false,
             welcome_audio_url: ''
         },
         loading: false,
         
         nextStep() {
             if (this.validateCurrentStep()) {
                 if (this.currentStep < this.totalSteps) {
                     this.currentStep++;
                 }
             }
         },
         
         previousStep() {
             if (this.currentStep > 1) {
                 this.currentStep--;
             }
         },
         
         validateCurrentStep() {
             if (this.currentStep === 1) {
                 if (!this.formData.token || this.formData.token.length < 10) {
                     showFriendlyError('Token do bot √© obrigat√≥rio');
                     return false;
                 }
             }
             return true;
         },
         
         async submitBot() {
             this.loading = true;
             try {
                 const response = await fetch('/api/bots', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify(this.formData)
                 });
                 
                 const data = await response.json();
                 
                 if (response.ok) {
                     showSuccess('Bot criado com sucesso! Redirecionando...');
                     setTimeout(() => {
                         window.location.href = '/dashboard';
                    }, 1500);
                 } else {
                     showFriendlyError(data.error);
                     this.loading = false;
                 }
             } catch (error) {
                 showFriendlyError(error.message);
                 this.loading = false;
             }
         }
     }">
    
    <!-- Header -->
    <div class="mb-8">
        <a href="{{ url_for('dashboard') }}" class="inline-flex items-center text-txt-primary hover:text-txt-primary mb-4">
            <i class="fas fa-arrow-left mr-2"></i>
            Voltar para Dashboard
        </a>
        <h1 class="text-4xl font-bold text-txt-primary">Criar Novo Bot ü§ñ</h1>
        <p class="mt-2 text-lg text-txt-primary">Vamos criar seu bot em 4 passos simples</p>
    </div>

    <!-- Indicador de Progresso -->
    <div class="mb-12">
        <div class="flex items-center justify-between">
            <!-- Step 1 -->
            <div class="flex-1 flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full font-bold text-lg transition-all"
                     :class="currentStep >= 1 ? 'bg-trust-500 text-white' : 'bg-dark-surface text-txt-primary'">
                    <span x-show="currentStep > 1"><i class="fas fa-check"></i></span>
                    <span x-show="currentStep <= 1">1</span>
                </div>
                <div class="ml-3 text-left">
                    <p class="text-sm font-bold" :class="currentStep === 1 ? 'text-trust-500' : 'text-txt-primary'">
                        Token do Bot
                    </p>
                    <p class="text-xs text-txt-primary">Dados b√°sicos</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 transition-all"
                 :class="currentStep > 1 ? 'bg-trust-500' : 'bg-dark-surface'"></div>
            
            <!-- Step 2 -->
            <div class="flex-1 flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full font-bold text-lg transition-all"
                     :class="currentStep >= 2 ? 'bg-trust-500 text-white' : 'bg-dark-surface text-txt-primary'">
                    <span x-show="currentStep > 2"><i class="fas fa-check"></i></span>
                    <span x-show="currentStep <= 2">2</span>
                </div>
                <div class="ml-3 text-left">
                    <p class="text-sm font-bold" :class="currentStep === 2 ? 'text-trust-500' : 'text-txt-primary'">
                        Pagamento
                    </p>
                    <p class="text-xs text-txt-primary">Escolha o gateway</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 transition-all"
                 :class="currentStep > 2 ? 'bg-trust-500' : 'bg-dark-surface'"></div>
            
            <!-- Step 3 -->
            <div class="flex-1 flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full font-bold text-lg transition-all"
                     :class="currentStep >= 3 ? 'bg-trust-500 text-white' : 'bg-dark-surface text-txt-primary'">
                    <span x-show="currentStep > 3"><i class="fas fa-check"></i></span>
                    <span x-show="currentStep <= 3">3</span>
                </div>
                <div class="ml-3 text-left">
                    <p class="text-sm font-bold" :class="currentStep === 3 ? 'text-trust-500' : 'text-txt-primary'">
                        Mensagens
                    </p>
                    <p class="text-xs text-txt-primary">Personaliza√ß√£o</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 transition-all"
                 :class="currentStep > 3 ? 'bg-trust-500' : 'bg-dark-surface'"></div>
            
            <!-- Step 4 -->
            <div class="flex-1 flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full font-bold text-lg transition-all"
                     :class="currentStep >= 4 ? 'bg-trust-500 text-white' : 'bg-dark-surface text-txt-primary'">
                    4
                </div>
                <div class="ml-3 text-left">
                    <p class="text-sm font-bold" :class="currentStep === 4 ? 'text-trust-500' : 'text-txt-primary'">
                        Confirmar
                    </p>
                    <p class="text-xs text-txt-primary">Revisar tudo</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Steps Content -->
    <div class="bg-white rounded-2xl shadow-lg p-8">
        
        <!-- STEP 1: Token do Bot -->
        <div x-show="currentStep === 1" x-cloak>
            <h2 class="text-2xl font-bold text-txt-primary mb-2">Passo 1: Token do Bot</h2>
            <p class="text-txt-primary mb-6">Cole aqui o token que voc√™ recebeu do @BotFather no Telegram</p>
            
            <!-- Como conseguir o token -->
            <div class="mb-6 bg-blue-50 border-l-4 border-trust-500 p-4 rounded-r-lg">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-trust-500 text-xl mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-trust-900 mb-2">Como conseguir o token?</h4>
                        <ol class="text-sm text-trust-900 space-y-1">
                            <li>1Ô∏è‚É£ Abra o Telegram e fale com <strong>@BotFather</strong></li>
                            <li>2Ô∏è‚É£ Envie o comando <code class="bg-trust-100 px-2 py-1 rounded">/newbot</code></li>
                            <li>3Ô∏è‚É£ Escolha um nome e username para seu bot</li>
                            <li>4Ô∏è‚É£ Copie o token que o @BotFather enviar</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-txt-primary mb-2 flex items-center gap-2">
                        Token do Bot
                        <span class="text-alert-500">*</span>
                        <button type="button" class="text-trust-500 hover:text-trust-500" data-tooltip="Token fornecido pelo @BotFather. √â uma sequ√™ncia longa de n√∫meros e letras">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </label>
                    <input type="text" 
                           x-model="formData.token"
                           class="w-full px-4 py-3 border-2 border-white border-opacity-10 rounded-lg focus:border-trust-500 focus:ring-2 focus:ring-blue-200 transition-all"
                           placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <p class="mt-2 text-xs text-txt-primary">
                        <strong>Exemplo:</strong> <code class="bg-dark-surface px-2 py-1 rounded">123456789:ABCdefGHIjklMNOpqrsTUVwxyz</code>
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-txt-primary mb-2 flex items-center gap-2">
                        Nome do Bot (opcional)
                        <button type="button" class="text-trust-500 hover:text-trust-500" data-tooltip="Nome amig√°vel para identificar seu bot no painel">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </label>
                    <input type="text" 
                           x-model="formData.name"
                           class="w-full px-4 py-3 border-2 border-white border-opacity-10 rounded-lg focus:border-trust-500 focus:ring-2 focus:ring-blue-200 transition-all"
                           placeholder="Meu Bot de Vendas">
                </div>
            </div>
        </div>

        <!-- STEP 2: Gateway de Pagamento -->
        <div x-show="currentStep === 2" x-cloak>
            <h2 class="text-2xl font-bold text-txt-primary mb-2">Passo 2: M√©todo de Pagamento</h2>
            <p class="text-txt-primary mb-6">Escolha como voc√™ quer receber os pagamentos (recomendamos PushynPay para iniciantes)</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Paradise -->
                <label class="cursor-pointer">
                    <input type="radio" x-model="formData.gateway_type" value="paradise" class="hidden peer">
                    <div class="border-2 border-white border-opacity-10 rounded-xl p-6 peer-checked:border-trust-500 peer-checked:bg-blue-50 hover:border-trust-300 transition-all">
                        <h3 class="text-lg font-bold text-txt-primary mb-3">Paradise</h3>
                        <ul class="space-y-2 text-sm text-txt-primary">
                            <li>‚ö° Processamento r√°pido</li>
                            <li>‚úÖ Split autom√°tico</li>
                            <li>üéØ Para avan√ßados</li>
                            <li>üí∞ Taxa: 3.49%</li>
                        </ul>
                    </div>
                </label>
                
                <!-- PushynPay -->
                <label class="cursor-pointer">
                    <input type="radio" x-model="formData.gateway_type" value="pushynpay" class="hidden peer">
                    <div class="border-2 border-white border-opacity-10 rounded-xl p-6 peer-checked:border-trust-500 peer-checked:bg-blue-50 hover:border-trust-300 transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-txt-primary">PushynPay</h3>
                            <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full text-xs font-bold">
                                RECOMENDADO
                            </span>
                        </div>
                        <ul class="space-y-2 text-sm text-txt-primary">
                            <li>‚úÖ Mais usado por iniciantes</li>
                            <li>‚úÖ Confi√°vel</li>
                            <li>‚úÖ Boa taxa</li>
                            <li>üí∞ Taxa: 2.49%</li>
                        </ul>
                    </div>
                </label>
            </div>
            
            <div class="mt-6 bg-yellow-50 border-l-4 border-gold-500 p-4 rounded-r-lg">
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-gold-500 text-xl mr-3 mt-1"></i>
                    <p class="text-sm text-gold-700">
                        <strong>Dica:</strong> Voc√™ precisar√° configurar as credenciais do gateway depois, em Configura√ß√µes ‚Üí Gateways de Pagamento
                    </p>
                </div>
            </div>
        </div>

        <!-- STEP 3: Mensagens -->
        <div x-show="currentStep === 3" x-cloak>
            <h2 class="text-2xl font-bold text-txt-primary mb-2">Passo 3: Mensagem de Boas-vindas</h2>
            <p class="text-txt-primary mb-6">Configure a primeira mensagem que seus clientes ver√£o</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-txt-primary mb-2 flex items-center gap-2">
                        Mensagem
                        <button type="button" class="text-trust-500 hover:text-trust-500" data-tooltip="Texto que aparece quando algu√©m inicia conversa com seu bot. Use para apresentar seus produtos">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </label>
                    <textarea x-model="formData.welcome_message"
                              rows="6"
                              maxlength="900"
                              @input="formData.welcome_message = stripSurrogateChars(formData.welcome_message || '').slice(0, 900)"
                              class="w-full px-4 py-3 border-2 border-white border-opacity-10 rounded-lg focus:border-trust-500 focus:ring-2 focus:ring-blue-200 transition-all"
                              placeholder="Ol√°! Bem-vindo ao nosso bot de vendas üéâ

Aqui voc√™ encontra os melhores produtos com entrega r√°pida.

Escolha uma op√ß√£o abaixo para come√ßar:"></textarea>
                    <p class="text-xs text-gray-400 mt-1">M√°ximo de 900 caracteres.</p>
                    <p class="mt-2 text-xs text-txt-primary">
                        üí° Voc√™ pode usar <strong>emojis</strong> para deixar mais atrativo!
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-txt-primary mb-2 flex items-center gap-2">
                        Link de Foto/V√≠deo (opcional)
                        <button type="button" class="text-trust-500 hover:text-trust-500" data-tooltip="Link do Telegram para foto ou v√≠deo de apresenta√ß√£o. Ex: https://t.me/seucanal/123">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </label>
                    <input type="url" 
                           x-model="formData.welcome_media_url"
                           class="w-full px-4 py-3 border-2 border-white border-opacity-10 rounded-lg focus:border-trust-500 focus:ring-2 focus:ring-blue-200 transition-all"
                           placeholder="https://t.me/seucanal/123">
                    <p class="mt-2 text-xs text-txt-primary">
                        <strong>Exemplo:</strong> https://t.me/alemaomidias/602<br>
                        <strong>Tipos suportados:</strong> V√≠deo, Foto ou √Åudio
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-txt-primary mb-2">Tipo de M√≠dia Principal</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" x-model="formData.welcome_media_type" value="photo" class="hidden peer">
                            <div class="border-2 border-white border-opacity-10 rounded-lg p-4 text-center peer-checked:border-trust-500 peer-checked:bg-blue-50 hover:border-trust-300 transition-all">
                                <i class="fas fa-image text-3xl text-txt-primary mb-2"></i>
                                <p class="font-bold text-txt-primary">Foto</p>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" x-model="formData.welcome_media_type" value="video" class="hidden peer">
                            <div class="border-2 border-white border-opacity-10 rounded-lg p-4 text-center peer-checked:border-trust-500 peer-checked:bg-blue-50 hover:border-trust-300 transition-all">
                                <i class="fas fa-video text-3xl text-txt-primary mb-2"></i>
                                <p class="font-bold text-txt-primary">V√≠deo</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="p-4 rounded-lg" style="background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.2);">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" 
                               x-model="formData.welcome_audio_enabled"
                               class="w-5 h-5 bg-gray-700 border-gray-600 rounded focus:ring-purple-500"
                               style="accent-color: #A855F7;">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-microphone text-purple-500 text-lg"></i>
                            <span class="text-sm font-bold text-txt-primary">Adicionar √Åudio Complementar (opcional)</span>
                        </div>
                    </label>
                    <div x-show="formData.welcome_audio_enabled" x-cloak class="mt-3">
                        <input type="url" 
                               x-model="formData.welcome_audio_url"
                               class="w-full px-4 py-3 border-2 border-white border-opacity-10 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all"
                               placeholder="https://t.me/seucanal/audio123">
                        <p class="mt-2 text-xs text-txt-primary opacity-70">
                            O √°udio ser√° enviado ap√≥s a m√≠dia principal (v√≠deo ou foto)
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 4: Confirma√ß√£o -->
        <div x-show="currentStep === 4" x-cloak>
            <h2 class="text-2xl font-bold text-txt-primary mb-2">Passo 4: Revisar e Criar</h2>
            <p class="text-txt-primary mb-6">Confira se est√° tudo certo antes de criar seu bot</p>
            
            <div class="space-y-4">
                <div class="bg-dark-surface rounded-lg p-4">
                    <h4 class="font-bold text-txt-primary mb-2">üìù Resumo:</h4>
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-txt-primary">Nome:</dt>
                            <dd class="font-bold text-txt-primary" x-text="formData.name || 'Sem nome'"></dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-txt-primary">Token:</dt>
                            <dd class="font-mono text-txt-primary text-xs" x-text="formData.token.substring(0, 20) + '...'"></dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-txt-primary">Gateway:</dt>
                            <dd class="font-bold text-txt-primary" x-text="formData.gateway_type.toUpperCase()"></dd>
                        </div>
                        <div class="flex justify-between">
                            <dt class="text-txt-primary">Mensagem:</dt>
                            <dd class="font-bold text-txt-primary" x-text="formData.welcome_message ? 'Configurada ‚úÖ' : 'N√£o configurada'"></dd>
                        </div>
                    </dl>
                </div>
                
                <div class="bg-green-50 border-l-4 border-emerald-500 p-4 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-emerald-500 text-xl mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-emerald-900 mb-1">Tudo pronto!</h4>
                            <p class="text-sm text-emerald-700">
                                Ap√≥s criar o bot, voc√™ poder√° configurar bot√µes de venda, order bumps e muito mais.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="flex justify-between items-center mt-8 pt-6 border-t border-white border-opacity-5">
            <button x-show="currentStep > 1"
                    @click="previousStep()"
                    class="inline-flex items-center px-6 py-3 border-2 border-white border-opacity-10 text-txt-primary rounded-lg font-semibold hover:bg-dark-surface transition-all">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar
            </button>
            
            <div x-show="currentStep === 1"></div>
            
            <button x-show="currentStep < totalSteps"
                    @click="nextStep()"
                    class="inline-flex items-center px-6 py-3 bg-trust-500 text-white rounded-lg font-semibold hover:bg-trust-700 transition-all">
                Pr√≥ximo
                <i class="fas fa-arrow-right ml-2"></i>
            </button>
            
            <button x-show="currentStep === totalSteps"
                    @click="submitBot()"
                    :disabled="loading"
                    :class="{'opacity-50 cursor-not-allowed': loading}"
                    class="inline-flex items-center px-8 py-3 bg-emerald-500 text-white rounded-lg font-bold text-lg hover:bg-emerald-700 transition-all shadow-lg">
                <span x-show="!loading" class="flex items-center">
                    <i class="fas fa-rocket mr-2"></i>
                    Criar Meu Bot!
                </span>
                <span x-show="loading" class="flex items-center">
                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Criando...
                </span>
            </button>
        </div>

        <!-- Progress Indicator -->
        <div class="mt-6 text-center">
            <p class="text-sm text-txt-primary">
                Passo <strong x-text="currentStep"></strong> de <strong x-text="totalSteps"></strong>
            </p>
        </div>
    </div>

</div>

<!-- Container para mensagens -->
<div id="error-container" class="fixed top-20 right-4 z-50 max-w-md"></div>

{% endblock %}

