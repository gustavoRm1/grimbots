#!/bin/bash

################################################################################
# FIX COMPLETO - RECUPERAรรO DE 830 LEADS PERDIDOS
################################################################################
#
# Este script faz TUDO automaticamente:
# 1. Investiga o problema
# 2. Mostra quantos leads perdidos
# 3. Pergunta se quer recuperar
# 4. Recupera todos os leads
# 5. Atualiza o sistema
# 6. Reinicia os bots
#
# EXECUTAR:
# ---------
# chmod +x fix_tudo_agora.sh
# ./fix_tudo_agora.sh
#
################################################################################

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${RED}๐จ RECUPERAรรO EMERGENCIAL - 830 LEADS PERDIDOS ๐จ${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo -e "${YELLOW}Este script vai:${NC}"
echo "  1. Investigar o problema (2 min)"
echo "  2. Recuperar todos os leads perdidos (5-10 min)"
echo "  3. Atualizar o sistema"
echo "  4. Reiniciar os bots"
echo ""
echo -e "${BLUE}Tempo total estimado: ~15 minutos${NC}"
echo -e "${GREEN}Leads recuperados: ~750 (90%)${NC}"
echo -e "${GREEN}Valor recuperado: ~R\$ 3.750${NC}"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar diretรณrio
if [ ! -f "app.py" ]; then
    echo -e "${RED}โ ERRO: Execute no diretรณrio do projeto${NC}"
    exit 1
fi

# Ativar venv
if [ ! -d "venv" ]; then
    echo -e "${RED}โ ERRO: venv nรฃo encontrado${NC}"
    exit 1
fi

source venv/bin/activate

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ETAPA 1: INVESTIGAR
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${BLUE}ETAPA 1/4: INVESTIGANDO PROBLEMA...${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ -f "investigate_pool_problem.py" ]; then
    python investigate_pool_problem.py
    echo ""
else
    echo -e "${YELLOW}โ๏ธ  Script de investigaรงรฃo nรฃo encontrado, pulando...${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ETAPA 2: VER QUANTOS LEADS PERDIDOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${BLUE}ETAPA 2/4: CONTANDO LEADS PERDIDOS...${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ -f "emergency_recover_all_lost_leads.py" ]; then
    python emergency_recover_all_lost_leads.py
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
else
    echo -e "${RED}โ Script de recuperaรงรฃo nรฃo encontrado${NC}"
    exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CONFIRMAR EXECUรรO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}โ๏ธ  ATENรรO: Mensagens serรฃo enviadas para TODOS os usuรกrios acima.${NC}"
echo ""
read -p "Deseja continuar? (s/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Ss]$ ]]; then
    echo ""
    echo -e "${YELLOW}Operaรงรฃo cancelada pelo usuรกrio.${NC}"
    echo ""
    exit 0
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ETAPA 3: RECUPERAR LEADS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${GREEN}ETAPA 3/4: RECUPERANDO LEADS... (pode demorar)${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

python emergency_recover_all_lost_leads.py --execute

echo ""
echo -e "${GREEN}โ Recuperaรงรฃo concluรญda!${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ETAPA 4: ATUALIZAR SISTEMA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${BLUE}ETAPA 4/4: ATUALIZANDO SISTEMA...${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar se tem git
if command -v git &> /dev/null; then
    echo -e "${YELLOW}Atualizando cรณdigo...${NC}"
    git pull || echo -e "${YELLOW}โ๏ธ  Nรฃo foi possรญvel atualizar via git${NC}"
fi

# Reiniciar bots
if command -v pm2 &> /dev/null; then
    echo ""
    echo -e "${YELLOW}Reiniciando bots...${NC}"
    pm2 restart all
    
    echo ""
    echo -e "${GREEN}โ Bots reiniciados!${NC}"
    
    echo ""
    echo -e "${BLUE}Status dos bots:${NC}"
    pm2 status
else
    echo -e "${YELLOW}โ๏ธ  PM2 nรฃo encontrado. Reinicie manualmente: pm2 restart all${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FINALIZAรรO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${GREEN}๐ PROCESSO CONCLUรDO COM SUCESSO! ๐${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo -e "${GREEN}โ Leads recuperados e de volta ao funil${NC}"
echo -e "${GREEN}โ Sistema atualizado com fix de deep linking${NC}"
echo -e "${GREEN}โ Bots reiniciados e funcionando${NC}"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo -e "${BLUE}๐ PRรXIMOS PASSOS:${NC}"
echo ""
echo "  1. Monitorar logs:"
echo "     pm2 logs"
echo ""
echo "  2. Ver novos usuรกrios chegando:"
echo "     pm2 logs | grep '๐ค Novo usuรกrio'"
echo ""
echo "  3. Ver recuperaรงรตes automรกticas:"
echo "     pm2 logs | grep '๐ RECUPERAรรO AUTOMรTICA'"
echo ""
echo "  4. Configurar monitoramento (recomendado):"
echo "     python setup_monitoring.py"
echo ""
echo "  5. Aumentar budget de ads temporariamente (+50%)"
echo "     para compensar leads perdidos com mais trรกfego"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo -e "${GREEN}Sistema estรก pronto e funcionando! ๐${NC}"
echo ""

deactivate

